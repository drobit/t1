dn: inum=2124-0CF1,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Cert authentication module
displayName: cert
oxEnabled: false
inum: 2124-0CF1
oxConfigurationProperty: {"value1":"chain_cert_file_path","value2":"/etc/certs/chain_cert.pem","description":""}
oxConfigurationProperty: {"value1":"credentials_file","value2":"/etc/certs/cert_creds.json","description":""}
oxConfigurationProperty: {"value1":"map_user_cert","value2":"true","description":""}
oxConfigurationProperty: {"value1":"use_generic_validator","value2":"true","description":""}
oxConfigurationProperty: {"value1":"use_path_validator","value2":"true","description":""}
oxConfigurationProperty: {"value1":"use_ocsp_validator","value2":"false","description":""}
oxConfigurationProperty: {"value1":"use_crl_validator","value2":"false","description":""}
oxConfigurationProperty: {"value1":"crl_max_response_size","value2":"10485760","description":""}
oxLevel: 30
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxRevision: 1
oxScript:: IwojIG94QXV0aCBpcyBhdmFpbGFibGUgdW5kZXIgdGhlIE1JVCBMaWNlbnNlICgyMDA4KS4gU2VlIGh0dHA6Ly9vcGVuc291cmNlLm9yZy9saWNlbnNlcy9NSVQgZm9yIGZ1bGwgdGV4dC4KIyBDb3B5cmlnaHQgKGMpIDIwMTYsIEdsdXUKIwojIEF1dGhvcjogWXVyaXkgTW92Y2hhbgojCgpmcm9tIG9yZy5nbHV1LnNlcnZpY2UuY2RpLnV0aWwgaW1wb3J0IENkaVV0aWwKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuYXV0aCBpbXBvcnQgUGVyc29uQXV0aGVudGljYXRpb25UeXBlCmZyb20gamF2YXguZmFjZXMuY29udGV4dCBpbXBvcnQgRmFjZXNDb250ZXh0CmZyb20gb3JnLmdsdXUub3hhdXRoLnNlY3VyaXR5IGltcG9ydCBJZGVudGl0eQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlIGltcG9ydCBBdXRoZW50aWNhdGlvblNlcnZpY2UKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5jb21tb24gaW1wb3J0IFVzZXJTZXJ2aWNlCmZyb20gb3JnLmdsdXUudXRpbCBpbXBvcnQgU3RyaW5nSGVscGVyCmZyb20gb3JnLmdsdXUub3hhdXRoLnV0aWwgaW1wb3J0IFNlcnZlclV0aWwKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5jb21tb24gaW1wb3J0IEVuY3J5cHRpb25TZXJ2aWNlCmZyb20gamF2YS51dGlsIGltcG9ydCBBcnJheXMKZnJvbSBvcmcuZ2x1dS5veGF1dGguY2VydC5maW5nZXJwcmludCBpbXBvcnQgRmluZ2VycHJpbnRIZWxwZXIKZnJvbSBvcmcuZ2x1dS5veGF1dGguY2VydC52YWxpZGF0aW9uIGltcG9ydCBHZW5lcmljQ2VydGlmaWNhdGVWZXJpZmllciwgUGF0aENlcnRpZmljYXRlVmVyaWZpZXIsIE9DU1BDZXJ0aWZpY2F0ZVZlcmlmaWVyLCBDUkxDZXJ0aWZpY2F0ZVZlcmlmaWVyCmZyb20gb3JnLmdsdXUub3hhdXRoLmNlcnQudmFsaWRhdGlvbi5tb2RlbCBpbXBvcnQgVmFsaWRhdGlvblN0YXR1cwpmcm9tIG9yZy5nbHV1Lm94YXV0aC51dGlsIGltcG9ydCBDZXJ0VXRpbApmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC51dGlsIGltcG9ydCBDZXJ0VXRpbHMKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5uZXQgaW1wb3J0IEh0dHBTZXJ2aWNlCmZyb20gb3JnLmFwYWNoZS5odHRwLnBhcmFtcyBpbXBvcnQgQ29yZUNvbm5lY3Rpb25QTmFtZXMKCmltcG9ydCBzeXMKaW1wb3J0IGJhc2U2NAppbXBvcnQgdXJsbGliCgppbXBvcnQgamF2YQppbXBvcnQganNvbgoKY2xhc3MgUGVyc29uQXV0aGVudGljYXRpb24oUGVyc29uQXV0aGVudGljYXRpb25UeXBlKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6CiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkNlcnQuIEluaXRpYWxpemF0aW9uIgoKICAgICAgICBpZiBub3QgKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJjaGFpbl9jZXJ0X2ZpbGVfcGF0aCIpKToKICAgICAgICAgICAgcHJpbnQgIkNlcnQuIEluaXRpYWxpemF0aW9uLiBQcm9wZXJ0eSBjaGFpbl9jZXJ0X2ZpbGVfcGF0aCBpcyBtYW5kYXRvcnkiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBpZiBub3QgKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJtYXBfdXNlcl9jZXJ0IikpOgogICAgICAgICAgICBwcmludCAiQ2VydC4gSW5pdGlhbGl6YXRpb24uIFByb3BlcnR5IG1hcF91c2VyX2NlcnQgaXMgbWFuZGF0b3J5IgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgY2hhaW5fY2VydF9maWxlX3BhdGggPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImNoYWluX2NlcnRfZmlsZV9wYXRoIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgc2VsZi5jaGFpbl9jZXJ0cyA9IENlcnRVdGlsLmxvYWRYNTA5Q2VydGlmaWNhdGVGcm9tRmlsZShjaGFpbl9jZXJ0X2ZpbGVfcGF0aCkKICAgICAgICBpZiBzZWxmLmNoYWluX2NlcnRzID09IE5vbmU6CiAgICAgICAgICAgIHByaW50ICJDZXJ0LiBJbml0aWFsaXphdGlvbi4gRmFpbGVkIHRvIGxvYWQgY2hhaW4gY2VydGlmaWNhdGVzIGZyb20gJyVzJyIgJSBjaGFpbl9jZXJ0X2ZpbGVfcGF0aAogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgcHJpbnQgIkNlcnQuIEluaXRpYWxpemF0aW9uLiBMb2FkZWQgJyVkJyBjaGFpbiBjZXJ0aWZpY2F0ZXMiICUgc2VsZi5jaGFpbl9jZXJ0cy5zaXplKCkKICAgICAgICAKICAgICAgICBjcmxfbWF4X3Jlc3BvbnNlX3NpemUgPSA1ICogMTAyNCAqIDEwMjQgICMgMTBNYgogICAgICAgIGlmIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJjcmxfbWF4X3Jlc3BvbnNlX3NpemUiKToKICAgICAgICAgICAgY3JsX21heF9yZXNwb25zZV9zaXplID0gU3RyaW5nSGVscGVyLnRvSW50ZWdlcihjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImNybF9tYXhfcmVzcG9uc2Vfc2l6ZSIpLmdldFZhbHVlMigpLCBjcmxfbWF4X3Jlc3BvbnNlX3NpemUpCiAgICAgICAgICAgIHByaW50ICJDZXJ0LiBJbml0aWFsaXphdGlvbi4gQ1JMIG1heCByZXNwb25zZSBzaXplIGlzICclZCciICUgY3JsX21heF9yZXNwb25zZV9zaXplCgogICAgICAgICMgRGVmaW5lIGFycmF5IHRvIG9yZGVyIG1ldGhvZHMgY29ycmVjdGx5CiAgICAgICAgc2VsZi52YWxpZGF0b3JfdHlwZXMgPSBbICdnZW5lcmljJywgJ3BhdGgnLCAnb2NzcCcsICdjcmwnXQogICAgICAgIHNlbGYudmFsaWRhdG9ycyA9IHsgJ2dlbmVyaWMnIDogW0dlbmVyaWNDZXJ0aWZpY2F0ZVZlcmlmaWVyKCksIEZhbHNlXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwYXRoJyA6IFtQYXRoQ2VydGlmaWNhdGVWZXJpZmllcihGYWxzZSksIEZhbHNlXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvY3NwJyA6IFtPQ1NQQ2VydGlmaWNhdGVWZXJpZmllcigpLCBGYWxzZV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY3JsJyA6IFtDUkxDZXJ0aWZpY2F0ZVZlcmlmaWVyKGNybF9tYXhfcmVzcG9uc2Vfc2l6ZSksIEZhbHNlXSB9CgogICAgICAgIGZvciB0eXBlIGluIHNlbGYudmFsaWRhdG9yX3R5cGVzOgogICAgICAgICAgICB2YWxpZGF0b3JfcGFyYW1fbmFtZSA9ICJ1c2VfJXNfdmFsaWRhdG9yIiAlIHR5cGUKICAgICAgICAgICAgaWYgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkodmFsaWRhdG9yX3BhcmFtX25hbWUpOgogICAgICAgICAgICAgICAgdmFsaWRhdG9yX3N0YXR1cyA9IFN0cmluZ0hlbHBlci50b0Jvb2xlYW4oY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KHZhbGlkYXRvcl9wYXJhbV9uYW1lKS5nZXRWYWx1ZTIoKSwgRmFsc2UpCiAgICAgICAgICAgICAgICBzZWxmLnZhbGlkYXRvcnNbdHlwZV1bMV0gPSB2YWxpZGF0b3Jfc3RhdHVzCgogICAgICAgICAgICBwcmludCAiQ2VydC4gSW5pdGlhbGl6YXRpb24uIFZhbGlkYXRpb24gbWV0aG9kICclcycgc3RhdHVzOiAnJXMnIiAlICh0eXBlLCBzZWxmLnZhbGlkYXRvcnNbdHlwZV1bMV0pCgogICAgICAgIHNlbGYubWFwX3VzZXJfY2VydCA9IFN0cmluZ0hlbHBlci50b0Jvb2xlYW4oY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJtYXBfdXNlcl9jZXJ0IikuZ2V0VmFsdWUyKCksIEZhbHNlKQogICAgICAgIHByaW50ICJDZXJ0LiBJbml0aWFsaXphdGlvbi4gbWFwX3VzZXJfY2VydDogJyVzJyIgJSBzZWxmLm1hcF91c2VyX2NlcnQKCiAgICAgICAgc2VsZi5lbmFibGVkX3JlY2FwdGNoYSA9IHNlbGYuaW5pdFJlY2FwdGNoYShjb25maWd1cmF0aW9uQXR0cmlidXRlcykKICAgICAgICBwcmludCAiQ2VydC4gSW5pdGlhbGl6YXRpb24uIGVuYWJsZWRfcmVjYXB0Y2hhOiAnJXMnIiAlIHNlbGYuZW5hYmxlZF9yZWNhcHRjaGEKCiAgICAgICAgcHJpbnQgIkNlcnQuIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseSIKCiAgICAgICAgcmV0dXJuIFRydWUgICAKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkNlcnQuIERlc3Ryb3kiCgogICAgICAgIGZvciB0eXBlIGluIHNlbGYudmFsaWRhdG9yX3R5cGVzOgogICAgICAgICAgICBzZWxmLnZhbGlkYXRvcnNbdHlwZV1bMF0uZGVzdHJveSgpCgogICAgICAgIHByaW50ICJDZXJ0LiBEZXN0cm95ZWQgc3VjY2Vzc2Z1bGx5IgoKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQoKICAgIGRlZiBnZXRBdXRoZW50aWNhdGlvbk1ldGhvZENsYWltcyhzZWxmLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgaXNWYWxpZEF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGdldEFsdGVybmF0aXZlQXV0aGVudGljYXRpb25NZXRob2Qoc2VsZiwgdXNhZ2VUeXBlLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgYXV0aGVudGljYXRlKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CiAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCiAgICAgICAgY3JlZGVudGlhbHMgPSBpZGVudGl0eS5nZXRDcmVkZW50aWFscygpCgogICAgICAgIHVzZXJfbmFtZSA9IGNyZWRlbnRpYWxzLmdldFVzZXJuYW1lKCkKCiAgICAgICAgdXNlclNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oVXNlclNlcnZpY2UpCiAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkKCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICBwcmludCAiQ2VydC4gQXV0aGVudGljYXRlIGZvciBzdGVwIDEiCiAgICAgICAgICAgIGxvZ2luX2J1dHRvbiA9IFNlcnZlclV0aWwuZ2V0Rmlyc3RWYWx1ZShyZXF1ZXN0UGFyYW1ldGVycywgImxvZ2luRm9ybTpsb2dpbkJ1dHRvbiIpCiAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KGxvZ2luX2J1dHRvbik6CiAgICAgICAgICAgICAgICBwcmludCAiQ2VydC4gQXV0aGVudGljYXRlIGZvciBzdGVwIDEuIEZvcm0gd2VyZSBzdWJtaXR0ZWQgaW5jb3JyZWN0bHkiCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgaWYgc2VsZi5lbmFibGVkX3JlY2FwdGNoYToKICAgICAgICAgICAgICAgIHByaW50ICJDZXJ0LiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMS4gVmFsaWRhdGluZyByZWNhcHRjaGEgcmVzcG9uc2UiCiAgICAgICAgICAgICAgICByZWNhcHRjaGFfcmVzcG9uc2UgPSBTZXJ2ZXJVdGlsLmdldEZpcnN0VmFsdWUocmVxdWVzdFBhcmFtZXRlcnMsICJnLXJlY2FwdGNoYS1yZXNwb25zZSIpCgogICAgICAgICAgICAgICAgcmVjYXB0Y2hhX3Jlc3VsdCA9IHNlbGYudmFsaWRhdGVSZWNhcHRjaGEocmVjYXB0Y2hhX3Jlc3BvbnNlKQogICAgICAgICAgICAgICAgcHJpbnQgIkNlcnQuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiByZWNhcHRjaGFfcmVzdWx0OiAnJXMnIiAlIHJlY2FwdGNoYV9yZXN1bHQKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIHJlY2FwdGNoYV9yZXN1bHQKCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxpZiBzdGVwID09IDI6CiAgICAgICAgICAgIHByaW50ICJDZXJ0LiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMiIKCiAgICAgICAgICAgICMgVmFsaWRhdGUgaWYgdXNlciBzZWxlY3RlZCBjZXJ0aWZpY2F0ZQogICAgICAgICAgICBjZXJ0X3g1MDkgPSBzZWxmLmdldFNlc3Npb25BdHRyaWJ1dGUoImNlcnRfeDUwOSIpCiAgICAgICAgICAgIGlmIGNlcnRfeDUwOSA9PSBOb25lOgogICAgICAgICAgICAgICAgcHJpbnQgIkNlcnQuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBVc2VyIG5vdCBzZWxlY3RlZCBhbnkgY2VydHMiCiAgICAgICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJjZXJ0X3NlbGVjdGVkIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJldHVybiBUcnVlIHRvIGluZm9ybSB1c2VyIGhvdyB0byByZXNldCB3b3JrZmxvdwogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImNlcnRfc2VsZWN0ZWQiLCBUcnVlKQogICAgICAgICAgICAgICAgeDUwOUNlcnRpZmljYXRlID0gc2VsZi5jZXJ0RnJvbVN0cmluZyhjZXJ0X3g1MDkpCgogICAgICAgICAgICBzdWJqZWN0WDUwMFByaW5jaXBhbCA9IHg1MDlDZXJ0aWZpY2F0ZS5nZXRTdWJqZWN0WDUwMFByaW5jaXBhbCgpCiAgICAgICAgICAgIHByaW50ICJDZXJ0LiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gVXNlciBzZWxlY3RlZCBjZXJ0aWZpY2F0ZSB3aXRoIEROICclcyciICUgc3ViamVjdFg1MDBQcmluY2lwYWwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmFsaWRhdGUgY2VydGlmaWNhdGVzIHdoaWNoIHVzZXIgc2VsZWN0ZWQKICAgICAgICAgICAgdmFsaWQgPSBzZWxmLnZhbGlkYXRlQ2VydGlmaWNhdGUoeDUwOUNlcnRpZmljYXRlKQogICAgICAgICAgICBpZiBub3QgdmFsaWQ6CiAgICAgICAgICAgICAgICBwcmludCAiQ2VydC4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIuIENlcnRpZmljYXRlIEROICclcycgaXMgbm90IHZhbGlkIiAlIHN1YmplY3RYNTAwUHJpbmNpcGFsCiAgICAgICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJjZXJ0X3ZhbGlkIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmV0dXJuIFRydWUgdG8gaW5mb3JtIHVzZXIgaG93IHRvIHJlc2V0IHdvcmtmbG93CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigiY2VydF92YWxpZCIsIFRydWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENhbGN1bGF0ZSBjZXJ0aWZpY2F0ZSBmaW5nZXJwcmludAogICAgICAgICAgICB4NTA5Q2VydGlmaWNhdGVGaW5nZXJwcmludCA9IHNlbGYuY2FsY3VsYXRlQ2VydGlmaWNhdGVGaW5nZXJwcmludCh4NTA5Q2VydGlmaWNhdGUpCiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImNlcnRfeDUwOV9maW5nZXJwcmludCIsIHg1MDlDZXJ0aWZpY2F0ZUZpbmdlcnByaW50KQogICAgICAgICAgICBwcmludCAiQ2VydC4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIuIEZpbmdlcnByaW50IGlzICclcycgb2YgY2VydGlmaWNhdGUgd2l0aCBETiAnJXMnIiAlICh4NTA5Q2VydGlmaWNhdGVGaW5nZXJwcmludCwgc3ViamVjdFg1MDBQcmluY2lwYWwpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEF0dGVtcHQgdG8gZmluZCB1c2VyIGJ5IGNlcnRpZmljYXRlIGZpbmdlcnByaW50CiAgICAgICAgICAgIGNlcnRfdXNlcl9leHRlcm5hbF91aWQgPSAiY2VydDolcyIgJSB4NTA5Q2VydGlmaWNhdGVGaW5nZXJwcmludAogICAgICAgICAgICBwcmludCAiQ2VydC4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIuIEF0dGVtcHRpbmcgdG8gZmluZCB1c2VyIGJ5IG94RXh0ZXJuYWxVaWQgYXR0cmlidXRlIHZhbHVlICVzIiAlIGNlcnRfdXNlcl9leHRlcm5hbF91aWQKCiAgICAgICAgICAgIGZpbmRfdXNlcl9ieV9leHRlcm5hbF91aWQgPSB1c2VyU2VydmljZS5nZXRVc2VyQnlBdHRyaWJ1dGUoIm94RXh0ZXJuYWxVaWQiLCBjZXJ0X3VzZXJfZXh0ZXJuYWxfdWlkKQogICAgICAgICAgICBpZiBmaW5kX3VzZXJfYnlfZXh0ZXJuYWxfdWlkID09IE5vbmU6CiAgICAgICAgICAgICAgICBwcmludCAiQ2VydC4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIuIEZhaWxlZCB0byBmaW5kIHVzZXIiCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHNlbGYubWFwX3VzZXJfY2VydDoKICAgICAgICAgICAgICAgICAgICBwcmludCAiQ2VydC4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIuIFN0b3JpbmcgY2VydF91c2VyX2V4dGVybmFsX3VpZCBmb3Igc3RlcCAzIgogICAgICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImNlcnRfdXNlcl9leHRlcm5hbF91aWQiLCBjZXJ0X3VzZXJfZXh0ZXJuYWxfdWlkKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHByaW50ICJDZXJ0LiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gTWFwcGluZyBjZXJ0IHRvIHVzZXIgYWNjb3VudCBpcyBub3QgYWxsb3dlZCIKICAgICAgICAgICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJjZXJ0X2NvdW50X2xvZ2luX3N0ZXBzIiwgMikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIGZvdW5kVXNlck5hbWUgPSBmaW5kX3VzZXJfYnlfZXh0ZXJuYWxfdWlkLmdldFVzZXJJZCgpCiAgICAgICAgICAgIHByaW50ICJDZXJ0LiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gZm91bmRVc2VyTmFtZTogIiArIGZvdW5kVXNlck5hbWUKCiAgICAgICAgICAgIGxvZ2dlZF9pbiA9IEZhbHNlCiAgICAgICAgICAgIHVzZXJTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFVzZXJTZXJ2aWNlKQogICAgICAgICAgICBsb2dnZWRfaW4gPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKGZvdW5kVXNlck5hbWUpCiAgICAgICAgCiAgICAgICAgICAgIHByaW50ICJDZXJ0LiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gU2V0dGluZyBjb3VudCBzdGVwcyB0byAyIgogICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJjZXJ0X2NvdW50X2xvZ2luX3N0ZXBzIiwgMikKCiAgICAgICAgICAgIHJldHVybiBsb2dnZWRfaW4KICAgICAgICBlbGlmIHN0ZXAgPT0gMzoKICAgICAgICAgICAgcHJpbnQgIkNlcnQuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAzIgoKICAgICAgICAgICAgY2VydF91c2VyX2V4dGVybmFsX3VpZCA9IHNlbGYuZ2V0U2Vzc2lvbkF0dHJpYnV0ZSgiY2VydF91c2VyX2V4dGVybmFsX3VpZCIpCiAgICAgICAgICAgIGlmIGNlcnRfdXNlcl9leHRlcm5hbF91aWQgPT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJDZXJ0LiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMy4gY2VydF91c2VyX2V4dGVybmFsX3VpZCBpcyBlbXB0eSIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgdXNlcl9wYXNzd29yZCA9IGNyZWRlbnRpYWxzLmdldFBhc3N3b3JkKCkKCiAgICAgICAgICAgIGxvZ2dlZF9pbiA9IEZhbHNlCiAgICAgICAgICAgIGlmIChTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eVN0cmluZyh1c2VyX25hbWUpIGFuZCBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eVN0cmluZyh1c2VyX3Bhc3N3b3JkKSk6CiAgICAgICAgICAgICAgICBsb2dnZWRfaW4gPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJfbmFtZSwgdXNlcl9wYXNzd29yZCkKCiAgICAgICAgICAgIGlmIChub3QgbG9nZ2VkX2luKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgIyBEb3VibGUgY2hlY2sganVzdCB0byBtYWtlIHN1cmUuIFdlIGRpZCBjaGVja2luZyBpbiBwcmV2aW91cyBzdGVwCiAgICAgICAgICAgICMgQ2hlY2sgaWYgdGhlcmUgaXMgdXNlciB3aGljaCBoYXMgY2VydF91c2VyX2V4dGVybmFsX3VpZAogICAgICAgICAgICAjIEF2b2lkIG1hcHBpbmcgdXNlciBjZXJ0IHRvIG1vcmUgdGhhbiBvbmUgSURQIGFjY291bnQKICAgICAgICAgICAgZmluZF91c2VyX2J5X2V4dGVybmFsX3VpZCA9IHVzZXJTZXJ2aWNlLmdldFVzZXJCeUF0dHJpYnV0ZSgib3hFeHRlcm5hbFVpZCIsIGNlcnRfdXNlcl9leHRlcm5hbF91aWQpCiAgICAgICAgICAgIGlmIGZpbmRfdXNlcl9ieV9leHRlcm5hbF91aWQgPT0gTm9uZToKICAgICAgICAgICAgICAgICMgQWRkIGNlcnRfdXNlcl9leHRlcm5hbF91aWQgdG8gdXNlcidzIGV4dGVybmFsIEdVSUQgbGlzdAogICAgICAgICAgICAgICAgZmluZF91c2VyX2J5X2V4dGVybmFsX3VpZCA9IHVzZXJTZXJ2aWNlLmFkZFVzZXJBdHRyaWJ1dGUodXNlcl9uYW1lLCAib3hFeHRlcm5hbFVpZCIsIGNlcnRfdXNlcl9leHRlcm5hbF91aWQpCiAgICAgICAgICAgICAgICBpZiBmaW5kX3VzZXJfYnlfZXh0ZXJuYWxfdWlkID09IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkNlcnQuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAzLiBGYWlsZWQgdG8gdXBkYXRlIGN1cnJlbnQgdXNlciIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBwcmVwYXJlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIHByaW50ICJDZXJ0LiBQcmVwYXJlIGZvciBzdGVwICVkIiAlIHN0ZXAKICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKICAgICAgICAKICAgICAgICBpZiBzdGVwID09IDE6CiAgICAgICAgICAgIGlmIHNlbGYuZW5hYmxlZF9yZWNhcHRjaGE6CiAgICAgICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJyZWNhcHRjaGFfc2l0ZV9rZXkiLCBzZWxmLnJlY2FwdGNoYV9jcmVkc1snc2l0ZV9rZXknXSkKICAgICAgICBlbGlmIHN0ZXAgPT0gMjoKICAgICAgICAgICAgIyBTdG9yZSBjZXJ0aWZpY2F0ZSBpbiBzZXNzaW9uCiAgICAgICAgICAgIGZhY2VzQ29udGV4dCA9IENkaVV0aWwuYmVhbihGYWNlc0NvbnRleHQpCiAgICAgICAgICAgIGV4dGVybmFsQ29udGV4dCA9IGZhY2VzQ29udGV4dC5nZXRFeHRlcm5hbENvbnRleHQoKQogICAgICAgICAgICByZXF1ZXN0ID0gZXh0ZXJuYWxDb250ZXh0LmdldFJlcXVlc3QoKQoKICAgICAgICAgICAgIyBUcnkgdG8gZ2V0IGNlcnRpZmljYXRlIGZyb20gaGVhZGVyIFgtQ2xpZW50Q2VydAogICAgICAgICAgICBjbGllbnRDZXJ0aWZpY2F0ZSA9IGV4dGVybmFsQ29udGV4dC5nZXRSZXF1ZXN0SGVhZGVyTWFwKCkuZ2V0KCJYLUNsaWVudENlcnQiKQogICAgICAgICAgICBpZiBjbGllbnRDZXJ0aWZpY2F0ZSAhPSBOb25lOgogICAgICAgICAgICAgICAgeDUwOUNlcnRpZmljYXRlID0gc2VsZi5jZXJ0RnJvbVBlbVN0cmluZyhjbGllbnRDZXJ0aWZpY2F0ZSkKICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImNlcnRfeDUwOSIsICBzZWxmLmNlcnRUb1N0cmluZyh4NTA5Q2VydGlmaWNhdGUpKQogICAgICAgICAgICAgICAgcHJpbnQgIkNlcnQuIFByZXBhcmUgZm9yIHN0ZXAgMi4gU3RvcmluZyB1c2VyIGNlcnRpZmljYXRlIG9idGFpbmVkIGZyb20gJ1gtQ2xpZW50Q2VydCcgaGVhZGVyIgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgICAgICMgVHJ5IHRvIGdldCBjZXJ0aWZpY2F0ZSBmcm9tIGF0dHJpYnV0ZSBqYXZheC5zZXJ2bGV0LnJlcXVlc3QuWDUwOUNlcnRpZmljYXRlCiAgICAgICAgICAgIHg1MDlDZXJ0aWZpY2F0ZXMgPSByZXF1ZXN0LmdldEF0dHJpYnV0ZSgnamF2YXguc2VydmxldC5yZXF1ZXN0Llg1MDlDZXJ0aWZpY2F0ZScpCiAgICAgICAgICAgIGlmICh4NTA5Q2VydGlmaWNhdGVzICE9IE5vbmUpIGFuZCAobGVuKHg1MDlDZXJ0aWZpY2F0ZXMpID4gMCk6CiAgICAgICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJjZXJ0X3g1MDkiLCBzZWxmLmNlcnRUb1N0cmluZyh4NTA5Q2VydGlmaWNhdGVzWzBdKSkKICAgICAgICAgICAgICAgIHByaW50ICJDZXJ0LiBQcmVwYXJlIGZvciBzdGVwIDIuIFN0b3JpbmcgdXNlciBjZXJ0aWZpY2F0ZSBvYnRhaW5lZCBmcm9tICdqYXZheC5zZXJ2bGV0LnJlcXVlc3QuWDUwOUNlcnRpZmljYXRlJyBhdHRyaWJ1dGUiCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICBpZiBzdGVwIDwgNDoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgZ2V0RXh0cmFQYXJhbWV0ZXJzRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgc3RlcCk6CiAgICAgICAgcmV0dXJuIEFycmF5cy5hc0xpc3QoImNlcnRfc2VsZWN0ZWQiLCAiY2VydF92YWxpZCIsICJjZXJ0X3g1MDkiLCAiY2VydF94NTA5X2ZpbmdlcnByaW50IiwgImNlcnRfY291bnRfbG9naW5fc3RlcHMiLCAiY2VydF91c2VyX2V4dGVybmFsX3VpZCIpCgogICAgZGVmIGdldENvdW50QXV0aGVudGljYXRpb25TdGVwcyhzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgY2VydF9jb3VudF9sb2dpbl9zdGVwcyA9IHNlbGYuZ2V0U2Vzc2lvbkF0dHJpYnV0ZSgiY2VydF9jb3VudF9sb2dpbl9zdGVwcyIpCiAgICAgICAgaWYgY2VydF9jb3VudF9sb2dpbl9zdGVwcyAhPSBOb25lOgogICAgICAgICAgICByZXR1cm4gY2VydF9jb3VudF9sb2dpbl9zdGVwcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiAzCgogICAgZGVmIGdldFBhZ2VGb3JTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCBzdGVwKToKICAgICAgICBpZiBzdGVwID09IDE6CiAgICAgICAgICAgIHJldHVybiAiL2F1dGgvY2VydC9sb2dpbi54aHRtbCIKICAgICAgICBpZiBzdGVwID09IDI6CiAgICAgICAgICAgIHJldHVybiAiL2F1dGgvY2VydC9jZXJ0LWxvZ2luLnhodG1sIgogICAgICAgIGVsaWYgc3RlcCA9PSAzOgogICAgICAgICAgICBjZXJ0X3NlbGVjdGVkID0gc2VsZi5nZXRTZXNzaW9uQXR0cmlidXRlKCJjZXJ0X3NlbGVjdGVkIikKICAgICAgICAgICAgaWYgVHJ1ZSAhPSBjZXJ0X3NlbGVjdGVkOgogICAgICAgICAgICAgICAgcmV0dXJuICIvYXV0aC9jZXJ0L2NlcnQtbm90LXNlbGVjdGVkLnhodG1sIgoKICAgICAgICAgICAgY2VydF92YWxpZCA9IHNlbGYuZ2V0U2Vzc2lvbkF0dHJpYnV0ZSgiY2VydF92YWxpZCIpCiAgICAgICAgICAgIGlmIFRydWUgIT0gY2VydF92YWxpZDoKICAgICAgICAgICAgICAgIHJldHVybiAiL2F1dGgvY2VydC9jZXJ0LWludmFsaWQueGh0bWwiCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gIi9sb2dpbi54aHRtbCIKCiAgICAgICAgcmV0dXJuICIiCgogICAgZGVmIGxvZ291dChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIHByb2Nlc3NCYXNpY0F1dGhlbnRpY2F0aW9uKHNlbGYsIGNyZWRlbnRpYWxzKToKICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkKICAgICAgICBhdXRoZW50aWNhdGlvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oQXV0aGVudGljYXRpb25TZXJ2aWNlKQoKICAgICAgICB1c2VyX25hbWUgPSBjcmVkZW50aWFscy5nZXRVc2VybmFtZSgpCiAgICAgICAgdXNlcl9wYXNzd29yZCA9IGNyZWRlbnRpYWxzLmdldFBhc3N3b3JkKCkKCiAgICAgICAgbG9nZ2VkX2luID0gRmFsc2UKICAgICAgICBpZiAoU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9uYW1lKSBhbmQgU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9wYXNzd29yZCkpOgogICAgICAgICAgICBsb2dnZWRfaW4gPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJfbmFtZSwgdXNlcl9wYXNzd29yZCkKCiAgICAgICAgaWYgKG5vdCBsb2dnZWRfaW4pOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICBmaW5kX3VzZXJfYnlfdWlkID0gYXV0aGVudGljYXRpb25TZXJ2aWNlLmdldEF1dGhlbnRpY2F0ZWRVc2VyKCkKICAgICAgICBpZiAoZmluZF91c2VyX2J5X3VpZCA9PSBOb25lKToKICAgICAgICAgICAgcHJpbnQgIkNlcnQuIFByb2Nlc3MgYmFzaWMgYXV0aGVudGljYXRpb24uIEZhaWxlZCB0byBmaW5kIHVzZXIgJyVzJyIgJSB1c2VyX25hbWUKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAKICAgICAgICByZXR1cm4gZmluZF91c2VyX2J5X3VpZAoKICAgIGRlZiBnZXRTZXNzaW9uQXR0cmlidXRlKHNlbGYsIGF0dHJpYnV0ZV9uYW1lKToKICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKCiAgICAgICAgIyBUcnkgdG8gZ2V0IGF0dHJpYnV0ZSB2YWx1ZSBmcm9tIFNlYW0gZXZlbnQgY29udGV4dAogICAgICAgIGlmIGlkZW50aXR5LmlzU2V0V29ya2luZ1BhcmFtZXRlcihhdHRyaWJ1dGVfbmFtZSk6CiAgICAgICAgICAgIHJldHVybiBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKGF0dHJpYnV0ZV9uYW1lKQogICAgICAgIAogICAgICAgICMgVHJ5IHRvIGdldCBhdHRyaWJ1dGUgZnJvbSBwZXJzaXN0ZW50IHNlc3Npb24KICAgICAgICBzZXNzaW9uX2lkID0gaWRlbnRpdHkuZ2V0U2Vzc2lvbklkKCkKICAgICAgICBpZiBzZXNzaW9uX2lkID09IE5vbmU6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHNlc3Npb25fYXR0cmlidXRlcyA9IHNlc3Npb25faWQuZ2V0U2Vzc2lvbkF0dHJpYnV0ZXMoKQogICAgICAgIGlmIHNlc3Npb25fYXR0cmlidXRlcyA9PSBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICBpZiBzZXNzaW9uX2F0dHJpYnV0ZXMuY29udGFpbnNLZXkoYXR0cmlidXRlX25hbWUpOgogICAgICAgICAgICByZXR1cm4gc2Vzc2lvbl9hdHRyaWJ1dGVzLmdldChhdHRyaWJ1dGVfbmFtZSkKCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgY2FsY3VsYXRlQ2VydGlmaWNhdGVGaW5nZXJwcmludChzZWxmLCB4NTA5Q2VydGlmaWNhdGUpOgogICAgICAgIHByaW50ICJDZXJ0LiBDYWxjdWxhdGUgZmluZ2VycHJpbnQgZm9yIGNlcnRpZmljYXRlIEROICclcyciICUgeDUwOUNlcnRpZmljYXRlLmdldFN1YmplY3RYNTAwUHJpbmNpcGFsKCkKICAgICAgICAKICAgICAgICBwdWJsaWNLZXkgPSB4NTA5Q2VydGlmaWNhdGUuZ2V0UHVibGljS2V5KCkKICAgICAgICAKICAgICAgICAjIFVzZSBveEF1dGggaW1wbGVtZW50YXRpb24KICAgICAgICBmaW5nZXJwcmludCA9IEZpbmdlcnByaW50SGVscGVyLmdldFB1YmxpY0tleVNzaEZpbmdlcnByaW50KHB1YmxpY0tleSkKICAgICAgICAKICAgICAgICByZXR1cm4gZmluZ2VycHJpbnQgICAgICAKCiAgICBkZWYgdmFsaWRhdGVDZXJ0aWZpY2F0ZShzZWxmLCB4NTA5Q2VydGlmaWNhdGUpOgogICAgICAgIHN1YmplY3RYNTAwUHJpbmNpcGFsID0geDUwOUNlcnRpZmljYXRlLmdldFN1YmplY3RYNTAwUHJpbmNpcGFsKCkKCiAgICAgICAgcHJpbnQgIkNlcnQuIFZhbGlkYXRpbmcgY2VydGlmaWNhdGUgd2l0aCBETiAnJXMnIiAlIHN1YmplY3RYNTAwUHJpbmNpcGFsCiAgICAgICAgCiAgICAgICAgdmFsaWRhdGlvbl9kYXRlID0gamF2YS51dGlsLkRhdGUoKQoKICAgICAgICBmb3IgdHlwZSBpbiBzZWxmLnZhbGlkYXRvcl90eXBlczoKICAgICAgICAgICAgaWYgc2VsZi52YWxpZGF0b3JzW3R5cGVdWzFdOgogICAgICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi52YWxpZGF0b3JzW3R5cGVdWzBdLnZhbGlkYXRlKHg1MDlDZXJ0aWZpY2F0ZSwgc2VsZi5jaGFpbl9jZXJ0cywgdmFsaWRhdGlvbl9kYXRlKQogICAgICAgICAgICAgICAgcHJpbnQgIkNlcnQuIFZhbGlkYXRlIGNlcnRpZmljYXRlOiAnJXMnLiBWYWxpZGF0aW9uIG1ldGhvZCAnJXMnIHJlc3VsdDogJyVzJyIgJSAoc3ViamVjdFg1MDBQcmluY2lwYWwsIHR5cGUsIHJlc3VsdCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5nZXRWYWxpZGl0eSgpICE9IFZhbGlkYXRpb25TdGF0dXMuQ2VydGlmaWNhdGVWYWxpZGl0eS5WQUxJRCk6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkNlcnQuIENlcnRpZmljYXRlOiAnJXMnIGlzIGludmFsaWQiICUgc3ViamVjdFg1MDBQcmluY2lwYWwKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBjZXJ0VG9TdHJpbmcoc2VsZiwgeDUwOUNlcnRpZmljYXRlKToKICAgICAgICBpZiB4NTA5Q2VydGlmaWNhdGUgPT0gTm9uZToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICByZXR1cm4gYmFzZTY0LmI2NGVuY29kZSh4NTA5Q2VydGlmaWNhdGUuZ2V0RW5jb2RlZCgpKQoKICAgIGRlZiBjZXJ0RnJvbVN0cmluZyhzZWxmLCB4NTA5Q2VydGlmaWNhdGVFbmNvZGVkKToKICAgICAgICB4NTA5Q2VydGlmaWNhdGVEZWNvZGVkID0gYmFzZTY0LmI2NGRlY29kZSh4NTA5Q2VydGlmaWNhdGVFbmNvZGVkKQogICAgICAgIHJldHVybiBDZXJ0VXRpbHMueDUwOUNlcnRpZmljYXRlRnJvbUJ5dGVzKHg1MDlDZXJ0aWZpY2F0ZURlY29kZWQpCgogICAgZGVmIGNlcnRGcm9tUGVtU3RyaW5nKHNlbGYsIHBlbUNlcnRpZmljYXRlKToKICAgICAgICB4NTA5Q2VydGlmaWNhdGVFbmNvZGVkID0gcGVtQ2VydGlmaWNhdGUucmVwbGFjZSgiLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tIiwgIiIpLnJlcGxhY2UoIi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0iLCAiIikuc3RyaXAoKQogICAgICAgIHJldHVybiBzZWxmLmNlcnRGcm9tU3RyaW5nKHg1MDlDZXJ0aWZpY2F0ZUVuY29kZWQpCgogICAgZGVmIGluaXRSZWNhcHRjaGEoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJDZXJ0LiBJbml0aWFsaXplIHJlY2FwdGNoYSIKICAgICAgICBpZiBub3QgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImNyZWRlbnRpYWxzX2ZpbGUiKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIGNlcnRfY3JlZHNfZmlsZSA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiY3JlZGVudGlhbHNfZmlsZSIpLmdldFZhbHVlMigpCgogICAgICAgICMgTG9hZCBjcmVkZW50aWFscyBmcm9tIGZpbGUKICAgICAgICBmID0gb3BlbihjZXJ0X2NyZWRzX2ZpbGUsICdyJykKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNyZWRzID0ganNvbi5sb2FkcyhmLnJlYWQoKSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJDZXJ0LiBJbml0aWFsaXplIHJlY2FwdGNoYS4gRmFpbGVkIHRvIGxvYWQgY3JlZGVudGlhbHMgZnJvbSBmaWxlOiAlcyIgJSBjZXJ0X2NyZWRzX2ZpbGUKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgZi5jbG9zZSgpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZWNhcHRjaGFfY3JlZHMgPSBjcmVkc1sicmVjYXB0Y2hhIl0KICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJDZXJ0LiBJbml0aWFsaXplIHJlY2FwdGNoYS4gSW52YWxpZCBjcmVkZW50aWFscyBmaWxlICclcycgZm9ybWF0OiIgJSBjZXJ0X2NyZWRzX2ZpbGUKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgc2VsZi5yZWNhcHRjaGFfY3JlZHMgPSBOb25lCiAgICAgICAgaWYgcmVjYXB0Y2hhX2NyZWRzWyJlbmFibGVkIl06CiAgICAgICAgICAgIHByaW50ICJDZXJ0LiBJbml0aWFsaXplIHJlY2FwdGNoYS4gUmVjYXB0Y2hhIGlzIGVuYWJsZWQiCgogICAgICAgICAgICBlbmNyeXB0aW9uU2VydmljZSA9IENkaVV0aWwuYmVhbihFbmNyeXB0aW9uU2VydmljZSkKCiAgICAgICAgICAgIHNpdGVfa2V5ID0gcmVjYXB0Y2hhX2NyZWRzWyJzaXRlX2tleSJdCiAgICAgICAgICAgIHNlY3JldF9rZXkgPSByZWNhcHRjaGFfY3JlZHNbInNlY3JldF9rZXkiXQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2l0ZV9rZXkgPSBlbmNyeXB0aW9uU2VydmljZS5kZWNyeXB0KHNpdGVfa2V5KQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAjIElnbm9yZSBleGNlcHRpb24uIFZhbHVlIGlzIG5vdCBlbmNyeXB0ZWQKICAgICAgICAgICAgICAgIHByaW50ICJDZXJ0LiBJbml0aWFsaXplIHJlY2FwdGNoYS4gQXNzdW1pbmcgdGhhdCAnc2l0ZV9rZXknIGluIG5vdCBlbmNyeXB0ZWQiCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWNyZXRfa2V5ID0gZW5jcnlwdGlvblNlcnZpY2UuZGVjcnlwdChzZWNyZXRfa2V5KQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAjIElnbm9yZSBleGNlcHRpb24uIFZhbHVlIGlzIG5vdCBlbmNyeXB0ZWQKICAgICAgICAgICAgICAgIHByaW50ICJDZXJ0LiBJbml0aWFsaXplIHJlY2FwdGNoYS4gQXNzdW1pbmcgdGhhdCAnc2VjcmV0X2tleScgaW4gbm90IGVuY3J5cHRlZCIKCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnJlY2FwdGNoYV9jcmVkcyA9IHsgJ3NpdGVfa2V5JyA6IHNpdGVfa2V5LCAic2VjcmV0X2tleSIgOiBzZWNyZXRfa2V5IH0KICAgICAgICAgICAgcHJpbnQgIkNlcnQuIEluaXRpYWxpemUgcmVjYXB0Y2hhLiBSZWNhcHRjaGEgaXMgY29uZmlndXJlZCBjb3JyZWN0bHkiCgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50ICJDZXJ0LiBJbml0aWFsaXplIHJlY2FwdGNoYS4gUmVjYXB0Y2hhIGlzIGRpc2FibGVkIgoKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgdmFsaWRhdGVSZWNhcHRjaGEoc2VsZiwgcmVjYXB0Y2hhX3Jlc3BvbnNlKToKICAgICAgICBwcmludCAiQ2VydC4gVmFsaWRhdGUgcmVjYXB0Y2hhIHJlc3BvbnNlIgoKICAgICAgICBmYWNlc0NvbnRleHQgPSBDZGlVdGlsLmJlYW4oRmFjZXNDb250ZXh0KQogICAgICAgIHJlcXVlc3QgPSBmYWNlc0NvbnRleHQuZ2V0RXh0ZXJuYWxDb250ZXh0KCkuZ2V0UmVxdWVzdCgpCgogICAgICAgIHJlbW90ZWlwID0gU2VydmVyVXRpbC5nZXRJcEFkZHJlc3MocmVxdWVzdCkKICAgICAgICBwcmludCAiQ2VydC4gVmFsaWRhdGUgcmVjYXB0Y2hhIHJlc3BvbnNlLiByZW1vdGVpcDogJyVzJyIgJSByZW1vdGVpcAoKICAgICAgICBodHRwU2VydmljZSA9IENkaVV0aWwuYmVhbihIdHRwU2VydmljZSkKCiAgICAgICAgaHR0cF9jbGllbnQgPSBodHRwU2VydmljZS5nZXRIdHRwc0NsaWVudCgpCiAgICAgICAgaHR0cF9jbGllbnRfcGFyYW1zID0gaHR0cF9jbGllbnQuZ2V0UGFyYW1zKCkKICAgICAgICBodHRwX2NsaWVudF9wYXJhbXMuc2V0SW50UGFyYW1ldGVyKENvcmVDb25uZWN0aW9uUE5hbWVzLkNPTk5FQ1RJT05fVElNRU9VVCwgMTUgKiAxMDAwKQogICAgICAgIAogICAgICAgIHJlY2FwdGNoYV92YWxpZGF0aW9uX3VybCA9ICJodHRwczovL3d3dy5nb29nbGUuY29tL3JlY2FwdGNoYS9hcGkvc2l0ZXZlcmlmeSIKICAgICAgICByZWNhcHRjaGFfdmFsaWRhdGlvbl9yZXF1ZXN0ID0gdXJsbGliLnVybGVuY29kZSh7ICJzZWNyZXQiIDogc2VsZi5yZWNhcHRjaGFfY3JlZHNbJ3NlY3JldF9rZXknXSwgInJlc3BvbnNlIiA6IHJlY2FwdGNoYV9yZXNwb25zZSwgInJlbW90ZWlwIiA6IHJlbW90ZWlwIH0pCiAgICAgICAgcmVjYXB0Y2hhX3ZhbGlkYXRpb25faGVhZGVycyA9IHsgIkNvbnRlbnQtdHlwZSIgOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIiwgIkFjY2VwdCIgOiAiYXBwbGljYXRpb24vanNvbiIgfQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGh0dHBfc2VydmljZV9yZXNwb25zZSA9IGh0dHBTZXJ2aWNlLmV4ZWN1dGVQb3N0KGh0dHBfY2xpZW50LCByZWNhcHRjaGFfdmFsaWRhdGlvbl91cmwsIE5vbmUsIHJlY2FwdGNoYV92YWxpZGF0aW9uX2hlYWRlcnMsIHJlY2FwdGNoYV92YWxpZGF0aW9uX3JlcXVlc3QpCiAgICAgICAgICAgIGh0dHBfcmVzcG9uc2UgPSBodHRwX3NlcnZpY2VfcmVzcG9uc2UuZ2V0SHR0cFJlc3BvbnNlKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJDZXJ0LiBWYWxpZGF0ZSByZWNhcHRjaGEgcmVzcG9uc2UuIEV4Y2VwdGlvbjogIiwgc3lzLmV4Y19pbmZvKClbMV0KICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IGh0dHBTZXJ2aWNlLmlzUmVzcG9uc2VTdGFzdHVzQ29kZU9rKGh0dHBfcmVzcG9uc2UpOgogICAgICAgICAgICAgICAgcHJpbnQgIkNlcnQuIFZhbGlkYXRlIHJlY2FwdGNoYSByZXNwb25zZS4gR2V0IGludmFsaWQgcmVzcG9uc2UgZnJvbSB2YWxpZGF0aW9uIHNlcnZlcjogIiwgc3RyKGh0dHBfcmVzcG9uc2UuZ2V0U3RhdHVzTGluZSgpLmdldFN0YXR1c0NvZGUoKSkKICAgICAgICAgICAgICAgIGh0dHBTZXJ2aWNlLmNvbnN1bWUoaHR0cF9yZXNwb25zZSkKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICAgICAgICAgIHJlc3BvbnNlX2J5dGVzID0gaHR0cFNlcnZpY2UuZ2V0UmVzcG9uc2VDb250ZW50KGh0dHBfcmVzcG9uc2UpCiAgICAgICAgICAgIHJlc3BvbnNlX3N0cmluZyA9IGh0dHBTZXJ2aWNlLmNvbnZlcnRFbnRpdHlUb1N0cmluZyhyZXNwb25zZV9ieXRlcykKICAgICAgICAgICAgaHR0cFNlcnZpY2UuY29uc3VtZShodHRwX3Jlc3BvbnNlKQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIGh0dHBfc2VydmljZV9yZXNwb25zZS5jbG9zZUNvbm5lY3Rpb24oKQoKICAgICAgICBpZiByZXNwb25zZV9zdHJpbmcgPT0gTm9uZToKICAgICAgICAgICAgcHJpbnQgIkNlcnQuIFZhbGlkYXRlIHJlY2FwdGNoYSByZXNwb25zZS4gR2V0IGVtcHR5IHJlc3BvbnNlIGZyb20gdmFsaWRhdGlvbiBzZXJ2ZXIiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIHJlc3BvbnNlID0ganNvbi5sb2FkcyhyZXNwb25zZV9zdHJpbmcpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlWyJzdWNjZXNzIl0KCiAgICBkZWYgZ2V0TmV4dFN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKICAgICAgICByZXR1cm4gLTEKCiAgICBkZWYgZ2V0TG9nb3V0RXh0ZXJuYWxVcmwoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICBwcmludCAiR2V0IGV4dGVybmFsIGxvZ291dCBVUkwgY2FsbCIKICAgICAgICByZXR1cm4gTm9uZQ==
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=2FDB-CF02,ou=scripts,o=gluu
objectClass: oxCustomScript
objectClass: top
description: Passport authentication module
displayName: passport_social
oxEnabled: true
inum: 2FDB-CF02
oxConfigurationProperty: {"value1":"key_store_file","value2":"/etc/certs/passport-rp.jks","hide":false,"description":""}
oxConfigurationProperty: {"value1":"key_store_password","value2":"secret","hide":false,"description":""}
oxLevel: 40
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE5LCBHbHV1CiMKIyBBdXRob3I6IEpvc2UgR29uemFsZXoKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwpmcm9tIG9yZy5nbHV1LmpzZjIuc2VydmljZSBpbXBvcnQgRmFjZXNTZXJ2aWNlCmZyb20gb3JnLmdsdXUuanNmMi5tZXNzYWdlIGltcG9ydCBGYWNlc01lc3NhZ2VzCgpmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5jb21tb24gaW1wb3J0IFVzZXIsIFdlYktleVN0b3JhZ2UKZnJvbSBvcmcuZ2x1dS5veGF1dGgubW9kZWwuY29uZmlndXJhdGlvbiBpbXBvcnQgQXBwQ29uZmlndXJhdGlvbgpmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5jcnlwdG8gaW1wb3J0IENyeXB0b1Byb3ZpZGVyRmFjdG9yeQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5qd3QgaW1wb3J0IEp3dCwgSnd0Q2xhaW1OYW1lCmZyb20gb3JnLmdsdXUub3hhdXRoLm1vZGVsLnV0aWwgaW1wb3J0IEJhc2U2NFV0aWwKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZSBpbXBvcnQgQXBwSW5pdGlhbGl6ZXIsIEF1dGhlbnRpY2F0aW9uU2VydmljZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlLmNvbW1vbiBpbXBvcnQgVXNlclNlcnZpY2UsIEVuY3J5cHRpb25TZXJ2aWNlCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UubmV0IGltcG9ydCBIdHRwU2VydmljZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZWN1cml0eSBpbXBvcnQgSWRlbnRpdHkKZnJvbSBvcmcuZ2x1dS5veGF1dGgudXRpbCBpbXBvcnQgU2VydmVyVXRpbApmcm9tIG9yZy5nbHV1LmNvbmZpZy5veHRydXN0IGltcG9ydCBMZGFwT3hQYXNzcG9ydENvbmZpZ3VyYXRpb24KZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuYXV0aCBpbXBvcnQgUGVyc29uQXV0aGVudGljYXRpb25UeXBlCmZyb20gb3JnLmdsdXUucGVyc2lzdCBpbXBvcnQgUGVyc2lzdGVuY2VFbnRyeU1hbmFnZXIKZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlLmNkaS51dGlsIGltcG9ydCBDZGlVdGlsCmZyb20gb3JnLmdsdXUudXRpbCBpbXBvcnQgU3RyaW5nSGVscGVyCmZyb20gamF2YS51dGlsIGltcG9ydCBBcnJheUxpc3QsIEFycmF5cywgQ29sbGVjdGlvbnMKCmZyb20gamF2YXguZmFjZXMuYXBwbGljYXRpb24gaW1wb3J0IEZhY2VzTWVzc2FnZQpmcm9tIGphdmF4LmZhY2VzLmNvbnRleHQgaW1wb3J0IEZhY2VzQ29udGV4dAoKaW1wb3J0IGpzb24KaW1wb3J0IHN5cwppbXBvcnQgZGF0ZXRpbWUKCmNsYXNzIFBlcnNvbkF1dGhlbnRpY2F0aW9uKFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gaW5pdCBjYWxsZWQiCgogICAgICAgIHNlbGYuZXh0ZW5zaW9uTW9kdWxlID0gc2VsZi5sb2FkRXh0ZXJuYWxNb2R1bGUoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJleHRlbnNpb25fbW9kdWxlIikpCiAgICAgICAgZXh0ZW5zaW9uUmVzdWx0ID0gc2VsZi5leHRlbnNpb25Jbml0KGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKQogICAgICAgIGlmIGV4dGVuc2lvblJlc3VsdCAhPSBOb25lOgogICAgICAgICAgICByZXR1cm4gZXh0ZW5zaW9uUmVzdWx0CgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gaW5pdC4gQmVoYXZpb3VyIGlzIHNvY2lhbCIKICAgICAgICBzdWNjZXNzID0gc2VsZi5wcm9jZXNzS2V5U3RvcmVQcm9wZXJ0aWVzKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKQoKICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICBzZWxmLnByb3ZpZGVyS2V5ID0gInByb3ZpZGVyIgogICAgICAgICAgICBzZWxmLmN1c3RvbUF1dGh6UGFyYW1ldGVyID0gc2VsZi5nZXRDdXN0b21BdXRoelBhcmFtZXRlcihjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImF1dGh6X3JlcV9wYXJhbV9wcm92aWRlciIpKQogICAgICAgICAgICBzZWxmLnBhc3Nwb3J0RE4gPSBzZWxmLmdldFBhc3Nwb3J0Q29uZmlnRE4oKQogICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGluaXQuIEluaXRpYWxpemF0aW9uIHN1Y2Nlc3MiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBpbml0LiBJbml0aWFsaXphdGlvbiBmYWlsZWQiCiAgICAgICAgcmV0dXJuIHN1Y2Nlc3MKCgogICAgZGVmIGRlc3Ryb3koc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gZGVzdHJveSBjYWxsZWQiCiAgICAgICAgcmV0dXJuIFRydWUKCgogICAgZGVmIGdldEFwaVZlcnNpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIDExCiAgICAgICAgCiAgICBkZWYgZ2V0QXV0aGVudGljYXRpb25NZXRob2RDbGFpbXMoc2VsZiwgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHJldHVybiBOb25lCiAgICAgICAgCiAgICBkZWYgaXNWYWxpZEF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBUcnVlCgoKICAgIGRlZiBnZXRBbHRlcm5hdGl2ZUF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBOb25lCgoKICAgIGRlZiBhdXRoZW50aWNhdGUoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKCiAgICAgICAgZXh0ZW5zaW9uUmVzdWx0ID0gc2VsZi5leHRlbnNpb25BdXRoZW50aWNhdGUoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKQogICAgICAgIGlmIGV4dGVuc2lvblJlc3VsdCAhPSBOb25lOgogICAgICAgICAgICByZXR1cm4gZXh0ZW5zaW9uUmVzdWx0CgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXV0aGVudGljYXRlIGZvciBzdGVwICVzIGNhbGxlZCIgJSBzdHIoc3RlcCkKICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICAjIEdldCBKV1QgdG9rZW4KICAgICAgICAgICAgand0X3BhcmFtID0gU2VydmVyVXRpbC5nZXRGaXJzdFZhbHVlKHJlcXVlc3RQYXJhbWV0ZXJzLCAidXNlciIpCgogICAgICAgICAgICBpZiBqd3RfcGFyYW0gIT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXV0aGVudGljYXRlIGZvciBzdGVwIDEuIEpXVCB1c2VyIHByb2ZpbGUgdG9rZW4gZm91bmQiCgogICAgICAgICAgICAgICAgIyBQYXJzZSBKV1QgYW5kIHZhbGlkYXRlCiAgICAgICAgICAgICAgICBqd3QgPSBKd3QucGFyc2Uoand0X3BhcmFtKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYudmFsaWRTaWduYXR1cmUoand0KToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICAgICBpZiBzZWxmLmp3dEhhc0V4cGlyZWQoand0KToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICAgICAodXNlcl9wcm9maWxlLCBqc29ucCkgPSBzZWxmLmdldFVzZXJQcm9maWxlKGp3dCkKICAgICAgICAgICAgICAgIGlmIHVzZXJfcHJvZmlsZSA9PSBOb25lOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLmF0dGVtcHRBdXRoZW50aWNhdGlvbihpZGVudGl0eSwgdXNlcl9wcm9maWxlLCBqc29ucCkKCiAgICAgICAgICAgICNTZWUgcGFzc3BvcnRsb2dpbi54aHRtbAogICAgICAgICAgICBwcm92aWRlciA9IFNlcnZlclV0aWwuZ2V0Rmlyc3RWYWx1ZShyZXF1ZXN0UGFyYW1ldGVycywgImxvZ2luRm9ybTpwcm92aWRlciIpCiAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KHByb3ZpZGVyKToKCiAgICAgICAgICAgICAgICAjaXQncyB1c2VybmFtZSArIHBhc3N3IGF1dGgKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXV0aGVudGljYXRlIGZvciBzdGVwIDEuIEJhc2ljIGF1dGhlbnRpY2F0aW9uIGRldGVjdGVkIgogICAgICAgICAgICAgICAgbG9nZ2VkX2luID0gRmFsc2UKCiAgICAgICAgICAgICAgICBjcmVkZW50aWFscyA9IGlkZW50aXR5LmdldENyZWRlbnRpYWxzKCkKICAgICAgICAgICAgICAgIHVzZXJfbmFtZSA9IGNyZWRlbnRpYWxzLmdldFVzZXJuYW1lKCkKICAgICAgICAgICAgICAgIHVzZXJfcGFzc3dvcmQgPSBjcmVkZW50aWFscy5nZXRQYXNzd29yZCgpCgogICAgICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9uYW1lKSBhbmQgU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9wYXNzd29yZCk6CiAgICAgICAgICAgICAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkKICAgICAgICAgICAgICAgICAgICBsb2dnZWRfaW4gPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJfbmFtZSwgdXNlcl9wYXNzd29yZCkKCiAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiBCYXNpYyBhdXRoZW50aWNhdGlvbiByZXR1cm5lZDogJXMiICUgbG9nZ2VkX2luCiAgICAgICAgICAgICAgICByZXR1cm4gbG9nZ2VkX2luCgogICAgICAgICAgICBlbGlmIHByb3ZpZGVyIGluIHNlbGYucmVnaXN0ZXJlZFByb3ZpZGVyczoKICAgICAgICAgICAgICAgICNpdCdzIGEgcmVjb2duaXplZCBleHRlcm5hbCBJRFAKICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInNlbGVjdGVkUHJvdmlkZXIiLCBwcm92aWRlcikKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXV0aGVudGljYXRlIGZvciBzdGVwIDEuIFJldHJ5aW5nIHN0ZXAgMSIKICAgICAgICAgICAgICAgICNzZWUgcHJlcGFyZUZvclN0ZXAgKHN0ZXAgPSAxKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgaWYgc3RlcCA9PSAyOgogICAgICAgICAgICBtYWlsID0gU2VydmVyVXRpbC5nZXRGaXJzdFZhbHVlKHJlcXVlc3RQYXJhbWV0ZXJzLCAibG9naW5Gb3JtOmVtYWlsIikKICAgICAgICAgICAganNvbnAgPSBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKCJwYXNzcG9ydF91c2VyX3Byb2ZpbGUiKQoKICAgICAgICAgICAgaWYgbWFpbCA9PSBOb25lOgogICAgICAgICAgICAgICAgc2VsZi5zZXRNZXNzYWdlRXJyb3IoRmFjZXNNZXNzYWdlLlNFVkVSSVRZX0VSUk9SLCAiRW1haWwgd2FzIG1pc3NpbmcgaW4gdXNlciBwcm9maWxlIikKICAgICAgICAgICAgZWxpZiBqc29ucCAhPSBOb25lOgogICAgICAgICAgICAgICAgIyBDb21wbGV0aW9uIG9mIHByb2ZpbGUgdGFrZXMgcGxhY2UKICAgICAgICAgICAgICAgIHVzZXJfcHJvZmlsZSA9IGpzb24ubG9hZHMoanNvbnApCiAgICAgICAgICAgICAgICB1c2VyX3Byb2ZpbGVbIm1haWwiXSA9IFsgbWFpbCBdCgogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuYXR0ZW1wdEF1dGhlbnRpY2F0aW9uKGlkZW50aXR5LCB1c2VyX3Byb2ZpbGUsIGpzb25wKQoKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBhdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gRmFpbGVkOiBleHBlY3RlZCBtYWlsIHZhbHVlIGluIEhUVFAgcmVxdWVzdCBhbmQganNvbiBwcm9maWxlIGluIHNlc3Npb24iCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKCiAgICBkZWYgcHJlcGFyZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKCiAgICAgICAgZXh0ZW5zaW9uUmVzdWx0ID0gc2VsZi5leHRlbnNpb25QcmVwYXJlRm9yU3RlcChjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApCiAgICAgICAgaWYgZXh0ZW5zaW9uUmVzdWx0ICE9IE5vbmU6CiAgICAgICAgICAgIHJldHVybiBleHRlbnNpb25SZXN1bHQKCiAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBwcmVwYXJlRm9yU3RlcCBjYWxsZWQgJXMiICAlIHN0cihzdGVwKQogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQoKICAgICAgICBpZiBzdGVwID09IDE6CiAgICAgICAgICAgICNyZS1yZWFkIHRoZSBzdHJhdGVnaWVzIGNvbmZpZyAoZm9yIGluc3RhbmNlIHRvIGtub3cgd2hpY2ggc3RyYXRlZ2llcyBoYXZlIGVuYWJsZWQgdGhlIGVtYWlsIGFjY291bnQgbGlua2luZykKICAgICAgICAgICAgc2VsZi5wYXJzZVByb3ZpZGVyQ29uZmlncygpCiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImV4dGVybmFsUHJvdmlkZXJzIiwganNvbi5kdW1wcyhzZWxmLnJlZ2lzdGVyZWRQcm92aWRlcnMpKQoKICAgICAgICAgICAgcHJvdmlkZXJQYXJhbSA9IHNlbGYuY3VzdG9tQXV0aHpQYXJhbWV0ZXIKICAgICAgICAgICAgdXJsID0gTm9uZQoKICAgICAgICAgICAgc2Vzc2lvbkF0dHJpYnV0ZXMgPSBpZGVudGl0eS5nZXRTZXNzaW9uSWQoKS5nZXRTZXNzaW9uQXR0cmlidXRlcygpCiAgICAgICAgICAgIHNlbGYuc2tpcFByb2ZpbGVVcGRhdGUgPSBTdHJpbmdIZWxwZXIuZXF1YWxzSWdub3JlQ2FzZShzZXNzaW9uQXR0cmlidXRlcy5nZXQoInNraXBQYXNzcG9ydFByb2ZpbGVVcGRhdGUiKSwgInRydWUiKQoKICAgICAgICAgICAgI3RoaXMgcGFyYW0gY291bGQgaGF2ZSBiZWVuIHNldCBwcmV2aW91c2x5IGluIGF1dGhlbnRpY2F0ZSBzdGVwIGlmIGN1cnJlbnQgc3RlcCBpcyBiZWluZyByZXRyaWVkCiAgICAgICAgICAgIHByb3ZpZGVyID0gaWRlbnRpdHkuZ2V0V29ya2luZ1BhcmFtZXRlcigic2VsZWN0ZWRQcm92aWRlciIpCiAgICAgICAgICAgIGlmIHByb3ZpZGVyICE9IE5vbmU6CiAgICAgICAgICAgICAgICB1cmwgPSBzZWxmLmdldFBhc3Nwb3J0UmVkaXJlY3RVcmwocHJvdmlkZXIpCiAgICAgICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJzZWxlY3RlZFByb3ZpZGVyIiwgTm9uZSkKCiAgICAgICAgICAgIGVsaWYgcHJvdmlkZXJQYXJhbSAhPSBOb25lOgogICAgICAgICAgICAgICAgcGFyYW1WYWx1ZSA9IHNlc3Npb25BdHRyaWJ1dGVzLmdldChwcm92aWRlclBhcmFtKQoKICAgICAgICAgICAgICAgIGlmIHBhcmFtVmFsdWUgIT0gTm9uZToKICAgICAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIHByZXBhcmVGb3JTdGVwLiBGb3VuZCB2YWx1ZSBpbiBjdXN0b20gcGFyYW0gb2YgYXV0aG9yaXphdGlvbiByZXF1ZXN0OiAlcyIgJSBwYXJhbVZhbHVlCiAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXIgPSBzZWxmLmdldFByb3ZpZGVyRnJvbUpzb24ocGFyYW1WYWx1ZSkKCiAgICAgICAgICAgICAgICAgICAgaWYgcHJvdmlkZXIgPT0gTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBwcmVwYXJlRm9yU3RlcC4gQSBwcm92aWRlciB2YWx1ZSBjb3VsZCBub3QgYmUgZXh0cmFjdGVkIGZyb20gY3VzdG9tIGF1dGhvcml6YXRpb24gcmVxdWVzdCBwYXJhbWV0ZXIiCiAgICAgICAgICAgICAgICAgICAgZWxpZiBub3QgcHJvdmlkZXIgaW4gc2VsZi5yZWdpc3RlcmVkUHJvdmlkZXJzOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIHByZXBhcmVGb3JTdGVwLiBQcm92aWRlciAnJXMnIG5vdCBwYXJ0IG9mIGtub3duIGNvbmZpZ3VyZWQgSURQcy9PUHMiICUgcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICB1cmwgPSBzZWxmLmdldFBhc3Nwb3J0UmVkaXJlY3RVcmwocHJvdmlkZXIpCgogICAgICAgICAgICBpZiB1cmwgPT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gcHJlcGFyZUZvclN0ZXAuIEEgcGFnZSB0byBtYW51YWxseSBzZWxlY3QgYW4gaWRlbnRpdHkgcHJvdmlkZXIgd2lsbCBiZSBzaG93biIKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGZhY2VzU2VydmljZSA9IENkaVV0aWwuYmVhbihGYWNlc1NlcnZpY2UpCiAgICAgICAgICAgICAgICBmYWNlc1NlcnZpY2UucmVkaXJlY3RUb0V4dGVybmFsVVJMKHVybCkKCiAgICAgICAgcmV0dXJuIFRydWUKCgogICAgZGVmIGdldEV4dHJhUGFyYW1ldGVyc0ZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0RXh0cmFQYXJhbWV0ZXJzRm9yU3RlcCBjYWxsZWQiCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICByZXR1cm4gQXJyYXlzLmFzTGlzdCgic2VsZWN0ZWRQcm92aWRlciIsICJleHRlcm5hbFByb3ZpZGVycyIpCiAgICAgICAgZWxpZiBzdGVwID09IDI6CiAgICAgICAgICAgIHJldHVybiBBcnJheXMuYXNMaXN0KCJwYXNzcG9ydF91c2VyX3Byb2ZpbGUiKQogICAgICAgIHJldHVybiBOb25lCgoKICAgIGRlZiBnZXRDb3VudEF1dGhlbnRpY2F0aW9uU3RlcHMoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0Q291bnRBdXRoZW50aWNhdGlvblN0ZXBzIGNhbGxlZCIKICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKICAgICAgICBpZiBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKCJwYXNzcG9ydF91c2VyX3Byb2ZpbGUiKSAhPSBOb25lOgogICAgICAgICAgICByZXR1cm4gMgogICAgICAgIHJldHVybiAxCgoKICAgIGRlZiBnZXRQYWdlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgc3RlcCk6CiAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBnZXRQYWdlRm9yU3RlcCBjYWxsZWQiCgogICAgICAgIGV4dGVuc2lvblJlc3VsdCA9IHNlbGYuZXh0ZW5zaW9uR2V0UGFnZUZvclN0ZXAoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApCiAgICAgICAgaWYgZXh0ZW5zaW9uUmVzdWx0ICE9IE5vbmU6CiAgICAgICAgICAgIHJldHVybiBleHRlbnNpb25SZXN1bHQKCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICByZXR1cm4gIi9hdXRoL3Bhc3Nwb3J0L3Bhc3Nwb3J0bG9naW4ueGh0bWwiCiAgICAgICAgcmV0dXJuICIvYXV0aC9wYXNzcG9ydC9wYXNzcG9ydHBvc3Rsb2dpbi54aHRtbCIKCgogICAgZGVmIGdldE5leHRTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CgogICAgICAgIGlmIHN0ZXAgPT0gMToKICAgICAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCiAgICAgICAgICAgIHByb3ZpZGVyID0gaWRlbnRpdHkuZ2V0V29ya2luZ1BhcmFtZXRlcigic2VsZWN0ZWRQcm92aWRlciIpCiAgICAgICAgICAgIGlmIHByb3ZpZGVyICE9IE5vbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gMQoKICAgICAgICByZXR1cm4gLTEKCiAgICBkZWYgZ2V0TG9nb3V0RXh0ZXJuYWxVcmwoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICBwcmludCAiR2V0IGV4dGVybmFsIGxvZ291dCBVUkwgY2FsbCIKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBsb2dvdXQoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKIyBFeHRlbnNpb24gbW9kdWxlIHJlbGF0ZWQgZnVuY3Rpb25zCgogICAgZGVmIGV4dGVuc2lvbkluaXQoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgoKICAgICAgICBpZiBzZWxmLmV4dGVuc2lvbk1vZHVsZSA9PSBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHJldHVybiBzZWxmLmV4dGVuc2lvbk1vZHVsZS5pbml0KGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKQoKCiAgICBkZWYgZXh0ZW5zaW9uQXV0aGVudGljYXRlKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CgogICAgICAgIGlmIHNlbGYuZXh0ZW5zaW9uTW9kdWxlID09IE5vbmU6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgcmV0dXJuIHNlbGYuZXh0ZW5zaW9uTW9kdWxlLmF1dGhlbnRpY2F0ZShjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApCgoKICAgIGRlZiBleHRlbnNpb25QcmVwYXJlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgoKICAgICAgICBpZiBzZWxmLmV4dGVuc2lvbk1vZHVsZSA9PSBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHJldHVybiBzZWxmLmV4dGVuc2lvbk1vZHVsZS5wcmVwYXJlRm9yU3RlcChjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApCgoKICAgIGRlZiBleHRlbnNpb25HZXRQYWdlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgc3RlcCk6CgogICAgICAgIGlmIHNlbGYuZXh0ZW5zaW9uTW9kdWxlID09IE5vbmU6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgcmV0dXJuIHNlbGYuZXh0ZW5zaW9uTW9kdWxlLmdldFBhZ2VGb3JTdGVwKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCBzdGVwKQoKIyBJbml0YWxpemF0aW9uIHJvdXRpbmVzCgogICAgZGVmIGxvYWRFeHRlcm5hbE1vZHVsZShzZWxmLCBzaW1wbGVDdXN0UHJvcGVydHkpOgoKICAgICAgICBpZiBzaW1wbGVDdXN0UHJvcGVydHkgIT0gTm9uZToKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBsb2FkRXh0ZXJuYWxNb2R1bGUuIExvYWRpbmcgcGFzc3BvcnQgZXh0ZW5zaW9uIG1vZHVsZS4uLiIKICAgICAgICAgICAgbW9kdWxlTmFtZSA9IHNpbXBsZUN1c3RQcm9wZXJ0eS5nZXRWYWx1ZTIoKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBtb2R1bGUgPSBfX2ltcG9ydF9fKG1vZHVsZU5hbWUpCiAgICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gbG9hZEV4dGVybmFsTW9kdWxlLiBGYWlsZWQgdG8gbG9hZCBtb2R1bGUgJXMiICUgbW9kdWxlTmFtZQogICAgICAgICAgICAgICAgcHJpbnQgIkV4Y2VwdGlvbjogIiwgc3lzLmV4Y19pbmZvKClbMV0KICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gbG9hZEV4dGVybmFsTW9kdWxlLiBGbG93IHdpbGwgYmUgZHJpdmVuIGVudGlyZWx5IGJ5IHJvdXRpbmVzIG9mIG1haW4gcGFzc3BvcnQgc2NyaXB0IgogICAgICAgIHJldHVybiBOb25lCgoKICAgIGRlZiBwcm9jZXNzS2V5U3RvcmVQcm9wZXJ0aWVzKHNlbGYsIGF0dHJzKToKICAgICAgICBmaWxlID0gYXR0cnMuZ2V0KCJrZXlfc3RvcmVfZmlsZSIpCiAgICAgICAgcGFzc3dvcmQgPSBhdHRycy5nZXQoImtleV9zdG9yZV9wYXNzd29yZCIpCgogICAgICAgIGlmIGZpbGUgIT0gTm9uZSBhbmQgcGFzc3dvcmQgIT0gTm9uZToKICAgICAgICAgICAgZmlsZSA9IGZpbGUuZ2V0VmFsdWUyKCkKICAgICAgICAgICAgcGFzc3dvcmQgPSBwYXNzd29yZC5nZXRWYWx1ZTIoKQoKICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzTm90RW1wdHkoZmlsZSkgYW5kIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5KHBhc3N3b3JkKToKICAgICAgICAgICAgICAgIHNlbGYua2V5U3RvcmVGaWxlID0gZmlsZQogICAgICAgICAgICAgICAgc2VsZi5rZXlTdG9yZVBhc3N3b3JkID0gcGFzc3dvcmQKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gcmVhZEtleVN0b3JlUHJvcGVydGllcy4gUHJvcGVydGllcyBrZXlfc3RvcmVfZmlsZSBvciBrZXlfc3RvcmVfcGFzc3dvcmQgbm90IGZvdW5kIG9yIGVtcHR5IgogICAgICAgIHJldHVybiBGYWxzZQoKCiAgICBkZWYgZ2V0Q3VzdG9tQXV0aHpQYXJhbWV0ZXIoc2VsZiwgc2ltcGxlQ3VzdFByb3BlcnR5KToKCiAgICAgICAgY3VzdG9tQXV0aHpQYXJhbWV0ZXIgPSBOb25lCiAgICAgICAgaWYgc2ltcGxlQ3VzdFByb3BlcnR5ICE9IE5vbmU6CiAgICAgICAgICAgIHByb3AgPSBzaW1wbGVDdXN0UHJvcGVydHkuZ2V0VmFsdWUyKCkKICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzTm90RW1wdHkocHJvcCk6CiAgICAgICAgICAgICAgICBjdXN0b21BdXRoelBhcmFtZXRlciA9IHByb3AKCiAgICAgICAgaWYgY3VzdG9tQXV0aHpQYXJhbWV0ZXIgPT0gTm9uZToKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBnZXRDdXN0b21BdXRoelBhcmFtZXRlci4gTm8gY3VzdG9tIHBhcmFtIGZvciBPSURDIGF1dGh6IHJlcXVlc3QgaW4gc2NyaXB0IHByb3BlcnRpZXMiCiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0Q3VzdG9tQXV0aHpQYXJhbWV0ZXIuIFBhc3Nwb3J0IGZsb3cgY2Fubm90IGJlIGluaXRpYXRlZCBieSBkb2luZyBhbiBPcGVuSUQgY29ubmVjdCBhdXRob3JpemF0aW9uIHJlcXVlc3QiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBnZXRDdXN0b21BdXRoelBhcmFtZXRlci4gQ3VzdG9tIHBhcmFtIGZvciBPSURDIGF1dGh6IHJlcXVlc3QgaW4gc2NyaXB0IHByb3BlcnRpZXM6ICVzIiAlIGN1c3RvbUF1dGh6UGFyYW1ldGVyCgogICAgICAgIHJldHVybiBjdXN0b21BdXRoelBhcmFtZXRlcgoKIyBDb25maWd1cmF0aW9uIHBhcnNpbmcKCiAgICBkZWYgZ2V0UGFzc3BvcnRDb25maWdETihzZWxmKToKCiAgICAgICAgZiA9IG9wZW4oJy9ldGMvZ2x1dS9jb25mL2dsdXUucHJvcGVydGllcycsICdyJykKICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICBwcm9wID0gbGluZS5zcGxpdCgiPSIpCiAgICAgICAgICAgIGlmIHByb3BbMF0gPT0gIm94cGFzc3BvcnRfQ29uZmlndXJhdGlvbkVudHJ5RE4iOgogICAgICAgICAgICAgIHByb3AucG9wKDApCiAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgZi5jbG9zZSgpCiAgICAgICAgcmV0dXJuICI9Ii5qb2luKHByb3ApLnN0cmlwKCkKCgogICAgZGVmIHBhcnNlQWxsUHJvdmlkZXJzKHNlbGYpOgoKICAgICAgICByZWdpc3RlcmVkUHJvdmlkZXJzID0ge30KICAgICAgICBwcmludCAiUGFzc3BvcnQuIHBhcnNlQWxsUHJvdmlkZXJzLiBBZGRpbmcgcHJvdmlkZXJzIgogICAgICAgIGVudHJ5TWFuYWdlciA9IENkaVV0aWwuYmVhbihQZXJzaXN0ZW5jZUVudHJ5TWFuYWdlcikKCiAgICAgICAgY29uZmlnID0gTGRhcE94UGFzc3BvcnRDb25maWd1cmF0aW9uKCkKICAgICAgICBjb25maWcgPSBlbnRyeU1hbmFnZXIuZmluZChjb25maWcuZ2V0Q2xhc3MoKSwgc2VsZi5wYXNzcG9ydEROKS5nZXRQYXNzcG9ydENvbmZpZ3VyYXRpb24oKQogICAgICAgIGNvbmZpZyA9IGNvbmZpZy5nZXRQcm92aWRlcnMoKSBpZiBjb25maWcgIT0gTm9uZSBlbHNlIGNvbmZpZwoKICAgICAgICBpZiBjb25maWcgIT0gTm9uZSBhbmQgbGVuKGNvbmZpZykgPiAwOgogICAgICAgICAgICBmb3IgcHJ2ZGV0YWlscyBpbiBjb25maWc6CiAgICAgICAgICAgICAgICBpZiBwcnZkZXRhaWxzLmlzRW5hYmxlZCgpOgogICAgICAgICAgICAgICAgICAgIHJlZ2lzdGVyZWRQcm92aWRlcnNbcHJ2ZGV0YWlscy5nZXRJZCgpXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgImVtYWlsTGlua2luZ1NhZmUiOiBwcnZkZXRhaWxzLmlzRW1haWxMaW5raW5nU2FmZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAicmVxdWVzdEZvckVtYWlsIiA6IHBydmRldGFpbHMuaXNSZXF1ZXN0Rm9yRW1haWwoKSwKICAgICAgICAgICAgICAgICAgICAgICAgImxvZ29faW1nIjogcHJ2ZGV0YWlscy5nZXRMb2dvSW1nKCksCiAgICAgICAgICAgICAgICAgICAgICAgICJkaXNwbGF5TmFtZSI6IHBydmRldGFpbHMuZ2V0RGlzcGxheU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiBwcnZkZXRhaWxzLmdldFR5cGUoKQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlZ2lzdGVyZWRQcm92aWRlcnMKCgogICAgZGVmIHBhcnNlUHJvdmlkZXJDb25maWdzKHNlbGYpOgoKICAgICAgICByZWdpc3RlcmVkUHJvdmlkZXJzID0ge30KICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlZ2lzdGVyZWRQcm92aWRlcnMgPSBzZWxmLnBhcnNlQWxsUHJvdmlkZXJzKCkKICAgICAgICAgICAgdG9SZW1vdmUgPSBbXQoKICAgICAgICAgICAgZm9yIHByb3ZpZGVyIGluIHJlZ2lzdGVyZWRQcm92aWRlcnM6CiAgICAgICAgICAgICAgICBpZiByZWdpc3RlcmVkUHJvdmlkZXJzW3Byb3ZpZGVyXVsidHlwZSJdID09ICJzYW1sIjoKICAgICAgICAgICAgICAgICAgICB0b1JlbW92ZS5hcHBlbmQocHJvdmlkZXIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJlZ2lzdGVyZWRQcm92aWRlcnNbcHJvdmlkZXJdWyJzYW1sIl0gPSBGYWxzZQoKICAgICAgICAgICAgZm9yIHByb3ZpZGVyIGluIHRvUmVtb3ZlOgogICAgICAgICAgICAgICAgcmVnaXN0ZXJlZFByb3ZpZGVycy5wb3AocHJvdmlkZXIpCgogICAgICAgICAgICBpZiBsZW4ocmVnaXN0ZXJlZFByb3ZpZGVycy5rZXlzKCkpID4gMDoKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gcGFyc2VQcm92aWRlckNvbmZpZ3MuIENvbmZpZ3VyZWQgcHJvdmlkZXJzOiIsIHJlZ2lzdGVyZWRQcm92aWRlcnMKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gcGFyc2VQcm92aWRlckNvbmZpZ3MuIE5vIHByb3ZpZGVycyByZWdpc3RlcmVkIHlldCIKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gcGFyc2VQcm92aWRlckNvbmZpZ3MuIEFuIGVycm9yIG9jY3VycmVkIHdoaWxlIGJ1aWxkaW5nIHRoZSBsaXN0IG9mIHN1cHBvcnRlZCBhdXRoZW50aWNhdGlvbiBwcm92aWRlcnMiLCBzeXMuZXhjX2luZm8oKVsxXQoKICAgICAgICBzZWxmLnJlZ2lzdGVyZWRQcm92aWRlcnMgPSByZWdpc3RlcmVkUHJvdmlkZXJzCgojIEF1eGlsaWFyeSByb3V0aW5lcwoKICAgIGRlZiBnZXRQcm92aWRlckZyb21Kc29uKHNlbGYsIHByb3ZpZGVySnNvbik6CgogICAgICAgIHByb3ZpZGVyID0gTm9uZQogICAgICAgIHRyeToKICAgICAgICAgICAgb2JqID0ganNvbi5sb2FkcyhCYXNlNjRVdGlsLmJhc2U2NHVybGRlY29kZVRvU3RyaW5nKHByb3ZpZGVySnNvbikpCiAgICAgICAgICAgIHByb3ZpZGVyID0gb2JqW3NlbGYucHJvdmlkZXJLZXldCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGdldFByb3ZpZGVyRnJvbUpzb24uIENvdWxkIG5vdCBwYXJzZSBwcm92aWRlZCBKc29uIHN0cmluZy4gUmV0dXJuaW5nIE5vbmUiCgogICAgICAgIHJldHVybiBwcm92aWRlcgoKCiAgICBkZWYgZ2V0UGFzc3BvcnRSZWRpcmVjdFVybChzZWxmLCBwcm92aWRlcik6CgogICAgICAgICMgcHJvdmlkZXIgaXMgYXNzdW1lZCB0byBleGlzdCBpbiBzZWxmLnJlZ2lzdGVyZWRQcm92aWRlcnMKICAgICAgICB1cmwgPSBOb25lCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmYWNlc0NvbnRleHQgPSBDZGlVdGlsLmJlYW4oRmFjZXNDb250ZXh0KQogICAgICAgICAgICB0b2tlbkVuZHBvaW50ID0gImh0dHBzOi8vJXMvcGFzc3BvcnQvdG9rZW4iICUgZmFjZXNDb250ZXh0LmdldEV4dGVybmFsQ29udGV4dCgpLmdldFJlcXVlc3QoKS5nZXRTZXJ2ZXJOYW1lKCkKCiAgICAgICAgICAgIGh0dHBTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEh0dHBTZXJ2aWNlKQogICAgICAgICAgICBodHRwY2xpZW50ID0gaHR0cFNlcnZpY2UuZ2V0SHR0cHNDbGllbnQoKQoKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBnZXRQYXNzcG9ydFJlZGlyZWN0VXJsLiBPYnRhaW5pbmcgdG9rZW4gZnJvbSBwYXNzcG9ydCBhdCAlcyIgJSB0b2tlbkVuZHBvaW50CiAgICAgICAgICAgIHJlc3VsdFJlc3BvbnNlID0gaHR0cFNlcnZpY2UuZXhlY3V0ZUdldChodHRwY2xpZW50LCB0b2tlbkVuZHBvaW50LCBDb2xsZWN0aW9ucy5zaW5nbGV0b25NYXAoIkFjY2VwdCIsICJ0ZXh0L2pzb24iKSkKICAgICAgICAgICAgaHR0cFJlc3BvbnNlID0gcmVzdWx0UmVzcG9uc2UuZ2V0SHR0cFJlc3BvbnNlKCkKICAgICAgICAgICAgYnl0ZXMgPSBodHRwU2VydmljZS5nZXRSZXNwb25zZUNvbnRlbnQoaHR0cFJlc3BvbnNlKQoKICAgICAgICAgICAgcmVzcG9uc2UgPSBodHRwU2VydmljZS5jb252ZXJ0RW50aXR5VG9TdHJpbmcoYnl0ZXMpCiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0UGFzc3BvcnRSZWRpcmVjdFVybC4gUmVzcG9uc2Ugd2FzICVzIiAlIGh0dHBSZXNwb25zZS5nZXRTdGF0dXNMaW5lKCkuZ2V0U3RhdHVzQ29kZSgpCgogICAgICAgICAgICB0b2tlbk9iaiA9IGpzb24ubG9hZHMocmVzcG9uc2UpCiAgICAgICAgICAgIHVybCA9ICIvcGFzc3BvcnQvYXV0aC8lcy8lcyIgJSAocHJvdmlkZXIsIHRva2VuT2JqWyJ0b2tlbl8iXSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0UGFzc3BvcnRSZWRpcmVjdFVybC4gRXJyb3IgYnVpbGRpbmcgcmVkaXJlY3QgVVJMOiAiLCBzeXMuZXhjX2luZm8oKVsxXQoKICAgICAgICByZXR1cm4gdXJsCgoKICAgIGRlZiB2YWxpZFNpZ25hdHVyZShzZWxmLCBqd3QpOgoKICAgICAgICBwcmludCAiUGFzc3BvcnQuIHZhbGlkU2lnbmF0dXJlLiBDaGVja2luZyBKV1QgdG9rZW4gc2lnbmF0dXJlIgogICAgICAgIHZhbGlkID0gRmFsc2UKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBDb25maWd1cmF0aW9uID0gQXBwQ29uZmlndXJhdGlvbigpCiAgICAgICAgICAgIGFwcENvbmZpZ3VyYXRpb24uc2V0V2ViS2V5c1N0b3JhZ2UoV2ViS2V5U3RvcmFnZS5LRVlTVE9SRSkKICAgICAgICAgICAgYXBwQ29uZmlndXJhdGlvbi5zZXRLZXlTdG9yZUZpbGUoc2VsZi5rZXlTdG9yZUZpbGUpCiAgICAgICAgICAgIGFwcENvbmZpZ3VyYXRpb24uc2V0S2V5U3RvcmVTZWNyZXQoc2VsZi5rZXlTdG9yZVBhc3N3b3JkKQogICAgICAgICAgICBhcHBDb25maWd1cmF0aW9uLnNldEtleVJlZ2VuZXJhdGlvbkVuYWJsZWQoRmFsc2UpCgogICAgICAgICAgICBjcnlwdG9Qcm92aWRlciA9IENyeXB0b1Byb3ZpZGVyRmFjdG9yeS5nZXRDcnlwdG9Qcm92aWRlcihhcHBDb25maWd1cmF0aW9uKQogICAgICAgICAgICB2YWxpZCA9IGNyeXB0b1Byb3ZpZGVyLnZlcmlmeVNpZ25hdHVyZShqd3QuZ2V0U2lnbmluZ0lucHV0KCksIGp3dC5nZXRFbmNvZGVkU2lnbmF0dXJlKCksIGp3dC5nZXRIZWFkZXIoKS5nZXRLZXlJZCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5vbmUsIE5vbmUsIGp3dC5nZXRIZWFkZXIoKS5nZXRTaWduYXR1cmVBbGdvcml0aG0oKSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJFeGNlcHRpb246ICIsIHN5cy5leGNfaW5mbygpWzFdCgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gdmFsaWRTaWduYXR1cmUuIFZhbGlkYXRpb24gcmVzdWx0IHdhcyAlcyIgJSB2YWxpZAogICAgICAgIHJldHVybiB2YWxpZAoKCiAgICBkZWYgand0SGFzRXhwaXJlZChzZWxmLCBqd3QpOgogICAgICAgICMgQ2hlY2sgaWYgand0IGhhcyBleHBpcmVkCiAgICAgICAgand0X2NsYWltcyA9IGp3dC5nZXRDbGFpbXMoKQogICAgICAgIHRyeToKICAgICAgICAgICAgZXhwX2RhdGUgPSBqd3RfY2xhaW1zLmdldENsYWltQXNEYXRlKEp3dENsYWltTmFtZS5FWFBJUkFUSU9OX1RJTUUpCiAgICAgICAgICAgIGhhc0V4cGlyZWQgPSBleHBfZGF0ZSA8IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwcmludCAiRXhjZXB0aW9uOiBUaGUgSldUIGRvZXMgbm90IGhhdmUgJyVzJyBhdHRyaWJ1dGUiICUgSnd0Q2xhaW1OYW1lLkVYUElSQVRJT05fVElNRQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgcmV0dXJuIGhhc0V4cGlyZWQKCgogICAgZGVmIGdldFVzZXJQcm9maWxlKHNlbGYsIGp3dCk6CiAgICAgICAgand0X2NsYWltcyA9IGp3dC5nZXRDbGFpbXMoKQogICAgICAgIHVzZXJfcHJvZmlsZV9qc29uID0gTm9uZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHVzZXJfcHJvZmlsZV9qc29uID0gQ2RpVXRpbC5iZWFuKEVuY3J5cHRpb25TZXJ2aWNlKS5kZWNyeXB0KGp3dF9jbGFpbXMuZ2V0Q2xhaW1Bc1N0cmluZygiZGF0YSIpKQogICAgICAgICAgICB1c2VyX3Byb2ZpbGUgPSBqc29uLmxvYWRzKHVzZXJfcHJvZmlsZV9qc29uKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBnZXRVc2VyUHJvZmlsZS4gUHJvYmxlbSBvYnRhaW5pbmcgdXNlciBwcm9maWxlIGpzb24gcmVwcmVzZW50YXRpb24iCgogICAgICAgIHJldHVybiAodXNlcl9wcm9maWxlLCB1c2VyX3Byb2ZpbGVfanNvbikKCgogICAgZGVmIGF0dGVtcHRBdXRoZW50aWNhdGlvbihzZWxmLCBpZGVudGl0eSwgdXNlcl9wcm9maWxlLCB1c2VyX3Byb2ZpbGVfanNvbik6CgogICAgICAgIHVpZEtleSA9ICJ1aWQiCiAgICAgICAgaWYgbm90IHNlbGYuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZXModXNlcl9wcm9maWxlLCBbdWlkS2V5LCBzZWxmLnByb3ZpZGVyS2V5XSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBwcm92aWRlciA9IHVzZXJfcHJvZmlsZVtzZWxmLnByb3ZpZGVyS2V5XQogICAgICAgIGlmIG5vdCBwcm92aWRlciBpbiBzZWxmLnJlZ2lzdGVyZWRQcm92aWRlcnM6CiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXR0ZW1wdEF1dGhlbnRpY2F0aW9uLiBJZGVudGl0eSBQcm92aWRlciAlcyBub3QgcmVjb2duaXplZCIgJSBwcm92aWRlcgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgdWlkID0gdXNlcl9wcm9maWxlW3VpZEtleV1bMF0KICAgICAgICBleHRlcm5hbFVpZCA9ICJwYXNzcG9ydC0lczolcyIgJSAocHJvdmlkZXIsIHVpZCkKCiAgICAgICAgdXNlclNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oVXNlclNlcnZpY2UpCiAgICAgICAgdXNlckJ5VWlkID0gdXNlclNlcnZpY2UuZ2V0VXNlckJ5QXR0cmlidXRlKCJveEV4dGVybmFsVWlkIiwgZXh0ZXJuYWxVaWQpCgogICAgICAgIGVtYWlsID0gTm9uZQogICAgICAgIGlmICJtYWlsIiBpbiB1c2VyX3Byb2ZpbGU6CiAgICAgICAgICAgIGVtYWlsID0gdXNlcl9wcm9maWxlWyJtYWlsIl0KICAgICAgICAgICAgaWYgbGVuKGVtYWlsKSA9PSAwOgogICAgICAgICAgICAgICAgZW1haWwgPSBOb25lCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBlbWFpbCA9IGVtYWlsWzBdCiAgICAgICAgICAgICAgICB1c2VyX3Byb2ZpbGVbIm1haWwiXSA9IFsgZW1haWwgXQoKICAgICAgICBpZiBlbWFpbCA9PSBOb25lIGFuZCBzZWxmLnJlZ2lzdGVyZWRQcm92aWRlcnNbcHJvdmlkZXJdWyJyZXF1ZXN0Rm9yRW1haWwiXToKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBhdHRlbXB0QXV0aGVudGljYXRpb24uIEVtYWlsIHdhcyBub3QgcmVjZWl2ZWQiCgogICAgICAgICAgICBpZiB1c2VyQnlVaWQgIT0gTm9uZToKICAgICAgICAgICAgICAgICMgVGhpcyBhdm9pZHMgYXNraW5nIGZvciB0aGUgZW1haWwgb3ZlciBldmVyeSBsb2dpbiBhdHRlbXB0CiAgICAgICAgICAgICAgICBlbWFpbCA9IHVzZXJCeVVpZC5nZXRBdHRyaWJ1dGUoIm1haWwiKQogICAgICAgICAgICAgICAgaWYgZW1haWwgIT0gTm9uZToKICAgICAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGF0dGVtcHRBdXRoZW50aWNhdGlvbi4gRmlsbGluZyBtaXNzaW5nIGVtYWlsIHZhbHVlIHdpdGggJXMiICUgZW1haWwKICAgICAgICAgICAgICAgICAgICB1c2VyX3Byb2ZpbGVbIm1haWwiXSA9IFsgZW1haWwgXQoKICAgICAgICAgICAgaWYgZW1haWwgPT0gTm9uZToKICAgICAgICAgICAgICAgICMgU3RvcmUgdXNlciBwcm9maWxlIGluIHNlc3Npb24gYW5kIGFib3J0IHRoaXMgcm91dGluZQogICAgICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigicGFzc3BvcnRfdXNlcl9wcm9maWxlIiwgdXNlcl9wcm9maWxlX2pzb24pCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICB1c2VyQnlNYWlsID0gTm9uZSBpZiBlbWFpbCA9PSBOb25lIGVsc2UgdXNlclNlcnZpY2UuZ2V0VXNlckJ5QXR0cmlidXRlKCJtYWlsIiwgZW1haWwpCgogICAgICAgICMgRGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBhZGQgZW50cnksIHVwZGF0ZSBleGlzdGluZywgb3IgZGVueSBhY2Nlc3MKICAgICAgICBkb1VwZGF0ZSA9IEZhbHNlCiAgICAgICAgZG9BZGQgPSBGYWxzZQogICAgICAgIGlmIHVzZXJCeVVpZCAhPSBOb25lOgogICAgICAgICAgICBwcmludCAiVXNlciB3aXRoIGV4dGVybmFsVWlkICclcycgYWxyZWFkeSBleGlzdHMiICUgZXh0ZXJuYWxVaWQKICAgICAgICAgICAgaWYgdXNlckJ5TWFpbCA9PSBOb25lOgogICAgICAgICAgICAgICAgZG9VcGRhdGUgPSBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiB1c2VyQnlNYWlsLmdldFVzZXJJZCgpID09IHVzZXJCeVVpZC5nZXRVc2VySWQoKToKICAgICAgICAgICAgICAgICAgICBkb1VwZGF0ZSA9IFRydWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlVzZXJzIHdpdGggZXh0ZXJuYWxVaWQgJyVzJyBhbmQgbWFpbCAnJXMnIGFyZSBkaWZmZXJlbnQuIEFjY2VzcyB3aWxsIGJlIGRlbmllZC4gSW1wZXJzb25hdGlvbiBhdHRlbXB0PyIgJSAoZXh0ZXJuYWxVaWQsIGVtYWlsKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0TWVzc2FnZUVycm9yKEZhY2VzTWVzc2FnZS5TRVZFUklUWV9FUlJPUiwgIkVtYWlsIHZhbHVlIGNvcnJlc3BvbmRzIHRvIGFuIGFscmVhZHkgZXhpc3RpbmcgcHJvdmlzaW9uZWQgYWNjb3VudCIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgdXNlckJ5TWFpbCA9PSBOb25lOgogICAgICAgICAgICAgICAgZG9BZGQgPSBUcnVlCiAgICAgICAgICAgIGVsaWYgc2VsZi5yZWdpc3RlcmVkUHJvdmlkZXJzW3Byb3ZpZGVyXVsiZW1haWxMaW5raW5nU2FmZSJdOgoKICAgICAgICAgICAgICAgIHRtcExpc3QgPSB1c2VyQnlNYWlsLmdldEF0dHJpYnV0ZVZhbHVlcygib3hFeHRlcm5hbFVpZCIpCiAgICAgICAgICAgICAgICB0bXBMaXN0ID0gQXJyYXlMaXN0KCkgaWYgdG1wTGlzdCA9PSBOb25lIGVsc2UgQXJyYXlMaXN0KHRtcExpc3QpCiAgICAgICAgICAgICAgICB0bXBMaXN0LmFkZChleHRlcm5hbFVpZCkKICAgICAgICAgICAgICAgIHVzZXJCeU1haWwuc2V0QXR0cmlidXRlKCJveEV4dGVybmFsVWlkIiwgdG1wTGlzdCkKCiAgICAgICAgICAgICAgICB1c2VyQnlVaWQgPSB1c2VyQnlNYWlsCiAgICAgICAgICAgICAgICBwcmludCAiRXh0ZXJuYWwgdXNlciBzdXBwbHlpbmcgbWFpbCAlcyB3aWxsIGJlIGxpbmtlZCB0byBleGlzdGluZyBhY2NvdW50ICclcyciICUgKGVtYWlsLCB1c2VyQnlNYWlsLmdldFVzZXJJZCgpKQogICAgICAgICAgICAgICAgZG9VcGRhdGUgPSBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludCAiQW4gYXR0ZW1wdCB0byBzdXBwbHkgYW4gZW1haWwgb2YgYW4gZXhpc3RpbmcgdXNlciB3YXMgbWFkZS4gVHVybiBvbiAnZW1haWxMaW5raW5nU2FmZScgaWYgeW91IHdhbnQgdG8gZW5hYmxlIGxpbmtpbmciCiAgICAgICAgICAgICAgICBzZWxmLnNldE1lc3NhZ2VFcnJvcihGYWNlc01lc3NhZ2UuU0VWRVJJVFlfRVJST1IsICJFbWFpbCB2YWx1ZSBjb3JyZXNwb25kcyB0byBhbiBhbHJlYWR5IGV4aXN0aW5nIGFjY291bnQuIElmIHlvdSBhbHJlYWR5IGhhdmUgYSB1c2VybmFtZSBhbmQgcGFzc3dvcmQgdXNlIHRob3NlIGluc3RlYWQgb2YgYW4gZXh0ZXJuYWwgYXV0aGVudGljYXRpb24gc2l0ZSB0byBnZXQgYWNjZXNzLiIpCgogICAgICAgIHVzZXJuYW1lID0gTm9uZQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgZG9VcGRhdGU6CiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHVzZXJCeVVpZC5nZXRVc2VySWQoKQogICAgICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBhdHRlbXB0QXV0aGVudGljYXRpb24uIFVwZGF0aW5nIHVzZXIgJXMiICUgdXNlcm5hbWUKICAgICAgICAgICAgICAgIHNlbGYudXBkYXRlVXNlcih1c2VyQnlVaWQsIHVzZXJfcHJvZmlsZSwgdXNlclNlcnZpY2UpCiAgICAgICAgICAgIGVsaWYgZG9BZGQ6CiAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGF0dGVtcHRBdXRoZW50aWNhdGlvbi4gQ3JlYXRpbmcgdXNlciAlcyIgJSBleHRlcm5hbFVpZAogICAgICAgICAgICAgICAgbmV3VXNlciA9IHNlbGYuYWRkVXNlcihleHRlcm5hbFVpZCwgdXNlcl9wcm9maWxlLCB1c2VyU2VydmljZSkKICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gbmV3VXNlci5nZXRVc2VySWQoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIkV4Y2VwdGlvbjogIiwgc3lzLmV4Y19pbmZvKClbMV0KICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBhdHRlbXB0QXV0aGVudGljYXRpb24uIEF1dGhlbnRpY2F0aW9uIGZhaWxlZCIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIGlmIHVzZXJuYW1lID09IE5vbmU6CiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXR0ZW1wdEF1dGhlbnRpY2F0aW9uLiBBdXRoZW50aWNhdGlvbiBhdHRlbXB0IHdhcyByZWplY3RlZCIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VkX2luID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkuYXV0aGVudGljYXRlKHVzZXJuYW1lKQogICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGF0dGVtcHRBdXRoZW50aWNhdGlvbi4gQXV0aGVudGljYXRpb24gZm9yICVzIHJldHVybmVkICVzIiAlICh1c2VybmFtZSwgbG9nZ2VkX2luKQogICAgICAgICAgICByZXR1cm4gbG9nZ2VkX2luCgoKICAgIGRlZiBzZXRNZXNzYWdlRXJyb3Ioc2VsZiwgc2V2ZXJpdHksIG1zZyk6CiAgICAgICAgZmFjZXNNZXNzYWdlcyA9IENkaVV0aWwuYmVhbihGYWNlc01lc3NhZ2VzKQogICAgICAgIGZhY2VzTWVzc2FnZXMuc2V0S2VlcE1lc3NhZ2VzKCkKICAgICAgICBmYWNlc01lc3NhZ2VzLmNsZWFyKCkKICAgICAgICBmYWNlc01lc3NhZ2VzLmFkZChzZXZlcml0eSwgbXNnKQoKCiAgICBkZWYgY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZXMoc2VsZiwgcHJvZmlsZSwgYXR0cnMpOgoKICAgICAgICBmb3IgYXR0ciBpbiBhdHRyczoKICAgICAgICAgICAgaWYgKG5vdCBhdHRyIGluIHByb2ZpbGUpIG9yIGxlbihwcm9maWxlW2F0dHJdKSA9PSAwOgogICAgICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBjaGVja1JlcXVpcmVkQXR0cmlidXRlcy4gQXR0cmlidXRlICclcycgaXMgbWlzc2luZyBpbiBwcm9maWxlIiAlIGF0dHIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHJldHVybiBUcnVlCgoKICAgIGRlZiBhZGRVc2VyKHNlbGYsIGV4dGVybmFsVWlkLCBwcm9maWxlLCB1c2VyU2VydmljZSk6CgogICAgICAgIG5ld1VzZXIgPSBVc2VyKCkKICAgICAgICAjRmlsbCB1c2VyIGF0dHJzCiAgICAgICAgbmV3VXNlci5zZXRBdHRyaWJ1dGUoIm94RXh0ZXJuYWxVaWQiLCBleHRlcm5hbFVpZCkKICAgICAgICBzZWxmLmZpbGxVc2VyKG5ld1VzZXIsIHByb2ZpbGUpCiAgICAgICAgbmV3VXNlciA9IHVzZXJTZXJ2aWNlLmFkZFVzZXIobmV3VXNlciwgVHJ1ZSkKICAgICAgICByZXR1cm4gbmV3VXNlcgoKCiAgICBkZWYgdXBkYXRlVXNlcihzZWxmLCBmb3VuZFVzZXIsIHByb2ZpbGUsIHVzZXJTZXJ2aWNlKToKCiAgICAgICAgIyB3aGVuIHRoaXMgaXMgZmFsc2UsIHRoZXJlIG1pZ2h0IHN0aWxsIHNvbWUgdXBkYXRlcyB0YWtpbmcgcGxhY2UgKGUuZy4gbm90IHJlbGF0ZWQgdG8gcHJvZmlsZSBhdHRycyByZWxlYXNlZCBieSBleHRlcm5hbCBwcm92aWRlcikKICAgICAgICBpZiAobm90IHNlbGYuc2tpcFByb2ZpbGVVcGRhdGUpOgogICAgICAgICAgICBzZWxmLmZpbGxVc2VyKGZvdW5kVXNlciwgcHJvZmlsZSkKICAgICAgICB1c2VyU2VydmljZS51cGRhdGVVc2VyKGZvdW5kVXNlcikKCgogICAgZGVmIGZpbGxVc2VyKHNlbGYsIGZvdW5kVXNlciwgcHJvZmlsZSk6CgogICAgICAgIGZvciBhdHRyIGluIHByb2ZpbGU6CiAgICAgICAgICAgICMgInByb3ZpZGVyIiBpcyBkaXNyZWdhcmRlZCBpZiBwYXJ0IG9mIG1hcHBpbmcKICAgICAgICAgICAgaWYgYXR0ciAhPSBzZWxmLnByb3ZpZGVyS2V5OgogICAgICAgICAgICAgICAgdmFsdWVzID0gcHJvZmlsZVthdHRyXQogICAgICAgICAgICAgICAgcHJpbnQgIiVzID0gJXMiICUgKGF0dHIsIHZhbHVlcykKICAgICAgICAgICAgICAgIGZvdW5kVXNlci5zZXRBdHRyaWJ1dGUoYXR0ciwgdmFsdWVzKQoKICAgICAgICAgICAgICAgIGlmIGF0dHIgPT0gIm1haWwiOgogICAgICAgICAgICAgICAgICAgIG94dHJ1c3RNYWlscyA9IFtdCiAgICAgICAgICAgICAgICAgICAgZm9yIG1haWwgaW4gdmFsdWVzOgogICAgICAgICAgICAgICAgICAgICAgICBveHRydXN0TWFpbHMuYXBwZW5kKCd7InZhbHVlIjoiJXMiLCJwcmltYXJ5IjpmYWxzZX0nICUgbWFpbCkKICAgICAgICAgICAgICAgICAgICBmb3VuZFVzZXIuc2V0QXR0cmlidXRlKCJveFRydXN0RW1haWwiLCBveHRydXN0TWFpbHMpCg==
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=CB5B-3211,ou=scripts,o=gluu
objectClass: oxCustomScript
objectClass: top
description: Permission Dynamic Scope script
displayName: dynamic_permission
oxEnabled: true
inum: CB5B-3211
oxLevel: 100
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuDQojIENvcHlyaWdodCAoYykgMjAxNiwgR2x1dQ0KIw0KIyBBdXRob3I6IFl1cml5IE1vdmNoYW4NCiMNCg0KZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuc2NvcGUgaW1wb3J0IER5bmFtaWNTY29wZVR5cGUNCmZyb20gb3JnLmdsdXUuc2VydmljZS5jZGkudXRpbCBpbXBvcnQgQ2RpVXRpbA0KZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5jb21tb24gaW1wb3J0IFVzZXJTZXJ2aWNlDQpmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlciwgQXJyYXlIZWxwZXINCmZyb20gamF2YS51dGlsIGltcG9ydCBBcnJheXMsIEFycmF5TGlzdA0KDQppbXBvcnQgamF2YQ0KDQpjbGFzcyBEeW5hbWljU2NvcGUoRHluYW1pY1Njb3BlVHlwZSk6DQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGN1cnJlbnRUaW1lTWlsbGlzKToNCiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzDQoNCiAgICBkZWYgaW5pdChzZWxmLCBjdXN0b21TY3JpcHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcHJpbnQgIlBlcm1pc3Npb24gZHluYW1pYyBzY29wZS4gSW5pdGlhbGl6YXRpb24iDQoNCiAgICAgICAgcHJpbnQgIlBlcm1pc3Npb24gZHluYW1pYyBzY29wZS4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5Ig0KDQogICAgICAgIHJldHVybiBUcnVlICAgDQoNCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6DQogICAgICAgIHByaW50ICJQZXJtaXNzaW9uIGR5bmFtaWMgc2NvcGUuIERlc3Ryb3kiDQogICAgICAgIHByaW50ICJQZXJtaXNzaW9uIGR5bmFtaWMgc2NvcGUuIERlc3Ryb3llZCBzdWNjZXNzZnVsbHkiDQogICAgICAgIHJldHVybiBUcnVlICAgDQoNCiAgICAjIFVwZGF0ZSBKc29uIFdlYiB0b2tlbiBiZWZvcmUgc2lnbmluZy9lbmNyeXByaW5nIGl0DQogICAgIyAgIGR5bmFtaWNTY29wZUNvbnRleHQgaXMgb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuZXh0ZXJuYWwuY29udGV4dC5EeW5hbWljU2NvcGVFeHRlcm5hbENvbnRleHQNCiAgICAjICAgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMgaXMgamF2YS51dGlsLk1hcDxTdHJpbmcsIFNpbXBsZUN1c3RvbVByb3BlcnR5Pg0KICAgIGRlZiB1cGRhdGUoc2VsZiwgZHluYW1pY1Njb3BlQ29udGV4dCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICBwcmludCAiUGVybWlzc2lvbiBkeW5hbWljIHNjb3BlIHNjb3BlLiBVcGRhdGUgbWV0aG9kIg0KDQogICAgICAgIGF1dGhvcml6YXRpb25HcmFudCA9IGR5bmFtaWNTY29wZUNvbnRleHQuZ2V0QXV0aG9yaXphdGlvbkdyYW50KCkNCiAgICAgICAgdXNlciA9IGR5bmFtaWNTY29wZUNvbnRleHQuZ2V0VXNlcigpDQogICAgICAgIGpzb25XZWJSZXNwb25zZSA9IGR5bmFtaWNTY29wZUNvbnRleHQuZ2V0SnNvbldlYlJlc3BvbnNlKCkNCiAgICAgICAgY2xhaW1zID0ganNvbldlYlJlc3BvbnNlLmdldENsYWltcygpDQoNCiAgICAgICAgdXNlclNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oVXNlclNlcnZpY2UpDQogICAgICAgIHJvbGVzID0gdXNlclNlcnZpY2UuZ2V0Q3VzdG9tQXR0cmlidXRlKHVzZXIsICJyb2xlIikNCiAgICAgICAgaWYgcm9sZXMgIT0gTm9uZToNCiAgICAgICAgICAgIGNsYWltcy5zZXRDbGFpbSgicm9sZSIsIHJvbGVzLmdldFZhbHVlcygpKQ0KDQogICAgICAgIHJldHVybiBUcnVlDQoNCiAgICBkZWYgZ2V0U3VwcG9ydGVkQ2xhaW1zKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcmV0dXJuIEFycmF5cy5hc0xpc3QoInJvbGUiKQ0KDQogICAgZGVmIGdldEFwaVZlcnNpb24oc2VsZik6DQogICAgICAgIHJldHVybiAxMQ0K
oxScriptType: dynamic_scope
programmingLanguage: python

dn: inum=031C-4A65,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample Id Generator script
displayName: id_generator
oxEnabled: false
inum: 031C-4A65
oxLevel: 100
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuaWQgaW1wb3J0IElkR2VuZXJhdG9yVHlwZQpmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlciwgQXJyYXlIZWxwZXIKZnJvbSBqYXZhLnV0aWwgaW1wb3J0IEFycmF5cywgQXJyYXlMaXN0CgppbXBvcnQgamF2YQoKY2xhc3MgSWRHZW5lcmF0b3IoSWRHZW5lcmF0b3JUeXBlKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6CiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIklkIGdlbmVyYXRvci4gSW5pdGlhbGl6YXRpb24iCiAgICAgICAgcHJpbnQgIklkIGdlbmVyYXRvci4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgoKICAgICAgICByZXR1cm4gVHJ1ZSAgIAoKICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiSWQgZ2VuZXJhdG9yLiBEZXN0cm95IgogICAgICAgIHByaW50ICJJZCBnZW5lcmF0b3IuIERlc3Ryb3llZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUgICAKCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToKICAgICAgICByZXR1cm4gMTEKCiAgICAjIElkIGdlbmVyYXRvciBpbml0IG1ldGhvZAogICAgIyAgIGFwcElkIGlzIGFwcGxpY2F0aW9uIElkCiAgICAjICAgaWRUeXBlIGlzIElkIFR5cGUKICAgICMgICBpZFByZWZpeCBpcyBJZCBQcmVmaXgKICAgICMgICB1c2VyIGlzIG9yZy5nbHV1Lm94dHJ1c3QubW9kZWwuR2x1dUN1c3RvbVBlcnNvbgogICAgIyAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eT4KICAgIGRlZiBnZW5lcmF0ZUlkKHNlbGYsIGFwcElkLCBpZFR5cGUsIGlkUHJlZml4LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIklkIGdlbmVyYXRvci4gR2VuZXJhdGUgSWQiCiAgICAgICAgcHJpbnQgIklkIGdlbmVyYXRvci4gR2VuZXJhdGUgSWQuIEFwcElkOiAnIiwgYXBwSWQsICInLCBJZFR5cGU6ICciLCBpZFR5cGUsICInLCBJZFByZWZpeDogJyIsIGlkUHJlZml4LCAiJyIKCiAgICAgICAgIyBSZXR1cm4gTm9uZSBvciBlbXB0eSBzdHJpbmcgdG8gdHJpZ2dlciBkZWZhdWx0IElkIGdlbmVyYXRpb24gbWV0aG9kCiAgICAgICAgcmV0dXJuIE5vbmUK
oxScriptType: id_generator
programmingLanguage: python

dn: inum=031C-5621,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample Dynamic Scope script for org_name
displayName: org_name
oxEnabled: false
inum: 031C-5621
oxLevel: 100
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuDQojIENvcHlyaWdodCAoYykgMjAxNiwgR2x1dQ0KIw0KIyBBdXRob3I6IFl1cml5IE1vdmNoYW4NCiMNCg0KZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuc2NvcGUgaW1wb3J0IER5bmFtaWNTY29wZVR5cGUNCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuY29tbW9uIGltcG9ydCBVc2VyU2VydmljZQ0KZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIsIEFycmF5SGVscGVyDQpmcm9tIGphdmEudXRpbCBpbXBvcnQgQXJyYXlzLCBBcnJheUxpc3QNCg0KaW1wb3J0IGphdmENCg0KY2xhc3MgRHluYW1pY1Njb3BlKER5bmFtaWNTY29wZVR5cGUpOg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6DQogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcw0KDQogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6DQogICAgICAgIHByaW50ICJEeW5hbWljIHNjb3BlLiBJbml0aWFsaXphdGlvbiINCg0KICAgICAgICBwcmludCAiRHluYW1pYyBzY29wZS4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5Ig0KDQogICAgICAgIHJldHVybiBUcnVlICAgDQoNCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6DQogICAgICAgIHByaW50ICJEeW5hbWljIHNjb3BlLiBEZXN0cm95Ig0KICAgICAgICBwcmludCAiRHluYW1pYyBzY29wZS4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSINCiAgICAgICAgcmV0dXJuIFRydWUgICANCg0KICAgICMgVXBkYXRlIEpzb24gV2ViIHRva2VuIGJlZm9yZSBzaWduaW5nL2VuY3J5cHJpbmcgaXQNCiAgICAjICAgZHluYW1pY1Njb3BlQ29udGV4dCBpcyBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5leHRlcm5hbC5jb250ZXh0LkR5bmFtaWNTY29wZUV4dGVybmFsQ29udGV4dA0KICAgICMgICBjb25maWd1cmF0aW9uQXR0cmlidXRlcyBpcyBqYXZhLnV0aWwuTWFwPFN0cmluZywgU2ltcGxlQ3VzdG9tUHJvcGVydHk+DQogICAgZGVmIHVwZGF0ZShzZWxmLCBkeW5hbWljU2NvcGVDb250ZXh0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6DQogICAgICAgIHByaW50ICJEeW5hbWljIHNjb3BlLiBVcGRhdGUgbWV0aG9kIg0KDQogICAgICAgIGR5bmFtaWNTY29wZXMgPSBkeW5hbWljU2NvcGVDb250ZXh0LmdldER5bmFtaWNTY29wZXMoKQ0KICAgICAgICBhdXRob3JpemF0aW9uR3JhbnQgPSBkeW5hbWljU2NvcGVDb250ZXh0LmdldEF1dGhvcml6YXRpb25HcmFudCgpDQogICAgICAgIHVzZXIgPSBkeW5hbWljU2NvcGVDb250ZXh0LmdldFVzZXIoKQ0KICAgICAgICBqc29uV2ViUmVzcG9uc2UgPSBkeW5hbWljU2NvcGVDb250ZXh0LmdldEpzb25XZWJSZXNwb25zZSgpDQogICAgICAgIGNsYWltcyA9IGpzb25XZWJSZXNwb25zZS5nZXRDbGFpbXMoKQ0KDQogICAgICAgICMgQWRkIG9yZ2FuaXphdGlvbiBuYW1lIGlmIHRoZXJlIGlzIHNjb3BlID0gb3JnX25hbWUNCiAgICAgICAgY2xhaW1zLnNldENsYWltKCJvcmdfbmFtZSIsICJHbHV1LCBJbmMuIikNCg0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgZGVmIGdldFN1cHBvcnRlZENsYWltcyhzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6DQogICAgICAgIHJldHVybiBBcnJheXMuYXNMaXN0KCJvcmdfbmFtZSIpDQoNCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToNCiAgICAgICAgcmV0dXJuIDExDQo=
oxScriptType: dynamic_scope
programmingLanguage: python

dn: inum=031C-5622,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample Dynamic Scope script for work_phone
displayName: work_phone
oxEnabled: false
inum: 031C-5622
oxLevel: 100
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuDQojIENvcHlyaWdodCAoYykgMjAxNiwgR2x1dQ0KIw0KIyBBdXRob3I6IFl1cml5IE1vdmNoYW4NCiMNCg0KZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuc2NvcGUgaW1wb3J0IER5bmFtaWNTY29wZVR5cGUNCmZyb20gb3JnLmdsdXUuc2VydmljZS5jZGkudXRpbCBpbXBvcnQgQ2RpVXRpbA0KZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5jb21tb24gaW1wb3J0IFVzZXJTZXJ2aWNlDQpmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlciwgQXJyYXlIZWxwZXINCmZyb20gamF2YS51dGlsIGltcG9ydCBBcnJheXMsIEFycmF5TGlzdA0KDQppbXBvcnQgamF2YQ0KDQpjbGFzcyBEeW5hbWljU2NvcGUoRHluYW1pY1Njb3BlVHlwZSk6DQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGN1cnJlbnRUaW1lTWlsbGlzKToNCiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzDQoNCiAgICBkZWYgaW5pdChzZWxmLCBjdXN0b21TY3JpcHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcHJpbnQgIkR5bmFtaWMgc2NvcGUuIEluaXRpYWxpemF0aW9uIg0KDQogICAgICAgIHByaW50ICJEeW5hbWljIHNjb3BlLiBJbml0aWFsaXplZCBzdWNjZXNzZnVsbHkiDQoNCiAgICAgICAgcmV0dXJuIFRydWUgICANCg0KICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcHJpbnQgIkR5bmFtaWMgc2NvcGUuIERlc3Ryb3kiDQogICAgICAgIHByaW50ICJEeW5hbWljIHNjb3BlLiBEZXN0cm95ZWQgc3VjY2Vzc2Z1bGx5Ig0KICAgICAgICByZXR1cm4gVHJ1ZSAgIA0KDQogICAgIyBVcGRhdGUgSnNvbiBXZWIgdG9rZW4gYmVmb3JlIHNpZ25pbmcvZW5jcnlwcmluZyBpdA0KICAgICMgICBkeW5hbWljU2NvcGVDb250ZXh0IGlzIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlLmV4dGVybmFsLmNvbnRleHQuRHluYW1pY1Njb3BlRXh0ZXJuYWxDb250ZXh0DQogICAgIyAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eT4NCiAgICBkZWYgdXBkYXRlKHNlbGYsIGR5bmFtaWNTY29wZUNvbnRleHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcHJpbnQgIkR5bmFtaWMgc2NvcGUuIFVwZGF0ZSBtZXRob2QiDQoNCiAgICAgICAgZHluYW1pY1Njb3BlcyA9IGR5bmFtaWNTY29wZUNvbnRleHQuZ2V0RHluYW1pY1Njb3BlcygpDQogICAgICAgIGF1dGhvcml6YXRpb25HcmFudCA9IGR5bmFtaWNTY29wZUNvbnRleHQuZ2V0QXV0aG9yaXphdGlvbkdyYW50KCkNCiAgICAgICAgdXNlciA9IGR5bmFtaWNTY29wZUNvbnRleHQuZ2V0VXNlcigpDQogICAgICAgIGpzb25XZWJSZXNwb25zZSA9IGR5bmFtaWNTY29wZUNvbnRleHQuZ2V0SnNvbldlYlJlc3BvbnNlKCkNCiAgICAgICAgY2xhaW1zID0ganNvbldlYlJlc3BvbnNlLmdldENsYWltcygpDQoNCiAgICAgICAgIyBBZGQgd29yayBwaG9uZSBpZiB0aGVyZSBpcyBzY29wZSA9IHdvcmtfcGhvbmUNCiAgICAgICAgdXNlclNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oVXNlclNlcnZpY2UpDQogICAgICAgIHdvcmtQaG9uZSA9IHVzZXJTZXJ2aWNlLmdldEN1c3RvbUF0dHJpYnV0ZSh1c2VyLCAidGVsZXBob25lTnVtYmVyIikNCiAgICAgICAgaWYgd29ya1Bob25lICE9IE5vbmU6DQogICAgICAgICAgICBjbGFpbXMuc2V0Q2xhaW0oIndvcmtfcGhvbmUiLCB3b3JrUGhvbmUuZ2V0VmFsdWVzKCkpDQoNCiAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgIGRlZiBnZXRTdXBwb3J0ZWRDbGFpbXMoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICByZXR1cm4gQXJyYXlzLmFzTGlzdCgid29ya19waG9uZSIpDQoNCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToNCiAgICAgICAgcmV0dXJuIDExDQo=
oxScriptType: dynamic_scope
programmingLanguage: python

dn: inum=13D3-E7AD,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample Cache Refresh script
displayName: cache_refresh
oxEnabled: false
inum: 13D3-E7AD
oxLevel: 100
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUudXNlciBpbXBvcnQgQ2FjaGVSZWZyZXNoVHlwZQpmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlciwgQXJyYXlIZWxwZXIKZnJvbSBqYXZhLnV0aWwgaW1wb3J0IEFycmF5cywgQXJyYXlMaXN0CmZyb20gb3JnLmdsdXUub3h0cnVzdC5tb2RlbCBpbXBvcnQgR2x1dUN1c3RvbUF0dHJpYnV0ZQpmcm9tIG9yZy5nbHV1Lm1vZGVsLmN1c3RvbS5zY3JpcHQubW9kZWwuYmluZCBpbXBvcnQgQmluZENyZWRlbnRpYWxzCgppbXBvcnQgamF2YQoKY2xhc3MgQ2FjaGVSZWZyZXNoKENhY2hlUmVmcmVzaFR5cGUpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGN1cnJlbnRUaW1lTWlsbGlzKToKICAgICAgICBzZWxmLmN1cnJlbnRUaW1lTWlsbGlzID0gY3VycmVudFRpbWVNaWxsaXMKCiAgICBkZWYgaW5pdChzZWxmLCBjdXN0b21TY3JpcHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiQ2FjaGUgcmVmcmVzaC4gSW5pdGlhbGl6YXRpb24iCiAgICAgICAgcHJpbnQgIkNhY2hlIHJlZnJlc2guIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseSIKCiAgICAgICAgcmV0dXJuIFRydWUgICAKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkNhY2hlIHJlZnJlc2guIERlc3Ryb3kiCiAgICAgICAgcHJpbnQgIkNhY2hlIHJlZnJlc2guIERlc3Ryb3llZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICAjIENoZWNrIGlmIHRoaXMgaW5zdGFuY2UgY29uZm9ybSBzdGFydGluZyBjb25kaXRpb25zIAogICAgIyAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eT4KICAgICMgICByZXR1cm4gVHJ1ZS9GYWxzZQogICAgZGVmIGlzU3RhcnRQcm9jZXNzKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiQ2FjaGUgcmVmcmVzaC4gSXMgc3RhcnQgcHJvY2VzcyBtZXRob2QiCgogICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICAjIEdldCBiaW5kIGNyZWRlbnRpYWxzIHJlcXVpcmVkIHRvIGFjY2VzcyBzb3VyY2Ugc2VydmVyIAogICAgIyAgIGNvbmZpZ0lkIGlzIHRoZSBzb3VyY2Ugc2VydmVyCiAgICAjICAgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMgaXMgamF2YS51dGlsLk1hcDxTdHJpbmcsIFNpbXBsZUN1c3RvbVByb3BlcnR5PgogICAgIyAgIHJldHVybiBOb25lICh1c2UgcGFzc3dvcmQgZnJvbSBjb25maWd1cmF0aW9uKSBvciBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0Lm1vZGVsLmJpbmQuQmluZENyZWRlbnRpYWxzCiAgICBkZWYgZ2V0QmluZENyZWRlbnRpYWxzKHNlbGYsIGNvbmZpZ0lkLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkNhY2hlIHJlZnJlc2guIEdldEJpbmRDcmVkZW50aWFscyBtZXRob2QiCiMgICAgICAgIGlmIGNvbmZpZ0lkID09ICJzb3VyY2UiOgojICAgICAgICAgICAgcmV0dXJuIEJpbmRDcmVkZW50aWFscygiY249RGlyZWN0b3J5IE1hbmFnZXIiLCAicGFzc3dvcmQiKQoKICAgICAgICByZXR1cm4gTm9uZQoKICAgICMgVXBkYXRlIHVzZXIgZW50cnkgYmVmb3JlIHBlcnNpc3QgaXQKICAgICMgICB1c2VyIGlzIG9yZy5nbHV1Lm94dHJ1c3QubW9kZWwuR2x1dUN1c3RvbVBlcnNvbgogICAgIyAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eT4KICAgIGRlZiB1cGRhdGVVc2VyKHNlbGYsIHVzZXIsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiQ2FjaGUgcmVmcmVzaC4gVXBkYXRlVXNlciBtZXRob2QiCgogICAgICAgIGF0dHJpYnV0ZXMgPSB1c2VyLmdldEN1c3RvbUF0dHJpYnV0ZXMoKQoKICAgICAgICAjIEFkZCBuZXcgYXR0cmlidXRlIHByZWZlcnJlZExhbmd1YWdlCiAgICAgICAgYXR0clByZWZmZXJlZExhbmd1YWdlID0gR2x1dUN1c3RvbUF0dHJpYnV0ZSgicHJlZmVycmVkTGFuZ3VhZ2UiLCAiZW4tdXMiKQogICAgICAgIGF0dHJpYnV0ZXMuYWRkKGF0dHJQcmVmZmVyZWRMYW5ndWFnZSkKCiAgICAgICAgIyBBZGQgbmV3IGF0dHJpYnV0ZSB1c2VyUGFzc3dvcmQKICAgICAgICBhdHRyVXNlclBhc3N3b3JkID0gR2x1dUN1c3RvbUF0dHJpYnV0ZSgidXNlclBhc3N3b3JkIiwgInRlc3QiKQogICAgICAgIGF0dHJpYnV0ZXMuYWRkKGF0dHJVc2VyUGFzc3dvcmQpCgogICAgICAgICMgVXBkYXRlIGdpdmVuTmFtZSBhdHRyaWJ1dGUKICAgICAgICBmb3IgYXR0cmlidXRlIGluIGF0dHJpYnV0ZXM6CiAgICAgICAgICAgIGF0dHJOYW1lID0gYXR0cmlidXRlLmdldE5hbWUoKQogICAgICAgICAgICBpZiAoKCJnaXZlbm5hbWUiID09IFN0cmluZ0hlbHBlci50b0xvd2VyQ2FzZShhdHRyTmFtZSkpIGFuZCBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eShhdHRyaWJ1dGUuZ2V0VmFsdWUoKSkpOgogICAgICAgICAgICAgICAgYXR0cmlidXRlLnNldFZhbHVlKFN0cmluZ0hlbHBlci5yZW1vdmVNdWx0aXBsZVNwYWNlcyhhdHRyaWJ1dGUuZ2V0VmFsdWUoKSkgKyAiICh1cGRhdGVkKSIpCgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGdldEFwaVZlcnNpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIDExCg==
oxScriptType: cache_refresh
programmingLanguage: python

dn: inum=24FD-B96E,ou=scripts,o=gluu
objectClass: oxCustomScript
objectClass: top
description: OTP Validation of passwords using Yubicloud authentication module
displayName: yubicloud
oxEnabled: false
inum: 24FD-B96E
oxConfigurationProperty: {"value1":"yubicloud_uri","value2":"api.yubico.com","description":""}
oxConfigurationProperty: {"value1":"yubicloud_api_key","value2":"","description":""}
oxConfigurationProperty: {"value1":"yubicloud_id","value2":"","description":""}
oxLevel: 40
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4sIEFydW5tb3poaQojCgpmcm9tIG9yZy5nbHV1LnNlcnZpY2UuY2RpLnV0aWwgaW1wb3J0IENkaVV0aWwKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VjdXJpdHkgaW1wb3J0IElkZW50aXR5CmZyb20gb3JnLmdsdXUubW9kZWwuY3VzdG9tLnNjcmlwdC50eXBlLmF1dGggaW1wb3J0IFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlIGltcG9ydCBVc2VyU2VydmljZQpmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlcgoKaW1wb3J0IGphdmEKCmltcG9ydCB1cmxsaWIyCmltcG9ydCB1cmxsaWIKaW1wb3J0IHV1aWQKCgpjbGFzcyBQZXJzb25BdXRoZW50aWNhdGlvbihQZXJzb25BdXRoZW50aWNhdGlvblR5cGUpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGN1cnJlbnRUaW1lTWlsbGlzKToKICAgICAgICBzZWxmLmN1cnJlbnRUaW1lTWlsbGlzID0gY3VycmVudFRpbWVNaWxsaXMKCiAgICBkZWYgaW5pdChzZWxmLCBjdXN0b21TY3JpcHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiWXViaWNsb3VkLiBJbml0aWFsaXphdGlvbiIKCiAgICAgICAgc2VsZi5hcGlfc2VydmVyID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJ5dWJpY2xvdWRfdXJpIikuZ2V0VmFsdWUyKCkKICAgICAgICBzZWxmLmFwaV9rZXkgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoInl1YmljbG91ZF9hcGlfa2V5IikuZ2V0VmFsdWUyKCkKICAgICAgICBzZWxmLmNsaWVudF9pZCA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgieXViaWNsb3VkX2lkIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIll1YmljbG91ZC4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQogICAgICAgIAogICAgZGVmIGdldEF1dGhlbnRpY2F0aW9uTWV0aG9kQ2xhaW1zKHNlbGYsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgZGVmIGlzVmFsaWRBdXRoZW50aWNhdGlvbk1ldGhvZChzZWxmLCB1c2FnZVR5cGUsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBbHRlcm5hdGl2ZUF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGF1dGhlbnRpY2F0ZShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIGlmIChzdGVwID09IDEpOgogICAgICAgICAgICBwcmludCAiWXViaWNsb3VkLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMSIKCiAgICAgICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQogICAgICAgICAgICBjcmVkZW50aWFscyA9IGlkZW50aXR5LmdldENyZWRlbnRpYWxzKCkKCiAgICAgICAgICAgIHVzZXJuYW1lID0gY3JlZGVudGlhbHMuZ2V0VXNlcm5hbWUoKQogICAgICAgICAgICBvdHAgPSBjcmVkZW50aWFscy5nZXRQYXNzd29yZCgpCgogICAgICAgICAgICAjIFZhbGlkYXRlIG90cCBsZW5ndGgKICAgICAgICAgICAgaWYgbGVuKG90cCkgPCAzMiBvciBsZW4ob3RwKSA+IDQ4OgogICAgICAgICAgICAgICAgcHJpbnQgIll1YmljbG91ZC4gSW52YWxpZCBPVFAgbGVuZ3RoIgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICB1c2VyX3NlcnZpY2UgPSBDZGlVdGlsLmJlYW4oVXNlclNlcnZpY2UpCiAgICAgICAgICAgIHVzZXIgPSB1c2VyX3NlcnZpY2UuZ2V0VXNlcih1c2VybmFtZSkKCiAgICAgICAgICAgIHB1YmxpY19rZXkgPSB1c2VyLmdldEF0dHJpYnV0ZSgneXViaWtleUlkJykKCiAgICAgICAgICAgICMgTWF0Y2ggdGhlIHVzZXIgd2l0aCB0aGUgeXViaWtleQogICAgICAgICAgICBpZiBwdWJsaWNfa2V5IG5vdCBpbiBvdHA6CiAgICAgICAgICAgICAgICBwcmludCAiWXViaWNsb3VkLiBQdWJsaWMgS2V5IG5vdCBtYXRjaGluZyBPVFAiCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIGRhdGEgPSAiIgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBub25jZSA9IHN0cih1dWlkLnV1aWQ0KCkpLnJlcGxhY2UoIi0iLCAiIikKICAgICAgICAgICAgICAgIHBhcmFtcyA9IHVybGxpYi51cmxlbmNvZGUoeyJpZCI6IHNlbGYuY2xpZW50X2lkLCAib3RwIjogb3RwLCAibm9uY2UiOiBub25jZX0pCiAgICAgICAgICAgICAgICB1cmwgPSAiaHR0cHM6Ly8iICsgc2VsZi5hcGlfc2VydmVyICsgIi93c2FwaS8yLjAvdmVyaWZ5Lz8iICsgcGFyYW1zCiAgICAgICAgICAgICAgICBmID0gdXJsbGliMi51cmxvcGVuKHVybCkKICAgICAgICAgICAgICAgIGRhdGEgPSBmLnJlYWQoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludCAiWXViaWNsb3VkLiBFeGNlcHRpb24gIiwgZQoKICAgICAgICAgICAgaWYgJ3N0YXR1cz1PSycgaW4gZGF0YToKICAgICAgICAgICAgICAgIHVzZXJfc2VydmljZS5hdXRoZW50aWNhdGUodXNlcm5hbWUpCiAgICAgICAgICAgICAgICBwcmludCAiWXViaWNsb3VkLiBBdXRoZW50aWNhdGlvbiBTdWNjZXNzZnVsIgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgICAgIHByaW50ICJZdWJpY2xvdWQuIEVuZCBvZiBTdGVwIDEuIFJldHVybmluZyBGYWxzZS4iCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBwcmVwYXJlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIGlmIChzdGVwID09IDEpOgogICAgICAgICAgICBwcmludCAiWXViaWNsb3VkLiBQcmVwYXJlIGZvciBTdGVwIDEiCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdldEV4dHJhUGFyYW1ldGVyc0ZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGdldENvdW50QXV0aGVudGljYXRpb25TdGVwcyhzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcmV0dXJuIDEKCiAgICBkZWYgZ2V0UGFnZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIHJldHVybiAiIgoKICAgIGRlZiBnZXROZXh0U3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIHJldHVybiAtMQoKICAgIGRlZiBnZXRMb2dvdXRFeHRlcm5hbFVybChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHByaW50ICJHZXQgZXh0ZXJuYWwgbG9nb3V0IFVSTCBjYWxsIgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGxvZ291dChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHJldHVybiBUcnVlCg==
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=2DAF-F995,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample UMA RPT Policy
displayName: uma_rpt_policy
oxEnabled: false
inum: 2DAF-F995
oxConfigurationProperty: {"value1":"allowed_clients","value2":"1202.0509cc32-059f-4045-ae35-e117f778b65c, 1502.7ffa77ce-515b-44db-8f11-52fb60161201","description":""}
oxLevel: 100
oxRevision: 1
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuDQojIENvcHlyaWdodCAoYykgMjAxNywgR2x1dQ0KIw0KIyBBdXRob3I6IFl1cml5IFphYnJvdmFybnl5DQojDQojIENhbGwgc2VxdWVuY2UNCiMgMS4gRmlyc3QgaXMgY2FsbCBjb25zdHJ1Y3RvciBvZiB0aGUgU2NyaXB0IF9faW5pdF9fDQojIDIuIE5leHQgaW5pdCgpIG1ldGhvZA0KIyAzLiBOZXh0IGdldFJlcXVpcmVkQ2xhaW1zKCkgLSBtZXRob2QgcmV0dXJucyByZXF1aXJlZCBjbGFpbXMsIHNvIFVNQSBlbmdpbmUgY2hlY2tzIHdoZXRoZXINCiMgICAgaW4gcmVxdWVzdCBSUCBwcm92aWRlZCBhbGwgY2xhaW1zIHRoYXQgYXJlIHJlcXVpcmVkLiBQYXkgYXR0ZW50aW9uIHRoYXQgdGhlcmUgY2FuIGJlDQojICAgIG11bHRpcGxlIHNjcmlwdHMgYm91bmQgdG8gdGhlIHNjb3BlcywgbWVhbnMgdGhhdCBVTUEgZW5naW5lIHdpbGwgYnVpbGQgc2V0IG9mIHJlcXVpcmVkIGNsYWltcw0KIyAgICBmcm9tIGFsbCBzY3JpcHRzLiBJZiBub3QgYWxsIGNsYWltcyBhcmUgcHJvdmlkZWQgbmVlZF9pbmZvIGVycm9yIGlzIHNlbnQgdG8gUlAuDQojICAgIER1cmluZyBuZWVkX2luZm8gY29uc3RydWN0aW9uIGdldENsYWltc0dhdGhlcmluZ1NjcmlwdE5hbWUoKSBtZXRob2QgaXMgY2FsbGVkDQojIDQuIGF1dGhvcml6ZSgpIG1ldGhvZCBpcyBjYWxsZWQgaWYgYWxsIHJlcXVpcmVkIGNsYWltcyBhcmUgcHJvdmlkZWQuDQojIDUuIGRlc3Ryb3koKQ0KDQpmcm9tIG9yZy5nbHV1Lm1vZGVsLmN1c3RvbS5zY3JpcHQudHlwZS51bWEgaW1wb3J0IFVtYVJwdFBvbGljeVR5cGUNCmZyb20gb3JnLmdsdXUubW9kZWwudW1hIGltcG9ydCBDbGFpbURlZmluaXRpb25CdWlsZGVyDQpmcm9tIGphdmEubGFuZyBpbXBvcnQgU3RyaW5nDQoNCmNsYXNzIFVtYVJwdFBvbGljeShVbWFScHRQb2xpY3lUeXBlKToNCiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOg0KICAgICAgICBzZWxmLmN1cnJlbnRUaW1lTWlsbGlzID0gY3VycmVudFRpbWVNaWxsaXMNCg0KICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICBwcmludCAiUlBUIFBvbGljeS4gSW5pdGlhbGl6aW5nIC4uLiINCiAgICAgICAgcHJpbnQgIlJQVCBQb2xpY3kuIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseSINCg0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgZGVmIGRlc3Ryb3koc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICBwcmludCAiUlBUIFBvbGljeS4gRGVzdHJveWluZyAuLi4iDQogICAgICAgIHByaW50ICJSUFQgUG9saWN5LiBEZXN0cm95ZWQgc3VjY2Vzc2Z1bGx5Ig0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgZGVmIGdldEFwaVZlcnNpb24oc2VsZik6DQogICAgICAgIHJldHVybiAxMQ0KDQogICAgIyBSZXR1cm5zIHJlcXVpcmVkIGNsYWltcyBkZWZpbml0aW9ucy4NCiAgICAjIFRoaXMgbWV0aG9kIG11c3QgcHJvdmlkZSBkZWZpbml0aW9uIG9mIGFsbCBjbGFpbXMgdGhhdCBpcyB1c2VkIGluICdhdXRob3JpemUnIG1ldGhvZC4NCiAgICAjIE5vdGUgOiBuYW1lIGluIGJvdGggcGxhY2VzIG11c3QgbWF0Y2guDQogICAgIyAlMSRzIC0gcGxhY2Vob2xkZXIgZm9yIGlzc3Vlci4gSXQgdXNlcyBzdGFuZGFyZCBKYXZhIEZvcm1hdHRlciwgZG9jcyA6IGh0dHBzOi8vZG9jcy5vcmFjbGUuY29tL2phdmFzZS83L2RvY3MvYXBpL2phdmEvdXRpbC9Gb3JtYXR0ZXIuaHRtbA0KICAgIGRlZiBnZXRSZXF1aXJlZENsYWltcyhzZWxmLCBjb250ZXh0KTogIyBjb250ZXh0IGlzIHJlZmVyZW5jZSBvZiBvcmcuZ2x1dS5veGF1dGgudW1hLmF1dGhvcml6YXRpb24uVW1hQXV0aG9yaXphdGlvbkNvbnRleHQNCiAgICAgICAganNvbiA9ICIiIlsNCiAgICAgICAgew0KICAgICAgICAgICAgImlzc3VlciIgOiBbICIlMSRzIiBdLA0KICAgICAgICAgICAgIm5hbWUiIDogImNvdW50cnkiLA0KICAgICAgICAgICAgImNsYWltX3Rva2VuX2Zvcm1hdCIgOiBbICJodHRwOi8vb3BlbmlkLm5ldC9zcGVjcy9vcGVuaWQtY29ubmVjdC1jb3JlLTFfMC5odG1sI0lEVG9rZW4iIF0sDQogICAgICAgICAgICAiY2xhaW1fdHlwZSIgOiAic3RyaW5nIiwNCiAgICAgICAgICAgICJmcmllbmRseV9uYW1lIiA6ICJjb3VudHJ5Ig0KICAgICAgICB9LA0KICAgICAgICB7DQogICAgICAgICAgICAiaXNzdWVyIiA6IFsgIiUxJHMiIF0sDQogICAgICAgICAgICAibmFtZSIgOiAiY2l0eSIsDQogICAgICAgICAgICAiY2xhaW1fdG9rZW5fZm9ybWF0IiA6IFsgImh0dHA6Ly9vcGVuaWQubmV0L3NwZWNzL29wZW5pZC1jb25uZWN0LWNvcmUtMV8wLmh0bWwjSURUb2tlbiIgXSwNCiAgICAgICAgICAgICJjbGFpbV90eXBlIiA6ICJzdHJpbmciLA0KICAgICAgICAgICAgImZyaWVuZGx5X25hbWUiIDogImNpdHkiDQogICAgICAgIH0NCiAgICAgICAgXSIiIg0KICAgICAgICBjb250ZXh0LmFkZFJlZGlyZWN0VXNlclBhcmFtKCJjdXN0b21Vc2VyUGFyYW0xIiwgInZhbHVlMSIpICMgcGFzcyBzb21lIGN1c3RvbSBwYXJhbWV0ZXJzIHRvIG5lZWRfaW5mbyB1cmkuIEl0IGNhbiBiZSByZW1vdmVkIGlmIHlvdSBkb24ndCBuZWVkIGN1c3RvbSBwYXJhbWV0ZXJzLg0KICAgICAgICByZXR1cm4gQ2xhaW1EZWZpbml0aW9uQnVpbGRlci5idWlsZChTdHJpbmcuZm9ybWF0KGpzb24sIGNvbnRleHQuZ2V0SXNzdWVyKCkpKQ0KDQogICAgIyBNYWluIGF1dGhvcml6YXRpb24gbWV0aG9kLiBNdXN0IHJldHVybiBUcnVlIG9yIEZhbHNlLg0KICAgIGRlZiBhdXRob3JpemUoc2VsZiwgY29udGV4dCk6ICMgY29udGV4dCBpcyByZWZlcmVuY2Ugb2Ygb3JnLmdsdXUub3hhdXRoLnVtYS5hdXRob3JpemF0aW9uLlVtYUF1dGhvcml6YXRpb25Db250ZXh0DQogICAgICAgIHByaW50ICJSUFQgUG9saWN5LiBBdXRob3JpemluZyAuLi4iDQoNCiAgICAgICAgaWYgY29udGV4dC5nZXRDbGFpbSgiY291bnRyeSIpID09ICdVUycgYW5kIGNvbnRleHQuZ2V0Q2xhaW0oImNpdHkiKSA9PSAnTlknOg0KICAgICAgICAgICAgcHJpbnQgIkF1dGhvcml6ZWQgc3VjY2Vzc2Z1bGx5ISINCiAgICAgICAgICAgIHJldHVybiBUcnVlDQoNCiAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICAjIFJldHVybnMgbmFtZSBvZiB0aGUgQ2xhaW1zLUdhdGhlcmluZyBzY3JpcHQgd2hpY2ggd2lsbCBiZSBpbnZva2VkIGlmIG5lZWRfaW5mbyBlcnJvciBpcyByZXR1cm5lZC4NCiAgICBkZWYgZ2V0Q2xhaW1zR2F0aGVyaW5nU2NyaXB0TmFtZShzZWxmLCBjb250ZXh0KTogIyBjb250ZXh0IGlzIHJlZmVyZW5jZSBvZiBvcmcuZ2x1dS5veGF1dGgudW1hLmF1dGhvcml6YXRpb24uVW1hQXV0aG9yaXphdGlvbkNvbnRleHQNCiAgICAgICAgY29udGV4dC5hZGRSZWRpcmVjdFVzZXJQYXJhbSgiY3VzdG9tVXNlclBhcmFtMiIsICJ2YWx1ZTIiKSAjIHBhc3Mgc29tZSBjdXN0b20gcGFyYW1ldGVycyB0byBuZWVkX2luZm8gdXJpLiBJdCBjYW4gYmUgcmVtb3ZlZCBpZiB5b3UgZG9uJ3QgbmVlZCBjdXN0b20gcGFyYW1ldGVycy4NCiAgICAgICAgcmV0dXJuICJzYW1wbGVDbGFpbXNHYXRoZXJpbmci
oxScriptType: uma_rpt_policy
programmingLanguage: python

dn: inum=2DAF-F9A5,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Client authorization UMA RPT Policy for SCIM and Passport
displayName: scim_access_policy
oxEnabled: true
inum: 2DAF-F9A5
oxConfigurationProperty: {"value1":"allowed_clients","value2":"1202.0509cc32-059f-4045-ae35-e117f778b65c, 1502.7ffa77ce-515b-44db-8f11-52fb60161201","description":""}
oxLevel: 100
oxRevision: 1
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE3LCBHbHV1CiMKIyBBdXRob3I6IEpvc2UgR29uemFsZXoKIyBBZGFwdGVkIGZyb20gcHJldmlvdXMgMy4wLjEgc2NyaXB0IG9mIFl1cml5IE1vdmNoYW4KIwojIG94Q29uZmlndXJhdGlvblByb3BlcnR5IHJlcXVpcmVkOgojICAgYWxsb3dlZF9jbGllbnRzIC0gY29tbWEgc2VwYXJhdGVkIGxpc3Qgb2YgZG5zIG9mIGFsbG93ZWQgY2xpZW50cwojICAgKGkuZS4gdGhlIFNDSU0gUlAgY2xpZW50KQoKZnJvbSBvcmcuZ2x1dS5veGF1dGgubW9kZWwudW1hIGltcG9ydCBVbWFDb25zdGFudHMKZnJvbSBvcmcuZ2x1dS5tb2RlbC51bWEgaW1wb3J0IENsYWltRGVmaW5pdGlvbkJ1aWxkZXIKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUudW1hIGltcG9ydCBVbWFScHRQb2xpY3lUeXBlCmZyb20gb3JnLmdsdXUuc2VydmljZS5jZGkudXRpbCBpbXBvcnQgQ2RpVXRpbApmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlciwgQXJyYXlIZWxwZXIKZnJvbSBqYXZhLnV0aWwgaW1wb3J0IEFycmF5cywgQXJyYXlMaXN0LCBIYXNoU2V0CmZyb20gamF2YS5sYW5nIGltcG9ydCBTdHJpbmcKCmNsYXNzIFVtYVJwdFBvbGljeShVbWFScHRQb2xpY3lUeXBlKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJSUFQgUG9saWN5LiBJbml0aWFsaXppbmcgLi4uIgogICAgICAgIHNlbGYuY2xpZW50c1NldCA9IHNlbGYucHJlcGFyZUNsaWVudHNTZXQoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpCiAgICAgICAgcHJpbnQgIlJQVCBQb2xpY3kuIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiUlBUIFBvbGljeS4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQoKICAgIGRlZiBnZXRSZXF1aXJlZENsYWltcyhzZWxmLCBjb250ZXh0KToKICAgICAgICBqc29uID0gIiIiWwogICAgICAgIF0iIiIKICAgICAgICByZXR1cm4gQ2xhaW1EZWZpbml0aW9uQnVpbGRlci5idWlsZChqc29uKQoKICAgIGRlZiBhdXRob3JpemUoc2VsZiwgY29udGV4dCk6ICMgY29udGV4dCBpcyByZWZlcmVuY2Ugb2Ygb3JnLmdsdXUub3hhdXRoLnVtYS5hdXRob3JpemF0aW9uLlVtYUF1dGhvcml6YXRpb25Db250ZXh0CiAgICAgICAgcHJpbnQgIlJQVCBQb2xpY3kuIEF1dGhvcml6aW5nIC4uLiIKCiAgICAgICAgY2xpZW50X2lkPWNvbnRleHQuZ2V0Q2xpZW50KCkuZ2V0Q2xpZW50SWQoKQogICAgICAgIHByaW50ICJVbWFScHRQb2xpY3kuIGNsaWVudF9pZCA9ICVzIiAlIGNsaWVudF9pZAoKICAgICAgICBpZiAoU3RyaW5nSGVscGVyLmlzRW1wdHkoY2xpZW50X2lkKSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgIAogICAgICAgIGlmIChzZWxmLmNsaWVudHNTZXQuY29udGFpbnMoY2xpZW50X2lkKSk6CiAgICAgICAgICAgIHByaW50ICJVbWFScHRQb2xpY3kuIEF1dGhvcml6aW5nIGNsaWVudCIKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICBwcmludCAiVW1hUnB0UG9saWN5LiBDbGllbnQgaXNuJ3QgYXV0aG9yaXplZCIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdldENsYWltc0dhdGhlcmluZ1NjcmlwdE5hbWUoc2VsZiwgY29udGV4dCk6CiAgICAgICAgcmV0dXJuIFVtYUNvbnN0YW50cy5OT19TQ1JJUFQKCiAgICBkZWYgcHJlcGFyZUNsaWVudHNTZXQoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIGNsaWVudHNTZXQgPSBIYXNoU2V0KCkKICAgICAgICBpZiAobm90IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJhbGxvd2VkX2NsaWVudHMiKSk6CiAgICAgICAgICAgIHJldHVybiBjbGllbnRzU2V0CgogICAgICAgIGFsbG93ZWRDbGllbnRzTGlzdCA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiYWxsb3dlZF9jbGllbnRzIikuZ2V0VmFsdWUyKCkKICAgICAgICBpZiAoU3RyaW5nSGVscGVyLmlzRW1wdHkoYWxsb3dlZENsaWVudHNMaXN0KSk6CiAgICAgICAgICAgIHByaW50ICJVbWFScHRQb2xpY3kuIFRoZSBwcm9wZXJ0eSBhbGxvd2VkX2NsaWVudHMgaXMgZW1wdHkiCiAgICAgICAgICAgIHJldHVybiBjbGllbnRzU2V0ICAgIAoKICAgICAgICBhbGxvd2VkQ2xpZW50c0xpc3RBcnJheSA9IFN0cmluZ0hlbHBlci5zcGxpdChhbGxvd2VkQ2xpZW50c0xpc3QsICIsIikKICAgICAgICBpZiAoQXJyYXlIZWxwZXIuaXNFbXB0eShhbGxvd2VkQ2xpZW50c0xpc3RBcnJheSkpOgogICAgICAgICAgICBwcmludCAiVW1hUnB0UG9saWN5LiBObyBjbGllbnRzIHNwZWNpZmllZCBpbiBhbGxvd2VkX2NsaWVudHMgcHJvcGVydHkiCiAgICAgICAgICAgIHJldHVybiBjbGllbnRzU2V0CiAgICAgICAgCiAgICAgICAgIyBDb252ZXJ0IHRvIEhhc2hTZXQgdG8gcXVpY2sgc2VhcmNoCiAgICAgICAgaSA9IDAKICAgICAgICBjb3VudCA9IGxlbihhbGxvd2VkQ2xpZW50c0xpc3RBcnJheSkKICAgICAgICB3aGlsZSAoaSA8IGNvdW50KToKICAgICAgICAgICAgY2xpZW50ID0gYWxsb3dlZENsaWVudHNMaXN0QXJyYXlbaV0KICAgICAgICAgICAgY2xpZW50c1NldC5hZGQoY2xpZW50KQogICAgICAgICAgICBpID0gaSArIDEKCiAgICAgICAgcmV0dXJuIGNsaWVudHNTZXQK
oxScriptType: uma_rpt_policy
programmingLanguage: python

dn: inum=OO11-BAFE,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Client authorization UMA RPT Policy for oxtrust api
displayName: oxtrust_api_access_policy
oxEnabled: false
inum: OO11-BAFE
oxConfigurationProperty: {"value1":"allowed_clients","value2":"1402.ea813f43-e860-47fe-8356-7cb31aa03004","description":""}
oxLevel: 100
oxRevision: 1
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE3LCBHbHV1CiMKIyBBdXRob3I6IEpvc2UgR29uemFsZXoKIyBBZGFwdGVkIGZyb20gcHJldmlvdXMgMy4wLjEgc2NyaXB0IG9mIFl1cml5IE1vdmNoYW4KIwojIG94Q29uZmlndXJhdGlvblByb3BlcnR5IHJlcXVpcmVkOgojICAgYWxsb3dlZF9jbGllbnRzIC0gY29tbWEgc2VwYXJhdGVkIGxpc3Qgb2YgZG5zIG9mIGFsbG93ZWQgY2xpZW50cwojICAgKGkuZS4gdGhlIFNDSU0gUlAgY2xpZW50KQoKZnJvbSBvcmcuZ2x1dS5veGF1dGgubW9kZWwudW1hIGltcG9ydCBVbWFDb25zdGFudHMKZnJvbSBvcmcuZ2x1dS5tb2RlbC51bWEgaW1wb3J0IENsYWltRGVmaW5pdGlvbkJ1aWxkZXIKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUudW1hIGltcG9ydCBVbWFScHRQb2xpY3lUeXBlCmZyb20gb3JnLmdsdXUuc2VydmljZS5jZGkudXRpbCBpbXBvcnQgQ2RpVXRpbApmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlciwgQXJyYXlIZWxwZXIKZnJvbSBqYXZhLnV0aWwgaW1wb3J0IEFycmF5cywgQXJyYXlMaXN0LCBIYXNoU2V0CmZyb20gamF2YS5sYW5nIGltcG9ydCBTdHJpbmcKCmNsYXNzIFVtYVJwdFBvbGljeShVbWFScHRQb2xpY3lUeXBlKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJSUFQgUG9saWN5LiBJbml0aWFsaXppbmcgLi4uIgogICAgICAgIHNlbGYuY2xpZW50c1NldCA9IHNlbGYucHJlcGFyZUNsaWVudHNTZXQoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpCiAgICAgICAgcHJpbnQgIlJQVCBQb2xpY3kuIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiUlBUIFBvbGljeS4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQoKICAgIGRlZiBnZXRSZXF1aXJlZENsYWltcyhzZWxmLCBjb250ZXh0KToKICAgICAgICBqc29uID0gIiIiWwogICAgICAgIF0iIiIKICAgICAgICByZXR1cm4gQ2xhaW1EZWZpbml0aW9uQnVpbGRlci5idWlsZChqc29uKQoKICAgIGRlZiBhdXRob3JpemUoc2VsZiwgY29udGV4dCk6ICMgY29udGV4dCBpcyByZWZlcmVuY2Ugb2Ygb3JnLmdsdXUub3hhdXRoLnVtYS5hdXRob3JpemF0aW9uLlVtYUF1dGhvcml6YXRpb25Db250ZXh0CiAgICAgICAgcHJpbnQgIlJQVCBQb2xpY3kuIEF1dGhvcml6aW5nIC4uLiIKCiAgICAgICAgY2xpZW50X2lkPWNvbnRleHQuZ2V0Q2xpZW50KCkuZ2V0Q2xpZW50SWQoKQogICAgICAgIHByaW50ICJVbWFScHRQb2xpY3kuIGNsaWVudF9pZCA9ICVzIiAlIGNsaWVudF9pZAoKICAgICAgICBpZiAoU3RyaW5nSGVscGVyLmlzRW1wdHkoY2xpZW50X2lkKSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgIAogICAgICAgIGlmIChzZWxmLmNsaWVudHNTZXQuY29udGFpbnMoY2xpZW50X2lkKSk6CiAgICAgICAgICAgIHByaW50ICJVbWFScHRQb2xpY3kuIEF1dGhvcml6aW5nIGNsaWVudCIKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICBwcmludCAiVW1hUnB0UG9saWN5LiBDbGllbnQgaXNuJ3QgYXV0aG9yaXplZCIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdldENsYWltc0dhdGhlcmluZ1NjcmlwdE5hbWUoc2VsZiwgY29udGV4dCk6CiAgICAgICAgcmV0dXJuIFVtYUNvbnN0YW50cy5OT19TQ1JJUFQKCiAgICBkZWYgcHJlcGFyZUNsaWVudHNTZXQoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIGNsaWVudHNTZXQgPSBIYXNoU2V0KCkKICAgICAgICBpZiAobm90IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJhbGxvd2VkX2NsaWVudHMiKSk6CiAgICAgICAgICAgIHJldHVybiBjbGllbnRzU2V0CgogICAgICAgIGFsbG93ZWRDbGllbnRzTGlzdCA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiYWxsb3dlZF9jbGllbnRzIikuZ2V0VmFsdWUyKCkKICAgICAgICBpZiAoU3RyaW5nSGVscGVyLmlzRW1wdHkoYWxsb3dlZENsaWVudHNMaXN0KSk6CiAgICAgICAgICAgIHByaW50ICJVbWFScHRQb2xpY3kuIFRoZSBwcm9wZXJ0eSBhbGxvd2VkX2NsaWVudHMgaXMgZW1wdHkiCiAgICAgICAgICAgIHJldHVybiBjbGllbnRzU2V0ICAgIAoKICAgICAgICBhbGxvd2VkQ2xpZW50c0xpc3RBcnJheSA9IFN0cmluZ0hlbHBlci5zcGxpdChhbGxvd2VkQ2xpZW50c0xpc3QsICIsIikKICAgICAgICBpZiAoQXJyYXlIZWxwZXIuaXNFbXB0eShhbGxvd2VkQ2xpZW50c0xpc3RBcnJheSkpOgogICAgICAgICAgICBwcmludCAiVW1hUnB0UG9saWN5LiBObyBjbGllbnRzIHNwZWNpZmllZCBpbiBhbGxvd2VkX2NsaWVudHMgcHJvcGVydHkiCiAgICAgICAgICAgIHJldHVybiBjbGllbnRzU2V0CiAgICAgICAgCiAgICAgICAgIyBDb252ZXJ0IHRvIEhhc2hTZXQgdG8gcXVpY2sgc2VhcmNoCiAgICAgICAgaSA9IDAKICAgICAgICBjb3VudCA9IGxlbihhbGxvd2VkQ2xpZW50c0xpc3RBcnJheSkKICAgICAgICB3aGlsZSAoaSA8IGNvdW50KToKICAgICAgICAgICAgY2xpZW50ID0gYWxsb3dlZENsaWVudHNMaXN0QXJyYXlbaV0KICAgICAgICAgICAgY2xpZW50c1NldC5hZGQoY2xpZW50KQogICAgICAgICAgICBpID0gaSArIDEKCiAgICAgICAgcmV0dXJuIGNsaWVudHNTZXQK
oxScriptType: uma_rpt_policy
programmingLanguage: python

dn: inum=2DAF-F996,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample UMA Claims Gathering
displayName: sampleClaimsGathering
oxEnabled: false
inum: 2DAF-F996
oxLevel: 1
oxRevision: 1
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuDQojIENvcHlyaWdodCAoYykgMjAxNywgR2x1dQ0KIw0KIyBBdXRob3I6IFl1cml5IFphYnJvdmFybnl5DQojDQoNCmZyb20gb3JnLmdsdXUubW9kZWwuY3VzdG9tLnNjcmlwdC50eXBlLnVtYSBpbXBvcnQgVW1hQ2xhaW1zR2F0aGVyaW5nVHlwZQ0KDQpjbGFzcyBVbWFDbGFpbXNHYXRoZXJpbmcoVW1hQ2xhaW1zR2F0aGVyaW5nVHlwZSk6DQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOg0KICAgICAgICBzZWxmLmN1cnJlbnRUaW1lTWlsbGlzID0gY3VycmVudFRpbWVNaWxsaXMNCg0KICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICBwcmludCAiQ2xhaW1zLUdhdGhlcmluZy4gSW5pdGlhbGl6aW5nIC4uLiINCiAgICAgICAgcHJpbnQgIkNsYWltcy1HYXRoZXJpbmcuIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseSINCg0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgZGVmIGRlc3Ryb3koc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICBwcmludCAiQ2xhaW1zLUdhdGhlcmluZy4gRGVzdHJveWluZyAuLi4iDQogICAgICAgIHByaW50ICJDbGFpbXMtR2F0aGVyaW5nLiBEZXN0cm95ZWQgc3VjY2Vzc2Z1bGx5Ig0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgZGVmIGdldEFwaVZlcnNpb24oc2VsZik6DQogICAgICAgIHJldHVybiAxMQ0KDQoNCiAgICAjIE1haW4gZ2F0aGVyIG1ldGhvZC4gTXVzdCByZXR1cm4gVHJ1ZSAoaWYgZ2F0aGVyaW5nIHBlcmZvcm1lZCBzdWNjZXNzZnVsbHkpIG9yIEZhbHNlIChpZiBmYWlsKS4NCiAgICAjIE1ldGhvZCBtdXN0IHNldCBjbGFpbSBpbnRvIGNvbnRleHQgKHZpYSBjb250ZXh0LnB1dENsYWltKCduYW1lJywgdmFsdWUpKSBpbiBvcmRlciB0byBwZXJzaXN0IGl0IChvdGhlcndpc2UgaXQgd2lsbCBiZSBsb3N0KS4NCiAgICAjIEFsbCB1c2VyIGVudGVyZWQgdmFsdWVzIGNhbiBiZSBhY2Nlc3MgdmlhIE1hcDxTdHJpbmcsIFN0cmluZz4gY29udGV4dC5nZXRQYWdlQ2xhaW1zKCkNCiAgICBkZWYgZ2F0aGVyKHNlbGYsIHN0ZXAsIGNvbnRleHQpOiAjIGNvbnRleHQgaXMgcmVmZXJlbmNlIG9mIG9yZy5nbHV1Lm94YXV0aC51bWEuYXV0aG9yaXphdGlvbi5VbWFHYXRoZXJDb250ZXh0DQogICAgICAgIHByaW50ICJDbGFpbXMtR2F0aGVyaW5nLiBHYXRoZXJpbmcgLi4uIg0KDQogICAgICAgIGlmIHN0ZXAgPT0gMToNCiAgICAgICAgICAgIGlmIChjb250ZXh0LmdldFBhZ2VDbGFpbXMoKS5jb250YWluc0tleSgiY291bnRyeSIpKToNCiAgICAgICAgICAgICAgICBjb3VudHJ5ID0gY29udGV4dC5nZXRQYWdlQ2xhaW1zKCkuZ2V0KCJjb3VudHJ5IikNCiAgICAgICAgICAgICAgICBwcmludCAiQ291bnRyeTogIiArIGNvdW50cnkNCg0KICAgICAgICAgICAgICAgIGNvbnRleHQucHV0Q2xhaW0oImNvdW50cnkiLCBjb3VudHJ5KQ0KICAgICAgICAgICAgICAgIHJldHVybiBUcnVlDQoNCiAgICAgICAgICAgIHByaW50ICJDbGFpbXMtR2F0aGVyaW5nLiAnY291bnRyeScgaXMgbm90IHByb3ZpZGVkIG9uIHN0ZXAgMS4iDQogICAgICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgICAgICBlbGlmIHN0ZXAgPT0gMjoNCiAgICAgICAgICAgIGlmIChjb250ZXh0LmdldFBhZ2VDbGFpbXMoKS5jb250YWluc0tleSgiY2l0eSIpKToNCiAgICAgICAgICAgICAgICBjaXR5ID0gY29udGV4dC5nZXRQYWdlQ2xhaW1zKCkuZ2V0KCJjaXR5IikNCiAgICAgICAgICAgICAgICBwcmludCAiQ2l0eTogIiArIGNpdHkNCg0KICAgICAgICAgICAgICAgIGNvbnRleHQucHV0Q2xhaW0oImNpdHkiLCBjaXR5KQ0KICAgICAgICAgICAgICAgIHByaW50ICJDbGFpbXMtR2F0aGVyaW5nLiAnY2l0eScgaXMgbm90IHByb3ZpZGVkIG9uIHN0ZXAgMi4iDQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgIGRlZiBnZXROZXh0U3RlcChzZWxmLCBzdGVwLCBjb250ZXh0KToNCiAgICAgICAgcmV0dXJuIC0xDQoNCiAgICBkZWYgcHJlcGFyZUZvclN0ZXAoc2VsZiwgc3RlcCwgY29udGV4dCk6DQogICAgICAgIGlmIHN0ZXAgPT0gMTAgYW5kIG5vdCBjb250ZXh0LmlzQXV0aGVudGljYXRlZCgpOg0KICAgICAgICAgICAgIyB1c2VyIGlzIG5vdCBhdXRoZW50aWNhdGVkLCBzbyB3ZSBhcmUgcmVkaXJlY3RpbmcgdXNlciB0byBhdXRob3JpemF0aW9uIGVuZHBvaW50DQogICAgICAgICAgICAjIGNsaWVudF9pZCBpcyBzcGVjaWZpZWQgdmlhIGNvbmZpZ3VyYXRpb24gYXR0cmlidXRlLg0KICAgICAgICAgICAgIyBNYWtlIHN1cmUgdGhhdCBnaXZlbiBjbGllbnQgaGFzIHJlZGlyZWN0X3VyaSB0byBDbGFpbXMtR2F0aGVyaW5nIEVuZHBvaW50IHdpdGggcGFyYW1ldGVyIGF1dGhlbnRpY2F0aW9uPXRydWUNCiAgICAgICAgICAgICMgU2FtcGxlIGh0dHBzOi8vc2FtcGxlLmNvbS9yZXN0djEvdW1hL2dhdGhlcl9jbGFpbXM/YXV0aGVudGljYXRpb249dHJ1ZQ0KICAgICAgICAgICAgIyBJZiByZWRpcmVjdCB0byBleHRlcm5hbCB1cmwgaXMgcGVyZm9ybWF0ZWQsIG1ha2Ugc3VyZSB0aGF0IHZpZXdBY3Rpb24gaGFzIG9uUG9zdGJhY2s9InRydWUiIChvdGhlcndpc2UgcmVkaXJlY3Qgd2lsbCBub3Qgd29yaykNCiAgICAgICAgICAgICMgQWZ0ZXIgdXNlciBpcyBhdXRoZW50aWNhdGVkIHRoZW4gd2l0aGluIHRoZSBzY3JpcHQgaXQncyBwb3NzaWJsZSB0byBnZXQgdXNlciBhdHRyaWJ1dGVzIGFzDQogICAgICAgICAgICAjIGNvbnRleHQuZ2V0VXNlcigidWlkIiwgInNuIikNCiAgICAgICAgICAgICMgSWYgdXNlciBpcyBhdXRoZW50aWNhdGVkIHRvIGN1cnJlbnQgQVMgKHRvIHRoZSBzYW1lIHNlcnZlciwgbm90IGV4dGVybmFsIG9uZSkgdGhlbiBpdCdzIHBvc3NpYmxlIHRvDQogICAgICAgICAgICAjIGFjY2VzcyBDb25uZWN0IHNlc3Npb24gYXR0cmlidXRlcyBkaXJlY3RseSAobm8gbmVlZCB0byBvYnRhaW4gaWRfdG9rZW4gYWZ0ZXIgcmVkaXJlY3Qgd2l0aCAnY29kZScpLg0KICAgICAgICAgICAgIyBUbyBmZXRjaCBhdHRyaWJ1dGVzIHBsZWFzZSB1c2UgZ2V0Q29ubmVjdFNlc3Npb25BdHRyaWJ1dGVzKCkgbWV0aG9kLg0KDQogICAgICAgICAgICBwcmludCAiVXNlciBpcyBub3QgYXV0aGVudGljYXRlZC4gUmVkaXJlY3QgZm9yIGF1dGhlbnRpY2F0aW9uIC4uLiINCiAgICAgICAgICAgIGNsaWVudElkID0gY29udGV4dC5nZXRDb25maWd1cmF0aW9uQXR0cmlidXRlcygpLmdldCgiY2xpZW50X2lkIikuZ2V0VmFsdWUyKCkNCiAgICAgICAgICAgIHJlZGlyZWN0VXJpID0gY29udGV4dC5nZXRDbGFpbXNHYXRoZXJpbmdFbmRwb2ludCgpICsgIj9hdXRoZW50aWNhdGlvbj10cnVlIiAjIHdpdGhvdXQgYXV0aGVudGljYXRpb249dHJ1ZSBwYXJhbWV0ZXIgaXQgd2lsbCBub3Qgd29yaw0KICAgICAgICAgICAgYXV0aG9yaXphdGlvblVybCA9IGNvbnRleHQuZ2V0QXV0aG9yaXphdGlvbkVuZHBvaW50KCkgKyAiP2NsaWVudF9pZD0iICsgY2xpZW50SWQgKyAiJnJlZGlyZWN0X3VyaT0iICsgcmVkaXJlY3RVcmkgKyAiJnNjb3BlPW9wZW5pZCZyZXNwb25zZV90eXBlPWNvZGUiDQogICAgICAgICAgICBjb250ZXh0LnJlZGlyZWN0VG9FeHRlcm5hbFVybChhdXRob3JpemF0aW9uVXJsKSAjIHJlZGlyZWN0IHRvIGV4dGVybmFsIHVybA0KICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQogICAgICAgIGlmIHN0ZXAgPT0gMTAgYW5kIGNvbnRleHQuaXNBdXRoZW50aWNhdGVkKCk6ICMgZXhhbXBsZSBob3cgdG8gZ2V0IHNlc3Npb24gYXR0cmlidXRlIGlmIHVzZXIgaXMgYXV0aGVudGljYXRlZCB0byBzYW1lIEFTDQogICAgICAgICAgICBhcmMgPSBjb250ZXh0LmdldENvbm5lY3RTZXNzaW9uQXR0cmlidXRlcygpLmdldCgiYWNyIikNCg0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgZGVmIGdldFN0ZXBzQ291bnQoc2VsZiwgY29udGV4dCk6DQogICAgICAgIHJldHVybiAyDQoNCiAgICBkZWYgZ2V0UGFnZUZvclN0ZXAoc2VsZiwgc3RlcCwgY29udGV4dCk6DQogICAgICAgIGlmIHN0ZXAgPT0gMToNCiAgICAgICAgICAgIHJldHVybiAiL3VtYTIvc2FtcGxlL2NvdW50cnkueGh0bWwiDQogICAgICAgIGVsaWYgc3RlcCA9PSAyOg0KICAgICAgICAgICAgcmV0dXJuICIvdW1hMi9zYW1wbGUvY2l0eS54aHRtbCINCiAgICAgICAgcmV0dXJuICIi
oxScriptType: uma_claims_gathering
programmingLanguage: python

dn: inum=2DAF-AA90,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Introspection Sample Script
displayName: introspection_sample
oxEnabled: false
inum: 2DAF-AA90
oxLevel: 1
oxRevision: 1
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE4LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IFphYnJvdmFybnl5CiMKIwoKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuaW50cm9zcGVjdGlvbiBpbXBvcnQgSW50cm9zcGVjdGlvblR5cGUKZnJvbSBqYXZhLmxhbmcgaW1wb3J0IFN0cmluZwoKY2xhc3MgSW50cm9zcGVjdGlvbihJbnRyb3NwZWN0aW9uVHlwZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJJbnRyb3NwZWN0aW9uIHNjcmlwdC4gSW5pdGlhbGl6aW5nIC4uLiIKICAgICAgICBwcmludCAiSW50cm9zcGVjdGlvbiBzY3JpcHQuIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseSIKCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkludHJvc3BlY3Rpb24gc2NyaXB0LiBEZXN0cm95aW5nIC4uLiIKICAgICAgICBwcmludCAiSW50cm9zcGVjdGlvbiBzY3JpcHQuIERlc3Ryb3llZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToKICAgICAgICByZXR1cm4gMTEKCiAgICAjIFJldHVybnMgYm9vbGVhbiwgdHJ1ZSAtIGFwcGx5IGludHJvc3BlY3Rpb24gbWV0aG9kLCBmYWxzZSAtIGlnbm9yZSBpdC4KICAgICMgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGFmdGVyIGludHJvc3BlY3Rpb24gcmVzcG9uc2UgaXMgcmVhZHkuIFRoaXMgbWV0aG9kIGNhbiBtb2RpZnkgaW50cm9zcGVjdGlvbiByZXNwb25zZS4KICAgICMgTm90ZSA6CiAgICAjIHJlc3BvbnNlQXNKc29uT2JqZWN0IC0gaXMgb3JnLmNvZGVoYXVzLmpldHRpc29uLmpzb24uSlNPTk9iamVjdCwgeW91IGNhbiB1c2UgYW55IG1ldGhvZCB0byBtYW5pcHVsYXRlIGpzb24KICAgICMgY29udGV4dCBpcyByZWZlcmVuY2Ugb2Ygb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuZXh0ZXJuYWwuY29udGV4dC5FeHRlcm5hbEludHJvc3BlY3Rpb25Db250ZXh0IChpbiBodHRwczovL2dpdGh1Yi5jb20vR2x1dUZlZGVyYXRpb24vb3hhdXRoIHByb2plY3QsICkKICAgIGRlZiBtb2RpZnlSZXNwb25zZShzZWxmLCByZXNwb25zZUFzSnNvbk9iamVjdCwgY29udGV4dCk6CiAgICAgICAgcmVzcG9uc2VBc0pzb25PYmplY3QuYWNjdW11bGF0ZSgia2V5X2Zyb21fc2NyaXB0IiwgInZhbHVlX2Zyb21fc2NyaXB0IikKICAgICAgICByZXR1cm4gVHJ1ZQoK
oxScriptType: introspection
programmingLanguage: python

dn: inum=2DAF-BA90,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Introspection Custom Parameters Sample Script
displayName: introspection_custom_params
oxEnabled: false
inum: 2DAF-BA90
oxLevel: 1
oxRevision: 1
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE5LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vY2hhbgojCiMKCmZyb20gb3JnLmdsdXUubW9kZWwuY3VzdG9tLnNjcmlwdC50eXBlLmludHJvc3BlY3Rpb24gaW1wb3J0IEludHJvc3BlY3Rpb25UeXBlCmZyb20gb3JnLmdsdXUub3hhdXRoLm1vZGVsLmNvbW1vbiBpbXBvcnQgQXV0aG9yaXphdGlvbkdyYW50TGlzdApmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlIGltcG9ydCBTZXNzaW9uSWRTZXJ2aWNlCmZyb20gb3JnLmdsdXUuc2VydmljZS5jZGkudXRpbCBpbXBvcnQgQ2RpVXRpbApmcm9tIGphdmEubGFuZyBpbXBvcnQgU3RyaW5nCgpjbGFzcyBJbnRyb3NwZWN0aW9uKEludHJvc3BlY3Rpb25UeXBlKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6CiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkludHJvc3BlY3Rpb24gc2NyaXB0LiBJbml0aWFsaXppbmcgLi4uIgogICAgICAgIHByaW50ICJJbnRyb3NwZWN0aW9uIHNjcmlwdC4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgoKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiSW50cm9zcGVjdGlvbiBzY3JpcHQuIERlc3Ryb3lpbmcgLi4uIgogICAgICAgIHByaW50ICJJbnRyb3NwZWN0aW9uIHNjcmlwdC4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQoKICAgICMgUmV0dXJucyBib29sZWFuLCB0cnVlIC0gYXBwbHkgaW50cm9zcGVjdGlvbiBtZXRob2QsIGZhbHNlIC0gaWdub3JlIGl0LgogICAgIyBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgYWZ0ZXIgaW50cm9zcGVjdGlvbiByZXNwb25zZSBpcyByZWFkeS4gVGhpcyBtZXRob2QgY2FuIG1vZGlmeSBpbnRyb3NwZWN0aW9uIHJlc3BvbnNlLgogICAgIyBOb3RlIDoKICAgICMgcmVzcG9uc2VBc0pzb25PYmplY3QgLSBpcyBvcmcuY29kZWhhdXMuamV0dGlzb24uanNvbi5KU09OT2JqZWN0LCB5b3UgY2FuIHVzZSBhbnkgbWV0aG9kIHRvIG1hbmlwdWxhdGUganNvbgogICAgIyBjb250ZXh0IGlzIHJlZmVyZW5jZSBvZiBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5leHRlcm5hbC5jb250ZXh0LkV4dGVybmFsSW50cm9zcGVjdGlvbkNvbnRleHQgKGluIGh0dHBzOi8vZ2l0aHViLmNvbS9HbHV1RmVkZXJhdGlvbi9veGF1dGggcHJvamVjdCwgKQogICAgZGVmIG1vZGlmeVJlc3BvbnNlKHNlbGYsIHJlc3BvbnNlQXNKc29uT2JqZWN0LCBjb250ZXh0KToKICAgICAgICB0b2tlbiA9IGNvbnRleHQuZ2V0SHR0cFJlcXVlc3QoKS5nZXRQYXJhbWV0ZXIoInRva2VuIikKICAgICAgICBpZiB0b2tlbiBpcyBOb25lOgogICAgICAgICAgICBwcmludCAiSW50cm9zcGVjdGlvbi4gVGhlcmUgaXMgbm8gdG9rZW4gaW4gcmVxdWVzdCIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIGF1dGhvcml6YXRpb25HcmFudExpc3QgPSBDZGlVdGlsLmJlYW4oQXV0aG9yaXphdGlvbkdyYW50TGlzdCkKICAgICAgICBhdXRob3JpemF0aW9uR3JhbnQgPSBhdXRob3JpemF0aW9uR3JhbnRMaXN0LmdldEF1dGhvcml6YXRpb25HcmFudEJ5QWNjZXNzVG9rZW4odG9rZW4pOwogICAgICAgIGlmIGF1dGhvcml6YXRpb25HcmFudCBpcyBOb25lOgogICAgICAgICAgICBwcmludCAiSW50cm9zcGVjdGlvbi4gRmFpbGVkIHRvIGxvYWQgYXV0aG9yaXphdGlvbiBncmFudCBieSB0b2tlbiIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICMgUHV0IHVzZXJfaWQgaW50byByZXNwb25zZQogICAgICAgIHJlc3BvbnNlQXNKc29uT2JqZWN0LmFjY3VtdWxhdGUoInVzZXJfaWQiLCBhdXRob3JpemF0aW9uR3JhbnQuZ2V0VXNlcigpLmdldFVzZXJJZCgpKQoKICAgICAgICAjIFB1dCBjdXN0b20gcGFyYW1ldGVycyBpbnRvIHJlc3BvbnNlCiAgICAgICAgc2Vzc2lvbkRuID0gYXV0aG9yaXphdGlvbkdyYW50LmdldFNlc3Npb25EbigpOwogICAgICAgIGlmIHNlc3Npb25EbiBpcyBOb25lOgogICAgICAgICAgICAjIFRoZXJlIGlzIG5vIHNlc3Npb24KICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgc2Vzc2lvbklkU2VydmljZSA9IENkaVV0aWwuYmVhbihTZXNzaW9uSWRTZXJ2aWNlKQogICAgICAgIHNlc3Npb24gPSBzZXNzaW9uSWRTZXJ2aWNlLmdldFNlc3Npb25CeUlkKHNlc3Npb25EbikKICAgICAgICBpZiBzZXNzaW9uRG4gaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQgIkludHJvc3BlY3Rpb24uIEZhaWxlZCB0byBsb2FkIHNlc3Npb24gJyVzJyIgJSBzZXNzaW9uRG4KICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICMgUmV0dXJuIHNlc3Npb25faWQKICAgICAgICByZXNwb25zZUFzSnNvbk9iamVjdC5hY2N1bXVsYXRlKCJzZXNzaW9uX2lkIiwgc2Vzc2lvbkRuKQogICAgICAgIAogICAgICAgIHNlc3Npb25BdHRyaWJ1dGVzID0gc2Vzc2lvbi5nZXRTZXNzaW9uQXR0cmlidXRlcygpCiAgICAgICAgaWYgc2Vzc2lvbkF0dHJpYnV0ZXMgaXMgTm9uZToKICAgICAgICAgICAgIyBUaGVyZSBpcyBubyBzZXNzaW9uIGF0dHJpYnV0ZXMKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgIyBBcHBlbmQgY3VzdG9tIGNsYWltcwogICAgICAgIGlmIHNlc3Npb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJjdXN0b20xIik6CiAgICAgICAgICAgIHJlc3BvbnNlQXNKc29uT2JqZWN0LmFjY3VtdWxhdGUoImN1c3RvbTEiLCBzZXNzaW9uQXR0cmlidXRlcy5nZXQoImN1c3RvbTEiKSkKICAgICAgICBpZiBzZXNzaW9uQXR0cmlidXRlcy5jb250YWluc0tleSgiY3VzdG9tMiIpOgogICAgICAgICAgICByZXNwb25zZUFzSnNvbk9iamVjdC5hY2N1bXVsYXRlKCJjdXN0b20yIiwgc2Vzc2lvbkF0dHJpYnV0ZXMuZ2V0KCJjdXN0b20yIikpCgogICAgICAgIHJldHVybiBUcnVlCgo=
oxScriptType: introspection
programmingLanguage: python

dn: inum=2DAF-CA90,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Frontchannel logout Sample
displayName: frontchannel_logout_sample
oxEnabled: false
inum: 2DAF-CA90
oxLevel: 1
oxRevision: 1
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxScript:: IyBDb3B5cmlnaHQgKGMpIDIwMjAsIEdsdXUKIwojIEF1dGhvcjogWXVyaXkgWmFicm92YXJueXkKIwoKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUubG9nb3V0IGltcG9ydCBFbmRTZXNzaW9uVHlwZQpmcm9tIGphdmEubGFuZyBpbXBvcnQgU3RyaW5nCgpjbGFzcyBFbmRTZXNzaW9uKEVuZFNlc3Npb25UeXBlKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6CiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkVuZFNlc3Npb24gc2NyaXB0LiBJbml0aWFsaXppbmcgLi4uIgogICAgICAgIHByaW50ICJFbmRTZXNzaW9uIHNjcmlwdC4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgoKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiRW5kU2Vzc2lvbiBzY3JpcHQuIERlc3Ryb3lpbmcgLi4uIgogICAgICAgIHByaW50ICJFbmRTZXNzaW9uIHNjcmlwdC4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQoKICAgICMgUmV0dXJucyBzdHJpbmcsIGl0IG11c3QgYmUgdmFsaWQgSFRNTCAod2l0aCBpZnJhbWVzIGFjY29yZGluZyB0byBzcGVjIGh0dHA6Ly9vcGVuaWQubmV0L3NwZWNzL29wZW5pZC1jb25uZWN0LWZyb250Y2hhbm5lbC0xXzAuaHRtbCkKICAgICMgVGhpcyBtZXRob2QgaXMgY2FsbGVkIG9uIGAvZW5kX3Nlc3Npb25gIGFmdGVyIGFjdHVhbCBzZXNzaW9uIGlzIGtpbGxlZCBhbmQgb3hhdXRoIGNvbnN0cnVjdCBIVE1MIHRvIHJldHVybiB0byBSUC4KICAgICMgTm90ZSA6CiAgICAjIGNvbnRleHQgaXMgcmVmZXJlbmNlIG9mIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlLmV4dGVybmFsLmNvbnRleHQuRW5kU2Vzc2lvbkNvbnRleHQgKGluIGh0dHBzOi8vZ2l0aHViLmNvbS9HbHV1RmVkZXJhdGlvbi9veGF1dGggcHJvamVjdCwgKQogICAgZGVmIGdldEZyb250Y2hhbm5lbEh0bWwoc2VsZiwgY29udGV4dCk6CiAgICAgICAgcmV0dXJuICIi
oxScriptType: end_session
programmingLanguage: python

dn: inum=2DAF-AA91,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Resource Owner Password Credentials Example
displayName: resource_owner_password_credentials_example
oxEnabled: false
inum: 2DAF-AA91
oxLevel: 1
oxRevision: 1
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxScript:: ZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUub3duZXIgaW1wb3J0IFJlc291cmNlT3duZXJQYXNzd29yZENyZWRlbnRpYWxzVHlwZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlIGltcG9ydCBBdXRoZW50aWNhdGlvblNlcnZpY2UKZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlLmNkaS51dGlsIGltcG9ydCBDZGlVdGlsCmZyb20gamF2YS5sYW5nIGltcG9ydCBTdHJpbmcKCmNsYXNzIFJlc291cmNlT3duZXJQYXNzd29yZENyZWRlbnRpYWxzKFJlc291cmNlT3duZXJQYXNzd29yZENyZWRlbnRpYWxzVHlwZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJST1BDIHNjcmlwdC4gSW5pdGlhbGl6aW5nIC4uLiIKCiAgICAgICAgc2VsZi51c2VybmFtZVBhcmFtTmFtZSA9ICJ1c2VybmFtZSIKICAgICAgICBzZWxmLnBhc3N3b3JkUGFyYW1OYW1lID0gInBhc3N3b3JkIgoKICAgICAgICBwcmludCAiUk9QQyBzY3JpcHQuIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseSIKCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIlJPUEMgc2NyaXB0LiBEZXN0cm95aW5nIC4uLiIKICAgICAgICBwcmludCAiUk9QQyBzY3JpcHQuIERlc3Ryb3llZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToKICAgICAgICByZXR1cm4gMTEKCiAgICAjIFJldHVybnMgVHJ1ZSBhbmQgc2V0IHVzZXIgaW50byBjb250ZXh0IHdoZW4gdXNlciBhdXRoZW50aWNhdGVkIHN1Y2Nlc2Z1bGx5CiAgICAjIFJldHVybnMgRmFsc2Ugd2hlbiB1c2VyIG5vdCBhdXRoZW50aWNhdGVkIG9yIGl0J3MgbmVlZGVkIHRvIGNhbmNlbCBub3RtYWwgZmxvdwogICAgIyBOb3RlIDoKICAgICMgY29udGV4dCBpcyByZWZlcmVuY2Ugb2Ygb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuZXh0ZXJuYWwuY29udGV4dC5FeHRlcm5hbFJlc291cmNlT3duZXJQYXNzd29yZENyZWRlbnRpYWxzQ29udGV4dCNFeHRlcm5hbFJlc291cmNlT3duZXJQYXNzd29yZENyZWRlbnRpYWxzQ29udGV4dCAoaW4gaHR0cHM6Ly9naXRodWIuY29tL0dsdXVGZWRlcmF0aW9uL294YXV0aCBwcm9qZWN0LCApCiAgICBkZWYgYXV0aGVudGljYXRlKHNlbGYsIGNvbnRleHQpOgogICAgICAgIHByaW50ICJST1BDIHNjcmlwdC4gQXV0aGVudGljYXRlIgogICAgICAgIGRldmljZUlkUGFyYW0gPSBjb250ZXh0LmdldEh0dHBSZXF1ZXN0KCkuZ2V0UGFyYW1ldGVyVmFsdWVzKCJkZXZpY2VfaWQiKQogICAgICAgIGlmIGRldmljZUlkUGFyYW0gIT0gTm9uZSBhbmQgKGRldmljZUlkUGFyYW0ubGVuZ2h0ID4gMCApOgogICAgICAgICAgICByZXN1bHQgPSBkZXZpY2VJZFBhcmFtWzBdID09ICJkZXZpY2VfaWRfMSIKICAgICAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgIyBTZXQgYXVudGVudGljYXRlZCB1c2VyIGluIGNvbnRleHQKICAgICAgICAgICAgIyBjb250ZXh0LnNldFVzZXIodXNlcikKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgIyBEbyBnZW5lcmljIGF1dGhlbnRpY2F0aW9uIGluIG90aGVyIGNhc2VzCiAgICAgICAgYXV0aFNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oQXV0aGVudGljYXRpb25TZXJ2aWNlKQoKICAgICAgICB1c2VybmFtZSA9IGNvbnRleHQuZ2V0SHR0cFJlcXVlc3QoKS5nZXRQYXJhbWV0ZXIoc2VsZi51c2VybmFtZVBhcmFtTmFtZSkKICAgICAgICBwYXNzd29yZCA9IGNvbnRleHQuZ2V0SHR0cFJlcXVlc3QoKS5nZXRQYXJhbWV0ZXIoc2VsZi5wYXNzd29yZFBhcmFtTmFtZSkKICAgICAgICByZXN1bHQgPSBhdXRoU2VydmljZS5hdXRoZW50aWNhdGUodXNlcm5hbWUsIHBhc3N3b3JkKQogICAgICAgIGlmIG5vdCByZXN1bHQ6CiAgICAgICAgICAgIHByaW50ICJST1BDIHNjcmlwdC4gQXV0aGVudGljYXRlLiBDb3VsZCBub3QgYXV0aGVudGljYXRlIHVzZXIgJyVzJyAiICUgdXNlcm5hbWUKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIGNvbnRleHQuc2V0VXNlcihhdXRoU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpKQoKICAgICAgICByZXR1cm4gVHJ1ZQo=
oxScriptType: resource_owner_password_credentials
programmingLanguage: python

dn: inum=2DAF-BA91,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Resource Owner Password Credentials Custom Parameters Example
displayName: resource_owner_password_credentials_custom_params_example
oxEnabled: false
inum: 2DAF-BA91
oxLevel: 1
oxRevision: 1
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE5LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vY2hhbgojCiMKCmZyb20gb3JnLmdsdXUubW9kZWwuY3VzdG9tLnNjcmlwdC50eXBlLm93bmVyIGltcG9ydCBSZXNvdXJjZU93bmVyUGFzc3dvcmRDcmVkZW50aWFsc1R5cGUKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZSBpbXBvcnQgQXV0aGVudGljYXRpb25TZXJ2aWNlLCBTZXNzaW9uSWRTZXJ2aWNlCmZyb20gb3JnLmdsdXUub3hhdXRoLm1vZGVsLmNvbW1vbiBpbXBvcnQgU2Vzc2lvbklkU3RhdGUKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VjdXJpdHkgaW1wb3J0IElkZW50aXR5CmZyb20gb3JnLmdsdXUuc2VydmljZS5jZGkudXRpbCBpbXBvcnQgQ2RpVXRpbApmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5hdXRob3JpemUgaW1wb3J0IEF1dGhvcml6ZVJlcXVlc3RQYXJhbQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5jb25maWcgaW1wb3J0IENvbnN0YW50cwpmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlcgpmcm9tIGphdmEubGFuZyBpbXBvcnQgU3RyaW5nCmZyb20gamF2YS51dGlsIGltcG9ydCBEYXRlLCBIYXNoTWFwCgpjbGFzcyBSZXNvdXJjZU93bmVyUGFzc3dvcmRDcmVkZW50aWFscyhSZXNvdXJjZU93bmVyUGFzc3dvcmRDcmVkZW50aWFsc1R5cGUpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGN1cnJlbnRUaW1lTWlsbGlzKToKICAgICAgICBzZWxmLmN1cnJlbnRUaW1lTWlsbGlzID0gY3VycmVudFRpbWVNaWxsaXMKCiAgICBkZWYgaW5pdChzZWxmLCBjdXN0b21TY3JpcHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiUk9QQyBzY3JpcHQuIEluaXRpYWxpemluZyAuLi4iCiAgICAgICAgcHJpbnQgIlJPUEMgc2NyaXB0LiBJbml0aWFsaXplZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIlJPUEMgc2NyaXB0LiBEZXN0cm95aW5nIC4uLiIKICAgICAgICBwcmludCAiUk9QQyBzY3JpcHQuIERlc3Ryb3llZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToKICAgICAgICByZXR1cm4gMTEKCiAgICAjIFJldHVybnMgVHJ1ZSBhbmQgc2V0IHVzZXIgaW50byBjb250ZXh0IHdoZW4gdXNlciBhdXRoZW50aWNhdGVkIHN1Y2Nlc2Z1bGx5CiAgICAjIFJldHVybnMgRmFsc2Ugd2hlbiB1c2VyIG5vdCBhdXRoZW50aWNhdGVkIG9yIGl0J3MgbmVlZGVkIHRvIGNhbmNlbCBub3RtYWwgZmxvdwogICAgIyBOb3RlIDoKICAgICMgY29udGV4dCBpcyByZWZlcmVuY2Ugb2Ygb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuZXh0ZXJuYWwuY29udGV4dC5FeHRlcm5hbFJlc291cmNlT3duZXJQYXNzd29yZENyZWRlbnRpYWxzQ29udGV4dCNFeHRlcm5hbFJlc291cmNlT3duZXJQYXNzd29yZENyZWRlbnRpYWxzQ29udGV4dCAoaW4gaHR0cHM6Ly9naXRodWIuY29tL0dsdXVGZWRlcmF0aW9uL294YXV0aCBwcm9qZWN0LCApCiAgICBkZWYgYXV0aGVudGljYXRlKHNlbGYsIGNvbnRleHQpOgogICAgICAgIHByaW50ICJST1BDIHNjcmlwdC4gQXV0aGVudGljYXRlIgoKICAgICAgICAjIERvIGdlbmVyaWMgYXV0aGVudGljYXRpb24KICAgICAgICBhdXRoZW50aWNhdGlvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oQXV0aGVudGljYXRpb25TZXJ2aWNlKQoKICAgICAgICB1c2VybmFtZSA9IGNvbnRleHQuZ2V0SHR0cFJlcXVlc3QoKS5nZXRQYXJhbWV0ZXIoInVzZXJuYW1lIikKICAgICAgICBwYXNzd29yZCA9IGNvbnRleHQuZ2V0SHR0cFJlcXVlc3QoKS5nZXRQYXJhbWV0ZXIoInBhc3N3b3JkIikKICAgICAgICByZXN1bHQgPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJuYW1lLCBwYXNzd29yZCkKICAgICAgICBpZiBub3QgcmVzdWx0OgogICAgICAgICAgICBwcmludCAiUk9QQyBzY3JpcHQuIEF1dGhlbnRpY2F0ZS4gQ291bGQgbm90IGF1dGhlbnRpY2F0ZSB1c2VyICclcycgIiAlIHVzZXJuYW1lCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBjb250ZXh0LnNldFVzZXIoYXV0aGVudGljYXRpb25TZXJ2aWNlLmdldEF1dGhlbnRpY2F0ZWRVc2VyKCkpCiAgICAgICAgcHJpbnQgIlJPUEMgc2NyaXB0LiBBdXRoZW50aWNhdGUuIFVzZXIgJyVzJyBhdXRoZW50aWNhdGVkIHN1Y2Nlc3NmdWxseSIgJSB1c2VybmFtZQogICAgICAgIAoKICAgICAgICAjIEdldCBjdXNvbSBwYXJhbWV0ZXJzIGZyb20gcmVxdWVzdAogICAgICAgIGN1c3RvbVBhcmFtMVZhbHVlID0gY29udGV4dC5nZXRIdHRwUmVxdWVzdCgpLmdldFBhcmFtZXRlcigiY3VzdG9tMSIpCiAgICAgICAgY3VzdG9tUGFyYW0yVmFsdWUgPSBjb250ZXh0LmdldEh0dHBSZXF1ZXN0KCkuZ2V0UGFyYW1ldGVyKCJjdXN0b20yIikKCiAgICAgICAgY3VzdG9tUGFyYW1ldGVycyA9IHt9CiAgICAgICAgY3VzdG9tUGFyYW1ldGVyc1siY3VzdG9tMSJdID0gY3VzdG9tUGFyYW0xVmFsdWUKICAgICAgICBjdXN0b21QYXJhbWV0ZXJzWyJjdXN0b20yIl0gPSBjdXN0b21QYXJhbTJWYWx1ZQogICAgICAgIHByaW50ICJST1BDIHNjcmlwdC4gQXV0aGVudGljYXRlLiBVc2VyICclcycuIENyZWF0aW5nIGF1dGhlbnRpY2F0ZWQgc2Vzc2lvbiB3aXRoIGN1c3RvbSBhdHRyaWJ1dGVzOiAnJXMnIiAlICh1c2VybmFtZSwgY3VzdG9tUGFyYW1ldGVycykKCiAgICAgICAgc2Vzc2lvbiA9IHNlbGYuY3JlYXRlTmV3QXV0aGVudGljYXRlZFNlc3Npb24oY29udGV4dCwgY3VzdG9tUGFyYW1ldGVycykKICAgICAgICAKICAgICAgICAjIFRoaXMgaXMgbmVlZGVkIHRvIGFsbG93IHN0b3JlIGluIHRva2VuIGVudHJ5IHNlc3Npb25JZAogICAgICAgIGF1dGhlbnRpY2F0aW9uU2VydmljZS5jb25maWd1cmVFdmVudFVzZXIoc2Vzc2lvbikKCiAgICAgICAgcHJpbnQgIlJPUEMgc2NyaXB0LiBBdXRoZW50aWNhdGUuIFVzZXIgJyVzJy4gQ3JlYXRlZCBhdXRoZW50aWNhdGVkIHNlc3Npb246ICclcyciICUgKHVzZXJuYW1lLCBjdXN0b21QYXJhbWV0ZXJzKQoKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBjcmVhdGVOZXdBdXRoZW50aWNhdGVkU2Vzc2lvbihzZWxmLCBjb250ZXh0LCBjdXN0b21QYXJhbWV0ZXJzPXt9KToKICAgICAgICBzZXNzaW9uSWRTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFNlc3Npb25JZFNlcnZpY2UpCgogICAgICAgIHVzZXIgPSBjb250ZXh0LmdldFVzZXIoKQogICAgICAgIGNsaWVudCA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkuZ2V0U2Vzc2lvbkNsaWVudCgpLmdldENsaWVudCgpCgogICAgICAgICMgQWRkIG1hbmRhdG9yeSBzZXNzaW9uIHBhcmFtZXRlcnMKICAgICAgICBzZXNzaW9uQXR0cmlidXRlcyA9IEhhc2hNYXAoKQogICAgICAgIHNlc3Npb25BdHRyaWJ1dGVzLnB1dChDb25zdGFudHMuQVVUSEVOVElDQVRFRF9VU0VSLCB1c2VyLmdldFVzZXJJZCgpKQogICAgICAgIHNlc3Npb25BdHRyaWJ1dGVzLnB1dChBdXRob3JpemVSZXF1ZXN0UGFyYW0uQ0xJRU5UX0lELCBjbGllbnQuZ2V0Q2xpZW50SWQoKSkKICAgICAgICBzZXNzaW9uQXR0cmlidXRlcy5wdXQoQXV0aG9yaXplUmVxdWVzdFBhcmFtLlBST01QVCwgIiIpCgogICAgICAgICMgQWRkIGN1c3RvbSBzZXNzaW9uIHBhcmFtZXRlcnMKICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBjdXN0b21QYXJhbWV0ZXJzLml0ZXJpdGVtcygpOgogICAgICAgICAgICBpZiBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eSh2YWx1ZSk6CiAgICAgICAgICAgICAgICBzZXNzaW9uQXR0cmlidXRlcy5wdXQoa2V5LCB2YWx1ZSkKCiAgICAgICAgIyBHZW5lcmF0ZSBhdXRoZW50aWNhdGVkIHNlc3Npb24KICAgICAgICBzZXNzaW9uSWQgPSBzZXNzaW9uSWRTZXJ2aWNlLmdlbmVyYXRlQXV0aGVudGljYXRlZFNlc3Npb25JZChjb250ZXh0LmdldEh0dHBSZXF1ZXN0KCksIHVzZXIuZ2V0RG4oKSwgc2Vzc2lvbkF0dHJpYnV0ZXMpCgogICAgICAgIHByaW50ICJST1BDIHNjcmlwdC4gR2VuZXJhdGVkIHNlc3Npb24gaWQuIEROOiAnJXMnIiAlIHNlc3Npb25JZC5nZXREbigpCgogICAgICAgIHJldHVybiBzZXNzaW9uSWQK
oxScriptType: resource_owner_password_credentials
programmingLanguage: python

dn: inum=4BBE-C6A8,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Basic (with user locking) authentication module
displayName: basic_lock
oxEnabled: false
inum: 4BBE-C6A8
oxConfigurationProperty: {"value1":"invalid_login_count_attribute","value2":"oxCountInvalidLogin","description":""}
oxConfigurationProperty: {"value1":"maximum_invalid_login_attemps","value2":"3","description":""}
oxConfigurationProperty: {"value1":"lock_expiration_time","value2":"120","description":""}
oxLevel: 20
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIyBBdXRob3I6IEdhc215ciBNb3VnYW5nCiMKCmZyb20gb3JnLmdsdXUuc2VydmljZS5jZGkudXRpbCBpbXBvcnQgQ2RpVXRpbApmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZWN1cml0eSBpbXBvcnQgSWRlbnRpdHkKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuYXV0aCBpbXBvcnQgUGVyc29uQXV0aGVudGljYXRpb25UeXBlCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UgaW1wb3J0IEF1dGhlbnRpY2F0aW9uU2VydmljZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlLmNvbW1vbiBpbXBvcnQgVXNlclNlcnZpY2UKZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlIGltcG9ydCBDYWNoZVNlcnZpY2UKZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIKZnJvbSBvcmcuZ2x1dS5wZXJzaXN0LmV4Y2VwdGlvbiBpbXBvcnQgQXV0aGVudGljYXRpb25FeGNlcHRpb24KZnJvbSBqYXZheC5mYWNlcy5hcHBsaWNhdGlvbiBpbXBvcnQgRmFjZXNNZXNzYWdlCmZyb20gb3JnLmdsdXUuanNmMi5tZXNzYWdlIGltcG9ydCBGYWNlc01lc3NhZ2VzCmZyb20gamF2YS50aW1lIGltcG9ydCBMb2NhbERhdGVUaW1lLCBEdXJhdGlvbgpmcm9tIGphdmEudGltZS5mb3JtYXQgaW1wb3J0IERhdGVUaW1lRm9ybWF0dGVyCgppbXBvcnQgamF2YQppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IGpzb24KCmNsYXNzIFBlcnNvbkF1dGhlbnRpY2F0aW9uKFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiQmFzaWMgKGxvY2sgYWNjb3VudCkuIEluaXRpYWxpemF0aW9uIgoKICAgICAgICBzZWxmLmludmFsaWRMb2dpbkNvdW50QXR0cmlidXRlID0gIm94Q291bnRJbnZhbGlkTG9naW4iCiAgICAgICAgaWYgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImludmFsaWRfbG9naW5fY291bnRfYXR0cmlidXRlIik6CiAgICAgICAgICAgIHNlbGYuaW52YWxpZExvZ2luQ291bnRBdHRyaWJ1dGUgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImludmFsaWRfbG9naW5fY291bnRfYXR0cmlidXRlIikuZ2V0VmFsdWUyKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBwcmludCAiQmFzaWMgKGxvY2sgYWNjb3VudCkuIEluaXRpYWxpemF0aW9uLiBVc2luZyBkZWZhdWx0IGF0dHJpYnV0ZSIKCiAgICAgICAgc2VsZi5tYXhpbXVtSW52YWxpZExvZ2luQXR0ZW1wcyA9IDMKICAgICAgICBpZiBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5jb250YWluc0tleSgibWF4aW11bV9pbnZhbGlkX2xvZ2luX2F0dGVtcHMiKToKICAgICAgICAgICAgc2VsZi5tYXhpbXVtSW52YWxpZExvZ2luQXR0ZW1wcyA9IFN0cmluZ0hlbHBlci50b0ludGVnZXIoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJtYXhpbXVtX2ludmFsaWRfbG9naW5fYXR0ZW1wcyIpLmdldFZhbHVlMigpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50ICJCYXNpYyAobG9jayBhY2NvdW50KS4gSW5pdGlhbGl6YXRpb24uIFVzaW5nIGRlZmF1bHQgbnVtYmVyIGF0dGVtcHRzIgoKICAgICAgICBzZWxmLmxvY2tFeHBpcmF0aW9uVGltZSA9IDE4MAogICAgICAgIGlmIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJsb2NrX2V4cGlyYXRpb25fdGltZSIpOgogICAgICAgICAgICBzZWxmLmxvY2tFeHBpcmF0aW9uVGltZSA9IFN0cmluZ0hlbHBlci50b0ludGVnZXIoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJsb2NrX2V4cGlyYXRpb25fdGltZSIpLmdldFZhbHVlMigpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50ICJCYXNpYyAobG9jayBhY2NvdW50KS4gSW5pdGlhbGl6YXRpb24uIFVzaW5nIGRlZmF1bHQgbG9jayBleHBpcmF0aW9uIHRpbWUiCgoKICAgICAgICBwcmludCAiQmFzaWMgKGxvY2sgYWNjb3VudCkuIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseS4gaW52YWxpZF9sb2dpbl9jb3VudF9hdHRyaWJ1dGU6ICclcycsIG1heGltdW1faW52YWxpZF9sb2dpbl9hdHRlbXBzOiAnJXMnLCBsb2NrX2V4cGlyYXRpb25fdGltZTogJyVzJyIgJSAoc2VsZi5pbnZhbGlkTG9naW5Db3VudEF0dHJpYnV0ZSwgc2VsZi5tYXhpbXVtSW52YWxpZExvZ2luQXR0ZW1wcywgc2VsZi5sb2NrRXhwaXJhdGlvblRpbWUpCgogICAgICAgIHJldHVybiBUcnVlICAgCgogICAgZGVmIGRlc3Ryb3koc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJCYXNpYyAobG9jayBhY2NvdW50KS4gRGVzdHJveSIKICAgICAgICBwcmludCAiQmFzaWMgKGxvY2sgYWNjb3VudCkuIERlc3Ryb3llZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToKICAgICAgICByZXR1cm4gMTEKCiAgICBkZWYgZ2V0QXV0aGVudGljYXRpb25NZXRob2RDbGFpbXMoc2VsZiwgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHJldHVybiBOb25lCiAgICAgICAgCiAgICBkZWYgaXNWYWxpZEF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGdldEFsdGVybmF0aXZlQXV0aGVudGljYXRpb25NZXRob2Qoc2VsZiwgdXNhZ2VUeXBlLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgYXV0aGVudGljYXRlKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CiAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkKCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICBwcmludCAiQmFzaWMgKGxvY2sgYWNjb3VudCkuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxIgogICAgICAgICAgICBmYWNlc01lc3NhZ2VzID0gQ2RpVXRpbC5iZWFuKEZhY2VzTWVzc2FnZXMpCiAgICAgICAgICAgIGZhY2VzTWVzc2FnZXMuc2V0S2VlcE1lc3NhZ2VzKCkKICAgICAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCiAgICAgICAgICAgIGNyZWRlbnRpYWxzID0gaWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHMoKQogICAgICAgICAgICB1c2VyX25hbWUgPSBjcmVkZW50aWFscy5nZXRVc2VybmFtZSgpCiAgICAgICAgICAgIHVzZXJfcGFzc3dvcmQgPSBjcmVkZW50aWFscy5nZXRQYXNzd29yZCgpCiAgICAgICAgICAgIGNhY2hlU2VydmljZSA9IENkaVV0aWwuYmVhbihDYWNoZVNlcnZpY2UpCiAgICAgICAgICAgIHVzZXJTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFVzZXJTZXJ2aWNlKQoKCiAgICAgICAgICAgIGxvZ2dlZF9pbiA9IEZhbHNlCiAgICAgICAgICAgIGlmIChTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eVN0cmluZyh1c2VyX25hbWUpIGFuZCBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eVN0cmluZyh1c2VyX3Bhc3N3b3JkKSk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VkX2luID0gYXV0aGVudGljYXRpb25TZXJ2aWNlLmF1dGhlbnRpY2F0ZSh1c2VyX25hbWUsIHVzZXJfcGFzc3dvcmQpCiAgICAgICAgICAgICAgICBleGNlcHQgQXV0aGVudGljYXRpb25FeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkJhc2ljIChsb2NrIGFjY291bnQpLiBBdXRoZW50aWNhdGUuIEZhaWxlZCB0byBhdXRoZW50aWNhdGUgdXNlciAnJXMnIiAlIHVzZXJfbmFtZQoKICAgICAgICAgICAgaWYgbG9nZ2VkX2luOgogICAgICAgICAgICAgICAgc2VsZi5zZXRVc2VyQXR0cmlidXRlVmFsdWUodXNlcl9uYW1lLCBzZWxmLmludmFsaWRMb2dpbkNvdW50QXR0cmlidXRlLCBTdHJpbmdIZWxwZXIudG9TdHJpbmcoMCkpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjb3VudEludmFsaWRMb2dpbkFycmlidXRlVmFsdWUgPSBzZWxmLmdldFVzZXJBdHRyaWJ1dGVWYWx1ZSh1c2VyX25hbWUsIHNlbGYuaW52YWxpZExvZ2luQ291bnRBdHRyaWJ1dGUpCiAgICAgICAgICAgICAgICB1c2VyU2F0dXMgPSBzZWxmLmdldFVzZXJBdHRyaWJ1dGVWYWx1ZSh1c2VyX25hbWUsICJnbHV1U3RhdHVzIikKICAgICAgICAgICAgICAgIHByaW50ICJDdXJyZW50IHVzZXIgJyVzJyBzdGF0dXMgaXMgJyVzJyIgJSAoIHVzZXJfbmFtZSwgdXNlclNhdHVzICkKCiAgICAgICAgICAgICAgICBjb3VudEludmFsaWRMb2dpbiA9IFN0cmluZ0hlbHBlci50b0ludGVnZXIoY291bnRJbnZhbGlkTG9naW5BcnJpYnV0ZVZhbHVlLCAwKQoKICAgICAgICAgICAgICAgIGlmIGNvdW50SW52YWxpZExvZ2luIDwgc2VsZi5tYXhpbXVtSW52YWxpZExvZ2luQXR0ZW1wczoKICAgICAgICAgICAgICAgICAgICBjb3VudEludmFsaWRMb2dpbiA9IGNvdW50SW52YWxpZExvZ2luICsgMQogICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ0F0dGVtcHRzID0gc2VsZi5tYXhpbXVtSW52YWxpZExvZ2luQXR0ZW1wcyAtIGNvdW50SW52YWxpZExvZ2luCgogICAgICAgICAgICAgICAgICAgIHByaW50ICJSZW1haW5pbmcgbG9naW4gY291bnQgYXR0ZW1wdHMgJyVzJyBmb3IgdXNlciAnJXMnIiAlICggcmVtYWluaW5nQXR0ZW1wdHMsIHVzZXJfbmFtZSApCgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0VXNlckF0dHJpYnV0ZVZhbHVlKHVzZXJfbmFtZSwgc2VsZi5pbnZhbGlkTG9naW5Db3VudEF0dHJpYnV0ZSwgU3RyaW5nSGVscGVyLnRvU3RyaW5nKGNvdW50SW52YWxpZExvZ2luKSkKICAgICAgICAgICAgICAgICAgICBpZiByZW1haW5pbmdBdHRlbXB0cyA+IDAgYW5kIHVzZXJTYXR1cyA9PSAiYWN0aXZlIjoKICAgICAgICAgICAgICAgICAgICAgICAgZmFjZXNNZXNzYWdlcy5hZGQoRmFjZXNNZXNzYWdlLlNFVkVSSVRZX0lORk8sIFN0cmluZ0hlbHBlci50b1N0cmluZyhyZW1haW5pbmdBdHRlbXB0cykrIiBtb3JlIGF0dGVtcHQocykgYmVmb3JlIGFjY291bnQgaXMgTE9DS0VEISIpCgogICAgICAgICAgICAgICAgaWYgKGNvdW50SW52YWxpZExvZ2luID49IHNlbGYubWF4aW11bUludmFsaWRMb2dpbkF0dGVtcHMpIGFuZCAoKHVzZXJTYXR1cyA9PSBOb25lKSBvciAodXNlclNhdHVzID09ICJhY3RpdmUiKSk6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkJhc2ljIChsb2NrIGFjY291bnQpLiBMb2NraW5nICclcycgZm9yICclcycgc2Vjb25kcyIgJSAoIHVzZXJfbmFtZSwgc2VsZi5sb2NrRXhwaXJhdGlvblRpbWUpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2NrVXNlcih1c2VyX25hbWUpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICAgICAgaWYgKGNvdW50SW52YWxpZExvZ2luID49IHNlbGYubWF4aW11bUludmFsaWRMb2dpbkF0dGVtcHMpIGFuZCB1c2VyU2F0dXMgPT0gImluYWN0aXZlIjoKICAgICAgICAgICAgICAgICAgICBwcmludCAiQmFzaWMgKGxvY2sgYWNjb3VudCkuIFVzZXIgJyVzJyBpcyBsb2NrZWQuIENoZWNraW5nIGlmIHdlIGNhbiB1bmxvY2sgaGltIiAlIHVzZXJfbmFtZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHVubG9ja19hbmRfYXV0aGVudGljYXRlID0gRmFsc2UKCiAgICAgICAgICAgICAgICAgICAgb2JqZWN0X2Zyb21fc3RvcmUgPSBjYWNoZVNlcnZpY2UuZ2V0KE5vbmUsICJsb2NrX3VzZXJfIiArIHVzZXJfbmFtZSkKICAgICAgICAgICAgICAgICAgICBpZiBvYmplY3RfZnJvbV9zdG9yZSA9PSBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICAjIE9iamVjdCBpbiBjYWNoZSB3YXMgZXhwaXJlZC4gV2UgbmVlZCB0byB1bmxvY2sgdXNlcgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCAiQmFzaWMgKGxvY2sgYWNjb3VudCkuIFVzZXIgbG9ja2luZyBkZXRhaWxzIGZvciB1c2VyICclcycgbm90IGV4aXN0cyIgJSB1c2VyX25hbWUKICAgICAgICAgICAgICAgICAgICAgICAgdW5sb2NrX2FuZF9hdXRoZW50aWNhdGUgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBBbmFseXplIG9iamVjdCBmcm9tIGNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJfbG9ja19kZXRhaWxzID0ganNvbi5sb2FkcyhvYmplY3RfZnJvbV9zdG9yZSkKCiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJfbG9ja19kZXRhaWxzX2xvY2tlZCA9IHVzZXJfbG9ja19kZXRhaWxzWydsb2NrZWQnXQogICAgICAgICAgICAgICAgICAgICAgICB1c2VyX2xvY2tfZGV0YWlsc19jcmVhdGVkID0gdXNlcl9sb2NrX2RldGFpbHNbJ2NyZWF0ZWQnXQogICAgICAgICAgICAgICAgICAgICAgICB1c2VyX2xvY2tfZGV0YWlsc19jcmVhdGVkX2RhdGUgPSBMb2NhbERhdGVUaW1lLnBhcnNlKHVzZXJfbG9ja19kZXRhaWxzX2NyZWF0ZWQsIERhdGVUaW1lRm9ybWF0dGVyLklTT19MT0NBTF9EQVRFX1RJTUUpCiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJfbG9ja19kZXRhaWxzX2NyZWF0ZWRfZGlmZiA9IER1cmF0aW9uLmJldHdlZW4odXNlcl9sb2NrX2RldGFpbHNfY3JlYXRlZF9kYXRlLCBMb2NhbERhdGVUaW1lLm5vdygpKS5nZXRTZWNvbmRzKCkKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkJhc2ljIChsb2NrIGFjY291bnQpLiBHZXQgdXNlciAnJXMnIGxvY2tpbmcgZGV0YWlscy4gbG9ja2VkOiAnJXMnLCBDcmVhdGVkOiAnJXMnLCBEaWZmZXJlbmNlIGluIHNlY29uZHM6ICclcyciICUgKCB1c2VyX25hbWUsIHVzZXJfbG9ja19kZXRhaWxzX2xvY2tlZCwgdXNlcl9sb2NrX2RldGFpbHNfY3JlYXRlZCwgdXNlcl9sb2NrX2RldGFpbHNfY3JlYXRlZF9kaWZmICkKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVzZXJfbG9ja19kZXRhaWxzX2xvY2tlZCBhbmQgdXNlcl9sb2NrX2RldGFpbHNfY3JlYXRlZF9kaWZmID49IHNlbGYubG9ja0V4cGlyYXRpb25UaW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkJhc2ljIChsb2NrIGFjY291bnQpLiBVbmxvY2tpbmcgdXNlciAnJXMnIGFmdGVyIGxvY2sgZXhwaXJhdGlvbiIgJSB1c2VyX25hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVubG9ja19hbmRfYXV0aGVudGljYXRlID0gVHJ1ZQoKICAgICAgICAgICAgICAgICAgICBpZiB1bmxvY2tfYW5kX2F1dGhlbnRpY2F0ZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi51bkxvY2tVc2VyKHVzZXJfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXRVc2VyQXR0cmlidXRlVmFsdWUodXNlcl9uYW1lLCBzZWxmLmludmFsaWRMb2dpbkNvdW50QXR0cmlidXRlLCBTdHJpbmdIZWxwZXIudG9TdHJpbmcoMCkpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlZF9pbiA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5hdXRoZW50aWNhdGUodXNlcl9uYW1lLCB1c2VyX3Bhc3N3b3JkKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgbG9nZ2VkX2luOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBVcGRhdGUgbnVtYmVyIG9mIGF0dGVtcHRzIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXRVc2VyQXR0cmlidXRlVmFsdWUodXNlcl9uYW1lLCBzZWxmLmludmFsaWRMb2dpbkNvdW50QXR0cmlidXRlLCBTdHJpbmdIZWxwZXIudG9TdHJpbmcoMSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLm1heGltdW1JbnZhbGlkTG9naW5BdHRlbXBzID09IDE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBMb2NrIHVzZXIgaWYgbWF4aW11bSBjb3VudCBsb2dpbiBhdHRlbXB0cyBpcyAxIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9ja1VzZXIodXNlcl9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKCiAgICAgICAgICAgIHJldHVybiBsb2dnZWRfaW4KICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgcHJlcGFyZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKICAgICAgICBpZiBzdGVwID09IDE6CiAgICAgICAgICAgIHByaW50ICJCYXNpYyAobG9jayBhY2NvdW50KS4gUHJlcGFyZSBmb3IgU3RlcCAxIgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBnZXRFeHRyYVBhcmFtZXRlcnNGb3JTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCBzdGVwKToKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBnZXRDb3VudEF1dGhlbnRpY2F0aW9uU3RlcHMoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiAxCgogICAgZGVmIGdldFBhZ2VGb3JTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCBzdGVwKToKICAgICAgICByZXR1cm4gIiIKICAgICAgICAKICAgIGRlZiBnZXROZXh0U3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIHJldHVybiAtMQoKICAgIGRlZiBnZXRMb2dvdXRFeHRlcm5hbFVybChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHByaW50ICJHZXQgZXh0ZXJuYWwgbG9nb3V0IFVSTCBjYWxsIgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGxvZ291dChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGdldFVzZXJBdHRyaWJ1dGVWYWx1ZShzZWxmLCB1c2VyX25hbWUsIGF0dHJpYnV0ZV9uYW1lKToKICAgICAgICBpZiBTdHJpbmdIZWxwZXIuaXNFbXB0eSh1c2VyX25hbWUpOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkKCiAgICAgICAgZmluZF91c2VyX2J5X3VpZCA9IHVzZXJTZXJ2aWNlLmdldFVzZXIodXNlcl9uYW1lLCBhdHRyaWJ1dGVfbmFtZSkKICAgICAgICBpZiBmaW5kX3VzZXJfYnlfdWlkID09IE5vbmU6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIGN1c3RvbV9hdHRyaWJ1dGVfdmFsdWUgPSB1c2VyU2VydmljZS5nZXRDdXN0b21BdHRyaWJ1dGUoZmluZF91c2VyX2J5X3VpZCwgYXR0cmlidXRlX25hbWUpCiAgICAgICAgaWYgY3VzdG9tX2F0dHJpYnV0ZV92YWx1ZSA9PSBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgICAgIGF0dHJpYnV0ZV92YWx1ZSA9IGN1c3RvbV9hdHRyaWJ1dGVfdmFsdWUuZ2V0VmFsdWUoKQoKICAgICAgICBwcmludCAiQmFzaWMgKGxvY2sgYWNjb3VudCkuIEdldCB1c2VyIGF0dHJpYnV0ZS4gVXNlcidzICclcycgYXR0cmlidXRlICclcycgdmFsdWUgaXMgJyVzJyIgJSAodXNlcl9uYW1lLCBhdHRyaWJ1dGVfbmFtZSwgYXR0cmlidXRlX3ZhbHVlKQoKICAgICAgICByZXR1cm4gYXR0cmlidXRlX3ZhbHVlCgogICAgZGVmIHNldFVzZXJBdHRyaWJ1dGVWYWx1ZShzZWxmLCB1c2VyX25hbWUsIGF0dHJpYnV0ZV9uYW1lLCBhdHRyaWJ1dGVfdmFsdWUpOgogICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KHVzZXJfbmFtZSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHVzZXJTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFVzZXJTZXJ2aWNlKQoKICAgICAgICBmaW5kX3VzZXJfYnlfdWlkID0gdXNlclNlcnZpY2UuZ2V0VXNlcih1c2VyX25hbWUpCiAgICAgICAgaWYgZmluZF91c2VyX2J5X3VpZCA9PSBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgICAgIHVzZXJTZXJ2aWNlLnNldEN1c3RvbUF0dHJpYnV0ZShmaW5kX3VzZXJfYnlfdWlkLCBhdHRyaWJ1dGVfbmFtZSwgYXR0cmlidXRlX3ZhbHVlKQogICAgICAgIHVwZGF0ZWRfdXNlciA9IHVzZXJTZXJ2aWNlLnVwZGF0ZVVzZXIoZmluZF91c2VyX2J5X3VpZCkKCiAgICAgICAgcHJpbnQgIkJhc2ljIChsb2NrIGFjY291bnQpLiBTZXQgdXNlciBhdHRyaWJ1dGUuIFVzZXIncyAnJXMnIGF0dHJpYnV0ZSAnJXMnIHZhbHVlIGlzICclcyciICUgKHVzZXJfbmFtZSwgYXR0cmlidXRlX25hbWUsIGF0dHJpYnV0ZV92YWx1ZSkKCiAgICAgICAgcmV0dXJuIHVwZGF0ZWRfdXNlcgoKICAgIGRlZiBsb2NrVXNlcihzZWxmLCB1c2VyX25hbWUpOgogICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KHVzZXJfbmFtZSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHVzZXJTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFVzZXJTZXJ2aWNlKQogICAgICAgIGNhY2hlU2VydmljZT0gQ2RpVXRpbC5iZWFuKENhY2hlU2VydmljZSkKICAgICAgICBmYWNlc01lc3NhZ2VzID0gQ2RpVXRpbC5iZWFuKEZhY2VzTWVzc2FnZXMpCiAgICAgICAgZmFjZXNNZXNzYWdlcy5zZXRLZWVwTWVzc2FnZXMoKQoKICAgICAgICBmaW5kX3VzZXJfYnlfdWlkID0gdXNlclNlcnZpY2UuZ2V0VXNlcih1c2VyX25hbWUpCiAgICAgICAgaWYgKGZpbmRfdXNlcl9ieV91aWQgPT0gTm9uZSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHN0YXR1c19hdHRyaWJ1dGVfdmFsdWUgPSB1c2VyU2VydmljZS5nZXRDdXN0b21BdHRyaWJ1dGUoZmluZF91c2VyX2J5X3VpZCwgImdsdXVTdGF0dXMiKQogICAgICAgIGlmIHN0YXR1c19hdHRyaWJ1dGVfdmFsdWUgIT0gTm9uZToKICAgICAgICAgICAgdXNlcl9zdGF0dXMgPSBzdGF0dXNfYXR0cmlidXRlX3ZhbHVlLmdldFZhbHVlKCkKICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmVxdWFscyh1c2VyX3N0YXR1cywgImluYWN0aXZlIik6CiAgICAgICAgICAgICAgICBwcmludCAiQmFzaWMgKGxvY2sgYWNjb3VudCkuIExvY2sgdXNlci4gVXNlciAnJXMnIGxvY2tlZCBhbHJlYWR5IiAlIHVzZXJfbmFtZQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgdXNlclNlcnZpY2Uuc2V0Q3VzdG9tQXR0cmlidXRlKGZpbmRfdXNlcl9ieV91aWQsICJnbHV1U3RhdHVzIiwgImluYWN0aXZlIikKICAgICAgICB1cGRhdGVkX3VzZXIgPSB1c2VyU2VydmljZS51cGRhdGVVc2VyKGZpbmRfdXNlcl9ieV91aWQpCgogICAgICAgIG9iamVjdF90b19zdG9yZSA9IGpzb24uZHVtcHMoeydsb2NrZWQnOiBUcnVlLCAnY3JlYXRlZCc6IExvY2FsRGF0ZVRpbWUubm93KCkudG9TdHJpbmcoKX0sIHNlcGFyYXRvcnM9KCcsJywnOicpKQoKICAgICAgICBjYWNoZVNlcnZpY2UucHV0KFN0cmluZ0hlbHBlci50b1N0cmluZyhzZWxmLmxvY2tFeHBpcmF0aW9uVGltZSksICJsb2NrX3VzZXJfIit1c2VyX25hbWUsIG9iamVjdF90b19zdG9yZSk7CiAgICAgICAgZmFjZXNNZXNzYWdlcy5hZGQoRmFjZXNNZXNzYWdlLlNFVkVSSVRZX0VSUk9SLCAiWW91ciBhY2NvdW50IGlzIGxvY2tlZC4gUGxlYXNlIHRyeSBhZ2FpbiBhZnRlciAiICsgU3RyaW5nSGVscGVyLnRvU3RyaW5nKHNlbGYubG9ja0V4cGlyYXRpb25UaW1lKSArICIgc2VjcyIpCgogICAgICAgIHByaW50ICJCYXNpYyAobG9jayBhY2NvdW50KS4gTG9jayB1c2VyLiBVc2VyICclcycgbG9ja2VkIiAlIHVzZXJfbmFtZQoKICAgIGRlZiB1bkxvY2tVc2VyKHNlbGYsIHVzZXJfbmFtZSk6CiAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzRW1wdHkodXNlcl9uYW1lKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgdXNlclNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oVXNlclNlcnZpY2UpCiAgICAgICAgY2FjaGVTZXJ2aWNlPSBDZGlVdGlsLmJlYW4oQ2FjaGVTZXJ2aWNlKQoKICAgICAgICBmaW5kX3VzZXJfYnlfdWlkID0gdXNlclNlcnZpY2UuZ2V0VXNlcih1c2VyX25hbWUpCiAgICAgICAgaWYgKGZpbmRfdXNlcl9ieV91aWQgPT0gTm9uZSk6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIG9iamVjdF90b19zdG9yZSA9IGpzb24uZHVtcHMoeydsb2NrZWQnOiBGYWxzZSwgJ2NyZWF0ZWQnOiBMb2NhbERhdGVUaW1lLm5vdygpLnRvU3RyaW5nKCl9LCBzZXBhcmF0b3JzPSgnLCcsJzonKSkKICAgICAgICBjYWNoZVNlcnZpY2UucHV0KFN0cmluZ0hlbHBlci50b1N0cmluZyhzZWxmLmxvY2tFeHBpcmF0aW9uVGltZSksICJsb2NrX3VzZXJfIit1c2VyX25hbWUsIG9iamVjdF90b19zdG9yZSk7CgogICAgICAgIHVzZXJTZXJ2aWNlLnNldEN1c3RvbUF0dHJpYnV0ZShmaW5kX3VzZXJfYnlfdWlkLCAiZ2x1dVN0YXR1cyIsICJhY3RpdmUiKQogICAgICAgIHVzZXJTZXJ2aWNlLnNldEN1c3RvbUF0dHJpYnV0ZShmaW5kX3VzZXJfYnlfdWlkLCBzZWxmLmludmFsaWRMb2dpbkNvdW50QXR0cmlidXRlLCBOb25lKQogICAgICAgIHVwZGF0ZWRfdXNlciA9IHVzZXJTZXJ2aWNlLnVwZGF0ZVVzZXIoZmluZF91c2VyX2J5X3VpZCkKCgogICAgICAgIHByaW50ICJCYXNpYyAobG9jayBhY2NvdW50KS4gTG9jayB1c2VyLiBVc2VyICclcycgdW5sb2NrZWQiICUgdXNlcl9uYW1lCg==
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=5018-AF9C,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: UAF authentication module
displayName: uaf
oxEnabled: false
inum: 5018-AF9C
oxConfigurationProperty: {"value1":"uaf_server_uri","value2":"https://instance-1.us-central1-a.c.nifty-canyon-287111.internal","description":""}
oxConfigurationProperty: {"value1":"uaf_policy_name","value2":"default","description":""}
oxConfigurationProperty: {"value1":"qr_options","value2":"{ width: 400, height: 400 }","description":""}
oxConfigurationProperty: {"value1":"registration_uri","value2":"https://instance-1.us-central1-a.c.nifty-canyon-287111.internal/identity/register","description":""}
oxConfigurationProperty: {"value1":"send_push_notifaction","value2":"false","description":""}
oxLevel: 70
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKIyBSZXF1aXJlcyB0aGUgZm9sbG93aW5nIGN1c3RvbSBwcm9wZXJ0aWVzIGFuZCB2YWx1ZXM6CiMgICB1YWZfc2VydmVyX3VyaTogPGlkcF9ob3N0bmFtZT4KIwojIFRoZXNlIGFyZSBub24gbWFuZGF0b3J5IGN1c3RvbSBwcm9wZXJ0aWVzIGFuZCB2YWx1ZXM6CiMgICB1YWZfcG9saWN5X25hbWU6IGRlZmF1bHQKIyAgIHNlbmRfcHVzaF9ub3RpZmFjdGlvbjogZmFsc2UKIyAgIHJlZ2lzdHJhdGlvbl91cmk6IGh0dHBzOi8vPGlkcF9ob3N0bmFtZT4vaWRlbnRpdHkvcmVnaXN0ZXIKIyAgIHFyX29wdGlvbnM6IHsgd2lkdGg6IDQwMCwgaGVpZ2h0OiA0MDAgfQoKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuYXV0aCBpbXBvcnQgUGVyc29uQXV0aGVudGljYXRpb25UeXBlCmZyb20gb3JnLmdsdXUuc2VydmljZS5jZGkudXRpbCBpbXBvcnQgQ2RpVXRpbApmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZWN1cml0eSBpbXBvcnQgSWRlbnRpdHkKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZSBpbXBvcnQgQXV0aGVudGljYXRpb25TZXJ2aWNlLCBTZXNzaW9uSWRTZXJ2aWNlCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuY29tbW9uIGltcG9ydCBVc2VyU2VydmljZQpmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlciwgQXJyYXlIZWxwZXIKZnJvbSBvcmcuZ2x1dS5veGF1dGgudXRpbCBpbXBvcnQgU2VydmVyVXRpbApmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5jb25maWcgaW1wb3J0IENvbnN0YW50cwpmcm9tIGphdmF4LndzLnJzLmNvcmUgaW1wb3J0IFJlc3BvbnNlCmZyb20gamF2YS51dGlsIGltcG9ydCBBcnJheXMKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5uZXQgaW1wb3J0IEh0dHBTZXJ2aWNlCmZyb20gb3JnLmFwYWNoZS5odHRwLnBhcmFtcyBpbXBvcnQgQ29yZUNvbm5lY3Rpb25QTmFtZXMKCmltcG9ydCBzeXMKaW1wb3J0IGphdmEKaW1wb3J0IGpzb24KCmNsYXNzIFBlcnNvbkF1dGhlbnRpY2F0aW9uKFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJVQUYuIEluaXRpYWxpemF0aW9uIgoKICAgICAgICBpZiBub3QgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoInVhZl9zZXJ2ZXJfdXJpIik6CiAgICAgICAgICAgIHByaW50ICJVQUYuIEluaXRpYWxpemF0aW9uLiBQcm9wZXJ0eSB1YWZfc2VydmVyX3VyaSBpcyBtYW5kYXRvcnkiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBzZWxmLnVhZl9zZXJ2ZXJfdXJpID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJ1YWZfc2VydmVyX3VyaSIpLmdldFZhbHVlMigpCgogICAgICAgIHNlbGYudWFmX3BvbGljeV9uYW1lID0gImRlZmF1bHQiCiAgICAgICAgaWYgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoInVhZl9wb2xpY3lfbmFtZSIpOgogICAgICAgICAgICBzZWxmLnVhZl9wb2xpY3lfbmFtZSA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgidWFmX3BvbGljeV9uYW1lIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgc2VsZi5zZW5kX3B1c2hfbm90aWZhY3Rpb24gPSBGYWxzZQogICAgICAgIGlmIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJzZW5kX3B1c2hfbm90aWZhY3Rpb24iKToKICAgICAgICAgICAgc2VsZi5zZW5kX3B1c2hfbm90aWZhY3Rpb24gPSBTdHJpbmdIZWxwZXIudG9Cb29sZWFuKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgic2VuZF9wdXNoX25vdGlmYWN0aW9uIikuZ2V0VmFsdWUyKCksIEZhbHNlKQoKICAgICAgICBzZWxmLnJlZ2lzdHJhdGlvbl91cmkgPSBOb25lCiAgICAgICAgaWYgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoInJlZ2lzdHJhdGlvbl91cmkiKToKICAgICAgICAgICAgc2VsZi5yZWdpc3RyYXRpb25fdXJpID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJyZWdpc3RyYXRpb25fdXJpIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgc2VsZi5jdXN0b21Rck9wdGlvbnMgPSB7fQogICAgICAgIGlmIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJxcl9vcHRpb25zIik6CiAgICAgICAgICAgIHNlbGYuY3VzdG9tUXJPcHRpb25zID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJxcl9vcHRpb25zIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgcHJpbnQgIlVBRi4gSW5pdGlhbGl6aW5nIEhUVFAgY2xpZW50IgogICAgICAgIGh0dHBTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEh0dHBTZXJ2aWNlKQogICAgICAgIHNlbGYuaHR0cF9jbGllbnQgPSBodHRwU2VydmljZS5nZXRIdHRwc0NsaWVudCgpCiAgICAgICAgaHR0cF9jbGllbnRfcGFyYW1zID0gc2VsZi5odHRwX2NsaWVudC5nZXRQYXJhbXMoKQogICAgICAgIGh0dHBfY2xpZW50X3BhcmFtcy5zZXRJbnRQYXJhbWV0ZXIoQ29yZUNvbm5lY3Rpb25QTmFtZXMuQ09OTkVDVElPTl9USU1FT1VULCAxNSAqIDEwMDApCgogICAgICAgIHByaW50ICJVQUYuIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseS4gdWFmX3NlcnZlcl91cmk6ICclcycsIHVhZl9wb2xpY3lfbmFtZTogJyVzJywgc2VuZF9wdXNoX25vdGlmYWN0aW9uOiAnJXMnLCByZWdpc3RyYXRpb25fdXJpOiAnJXMnLCBxcl9vcHRpb25zOiAnJXMnIiAlIChzZWxmLnVhZl9zZXJ2ZXJfdXJpLCBzZWxmLnVhZl9wb2xpY3lfbmFtZSwgc2VsZi5zZW5kX3B1c2hfbm90aWZhY3Rpb24sIHNlbGYucmVnaXN0cmF0aW9uX3VyaSwgc2VsZi5jdXN0b21Rck9wdGlvbnMpCiAgICAgICAgCiAgICAgICAgcHJpbnQgIlVBRi4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGRlc3Ryb3koc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJVQUYuIERlc3Ryb3kiCiAgICAgICAgcHJpbnQgIlVBRi4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQogICAgICAgIAogICAgZGVmIGdldEF1dGhlbnRpY2F0aW9uTWV0aG9kQ2xhaW1zKHNlbGYsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgZGVmIGlzVmFsaWRBdXRoZW50aWNhdGlvbk1ldGhvZChzZWxmLCB1c2FnZVR5cGUsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBbHRlcm5hdGl2ZUF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGF1dGhlbnRpY2F0ZShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQogICAgICAgIGNyZWRlbnRpYWxzID0gaWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHMoKQoKICAgICAgICBzZXNzaW9uX2F0dHJpYnV0ZXMgPSBpZGVudGl0eS5nZXRTZXNzaW9uSWQoKS5nZXRTZXNzaW9uQXR0cmlidXRlcygpCgogICAgICAgIHNlbGYuc2V0UmVxdWVzdFNjb3BlZFBhcmFtZXRlcnMoaWRlbnRpdHkpCgogICAgICAgIGlmIChzdGVwID09IDEpOgogICAgICAgICAgICBwcmludCAiVUFGLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMSIKCiAgICAgICAgICAgIHVzZXJfbmFtZSA9IGNyZWRlbnRpYWxzLmdldFVzZXJuYW1lKCkKCiAgICAgICAgICAgIGF1dGhlbnRpY2F0ZWRfdXNlciA9IHNlbGYucHJvY2Vzc0Jhc2ljQXV0aGVudGljYXRpb24oY3JlZGVudGlhbHMpCiAgICAgICAgICAgIGlmIGF1dGhlbnRpY2F0ZWRfdXNlciA9PSBOb25lOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICB1YWZfYXV0aF9tZXRob2QgPSAiYXV0aGVudGljYXRlIgogICAgICAgICAgICAjIFVuY29tbWVudCB0aGlzIGJsb2NrIGlmIHlvdSBuZWVkIHRvIGFsbG93IHVzZXIgc2Vjb25kIGRldmljZSByZWdpc3RyYXRpb24KICAgICAgICAgICAgI2Vucm9sbG1lbnRfbW9kZSA9IFNlcnZlclV0aWwuZ2V0Rmlyc3RWYWx1ZShyZXF1ZXN0UGFyYW1ldGVycywgImxvZ2luRm9ybTpyZWdpc3RlckJ1dHRvbiIpCiAgICAgICAgICAgICNpZiBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eShlbnJvbGxtZW50X21vZGUpOgogICAgICAgICAgICAjICAgIHVhZl9hdXRoX21ldGhvZCA9ICJlbnJvbGwiCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiB1YWZfYXV0aF9tZXRob2QgPT0gImF1dGhlbnRpY2F0ZSI6CiAgICAgICAgICAgICAgICB1c2VyX2Vucm9sbG1lbnRzID0gc2VsZi5maW5kRW5yb2xsbWVudHMoY3JlZGVudGlhbHMpCiAgICAgICAgICAgICAgICBpZiBsZW4odXNlcl9lbnJvbGxtZW50cykgPT0gMDoKICAgICAgICAgICAgICAgICAgICB1YWZfYXV0aF9tZXRob2QgPSAiZW5yb2xsIgogICAgICAgICAgICAgICAgICAgIHByaW50ICJVQUYuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiBUaGVyZSBpcyBubyBVQUYgZW5yb2xsbWVudCBmb3IgdXNlciAnJXMnLiBDaGFuZ2luZyB1YWZfYXV0aF9tZXRob2QgdG8gJyVzJyIgJSAodXNlcl9uYW1lLCB1YWZfYXV0aF9tZXRob2QpCgogICAgICAgICAgICBwcmludCAiVUFGLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMS4gdWFmX2F1dGhfbWV0aG9kOiAnJXMnIiAlIHVhZl9hdXRoX21ldGhvZAogICAgICAgICAgICAKICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigidWFmX2F1dGhfbWV0aG9kIiwgdWFmX2F1dGhfbWV0aG9kKQoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbGlmIChzdGVwID09IDIpOgogICAgICAgICAgICBwcmludCAiVUFGLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMiIKCiAgICAgICAgICAgIHNlc3Npb24gPSBDZGlVdGlsLmJlYW4oU2Vzc2lvbklkU2VydmljZSkuZ2V0U2Vzc2lvbklkKCkKICAgICAgICAgICAgaWYgc2Vzc2lvbiA9PSBOb25lOgogICAgICAgICAgICAgICAgcHJpbnQgIlVBRi4gUHJlcGFyZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gZGV0ZXJtaW5lIHNlc3Npb25faWQiCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIHVzZXIgPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuZ2V0QXV0aGVudGljYXRlZFVzZXIoKQogICAgICAgICAgICBpZiAodXNlciA9PSBOb25lKToKICAgICAgICAgICAgICAgIHByaW50ICJVQUYuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gZGV0ZXJtaW5lIHVzZXIgbmFtZSIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICB1c2VyX25hbWUgPSB1c2VyLmdldFVzZXJJZCgpCgogICAgICAgICAgICB1YWZfYXV0aF9yZXN1bHQgPSBTZXJ2ZXJVdGlsLmdldEZpcnN0VmFsdWUocmVxdWVzdFBhcmFtZXRlcnMsICJhdXRoX3Jlc3VsdCIpCiAgICAgICAgICAgIGlmIHVhZl9hdXRoX3Jlc3VsdCAhPSAic3VjY2VzcyI6CiAgICAgICAgICAgICAgICBwcmludCAiVUFGLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gYXV0aF9yZXN1bHQgaXMgJyVzJyIgJSB1YWZfYXV0aF9yZXN1bHQKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgIyBSZXN0b3JlIHN0YXRlIGZyb20gc2Vzc2lvbgogICAgICAgICAgICB1YWZfYXV0aF9tZXRob2QgPSBzZXNzaW9uX2F0dHJpYnV0ZXMuZ2V0KCJ1YWZfYXV0aF9tZXRob2QiKQoKICAgICAgICAgICAgaWYgbm90IHVhZl9hdXRoX21ldGhvZCBpbiBbJ2Vucm9sbCcsICdhdXRoZW50aWNhdGUnXToKICAgICAgICAgICAgICAgIHByaW50ICJVQUYuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gYXV0aGVudGljYXRlIHVzZXIuIHVhZl9hdXRoX21ldGhvZDogJyVzJyIgJSB1YWZfYXV0aF9tZXRob2QKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgIyBSZXF1ZXN0IFNUQVRVU19PQkIKICAgICAgICAgICAgaWYgVHJ1ZToKICAgICAgICAgICAgICAgICNUT0RPOiBSZW1vdmUgdGhpcyBjb25kaXRpb24KICAgICAgICAgICAgICAgICMgSXQncyB3b3JrYXJvdW5kIGJlY3Vhc2UgaXQncyBub3QgcG9zc2libGUgdG8gY2FsbCBTVEFUVVNfT0JCIDIgdGltZXMuIEZpcnN0IHRpbWUgb24gYnJvd3NlciBhbmQgc2Vjb25kIGltZSBvbiBzZXJ2ZXIKICAgICAgICAgICAgICAgIHVhZl91c2VyX2RldmljZV9oYW5kbGUgPSBTZXJ2ZXJVdGlsLmdldEZpcnN0VmFsdWUocmVxdWVzdFBhcmFtZXRlcnMsICJhdXRoX2hhbmRsZSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB1YWZfb2JiX2F1dGhfbWV0aG9kID0gc2Vzc2lvbl9hdHRyaWJ1dGVzLmdldCgidWFmX29iYl9hdXRoX21ldGhvZCIpCiAgICAgICAgICAgICAgICB1YWZfb2JiX3NlcnZlcl91cmkgPSBzZXNzaW9uX2F0dHJpYnV0ZXMuZ2V0KCJ1YWZfb2JiX3NlcnZlcl91cmkiKQogICAgICAgICAgICAgICAgdWFmX29iYl9zdGFydF9yZXNwb25zZSA9IHNlc3Npb25fYXR0cmlidXRlcy5nZXQoInVhZl9vYmJfc3RhcnRfcmVzcG9uc2UiKQoKICAgICAgICAgICAgICAgICMgUHJlcGFyZSBTVEFUVVNfT0JCCiAgICAgICAgICAgICAgICB1YWZfb2JiX3N0YXJ0X3Jlc3BvbnNlX2pzb24gPSBqc29uLmxvYWRzKHVhZl9vYmJfc3RhcnRfcmVzcG9uc2UpCiAgICAgICAgICAgICAgICB1YWZfb2JiX3N0YXR1c19yZXF1ZXN0X2RpY3Rpb25hcnkgPSB7ICJvcGVyYXRpb24iOiAiU1RBVFVTXyVzIiAlIHVhZl9vYmJfYXV0aF9tZXRob2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ1c2VyTmFtZSI6IHVzZXJfbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5lZWREZXRhaWxzIjogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm9vYlN0YXR1c0hhbmRsZSI6IHVhZl9vYmJfc3RhcnRfcmVzcG9uc2VfanNvblsib29iU3RhdHVzSGFuZGxlIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgICAgIHVhZl9vYmJfc3RhdHVzX3JlcXVlc3QgPSBqc29uLmR1bXBzKHVhZl9vYmJfc3RhdHVzX3JlcXVlc3RfZGljdGlvbmFyeSwgc2VwYXJhdG9ycz0oJywnLCc6JykpCiAgICAgICAgICAgICAgICBwcmludCAiVUFGLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gUHJlcGFyZWQgU1RBVFVTIHJlcXVlc3Q6ICclcycgdG8gc2VuZCB0byAnJXMnIiAlICh1YWZfb2JiX3N0YXR1c19yZXF1ZXN0LCB1YWZfb2JiX3NlcnZlcl91cmkpCgogICAgICAgICAgICAgICAgdWFmX3N0YXR1c19vYmJfcmVzcG9uc2UgPSBzZWxmLmV4ZWN1dGVQb3N0KHVhZl9vYmJfc2VydmVyX3VyaSwgdWFmX29iYl9zdGF0dXNfcmVxdWVzdCkKICAgICAgICAgICAgICAgIGlmIHVhZl9zdGF0dXNfb2JiX3Jlc3BvbnNlID09IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICAgICAgcHJpbnQgIlVBRi4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIuIEdldCBTVEFUVVMgcmVzcG9uc2U6ICclcyciICUgdWFmX3N0YXR1c19vYmJfcmVzcG9uc2UKICAgICAgICAgICAgICAgIHVhZl9zdGF0dXNfb2JiX3Jlc3BvbnNlX2pzb24gPSBqc29uLmxvYWRzKHVhZl9zdGF0dXNfb2JiX3Jlc3BvbnNlKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiB1YWZfc3RhdHVzX29iYl9yZXNwb25zZV9qc29uWyJzdGF0dXNDb2RlIl0gIT0gNDAwMDoKICAgICAgICAgICAgICAgICAgICBwcmludCAiVUFGLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gVUFGIG9wZXJhdGlvbiBzdGF0dXMgaXMgaW52YWxpZC4gc3RhdHVzQ29kZTogJyVzJyIgJSB1YWZfc3RhdHVzX29iYl9yZXNwb25zZV9qc29uWyJzdGF0dXNDb2RlIl0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICAgICB1YWZfdXNlcl9kZXZpY2VfaGFuZGxlID0gdWFmX3N0YXR1c19vYmJfcmVzcG9uc2VfanNvblsiYWRkaXRpb25hbEluZm8iXVsiYXV0aGVudGljYXRvcnNSZXN1bHQiXVsiaGFuZGxlIl0KCiAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KHVhZl91c2VyX2RldmljZV9oYW5kbGUpOgogICAgICAgICAgICAgICAgcHJpbnQgIlVBRi4gUHJlcGFyZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gZ2V0IFVBRiBoYW5kbGUiCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIHVhZl91c2VyX2V4dGVybmFsX3VpZCA9ICJ1YWY6JXMiICUgdWFmX3VzZXJfZGV2aWNlX2hhbmRsZQogICAgICAgICAgICBwcmludCAiVUFGLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gVUFGIGhhbmRsZTogJyVzJyIgJSB1YWZfdXNlcl9leHRlcm5hbF91aWQKCiAgICAgICAgICAgIGlmIHVhZl9hdXRoX21ldGhvZCA9PSAiYXV0aGVudGljYXRlIjoKICAgICAgICAgICAgICAgICMgVmFsaWRhdGUgaWYgdXNlciB1c2VkIGRldmljZSB3aXRoIHNhbWUga2VZSGFuZGxlCiAgICAgICAgICAgICAgICB1c2VyX2Vucm9sbG1lbnRzID0gc2VsZi5maW5kRW5yb2xsbWVudHMoY3JlZGVudGlhbHMpCiAgICAgICAgICAgICAgICBpZiBsZW4odXNlcl9lbnJvbGxtZW50cykgPT0gMDoKICAgICAgICAgICAgICAgICAgICB1YWZfYXV0aF9tZXRob2QgPSAiZW5yb2xsIgogICAgICAgICAgICAgICAgICAgIHByaW50ICJVQUYuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBUaGVyZSBpcyBubyBVQUYgZW5yb2xsbWVudCBmb3IgdXNlciAnJXMnLiIgJSB1c2VyX25hbWUKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIHVzZXJfZW5yb2xsbWVudCBpbiB1c2VyX2Vucm9sbG1lbnRzOgogICAgICAgICAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5lcXVhbHNJZ25vcmVDYXNlKHVzZXJfZW5yb2xsbWVudCwgdWFmX3VzZXJfZGV2aWNlX2hhbmRsZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ICJVQUYuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBUaGVyZSBpcyBVQUYgZW5yb2xsbWVudCBmb3IgdXNlciAnJXMnLiBVc2VyIGF1dGhlbnRpY2F0ZWQgc3VjY2Vzc2Z1bGx5IiAlIHVzZXJfbmFtZQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdXNlclNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oVXNlclNlcnZpY2UpCgogICAgICAgICAgICAgICAgIyBEb3VibGUgY2hlY2sganVzdCB0byBtYWtlIHN1cmUuIFdlIGRpZCBjaGVja2luZyBpbiBwcmV2aW91cyBzdGVwCiAgICAgICAgICAgICAgICAjIENoZWNrIGlmIHRoZXJlIGlzIHVzZXIgd2hpY2ggaGFzIHVhZl91c2VyX2V4dGVybmFsX3VpZAogICAgICAgICAgICAgICAgIyBBdm9pZCBtYXBwaW5nIHVzZXIgY2VydCB0byBtb3JlIHRoYW4gb25lIElEUCBhY2NvdW50CiAgICAgICAgICAgICAgICBmaW5kX3VzZXJfYnlfZXh0ZXJuYWxfdWlkID0gdXNlclNlcnZpY2UuZ2V0VXNlckJ5QXR0cmlidXRlKCJveEV4dGVybmFsVWlkIiwgdWFmX3VzZXJfZXh0ZXJuYWxfdWlkKQogICAgICAgICAgICAgICAgaWYgZmluZF91c2VyX2J5X2V4dGVybmFsX3VpZCA9PSBOb25lOgogICAgICAgICAgICAgICAgICAgICMgQWRkIHVhZl91c2VyX2V4dGVybmFsX3VpZCB0byB1c2VyJ3MgZXh0ZXJuYWwgR1VJRCBsaXN0CiAgICAgICAgICAgICAgICAgICAgZmluZF91c2VyX2J5X2V4dGVybmFsX3VpZCA9IHVzZXJTZXJ2aWNlLmFkZFVzZXJBdHRyaWJ1dGUodXNlcl9uYW1lLCAib3hFeHRlcm5hbFVpZCIsIHVhZl91c2VyX2V4dGVybmFsX3VpZCkKICAgICAgICAgICAgICAgICAgICBpZiBmaW5kX3VzZXJfYnlfZXh0ZXJuYWxfdWlkID09IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ICJVQUYuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gdXBkYXRlIGN1cnJlbnQgdXNlciIKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHByZXBhcmVGb3JTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CiAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkKCiAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCiAgICAgICAgY3JlZGVudGlhbHMgPSBpZGVudGl0eS5nZXRDcmVkZW50aWFscygpCgogICAgICAgIHNlc3Npb25fYXR0cmlidXRlcyA9IGlkZW50aXR5LmdldFNlc3Npb25JZCgpLmdldFNlc3Npb25BdHRyaWJ1dGVzKCkKCiAgICAgICAgc2VsZi5zZXRSZXF1ZXN0U2NvcGVkUGFyYW1ldGVycyhpZGVudGl0eSkKCiAgICAgICAgaWYgKHN0ZXAgPT0gMSk6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxpZiAoc3RlcCA9PSAyKToKICAgICAgICAgICAgcHJpbnQgIlVBRi4gUHJlcGFyZSBmb3Igc3RlcCAyIgoKICAgICAgICAgICAgc2Vzc2lvbiA9IENkaVV0aWwuYmVhbihTZXNzaW9uSWRTZXJ2aWNlKS5nZXRTZXNzaW9uSWQoKQogICAgICAgICAgICBpZiBzZXNzaW9uID09IE5vbmU6CiAgICAgICAgICAgICAgICBwcmludCAiVUFGLiBQcmVwYXJlIGZvciBzdGVwIDIuIEZhaWxlZCB0byBkZXRlcm1pbmUgc2Vzc2lvbl9pZCIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgdXNlciA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpCiAgICAgICAgICAgIGlmICh1c2VyID09IE5vbmUpOgogICAgICAgICAgICAgICAgcHJpbnQgIlVBRi4gUHJlcGFyZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gZGV0ZXJtaW5lIHVzZXIgbmFtZSIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgdWFmX2F1dGhfbWV0aG9kID0gc2Vzc2lvbl9hdHRyaWJ1dGVzLmdldCgidWFmX2F1dGhfbWV0aG9kIikKICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzRW1wdHkodWFmX2F1dGhfbWV0aG9kKToKICAgICAgICAgICAgICAgIHByaW50ICJVQUYuIFByZXBhcmUgZm9yIHN0ZXAgMi4gRmFpbGVkIHRvIGRldGVybWluZSBhdXRoX21ldGhvZCIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgcHJpbnQgIlVBRi4gUHJlcGFyZSBmb3Igc3RlcCAyLiB1YWZfYXV0aF9tZXRob2Q6ICclcyciICUgdWFmX2F1dGhfbWV0aG9kCgogICAgICAgICAgICB1YWZfb2JiX2F1dGhfbWV0aG9kID0gIk9PQl9SRUciCiAgICAgICAgICAgIHVhZl9vYmJfc2VydmVyX3VyaSA9IHNlbGYudWFmX3NlcnZlcl91cmkgKyAiL25ubC92Mi9yZWciIAogICAgICAgICAgICBpZiBTdHJpbmdIZWxwZXIuZXF1YWxzSWdub3JlQ2FzZSh1YWZfYXV0aF9tZXRob2QsICJhdXRoZW50aWNhdGUiKToKICAgICAgICAgICAgICAgIHVhZl9vYmJfYXV0aF9tZXRob2QgPSAiT09CX0FVVEgiCiAgICAgICAgICAgICAgICB1YWZfb2JiX3NlcnZlcl91cmkgPSBzZWxmLnVhZl9zZXJ2ZXJfdXJpICsgIi9ubmwvdjIvYXV0aCIgCgogICAgICAgICAgICAjIFByZXBhcmUgU1RBUlRfT0JCCiAgICAgICAgICAgIHVhZl9vYmJfc3RhcnRfcmVxdWVzdF9kaWN0aW9uYXJ5ID0geyAib3BlcmF0aW9uIjogIlNUQVJUXyVzIiAlIHVhZl9vYmJfYXV0aF9tZXRob2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidXNlck5hbWUiOiB1c2VyLmdldFVzZXJJZCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInBvbGljeU5hbWUiOiAiZGVmYXVsdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAib29iTW9kZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7ICJxciI6ICJ0cnVlIiwgInJhd0RhdGEiOiAiZmFsc2UiLCAicHVzaCI6ICJmYWxzZSIgfSAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB1YWZfb2JiX3N0YXJ0X3JlcXVlc3QgPSBqc29uLmR1bXBzKHVhZl9vYmJfc3RhcnRfcmVxdWVzdF9kaWN0aW9uYXJ5LCBzZXBhcmF0b3JzPSgnLCcsJzonKSkKICAgICAgICAgICAgcHJpbnQgIlVBRi4gUHJlcGFyZSBmb3Igc3RlcCAyLiBQcmVwYXJlZCBTVEFSVCByZXF1ZXN0OiAnJXMnIHRvIHNlbmQgdG8gJyVzJyIgJSAodWFmX29iYl9zdGFydF9yZXF1ZXN0LCB1YWZfb2JiX3NlcnZlcl91cmkpCgogICAgICAgICAgICAjIFJlcXVlc3QgU1RBUlRfT0JCCiAgICAgICAgICAgIHVhZl9vYmJfc3RhcnRfcmVzcG9uc2UgPSBzZWxmLmV4ZWN1dGVQb3N0KHVhZl9vYmJfc2VydmVyX3VyaSwgdWFmX29iYl9zdGFydF9yZXF1ZXN0KQogICAgICAgICAgICBpZiB1YWZfb2JiX3N0YXJ0X3Jlc3BvbnNlID09IE5vbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIHByaW50ICJVQUYuIFByZXBhcmUgZm9yIHN0ZXAgMi4gR2V0IFNUQVJUIHJlc3BvbnNlOiAnJXMnIiAlIHVhZl9vYmJfc3RhcnRfcmVzcG9uc2UKICAgICAgICAgICAgdWFmX29iYl9zdGFydF9yZXNwb25zZV9qc29uID0ganNvbi5sb2Fkcyh1YWZfb2JiX3N0YXJ0X3Jlc3BvbnNlKQoKICAgICAgICAgICAgIyBQcmVwYXJlIFNUQVRVU19PQkIKICAgICAgICAgICAgI1RPRE86IFJlbW92ZSBuZWVkRGV0YWlscyBwYXJhbWV0ZXIKICAgICAgICAgICAgdWFmX29iYl9zdGF0dXNfcmVxdWVzdF9kaWN0aW9uYXJ5ID0geyAib3BlcmF0aW9uIjogIlNUQVRVU18lcyIgJSB1YWZfb2JiX2F1dGhfbWV0aG9kLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ1c2VyTmFtZSI6IHVzZXIuZ2V0VXNlcklkKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5lZWREZXRhaWxzIjogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAib29iU3RhdHVzSGFuZGxlIjogdWFmX29iYl9zdGFydF9yZXNwb25zZV9qc29uWyJvb2JTdGF0dXNIYW5kbGUiXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgdWFmX29iYl9zdGF0dXNfcmVxdWVzdCA9IGpzb24uZHVtcHModWFmX29iYl9zdGF0dXNfcmVxdWVzdF9kaWN0aW9uYXJ5LCBzZXBhcmF0b3JzPSgnLCcsJzonKSkKICAgICAgICAgICAgcHJpbnQgIlVBRi4gUHJlcGFyZSBmb3Igc3RlcCAyLiBQcmVwYXJlZCBTVEFUVVMgcmVxdWVzdDogJyVzJyB0byBzZW5kIHRvICclcyciICUgKHVhZl9vYmJfc3RhdHVzX3JlcXVlc3QsIHVhZl9vYmJfc2VydmVyX3VyaSkKCiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInVhZl9vYmJfYXV0aF9tZXRob2QiLCB1YWZfb2JiX2F1dGhfbWV0aG9kKQogICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJ1YWZfb2JiX3NlcnZlcl91cmkiLCB1YWZfb2JiX3NlcnZlcl91cmkpCiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInVhZl9vYmJfc3RhcnRfcmVzcG9uc2UiLCB1YWZfb2JiX3N0YXJ0X3Jlc3BvbnNlKQogICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJxcl9pbWFnZSIsIHVhZl9vYmJfc3RhcnRfcmVzcG9uc2VfanNvblsibW9kZVJlc3VsdCJdWyJxckNvZGUiXVsicXJJbWFnZSJdKQogICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJ1YWZfb2JiX3N0YXR1c19yZXF1ZXN0IiwgdWFmX29iYl9zdGF0dXNfcmVxdWVzdCkKCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdldEV4dHJhUGFyYW1ldGVyc0ZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIHJldHVybiBBcnJheXMuYXNMaXN0KCJ1YWZfYXV0aF9tZXRob2QiLCAidWFmX29iYl9hdXRoX21ldGhvZCIsICJ1YWZfb2JiX3NlcnZlcl91cmkiLCAidWFmX29iYl9zdGFydF9yZXNwb25zZSIpCgogICAgZGVmIGdldENvdW50QXV0aGVudGljYXRpb25TdGVwcyhzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcmV0dXJuIDIKCiAgICBkZWYgZ2V0UGFnZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIGlmIChzdGVwID09IDIpOgogICAgICAgICAgICByZXR1cm4gIi9hdXRoL3VhZi9sb2dpbi54aHRtbCIKCiAgICAgICAgcmV0dXJuICIiCgogICAgZGVmIGdldE5leHRTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CiAgICAgICAgcmV0dXJuIC0xCgogICAgZGVmIGdldExvZ291dEV4dGVybmFsVXJsKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcHJpbnQgIkdldCBleHRlcm5hbCBsb2dvdXQgVVJMIGNhbGwiCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgbG9nb3V0KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgc2V0UmVxdWVzdFNjb3BlZFBhcmFtZXRlcnMoc2VsZiwgaWRlbnRpdHkpOgogICAgICAgIGlmIHNlbGYucmVnaXN0cmF0aW9uX3VyaSAhPSBOb25lOgogICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJleHRlcm5hbF9yZWdpc3RyYXRpb25fdXJpIiwgc2VsZi5yZWdpc3RyYXRpb25fdXJpKQogICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInFyX29wdGlvbnMiLCBzZWxmLmN1c3RvbVFyT3B0aW9ucykKCiAgICBkZWYgcHJvY2Vzc0Jhc2ljQXV0aGVudGljYXRpb24oc2VsZiwgY3JlZGVudGlhbHMpOgogICAgICAgIHVzZXJTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFVzZXJTZXJ2aWNlKQogICAgICAgIGF1dGhlbnRpY2F0aW9uU2VydmljZSA9IENkaVV0aWwuYmVhbihBdXRoZW50aWNhdGlvblNlcnZpY2UpCgogICAgICAgIHVzZXJfbmFtZSA9IGNyZWRlbnRpYWxzLmdldFVzZXJuYW1lKCkKICAgICAgICB1c2VyX3Bhc3N3b3JkID0gY3JlZGVudGlhbHMuZ2V0UGFzc3dvcmQoKQoKICAgICAgICBsb2dnZWRfaW4gPSBGYWxzZQogICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5U3RyaW5nKHVzZXJfbmFtZSkgYW5kIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5U3RyaW5nKHVzZXJfcGFzc3dvcmQpOgogICAgICAgICAgICBsb2dnZWRfaW4gPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJfbmFtZSwgdXNlcl9wYXNzd29yZCkKCiAgICAgICAgaWYgbm90IGxvZ2dlZF9pbjoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgZmluZF91c2VyX2J5X3VpZCA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpCiAgICAgICAgaWYgZmluZF91c2VyX2J5X3VpZCA9PSBOb25lOgogICAgICAgICAgICBwcmludCAiVUFGLiBQcm9jZXNzIGJhc2ljIGF1dGhlbnRpY2F0aW9uLiBGYWlsZWQgdG8gZmluZCB1c2VyICclcyciICUgdXNlcl9uYW1lCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGZpbmRfdXNlcl9ieV91aWQKCiAgICBkZWYgZmluZEVucm9sbG1lbnRzKHNlbGYsIGNyZWRlbnRpYWxzKToKICAgICAgICByZXN1bHQgPSBbXQoKICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkKICAgICAgICB1c2VyX25hbWUgPSBjcmVkZW50aWFscy5nZXRVc2VybmFtZSgpCiAgICAgICAgdXNlciA9IHVzZXJTZXJ2aWNlLmdldFVzZXIodXNlcl9uYW1lLCAib3hFeHRlcm5hbFVpZCIpCiAgICAgICAgaWYgdXNlciA9PSBOb25lOgogICAgICAgICAgICBwcmludCAiVUFGLiBGaW5kIGVucm9sbG1lbnRzLiBGYWlsZWQgdG8gZmluZCB1c2VyIgogICAgICAgICAgICByZXR1cm4gcmVzdWx0CiAgICAgICAgCiAgICAgICAgdXNlcl9jdXN0b21fZXh0X2F0dHJpYnV0ZSA9IHVzZXJTZXJ2aWNlLmdldEN1c3RvbUF0dHJpYnV0ZSh1c2VyLCAib3hFeHRlcm5hbFVpZCIpCiAgICAgICAgaWYgdXNlcl9jdXN0b21fZXh0X2F0dHJpYnV0ZSA9PSBOb25lOgogICAgICAgICAgICByZXR1cm4gcmVzdWx0CiAgICAgICAgCiAgICAgICAgdWFmX3ByZWZpeCA9ICJ1YWY6IgogICAgICAgIHVhZl9wcmVmaXhfbGVuZ3RoID0gbGVuKHVhZl9wcmVmaXgpIAogICAgICAgIGZvciB1c2VyX2V4dGVybmFsX3VpZCBpbiB1c2VyX2N1c3RvbV9leHRfYXR0cmlidXRlLmdldFZhbHVlcygpOgogICAgICAgICAgICBpbmRleCA9IHVzZXJfZXh0ZXJuYWxfdWlkLmZpbmQodWFmX3ByZWZpeCkKICAgICAgICAgICAgaWYgaW5kZXggIT0gLTE6CiAgICAgICAgICAgICAgICBlbnJvbGxtZW50X3VpZCA9IHVzZXJfZXh0ZXJuYWxfdWlkW3VhZl9wcmVmaXhfbGVuZ3RoOl0KICAgICAgICAgICAgICAgIHJlc3VsdC5hcHBlbmQoZW5yb2xsbWVudF91aWQpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJlc3VsdAoKICAgIGRlZiBleGVjdXRlUG9zdChzZWxmLCByZXF1ZXN0X3VyaSwgcmVxdWVzdF9kYXRhKToKICAgICAgICBodHRwU2VydmljZSA9IENkaVV0aWwuYmVhbihIdHRwU2VydmljZSkKCiAgICAgICAgcmVxdWVzdF9oZWFkZXJzID0geyAiQ29udGVudC10eXBlIiA6ICJhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PVVURi04IiwgIkFjY2VwdCIgOiAiYXBwbGljYXRpb24vanNvbiIgfQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGh0dHBfc2VydmljZV9yZXNwb25zZSA9IGh0dHBTZXJ2aWNlLmV4ZWN1dGVQb3N0KHNlbGYuaHR0cF9jbGllbnQsIHJlcXVlc3RfdXJpLCBOb25lLCByZXF1ZXN0X2hlYWRlcnMsIHJlcXVlc3RfZGF0YSkKICAgICAgICAgICAgaHR0cF9yZXNwb25zZSA9IGh0dHBfc2VydmljZV9yZXNwb25zZS5nZXRIdHRwUmVzcG9uc2UoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIlVBRi4gVmFsaWRhdGUgUE9TVCByZXNwb25zZS4gRXhjZXB0aW9uOiAiLCBzeXMuZXhjX2luZm8oKVsxXQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG5vdCBodHRwU2VydmljZS5pc1Jlc3BvbnNlU3Rhc3R1c0NvZGVPayhodHRwX3Jlc3BvbnNlKToKICAgICAgICAgICAgICAgIHByaW50ICJVQUYuIFZhbGlkYXRlIFBPU1QgcmVzcG9uc2UuIEdldCBpbnZhbGlkIHJlc3BvbnNlIGZyb20gIHNlcnZlcjogJXMiICUgc3RyKGh0dHBfcmVzcG9uc2UuZ2V0U3RhdHVzTGluZSgpLmdldFN0YXR1c0NvZGUoKSkKICAgICAgICAgICAgICAgIGh0dHBTZXJ2aWNlLmNvbnN1bWUoaHR0cF9yZXNwb25zZSkKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAKICAgICAgICAgICAgcmVzcG9uc2VfYnl0ZXMgPSBodHRwU2VydmljZS5nZXRSZXNwb25zZUNvbnRlbnQoaHR0cF9yZXNwb25zZSkKICAgICAgICAgICAgcmVzcG9uc2Vfc3RyaW5nID0gaHR0cFNlcnZpY2UuY29udmVydEVudGl0eVRvU3RyaW5nKHJlc3BvbnNlX2J5dGVzKQogICAgICAgICAgICBodHRwU2VydmljZS5jb25zdW1lKGh0dHBfcmVzcG9uc2UpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Vfc3RyaW5nCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgaHR0cF9zZXJ2aWNlX3Jlc3BvbnNlLmNsb3NlQ29ubmVjdGlvbigpCiAgICAgICAgcmV0dXJuIE5vbmUK
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=5018-D4BF,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: HOTP/TOPT authentication module
displayName: otp
oxEnabled: false
inum: 5018-D4BF
oxConfigurationProperty: {"value1":"otp_type","value2":"totp","description":""}
oxConfigurationProperty: {"value1":"otp_conf_file","value2":"/etc/certs/otp_configuration.json","description":""}
oxConfigurationProperty: {"value1":"issuer","value2":"Gluu Inc","description":""}
oxConfigurationProperty: {"value1":"label","value2":"Gluu OTP","description":""}
oxConfigurationProperty: {"value1":"qr_options","value2":"{ size: 400, mSize: 0.05 }","description":""}
oxConfigurationProperty: {"value1":"registration_uri","value2":"https://instance-1.us-central1-a.c.nifty-canyon-287111.internal/identity/register","description":""}
oxLevel: 40
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKIyBSZXF1aXJlcyB0aGUgZm9sbG93aW5nIGN1c3RvbSBwcm9wZXJ0aWVzIGFuZCB2YWx1ZXM6CiMgICBvdHBfdHlwZTogdG90cC9ob3RwCiMgICBpc3N1ZXI6IEdsdXUgSW5jCiMgICBvdHBfY29uZl9maWxlOiAvZXRjL2NlcnRzL290cF9jb25maWd1cmF0aW9uLmpzb24KIwojIFRoZXNlIGFyZSBub24gbWFuZGF0b3J5IGN1c3RvbSBwcm9wZXJ0aWVzIGFuZCB2YWx1ZXM6CiMgICBsYWJlbDogR2x1dSBPVFAKIyAgIHFyX29wdGlvbnM6IHsgd2lkdGg6IDQwMCwgaGVpZ2h0OiA0MDAgfQojICAgcmVnaXN0cmF0aW9uX3VyaTogaHR0cHM6Ly9jZS1kZXYuZ2x1dS5vcmcvaWRlbnRpdHkvcmVnaXN0ZXIKCmltcG9ydCBqYXJyYXkKaW1wb3J0IGpzb24KaW1wb3J0IHN5cwpmcm9tIGNvbS5nb29nbGUuY29tbW9uLmlvIGltcG9ydCBCYXNlRW5jb2RpbmcKZnJvbSBjb20ubG9jaGJyaWRnZS5vYXRoLm90cCBpbXBvcnQgSE9UUApmcm9tIGNvbS5sb2NoYnJpZGdlLm9hdGgub3RwIGltcG9ydCBIT1RQVmFsaWRhdG9yCmZyb20gY29tLmxvY2hicmlkZ2Uub2F0aC5vdHAgaW1wb3J0IEhtYWNTaGFBbGdvcml0aG0KZnJvbSBjb20ubG9jaGJyaWRnZS5vYXRoLm90cCBpbXBvcnQgVE9UUApmcm9tIGNvbS5sb2NoYnJpZGdlLm9hdGgub3RwLmtleXByb3Zpc2lvbmluZyBpbXBvcnQgT1RQQXV0aFVSSUJ1aWxkZXIKZnJvbSBjb20ubG9jaGJyaWRnZS5vYXRoLm90cC5rZXlwcm92aXNpb25pbmcgaW1wb3J0IE9UUEtleQpmcm9tIGNvbS5sb2NoYnJpZGdlLm9hdGgub3RwLmtleXByb3Zpc2lvbmluZy5PVFBLZXkgaW1wb3J0IE9UUFR5cGUKZnJvbSBqYXZhLnNlY3VyaXR5IGltcG9ydCBTZWN1cmVSYW5kb20KZnJvbSBqYXZhLnV0aWwgaW1wb3J0IEFycmF5cwpmcm9tIGphdmEudXRpbC5jb25jdXJyZW50IGltcG9ydCBUaW1lVW5pdApmcm9tIGphdmF4LmZhY2VzLmFwcGxpY2F0aW9uIGltcG9ydCBGYWNlc01lc3NhZ2UKZnJvbSBvcmcuZ2x1dS5qc2YyLm1lc3NhZ2UgaW1wb3J0IEZhY2VzTWVzc2FnZXMKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuYXV0aCBpbXBvcnQgUGVyc29uQXV0aGVudGljYXRpb25UeXBlCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlY3VyaXR5IGltcG9ydCBJZGVudGl0eQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlIGltcG9ydCBBdXRoZW50aWNhdGlvblNlcnZpY2UsIFNlc3Npb25JZFNlcnZpY2UKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5jb21tb24gaW1wb3J0IFVzZXJTZXJ2aWNlCmZyb20gb3JnLmdsdXUub3hhdXRoLnV0aWwgaW1wb3J0IFNlcnZlclV0aWwKZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlLmNkaS51dGlsIGltcG9ydCBDZGlVdGlsCmZyb20gb3JnLmdsdXUudXRpbCBpbXBvcnQgU3RyaW5nSGVscGVyCgoKY2xhc3MgUGVyc29uQXV0aGVudGljYXRpb24oUGVyc29uQXV0aGVudGljYXRpb25UeXBlKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6CiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIk9UUC4gSW5pdGlhbGl6YXRpb24iCgogICAgICAgIGlmIG5vdCBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5jb250YWluc0tleSgib3RwX3R5cGUiKToKICAgICAgICAgICAgcHJpbnQgIk9UUC4gSW5pdGlhbGl6YXRpb24uIFByb3BlcnR5IG90cF90eXBlIGlzIG1hbmRhdG9yeSIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgc2VsZi5vdHBUeXBlID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJvdHBfdHlwZSIpLmdldFZhbHVlMigpCgogICAgICAgIGlmIG5vdCBzZWxmLm90cFR5cGUgaW4gWyJob3RwIiwgInRvdHAiXToKICAgICAgICAgICAgcHJpbnQgIk9UUC4gSW5pdGlhbGl6YXRpb24uIFByb3BlcnR5IHZhbHVlIG90cF90eXBlIGlzIGludmFsaWQiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBpZiBub3QgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImlzc3VlciIpOgogICAgICAgICAgICBwcmludCAiT1RQLiBJbml0aWFsaXphdGlvbi4gUHJvcGVydHkgaXNzdWVyIGlzIG1hbmRhdG9yeSIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgc2VsZi5vdHBJc3N1ZXIgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImlzc3VlciIpLmdldFZhbHVlMigpCgogICAgICAgIHNlbGYuY3VzdG9tTGFiZWwgPSBOb25lCiAgICAgICAgaWYgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImxhYmVsIik6CiAgICAgICAgICAgIHNlbGYuY3VzdG9tTGFiZWwgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImxhYmVsIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgc2VsZi5jdXN0b21Rck9wdGlvbnMgPSB7fQogICAgICAgIGlmIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJxcl9vcHRpb25zIik6CiAgICAgICAgICAgIHNlbGYuY3VzdG9tUXJPcHRpb25zID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJxcl9vcHRpb25zIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgc2VsZi5yZWdpc3RyYXRpb25VcmkgPSBOb25lCiAgICAgICAgaWYgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoInJlZ2lzdHJhdGlvbl91cmkiKToKICAgICAgICAgICAgc2VsZi5yZWdpc3RyYXRpb25VcmkgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoInJlZ2lzdHJhdGlvbl91cmkiKS5nZXRWYWx1ZTIoKQoKICAgICAgICB2YWxpZE90cENvbmZpZ3VyYXRpb24gPSBzZWxmLmxvYWRPdHBDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKQogICAgICAgIGlmIG5vdCB2YWxpZE90cENvbmZpZ3VyYXRpb246CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBwcmludCAiT1RQLiBJbml0aWFsaXplZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIk9UUC4gRGVzdHJveSIKICAgICAgICBwcmludCAiT1RQLiBEZXN0cm95ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGdldEFwaVZlcnNpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIDExCiAgICAgICAgCiAgICBkZWYgZ2V0QXV0aGVudGljYXRpb25NZXRob2RDbGFpbXMoc2VsZiwgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGdldE5leHRTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CiAgICAgICAgcHJpbnQgImdldE5leHRTdGVwIEludm9rZWQiCiAgICAgICAgIyBJZiB1c2VyIG5vdCBwYXNzIGN1cnJlbnQgc3RlcCBjaGFuZ2Ugc3RlcCB0byBwcmV2aW91cwogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQogICAgICAgIHJldHJ5X2N1cnJlbnRfc3RlcCA9IGlkZW50aXR5LmdldFdvcmtpbmdQYXJhbWV0ZXIoInJldHJ5X2N1cnJlbnRfc3RlcCIpCiAgICAgICAgaWYgcmV0cnlfY3VycmVudF9zdGVwOgogICAgICAgICAgICBwcmludCAiT1RQLiBHZXQgbmV4dCBzdGVwLiBSZXRyeWluZyBjdXJyZW50IHN0ZXAgJXMiICUgc3RlcAogICAgICAgICAgICAjIFJlbW92ZSBvbGQgUVIgY29kZQogICAgICAgICAgICAjaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigic3VwZXJfZ2x1dV9yZXF1ZXN0IiwgInRpbWVvdXQiKQogICAgICAgICAgICByZXN1bHRTdGVwID0gc3RlcAogICAgICAgICAgICByZXR1cm4gcmVzdWx0U3RlcAogICAgICAgIHJldHVybiAtMQoKICAgIGRlZiBpc1ZhbGlkQXV0aGVudGljYXRpb25NZXRob2Qoc2VsZiwgdXNhZ2VUeXBlLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZ2V0QWx0ZXJuYXRpdmVBdXRoZW50aWNhdGlvbk1ldGhvZChzZWxmLCB1c2FnZVR5cGUsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBhdXRoZW50aWNhdGUoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKICAgICAgICBhdXRoZW50aWNhdGlvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oQXV0aGVudGljYXRpb25TZXJ2aWNlKQoKICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKICAgICAgICBjcmVkZW50aWFscyA9IGlkZW50aXR5LmdldENyZWRlbnRpYWxzKCkKCiAgICAgICAgc2VsZi5zZXRSZXF1ZXN0U2NvcGVkUGFyYW1ldGVycyhpZGVudGl0eSkKCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICBwcmludCAiT1RQLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMSIKICAgICAgICAgICAgYXV0aGVudGljYXRlZF91c2VyID0gc2VsZi5wcm9jZXNzQmFzaWNBdXRoZW50aWNhdGlvbihjcmVkZW50aWFscykKICAgICAgICAgICAgaWYgYXV0aGVudGljYXRlZF91c2VyID09IE5vbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIG90cF9hdXRoX21ldGhvZCA9ICJhdXRoZW50aWNhdGUiCiAgICAgICAgICAgICMgVW5jb21tZW50IHRoaXMgYmxvY2sgaWYgeW91IG5lZWQgdG8gYWxsb3cgdXNlciBzZWNvbmQgT1RQIHJlZ2lzdHJhdGlvbgogICAgICAgICAgICAjZW5yb2xsbWVudF9tb2RlID0gU2VydmVyVXRpbC5nZXRGaXJzdFZhbHVlKHJlcXVlc3RQYXJhbWV0ZXJzLCAibG9naW5Gb3JtOnJlZ2lzdGVyQnV0dG9uIikKICAgICAgICAgICAgI2lmIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5KGVucm9sbG1lbnRfbW9kZSk6CiAgICAgICAgICAgICMgICAgb3RwX2F1dGhfbWV0aG9kID0gImVucm9sbCIKCiAgICAgICAgICAgIGlmIG90cF9hdXRoX21ldGhvZCA9PSAiYXV0aGVudGljYXRlIjoKICAgICAgICAgICAgICAgIHVzZXJfZW5yb2xsbWVudHMgPSBzZWxmLmZpbmRFbnJvbGxtZW50cyhhdXRoZW50aWNhdGVkX3VzZXIuZ2V0VXNlcklkKCkpCiAgICAgICAgICAgICAgICBpZiBsZW4odXNlcl9lbnJvbGxtZW50cykgPT0gMDoKICAgICAgICAgICAgICAgICAgICBvdHBfYXV0aF9tZXRob2QgPSAiZW5yb2xsIgogICAgICAgICAgICAgICAgICAgIHByaW50ICJPVFAuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiBUaGVyZSBpcyBubyBPVFAgZW5yb2xsbWVudCBmb3IgdXNlciAnJXMnLiBDaGFuZ2luZyBvdHBfYXV0aF9tZXRob2QgdG8gJyVzJyIgJSAoYXV0aGVudGljYXRlZF91c2VyLmdldFVzZXJJZCgpLCBvdHBfYXV0aF9tZXRob2QpCgogICAgICAgICAgICBpZiBvdHBfYXV0aF9tZXRob2QgPT0gImVucm9sbCI6CiAgICAgICAgICAgICAgICBwcmludCAiT1RQLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMS4gU2V0dGluZyBjb3VudCBzdGVwczogJyVzJyIgJSAzCiAgICAgICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJvdHBfY291bnRfbG9naW5fc3RlcHMiLCAzKQoKICAgICAgICAgICAgcHJpbnQgIk9UUC4gQXV0aGVudGljYXRlIGZvciBzdGVwIDEuIG90cF9hdXRoX21ldGhvZDogJyVzJyIgJSBvdHBfYXV0aF9tZXRob2QKICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigib3RwX2F1dGhfbWV0aG9kIiwgb3RwX2F1dGhfbWV0aG9kKQoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbGlmIHN0ZXAgPT0gMjoKICAgICAgICAgICAgcHJpbnQgIk9UUC4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIiCgogICAgICAgICAgICBhdXRoZW50aWNhdGlvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oQXV0aGVudGljYXRpb25TZXJ2aWNlKQogICAgICAgICAgICB1c2VyID0gYXV0aGVudGljYXRpb25TZXJ2aWNlLmdldEF1dGhlbnRpY2F0ZWRVc2VyKCkKICAgICAgICAgICAgaWYgdXNlciA9PSBOb25lOgogICAgICAgICAgICAgICAgcHJpbnQgIk9UUC4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIuIEZhaWxlZCB0byBkZXRlcm1pbmUgdXNlciBuYW1lIgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBzZXNzaW9uX2lkX3ZhbGlkYXRpb24gPSBzZWxmLnZhbGlkYXRlU2Vzc2lvbklkKGlkZW50aXR5KQogICAgICAgICAgICBpZiBub3Qgc2Vzc2lvbl9pZF92YWxpZGF0aW9uOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICAjIFJlc3RvcmUgc3RhdGUgZnJvbSBzZXNzaW9uCiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInJldHJ5X2N1cnJlbnRfc3RlcCIsIEZhbHNlKQogICAgICAgICAgICBvdHBfYXV0aF9tZXRob2QgPSBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKCJvdHBfYXV0aF9tZXRob2QiKQogICAgICAgICAgICBpZiBvdHBfYXV0aF9tZXRob2QgPT0gJ2Vucm9sbCc6CiAgICAgICAgICAgICAgICBhdXRoX3Jlc3VsdCA9IFNlcnZlclV0aWwuZ2V0Rmlyc3RWYWx1ZShyZXF1ZXN0UGFyYW1ldGVycywgImF1dGhfcmVzdWx0IikKICAgICAgICAgICAgICAgIGlmIG5vdCBTdHJpbmdIZWxwZXIuaXNFbXB0eShhdXRoX3Jlc3VsdCk6CiAgICAgICAgICAgICAgICAgICAgIyBkZWZlY3QgZml4ICMxMjI1ICAtIFJldHJ5IHRoZSBzdGVwLCBzaG93IFFSIGNvZGUgYWdhaW4KICAgICAgICAgICAgICAgICAgICBpZiBhdXRoX3Jlc3VsdCA9PSAndGltZW91dCc6CgkJCQkJCXByaW50ICJPVFAuIFFSLWNvZGUgdGltZW91dC4gQXV0aGVudGljYXRlIGZvciBzdGVwICVzLiBSZWluaXRpYWxpemluZyBjdXJyZW50IHN0ZXAiICUgc3RlcAoJCQkJCQlpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJyZXRyeV9jdXJyZW50X3N0ZXAiLCBUcnVlKQoJCQkJCQlyZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgICAgICAgICBwcmludCAiT1RQLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gVXNlciBub3QgZW5yb2xsZWQgT1RQIgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgICAgIHByaW50ICJPVFAuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBTa2lwcGluZyB0aGlzIHN0ZXAgZHVyaW5nIGVucm9sbG1lbnQiCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgb3RwX2F1dGhfcmVzdWx0ID0gc2VsZi5wcm9jZXNzT3RwQXV0aGVudGljYXRpb24ocmVxdWVzdFBhcmFtZXRlcnMsIHVzZXIuZ2V0VXNlcklkKCksIGlkZW50aXR5LCBvdHBfYXV0aF9tZXRob2QpCiAgICAgICAgICAgIHByaW50ICJPVFAuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBPVFAgYXV0aGVudGljYXRpb24gcmVzdWx0OiAnJXMnIiAlIG90cF9hdXRoX3Jlc3VsdAoKICAgICAgICAgICAgcmV0dXJuIG90cF9hdXRoX3Jlc3VsdAogICAgICAgIGVsaWYgc3RlcCA9PSAzOgogICAgICAgICAgICBwcmludCAiT1RQLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMyIKCiAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uU2VydmljZSA9IENkaVV0aWwuYmVhbihBdXRoZW50aWNhdGlvblNlcnZpY2UpCiAgICAgICAgICAgIHVzZXIgPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuZ2V0QXV0aGVudGljYXRlZFVzZXIoKQogICAgICAgICAgICBpZiB1c2VyID09IE5vbmU6CiAgICAgICAgICAgICAgICBwcmludCAiT1RQLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gRmFpbGVkIHRvIGRldGVybWluZSB1c2VyIG5hbWUiCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIHNlc3Npb25faWRfdmFsaWRhdGlvbiA9IHNlbGYudmFsaWRhdGVTZXNzaW9uSWQoaWRlbnRpdHkpCiAgICAgICAgICAgIGlmIG5vdCBzZXNzaW9uX2lkX3ZhbGlkYXRpb246CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICMgUmVzdG9yZSBzdGF0ZSBmcm9tIHNlc3Npb24KICAgICAgICAgICAgb3RwX2F1dGhfbWV0aG9kID0gaWRlbnRpdHkuZ2V0V29ya2luZ1BhcmFtZXRlcigib3RwX2F1dGhfbWV0aG9kIikKICAgICAgICAgICAgaWYgb3RwX2F1dGhfbWV0aG9kICE9ICdlbnJvbGwnOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBvdHBfYXV0aF9yZXN1bHQgPSBzZWxmLnByb2Nlc3NPdHBBdXRoZW50aWNhdGlvbihyZXF1ZXN0UGFyYW1ldGVycywgdXNlci5nZXRVc2VySWQoKSwgaWRlbnRpdHksIG90cF9hdXRoX21ldGhvZCkKICAgICAgICAgICAgcHJpbnQgIk9UUC4gQXV0aGVudGljYXRlIGZvciBzdGVwIDMuIE9UUCBhdXRoZW50aWNhdGlvbiByZXN1bHQ6ICclcyciICUgb3RwX2F1dGhfcmVzdWx0CgogICAgICAgICAgICByZXR1cm4gb3RwX2F1dGhfcmVzdWx0CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHByZXBhcmVGb3JTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CiAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCiAgICAgICAgY3JlZGVudGlhbHMgPSBpZGVudGl0eS5nZXRDcmVkZW50aWFscygpCgogICAgICAgIHNlbGYuc2V0UmVxdWVzdFNjb3BlZFBhcmFtZXRlcnMoaWRlbnRpdHkpCgogICAgICAgIGlmIHN0ZXAgPT0gMToKICAgICAgICAgICAgcHJpbnQgIk9UUC4gUHJlcGFyZSBmb3Igc3RlcCAxIgoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbGlmIHN0ZXAgPT0gMjoKICAgICAgICAgICAgcHJpbnQgIk9UUC4gUHJlcGFyZSBmb3Igc3RlcCAyIgoKICAgICAgICAgICAgc2Vzc2lvbl9pZF92YWxpZGF0aW9uID0gc2VsZi52YWxpZGF0ZVNlc3Npb25JZChpZGVudGl0eSkKICAgICAgICAgICAgaWYgbm90IHNlc3Npb25faWRfdmFsaWRhdGlvbjoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgb3RwX2F1dGhfbWV0aG9kID0gaWRlbnRpdHkuZ2V0V29ya2luZ1BhcmFtZXRlcigib3RwX2F1dGhfbWV0aG9kIikKICAgICAgICAgICAgcHJpbnQgIk9UUC4gUHJlcGFyZSBmb3Igc3RlcCAyLiBvdHBfYXV0aF9tZXRob2Q6ICclcyciICUgb3RwX2F1dGhfbWV0aG9kCgogICAgICAgICAgICBpZiBvdHBfYXV0aF9tZXRob2QgPT0gJ2Vucm9sbCc6CiAgICAgICAgICAgICAgICBhdXRoZW50aWNhdGlvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oQXV0aGVudGljYXRpb25TZXJ2aWNlKQogICAgICAgICAgICAgICAgdXNlciA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpCiAgICAgICAgICAgICAgICBpZiB1c2VyID09IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIk9UUC4gUHJlcGFyZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gbG9hZCB1c2VyIGVudHkiCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICAgICAgaWYgc2VsZi5vdHBUeXBlID09ICJob3RwIjoKICAgICAgICAgICAgICAgICAgICBvdHBfc2VjcmV0X2tleSA9IHNlbGYuZ2VuZXJhdGVTZWNyZXRIb3RwS2V5KCkKICAgICAgICAgICAgICAgICAgICBvdHBfZW5yb2xsbWVudF9yZXF1ZXN0ID0gc2VsZi5nZW5lcmF0ZUhvdHBTZWNyZXRLZXlVcmkob3RwX3NlY3JldF9rZXksIHNlbGYub3RwSXNzdWVyLCB1c2VyLmdldEF0dHJpYnV0ZSgiZGlzcGxheU5hbWUiKSkKICAgICAgICAgICAgICAgIGVsaWYgc2VsZi5vdHBUeXBlID09ICJ0b3RwIjoKICAgICAgICAgICAgICAgICAgICBvdHBfc2VjcmV0X2tleSA9IHNlbGYuZ2VuZXJhdGVTZWNyZXRUb3RwS2V5KCkKICAgICAgICAgICAgICAgICAgICBvdHBfZW5yb2xsbWVudF9yZXF1ZXN0ID0gc2VsZi5nZW5lcmF0ZVRvdHBTZWNyZXRLZXlVcmkob3RwX3NlY3JldF9rZXksIHNlbGYub3RwSXNzdWVyLCB1c2VyLmdldEF0dHJpYnV0ZSgiZGlzcGxheU5hbWUiKSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIk9UUC4gUHJlcGFyZSBmb3Igc3RlcCAyLiBVbmtub3duIE9UUCB0eXBlOiAnJXMnIiAlIHNlbGYub3RwVHlwZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgICAgIHByaW50ICJPVFAuIFByZXBhcmUgZm9yIHN0ZXAgMi4gUHJlcGFyZWQgZW5yb2xsbWVudCByZXF1ZXN0IGZvciB1c2VyOiAnJXMnIiAlIHVzZXIuZ2V0VXNlcklkKCkKICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoIm90cF9zZWNyZXRfa2V5Iiwgc2VsZi50b0Jhc2U2NFVybChvdHBfc2VjcmV0X2tleSkpCiAgICAgICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJvdHBfZW5yb2xsbWVudF9yZXF1ZXN0Iiwgb3RwX2Vucm9sbG1lbnRfcmVxdWVzdCkKCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxpZiBzdGVwID09IDM6CiAgICAgICAgICAgIHByaW50ICJPVFAuIFByZXBhcmUgZm9yIHN0ZXAgMyIKCiAgICAgICAgICAgIHNlc3Npb25faWRfdmFsaWRhdGlvbiA9IHNlbGYudmFsaWRhdGVTZXNzaW9uSWQoaWRlbnRpdHkpCiAgICAgICAgICAgIGlmIG5vdCBzZXNzaW9uX2lkX3ZhbGlkYXRpb246CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIG90cF9hdXRoX21ldGhvZCA9IGlkZW50aXR5LmdldFdvcmtpbmdQYXJhbWV0ZXIoIm90cF9hdXRoX21ldGhvZCIpCiAgICAgICAgICAgIHByaW50ICJPVFAuIFByZXBhcmUgZm9yIHN0ZXAgMy4gb3RwX2F1dGhfbWV0aG9kOiAnJXMnIiAlIG90cF9hdXRoX21ldGhvZAoKICAgICAgICAgICAgaWYgb3RwX2F1dGhfbWV0aG9kID09ICdlbnJvbGwnOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdldEV4dHJhUGFyYW1ldGVyc0ZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIHJldHVybiBBcnJheXMuYXNMaXN0KCJvdHBfYXV0aF9tZXRob2QiLCAib3RwX2NvdW50X2xvZ2luX3N0ZXBzIiwgIm90cF9zZWNyZXRfa2V5IiwgIm90cF9lbnJvbGxtZW50X3JlcXVlc3QiLCJyZXRyeV9jdXJyZW50X3N0ZXAiKQoKICAgIGRlZiBnZXRDb3VudEF1dGhlbnRpY2F0aW9uU3RlcHMoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQoKICAgICAgICBpZiBpZGVudGl0eS5pc1NldFdvcmtpbmdQYXJhbWV0ZXIoIm90cF9jb3VudF9sb2dpbl9zdGVwcyIpOgogICAgICAgICAgICByZXR1cm4gU3RyaW5nSGVscGVyLnRvSW50ZWdlcigiJXMiICUgaWRlbnRpdHkuZ2V0V29ya2luZ1BhcmFtZXRlcigib3RwX2NvdW50X2xvZ2luX3N0ZXBzIikpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIDIKCiAgICBkZWYgZ2V0UGFnZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIGlmIHN0ZXAgPT0gMjoKICAgICAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCgogICAgICAgICAgICBvdHBfYXV0aF9tZXRob2QgPSBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKCJvdHBfYXV0aF9tZXRob2QiKQogICAgICAgICAgICBwcmludCAiT1RQLiBHZXAgcGFnZSBmb3Igc3RlcCAyLiBvdHBfYXV0aF9tZXRob2Q6ICclcyciICUgb3RwX2F1dGhfbWV0aG9kCgogICAgICAgICAgICBpZiBvdHBfYXV0aF9tZXRob2QgPT0gJ2Vucm9sbCc6CiAgICAgICAgICAgICAgICByZXR1cm4gIi9hdXRoL290cC9lbnJvbGwueGh0bWwiCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gIi9hdXRoL290cC9vdHBsb2dpbi54aHRtbCIKICAgICAgICBlbGlmIHN0ZXAgPT0gMzoKICAgICAgICAgICAgcmV0dXJuICIvYXV0aC9vdHAvb3RwbG9naW4ueGh0bWwiCgogICAgICAgIHJldHVybiAiIgoKCiAgICBkZWYgZ2V0TG9nb3V0RXh0ZXJuYWxVcmwoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICBwcmludCAiR2V0IGV4dGVybmFsIGxvZ291dCBVUkwgY2FsbCIKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBsb2dvdXQoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBzZXRSZXF1ZXN0U2NvcGVkUGFyYW1ldGVycyhzZWxmLCBpZGVudGl0eSk6CiAgICAgICAgaWYgc2VsZi5yZWdpc3RyYXRpb25VcmkgIT0gTm9uZToKICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigiZXh0ZXJuYWxfcmVnaXN0cmF0aW9uX3VyaSIsIHNlbGYucmVnaXN0cmF0aW9uVXJpKQoKICAgICAgICBpZiBzZWxmLmN1c3RvbUxhYmVsICE9IE5vbmU6CiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInFyX2xhYmVsIiwgc2VsZi5jdXN0b21MYWJlbCkKCiAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigicXJfb3B0aW9ucyIsIHNlbGYuY3VzdG9tUXJPcHRpb25zKQoKICAgIGRlZiBsb2FkT3RwQ29uZmlndXJhdGlvbihzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIk9UUC4gTG9hZCBPVFAgY29uZmlndXJhdGlvbiIKICAgICAgICBpZiBub3QgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoIm90cF9jb25mX2ZpbGUiKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIG90cF9jb25mX2ZpbGUgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoIm90cF9jb25mX2ZpbGUiKS5nZXRWYWx1ZTIoKQoKICAgICAgICAjIExvYWQgY29uZmlndXJhdGlvbiBmcm9tIGZpbGUKICAgICAgICBmID0gb3BlbihvdHBfY29uZl9maWxlLCAncicpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBvdHBDb25maWd1cmF0aW9uID0ganNvbi5sb2FkcyhmLnJlYWQoKSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJPVFAuIExvYWQgT1RQIGNvbmZpZ3VyYXRpb24uIEZhaWxlZCB0byBsb2FkIGNvbmZpZ3VyYXRpb24gZnJvbSBmaWxlOiIsIG90cF9jb25mX2ZpbGUKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgZi5jbG9zZSgpCgogICAgICAgICMgQ2hlY2sgY29uZmlndXJhdGlvbiBmaWxlIHNldHRpbmdzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmhvdHBDb25maWd1cmF0aW9uID0gb3RwQ29uZmlndXJhdGlvblsiaG90cCJdCiAgICAgICAgICAgIHNlbGYudG90cENvbmZpZ3VyYXRpb24gPSBvdHBDb25maWd1cmF0aW9uWyJ0b3RwIl0KICAgICAgICAgICAgCiAgICAgICAgICAgIGhtYWNTaGFBbGdvcml0aG0gPSBzZWxmLnRvdHBDb25maWd1cmF0aW9uWyJobWFjU2hhQWxnb3JpdGhtIl0KICAgICAgICAgICAgaG1hY1NoYUFsZ29yaXRobVR5cGUgPSBOb25lCgogICAgICAgICAgICBpZiBTdHJpbmdIZWxwZXIuZXF1YWxzSWdub3JlQ2FzZShobWFjU2hhQWxnb3JpdGhtLCAic2hhMSIpOgogICAgICAgICAgICAgICAgaG1hY1NoYUFsZ29yaXRobVR5cGUgPSBIbWFjU2hhQWxnb3JpdGhtLkhNQUNfU0hBXzEKICAgICAgICAgICAgZWxpZiBTdHJpbmdIZWxwZXIuZXF1YWxzSWdub3JlQ2FzZShobWFjU2hhQWxnb3JpdGhtLCAic2hhMjU2Iik6CiAgICAgICAgICAgICAgICBobWFjU2hhQWxnb3JpdGhtVHlwZSA9IEhtYWNTaGFBbGdvcml0aG0uSE1BQ19TSEFfMjU2CiAgICAgICAgICAgIGVsaWYgU3RyaW5nSGVscGVyLmVxdWFsc0lnbm9yZUNhc2UoaG1hY1NoYUFsZ29yaXRobSwgInNoYTUxMiIpOgogICAgICAgICAgICAgICAgaG1hY1NoYUFsZ29yaXRobVR5cGUgPSBIbWFjU2hhQWxnb3JpdGhtLkhNQUNfU0hBXzUxMgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQgIk9UUC4gTG9hZCBPVFAgY29uZmlndXJhdGlvbi4gSW52YWxpZCBUT1RQIEhNQUMgU0hBIGFsZ29yaXRobTogJyVzJyIgJSBobWFjU2hhQWxnb3JpdGhtCiAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYudG90cENvbmZpZ3VyYXRpb25bImhtYWNTaGFBbGdvcml0aG1UeXBlIl0gPSBobWFjU2hhQWxnb3JpdGhtVHlwZQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIk9UUC4gTG9hZCBPVFAgY29uZmlndXJhdGlvbi4gSW52YWxpZCBjb25maWd1cmF0aW9uIGZpbGUgJyVzJyBmb3JtYXQuIEV4Y2VwdGlvbjogJyVzJyIgJSAob3RwX2NvbmZfZmlsZSwgc3lzLmV4Y19pbmZvKClbMV0pCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAoKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBwcm9jZXNzQmFzaWNBdXRoZW50aWNhdGlvbihzZWxmLCBjcmVkZW50aWFscyk6CiAgICAgICAgdXNlclNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oVXNlclNlcnZpY2UpCiAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkKCiAgICAgICAgdXNlcl9uYW1lID0gY3JlZGVudGlhbHMuZ2V0VXNlcm5hbWUoKQogICAgICAgIHVzZXJfcGFzc3dvcmQgPSBjcmVkZW50aWFscy5nZXRQYXNzd29yZCgpCgogICAgICAgIGxvZ2dlZF9pbiA9IEZhbHNlCiAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9uYW1lKSBhbmQgU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9wYXNzd29yZCk6CiAgICAgICAgICAgIGxvZ2dlZF9pbiA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5hdXRoZW50aWNhdGUodXNlcl9uYW1lLCB1c2VyX3Bhc3N3b3JkKQoKICAgICAgICBpZiBub3QgbG9nZ2VkX2luOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICBmaW5kX3VzZXJfYnlfdWlkID0gYXV0aGVudGljYXRpb25TZXJ2aWNlLmdldEF1dGhlbnRpY2F0ZWRVc2VyKCkKICAgICAgICBpZiBmaW5kX3VzZXJfYnlfdWlkID09IE5vbmU6CiAgICAgICAgICAgIHByaW50ICJPVFAuIFByb2Nlc3MgYmFzaWMgYXV0aGVudGljYXRpb24uIEZhaWxlZCB0byBmaW5kIHVzZXIgJyVzJyIgJSB1c2VyX25hbWUKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAKICAgICAgICByZXR1cm4gZmluZF91c2VyX2J5X3VpZAoKICAgIGRlZiBmaW5kRW5yb2xsbWVudHMoc2VsZiwgdXNlcl9uYW1lLCBza2lwUHJlZml4ID0gVHJ1ZSk6CiAgICAgICAgcmVzdWx0ID0gW10KCiAgICAgICAgdXNlclNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oVXNlclNlcnZpY2UpCiAgICAgICAgdXNlciA9IHVzZXJTZXJ2aWNlLmdldFVzZXIodXNlcl9uYW1lLCAib3hFeHRlcm5hbFVpZCIpCiAgICAgICAgaWYgdXNlciA9PSBOb25lOgogICAgICAgICAgICBwcmludCAiT1RQLiBGaW5kIGVucm9sbG1lbnRzLiBGYWlsZWQgdG8gZmluZCB1c2VyIgogICAgICAgICAgICByZXR1cm4gcmVzdWx0CiAgICAgICAgCiAgICAgICAgdXNlcl9jdXN0b21fZXh0X2F0dHJpYnV0ZSA9IHVzZXJTZXJ2aWNlLmdldEN1c3RvbUF0dHJpYnV0ZSh1c2VyLCAib3hFeHRlcm5hbFVpZCIpCiAgICAgICAgaWYgdXNlcl9jdXN0b21fZXh0X2F0dHJpYnV0ZSA9PSBOb25lOgogICAgICAgICAgICByZXR1cm4gcmVzdWx0CgogICAgICAgIG90cF9wcmVmaXggPSAiJXM6IiAlIHNlbGYub3RwVHlwZQogICAgICAgIAogICAgICAgIG90cF9wcmVmaXhfbGVuZ3RoID0gbGVuKG90cF9wcmVmaXgpIAogICAgICAgIGZvciB1c2VyX2V4dGVybmFsX3VpZCBpbiB1c2VyX2N1c3RvbV9leHRfYXR0cmlidXRlLmdldFZhbHVlcygpOgogICAgICAgICAgICBpbmRleCA9IHVzZXJfZXh0ZXJuYWxfdWlkLmZpbmQob3RwX3ByZWZpeCkKICAgICAgICAgICAgaWYgaW5kZXggIT0gLTE6CiAgICAgICAgICAgICAgICBpZiBza2lwUHJlZml4OgogICAgICAgICAgICAgICAgICAgIGVucm9sbG1lbnRfdWlkID0gdXNlcl9leHRlcm5hbF91aWRbb3RwX3ByZWZpeF9sZW5ndGg6XQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBlbnJvbGxtZW50X3VpZCA9IHVzZXJfZXh0ZXJuYWxfdWlkCgogICAgICAgICAgICAgICAgcmVzdWx0LmFwcGVuZChlbnJvbGxtZW50X3VpZCkKICAgICAgICAKICAgICAgICByZXR1cm4gcmVzdWx0CgogICAgZGVmIHZhbGlkYXRlU2Vzc2lvbklkKHNlbGYsIGlkZW50aXR5KToKICAgICAgICBzZXNzaW9uID0gQ2RpVXRpbC5iZWFuKFNlc3Npb25JZFNlcnZpY2UpLmdldFNlc3Npb25JZCgpCiAgICAgICAgaWYgc2Vzc2lvbiA9PSBOb25lOgogICAgICAgICAgICBwcmludCAiT1RQLiBWYWxpZGF0ZSBzZXNzaW9uIGlkLiBGYWlsZWQgdG8gZGV0ZXJtaW5lIHNlc3Npb25faWQiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBvdHBfYXV0aF9tZXRob2QgPSBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKCJvdHBfYXV0aF9tZXRob2QiKQogICAgICAgIGlmIG5vdCBvdHBfYXV0aF9tZXRob2QgaW4gWydlbnJvbGwnLCAnYXV0aGVudGljYXRlJ106CiAgICAgICAgICAgIHByaW50ICJPVFAuIFZhbGlkYXRlIHNlc3Npb24gaWQuIEZhaWxlZCB0byBhdXRoZW50aWNhdGUgdXNlci4gb3RwX2F1dGhfbWV0aG9kOiAnJXMnIiAlIG90cF9hdXRoX21ldGhvZAogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgcHJvY2Vzc090cEF1dGhlbnRpY2F0aW9uKHNlbGYsIHJlcXVlc3RQYXJhbWV0ZXJzLCB1c2VyX25hbWUsIGlkZW50aXR5LCBvdHBfYXV0aF9tZXRob2QpOgogICAgICAgIGZhY2VzTWVzc2FnZXMgPSBDZGlVdGlsLmJlYW4oRmFjZXNNZXNzYWdlcykKICAgICAgICBmYWNlc01lc3NhZ2VzLnNldEtlZXBNZXNzYWdlcygpCgogICAgICAgIHVzZXJTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFVzZXJTZXJ2aWNlKQoKICAgICAgICBvdHBDb2RlID0gU2VydmVyVXRpbC5nZXRGaXJzdFZhbHVlKHJlcXVlc3RQYXJhbWV0ZXJzLCAibG9naW5Gb3JtOm90cENvZGUiKQogICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KG90cENvZGUpOgogICAgICAgICAgICBmYWNlc01lc3NhZ2VzLmFkZChGYWNlc01lc3NhZ2UuU0VWRVJJVFlfRVJST1IsICJGYWlsZWQgdG8gYXV0aGVudGljYXRlLiBPVFAgY29kZSBpcyBlbXB0eSIpCiAgICAgICAgICAgIHByaW50ICJPVFAuIFByb2Nlc3MgT1RQIGF1dGhlbnRpY2F0aW9uLiBvdHBDb2RlIGlzIGVtcHR5IgoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgaWYgb3RwX2F1dGhfbWV0aG9kID09ICJlbnJvbGwiOgogICAgICAgICAgICAjIEdldCBrZXkgZnJvbSBzZXNzaW9uCiAgICAgICAgICAgIG90cF9zZWNyZXRfa2V5X2VuY29kZWQgPSBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKCJvdHBfc2VjcmV0X2tleSIpCiAgICAgICAgICAgIGlmIG90cF9zZWNyZXRfa2V5X2VuY29kZWQgPT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJPVFAuIFByb2Nlc3MgT1RQIGF1dGhlbnRpY2F0aW9uLiBPVFAgc2VjcmV0IGtleSBpcyBpbnZhbGlkIgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBvdHBfc2VjcmV0X2tleSA9IHNlbGYuZnJvbUJhc2U2NFVybChvdHBfc2VjcmV0X2tleV9lbmNvZGVkKQoKICAgICAgICAgICAgaWYgc2VsZi5vdHBUeXBlID09ICJob3RwIjoKICAgICAgICAgICAgICAgIHZhbGlkYXRpb25fcmVzdWx0ID0gc2VsZi52YWxpZGF0ZUhvdHBLZXkob3RwX3NlY3JldF9rZXksIDEsIG90cENvZGUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uX3Jlc3VsdCAhPSBOb25lKSBhbmQgdmFsaWRhdGlvbl9yZXN1bHRbInJlc3VsdCJdOgogICAgICAgICAgICAgICAgICAgIHByaW50ICJPVFAuIFByb2Nlc3MgSE9UUCBhdXRoZW50aWNhdGlvbiBkdXJpbmcgZW5yb2xsbWVudC4gb3RwQ29kZSBpcyB2YWxpZCIKICAgICAgICAgICAgICAgICAgICAjIFN0b3JlIEhPVFAgU2VjcmV0IEtleSBhbmQgbW92aW5nIGZhY3RvciBpbiB1c2VyIGVudHJ5CiAgICAgICAgICAgICAgICAgICAgb3RwX3VzZXJfZXh0ZXJuYWxfdWlkID0gImhvdHA6JXM7JXMiICUgKCBvdHBfc2VjcmV0X2tleV9lbmNvZGVkLCB2YWxpZGF0aW9uX3Jlc3VsdFsibW92aW5nRmFjdG9yIl0gKQoKICAgICAgICAgICAgICAgICAgICAjIEFkZCBvdHBfdXNlcl9leHRlcm5hbF91aWQgdG8gdXNlcidzIGV4dGVybmFsIEdVSUQgbGlzdAogICAgICAgICAgICAgICAgICAgIGZpbmRfdXNlcl9ieV9leHRlcm5hbF91aWQgPSB1c2VyU2VydmljZS5hZGRVc2VyQXR0cmlidXRlKHVzZXJfbmFtZSwgIm94RXh0ZXJuYWxVaWQiLCBvdHBfdXNlcl9leHRlcm5hbF91aWQpCiAgICAgICAgICAgICAgICAgICAgaWYgZmluZF91c2VyX2J5X2V4dGVybmFsX3VpZCAhPSBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgICAgICAgICBwcmludCAiT1RQLiBQcm9jZXNzIEhPVFAgYXV0aGVudGljYXRpb24gZHVyaW5nIGVucm9sbG1lbnQuIEZhaWxlZCB0byB1cGRhdGUgdXNlciBlbnRyeSIKICAgICAgICAgICAgZWxpZiBzZWxmLm90cFR5cGUgPT0gInRvdHAiOgogICAgICAgICAgICAgICAgdmFsaWRhdGlvbl9yZXN1bHQgPSBzZWxmLnZhbGlkYXRlVG90cEtleShvdHBfc2VjcmV0X2tleSwgb3RwQ29kZSx1c2VyX25hbWUpCiAgICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbl9yZXN1bHQgIT0gTm9uZSkgYW5kIHZhbGlkYXRpb25fcmVzdWx0WyJyZXN1bHQiXToKICAgICAgICAgICAgICAgICAgICBwcmludCAiT1RQLiBQcm9jZXNzIFRPVFAgYXV0aGVudGljYXRpb24gZHVyaW5nIGVucm9sbG1lbnQuIG90cENvZGUgaXMgdmFsaWQiCiAgICAgICAgICAgICAgICAgICAgIyBTdG9yZSBUT1RQIFNlY3JldCBLZXkgYW5kIG1vdmluZyBmYWN0b3IgaW4gdXNlciBlbnRyeQogICAgICAgICAgICAgICAgICAgIG90cF91c2VyX2V4dGVybmFsX3VpZCA9ICJ0b3RwOiVzIiAlIG90cF9zZWNyZXRfa2V5X2VuY29kZWQKCiAgICAgICAgICAgICAgICAgICAgIyBBZGQgb3RwX3VzZXJfZXh0ZXJuYWxfdWlkIHRvIHVzZXIncyBleHRlcm5hbCBHVUlEIGxpc3QKICAgICAgICAgICAgICAgICAgICBmaW5kX3VzZXJfYnlfZXh0ZXJuYWxfdWlkID0gdXNlclNlcnZpY2UuYWRkVXNlckF0dHJpYnV0ZSh1c2VyX25hbWUsICJveEV4dGVybmFsVWlkIiwgb3RwX3VzZXJfZXh0ZXJuYWxfdWlkKQogICAgICAgICAgICAgICAgICAgIGlmIGZpbmRfdXNlcl9ieV9leHRlcm5hbF91aWQgIT0gTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIk9UUC4gUHJvY2VzcyBUT1RQIGF1dGhlbnRpY2F0aW9uIGR1cmluZyBlbnJvbGxtZW50LiBGYWlsZWQgdG8gdXBkYXRlIHVzZXIgZW50cnkiCiAgICAgICAgZWxpZiBvdHBfYXV0aF9tZXRob2QgPT0gImF1dGhlbnRpY2F0ZSI6CiAgICAgICAgICAgIHVzZXJfZW5yb2xsbWVudHMgPSBzZWxmLmZpbmRFbnJvbGxtZW50cyh1c2VyX25hbWUpCgogICAgICAgICAgICBpZiBsZW4odXNlcl9lbnJvbGxtZW50cykgPT0gMDoKICAgICAgICAgICAgICAgIHByaW50ICJPVFAuIFByb2Nlc3MgT1RQIGF1dGhlbnRpY2F0aW9uLiBUaGVyZSBpcyBubyBPVFAgZW5yb2xsbWVudCBmb3IgdXNlciAnJXMnIiAlIHVzZXJfbmFtZQogICAgICAgICAgICAgICAgZmFjZXNNZXNzYWdlcy5hZGQoRmFjZXNNZXNzYWdlLlNFVkVSSVRZX0VSUk9SLCAiVGhlcmUgaXMgbm8gdmFsaWQgT1RQIHVzZXIgZW5yb2xsbWVudHMiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBpZiBzZWxmLm90cFR5cGUgPT0gImhvdHAiOgogICAgICAgICAgICAgICAgZm9yIHVzZXJfZW5yb2xsbWVudCBpbiB1c2VyX2Vucm9sbG1lbnRzOgogICAgICAgICAgICAgICAgICAgIHVzZXJfZW5yb2xsbWVudF9kYXRhID0gdXNlcl9lbnJvbGxtZW50LnNwbGl0KCI7IikKICAgICAgICAgICAgICAgICAgICBvdHBfc2VjcmV0X2tleV9lbmNvZGVkID0gdXNlcl9lbnJvbGxtZW50X2RhdGFbMF0KCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgY3VycmVudCBtb3ZpbmcgZmFjdG9yIGZyb20gdXNlciBlbnRyeQogICAgICAgICAgICAgICAgICAgIG1vdmluZ19mYWN0b3IgPSBTdHJpbmdIZWxwZXIudG9JbnRlZ2VyKHVzZXJfZW5yb2xsbWVudF9kYXRhWzFdKQogICAgICAgICAgICAgICAgICAgIG90cF9zZWNyZXRfa2V5ID0gc2VsZi5mcm9tQmFzZTY0VXJsKG90cF9zZWNyZXRfa2V5X2VuY29kZWQpCgogICAgICAgICAgICAgICAgICAgICMgVmFsaWRhdGUgVE9UUAogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25fcmVzdWx0ID0gc2VsZi52YWxpZGF0ZUhvdHBLZXkob3RwX3NlY3JldF9rZXksIG1vdmluZ19mYWN0b3IsIG90cENvZGUpCiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25fcmVzdWx0ICE9IE5vbmUpIGFuZCB2YWxpZGF0aW9uX3Jlc3VsdFsicmVzdWx0Il06CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ICJPVFAuIFByb2Nlc3MgSE9UUCBhdXRoZW50aWNhdGlvbiBkdXJpbmcgYXV0aGVudGljYXRpb24uIG90cENvZGUgaXMgdmFsaWQiCiAgICAgICAgICAgICAgICAgICAgICAgIG90cF91c2VyX2V4dGVybmFsX3VpZCA9ICJob3RwOiVzOyVzIiAlICggb3RwX3NlY3JldF9rZXlfZW5jb2RlZCwgbW92aW5nX2ZhY3RvciApCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld19vdHBfdXNlcl9leHRlcm5hbF91aWQgPSAiaG90cDolczslcyIgJSAoIG90cF9zZWNyZXRfa2V5X2VuY29kZWQsIHZhbGlkYXRpb25fcmVzdWx0WyJtb3ZpbmdGYWN0b3IiXSApCiAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBVcGRhdGUgbW92aW5nIGZhY3RvciBpbiB1c2VyIGVudHJ5CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmRfdXNlcl9ieV9leHRlcm5hbF91aWQgPSB1c2VyU2VydmljZS5yZXBsYWNlVXNlckF0dHJpYnV0ZSh1c2VyX25hbWUsICJveEV4dGVybmFsVWlkIiwgb3RwX3VzZXJfZXh0ZXJuYWxfdWlkLCBuZXdfb3RwX3VzZXJfZXh0ZXJuYWxfdWlkKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBmaW5kX3VzZXJfYnlfZXh0ZXJuYWxfdWlkICE9IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ICJPVFAuIFByb2Nlc3MgSE9UUCBhdXRoZW50aWNhdGlvbiBkdXJpbmcgYXV0aGVudGljYXRpb24uIEZhaWxlZCB0byB1cGRhdGUgdXNlciBlbnRyeSIKICAgICAgICAgICAgZWxpZiBzZWxmLm90cFR5cGUgPT0gInRvdHAiOgogICAgICAgICAgICAgICAgZm9yIHVzZXJfZW5yb2xsbWVudCBpbiB1c2VyX2Vucm9sbG1lbnRzOgogICAgICAgICAgICAgICAgICAgIG90cF9zZWNyZXRfa2V5ID0gc2VsZi5mcm9tQmFzZTY0VXJsKHVzZXJfZW5yb2xsbWVudCkKCiAgICAgICAgICAgICAgICAgICAgIyBWYWxpZGF0ZSBUT1RQCiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvbl9yZXN1bHQgPSBzZWxmLnZhbGlkYXRlVG90cEtleShvdHBfc2VjcmV0X2tleSwgb3RwQ29kZSwgdXNlcl9uYW1lKQogICAgICAgICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uX3Jlc3VsdCAhPSBOb25lKSBhbmQgdmFsaWRhdGlvbl9yZXN1bHRbInJlc3VsdCJdOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCAiT1RQLiBQcm9jZXNzIFRPVFAgYXV0aGVudGljYXRpb24gZHVyaW5nIGF1dGhlbnRpY2F0aW9uLiBvdHBDb2RlIGlzIHZhbGlkIgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICBmYWNlc01lc3NhZ2VzLmFkZChGYWNlc01lc3NhZ2UuU0VWRVJJVFlfRVJST1IsICJGYWlsZWQgdG8gYXV0aGVudGljYXRlLiBPVFAgY29kZSBpcyBpbnZhbGlkIikKICAgICAgICBwcmludCAiT1RQLiBQcm9jZXNzIE9UUCBhdXRoZW50aWNhdGlvbi4gT1RQIGNvZGUgaXMgaW52YWxpZCIKCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgIyBTaGFyZWQgSE9UUC9UT1RQIG1ldGhvZHMKICAgIGRlZiBnZW5lcmF0ZVNlY3JldEtleShzZWxmLCBrZXlMZW5ndGgpOgogICAgICAgIGJ5dGVzID0gamFycmF5Lnplcm9zKGtleUxlbmd0aCwgImIiKQogICAgICAgIHNlY3VyZVJhbmRvbSA9IFNlY3VyZVJhbmRvbSgpCiAgICAgICAgc2VjdXJlUmFuZG9tLm5leHRCeXRlcyhieXRlcykKICAgICAgICAKICAgICAgICByZXR1cm4gYnl0ZXMKICAgIAogICAgIyBIT1RQIG1ldGhvZHMKICAgIGRlZiBnZW5lcmF0ZVNlY3JldEhvdHBLZXkoc2VsZik6CiAgICAgICAga2V5TGVuZ3RoID0gc2VsZi5ob3RwQ29uZmlndXJhdGlvblsia2V5TGVuZ3RoIl0KICAgICAgICAKICAgICAgICByZXR1cm4gc2VsZi5nZW5lcmF0ZVNlY3JldEtleShrZXlMZW5ndGgpCgogICAgZGVmIGdlbmVyYXRlSG90cEtleShzZWxmLCBzZWNyZXRLZXksIG1vdmluZ0ZhY3Rvcik6CiAgICAgICAgZGlnaXRzID0gc2VsZi5ob3RwQ29uZmlndXJhdGlvblsiZGlnaXRzIl0KCiAgICAgICAgaG90cCA9IEhPVFAua2V5KHNlY3JldEtleSkuZGlnaXRzKGRpZ2l0cykubW92aW5nRmFjdG9yKG1vdmluZ0ZhY3RvcikuYnVpbGQoKQogICAgICAgIAogICAgICAgIHJldHVybiBob3RwLnZhbHVlKCkKCiAgICBkZWYgdmFsaWRhdGVIb3RwS2V5KHNlbGYsIHNlY3JldEtleSwgbW92aW5nRmFjdG9yLCB0b3RwS2V5KToKICAgICAgICBsb29rQWhlYWRXaW5kb3cgPSBzZWxmLmhvdHBDb25maWd1cmF0aW9uWyJsb29rQWhlYWRXaW5kb3ciXQogICAgICAgIGRpZ2l0cyA9IHNlbGYuaG90cENvbmZpZ3VyYXRpb25bImRpZ2l0cyJdCgogICAgICAgIGh0b3BWYWxpZGF0aW9uUmVzdWx0ID0gSE9UUFZhbGlkYXRvci5sb29rQWhlYWRXaW5kb3cobG9va0FoZWFkV2luZG93KS52YWxpZGF0ZShzZWNyZXRLZXksIG1vdmluZ0ZhY3RvciwgZGlnaXRzLCB0b3RwS2V5KQogICAgICAgIGlmIGh0b3BWYWxpZGF0aW9uUmVzdWx0LmlzVmFsaWQoKToKICAgICAgICAgICAgcmV0dXJuIHsgInJlc3VsdCI6IFRydWUsICJtb3ZpbmdGYWN0b3IiOiBodG9wVmFsaWRhdGlvblJlc3VsdC5nZXROZXdNb3ZpbmdGYWN0b3IoKSB9CgogICAgICAgIHJldHVybiB7ICJyZXN1bHQiOiBGYWxzZSwgIm1vdmluZ0ZhY3RvciI6IE5vbmUgfQoKICAgIGRlZiBnZW5lcmF0ZUhvdHBTZWNyZXRLZXlVcmkoc2VsZiwgc2VjcmV0S2V5LCBpc3N1ZXIsIHVzZXJEaXNwbGF5TmFtZSk6CiAgICAgICAgZGlnaXRzID0gc2VsZi5ob3RwQ29uZmlndXJhdGlvblsiZGlnaXRzIl0KCiAgICAgICAgc2VjcmV0S2V5QmFzZTMyID0gc2VsZi50b0Jhc2UzMihzZWNyZXRLZXkpCiAgICAgICAgb3RwS2V5ID0gT1RQS2V5KHNlY3JldEtleUJhc2UzMiwgT1RQVHlwZS5IT1RQKQogICAgICAgIGxhYmVsID0gaXNzdWVyICsgIiAlcyIgJSB1c2VyRGlzcGxheU5hbWUKCiAgICAgICAgb3RwQXV0aFVSSSA9IE9UUEF1dGhVUklCdWlsZGVyLmZyb21LZXkob3RwS2V5KS5sYWJlbChsYWJlbCkuaXNzdWVyKGlzc3VlcikuZGlnaXRzKGRpZ2l0cykuYnVpbGQoKQoKICAgICAgICByZXR1cm4gb3RwQXV0aFVSSS50b1VyaVN0cmluZygpCgogICAgIyBUT1RQIG1ldGhvZHMKICAgIGRlZiBnZW5lcmF0ZVNlY3JldFRvdHBLZXkoc2VsZik6CiAgICAgICAga2V5TGVuZ3RoID0gc2VsZi50b3RwQ29uZmlndXJhdGlvblsia2V5TGVuZ3RoIl0KICAgICAgICAKICAgICAgICByZXR1cm4gc2VsZi5nZW5lcmF0ZVNlY3JldEtleShrZXlMZW5ndGgpCgogICAgZGVmIGdlbmVyYXRlVG90cEtleShzZWxmLCBzZWNyZXRLZXkpOgogICAgICAgIGRpZ2l0cyA9IHNlbGYudG90cENvbmZpZ3VyYXRpb25bImRpZ2l0cyJdCiAgICAgICAgdGltZVN0ZXAgPSBzZWxmLnRvdHBDb25maWd1cmF0aW9uWyJ0aW1lU3RlcCJdCiAgICAgICAgaG1hY1NoYUFsZ29yaXRobVR5cGUgPSBzZWxmLnRvdHBDb25maWd1cmF0aW9uWyJobWFjU2hhQWxnb3JpdGhtVHlwZSJdCgogICAgICAgIHRvdHAgPSBUT1RQLmtleShzZWNyZXRLZXkpLmRpZ2l0cyhkaWdpdHMpLnRpbWVTdGVwKFRpbWVVbml0LlNFQ09ORFMudG9NaWxsaXModGltZVN0ZXApKS5obWFjU2hhKGhtYWNTaGFBbGdvcml0aG1UeXBlKS5idWlsZCgpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRvdHAudmFsdWUoKQoKICAgIGRlZiB2YWxpZGF0ZVRvdHBLZXkoc2VsZiwgc2VjcmV0S2V5LCB0b3RwS2V5LCB1c2VyX25hbWUpOgogICAgICAgIGxvY2FsVG90cEtleSA9IHNlbGYuZ2VuZXJhdGVUb3RwS2V5KHNlY3JldEtleSkKICAgICAgICBjYWNoZWRPVFAgPSBzZWxmLmdldENhY2hlZE9UUCh1c2VyX25hbWUpCgogICAgICAgIGlmIFN0cmluZ0hlbHBlci5lcXVhbHMobG9jYWxUb3RwS2V5LCB0b3RwS2V5KSBhbmQgbm90IFN0cmluZ0hlbHBlci5lcXVhbHMobG9jYWxUb3RwS2V5LCBjYWNoZWRPVFApOgogICAgICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkKICAgICAgICAgICAgaWYgY2FjaGVkT1RQIGlzIE5vbmU6CiAgICAgICAgICAgICAgICB1c2VyU2VydmljZS5hZGRVc2VyQXR0cmlidXRlKHVzZXJfbmFtZSwgIm94T1RQQ2FjaGUiLGxvY2FsVG90cEtleSkKICAgICAgICAgICAgZWxzZSA6CiAgICAgICAgICAgICAgICB1c2VyU2VydmljZS5yZXBsYWNlVXNlckF0dHJpYnV0ZSh1c2VyX25hbWUsICJveE9UUENhY2hlIiwgY2FjaGVkT1RQLCBsb2NhbFRvdHBLZXkpCiAgICAgICAgICAgIHByaW50ICJPVFAuIENhY2hpbmcgT1RQOiAnJXMnIiAlIGxvY2FsVG90cEtleQogICAgICAgICAgICByZXR1cm4geyAicmVzdWx0IjogVHJ1ZSB9CiAgICAgICAgcmV0dXJuIHsgInJlc3VsdCI6IEZhbHNlIH0KCQogICAgZGVmIGdldENhY2hlZE9UUChzZWxmLCB1c2VyX25hbWUpOgogICAgICAgIHVzZXJTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFVzZXJTZXJ2aWNlKQogICAgICAgIHVzZXIgPSB1c2VyU2VydmljZS5nZXRVc2VyKHVzZXJfbmFtZSwgIm94T1RQQ2FjaGUiKQogICAgICAgIGlmIHVzZXIgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQgIk9UUC4gR2V0IENhY2hlZCBPVFAuIEZhaWxlZCB0byBmaW5kIE9UUCIKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBjdXN0b21BdHRyaWJ1dGUgPSB1c2VyU2VydmljZS5nZXRDdXN0b21BdHRyaWJ1dGUodXNlciwgIm94T1RQQ2FjaGUiKQogICAgICAgIAogICAgICAgIGlmIGN1c3RvbUF0dHJpYnV0ZSBpcyBOb25lOgogICAgICAgICAgICBwcmludCAiT1RQLiBDdXN0b20gYXR0cmlidXRlIGlzIG51bGwiCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgdXNlcl9jYWNoZWRfT1RQID0gY3VzdG9tQXR0cmlidXRlLmdldFZhbHVlKCkKICAgICAgICBpZiB1c2VyX2NhY2hlZF9PVFAgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQgIk9UUC4gbm8gT1RQIGlzIHByZXNlbnQgaW4gTERBUCIKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAKICAgICAgICBwcmludCAiT1RQLkNhY2hlZCBPVFA6ICclcyciICUgdXNlcl9jYWNoZWRfT1RQCiAgICAgICAgcmV0dXJuIHVzZXJfY2FjaGVkX09UUAogICAgICAgIAogICAgZGVmIGdlbmVyYXRlVG90cFNlY3JldEtleVVyaShzZWxmLCBzZWNyZXRLZXksIGlzc3VlciwgdXNlckRpc3BsYXlOYW1lKToKICAgICAgICBkaWdpdHMgPSBzZWxmLnRvdHBDb25maWd1cmF0aW9uWyJkaWdpdHMiXQogICAgICAgIHRpbWVTdGVwID0gc2VsZi50b3RwQ29uZmlndXJhdGlvblsidGltZVN0ZXAiXQoKICAgICAgICBzZWNyZXRLZXlCYXNlMzIgPSBzZWxmLnRvQmFzZTMyKHNlY3JldEtleSkKICAgICAgICBvdHBLZXkgPSBPVFBLZXkoc2VjcmV0S2V5QmFzZTMyLCBPVFBUeXBlLlRPVFApCiAgICAgICAgbGFiZWwgPSBpc3N1ZXIgKyAiICVzIiAlIHVzZXJEaXNwbGF5TmFtZQoKICAgICAgICBvdHBBdXRoVVJJID0gT1RQQXV0aFVSSUJ1aWxkZXIuZnJvbUtleShvdHBLZXkpLmxhYmVsKGxhYmVsKS5pc3N1ZXIoaXNzdWVyKS5kaWdpdHMoZGlnaXRzKS50aW1lU3RlcChUaW1lVW5pdC5TRUNPTkRTLnRvTWlsbGlzKHRpbWVTdGVwKSkuYnVpbGQoKQoKICAgICAgICByZXR1cm4gb3RwQXV0aFVSSS50b1VyaVN0cmluZygpCgogICAgIyBVdGlsaXR5IG1ldGhvZHMKICAgIGRlZiB0b0Jhc2UzMihzZWxmLCBieXRlcyk6CiAgICAgICAgcmV0dXJuIEJhc2VFbmNvZGluZy5iYXNlMzIoKS5vbWl0UGFkZGluZygpLmVuY29kZShieXRlcykKCiAgICBkZWYgdG9CYXNlNjRVcmwoc2VsZiwgYnl0ZXMpOgogICAgICAgIHJldHVybiBCYXNlRW5jb2RpbmcuYmFzZTY0VXJsKCkuZW5jb2RlKGJ5dGVzKQoKICAgIGRlZiBmcm9tQmFzZTY0VXJsKHNlbGYsIGNoYXJzKToKICAgICAgICByZXR1cm4gQmFzZUVuY29kaW5nLmJhc2U2NFVybCgpLmRlY29kZShjaGFycykKCgo=
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=5018-F9CF,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: DUO authentication module
displayName: duo
oxEnabled: false
inum: 5018-F9CF
oxConfigurationProperty: {"value1":"duo_creds_file","value2":"/etc/certs/duo_creds.json","description":""}
oxConfigurationProperty: {"value1":"duo_host","value2":"api-random.duosecurity.com","description":""}
oxLevel: 50
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlLmNkaS51dGlsIGltcG9ydCBDZGlVdGlsCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlY3VyaXR5IGltcG9ydCBJZGVudGl0eQpmcm9tIG9yZy5nbHV1Lm1vZGVsLmN1c3RvbS5zY3JpcHQudHlwZS5hdXRoIGltcG9ydCBQZXJzb25BdXRoZW50aWNhdGlvblR5cGUKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZSBpbXBvcnQgQXV0aGVudGljYXRpb25TZXJ2aWNlCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuY29tbW9uIGltcG9ydCBVc2VyU2VydmljZQpmcm9tIG9yZy5nbHV1LnNlcnZpY2UgaW1wb3J0IE1haWxTZXJ2aWNlCmZyb20gb3JnLmdsdXUudXRpbCBpbXBvcnQgQXJyYXlIZWxwZXIKZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIKZnJvbSBqYXZhLnV0aWwgaW1wb3J0IEFycmF5cwoKaW1wb3J0IGR1b193ZWIKaW1wb3J0IGpzb24KCmNsYXNzIFBlcnNvbkF1dGhlbnRpY2F0aW9uKFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJEdW8uIEluaXRpYWxpemF0aW9uIgoKICAgICAgICBkdW9fY3JlZHNfZmlsZSA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiZHVvX2NyZWRzX2ZpbGUiKS5nZXRWYWx1ZTIoKQogICAgICAgICMgTG9hZCBjcmVkZW50aWFscyBmcm9tIGZpbGUKICAgICAgICBmID0gb3BlbihkdW9fY3JlZHNfZmlsZSwgJ3InKQogICAgICAgIHRyeToKICAgICAgICAgICAgY3JlZHMgPSBqc29uLmxvYWRzKGYucmVhZCgpKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIkR1by4gSW5pdGlhbGl6YXRpb24uIEZhaWxlZCB0byBsb2FkIGNyZWRzIGZyb20gZmlsZToiLCBkdW9fY3JlZHNfZmlsZQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBmLmNsb3NlKCkKCiAgICAgICAgc2VsZi5pa2V5ID0gc3RyKGNyZWRzWyJpa2V5Il0pCiAgICAgICAgc2VsZi5za2V5ID0gc3RyKGNyZWRzWyJza2V5Il0pCiAgICAgICAgc2VsZi5ha2V5ID0gc3RyKGNyZWRzWyJha2V5Il0pCgogICAgICAgIHNlbGYudXNlX2R1b19ncm91cCA9IEZhbHNlCiAgICAgICAgaWYgKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJkdW9fZ3JvdXAiKSk6CiAgICAgICAgICAgIHNlbGYuZHVvX2dyb3VwID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJkdW9fZ3JvdXAiKS5nZXRWYWx1ZTIoKQogICAgICAgICAgICBzZWxmLnVzZV9kdW9fZ3JvdXAgPSBUcnVlCiAgICAgICAgICAgIHByaW50ICJEdW8uIEluaXRpYWxpemF0aW9uLiBVc2luZyBEdW8gb25seSBpZiB1c2VyIGJlbG9uZyB0byBncm91cDoiLCBzZWxmLmR1b19ncm91cAoKICAgICAgICBzZWxmLnVzZV9hdWRpdF9ncm91cCA9IEZhbHNlCiAgICAgICAgaWYgKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJhdWRpdF9ncm91cCIpKToKICAgICAgICAgICAgc2VsZi5hdWRpdF9ncm91cCA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiYXVkaXRfZ3JvdXAiKS5nZXRWYWx1ZTIoKQoKICAgICAgICAgICAgaWYgKG5vdCBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5jb250YWluc0tleSgiYXVkaXRfZ3JvdXBfZW1haWwiKSk6CiAgICAgICAgICAgICAgICBwcmludCAiRHVvLiBJbml0aWFsaXphdGlvbi4gUHJvcGVydHkgYXVkaXRfZ3JvdXBfZW1haWwgaXMgbm90IHNwZWNpZmllZCIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgc2VsZi5hdWRpdF9lbWFpbCA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiYXVkaXRfZ3JvdXBfZW1haWwiKS5nZXRWYWx1ZTIoKQogICAgICAgICAgICBzZWxmLnVzZV9hdWRpdF9ncm91cCA9IFRydWUKCiAgICAgICAgICAgIHByaW50ICJEdW8uIEluaXRpYWxpemF0aW9uLiBVc2luZyBhdWRpdG8gZ3JvdXA6Iiwgc2VsZi5hdWRpdF9ncm91cAogICAgICAgICAgICAKICAgICAgICBpZiAoc2VsZi51c2VfZHVvX2dyb3VwIG9yIHNlbGYudXNlX2F1ZGl0X2dyb3VwKToKICAgICAgICAgICAgaWYgKG5vdCBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5jb250YWluc0tleSgiYXVkaXRfYXR0cmlidXRlIikpOgogICAgICAgICAgICAgICAgcHJpbnQgIkR1by4gSW5pdGlhbGl6YXRpb24uIFByb3BlcnR5IGF1ZGl0X2F0dHJpYnV0ZSBpcyBub3Qgc3BlY2lmaWVkIgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmF1ZGl0X2F0dHJpYnV0ZSA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiYXVkaXRfYXR0cmlidXRlIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgcHJpbnQgIkR1by4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIHJldHVybiBUcnVlICAgCgogICAgZGVmIGRlc3Ryb3koc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJEdW8uIERlc3Ryb3kiCiAgICAgICAgcHJpbnQgIkR1by4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQogICAgICAgIAogICAgZGVmIGdldEF1dGhlbnRpY2F0aW9uTWV0aG9kQ2xhaW1zKHNlbGYsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgZGVmIGlzVmFsaWRBdXRoZW50aWNhdGlvbk1ldGhvZChzZWxmLCB1c2FnZVR5cGUsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBbHRlcm5hdGl2ZUF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGF1dGhlbnRpY2F0ZShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIGR1b19ob3N0ID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJkdW9faG9zdCIpLmdldFZhbHVlMigpCgogICAgICAgIGF1dGhlbnRpY2F0aW9uU2VydmljZSA9IENkaVV0aWwuYmVhbihBdXRoZW50aWNhdGlvblNlcnZpY2UpCgogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQoKICAgICAgICBpZiAoc3RlcCA9PSAxKToKICAgICAgICAgICAgcHJpbnQgIkR1by4gQXV0aGVudGljYXRlIGZvciBzdGVwIDEiCgogICAgICAgICAgICAjIENoZWNrIGlmIHVzZXIgYXV0aGVudGljYXRlZCBhbHJlYWR5IGluIGFub3RoZXIgY3VzdG9tIHNjcmlwdAogICAgICAgICAgICB1c2VyID0gYXV0aGVudGljYXRpb25TZXJ2aWNlLmdldEF1dGhlbnRpY2F0ZWRVc2VyKCkKICAgICAgICAgICAgaWYgdXNlciA9PSBOb25lOgogICAgICAgICAgICAgICAgY3JlZGVudGlhbHMgPSBpZGVudGl0eS5nZXRDcmVkZW50aWFscygpCiAgICAgICAgICAgICAgICB1c2VyX25hbWUgPSBjcmVkZW50aWFscy5nZXRVc2VybmFtZSgpCiAgICAgICAgICAgICAgICB1c2VyX3Bhc3N3b3JkID0gY3JlZGVudGlhbHMuZ2V0UGFzc3dvcmQoKQogICAgCiAgICAgICAgICAgICAgICBsb2dnZWRfaW4gPSBGYWxzZQogICAgICAgICAgICAgICAgaWYgKFN0cmluZ0hlbHBlci5pc05vdEVtcHR5U3RyaW5nKHVzZXJfbmFtZSkgYW5kIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5U3RyaW5nKHVzZXJfcGFzc3dvcmQpKToKICAgICAgICAgICAgICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkKICAgICAgICAgICAgICAgICAgICBsb2dnZWRfaW4gPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJfbmFtZSwgdXNlcl9wYXNzd29yZCkKICAgIAogICAgICAgICAgICAgICAgaWYgKG5vdCBsb2dnZWRfaW4pOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICAgICAgICAgICAgICB1c2VyID0gYXV0aGVudGljYXRpb25TZXJ2aWNlLmdldEF1dGhlbnRpY2F0ZWRVc2VyKCkKCiAgICAgICAgICAgIGlmIChzZWxmLnVzZV9kdW9fZ3JvdXApOgogICAgICAgICAgICAgICAgcHJpbnQgIkR1by4gQXV0aGVudGljYXRlIGZvciBzdGVwIDEuIENoZWNraW5nIGlmIHVzZXIgYmVsb25nIHRvIER1byBncm91cCIKICAgICAgICAgICAgICAgIGlzX21lbWJlcl9kdW9fZ3JvdXAgPSBzZWxmLmlzVXNlck1lbWJlck9mR3JvdXAodXNlciwgc2VsZi5hdWRpdF9hdHRyaWJ1dGUsIHNlbGYuZHVvX2dyb3VwKQogICAgICAgICAgICAgICAgaWYgKGlzX21lbWJlcl9kdW9fZ3JvdXApOgogICAgICAgICAgICAgICAgICAgIHByaW50ICJEdW8uIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiBVc2VyICciICsgdXNlci5nZXRVc2VySWQoKSArICInIG1lbWJlciBvZiBEdW8gZ3JvdXAiCiAgICAgICAgICAgICAgICAgICAgZHVvX2NvdW50X2xvZ2luX3N0ZXBzID0gMgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLnByb2Nlc3NBdWRpdEdyb3VwKHVzZXIpCiAgICAgICAgICAgICAgICAgICAgZHVvX2NvdW50X2xvZ2luX3N0ZXBzID0gMQoKICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImR1b19jb3VudF9sb2dpbl9zdGVwcyIsIGR1b19jb3VudF9sb2dpbl9zdGVwcykKCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxpZiAoc3RlcCA9PSAyKToKICAgICAgICAgICAgcHJpbnQgIkR1by4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIiCiAgICAgICAgICAgIHVzZXIgPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuZ2V0QXV0aGVudGljYXRlZFVzZXIoKQogICAgICAgICAgICBpZiB1c2VyID09IE5vbmU6CiAgICAgICAgICAgICAgICBwcmludCAiRHVvLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gRmFpbGVkIHRvIGRldGVybWluZSB1c2VyIG5hbWUiCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIHVzZXJfbmFtZSA9IHVzZXIuZ2V0VXNlcklkKCkKCiAgICAgICAgICAgIHNpZ19yZXNwb25zZV9hcnJheSA9IHJlcXVlc3RQYXJhbWV0ZXJzLmdldCgic2lnX3Jlc3BvbnNlIikKICAgICAgICAgICAgaWYgQXJyYXlIZWxwZXIuaXNFbXB0eShzaWdfcmVzcG9uc2VfYXJyYXkpOgogICAgICAgICAgICAgICAgcHJpbnQgIkR1by4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIuIHNpZ19yZXNwb25zZSBpcyBlbXB0eSIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgZHVvX3NpZ19yZXNwb25zZSA9IHNpZ19yZXNwb25zZV9hcnJheVswXQoKICAgICAgICAgICAgcHJpbnQgIkR1by4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIuIGR1b19zaWdfcmVzcG9uc2U6ICIgKyBkdW9fc2lnX3Jlc3BvbnNlCgogICAgICAgICAgICBhdXRoZW50aWNhdGVkX3VzZXJuYW1lID0gZHVvX3dlYi52ZXJpZnlfcmVzcG9uc2Uoc2VsZi5pa2V5LCBzZWxmLnNrZXksIHNlbGYuYWtleSwgZHVvX3NpZ19yZXNwb25zZSkKCiAgICAgICAgICAgIHByaW50ICJEdW8uIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBhdXRoZW50aWNhdGVkX3VzZXJuYW1lOiAiICsgYXV0aGVudGljYXRlZF91c2VybmFtZSArICIsIGV4cGVjdGVkIHVzZXJfbmFtZTogIiArIHVzZXJfbmFtZQoKICAgICAgICAgICAgaWYgKG5vdCBTdHJpbmdIZWxwZXIuZXF1YWxzKHVzZXJfbmFtZSwgYXV0aGVudGljYXRlZF91c2VybmFtZSkpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBzZWxmLnByb2Nlc3NBdWRpdEdyb3VwKHVzZXIpCgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBwcmVwYXJlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQogICAgICAgIGF1dGhlbnRpY2F0aW9uU2VydmljZSA9IENkaVV0aWwuYmVhbihBdXRoZW50aWNhdGlvblNlcnZpY2UpCgogICAgICAgIGR1b19ob3N0ID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJkdW9faG9zdCIpLmdldFZhbHVlMigpCgogICAgICAgIGlmIChzdGVwID09IDEpOgogICAgICAgICAgICBwcmludCAiRHVvLiBQcmVwYXJlIGZvciBzdGVwIDEiCgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsaWYgKHN0ZXAgPT0gMik6CiAgICAgICAgICAgIHByaW50ICJEdW8uIFByZXBhcmUgZm9yIHN0ZXAgMiIKCiAgICAgICAgICAgIHVzZXIgPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuZ2V0QXV0aGVudGljYXRlZFVzZXIoKQogICAgICAgICAgICBpZiAodXNlciA9PSBOb25lKToKICAgICAgICAgICAgICAgIHByaW50ICJEdW8uIFByZXBhcmUgZm9yIHN0ZXAgMi4gRmFpbGVkIHRvIGRldGVybWluZSB1c2VyIG5hbWUiCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgdXNlcl9uYW1lID0gdXNlci5nZXRVc2VySWQoKQoKICAgICAgICAgICAgZHVvX3NpZ19yZXF1ZXN0ID0gZHVvX3dlYi5zaWduX3JlcXVlc3Qoc2VsZi5pa2V5LCBzZWxmLnNrZXksIHNlbGYuYWtleSwgdXNlcl9uYW1lKQogICAgICAgICAgICBwcmludCAiRHVvLiBQcmVwYXJlIGZvciBzdGVwIDIuIGR1b19zaWdfcmVxdWVzdDogIiArIGR1b19zaWdfcmVxdWVzdAogICAgICAgICAgICAKICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigiZHVvX2hvc3QiLCBkdW9faG9zdCkKICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigiZHVvX3NpZ19yZXF1ZXN0IiwgZHVvX3NpZ19yZXF1ZXN0KQoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgZ2V0RXh0cmFQYXJhbWV0ZXJzRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgc3RlcCk6CiAgICAgICAgaWYgc3RlcCA9PSAyOgogICAgICAgICAgICByZXR1cm4gQXJyYXlzLmFzTGlzdCgiZHVvX2NvdW50X2xvZ2luX3N0ZXBzIiwgImNhczJfdXNlcl91aWQiKQoKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBnZXRDb3VudEF1dGhlbnRpY2F0aW9uU3RlcHMoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQogICAgICAgIGlmIChpZGVudGl0eS5pc1NldFdvcmtpbmdQYXJhbWV0ZXIoImR1b19jb3VudF9sb2dpbl9zdGVwcyIpKToKICAgICAgICAgICAgcmV0dXJuIGludChpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKCJkdW9fY291bnRfbG9naW5fc3RlcHMiKSkKCiAgICAgICAgcmV0dXJuIDIKCiAgICBkZWYgZ2V0UGFnZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIGlmIChzdGVwID09IDIpOgogICAgICAgICAgICByZXR1cm4gIi9hdXRoL2R1by9kdW9sb2dpbi54aHRtbCIKICAgICAgICByZXR1cm4gIiIKCiAgICBkZWYgZ2V0TmV4dFN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKICAgICAgICByZXR1cm4gLTEKCiAgICBkZWYgZ2V0TG9nb3V0RXh0ZXJuYWxVcmwoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICBwcmludCAiR2V0IGV4dGVybmFsIGxvZ291dCBVUkwgY2FsbCIKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBsb2dvdXQoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBpc1VzZXJNZW1iZXJPZkdyb3VwKHNlbGYsIHVzZXIsIGF0dHJpYnV0ZSwgZ3JvdXApOgogICAgICAgIGlzX21lbWJlciA9IEZhbHNlCiAgICAgICAgbWVtYmVyX29mX2xpc3QgPSB1c2VyLmdldEF0dHJpYnV0ZVZhbHVlcyhhdHRyaWJ1dGUpCiAgICAgICAgaWYgKG1lbWJlcl9vZl9saXN0ICE9IE5vbmUpOgogICAgICAgICAgICBmb3IgbWVtYmVyX29mIGluIG1lbWJlcl9vZl9saXN0OgogICAgICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmVxdWFsc0lnbm9yZUNhc2UoZ3JvdXAsIG1lbWJlcl9vZikgb3IgbWVtYmVyX29mLmVuZHN3aXRoKGdyb3VwKToKICAgICAgICAgICAgICAgICAgICBpc19tZW1iZXIgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgcmV0dXJuIGlzX21lbWJlcgoKICAgIGRlZiBwcm9jZXNzQXVkaXRHcm91cChzZWxmLCB1c2VyKToKICAgICAgICBpZiAoc2VsZi51c2VfYXVkaXRfZ3JvdXApOgogICAgICAgICAgICBpc19tZW1iZXIgPSBzZWxmLmlzVXNlck1lbWJlck9mR3JvdXAodXNlciwgc2VsZi5hdWRpdF9hdHRyaWJ1dGUsIHNlbGYuYXVkaXRfZ3JvdXApCiAgICAgICAgICAgIGlmIChpc19tZW1iZXIpOgogICAgICAgICAgICAgICAgcHJpbnQgIkR1by4gQXV0aGVudGljYXRlIGZvciBwcm9jZXNzQXVkaXRHcm91cC4gVXNlciAnIiArIHVzZXIuZ2V0VXNlcklkKCkgKyAiJyBtZW1iZXIgb2YgYXVkaXQgZ3JvdXAiCiAgICAgICAgICAgICAgICBwcmludCAiRHVvLiBBdXRoZW50aWNhdGUgZm9yIHByb2Nlc3NBdWRpdEdyb3VwLiBTZW5kaW5nIGUtbWFpbCBhYm91dCB1c2VyICciICsgdXNlci5nZXRVc2VySWQoKSArICInIGxvZ2luIHRvIiwgc2VsZi5hdWRpdF9lbWFpbAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFNlbmQgZS1tYWlsIHRvIGFkbWluaXN0cmF0b3IKICAgICAgICAgICAgICAgIHVzZXJfaWQgPSB1c2VyLmdldFVzZXJJZCgpCiAgICAgICAgICAgICAgICBtYWlsU2VydmljZSA9IENkaVV0aWwuYmVhbihNYWlsU2VydmljZSkKICAgICAgICAgICAgICAgIHN1YmplY3QgPSAiVXNlciBsb2cgaW46ICIgKyB1c2VyX2lkCiAgICAgICAgICAgICAgICBib2R5ID0gIlVzZXIgbG9nIGluOiAiICsgdXNlcl9pZAogICAgICAgICAgICAgICAgbWFpbFNlcnZpY2Uuc2VuZE1haWwoc2VsZi5hdWRpdF9lbWFpbCwgc3ViamVjdCwgYm9keSkK
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=522F-CDC5,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample Update User script
displayName: update_user
oxEnabled: false
inum: 522F-CDC5
oxLevel: 100
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUudXNlciBpbXBvcnQgVXBkYXRlVXNlclR5cGUKZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIsIEFycmF5SGVscGVyCmZyb20gamF2YS51dGlsIGltcG9ydCBBcnJheXMsIEFycmF5TGlzdAoKaW1wb3J0IGphdmEKCmNsYXNzIFVwZGF0ZVVzZXIoVXBkYXRlVXNlclR5cGUpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGN1cnJlbnRUaW1lTWlsbGlzKToKICAgICAgICBzZWxmLmN1cnJlbnRUaW1lTWlsbGlzID0gY3VycmVudFRpbWVNaWxsaXMKCiAgICBkZWYgaW5pdChzZWxmLCBjdXN0b21TY3JpcHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiVXBkYXRlIHVzZXIuIEluaXRpYWxpemF0aW9uIgogICAgICAgIHByaW50ICJVcGRhdGUgdXNlci4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgoKICAgICAgICByZXR1cm4gVHJ1ZSAgIAoKICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiVXBkYXRlIHVzZXIuIERlc3Ryb3kiCiAgICAgICAgcHJpbnQgIlVwZGF0ZSB1c2VyLiBEZXN0cm95ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIHJldHVybiBUcnVlICAgCgogICAgZGVmIGdldEFwaVZlcnNpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIDExCgogICAgZGVmIG5ld1VzZXIoc2VsZiwgdXNlciwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJVcGRhdGUgdXNlci4gbmV3VXNlciBtZXRob2QiCgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGFkZFVzZXIoc2VsZiwgdXNlciwgcGVyc2lzdGVkLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIlVwZGF0ZSB1c2VyLiBhZGRVc2VyIG1ldGhvZCIKCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgcG9zdEFkZFVzZXIoc2VsZiwgdXNlciwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJVcGRhdGUgdXNlci4gcG9zdEFkZFVzZXIgbWV0aG9kIgoKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICMgVXBkYXRlIHVzZXIgZW50cnkgYmVmb3JlIHBlcnNpc3RlbnQgaXQKICAgICMgICB1c2VyIGlzIG9yZy5nbHV1Lm94dHJ1c3QubW9kZWwuR2x1dUN1c3RvbVBlcnNvbgogICAgIyAgIHBlcnNpc3RlZCBpcyBib29sZWFuIHZhbHVlIHRvIHNwZWNpZnkgaWYgb3BlcmF0aW9uIHR5cGU6IGFkZC9tb2RpZnkKICAgICMgICBjb25maWd1cmF0aW9uQXR0cmlidXRlcyBpcyBqYXZhLnV0aWwuTWFwPFN0cmluZywgU2ltcGxlQ3VzdG9tUHJvcGVydHk+CiAgICBkZWYgdXBkYXRlVXNlcihzZWxmLCB1c2VyLCBwZXJzaXN0ZWQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiVXBkYXRlIHVzZXIuIHVwZGF0ZVVzZXIgbWV0aG9kIgoKICAgICAgICB1aWQgPSB1c2VyLmdldFVpZCgpCiAgICAgICAgcHJpbnQgIlVwZGF0ZSB1c2VyLiBVc2VyIHVpZDoge30iLmZvcm1hdCh1aWQpCiAgICAgICAKICAgICAgICBtYWlsID0gdWlkICsgIkBleGFtcGxlLm9yZyIKICAgICAgICB1c2VyLnNldE1haWwobWFpbCkKCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgcG9zdFVwZGF0ZVVzZXIoc2VsZiwgdXNlciwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJVcGRhdGUgdXNlci4gcG9zdFVwZGF0ZVVzZXIgbWV0aG9kIgoKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZWxldGVVc2VyKHNlbGYsIHVzZXIsIHBlcnNpc3RlZCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJVcGRhdGUgdXNlci4gZGVsZXRlVXNlciBtZXRob2QiCgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIHBvc3REZWxldGVVc2VyKHNlbGYsIHVzZXIsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiVXBkYXRlIHVzZXIuIHBvc3REZWxldGVVc2VyIG1ldGhvZCIKCiAgICAgICAgcmV0dXJuIFRydWUK
oxScriptType: update_user
programmingLanguage: python

dn: inum=6EA0-8F0C,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample User Registration script
displayName: user_registration
oxEnabled: false
inum: 6EA0-8F0C
oxConfigurationProperty: {"value1":"enable_user","value2":"false","description":""}
oxLevel: 90
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuDQojIENvcHlyaWdodCAoYykgMjAxNiwgR2x1dQ0KIw0KIyBBdXRob3I6IFl1cml5IE1vdmNoYW4NCiMNCg0KZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUudXNlciBpbXBvcnQgVXNlclJlZ2lzdHJhdGlvblR5cGUNCmZyb20gb3JnLmdsdXUudXRpbCBpbXBvcnQgU3RyaW5nSGVscGVyLCBBcnJheUhlbHBlcg0KZnJvbSBqYXZhLnV0aWwgaW1wb3J0IEFycmF5cywgQXJyYXlMaXN0DQoNCmltcG9ydCBqYXZhDQoNCmNsYXNzIFVzZXJSZWdpc3RyYXRpb24oVXNlclJlZ2lzdHJhdGlvblR5cGUpOg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6DQogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcw0KDQogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6DQogICAgICAgIHByaW50ICJVc2VyIHJlZ2lzdHJhdGlvbi4gSW5pdGlhbGl6YXRpb24iDQoNCiAgICAgICAgc2VsZi5lbmFibGVfdXNlciA9IFN0cmluZ0hlbHBlci50b0Jvb2xlYW4oY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJlbmFibGVfdXNlciIpLmdldFZhbHVlMigpLCBGYWxzZSkNCg0KICAgICAgICBwcmludCAiVXNlciByZWdpc3RyYXRpb24uIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseSINCg0KICAgICAgICByZXR1cm4gVHJ1ZSAgIA0KDQogICAgZGVmIGRlc3Ryb3koc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICBwcmludCAiVXNlciByZWdpc3RyYXRpb24uIERlc3Ryb3kiDQogICAgICAgIHByaW50ICJVc2VyIHJlZ2lzdHJhdGlvbi4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSINCiAgICAgICAgcmV0dXJuIFRydWUgICANCg0KICAgICMgVXNlciByZWdpc3RyYXRpb24gaW5pdCBtZXRob2QNCiAgICAjICAgdXNlciBpcyBvcmcuZ2x1dS5veHRydXN0Lm1vZGVsLkdsdXVDdXN0b21QZXJzb24NCiAgICAjICAgcmVxdWVzdFBhcmFtZXRlcnMgaXMgamF2YS51dGlsLk1hcDxTdHJpbmcsIFN0cmluZ1tdPg0KICAgICMgICBjb25maWd1cmF0aW9uQXR0cmlidXRlcyBpcyBqYXZhLnV0aWwuTWFwPFN0cmluZywgU2ltcGxlQ3VzdG9tUHJvcGVydHk+DQogICAgZGVmIGluaXRSZWdpc3RyYXRpb24oc2VsZiwgdXNlciwgcmVxdWVzdFBhcmFtZXRlcnMsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcHJpbnQgIlVzZXIgcmVnaXN0cmF0aW9uLiBJbml0IG1ldGhvZCINCg0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgIyBVc2VyIHJlZ2lzdHJhdGlvbiBwcmUgbWV0aG9kDQogICAgIyAgIHVzZXIgaXMgb3JnLmdsdXUub3h0cnVzdC5tb2RlbC5HbHV1Q3VzdG9tUGVyc29uDQogICAgIyAgIHJlcXVlc3RQYXJhbWV0ZXJzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTdHJpbmdbXT4NCiAgICAjICAgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMgaXMgamF2YS51dGlsLk1hcDxTdHJpbmcsIFNpbXBsZUN1c3RvbVByb3BlcnR5Pg0KICAgIGRlZiBwcmVSZWdpc3RyYXRpb24oc2VsZiwgdXNlciwgcmVxdWVzdFBhcmFtZXRlcnMsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcHJpbnQgIlVzZXIgcmVnaXN0cmF0aW9uLiBQcmUgbWV0aG9kIg0KDQogICAgICAgIHVzZXJTdGF0dXMgPSAiYWN0aXZlIg0KICAgICAgICBpZiBub3Qgc2VsZi5lbmFibGVfdXNlcjoNCiAgICAgICAgICAgIHVzZXJTdGF0dXMgPSAiaW5hY3RpdmUiDQoNCiAgICAgICAgIyBEaXNhYmxlL0VuYWJsZSByZWdpc3RlcmVkIHVzZXINCiAgICAgICAgdXNlci5zZXRTdGF0dXModXNlclN0YXR1cykNCg0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgIyBVc2VyIHJlZ2lzdHJhdGlvbiBwb3N0IG1ldGhvZA0KICAgICMgICB1c2VyIGlzIG9yZy5nbHV1Lm94dHJ1c3QubW9kZWwuR2x1dUN1c3RvbVBlcnNvbg0KICAgICMgICByZXF1ZXN0UGFyYW1ldGVycyBpcyBqYXZhLnV0aWwuTWFwPFN0cmluZywgU3RyaW5nW10+DQogICAgIyAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eT4NCiAgICBkZWYgcG9zdFJlZ2lzdHJhdGlvbihzZWxmLCB1c2VyLCByZXF1ZXN0UGFyYW1ldGVycywgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICBwcmludCAiVXNlciByZWdpc3RyYXRpb24uIFBvc3QgbWV0aG9kIg0KDQogICAgICAgIHJldHVybiBUcnVlDQogICAgDQogICAgIyBVc2VyIGNvbmZpcm0gTmV3IFJlZ2lzdHJhdGlvbiBtZXRob2QNCiAgICAjICAgdXNlciBpcyBvcmcuZ2x1dS5veHRydXN0Lm1vZGVsLkdsdXVDdXN0b21QZXJzb24NCiAgICAjICAgcmVxdWVzdFBhcmFtZXRlcnMgaXMgamF2YS51dGlsLk1hcDxTdHJpbmcsIFN0cmluZ1tdPg0KICAgICMgICBjb25maWd1cmF0aW9uQXR0cmlidXRlcyBpcyBqYXZhLnV0aWwuTWFwPFN0cmluZywgU2ltcGxlQ3VzdG9tUHJvcGVydHk+DQogICAgZGVmIGNvbmZpcm1SZWdpc3RyYXRpb24oc2VsZiwgdXNlciwgcmVxdWVzdFBhcmFtZXRlcnMsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcHJpbnQgIlVzZXIgcmVnaXN0cmF0aW9uLiBDb25maXJtIHJlZ2lzdHJhdGlvbiBtZXRob2QiDQoNCiAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOg0KICAgICAgICByZXR1cm4gMTENCg==
oxScriptType: user_registration
programmingLanguage: python

dn: inum=6EA0-8F0D,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample Confirm User Registration  script
displayName: user_confirm_registration
oxEnabled: false
inum: 6EA0-8F0D
oxLevel: 100
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuDQojIENvcHlyaWdodCAoYykgMjAxNiwgR2x1dQ0KIw0KDQpmcm9tIG9yZy5nbHV1LnNlcnZpY2UuY2RpLnV0aWwgaW1wb3J0IENkaVV0aWwNCmZyb20gb3JnLmdsdXUubW9kZWwuY3VzdG9tLnNjcmlwdC50eXBlLnVzZXIgaW1wb3J0IFVzZXJSZWdpc3RyYXRpb25UeXBlDQpmcm9tIG9yZy5nbHV1LnNlcnZpY2UgaW1wb3J0IE1haWxTZXJ2aWNlDQpmcm9tIG9yZy5nbHV1Lm94dHJ1c3Quc2VydmljZSBpbXBvcnQgUGVyc29uU2VydmljZQ0KZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIsIEFycmF5SGVscGVyDQpmcm9tIGphdmEudXRpbCBpbXBvcnQgQXJyYXlzLCBBcnJheUxpc3QNCmZyb20gb3JnLmdsdXUuY29uZmlnLm94dHJ1c3QgaW1wb3J0IEFwcENvbmZpZ3VyYXRpb24NCmZyb20gamF2YXguZmFjZXMuY29udGV4dCBpbXBvcnQgRXh0ZXJuYWxDb250ZXh0DQpmcm9tIG9yZy5nbHV1Lm94dHJ1c3Quc2VydmljZSBpbXBvcnQgQ29uZmlndXJhdGlvblNlcnZpY2UNCg0KaW1wb3J0IGphdmENCg0KY2xhc3MgVXNlclJlZ2lzdHJhdGlvbihVc2VyUmVnaXN0cmF0aW9uVHlwZSk6DQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGN1cnJlbnRUaW1lTWlsbGlzKToNCiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzDQoNCiAgICBkZWYgaW5pdChzZWxmLCBjdXN0b21TY3JpcHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcHJpbnQgIlVzZXIgQ29uZmlybSByZWdpc3RyYXRpb24uIEluaXRpYWxpemF0aW9uIg0KICAgICAgICBwcmludCAiVXNlciBDb25maXJtIHJlZ2lzdHJhdGlvbi4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5Ig0KDQogICAgICAgIHJldHVybiBUcnVlICAgDQoNCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6DQogICAgICAgIHByaW50ICJVc2VyIENvbmZpcm0gcmVnaXN0cmF0aW9uLiBEZXN0cm95Ig0KICAgICAgICBwcmludCAiVXNlciBDb25maXJtIHJlZ2lzdHJhdGlvbi4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSINCiAgICAgICAgcmV0dXJuIFRydWUgICANCg0KICAgICMgVXNlciByZWdpc3RyYXRpb24gaW5pdCBtZXRob2QNCiAgICAjICAgdXNlciBpcyBvcmcuZ2x1dS5veHRydXN0Lm1vZGVsLkdsdXVDdXN0b21QZXJzb24NCiAgICAjICAgcmVxdWVzdFBhcmFtZXRlcnMgaXMgamF2YS51dGlsLk1hcDxTdHJpbmcsIFN0cmluZ1tdPg0KICAgICMgICBjb25maWd1cmF0aW9uQXR0cmlidXRlcyBpcyBqYXZhLnV0aWwuTWFwPFN0cmluZywgU2ltcGxlQ3VzdG9tUHJvcGVydHk+DQogICAgZGVmIGluaXRSZWdpc3RyYXRpb24oc2VsZiwgdXNlciwgcmVxdWVzdFBhcmFtZXRlcnMsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcHJpbnQgIlVzZXIgQ29uZmlybSByZWdpc3RyYXRpb24uIEluaXQgbWV0aG9kIg0KICAgICAgICAjaG9zdE5hbWUgPSByZXF1ZXN0UGFyYW1ldGVycy5nZXQoImhvc3ROYW1lIilbMF0NCiAgICAgICAgI3ByaW50ICJIb3N0TmFtZSBJbml0aWFsaXphdGlvbiA6ICVzIiAlIGhvc3ROYW1lDQogICAgICAgIHJldHVybiBUcnVlDQoNCiAgICAjIFVzZXIgcmVnaXN0cmF0aW9uIHByZSBtZXRob2QNCiAgICAjICAgdXNlciBpcyBvcmcuZ2x1dS5veHRydXN0Lm1vZGVsLkdsdXVDdXN0b21QZXJzb24NCiAgICAjICAgcmVxdWVzdFBhcmFtZXRlcnMgaXMgamF2YS51dGlsLk1hcDxTdHJpbmcsIFN0cmluZ1tdPg0KICAgICMgICBjb25maWd1cmF0aW9uQXR0cmlidXRlcyBpcyBqYXZhLnV0aWwuTWFwPFN0cmluZywgU2ltcGxlQ3VzdG9tUHJvcGVydHk+DQogICAgZGVmIHByZVJlZ2lzdHJhdGlvbihzZWxmLCB1c2VyLCByZXF1ZXN0UGFyYW1ldGVycywgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICBwcmludCAiVXNlciBDb25maXJtIHJlZ2lzdHJhdGlvbi4gUHJlIG1ldGhvZCINCiAgICAgICAgdXNlclN0YXR1cyA9ICJpbmFjdGl2ZSINCg0KICAgICAgICAjIERpc2FibGUvRW5hYmxlIHJlZ2lzdGVyZWQgdXNlcg0KICAgICAgICB1c2VyLnNldFN0YXR1cyh1c2VyU3RhdHVzKQ0KICAgICAgICBzZWxmLmd1aWQgPSBTdHJpbmdIZWxwZXIuZ2V0UmFuZG9tU3RyaW5nKDE2KQ0KICAgICAgICB1c2VyLnNldEd1aWQoc2VsZi5ndWlkKQ0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgIyBVc2VyIHJlZ2lzdHJhdGlvbiBwb3N0IG1ldGhvZA0KICAgICMgICB1c2VyIGlzIG9yZy5nbHV1Lm94dHJ1c3QubW9kZWwuR2x1dUN1c3RvbVBlcnNvbg0KICAgICMgICByZXF1ZXN0UGFyYW1ldGVycyBpcyBqYXZhLnV0aWwuTWFwPFN0cmluZywgU3RyaW5nW10+DQogICAgIyAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eT4NCiAgICBkZWYgcG9zdFJlZ2lzdHJhdGlvbihzZWxmLCB1c2VyLCByZXF1ZXN0UGFyYW1ldGVycywgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICBwcmludCAiVXNlciBDb25maXJtIHJlZ2lzdHJhdGlvbi4gUG9zdCBtZXRob2QiDQogICAgICAgIGV4dGVybmFsQ29udGV4dCA9IENkaVV0aWwuYmVhbihFeHRlcm5hbENvbnRleHQpDQogICAgICAgIGNvbnRleHRQYXRoID0gZXh0ZXJuYWxDb250ZXh0LmdldFJlcXVlc3QoKS5nZXRDb250ZXh0UGF0aCgpDQogICAgICAgIGhvc3ROYW1lID0gIGV4dGVybmFsQ29udGV4dC5nZXRSZXF1ZXN0U2VydmVyTmFtZSgpDQogICAgICAgIHByaW50ICJIb3N0TmFtZSBmcm9tIGNvbnRleHQgOiAlcyIgJSBob3N0TmFtZQ0KICAgICAgICBtYWlsU2VydmljZSA9IENkaVV0aWwuYmVhbihNYWlsU2VydmljZSkNCiAgICAgICAgc3ViamVjdCA9ICJSZWdpc3RyYXRpb24gY29uZmlybWF0aW9uIg0KICAgICAgICBhY3RpdmF0aW9uTGluayA9ICJodHRwczovLyVzJXMvY29uZmlybS9yZWdpc3RyYXRpb24uaHRtP2NvZGU9JXMiICUoaG9zdE5hbWUsIGNvbnRleHRQYXRoLCBzZWxmLmd1aWQpDQogICAgICAgIGJvZHkgPSAiPGgyIHN0eWxlPSdtYXJnaW4tbGVmdDoxMCUlO2NvbG9yOiAjMzM3YWI3Oyc+V2VsY29tZTwvaDI+PGhyIHN0eWxlPSd3aWR0aDo4MCUlO2JvcmRlcjogMXB4IHNvbGlkICMzMzdhYjc7Jz48L2hyPjxkaXYgc3R5bGU9J3RleHQtYWxpZ246Y2VudGVyOyc+PHA+RGVhciA8c3BhbiBzdHlsZT0nY29sb3I6ICMzMzdhYjc7Jz4lczwvc3Bhbj4sPC9wPjxwPllvdXIgQWNjb3VudCBoYXMgYmVlbiBjcmVhdGVkLCB3ZWxjb21lIHRvIDxzcGFuIHN0eWxlPSdjb2xvcjogIzMzN2FiNzsnPiVzPC9zcGFuPi48L3A+PHA+WW91IGFyZSBqdXN0IG9uZSBzdGVwIHdheSBmcm9tIGFjdGl2YXRpbmcgeW91ciBhY2NvdW50IG9uIDxzcGFuIHN0eWxlPSdjb2xvcjogIzMzN2FiNzsnPiVzPC9zcGFuPi48L3A+PHA+Q2xpY2sgdGhlIGJ1dHRvbiBhbmQgc3RhcnQgdXNpbmcgeW91ciBhY2NvdW50LjwvcD48L2Rpdj48YSBjbGFzcz0nYnRuJyBocmVmPSclcyc+PGJ1dHRvbiBzdHlsZT0nYmFja2dyb3VuZDogIzMzN2FiNzsgY29sb3I6IHdoaXRlOyBtYXJnaW4tbGVmdDogMzAlJTsgYm9yZGVyLXJhZGl1czogNXB4OyBib3JkZXI6IDBweDsgcGFkZGluZzogNXB4OycgdHlwZT0nYnV0dG9uJz5BY3RpdmF0ZSB5b3VyIGFjY291bnQgbm93ITwvYnV0dG9uPjwvYT4iICAlICh1c2VyLmdldFVpZCgpLCBob3N0TmFtZSwgaG9zdE5hbWUsIGFjdGl2YXRpb25MaW5rKQ0KICAgICAgICBwcmludCAiVXNlciBDb25maXJtIHJlZ2lzdHJhdGlvbi4gUG9zdCBtZXRob2QuIEF0dGVtcHRpbmcgdG8gc2VuZCBlLW1haWwgdG8gJyVzJyBtZXNzYWdlICclcyciICUgKHVzZXIuZ2V0TWFpbCgpLCBib2R5KQ0KICAgICAgICBtYWlsU2VydmljZS5zZW5kTWFpbCh1c2VyLmdldE1haWwoKSwgTm9uZSwgc3ViamVjdCwgYm9keSwgYm9keSk7DQogICAgICAgIHJldHVybiBUcnVlDQoNCiAgICBkZWYgY29uZmlybVJlZ2lzdHJhdGlvbihzZWxmLCB1c2VyLCByZXF1ZXN0UGFyYW1ldGVycywgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICBwcmludCAiVXNlciBDb25maXJtIHJlZ2lzdHJhdGlvbi4gQ29uZmlybSBtZXRob2QiDQogICAgICAgIGNvZGVfYXJyYXkgPSByZXF1ZXN0UGFyYW1ldGVycy5nZXQoImNvZGUiKQ0KICAgICAgICBpZiBBcnJheUhlbHBlci5pc0VtcHR5KGNvZGVfYXJyYXkpOg0KICAgICAgICAgICAgcHJpbnQgIlVzZXIgQ29uZmlybSByZWdpc3RyYXRpb24uIENvbmZpcm0gbWV0aG9kLiBjb2RlIGlzIGVtcHR5Ig0KICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICAgICAgY29uZmlybWF0aW9uX2NvZGUgPSBjb2RlX2FycmF5WzBdDQogICAgICAgIHByaW50ICJVc2VyIENvbmZpcm0gcmVnaXN0cmF0aW9uLiBDb25maXJtIG1ldGhvZC4gY29kZTogJyVzJyIgJSBjb25maXJtYXRpb25fY29kZQ0KDQogICAgICAgIGlmIGNvbmZpcm1hdGlvbl9jb2RlID09IE5vbmU6DQogICAgICAgICAgICBwcmludCAiVXNlciBDb25maXJtIHJlZ2lzdHJhdGlvbi4gQ29uZmlybSBtZXRob2QuIENvbmZpcm1hdGlvbiBjb2RlIG5vdCBleGlzdCBpbiByZXF1ZXN0Ig0KICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICAgICAgcGVyc29uU2VydmljZSA9IENkaVV0aWwuYmVhbihQZXJzb25TZXJ2aWNlKQ0KICAgICAgICB1c2VyID0gcGVyc29uU2VydmljZS5nZXRQZXJzb25CeUF0dHJpYnV0ZSgib3hHdWlkIiwgY29uZmlybWF0aW9uX2NvZGUpDQogICAgICAgIGlmIHVzZXIgPT0gTm9uZToNCiAgICAgICAgICAgIHByaW50ICJVc2VyIENvbmZpcm0gcmVnaXN0cmF0aW9uLiBDb25maXJtIG1ldGhvZC4gVGhlcmUgaXMgbm8gdXNlciBieSBjb25maXJtYXRpb24gY29kZTogJyVzJyIgJSBjb25maXJtYXRpb25fY29kZQ0KICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICAgICAgaWYgY29uZmlybWF0aW9uX2NvZGUgPT0gdXNlci5nZXRHdWlkKCk6DQogICAgICAgICAgICB1c2VyLnNldFN0YXR1cygiYWN0aXZlIikNCiAgICAgICAgICAgIHVzZXIuc2V0R3VpZCgiIikNCiAgICAgICAgICAgIHBlcnNvblNlcnZpY2UudXBkYXRlUGVyc29uKHVzZXIpDQogICAgICAgICAgICBwcmludCAiVXNlciBDb25maXJtIHJlZ2lzdHJhdGlvbi4gQ29uZmlybSBtZXRob2QuIFVzZXIgJyVzJyBjb25maXJtZWQgaGlzIHJlZ2lzdHJhdGlvbiIgJSB1c2VyLmdldFVpZCgpDQogICAgICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgICAgIHByaW50ICJVc2VyIENvbmZpcm0gcmVnaXN0cmF0aW9uLiBDb25maXJtIG1ldGhvZC4gQ29uZmlybWF0aW9uIGNvZGUgZm9yIHVzZXIgJyVzJyBpcyBpbnZhbGlkIiAlIHVzZXIuZ2V0VWlkKCkNCiAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToNCiAgICAgICAgcmV0dXJuIDExDQo=
oxScriptType: user_registration
programmingLanguage: python

dn: inum=8BAF-80D6,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Fido U2F authentication module
displayName: u2f
oxEnabled: false
inum: 8BAF-80D6
oxConfigurationProperty: {"value1":"u2f_application_id","value2":"https://instance-1.us-central1-a.c.nifty-canyon-287111.internal","description":""}
oxConfigurationProperty: {"value1":"u2f_server_uri","value2":"https://instance-1.us-central1-a.c.nifty-canyon-287111.internal","description":""}
oxLevel: 50
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuDQojIENvcHlyaWdodCAoYykgMjAxNiwgR2x1dQ0KIw0KIyBBdXRob3I6IFl1cml5IE1vdmNoYW4NCiMNCg0KaW1wb3J0IGphdmENCmltcG9ydCBzeXMNCmZyb20gamF2YXgud3MucnMuY29yZSBpbXBvcnQgUmVzcG9uc2UNCmZyb20gb3JnLmpib3NzLnJlc3RlYXN5LmNsaWVudCBpbXBvcnQgQ2xpZW50UmVzcG9uc2VGYWlsdXJlDQpmcm9tIG9yZy5qYm9zcy5yZXN0ZWFzeS5jbGllbnQuZXhjZXB0aW9uIGltcG9ydCBSZXN0ZWFzeUNsaWVudEV4Y2VwdGlvbg0KZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuYXV0aCBpbXBvcnQgUGVyc29uQXV0aGVudGljYXRpb25UeXBlDQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5jbGllbnQuZmlkby51MmYgaW1wb3J0IEZpZG9VMmZDbGllbnRGYWN0b3J5DQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5jb25maWcgaW1wb3J0IENvbnN0YW50cw0KZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VjdXJpdHkgaW1wb3J0IElkZW50aXR5DQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlIGltcG9ydCBBdXRoZW50aWNhdGlvblNlcnZpY2UsIFNlc3Npb25JZFNlcnZpY2UNCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuY29tbW9uIGltcG9ydCBVc2VyU2VydmljZQ0KZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5maWRvLnUyZiBpbXBvcnQgRGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZQ0KZnJvbSBvcmcuZ2x1dS5veGF1dGgudXRpbCBpbXBvcnQgU2VydmVyVXRpbA0KZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlLmNkaS51dGlsIGltcG9ydCBDZGlVdGlsDQpmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlcg0KDQoNCmNsYXNzIFBlcnNvbkF1dGhlbnRpY2F0aW9uKFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZSk6DQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGN1cnJlbnRUaW1lTWlsbGlzKToNCiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzDQoNCiAgICBkZWYgaW5pdChzZWxmLCBjdXN0b21TY3JpcHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcHJpbnQgIlUyRi4gSW5pdGlhbGl6YXRpb24iDQoNCiAgICAgICAgcHJpbnQgIlUyRi4gSW5pdGlhbGl6YXRpb24uIERvd25sb2FkaW5nIFUyRiBtZXRhZGF0YSINCiAgICAgICAgdTJmX3NlcnZlcl91cmkgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoInUyZl9zZXJ2ZXJfdXJpIikuZ2V0VmFsdWUyKCkNCiAgICAgICAgdTJmX3NlcnZlcl9tZXRhZGF0YV91cmkgPSB1MmZfc2VydmVyX3VyaSArICIvLndlbGwta25vd24vZmlkby11MmYtY29uZmlndXJhdGlvbiINCg0KICAgICAgICBtZXRhRGF0YUNvbmZpZ3VyYXRpb25TZXJ2aWNlID0gRmlkb1UyZkNsaWVudEZhY3RvcnkuaW5zdGFuY2UoKS5jcmVhdGVNZXRhRGF0YUNvbmZpZ3VyYXRpb25TZXJ2aWNlKHUyZl9zZXJ2ZXJfbWV0YWRhdGFfdXJpKQ0KDQogICAgICAgIG1heF9hdHRlbXB0cyA9IDIwDQogICAgICAgIGZvciBhdHRlbXB0IGluIHJhbmdlKDEsIG1heF9hdHRlbXB0cyArIDEpOg0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgIHNlbGYubWV0YURhdGFDb25maWd1cmF0aW9uID0gbWV0YURhdGFDb25maWd1cmF0aW9uU2VydmljZS5nZXRNZXRhZGF0YUNvbmZpZ3VyYXRpb24oKQ0KICAgICAgICAgICAgICAgIGJyZWFrDQogICAgICAgICAgICBleGNlcHQgQ2xpZW50UmVzcG9uc2VGYWlsdXJlLCBleDoNCiAgICAgICAgICAgICAgICAjIERldGVjdCBpZiBsYXN0IHRyeSBvciB3ZSBzdGlsbCBnZXQgU2VydmljZSBVbmF2YWlsYWJsZSBIVFRQIGVycm9yDQogICAgICAgICAgICAgICAgaWYgKGF0dGVtcHQgPT0gbWF4X2F0dGVtcHRzKSBvciAoZXguZ2V0UmVzcG9uc2UoKS5nZXRSZXNwb25zZVN0YXR1cygpICE9IFJlc3BvbnNlLlN0YXR1cy5TRVJWSUNFX1VOQVZBSUxBQkxFKToNCiAgICAgICAgICAgICAgICAgICAgcmFpc2UgZXgNCg0KICAgICAgICAgICAgICAgIGphdmEubGFuZy5UaHJlYWQuc2xlZXAoMzAwMCkNCiAgICAgICAgICAgICAgICBwcmludCAiQXR0ZW1wdGluZyB0byBsb2FkIG1ldGFkYXRhOiAlZCIgJSBhdHRlbXB0DQogICAgICAgICAgICBleGNlcHQgUmVzdGVhc3lDbGllbnRFeGNlcHRpb24sIGV4Og0KICAgICAgICAgICAgICAgICMgRGV0ZWN0IGlmIGxhc3QgdHJ5IG9yIHdlIHN0aWxsIGdldCBTZXJ2aWNlIFVuYXZhaWxhYmxlIEhUVFAgZXJyb3INCiAgICAgICAgICAgICAgICBpZiBhdHRlbXB0ID09IG1heF9hdHRlbXB0czoNCiAgICAgICAgICAgICAgICAgICAgcmFpc2UgZXgNCg0KICAgICAgICAgICAgICAgIGphdmEubGFuZy5UaHJlYWQuc2xlZXAoMzAwMCkNCiAgICAgICAgICAgICAgICBwcmludCAiQXR0ZW1wdGluZyB0byBsb2FkIG1ldGFkYXRhOiAlZCIgJSBhdHRlbXB0DQogICAgICAgIA0KICAgICAgICBwcmludCAiVTJGLiBJbml0aWFsaXplZCBzdWNjZXNzZnVsbHkiDQogICAgICAgIHJldHVybiBUcnVlICAgDQoNCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6DQogICAgICAgIHByaW50ICJVMkYuIERlc3Ryb3kiDQogICAgICAgIHByaW50ICJVMkYuIERlc3Ryb3llZCBzdWNjZXNzZnVsbHkiDQogICAgICAgIHJldHVybiBUcnVlDQoNCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToNCiAgICAgICAgcmV0dXJuIDExDQogICAgICAgIA0KICAgIGRlZiBnZXRBdXRoZW50aWNhdGlvbk1ldGhvZENsYWltcyhzZWxmLCByZXF1ZXN0UGFyYW1ldGVycyk6DQogICAgICAgIHJldHVybiBOb25lDQogICAgICAgIA0KICAgIGRlZiBpc1ZhbGlkQXV0aGVudGljYXRpb25NZXRob2Qoc2VsZiwgdXNhZ2VUeXBlLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6DQogICAgICAgIHJldHVybiBUcnVlDQoNCiAgICBkZWYgZ2V0QWx0ZXJuYXRpdmVBdXRoZW50aWNhdGlvbk1ldGhvZChzZWxmLCB1c2FnZVR5cGUsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcmV0dXJuIE5vbmUNCg0KICAgIGRlZiBhdXRoZW50aWNhdGUoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToNCiAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkNCg0KICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkNCiAgICAgICAgY3JlZGVudGlhbHMgPSBpZGVudGl0eS5nZXRDcmVkZW50aWFscygpDQoNCiAgICAgICAgdXNlcl9uYW1lID0gY3JlZGVudGlhbHMuZ2V0VXNlcm5hbWUoKQ0KDQogICAgICAgIGlmIChzdGVwID09IDEpOg0KICAgICAgICAgICAgcHJpbnQgIlUyRi4gQXV0aGVudGljYXRlIGZvciBzdGVwIDEiDQoNCiAgICAgICAgICAgIHVzZXJfcGFzc3dvcmQgPSBjcmVkZW50aWFscy5nZXRQYXNzd29yZCgpDQogICAgICAgICAgICBsb2dnZWRfaW4gPSBGYWxzZQ0KICAgICAgICAgICAgaWYgKFN0cmluZ0hlbHBlci5pc05vdEVtcHR5U3RyaW5nKHVzZXJfbmFtZSkgYW5kIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5U3RyaW5nKHVzZXJfcGFzc3dvcmQpKToNCiAgICAgICAgICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkNCiAgICAgICAgICAgICAgICBsb2dnZWRfaW4gPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJfbmFtZSwgdXNlcl9wYXNzd29yZCkNCg0KICAgICAgICAgICAgaWYgKG5vdCBsb2dnZWRfaW4pOg0KICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgICAgICAgICByZXR1cm4gVHJ1ZQ0KICAgICAgICBlbGlmIChzdGVwID09IDIpOg0KICAgICAgICAgICAgcHJpbnQgIlUyRi4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIiDQoNCiAgICAgICAgICAgIHRva2VuX3Jlc3BvbnNlID0gU2VydmVyVXRpbC5nZXRGaXJzdFZhbHVlKHJlcXVlc3RQYXJhbWV0ZXJzLCAidG9rZW5SZXNwb25zZSIpDQogICAgICAgICAgICBpZiB0b2tlbl9yZXNwb25zZSA9PSBOb25lOg0KICAgICAgICAgICAgICAgIHByaW50ICJVMkYuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiB0b2tlblJlc3BvbnNlIGlzIGVtcHR5Ig0KICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgICAgICAgICBhdXRoX21ldGhvZCA9IFNlcnZlclV0aWwuZ2V0Rmlyc3RWYWx1ZShyZXF1ZXN0UGFyYW1ldGVycywgImF1dGhNZXRob2QiKQ0KICAgICAgICAgICAgaWYgYXV0aF9tZXRob2QgPT0gTm9uZToNCiAgICAgICAgICAgICAgICBwcmludCAiVTJGLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gYXV0aE1ldGhvZCBpcyBlbXB0eSINCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgICAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkNCiAgICAgICAgICAgIHVzZXIgPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuZ2V0QXV0aGVudGljYXRlZFVzZXIoKQ0KICAgICAgICAgICAgaWYgKHVzZXIgPT0gTm9uZSk6DQogICAgICAgICAgICAgICAgcHJpbnQgIlUyRi4gUHJlcGFyZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gZGV0ZXJtaW5lIHVzZXIgbmFtZSINCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgICAgICAgICAgaWYgKGF1dGhfbWV0aG9kID09ICdhdXRoZW50aWNhdGUnKToNCiAgICAgICAgICAgICAgICBwcmludCAiVTJGLiBQcmVwYXJlIGZvciBzdGVwIDIuIENhbGwgRklETyBVMkYgaW4gb3JkZXIgdG8gZmluaXNoIGF1dGhlbnRpY2F0aW9uIHdvcmtmbG93Ig0KICAgICAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uUmVxdWVzdFNlcnZpY2UgPSBGaWRvVTJmQ2xpZW50RmFjdG9yeS5pbnN0YW5jZSgpLmNyZWF0ZUF1dGhlbnRpY2F0aW9uUmVxdWVzdFNlcnZpY2Uoc2VsZi5tZXRhRGF0YUNvbmZpZ3VyYXRpb24pDQogICAgICAgICAgICAgICAgYXV0aGVudGljYXRpb25TdGF0dXMgPSBhdXRoZW50aWNhdGlvblJlcXVlc3RTZXJ2aWNlLmZpbmlzaEF1dGhlbnRpY2F0aW9uKHVzZXIuZ2V0VXNlcklkKCksIHRva2VuX3Jlc3BvbnNlKQ0KDQogICAgICAgICAgICAgICAgaWYgKGF1dGhlbnRpY2F0aW9uU3RhdHVzLmdldFN0YXR1cygpICE9IENvbnN0YW50cy5SRVNVTFRfU1VDQ0VTUyk6DQogICAgICAgICAgICAgICAgICAgIHByaW50ICJVMkYuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBHZXQgaW52YWxpZCBhdXRoZW50aWNhdGlvbiBzdGF0dXMgZnJvbSBGSURPIFUyRiBzZXJ2ZXIiDQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICAgICAgICAgIGVsaWYgKGF1dGhfbWV0aG9kID09ICdlbnJvbGwnKToNCiAgICAgICAgICAgICAgICBwcmludCAiVTJGLiBQcmVwYXJlIGZvciBzdGVwIDIuIENhbGwgRklETyBVMkYgaW4gb3JkZXIgdG8gZmluaXNoIHJlZ2lzdHJhdGlvbiB3b3JrZmxvdyINCiAgICAgICAgICAgICAgICByZWdpc3RyYXRpb25SZXF1ZXN0U2VydmljZSA9IEZpZG9VMmZDbGllbnRGYWN0b3J5Lmluc3RhbmNlKCkuY3JlYXRlUmVnaXN0cmF0aW9uUmVxdWVzdFNlcnZpY2Uoc2VsZi5tZXRhRGF0YUNvbmZpZ3VyYXRpb24pDQogICAgICAgICAgICAgICAgcmVnaXN0cmF0aW9uU3RhdHVzID0gcmVnaXN0cmF0aW9uUmVxdWVzdFNlcnZpY2UuZmluaXNoUmVnaXN0cmF0aW9uKHVzZXIuZ2V0VXNlcklkKCksIHRva2VuX3Jlc3BvbnNlKQ0KDQogICAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvblN0YXR1cy5nZXRTdGF0dXMoKSAhPSBDb25zdGFudHMuUkVTVUxUX1NVQ0NFU1MpOg0KICAgICAgICAgICAgICAgICAgICBwcmludCAiVTJGLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gR2V0IGludmFsaWQgcmVnaXN0cmF0aW9uIHN0YXR1cyBmcm9tIEZJRE8gVTJGIHNlcnZlciINCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBwcmludCAiVTJGLiBQcmVwYXJlIGZvciBzdGVwIDIuIEF1dGhlbnRpY2F0aW9kIG1ldGhvZCBpcyBpbnZhbGlkIg0KICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgICAgICAgICByZXR1cm4gRmFsc2UNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgZGVmIHByZXBhcmVGb3JTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6DQogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQ0KDQogICAgICAgIGlmIChzdGVwID09IDEpOg0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICAgICAgZWxpZiAoc3RlcCA9PSAyKToNCiAgICAgICAgICAgIHByaW50ICJVMkYuIFByZXBhcmUgZm9yIHN0ZXAgMiINCg0KICAgICAgICAgICAgc2Vzc2lvbiA9IENkaVV0aWwuYmVhbihTZXNzaW9uSWRTZXJ2aWNlKS5nZXRTZXNzaW9uSWQoKQ0KICAgICAgICAgICAgaWYgc2Vzc2lvbiA9PSBOb25lOg0KICAgICAgICAgICAgICAgIHByaW50ICJVMkYuIFByZXBhcmUgZm9yIHN0ZXAgMi4gRmFpbGVkIHRvIGRldGVybWluZSBzZXNzaW9uX2lkIg0KICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgICAgICAgICBhdXRoZW50aWNhdGlvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oQXV0aGVudGljYXRpb25TZXJ2aWNlKQ0KICAgICAgICAgICAgdXNlciA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpDQogICAgICAgICAgICBpZiAodXNlciA9PSBOb25lKToNCiAgICAgICAgICAgICAgICBwcmludCAiVTJGLiBQcmVwYXJlIGZvciBzdGVwIDIuIEZhaWxlZCB0byBkZXRlcm1pbmUgdXNlciBuYW1lIg0KICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgICAgICAgICB1MmZfYXBwbGljYXRpb25faWQgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoInUyZl9hcHBsaWNhdGlvbl9pZCIpLmdldFZhbHVlMigpDQoNCiAgICAgICAgICAgICMgQ2hlY2sgaWYgdXNlciBoYXZlIHJlZ2lzdGVyZWQgZGV2aWNlcw0KICAgICAgICAgICAgZGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZSA9IENkaVV0aWwuYmVhbihEZXZpY2VSZWdpc3RyYXRpb25TZXJ2aWNlKQ0KDQogICAgICAgICAgICB1c2VySW51bSA9IHVzZXIuZ2V0QXR0cmlidXRlKCJpbnVtIikNCg0KICAgICAgICAgICAgcmVnaXN0cmF0aW9uUmVxdWVzdCA9IE5vbmUNCiAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uUmVxdWVzdCA9IE5vbmUNCg0KICAgICAgICAgICAgZGV2aWNlUmVnaXN0cmF0aW9ucyA9IGRldmljZVJlZ2lzdHJhdGlvblNlcnZpY2UuZmluZFVzZXJEZXZpY2VSZWdpc3RyYXRpb25zKHVzZXJJbnVtLCB1MmZfYXBwbGljYXRpb25faWQpDQogICAgICAgICAgICBpZiAoZGV2aWNlUmVnaXN0cmF0aW9ucy5zaXplKCkgPiAwKToNCiAgICAgICAgICAgICAgICBwcmludCAiVTJGLiBQcmVwYXJlIGZvciBzdGVwIDIuIENhbGwgRklETyBVMkYgaW4gb3JkZXIgdG8gc3RhcnQgYXV0aGVudGljYXRpb24gd29ya2Zsb3ciDQoNCiAgICAgICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uUmVxdWVzdFNlcnZpY2UgPSBGaWRvVTJmQ2xpZW50RmFjdG9yeS5pbnN0YW5jZSgpLmNyZWF0ZUF1dGhlbnRpY2F0aW9uUmVxdWVzdFNlcnZpY2Uoc2VsZi5tZXRhRGF0YUNvbmZpZ3VyYXRpb24pDQogICAgICAgICAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uUmVxdWVzdCA9IGF1dGhlbnRpY2F0aW9uUmVxdWVzdFNlcnZpY2Uuc3RhcnRBdXRoZW50aWNhdGlvbih1c2VyLmdldFVzZXJJZCgpLCBOb25lLCB1MmZfYXBwbGljYXRpb25faWQsIHNlc3Npb24uZ2V0SWQoKSkNCiAgICAgICAgICAgICAgICBleGNlcHQgQ2xpZW50UmVzcG9uc2VGYWlsdXJlLCBleDoNCiAgICAgICAgICAgICAgICAgICAgaWYgKGV4LmdldFJlc3BvbnNlKCkuZ2V0UmVzcG9uc2VTdGF0dXMoKSAhPSBSZXNwb25zZS5TdGF0dXMuTk9UX0ZPVU5EKToNCiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ICJVMkYuIFByZXBhcmUgZm9yIHN0ZXAgMi4gRmFpbGVkIHRvIHN0YXJ0IGF1dGhlbnRpY2F0aW9uIHdvcmtmbG93LiBFeGNlcHRpb246Iiwgc3lzLmV4Y19pbmZvKClbMV0NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBwcmludCAiVTJGLiBQcmVwYXJlIGZvciBzdGVwIDIuIENhbGwgRklETyBVMkYgaW4gb3JkZXIgdG8gc3RhcnQgcmVnaXN0cmF0aW9uIHdvcmtmbG93Ig0KICAgICAgICAgICAgICAgIHJlZ2lzdHJhdGlvblJlcXVlc3RTZXJ2aWNlID0gRmlkb1UyZkNsaWVudEZhY3RvcnkuaW5zdGFuY2UoKS5jcmVhdGVSZWdpc3RyYXRpb25SZXF1ZXN0U2VydmljZShzZWxmLm1ldGFEYXRhQ29uZmlndXJhdGlvbikNCiAgICAgICAgICAgICAgICByZWdpc3RyYXRpb25SZXF1ZXN0ID0gcmVnaXN0cmF0aW9uUmVxdWVzdFNlcnZpY2Uuc3RhcnRSZWdpc3RyYXRpb24odXNlci5nZXRVc2VySWQoKSwgdTJmX2FwcGxpY2F0aW9uX2lkLCBzZXNzaW9uLmdldElkKCkpDQoNCiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImZpZG9fdTJmX2F1dGhlbnRpY2F0aW9uX3JlcXVlc3QiLCBTZXJ2ZXJVdGlsLmFzSnNvbihhdXRoZW50aWNhdGlvblJlcXVlc3QpKQ0KICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigiZmlkb191MmZfcmVnaXN0cmF0aW9uX3JlcXVlc3QiLCBTZXJ2ZXJVdGlsLmFzSnNvbihyZWdpc3RyYXRpb25SZXF1ZXN0KSkNCg0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICAgICAgZWxpZiAoc3RlcCA9PSAzKToNCiAgICAgICAgICAgIHByaW50ICJVMkYuIFByZXBhcmUgZm9yIHN0ZXAgMyINCg0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgZGVmIGdldEV4dHJhUGFyYW1ldGVyc0ZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOg0KICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgZGVmIGdldENvdW50QXV0aGVudGljYXRpb25TdGVwcyhzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6DQogICAgICAgIHJldHVybiAyDQoNCiAgICBkZWYgZ2V0UGFnZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOg0KICAgICAgICBpZiAoc3RlcCA9PSAyKToNCiAgICAgICAgICAgIHJldHVybiAiL2F1dGgvdTJmL2xvZ2luLnhodG1sIg0KDQogICAgICAgIHJldHVybiAiIg0KDQogICAgZGVmIGdldE5leHRTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6DQogICAgICAgIHJldHVybiAtMQ0KDQogICAgZGVmIGdldExvZ291dEV4dGVybmFsVXJsKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycyk6DQogICAgICAgIHByaW50ICJHZXQgZXh0ZXJuYWwgbG9nb3V0IFVSTCBjYWxsIg0KICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgZGVmIGxvZ291dChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMpOg0KICAgICAgICByZXR1cm4gVHJ1ZQ0K
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=8BAF-80D7,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Fido2 authentication module
displayName: fido2
oxEnabled: false
inum: 8BAF-80D7
oxConfigurationProperty: {"value1":"fido2_server_uri","value2":"https://instance-1.us-central1-a.c.nifty-canyon-287111.internal","hide":false,"description":""}
oxLevel: 70
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE4LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBqYXZheC53cy5ycy5jb3JlIGltcG9ydCBSZXNwb25zZQpmcm9tIG9yZy5qYm9zcy5yZXN0ZWFzeS5jbGllbnQgaW1wb3J0IENsaWVudFJlc3BvbnNlRmFpbHVyZQpmcm9tIG9yZy5qYm9zcy5yZXN0ZWFzeS5jbGllbnQuZXhjZXB0aW9uIGltcG9ydCBSZXN0ZWFzeUNsaWVudEV4Y2VwdGlvbgpmcm9tIGphdmF4LndzLnJzLmNvcmUgaW1wb3J0IFJlc3BvbnNlCmZyb20gb3JnLmdsdXUubW9kZWwuY3VzdG9tLnNjcmlwdC50eXBlLmF1dGggaW1wb3J0IFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZQpmcm9tIG9yZy5nbHV1LmZpZG8yLmNsaWVudCBpbXBvcnQgRmlkbzJDbGllbnRGYWN0b3J5CmZyb20gb3JnLmdsdXUub3hhdXRoLnNlY3VyaXR5IGltcG9ydCBJZGVudGl0eQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlIGltcG9ydCBBdXRoZW50aWNhdGlvblNlcnZpY2UsIFNlc3Npb25JZFNlcnZpY2UKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5jb21tb24gaW1wb3J0IFVzZXJTZXJ2aWNlCmZyb20gb3JnLmdsdXUub3hhdXRoLnV0aWwgaW1wb3J0IFNlcnZlclV0aWwKZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlLmNkaS51dGlsIGltcG9ydCBDZGlVdGlsCmZyb20gb3JnLmdsdXUudXRpbCBpbXBvcnQgU3RyaW5nSGVscGVyCgpmcm9tIGphdmEudXRpbC5jb25jdXJyZW50LmxvY2tzIGltcG9ydCBSZWVudHJhbnRMb2NrCgppbXBvcnQgamF2YQppbXBvcnQgc3lzCnRyeToKICAgIGltcG9ydCBqc29uCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGltcG9ydCBzaW1wbGVqc29uIGFzIGpzb24KCmNsYXNzIFBlcnNvbkF1dGhlbnRpY2F0aW9uKFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJGaWRvMi4gSW5pdGlhbGl6YXRpb24iCgogICAgICAgIGlmIG5vdCBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5jb250YWluc0tleSgiZmlkbzJfc2VydmVyX3VyaSIpOgogICAgICAgICAgICBwcmludCAiZmlkbzJfc2VydmVyX3VyaS4gSW5pdGlhbGl6YXRpb24uIFByb3BlcnR5IGZpZG8yX3NlcnZlcl91cmkgaXMgbm90IHNwZWNpZmllZCIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIHNlbGYuZmlkbzJfc2VydmVyX3VyaSA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiZmlkbzJfc2VydmVyX3VyaSIpLmdldFZhbHVlMigpCgogICAgICAgIHNlbGYuZmlkbzJfZG9tYWluID0gTm9uZQogICAgICAgIGlmIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJmaWRvMl9kb21haW4iKToKICAgICAgICAgICAgc2VsZi5maWRvMl9kb21haW4gPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImZpZG8yX2RvbWFpbiIpLmdldFZhbHVlMigpCgogICAgICAgIHNlbGYubWV0YURhdGFMb2FkZXJMb2NrID0gUmVlbnRyYW50TG9jaygpCiAgICAgICAgc2VsZi5tZXRhRGF0YUNvbmZpZ3VyYXRpb24gPSBOb25lCiAgICAgICAgCiAgICAgICAgcHJpbnQgIkZpZG8yLiBJbml0aWFsaXplZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUgICAKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkZpZG8yLiBEZXN0cm95IgogICAgICAgIHByaW50ICJGaWRvMi4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQogICAgICAgIAogICAgZGVmIGdldEF1dGhlbnRpY2F0aW9uTWV0aG9kQ2xhaW1zKHNlbGYsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgZGVmIGlzVmFsaWRBdXRoZW50aWNhdGlvbk1ldGhvZChzZWxmLCB1c2FnZVR5cGUsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBbHRlcm5hdGl2ZUF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGF1dGhlbnRpY2F0ZShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIGF1dGhlbnRpY2F0aW9uU2VydmljZSA9IENkaVV0aWwuYmVhbihBdXRoZW50aWNhdGlvblNlcnZpY2UpCgogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQogICAgICAgIGNyZWRlbnRpYWxzID0gaWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHMoKQoKICAgICAgICB1c2VyX25hbWUgPSBjcmVkZW50aWFscy5nZXRVc2VybmFtZSgpCgogICAgICAgIGlmIHN0ZXAgPT0gMToKICAgICAgICAgICAgcHJpbnQgIkZpZG8yLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMSIKCiAgICAgICAgICAgIHVzZXJfcGFzc3dvcmQgPSBjcmVkZW50aWFscy5nZXRQYXNzd29yZCgpCiAgICAgICAgICAgIGxvZ2dlZF9pbiA9IEZhbHNlCiAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5U3RyaW5nKHVzZXJfbmFtZSkgYW5kIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5U3RyaW5nKHVzZXJfcGFzc3dvcmQpOgogICAgICAgICAgICAgICAgdXNlclNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oVXNlclNlcnZpY2UpCiAgICAgICAgICAgICAgICBsb2dnZWRfaW4gPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJfbmFtZSwgdXNlcl9wYXNzd29yZCkKCiAgICAgICAgICAgIGlmIG5vdCBsb2dnZWRfaW46CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxpZiBzdGVwID09IDI6CiAgICAgICAgICAgIHByaW50ICJGaWRvMi4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIiCgogICAgICAgICAgICB0b2tlbl9yZXNwb25zZSA9IFNlcnZlclV0aWwuZ2V0Rmlyc3RWYWx1ZShyZXF1ZXN0UGFyYW1ldGVycywgInRva2VuUmVzcG9uc2UiKQogICAgICAgICAgICBpZiB0b2tlbl9yZXNwb25zZSA9PSBOb25lOgogICAgICAgICAgICAgICAgcHJpbnQgIkZpZG8yLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gdG9rZW5SZXNwb25zZSBpcyBlbXB0eSIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgYXV0aF9tZXRob2QgPSBTZXJ2ZXJVdGlsLmdldEZpcnN0VmFsdWUocmVxdWVzdFBhcmFtZXRlcnMsICJhdXRoTWV0aG9kIikKICAgICAgICAgICAgaWYgYXV0aF9tZXRob2QgPT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJGaWRvMi4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIuIGF1dGhNZXRob2QgaXMgZW1wdHkiCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uU2VydmljZSA9IENkaVV0aWwuYmVhbihBdXRoZW50aWNhdGlvblNlcnZpY2UpCiAgICAgICAgICAgIHVzZXIgPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuZ2V0QXV0aGVudGljYXRlZFVzZXIoKQogICAgICAgICAgICBpZiB1c2VyID09IE5vbmU6CiAgICAgICAgICAgICAgICBwcmludCAiRmlkbzIuIFByZXBhcmUgZm9yIHN0ZXAgMi4gRmFpbGVkIHRvIGRldGVybWluZSB1c2VyIG5hbWUiCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIGlmIGF1dGhfbWV0aG9kID09ICdhdXRoZW50aWNhdGUnOgogICAgICAgICAgICAgICAgcHJpbnQgIkZpZG8yLiBQcmVwYXJlIGZvciBzdGVwIDIuIENhbGwgRmlkbzIgaW4gb3JkZXIgdG8gZmluaXNoIGF1dGhlbnRpY2F0aW9uIGZsb3ciCiAgICAgICAgICAgICAgICBhc3NlcnRpb25TZXJ2aWNlID0gRmlkbzJDbGllbnRGYWN0b3J5Lmluc3RhbmNlKCkuY3JlYXRlQXNzZXJ0aW9uU2VydmljZShzZWxmLm1ldGFEYXRhQ29uZmlndXJhdGlvbikKICAgICAgICAgICAgICAgIGFzc2VydGlvblN0YXR1cyA9IGFzc2VydGlvblNlcnZpY2UudmVyaWZ5KHRva2VuX3Jlc3BvbnNlKQogICAgICAgICAgICAgICAgYXV0aGVudGljYXRpb25TdGF0dXNFbnRpdHkgPSBhc3NlcnRpb25TdGF0dXMucmVhZEVudGl0eShqYXZhLmxhbmcuU3RyaW5nKQoKICAgICAgICAgICAgICAgIGlmIGFzc2VydGlvblN0YXR1cy5nZXRTdGF0dXMoKSAhPSBSZXNwb25zZS5TdGF0dXMuT0suZ2V0U3RhdHVzQ29kZSgpOgogICAgICAgICAgICAgICAgICAgIHByaW50ICJGaWRvMi4gQXV0aGVudGljYXRlIGZvciBzdGVwIDIuIEdldCBpbnZhbGlkIGF1dGhlbnRpY2F0aW9uIHN0YXR1cyBmcm9tIEZpZG8yIHNlcnZlciIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbGlmIGF1dGhfbWV0aG9kID09ICdlbnJvbGwnOgogICAgICAgICAgICAgICAgcHJpbnQgIkZpZG8yLiBQcmVwYXJlIGZvciBzdGVwIDIuIENhbGwgRmlkbzIgaW4gb3JkZXIgdG8gZmluaXNoIHJlZ2lzdHJhdGlvbiBmbG93IgogICAgICAgICAgICAgICAgYXR0ZXN0YXRpb25TZXJ2aWNlID0gRmlkbzJDbGllbnRGYWN0b3J5Lmluc3RhbmNlKCkuY3JlYXRlQXR0ZXN0YXRpb25TZXJ2aWNlKHNlbGYubWV0YURhdGFDb25maWd1cmF0aW9uKQogICAgICAgICAgICAgICAgYXR0ZXN0YXRpb25TdGF0dXMgPSBhdHRlc3RhdGlvblNlcnZpY2UudmVyaWZ5KHRva2VuX3Jlc3BvbnNlKQoKICAgICAgICAgICAgICAgIGlmIGF0dGVzdGF0aW9uU3RhdHVzLmdldFN0YXR1cygpICE9IFJlc3BvbnNlLlN0YXR1cy5PSy5nZXRTdGF0dXNDb2RlKCk6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkZpZG8yLiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gR2V0IGludmFsaWQgcmVnaXN0cmF0aW9uIHN0YXR1cyBmcm9tIEZpZG8yIHNlcnZlciIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQgIkZpZG8yLiBQcmVwYXJlIGZvciBzdGVwIDIuIEF1dGhlbnRpY2F0aW9uIG1ldGhvZCBpcyBpbnZhbGlkIgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgcHJlcGFyZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsaWYgc3RlcCA9PSAyOgogICAgICAgICAgICBwcmludCAiRmlkbzIuIFByZXBhcmUgZm9yIHN0ZXAgMiIKCiAgICAgICAgICAgIHNlc3Npb24gPSBDZGlVdGlsLmJlYW4oU2Vzc2lvbklkU2VydmljZSkuZ2V0U2Vzc2lvbklkKCkKICAgICAgICAgICAgaWYgc2Vzc2lvbiA9PSBOb25lOgogICAgICAgICAgICAgICAgcHJpbnQgIkZpZG8yLiBQcmVwYXJlIGZvciBzdGVwIDIuIEZhaWxlZCB0byBkZXRlcm1pbmUgc2Vzc2lvbl9pZCIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkKICAgICAgICAgICAgdXNlciA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpCiAgICAgICAgICAgIGlmIHVzZXIgPT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJGaWRvMi4gUHJlcGFyZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gZGV0ZXJtaW5lIHVzZXIgbmFtZSIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgdXNlck5hbWUgPSB1c2VyLmdldFVzZXJJZCgpCgogICAgICAgICAgICBtZXRhRGF0YUNvbmZpZ3VyYXRpb24gPSBzZWxmLmdldE1ldGFEYXRhQ29uZmlndXJhdGlvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICBhc3NlcnRpb25SZXNwb25zZSA9IE5vbmUKICAgICAgICAgICAgYXR0ZXN0YXRpb25SZXNwb25zZSA9IE5vbmUKCiAgICAgICAgICAgICMgQ2hlY2sgaWYgdXNlciBoYXZlIHJlZ2lzdGVyZWQgZGV2aWNlcwogICAgICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkKICAgICAgICAgICAgY291bnRGaWRvMkRldmljZXMgPSB1c2VyU2VydmljZS5jb3VudEZpZG9BbmRGaWRvMkRldmljZXModXNlck5hbWUsIHNlbGYuZmlkbzJfZG9tYWluKQogICAgICAgICAgICBpZiBjb3VudEZpZG8yRGV2aWNlcyA+IDA6CiAgICAgICAgICAgICAgICBwcmludCAiRmlkbzIuIFByZXBhcmUgZm9yIHN0ZXAgMi4gQ2FsbCBGaWRvMiBlbmRwb2ludCBpbiBvcmRlciB0byBzdGFydCBhc3NlcnRpb24gZmxvdyIKCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0aW9uU2VydmljZSA9IEZpZG8yQ2xpZW50RmFjdG9yeS5pbnN0YW5jZSgpLmNyZWF0ZUFzc2VydGlvblNlcnZpY2UobWV0YURhdGFDb25maWd1cmF0aW9uKQogICAgICAgICAgICAgICAgICAgIGFzc2VydGlvblJlcXVlc3QgPSBqc29uLmR1bXBzKHsndXNlcm5hbWUnOiB1c2VyTmFtZX0sIHNlcGFyYXRvcnM9KCcsJywgJzonKSkKICAgICAgICAgICAgICAgICAgICBhc3NlcnRpb25SZXNwb25zZSA9IGFzc2VydGlvblNlcnZpY2UuYXV0aGVudGljYXRlKGFzc2VydGlvblJlcXVlc3QpLnJlYWRFbnRpdHkoamF2YS5sYW5nLlN0cmluZykKICAgICAgICAgICAgICAgIGV4Y2VwdCBDbGllbnRSZXNwb25zZUZhaWx1cmUsIGV4OgogICAgICAgICAgICAgICAgICAgIHByaW50ICJGaWRvMi4gUHJlcGFyZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gc3RhcnQgYXNzZXJ0aW9uIGZsb3cuIEV4Y2VwdGlvbjoiLCBzeXMuZXhjX2luZm8oKVsxXQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQgIkZpZG8yLiBQcmVwYXJlIGZvciBzdGVwIDIuIENhbGwgRmlkbzIgZW5kcG9pbnQgaW4gb3JkZXIgdG8gc3RhcnQgYXR0ZXN0YXRpb24gZmxvdyIKCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYXR0ZXN0YXRpb25TZXJ2aWNlID0gRmlkbzJDbGllbnRGYWN0b3J5Lmluc3RhbmNlKCkuY3JlYXRlQXR0ZXN0YXRpb25TZXJ2aWNlKG1ldGFEYXRhQ29uZmlndXJhdGlvbikKICAgICAgICAgICAgICAgICAgICBhdHRlc3RhdGlvblJlcXVlc3QgPSBqc29uLmR1bXBzKHsndXNlcm5hbWUnOiB1c2VyTmFtZSwgJ2Rpc3BsYXlOYW1lJzogdXNlck5hbWUsICdhdHRlc3RhdGlvbicgOiAnZGlyZWN0J30sIHNlcGFyYXRvcnM9KCcsJywgJzonKSkKICAgICAgICAgICAgICAgICAgICBhdHRlc3RhdGlvblJlc3BvbnNlID0gYXR0ZXN0YXRpb25TZXJ2aWNlLnJlZ2lzdGVyKGF0dGVzdGF0aW9uUmVxdWVzdCkucmVhZEVudGl0eShqYXZhLmxhbmcuU3RyaW5nKQogICAgICAgICAgICAgICAgZXhjZXB0IENsaWVudFJlc3BvbnNlRmFpbHVyZSwgZXg6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkZpZG8yLiBQcmVwYXJlIGZvciBzdGVwIDIuIEZhaWxlZCB0byBzdGFydCBhdHRlc3RhdGlvbiBmbG93LiBFeGNlcHRpb246Iiwgc3lzLmV4Y19pbmZvKClbMV0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImZpZG8yX2Fzc2VydGlvbl9yZXF1ZXN0IiwgU2VydmVyVXRpbC5hc0pzb24oYXNzZXJ0aW9uUmVzcG9uc2UpKQogICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJmaWRvMl9hdHRlc3RhdGlvbl9yZXF1ZXN0IiwgU2VydmVyVXRpbC5hc0pzb24oYXR0ZXN0YXRpb25SZXNwb25zZSkpCiAgICAgICAgICAgIHByaW50ICJGaWRvMi4gUHJlcGFyZSBmb3Igc3RlcCAyLiBTdWNjZXNzZnVsbHkgc3RhcnQgZmxvdyB3aXRoIG5leHQgcmVxdWVzdHMuXG5maWRvMl9hc3NlcnRpb25fcmVxdWVzdDogJyVzJ1xuZmlkbzJfYXR0ZXN0YXRpb25fcmVxdWVzdDogJyVzJyIgJSAoIGFzc2VydGlvblJlc3BvbnNlLCBhdHRlc3RhdGlvblJlc3BvbnNlICkKCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxpZiBzdGVwID09IDM6CiAgICAgICAgICAgIHByaW50ICJGaWRvMi4gUHJlcGFyZSBmb3Igc3RlcCAzIgoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgZ2V0RXh0cmFQYXJhbWV0ZXJzRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgc3RlcCk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgZ2V0Q291bnRBdXRoZW50aWNhdGlvblN0ZXBzKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gMgoKICAgIGRlZiBnZXROZXh0U3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIHJldHVybiAtMQoKICAgIGRlZiBnZXRQYWdlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgc3RlcCk6CiAgICAgICAgaWYgc3RlcCA9PSAyOgogICAgICAgICAgICByZXR1cm4gIi9hdXRoL2ZpZG8yL2xvZ2luLnhodG1sIgoKICAgICAgICByZXR1cm4gIiIKCiAgICBkZWYgbG9nb3V0KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZ2V0QXV0aGVudGljYXRpb25NZXRob2RDbGFpbXMoc2VsZiwgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHJldHVybiBOb25lCiAgICAgICAgCiAgICBkZWYgZ2V0TG9nb3V0RXh0ZXJuYWxVcmwoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICBwcmludCAiR2V0IGV4dGVybmFsIGxvZ291dCBVUkwgY2FsbCIKICAgICAgICByZXR1cm4gTm9uZSAgICAKICAgICAgICAKICAgICAgICAKICAgIGRlZiBnZXRNZXRhRGF0YUNvbmZpZ3VyYXRpb24oc2VsZik6CiAgICAgICAgaWYgc2VsZi5tZXRhRGF0YUNvbmZpZ3VyYXRpb24gIT0gTm9uZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYubWV0YURhdGFDb25maWd1cmF0aW9uCiAgICAgICAgCiAgICAgICAgc2VsZi5tZXRhRGF0YUxvYWRlckxvY2subG9jaygpCiAgICAgICAgIyBNYWtlIHN1cmUgdGhhdCBhbm90aGVyIHRocmVhZCBub3QgbG9hZGVkIGNvbmZpZ3VyYXRpb24gYWxyZWFkeSAgICAgICAgICAKICAgICAgICBpZiBzZWxmLm1ldGFEYXRhQ29uZmlndXJhdGlvbiAhPSBOb25lOgogICAgICAgICAgICByZXR1cm4gc2VsZi5tZXRhRGF0YUNvbmZpZ3VyYXRpb24KCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwcmludCAiRmlkbzIuIEluaXRpYWxpemF0aW9uLiBEb3dubG9hZGluZyBGaWRvMiBtZXRhZGF0YSIKICAgICAgICAgICAgc2VsZi5maWRvMl9zZXJ2ZXJfbWV0YWRhdGFfdXJpID0gc2VsZi5maWRvMl9zZXJ2ZXJfdXJpICsgIi8ud2VsbC1rbm93bi9maWRvMi1jb25maWd1cmF0aW9uIgogICAgICAgICAgICAjc2VsZi5maWRvMl9zZXJ2ZXJfbWV0YWRhdGFfdXJpID0gc2VsZi5maWRvMl9zZXJ2ZXJfdXJpICsgIi9maWRvMi9yZXN0djEvZmlkbzIvY29uZmlndXJhdGlvbiIKCiAgICAgICAgICAgIG1ldGFEYXRhQ29uZmlndXJhdGlvblNlcnZpY2UgPSBGaWRvMkNsaWVudEZhY3RvcnkuaW5zdGFuY2UoKS5jcmVhdGVNZXRhRGF0YUNvbmZpZ3VyYXRpb25TZXJ2aWNlKHNlbGYuZmlkbzJfc2VydmVyX21ldGFkYXRhX3VyaSkKICAgIAogICAgICAgICAgICBtYXhfYXR0ZW1wdHMgPSAxMAogICAgICAgICAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZSgxLCBtYXhfYXR0ZW1wdHMgKyAxKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLm1ldGFEYXRhQ29uZmlndXJhdGlvbiA9IG1ldGFEYXRhQ29uZmlndXJhdGlvblNlcnZpY2UuZ2V0TWV0YWRhdGFDb25maWd1cmF0aW9uKCkucmVhZEVudGl0eShqYXZhLmxhbmcuU3RyaW5nKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLm1ldGFEYXRhQ29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgZXhjZXB0IENsaWVudFJlc3BvbnNlRmFpbHVyZSwgZXg6CiAgICAgICAgICAgICAgICAgICAgIyBEZXRlY3QgaWYgbGFzdCB0cnkgb3Igd2Ugc3RpbGwgZ2V0IFNlcnZpY2UgVW5hdmFpbGFibGUgSFRUUCBlcnJvcgogICAgICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0ID09IG1heF9hdHRlbXB0cykgb3IgKGV4LmdldFJlc3BvbnNlKCkuZ2V0UmVzcG9uc2VTdGF0dXMoKSAhPSBSZXNwb25zZS5TdGF0dXMuU0VSVklDRV9VTkFWQUlMQUJMRSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIGV4CiAgICAKICAgICAgICAgICAgICAgICAgICBqYXZhLmxhbmcuVGhyZWFkLnNsZWVwKDMwMDApCiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkF0dGVtcHRpbmcgdG8gbG9hZCBtZXRhZGF0YTogJWQiICUgYXR0ZW1wdAogICAgICAgICAgICAgICAgZXhjZXB0IFJlc3RlYXN5Q2xpZW50RXhjZXB0aW9uLCBleDoKICAgICAgICAgICAgICAgICAgICAjIERldGVjdCBpZiBsYXN0IHRyeSBvciB3ZSBzdGlsbCBnZXQgU2VydmljZSBVbmF2YWlsYWJsZSBIVFRQIGVycm9yCiAgICAgICAgICAgICAgICAgICAgaWYgYXR0ZW1wdCA9PSBtYXhfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIGV4CiAgICAKICAgICAgICAgICAgICAgICAgICBqYXZhLmxhbmcuVGhyZWFkLnNsZWVwKDMwMDApCiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkF0dGVtcHRpbmcgdG8gbG9hZCBtZXRhZGF0YTogJWQiICUgYXR0ZW1wdAogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIHNlbGYubWV0YURhdGFMb2FkZXJMb2NrLnVubG9jaygpCiAgICAgICAgICAgIAo=
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=92F0-BF9E,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Super Gluu authentication module
displayName: super_gluu
oxEnabled: false
inum: 92F0-BF9E
oxConfigurationProperty: {"value1":"qr_options","value2":"{ size: 500, mSize: 0.05 }","description":""}
oxConfigurationProperty: {"value1":"label","value2":"Super Gluu","description":""}
oxConfigurationProperty: {"value1":"registration_uri","value2":"https://instance-1.us-central1-a.c.nifty-canyon-287111.internal/identity/register","description":""}
oxConfigurationProperty: {"value1":"authentication_mode","value2":"two_step","description":""}
oxConfigurationProperty: {"value1":"notification_service_mode","value2":"gluu","description":""}
oxConfigurationProperty: {"value1":"credentials_file","value2":"/etc/certs/super_gluu_creds.json","description":""}
oxConfigurationProperty: {"value1":"supergluu_android_download_url","value2":"https://play.google.com/store/apps/details?id=gluu.org.super.gluu&hl=en_US","description":""}
oxConfigurationProperty: {"value1":"supergluu_ios_download_url","value2":"https://itunes.apple.com/us/app/super-gluu/id1093479646","description":""}
oxLevel: 60
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBjb20uZ29vZ2xlLmFuZHJvaWQuZ2NtLnNlcnZlciBpbXBvcnQgU2VuZGVyLCBNZXNzYWdlCmZyb20gY29tLm5vdG5vb3AuYXBucyBpbXBvcnQgQVBOUwpmcm9tIGphdmEudXRpbCBpbXBvcnQgQXJyYXlzCmZyb20gb3JnLmFwYWNoZS5odHRwLnBhcmFtcyBpbXBvcnQgQ29yZUNvbm5lY3Rpb25QTmFtZXMKZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlLmNkaS51dGlsIGltcG9ydCBDZGlVdGlsCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlY3VyaXR5IGltcG9ydCBJZGVudGl0eQpmcm9tIG9yZy5nbHV1Lm1vZGVsLmN1c3RvbS5zY3JpcHQudHlwZS5hdXRoIGltcG9ydCBQZXJzb25BdXRoZW50aWNhdGlvblR5cGUKZnJvbSBvcmcuZ2x1dS5veGF1dGgubW9kZWwuY29uZmlnIGltcG9ydCBDb25maWd1cmF0aW9uRmFjdG9yeQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlIGltcG9ydCBBdXRoZW50aWNhdGlvblNlcnZpY2UsIFNlc3Npb25JZFNlcnZpY2UKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5maWRvLnUyZiBpbXBvcnQgRGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlLm5ldCBpbXBvcnQgSHR0cFNlcnZpY2UKZnJvbSBvcmcuZ2x1dS5veGF1dGgudXRpbCBpbXBvcnQgU2VydmVyVXRpbApmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlcgpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlLmNvbW1vbiBpbXBvcnQgRW5jcnlwdGlvblNlcnZpY2UsIFVzZXJTZXJ2aWNlCmZyb20gb3JnLmdsdXUuc2VydmljZSBpbXBvcnQgTWFpbFNlcnZpY2UKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5wdXNoLnNucyBpbXBvcnQgUHVzaFBsYXRmb3JtLCBQdXNoU25zU2VydmljZSAKZnJvbSBvcmcuZ2x1dS5veG5vdGlmeS5jbGllbnQgaW1wb3J0IE5vdGlmeUNsaWVudEZhY3RvcnkgCmZyb20gamF2YS51dGlsIGltcG9ydCBBcnJheXMsIEhhc2hNYXAsIElkZW50aXR5SGFzaE1hcCwgRGF0ZQpmcm9tIGphdmEudGltZSBpbXBvcnQgWm9uZWREYXRlVGltZQpmcm9tIGphdmEudGltZS5mb3JtYXQgaW1wb3J0IERhdGVUaW1lRm9ybWF0dGVyCgp0cnk6CiAgICBmcm9tIG9yZy5nbHV1Lm94ZC5saWNlbnNlLmNsaWVudC5qcyBpbXBvcnQgUHJvZHVjdAogICAgZnJvbSBvcmcuZ2x1dS5veGQubGljZW5zZS52YWxpZGF0b3IgaW1wb3J0IExpY2Vuc2VWYWxpZGF0b3IKICAgIGhhc19saWNlbnNlX2FwaSA9IFRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgcHJpbnQgIlN1cGVyLUdsdXUuIExvYWQuIEZhaWxlZCB0byBsb2FkIGxpY2Vuc2luZyBBUEkiCiAgICBoYXNfbGljZW5zZV9hcGkgPSBGYWxzZQoKaW1wb3J0IGRhdGV0aW1lCmltcG9ydCB1cmxsaWIKCmltcG9ydCBzeXMKaW1wb3J0IGpzb24KCmNsYXNzIFBlcnNvbkF1dGhlbnRpY2F0aW9uKFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBJbml0aWFsaXphdGlvbiIKCiAgICAgICAgaWYgbm90IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJhdXRoZW50aWNhdGlvbl9tb2RlIik6CiAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBJbml0aWFsaXphdGlvbi4gUHJvcGVydHkgYXV0aGVudGljYXRpb25fbW9kZSBpcyBtYW5kYXRvcnkiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBzZWxmLmFwcGxpY2F0aW9uSWQgPSBOb25lCiAgICAgICAgaWYgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImFwcGxpY2F0aW9uX2lkIik6CiAgICAgICAgICAgIHNlbGYuYXBwbGljYXRpb25JZCA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiYXBwbGljYXRpb25faWQiKS5nZXRWYWx1ZTIoKQoKICAgICAgICBzZWxmLnJlZ2lzdHJhdGlvblVyaSA9IE5vbmUKICAgICAgICBpZiBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5jb250YWluc0tleSgicmVnaXN0cmF0aW9uX3VyaSIpOgogICAgICAgICAgICBzZWxmLnJlZ2lzdHJhdGlvblVyaSA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgicmVnaXN0cmF0aW9uX3VyaSIpLmdldFZhbHVlMigpCgogICAgICAgIGF1dGhlbnRpY2F0aW9uX21vZGUgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImF1dGhlbnRpY2F0aW9uX21vZGUiKS5nZXRWYWx1ZTIoKQogICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KGF1dGhlbnRpY2F0aW9uX21vZGUpOgogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gSW5pdGlhbGl6YXRpb24uIEZhaWxlZCB0byBkZXRlcm1pbmUgYXV0aGVudGljYXRpb25fbW9kZS4gYXV0aGVudGljYXRpb25fbW9kZSBjb25maWd1cmF0aW9uIHBhcmFtZXRlciBpcyBlbXB0eSIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgc2VsZi5vbmVTdGVwID0gU3RyaW5nSGVscGVyLmVxdWFsc0lnbm9yZUNhc2UoYXV0aGVudGljYXRpb25fbW9kZSwgIm9uZV9zdGVwIikKICAgICAgICBzZWxmLnR3b1N0ZXAgPSBTdHJpbmdIZWxwZXIuZXF1YWxzSWdub3JlQ2FzZShhdXRoZW50aWNhdGlvbl9tb2RlLCAidHdvX3N0ZXAiKQoKICAgICAgICBpZiBub3QgKHNlbGYub25lU3RlcCBvciBzZWxmLnR3b1N0ZXApOgogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gSW5pdGlhbGl6YXRpb24uIFZhbGlkIGF1dGhlbnRpY2F0aW9uX21vZGUgdmFsdWVzIGFyZSBvbmVfc3RlcCBhbmQgdHdvX3N0ZXAiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIHNlbGYuZW5hYmxlZFB1c2hOb3RpZmljYXRpb25zID0gc2VsZi5pbml0UHVzaE5vdGlmaWNhdGlvblNlcnZpY2UoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpCgogICAgICAgIHNlbGYuYW5kcm9pZFVybCA9IE5vbmUKICAgICAgICBpZiBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5jb250YWluc0tleSgic3VwZXJnbHV1X2FuZHJvaWRfZG93bmxvYWRfdXJsIik6CiAgICAgICAgICAgIHNlbGYuYW5kcm9pZFVybCA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgic3VwZXJnbHV1X2FuZHJvaWRfZG93bmxvYWRfdXJsIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgc2VsZi5JT1NVcmwgPSBOb25lCiAgICAgICAgaWYgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoInN1cGVyZ2x1dV9pb3NfZG93bmxvYWRfdXJsIik6CiAgICAgICAgICAgIHNlbGYuSU9TVXJsID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJzdXBlcmdsdXVfaW9zX2Rvd25sb2FkX3VybCIpLmdldFZhbHVlMigpCgogICAgICAgIHNlbGYuY3VzdG9tTGFiZWwgPSBOb25lCiAgICAgICAgaWYgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImxhYmVsIik6CiAgICAgICAgICAgIHNlbGYuY3VzdG9tTGFiZWwgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImxhYmVsIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgc2VsZi5jdXN0b21Rck9wdGlvbnMgPSB7fQogICAgICAgIGlmIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJxcl9vcHRpb25zIik6CiAgICAgICAgICAgIHNlbGYuY3VzdG9tUXJPcHRpb25zID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJxcl9vcHRpb25zIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgc2VsZi51c2Vfc3VwZXJfZ2x1dV9ncm91cCA9IEZhbHNlCiAgICAgICAgaWYgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoInN1cGVyX2dsdXVfZ3JvdXAiKToKICAgICAgICAgICAgc2VsZi5zdXBlcl9nbHV1X2dyb3VwID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJzdXBlcl9nbHV1X2dyb3VwIikuZ2V0VmFsdWUyKCkKICAgICAgICAgICAgc2VsZi51c2Vfc3VwZXJfZ2x1dV9ncm91cCA9IFRydWUKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemF0aW9uLiBVc2luZyBzdXBlcl9nbHV1IG9ubHkgaWYgdXNlciBiZWxvbmcgdG8gZ3JvdXA6ICVzIiAlIHNlbGYuc3VwZXJfZ2x1dV9ncm91cAoKICAgICAgICBzZWxmLnVzZV9hdWRpdF9ncm91cCA9IEZhbHNlCiAgICAgICAgaWYgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImF1ZGl0X2dyb3VwIik6CiAgICAgICAgICAgIHNlbGYuYXVkaXRfZ3JvdXAgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImF1ZGl0X2dyb3VwIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgICAgIGlmIChub3QgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImF1ZGl0X2dyb3VwX2VtYWlsIikpOgogICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemF0aW9uLiBQcm9wZXJ0eSBhdWRpdF9ncm91cF9lbWFpbCBpcyBub3Qgc3BlY2lmaWVkIgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBzZWxmLmF1ZGl0X2VtYWlsID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJhdWRpdF9ncm91cF9lbWFpbCIpLmdldFZhbHVlMigpCiAgICAgICAgICAgIHNlbGYudXNlX2F1ZGl0X2dyb3VwID0gVHJ1ZQoKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemF0aW9uLiBVc2luZyBhdWRpdCBncm91cDogJXMiICUgc2VsZi5hdWRpdF9ncm91cAogICAgICAgICAgICAKICAgICAgICBpZiBzZWxmLnVzZV9zdXBlcl9nbHV1X2dyb3VwIG9yIHNlbGYudXNlX2F1ZGl0X2dyb3VwOgogICAgICAgICAgICBpZiBub3QgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImF1ZGl0X2F0dHJpYnV0ZSIpOgogICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemF0aW9uLiBQcm9wZXJ0eSBhdWRpdF9hdHRyaWJ1dGUgaXMgbm90IHNwZWNpZmllZCIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5hdWRpdF9hdHRyaWJ1dGUgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImF1ZGl0X2F0dHJpYnV0ZSIpLmdldFZhbHVlMigpCgogICAgICAgIHNlbGYudmFsaWRfbGljZW5zZSA9IEZhbHNlCiAgICAgICAgIyBSZW1vdmluZyBvciBhbHRlcmluZyB0aGlzIGJsb2NrIHZhbGlkYXRpb24gaXMgYWdhaW5zdCB0aGUgdGVybXMgb2YgdGhlIGxpY2Vuc2UuIAogICAgICAgIGlmIGhhc19saWNlbnNlX2FwaSBhbmQgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImxpY2Vuc2VfZmlsZSIpOgogICAgICAgICAgICBsaWNlbnNlX2ZpbGUgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImxpY2Vuc2VfZmlsZSIpLmdldFZhbHVlMigpCgogICAgICAgICAgICAjIExvYWQgbGljZW5zZSBmcm9tIGZpbGUKICAgICAgICAgICAgZiA9IG9wZW4obGljZW5zZV9maWxlLCAncicpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxpY2Vuc2UgPSBqc29uLmxvYWRzKGYucmVhZCgpKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gSW5pdGlhbGl6YXRpb24uIEZhaWxlZCB0byBsb2FkIGxpY2Vuc2UgZnJvbSBmaWxlOiAlcyIgJSBsaWNlbnNlX2ZpbGUKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgZi5jbG9zZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZhbGlkYXRlIGxpY2Vuc2UKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5saWNlbnNlX2NvbnRlbnQgPSBMaWNlbnNlVmFsaWRhdG9yLnZhbGlkYXRlKGxpY2Vuc2VbInB1YmxpY19rZXkiXSwgbGljZW5zZVsicHVibGljX3Bhc3N3b3JkIl0sIGxpY2Vuc2VbImxpY2Vuc2VfcGFzc3dvcmQiXSwgbGljZW5zZVsibGljZW5zZSJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQcm9kdWN0LlNVUEVSX0dMVVUsIERhdGUoKSkKICAgICAgICAgICAgICAgIHNlbGYudmFsaWRfbGljZW5zZSA9IHNlbGYubGljZW5zZV9jb250ZW50LmlzVmFsaWQoKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gSW5pdGlhbGl6YXRpb24uIEZhaWxlZCB0byB2YWxpZGF0ZSBsaWNlbnNlLiBFeGNlcHRpb246ICIsIHN5cy5leGNfaW5mbygpWzFdCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBJbml0aWFsaXphdGlvbi4gTGljZW5zZSBzdGF0dXM6ICclcycuIExpY2Vuc2UgbWV0YWRhdGE6ICclcyciICUgKHNlbGYudmFsaWRfbGljZW5zZSwgc2VsZi5saWNlbnNlX2NvbnRlbnQuZ2V0TWV0YWRhdGEoKSkKCiAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseS4gb25lU3RlcDogJyVzJywgdHdvU3RlcDogJyVzJywgcHVzaE5vdGlmaWNhdGlvbnM6ICclcycsIGN1c3RvbUxhYmVsOiAnJXMnIiAlIChzZWxmLm9uZVN0ZXAsIHNlbGYudHdvU3RlcCwgc2VsZi5lbmFibGVkUHVzaE5vdGlmaWNhdGlvbnMsIHNlbGYuY3VzdG9tTGFiZWwpCgogICAgICAgIHJldHVybiBUcnVlICAgCgogICAgZGVmIGRlc3Ryb3koc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBEZXN0cm95IgoKICAgICAgICBzZWxmLnB1c2hBbmRyb2lkU2VydmljZSA9IE5vbmUKICAgICAgICBzZWxmLnB1c2hBcHBsZVNlcnZpY2UgPSBOb25lCgogICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBEZXN0cm95ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGdldEFwaVZlcnNpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIDExCiAgICAgICAgCiAgICBkZWYgZ2V0QXV0aGVudGljYXRpb25NZXRob2RDbGFpbXMoc2VsZiwgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHJldHVybiBOb25lCiAgICAgICAgCiAgICBkZWYgaXNWYWxpZEF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGdldEFsdGVybmF0aXZlQXV0aGVudGljYXRpb25NZXRob2Qoc2VsZiwgdXNhZ2VUeXBlLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgYXV0aGVudGljYXRlKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CiAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkKCiAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCiAgICAgICAgY3JlZGVudGlhbHMgPSBpZGVudGl0eS5nZXRDcmVkZW50aWFscygpCgogICAgICAgIHNlc3Npb25fYXR0cmlidXRlcyA9IGlkZW50aXR5LmdldFNlc3Npb25JZCgpLmdldFNlc3Npb25BdHRyaWJ1dGVzKCkKCiAgICAgICAgY2xpZW50X3JlZGlyZWN0X3VyaSA9IHNlbGYuZ2V0QXBwbGljYXRpb25Vcmkoc2Vzc2lvbl9hdHRyaWJ1dGVzKQogICAgICAgIGlmIGNsaWVudF9yZWRpcmVjdF91cmkgPT0gTm9uZToKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZS4gcmVkaXJlY3RfdXJpIGlzIG5vdCBzZXQiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBzZWxmLnNldFJlcXVlc3RTY29wZWRQYXJhbWV0ZXJzKGlkZW50aXR5LCBzdGVwKQoKICAgICAgICAjIFZhbGlkYXRlIGZvcm0gcmVzdWx0IGNvZGUgYW5kIGluaXRpYWxpemUgUVIgY29kZSByZWdlbmVyYXRpb24gaWYgbmVlZGVkIChyZXRyeV9jdXJyZW50X3N0ZXAgPSBUcnVlKQogICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInJldHJ5X2N1cnJlbnRfc3RlcCIsIEZhbHNlKQogICAgICAgIGZvcm1fYXV0aF9yZXN1bHQgPSBTZXJ2ZXJVdGlsLmdldEZpcnN0VmFsdWUocmVxdWVzdFBhcmFtZXRlcnMsICJhdXRoX3Jlc3VsdCIpCiAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzTm90RW1wdHkoZm9ybV9hdXRoX3Jlc3VsdCk6CiAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgJXMuIEdldCBhdXRoX3Jlc3VsdDogJyVzJyIgJSAoc3RlcCwgZm9ybV9hdXRoX3Jlc3VsdCkKICAgICAgICAgICAgaWYgZm9ybV9hdXRoX3Jlc3VsdCBpbiBbJ2Vycm9yJ106CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIGlmIGZvcm1fYXV0aF9yZXN1bHQgaW4gWyd0aW1lb3V0J106CiAgICAgICAgICAgICAgICBpZiAoKHN0ZXAgPT0gMSkgYW5kIHNlbGYub25lU3RlcCkgb3IgKChzdGVwID09IDIpIGFuZCBzZWxmLnR3b1N0ZXApOiAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAlcy4gUmVpbml0aWFsaXppbmcgY3VycmVudCBzdGVwIiAlIHN0ZXAKICAgICAgICAgICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJyZXRyeV9jdXJyZW50X3N0ZXAiLCBUcnVlKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkKICAgICAgICBkZXZpY2VSZWdpc3RyYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKERldmljZVJlZ2lzdHJhdGlvblNlcnZpY2UpCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gQXV0aGVudGljYXRlIGZvciBzdGVwIDEiCgogICAgICAgICAgICB1c2VyX25hbWUgPSBjcmVkZW50aWFscy5nZXRVc2VybmFtZSgpCiAgICAgICAgICAgIGlmIHNlbGYub25lU3RlcDoKICAgICAgICAgICAgICAgIHNlc3Npb25fZGV2aWNlX3N0YXR1cyA9IHNlbGYuZ2V0U2Vzc2lvbkRldmljZVN0YXR1cyhzZXNzaW9uX2F0dHJpYnV0ZXMsIHVzZXJfbmFtZSkKICAgICAgICAgICAgICAgIGlmIHNlc3Npb25fZGV2aWNlX3N0YXR1cyA9PSBOb25lOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgICAgIHUyZl9kZXZpY2VfaWQgPSBzZXNzaW9uX2RldmljZV9zdGF0dXNbJ2RldmljZV9pZCddCgogICAgICAgICAgICAgICAgdmFsaWRhdGlvbl9yZXN1bHQgPSBzZWxmLnZhbGlkYXRlU2Vzc2lvbkRldmljZVN0YXR1cyhjbGllbnRfcmVkaXJlY3RfdXJpLCBzZXNzaW9uX2RldmljZV9zdGF0dXMpCiAgICAgICAgICAgICAgICBpZiB2YWxpZGF0aW9uX3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gQXV0aGVudGljYXRlIGZvciBzdGVwIDEuIFVzZXIgc3VjY2Vzc2Z1bGx5IGF1dGhlbnRpY2F0ZWQgd2l0aCB1MmZfZGV2aWNlICclcyciICUgdTJmX2RldmljZV9pZAogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBzZXNzaW9uX2RldmljZV9zdGF0dXNbJ29uZV9zdGVwJ106CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiB1MmZfZGV2aWNlICclcycgaXMgbm90IG9uZSBzdGVwIGRldmljZSIgJSB1MmZfZGV2aWNlX2lkCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFRoZXJlIGFyZSB0d28gc3RlcHMgb25seSBpbiBlbnJvbGxtZW50IG1vZGUKICAgICAgICAgICAgICAgIGlmIHNlc3Npb25fZGV2aWNlX3N0YXR1c1snZW5yb2xsJ106CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRpb25fcmVzdWx0CgogICAgICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigic3VwZXJfZ2x1dV9jb3VudF9sb2dpbl9zdGVwcyIsIDEpCgogICAgICAgICAgICAgICAgdXNlcl9pbnVtID0gc2Vzc2lvbl9kZXZpY2Vfc3RhdHVzWyd1c2VyX2ludW0nXQoKICAgICAgICAgICAgICAgIHUyZl9kZXZpY2UgPSBkZXZpY2VSZWdpc3RyYXRpb25TZXJ2aWNlLmZpbmRVc2VyRGV2aWNlUmVnaXN0cmF0aW9uKHVzZXJfaW51bSwgdTJmX2RldmljZV9pZCwgIm94SWQiKQogICAgICAgICAgICAgICAgaWYgdTJmX2RldmljZSA9PSBOb25lOgogICAgICAgICAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMS4gRmFpbGVkIHRvIGxvYWQgdTJmX2RldmljZSAnJXMnIiAlIHUyZl9kZXZpY2VfaWQKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICAgICBsb2dnZWRfaW4gPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJfbmFtZSkKICAgICAgICAgICAgICAgIGlmIG5vdCBsb2dnZWRfaW46CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiBGYWlsZWQgdG8gYXV0aGVudGljYXRlIHVzZXIgJyVzJyIgJSB1c2VyX25hbWUKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gQXV0aGVudGljYXRlIGZvciBzdGVwIDEuIFVzZXIgJyVzJyBzdWNjZXNzZnVsbHkgYXV0aGVudGljYXRlZCB3aXRoIHUyZl9kZXZpY2UgJyVzJyIgJSAodXNlcl9uYW1lLCB1MmZfZGV2aWNlX2lkKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbGlmIHNlbGYudHdvU3RlcDoKICAgICAgICAgICAgICAgIGF1dGhlbnRpY2F0ZWRfdXNlciA9IHNlbGYucHJvY2Vzc0Jhc2ljQXV0aGVudGljYXRpb24oY3JlZGVudGlhbHMpCiAgICAgICAgICAgICAgICBpZiBhdXRoZW50aWNhdGVkX3VzZXIgPT0gTm9uZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi51c2Vfc3VwZXJfZ2x1dV9ncm91cCk6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiBDaGVja2luZyBpZiB1c2VyIGJlbG9uZyB0byBzdXBlcl9nbHV1IGdyb3VwIgogICAgICAgICAgICAgICAgICAgIGlzX21lbWJlcl9zdXBlcl9nbHV1X2dyb3VwID0gc2VsZi5pc1VzZXJNZW1iZXJPZkdyb3VwKGF1dGhlbnRpY2F0ZWRfdXNlciwgc2VsZi5hdWRpdF9hdHRyaWJ1dGUsIHNlbGYuc3VwZXJfZ2x1dV9ncm91cCkKICAgICAgICAgICAgICAgICAgICBpZiAoaXNfbWVtYmVyX3N1cGVyX2dsdXVfZ3JvdXApOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gQXV0aGVudGljYXRlIGZvciBzdGVwIDEuIFVzZXIgJyVzJyBtZW1iZXIgb2Ygc3VwZXJfZ2x1dSBncm91cCIgJSBhdXRoZW50aWNhdGVkX3VzZXIuZ2V0VXNlcklkKCkKICAgICAgICAgICAgICAgICAgICAgICAgc3VwZXJfZ2x1dV9jb3VudF9sb2dpbl9zdGVwcyA9IDIKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnVzZV9hdWRpdF9ncm91cDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHJvY2Vzc0F1ZGl0R3JvdXAoYXV0aGVudGljYXRlZF91c2VyLCBzZWxmLmF1ZGl0X2F0dHJpYnV0ZSwgc2VsZi5hdWRpdF9ncm91cCkKICAgICAgICAgICAgICAgICAgICAgICAgc3VwZXJfZ2x1dV9jb3VudF9sb2dpbl9zdGVwcyA9IDEKICAgIAogICAgICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInN1cGVyX2dsdXVfY291bnRfbG9naW5fc3RlcHMiLCBzdXBlcl9nbHV1X2NvdW50X2xvZ2luX3N0ZXBzKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIHN1cGVyX2dsdXVfY291bnRfbG9naW5fc3RlcHMgPT0gMToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgIAogICAgICAgICAgICAgICAgYXV0aF9tZXRob2QgPSAnYXV0aGVudGljYXRlJwogICAgICAgICAgICAgICAgZW5yb2xsbWVudF9tb2RlID0gU2VydmVyVXRpbC5nZXRGaXJzdFZhbHVlKHJlcXVlc3RQYXJhbWV0ZXJzLCAibG9naW5Gb3JtOnJlZ2lzdGVyQnV0dG9uIikKICAgICAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5KGVucm9sbG1lbnRfbW9kZSk6CiAgICAgICAgICAgICAgICAgICAgYXV0aF9tZXRob2QgPSAnZW5yb2xsJwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBhdXRoX21ldGhvZCA9PSAnYXV0aGVudGljYXRlJzoKICAgICAgICAgICAgICAgICAgICB1c2VyX2ludW0gPSB1c2VyU2VydmljZS5nZXRVc2VySW51bShhdXRoZW50aWNhdGVkX3VzZXIpCiAgICAgICAgICAgICAgICAgICAgdTJmX2RldmljZXNfbGlzdCA9IGRldmljZVJlZ2lzdHJhdGlvblNlcnZpY2UuZmluZFVzZXJEZXZpY2VSZWdpc3RyYXRpb25zKHVzZXJfaW51bSwgY2xpZW50X3JlZGlyZWN0X3VyaSwgIm94SWQiKQogICAgICAgICAgICAgICAgICAgIGlmIHUyZl9kZXZpY2VzX2xpc3Quc2l6ZSgpID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIGF1dGhfbWV0aG9kID0gJ2Vucm9sbCcKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiBUaGVyZSBpcyBubyBVMkYgJyVzJyB1c2VyIGRldmljZXMgYXNzb2NpYXRlZCB3aXRoIGFwcGxpY2F0aW9uICclcycuIENoYW5naW5nIGF1dGhfbWV0aG9kIHRvICclcyciICUgKHVzZXJfbmFtZSwgY2xpZW50X3JlZGlyZWN0X3VyaSwgYXV0aF9tZXRob2QpCiAgICAKICAgICAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMS4gYXV0aF9tZXRob2Q6ICclcyciICUgYXV0aF9tZXRob2QKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigic3VwZXJfZ2x1dV9hdXRoX21ldGhvZCIsIGF1dGhfbWV0aG9kKQoKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBlbGlmIHN0ZXAgPT0gMjoKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyIgoKICAgICAgICAgICAgdXNlciA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpCiAgICAgICAgICAgIGlmICh1c2VyID09IE5vbmUpOgogICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gZGV0ZXJtaW5lIHVzZXIgbmFtZSIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICB1c2VyX25hbWUgPSB1c2VyLmdldFVzZXJJZCgpCgogICAgICAgICAgICBzZXNzaW9uX2F0dHJpYnV0ZXMgPSBpZGVudGl0eS5nZXRTZXNzaW9uSWQoKS5nZXRTZXNzaW9uQXR0cmlidXRlcygpCgogICAgICAgICAgICBzZXNzaW9uX2RldmljZV9zdGF0dXMgPSBzZWxmLmdldFNlc3Npb25EZXZpY2VTdGF0dXMoc2Vzc2lvbl9hdHRyaWJ1dGVzLCB1c2VyX25hbWUpCiAgICAgICAgICAgIGlmIHNlc3Npb25fZGV2aWNlX3N0YXR1cyA9PSBOb25lOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICB1MmZfZGV2aWNlX2lkID0gc2Vzc2lvbl9kZXZpY2Vfc3RhdHVzWydkZXZpY2VfaWQnXQoKICAgICAgICAgICAgIyBUaGVyZSBhcmUgdHdvIHN0ZXBzIG9ubHkgaW4gZW5yb2xsbWVudCBtb2RlCiAgICAgICAgICAgIGlmIHNlbGYub25lU3RlcCBhbmQgc2Vzc2lvbl9kZXZpY2Vfc3RhdHVzWydlbnJvbGwnXToKICAgICAgICAgICAgICAgIGF1dGhlbnRpY2F0ZWRfdXNlciA9IHNlbGYucHJvY2Vzc0Jhc2ljQXV0aGVudGljYXRpb24oY3JlZGVudGlhbHMpCiAgICAgICAgICAgICAgICBpZiBhdXRoZW50aWNhdGVkX3VzZXIgPT0gTm9uZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICAgICB1c2VyX2ludW0gPSB1c2VyU2VydmljZS5nZXRVc2VySW51bShhdXRoZW50aWNhdGVkX3VzZXIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGF0dGFjaF9yZXN1bHQgPSBkZXZpY2VSZWdpc3RyYXRpb25TZXJ2aWNlLmF0dGFjaFVzZXJEZXZpY2VSZWdpc3RyYXRpb24odXNlcl9pbnVtLCB1MmZfZGV2aWNlX2lkKQoKICAgICAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBBdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gUmVzdWx0IGFmdGVyIGF0dGFjaGluZyB1MmZfZGV2aWNlICclcycgdG8gdXNlciAnJXMnOiAnJXMnIiAlICh1MmZfZGV2aWNlX2lkLCB1c2VyX25hbWUsIGF0dGFjaF9yZXN1bHQpIAoKICAgICAgICAgICAgICAgIHJldHVybiBhdHRhY2hfcmVzdWx0CiAgICAgICAgICAgIGVsaWYgc2VsZi50d29TdGVwOgogICAgICAgICAgICAgICAgaWYgdXNlcl9uYW1lID09IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gZGV0ZXJtaW5lIHVzZXIgbmFtZSIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICAgICB2YWxpZGF0aW9uX3Jlc3VsdCA9IHNlbGYudmFsaWRhdGVTZXNzaW9uRGV2aWNlU3RhdHVzKGNsaWVudF9yZWRpcmVjdF91cmksIHNlc3Npb25fZGV2aWNlX3N0YXR1cywgdXNlcl9uYW1lKQogICAgICAgICAgICAgICAgaWYgdmFsaWRhdGlvbl9yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBVc2VyICclcycgc3VjY2Vzc2Z1bGx5IGF1dGhlbnRpY2F0ZWQgd2l0aCB1MmZfZGV2aWNlICclcyciICUgKHVzZXJfbmFtZSwgdTJmX2RldmljZV9pZCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHN1cGVyX2dsdXVfcmVxdWVzdCA9IGpzb24ubG9hZHMoc2Vzc2lvbl9kZXZpY2Vfc3RhdHVzWydzdXBlcl9nbHV1X3JlcXVlc3QnXSkKICAgICAgICAgICAgICAgIGF1dGhfbWV0aG9kID0gc3VwZXJfZ2x1dV9yZXF1ZXN0WydtZXRob2QnXQogICAgICAgICAgICAgICAgaWYgYXV0aF9tZXRob2QgaW4gWydlbnJvbGwnLCAnYXV0aGVudGljYXRlJ106CiAgICAgICAgICAgICAgICAgICAgaWYgdmFsaWRhdGlvbl9yZXN1bHQgYW5kIHNlbGYudXNlX2F1ZGl0X2dyb3VwOgogICAgICAgICAgICAgICAgICAgICAgICB1c2VyID0gYXV0aGVudGljYXRpb25TZXJ2aWNlLmdldEF1dGhlbnRpY2F0ZWRVc2VyKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm9jZXNzQXVkaXRHcm91cCh1c2VyLCBzZWxmLmF1ZGl0X2F0dHJpYnV0ZSwgc2VsZi5hdWRpdF9ncm91cCkKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRpb25fcmVzdWx0CgogICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBVMkYgYXV0aF9tZXRob2QgaXMgaW52YWxpZCIKCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBwcmVwYXJlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQogICAgICAgIHNlc3Npb25fYXR0cmlidXRlcyA9IGlkZW50aXR5LmdldFNlc3Npb25JZCgpLmdldFNlc3Npb25BdHRyaWJ1dGVzKCkKCiAgICAgICAgY2xpZW50X3JlZGlyZWN0X3VyaSA9IHNlbGYuZ2V0QXBwbGljYXRpb25Vcmkoc2Vzc2lvbl9hdHRyaWJ1dGVzKQogICAgICAgIGlmIGNsaWVudF9yZWRpcmVjdF91cmkgPT0gTm9uZToKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFByZXBhcmUgZm9yIHN0ZXAuIHJlZGlyZWN0X3VyaSBpcyBub3Qgc2V0IgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgc2VsZi5zZXRSZXF1ZXN0U2NvcGVkUGFyYW1ldGVycyhpZGVudGl0eSwgc3RlcCkKCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gUHJlcGFyZSBmb3Igc3RlcCAxIgogICAgICAgICAgICBpZiBzZWxmLm9uZVN0ZXA6CiAgICAgICAgICAgICAgICBzZXNzaW9uID0gQ2RpVXRpbC5iZWFuKFNlc3Npb25JZFNlcnZpY2UpLmdldFNlc3Npb25JZCgpCiAgICAgICAgICAgICAgICBpZiBzZXNzaW9uID09IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFByZXBhcmUgZm9yIHN0ZXAgMi4gRmFpbGVkIHRvIGRldGVybWluZSBzZXNzaW9uX2lkIgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgICAgIGlzc3VlciA9IENkaVV0aWwuYmVhbihDb25maWd1cmF0aW9uRmFjdG9yeSkuZ2V0Q29uZmlndXJhdGlvbigpLmdldElzc3VlcigpCiAgICAgICAgICAgICAgICBzdXBlcl9nbHV1X3JlcXVlc3RfZGljdGlvbmFyeSA9IHsnYXBwJzogY2xpZW50X3JlZGlyZWN0X3VyaSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaXNzdWVyJzogaXNzdWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0ZSc6IHNlc3Npb24uZ2V0SWQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGljZW5zZWQnOiBzZWxmLnZhbGlkX2xpY2Vuc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NyZWF0ZWQnOiBEYXRlVGltZUZvcm1hdHRlci5JU09fT0ZGU0VUX0RBVEVfVElNRS5mb3JtYXQoWm9uZWREYXRlVGltZS5ub3coKS53aXRoTmFubygwKSl9CgogICAgICAgICAgICAgICAgc2VsZi5hZGRHZW9sb2NhdGlvbkRhdGEoc2Vzc2lvbl9hdHRyaWJ1dGVzLCBzdXBlcl9nbHV1X3JlcXVlc3RfZGljdGlvbmFyeSkKCiAgICAgICAgICAgICAgICBzdXBlcl9nbHV1X3JlcXVlc3QgPSBqc29uLmR1bXBzKHN1cGVyX2dsdXVfcmVxdWVzdF9kaWN0aW9uYXJ5LCBzZXBhcmF0b3JzPSgnLCcsJzonKSkKICAgICAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBQcmVwYXJlIGZvciBzdGVwIDEuIFByZXBhcmVkIHN1cGVyX2dsdXVfcmVxdWVzdDoiLCBzdXBlcl9nbHV1X3JlcXVlc3QKICAgIAogICAgICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigic3VwZXJfZ2x1dV9yZXF1ZXN0Iiwgc3VwZXJfZ2x1dV9yZXF1ZXN0KQogICAgICAgICAgICBlbGlmIHNlbGYudHdvU3RlcDoKICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImRpc3BsYXlfcmVnaXN0ZXJfYWN0aW9uIiwgVHJ1ZSkKCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxpZiBzdGVwID09IDI6CiAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBQcmVwYXJlIGZvciBzdGVwIDIiCiAgICAgICAgICAgIGlmIHNlbGYub25lU3RlcDoKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgICAgICBhdXRoZW50aWNhdGlvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oQXV0aGVudGljYXRpb25TZXJ2aWNlKQogICAgICAgICAgICB1c2VyID0gYXV0aGVudGljYXRpb25TZXJ2aWNlLmdldEF1dGhlbnRpY2F0ZWRVc2VyKCkKICAgICAgICAgICAgaWYgdXNlciA9PSBOb25lOgogICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFByZXBhcmUgZm9yIHN0ZXAgMi4gRmFpbGVkIHRvIGRldGVybWluZSB1c2VyIG5hbWUiCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIGlmIHNlc3Npb25fYXR0cmlidXRlcy5jb250YWluc0tleSgic3VwZXJfZ2x1dV9yZXF1ZXN0Iik6CiAgICAgICAgICAgICAgIHN1cGVyX2dsdXVfcmVxdWVzdCA9IHNlc3Npb25fYXR0cmlidXRlcy5nZXQoInN1cGVyX2dsdXVfcmVxdWVzdCIpCiAgICAgICAgICAgICAgIGlmIG5vdCBTdHJpbmdIZWxwZXIuZXF1YWxzSWdub3JlQ2FzZShzdXBlcl9nbHV1X3JlcXVlc3QsICJ0aW1lb3V0Iik6CiAgICAgICAgICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gUHJlcGFyZSBmb3Igc3RlcCAyLiBSZXF1ZXN0IHdhcyBnZW5lcmF0ZWQgYWxyZWFkeSIKICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICBzZXNzaW9uID0gQ2RpVXRpbC5iZWFuKFNlc3Npb25JZFNlcnZpY2UpLmdldFNlc3Npb25JZCgpCiAgICAgICAgICAgIGlmIHNlc3Npb24gPT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBQcmVwYXJlIGZvciBzdGVwIDIuIEZhaWxlZCB0byBkZXRlcm1pbmUgc2Vzc2lvbl9pZCIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgYXV0aF9tZXRob2QgPSBzZXNzaW9uX2F0dHJpYnV0ZXMuZ2V0KCJzdXBlcl9nbHV1X2F1dGhfbWV0aG9kIikKICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzRW1wdHkoYXV0aF9tZXRob2QpOgogICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFByZXBhcmUgZm9yIHN0ZXAgMi4gRmFpbGVkIHRvIGRldGVybWluZSBhdXRoX21ldGhvZCIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFByZXBhcmUgZm9yIHN0ZXAgMi4gYXV0aF9tZXRob2Q6ICclcyciICUgYXV0aF9tZXRob2QKICAgICAgICAgICAgCiAgICAgICAgICAgIGlzc3VlciA9IENkaVV0aWwuYmVhbihDb25maWd1cmF0aW9uRmFjdG9yeSkuZ2V0QXBwQ29uZmlndXJhdGlvbigpLmdldElzc3VlcigpCiAgICAgICAgICAgIHN1cGVyX2dsdXVfcmVxdWVzdF9kaWN0aW9uYXJ5ID0geyd1c2VybmFtZSc6IHVzZXIuZ2V0VXNlcklkKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXBwJzogY2xpZW50X3JlZGlyZWN0X3VyaSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpc3N1ZXInOiBpc3N1ZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWV0aG9kJzogYXV0aF9tZXRob2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3RhdGUnOiBzZXNzaW9uLmdldElkKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGljZW5zZWQnOiBzZWxmLnZhbGlkX2xpY2Vuc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY3JlYXRlZCc6IERhdGVUaW1lRm9ybWF0dGVyLklTT19PRkZTRVRfREFURV9USU1FLmZvcm1hdChab25lZERhdGVUaW1lLm5vdygpLndpdGhOYW5vKDApKX0KCiAgICAgICAgICAgIHNlbGYuYWRkR2VvbG9jYXRpb25EYXRhKHNlc3Npb25fYXR0cmlidXRlcywgc3VwZXJfZ2x1dV9yZXF1ZXN0X2RpY3Rpb25hcnkpCgogICAgICAgICAgICBzdXBlcl9nbHV1X3JlcXVlc3QgPSBqc29uLmR1bXBzKHN1cGVyX2dsdXVfcmVxdWVzdF9kaWN0aW9uYXJ5LCBzZXBhcmF0b3JzPSgnLCcsJzonKSkKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFByZXBhcmUgZm9yIHN0ZXAgMi4gUHJlcGFyZWQgc3VwZXJfZ2x1dV9yZXF1ZXN0OiIsIHN1cGVyX2dsdXVfcmVxdWVzdAoKICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigic3VwZXJfZ2x1dV9yZXF1ZXN0Iiwgc3VwZXJfZ2x1dV9yZXF1ZXN0KQogICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJzdXBlcl9nbHV1X2F1dGhfbWV0aG9kIiwgYXV0aF9tZXRob2QpCgogICAgICAgICAgICBpZiBhdXRoX21ldGhvZCBpbiBbJ2F1dGhlbnRpY2F0ZSddOgogICAgICAgICAgICAgICAgc2VsZi5zZW5kUHVzaE5vdGlmaWNhdGlvbihjbGllbnRfcmVkaXJlY3RfdXJpLCB1c2VyLCBzdXBlcl9nbHV1X3JlcXVlc3QpCgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBnZXROZXh0U3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgICMgSWYgdXNlciBub3QgcGFzcyBjdXJyZW50IHN0ZXAgY2hhbmdlIHN0ZXAgdG8gcHJldmlvdXMKICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKICAgICAgICByZXRyeV9jdXJyZW50X3N0ZXAgPSBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKCJyZXRyeV9jdXJyZW50X3N0ZXAiKQogICAgICAgIGlmIHJldHJ5X2N1cnJlbnRfc3RlcDoKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEdldCBuZXh0IHN0ZXAuIFJldHJ5aW5nIGN1cnJlbnQgc3RlcCIKCiAgICAgICAgICAgICMgUmVtb3ZlIG9sZCBRUiBjb2RlCiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInN1cGVyX2dsdXVfcmVxdWVzdCIsICJ0aW1lb3V0IikKCiAgICAgICAgICAgIHJlc3VsdFN0ZXAgPSBzdGVwCiAgICAgICAgICAgIHJldHVybiByZXN1bHRTdGVwCgogICAgICAgIHJldHVybiAtMQoKICAgIGRlZiBnZXRFeHRyYVBhcmFtZXRlcnNGb3JTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCBzdGVwKToKICAgICAgICBpZiBzdGVwID09IDE6CiAgICAgICAgICAgIGlmIHNlbGYub25lU3RlcDogICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5cy5hc0xpc3QoInN1cGVyX2dsdXVfcmVxdWVzdCIpCiAgICAgICAgICAgIGVsaWYgc2VsZi50d29TdGVwOgogICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5cy5hc0xpc3QoImRpc3BsYXlfcmVnaXN0ZXJfYWN0aW9uIikKICAgICAgICBlbGlmIHN0ZXAgPT0gMjoKICAgICAgICAgICAgcmV0dXJuIEFycmF5cy5hc0xpc3QoInN1cGVyX2dsdXVfYXV0aF9tZXRob2QiLCAic3VwZXJfZ2x1dV9yZXF1ZXN0IikKICAgICAgICAKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBnZXRDb3VudEF1dGhlbnRpY2F0aW9uU3RlcHMoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQogICAgICAgIGlmIGlkZW50aXR5LmlzU2V0V29ya2luZ1BhcmFtZXRlcigic3VwZXJfZ2x1dV9jb3VudF9sb2dpbl9zdGVwcyIpOgogICAgICAgICAgICByZXR1cm4gaWRlbnRpdHkuZ2V0V29ya2luZ1BhcmFtZXRlcigic3VwZXJfZ2x1dV9jb3VudF9sb2dpbl9zdGVwcyIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIDIKCiAgICBkZWYgZ2V0UGFnZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIGlmIHN0ZXAgPT0gMToKICAgICAgICAgICAgaWYgc2VsZi5vbmVTdGVwOiAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gIi9hdXRoL3N1cGVyLWdsdXUvbG9naW4ueGh0bWwiCiAgICAgICAgZWxpZiBzdGVwID09IDI6CiAgICAgICAgICAgIGlmIHNlbGYub25lU3RlcDoKICAgICAgICAgICAgICAgIHJldHVybiAiL2xvZ2luLnhodG1sIgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCiAgICAgICAgICAgICAgICBhdXRobWV0aG9kID0gaWRlbnRpdHkuZ2V0V29ya2luZ1BhcmFtZXRlcigic3VwZXJfZ2x1dV9hdXRoX21ldGhvZCIpCiAgICAgICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gYXV0aG1ldGhvZCAnJXMnIiAlIGF1dGhtZXRob2QKICAgICAgICAgICAgICAgIGlmIGF1dGhtZXRob2QgPT0gImVucm9sbCI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIvYXV0aC9zdXBlci1nbHV1L2xvZ2luLnhodG1sIgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIi9hdXRoL3N1cGVyLWdsdXUvbG9naW4ueGh0bWwiCgogICAgICAgIHJldHVybiAiIgoKICAgIGRlZiBnZXRMb2dvdXRFeHRlcm5hbFVybChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHByaW50ICJHZXQgZXh0ZXJuYWwgbG9nb3V0IFVSTCBjYWxsIgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGxvZ291dChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIHByb2Nlc3NCYXNpY0F1dGhlbnRpY2F0aW9uKHNlbGYsIGNyZWRlbnRpYWxzKToKICAgICAgICBhdXRoZW50aWNhdGlvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oQXV0aGVudGljYXRpb25TZXJ2aWNlKQoKICAgICAgICB1c2VyX25hbWUgPSBjcmVkZW50aWFscy5nZXRVc2VybmFtZSgpCiAgICAgICAgdXNlcl9wYXNzd29yZCA9IGNyZWRlbnRpYWxzLmdldFBhc3N3b3JkKCkKCiAgICAgICAgbG9nZ2VkX2luID0gRmFsc2UKICAgICAgICBpZiBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eVN0cmluZyh1c2VyX25hbWUpIGFuZCBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eVN0cmluZyh1c2VyX3Bhc3N3b3JkKToKICAgICAgICAgICAgbG9nZ2VkX2luID0gYXV0aGVudGljYXRpb25TZXJ2aWNlLmF1dGhlbnRpY2F0ZSh1c2VyX25hbWUsIHVzZXJfcGFzc3dvcmQpCgogICAgICAgIGlmIG5vdCBsb2dnZWRfaW46CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIGZpbmRfdXNlcl9ieV91aWQgPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuZ2V0QXV0aGVudGljYXRlZFVzZXIoKQogICAgICAgIGlmIGZpbmRfdXNlcl9ieV91aWQgPT0gTm9uZToKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFByb2Nlc3MgYmFzaWMgYXV0aGVudGljYXRpb24uIEZhaWxlZCB0byBmaW5kIHVzZXIgJyVzJyIgJSB1c2VyX25hbWUKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAKICAgICAgICByZXR1cm4gZmluZF91c2VyX2J5X3VpZAoKICAgIGRlZiB2YWxpZGF0ZVNlc3Npb25EZXZpY2VTdGF0dXMoc2VsZiwgY2xpZW50X3JlZGlyZWN0X3VyaSwgc2Vzc2lvbl9kZXZpY2Vfc3RhdHVzLCB1c2VyX25hbWUgPSBOb25lKToKICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkKICAgICAgICBkZXZpY2VSZWdpc3RyYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKERldmljZVJlZ2lzdHJhdGlvblNlcnZpY2UpCgogICAgICAgIHUyZl9kZXZpY2VfaWQgPSBzZXNzaW9uX2RldmljZV9zdGF0dXNbJ2RldmljZV9pZCddCgogICAgICAgIHUyZl9kZXZpY2UgPSBOb25lCiAgICAgICAgaWYgc2Vzc2lvbl9kZXZpY2Vfc3RhdHVzWydlbnJvbGwnXSBhbmQgc2Vzc2lvbl9kZXZpY2Vfc3RhdHVzWydvbmVfc3RlcCddOgogICAgICAgICAgICB1MmZfZGV2aWNlID0gZGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZS5maW5kT25lU3RlcFVzZXJEZXZpY2VSZWdpc3RyYXRpb24odTJmX2RldmljZV9pZCkKICAgICAgICAgICAgaWYgdTJmX2RldmljZSA9PSBOb25lOgogICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFZhbGlkYXRlIHNlc3Npb24gZGV2aWNlIHN0YXR1cy4gVGhlcmUgaXMgbm8gb25lIHN0ZXAgdTJmX2RldmljZSAnJXMnIiAlIHUyZl9kZXZpY2VfaWQKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgVmFsaWRhdGUgaWYgdXNlciBoYXMgc3BlY2lmaWVkIGRldmljZV9pZCBlbnJvbGxtZW50CiAgICAgICAgICAgIHVzZXJfaW51bSA9IHVzZXJTZXJ2aWNlLmdldFVzZXJJbnVtKHVzZXJfbmFtZSkKCiAgICAgICAgICAgIGlmIHNlc3Npb25fZGV2aWNlX3N0YXR1c1snb25lX3N0ZXAnXToKICAgICAgICAgICAgICAgIHVzZXJfaW51bSA9IHNlc3Npb25fZGV2aWNlX3N0YXR1c1sndXNlcl9pbnVtJ10KICAgIAogICAgICAgICAgICB1MmZfZGV2aWNlID0gZGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZS5maW5kVXNlckRldmljZVJlZ2lzdHJhdGlvbih1c2VyX2ludW0sIHUyZl9kZXZpY2VfaWQpCiAgICAgICAgICAgIGlmIHUyZl9kZXZpY2UgPT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBWYWxpZGF0ZSBzZXNzaW9uIGRldmljZSBzdGF0dXMuIFRoZXJlIGlzIG5vIHUyZl9kZXZpY2UgJyVzJyBhc3NvY2lhdGVkIHdpdGggdXNlciAnJXMnIiAlICh1MmZfZGV2aWNlX2lkLCB1c2VyX2ludW0pCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgaWYgbm90IFN0cmluZ0hlbHBlci5lcXVhbHNJZ25vcmVDYXNlKGNsaWVudF9yZWRpcmVjdF91cmksIHUyZl9kZXZpY2UuYXBwbGljYXRpb24pOgogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gVmFsaWRhdGUgc2Vzc2lvbiBkZXZpY2Ugc3RhdHVzLiB1MmZfZGV2aWNlICclcycgYXNzb2NpYXRlZCB3aXRoIG90aGVyIGFwcGxpY2F0aW9uICclcyciICUgKHUyZl9kZXZpY2VfaWQsIHUyZl9kZXZpY2UuYXBwbGljYXRpb24pCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGdldFNlc3Npb25EZXZpY2VTdGF0dXMoc2VsZiwgc2Vzc2lvbl9hdHRyaWJ1dGVzLCB1c2VyX25hbWUpOgogICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBHZXQgc2Vzc2lvbiBkZXZpY2Ugc3RhdHVzIgoKICAgICAgICBpZiBub3Qgc2Vzc2lvbl9hdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJzdXBlcl9nbHV1X3JlcXVlc3QiKToKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEdldCBzZXNzaW9uIGRldmljZSBzdGF0dXMuIFRoZXJlIGlzIG5vIFN1cGVyLUdsdXUgcmVxdWVzdCBpbiBzZXNzaW9uIGF0dHJpYnV0ZXMiCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICMgQ2hlY2sgc2Vzc2lvbiBzdGF0ZSBleHRlbmRlZAogICAgICAgIGlmIG5vdCBzZXNzaW9uX2F0dHJpYnV0ZXMuY29udGFpbnNLZXkoInNlc3Npb25fY3VzdG9tX3N0YXRlIik6CiAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBHZXQgc2Vzc2lvbiBkZXZpY2Ugc3RhdHVzLiBUaGVyZSBpcyBubyBzZXNzaW9uX2N1c3RvbV9zdGF0ZSBpbiBzZXNzaW9uIGF0dHJpYnV0ZXMiCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHNlc3Npb25fY3VzdG9tX3N0YXRlID0gc2Vzc2lvbl9hdHRyaWJ1dGVzLmdldCgic2Vzc2lvbl9jdXN0b21fc3RhdGUiKQogICAgICAgIGlmIG5vdCBTdHJpbmdIZWxwZXIuZXF1YWxzSWdub3JlQ2FzZSgiYXBwcm92ZWQiLCBzZXNzaW9uX2N1c3RvbV9zdGF0ZSk6CiAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBHZXQgc2Vzc2lvbiBkZXZpY2Ugc3RhdHVzLiBVc2VyICclcycgbm90IGFwcHJvdmUgb3Igbm90IHBhc3MgVTJGIGF1dGhlbnRpY2F0aW9uLiBzZXNzaW9uX2N1c3RvbV9zdGF0ZTogJyVzJyIgJSAodXNlcl9uYW1lLCBzZXNzaW9uX2N1c3RvbV9zdGF0ZSkKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgIyBUcnkgdG8gZmluZCBkZXZpY2VfaWQgaW4gc2Vzc2lvbiBhdHRyaWJ1dGUKICAgICAgICBpZiBub3Qgc2Vzc2lvbl9hdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJveHB1c2gyX3UyZl9kZXZpY2VfaWQiKToKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEdldCBzZXNzaW9uIGRldmljZSBzdGF0dXMuIFRoZXJlIGlzIG5vIHUyZl9kZXZpY2UgYXNzb2NpYXRlZCB3aXRoIHRoaXMgcmVxdWVzdCIKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgIyBUcnkgdG8gZmluZCB1c2VyX2ludW0gaW4gc2Vzc2lvbiBhdHRyaWJ1dGUKICAgICAgICBpZiBub3Qgc2Vzc2lvbl9hdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJveHB1c2gyX3UyZl9kZXZpY2VfdXNlcl9pbnVtIik6CiAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBHZXQgc2Vzc2lvbiBkZXZpY2Ugc3RhdHVzLiBUaGVyZSBpcyBubyB1c2VyX2ludW0gYXNzb2NpYXRlZCB3aXRoIHRoaXMgcmVxdWVzdCIKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAKICAgICAgICBlbnJvbGwgPSBGYWxzZQogICAgICAgIGlmIHNlc3Npb25fYXR0cmlidXRlcy5jb250YWluc0tleSgib3hwdXNoMl91MmZfZGV2aWNlX2Vucm9sbCIpOgogICAgICAgICAgICBlbnJvbGwgPSBTdHJpbmdIZWxwZXIuZXF1YWxzSWdub3JlQ2FzZSgidHJ1ZSIsIHNlc3Npb25fYXR0cmlidXRlcy5nZXQoIm94cHVzaDJfdTJmX2RldmljZV9lbnJvbGwiKSkKCiAgICAgICAgb25lX3N0ZXAgPSBGYWxzZQogICAgICAgIGlmIHNlc3Npb25fYXR0cmlidXRlcy5jb250YWluc0tleSgib3hwdXNoMl91MmZfZGV2aWNlX29uZV9zdGVwIik6CiAgICAgICAgICAgIG9uZV9zdGVwID0gU3RyaW5nSGVscGVyLmVxdWFsc0lnbm9yZUNhc2UoInRydWUiLCBzZXNzaW9uX2F0dHJpYnV0ZXMuZ2V0KCJveHB1c2gyX3UyZl9kZXZpY2Vfb25lX3N0ZXAiKSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgc3VwZXJfZ2x1dV9yZXF1ZXN0ID0gc2Vzc2lvbl9hdHRyaWJ1dGVzLmdldCgic3VwZXJfZ2x1dV9yZXF1ZXN0IikKICAgICAgICB1MmZfZGV2aWNlX2lkID0gc2Vzc2lvbl9hdHRyaWJ1dGVzLmdldCgib3hwdXNoMl91MmZfZGV2aWNlX2lkIikKICAgICAgICB1c2VyX2ludW0gPSBzZXNzaW9uX2F0dHJpYnV0ZXMuZ2V0KCJveHB1c2gyX3UyZl9kZXZpY2VfdXNlcl9pbnVtIikKCiAgICAgICAgc2Vzc2lvbl9kZXZpY2Vfc3RhdHVzID0geyJzdXBlcl9nbHV1X3JlcXVlc3QiOiBzdXBlcl9nbHV1X3JlcXVlc3QsICJkZXZpY2VfaWQiOiB1MmZfZGV2aWNlX2lkLCAidXNlcl9pbnVtIiA6IHVzZXJfaW51bSwgImVucm9sbCIgOiBlbnJvbGwsICJvbmVfc3RlcCIgOiBvbmVfc3RlcH0KICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gR2V0IHNlc3Npb24gZGV2aWNlIHN0YXR1cy4gc2Vzc2lvbl9kZXZpY2Vfc3RhdHVzOiAnJXMnIiAlIChzZXNzaW9uX2RldmljZV9zdGF0dXMpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHNlc3Npb25fZGV2aWNlX3N0YXR1cwoKICAgIGRlZiBpbml0UHVzaE5vdGlmaWNhdGlvblNlcnZpY2Uoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBJbml0aWFsaXplIE5hdGl2ZS9TTlMvR2x1dSBub3RpZmljYXRpb24gc2VydmljZXMiCgogICAgICAgIHNlbGYucHVzaFNuc01vZGUgPSBGYWxzZQogICAgICAgIHNlbGYucHVzaEdsdXVNb2RlID0gRmFsc2UKICAgICAgICBpZiBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5jb250YWluc0tleSgibm90aWZpY2F0aW9uX3NlcnZpY2VfbW9kZSIpOgogICAgICAgICAgICBub3RpZmljYXRpb25TZXJ2aWNlTW9kZSA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgibm90aWZpY2F0aW9uX3NlcnZpY2VfbW9kZSIpLmdldFZhbHVlMigpCiAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5lcXVhbHNJZ25vcmVDYXNlKG5vdGlmaWNhdGlvblNlcnZpY2VNb2RlLCAic25zIik6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5pbml0U25zUHVzaE5vdGlmaWNhdGlvblNlcnZpY2UoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpCiAgICAgICAgICAgIGVsaWYgU3RyaW5nSGVscGVyLmVxdWFsc0lnbm9yZUNhc2Uobm90aWZpY2F0aW9uU2VydmljZU1vZGUsICJnbHV1Iik6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5pbml0R2x1dVB1c2hOb3RpZmljYXRpb25TZXJ2aWNlKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKQoKICAgICAgICByZXR1cm4gc2VsZi5pbml0TmF0aXZlUHVzaE5vdGlmaWNhdGlvblNlcnZpY2UoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpCgogICAgZGVmIGluaXROYXRpdmVQdXNoTm90aWZpY2F0aW9uU2VydmljZShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemUgbmF0aXZlIG5vdGlmaWNhdGlvbiBzZXJ2aWNlcyIKICAgICAgICAKICAgICAgICBjcmVkcyA9IHNlbGYubG9hZFB1c2hOb3RpZmljYXRpb25DcmVkcyhjb25maWd1cmF0aW9uQXR0cmlidXRlcykKICAgICAgICBpZiBjcmVkcyA9PSBOb25lOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFuZHJvaWRfY3JlZHMgPSBjcmVkc1siYW5kcm9pZCJdWyJnY20iXQogICAgICAgICAgICBpb3NfY3JlZHMgPSBjcmVkc1siaW9zIl1bImFwbnMiXQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemUgbmF0aXZlIG5vdGlmaWNhdGlvbiBzZXJ2aWNlcy4gSW52YWxpZCBjcmVkZW50aWFscyBmaWxlIGZvcm1hdCIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgc2VsZi5wdXNoQW5kcm9pZFNlcnZpY2UgPSBOb25lCiAgICAgICAgc2VsZi5wdXNoQXBwbGVTZXJ2aWNlID0gTm9uZQogICAgICAgIGlmIGFuZHJvaWRfY3JlZHNbImVuYWJsZWQiXToKICAgICAgICAgICAgc2VsZi5wdXNoQW5kcm9pZFNlcnZpY2UgPSBTZW5kZXIoYW5kcm9pZF9jcmVkc1siYXBpX2tleSJdKSAKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemUgbmF0aXZlIG5vdGlmaWNhdGlvbiBzZXJ2aWNlcy4gQ3JlYXRlZCBBbmRyb2lkIG5vdGlmaWNhdGlvbiBzZXJ2aWNlIgogICAgICAgICAgICAKICAgICAgICBpZiBpb3NfY3JlZHNbImVuYWJsZWQiXToKICAgICAgICAgICAgcDEyX2ZpbGVfcGF0aCA9IGlvc19jcmVkc1sicDEyX2ZpbGVfcGF0aCJdCiAgICAgICAgICAgIHAxMl9wYXNzd29yZCA9IGlvc19jcmVkc1sicDEyX3Bhc3N3b3JkIl0KCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGVuY3J5cHRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEVuY3J5cHRpb25TZXJ2aWNlKQogICAgICAgICAgICAgICAgcDEyX3Bhc3N3b3JkID0gZW5jcnlwdGlvblNlcnZpY2UuZGVjcnlwdChwMTJfcGFzc3dvcmQpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICMgSWdub3JlIGV4Y2VwdGlvbi4gUGFzc3dvcmQgaXMgbm90IGVuY3J5cHRlZAogICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemUgbmF0aXZlIG5vdGlmaWNhdGlvbiBzZXJ2aWNlcy4gQXNzdW1pbmcgdGhhdCAncDEyX3Bhc3N3b3JkJyBwYXNzd29yZCBpbiBub3QgZW5jcnlwdGVkIgoKICAgICAgICAgICAgYXBuc1NlcnZpY2VCdWlsZGVyID0gIEFQTlMubmV3U2VydmljZSgpLndpdGhDZXJ0KHAxMl9maWxlX3BhdGgsIHAxMl9wYXNzd29yZCkKICAgICAgICAgICAgaWYgaW9zX2NyZWRzWyJwcm9kdWN0aW9uIl06CiAgICAgICAgICAgICAgICBzZWxmLnB1c2hBcHBsZVNlcnZpY2UgPSBhcG5zU2VydmljZUJ1aWxkZXIud2l0aFByb2R1Y3Rpb25EZXN0aW5hdGlvbigpLmJ1aWxkKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYucHVzaEFwcGxlU2VydmljZSA9IGFwbnNTZXJ2aWNlQnVpbGRlci53aXRoU2FuZGJveERlc3RpbmF0aW9uKCkuYnVpbGQoKQoKICAgICAgICAgICAgc2VsZi5wdXNoQXBwbGVTZXJ2aWNlUHJvZHVjdGlvbiA9IGlvc19jcmVkc1sicHJvZHVjdGlvbiJdCgogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gSW5pdGlhbGl6ZSBuYXRpdmUgbm90aWZpY2F0aW9uIHNlcnZpY2VzLiBDcmVhdGVkIGlPUyBub3RpZmljYXRpb24gc2VydmljZSIKCiAgICAgICAgZW5hYmxlZCA9IHNlbGYucHVzaEFuZHJvaWRTZXJ2aWNlICE9IE5vbmUgb3Igc2VsZi5wdXNoQXBwbGVTZXJ2aWNlICE9IE5vbmUKCiAgICAgICAgcmV0dXJuIGVuYWJsZWQKCiAgICBkZWYgaW5pdFNuc1B1c2hOb3RpZmljYXRpb25TZXJ2aWNlKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gSW5pdGlhbGl6ZSBTTlMgbm90aWZpY2F0aW9uIHNlcnZpY2VzIgogICAgICAgIHNlbGYucHVzaFNuc01vZGUgPSBUcnVlCgogICAgICAgIGNyZWRzID0gc2VsZi5sb2FkUHVzaE5vdGlmaWNhdGlvbkNyZWRzKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKQogICAgICAgIGlmIGNyZWRzID09IE5vbmU6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgc25zX2NyZWRzID0gY3JlZHNbInNucyJdCiAgICAgICAgICAgIGFuZHJvaWRfY3JlZHMgPSBjcmVkc1siYW5kcm9pZCJdWyJzbnMiXQogICAgICAgICAgICBpb3NfY3JlZHMgPSBjcmVkc1siaW9zIl1bInNucyJdCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gSW5pdGlhbGl6ZSBTTlMgbm90aWZpY2F0aW9uIHNlcnZpY2VzLiBJbnZhbGlkIGNyZWRlbnRpYWxzIGZpbGUgZm9ybWF0IgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICBzZWxmLnB1c2hBbmRyb2lkU2VydmljZSA9IE5vbmUKICAgICAgICBzZWxmLnB1c2hBcHBsZVNlcnZpY2UgPSBOb25lCiAgICAgICAgaWYgbm90IChhbmRyb2lkX2NyZWRzWyJlbmFibGVkIl0gb3IgaW9zX2NyZWRzWyJlbmFibGVkIl0pOgogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gSW5pdGlhbGl6ZSBTTlMgbm90aWZpY2F0aW9uIHNlcnZpY2VzLiBTTlMgZGlzYWJsZWQgZm9yIGFsbCBwbGF0Zm9ybXMiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBzbnNfYWNjZXNzX2tleSA9IHNuc19jcmVkc1siYWNjZXNzX2tleSJdCiAgICAgICAgc25zX3NlY3JldF9hY2Nlc3Nfa2V5ID0gc25zX2NyZWRzWyJzZWNyZXRfYWNjZXNzX2tleSJdCiAgICAgICAgc25zX3JlZ2lvbiA9IHNuc19jcmVkc1sicmVnaW9uIl0KCiAgICAgICAgZW5jcnlwdGlvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oRW5jcnlwdGlvblNlcnZpY2UpCgogICAgICAgIHRyeToKICAgICAgICAgICAgc25zX3NlY3JldF9hY2Nlc3Nfa2V5ID0gZW5jcnlwdGlvblNlcnZpY2UuZGVjcnlwdChzbnNfc2VjcmV0X2FjY2Vzc19rZXkpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAjIElnbm9yZSBleGNlcHRpb24uIFBhc3N3b3JkIGlzIG5vdCBlbmNyeXB0ZWQKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemUgU05TIG5vdGlmaWNhdGlvbiBzZXJ2aWNlcy4gQXNzdW1pbmcgdGhhdCAnc25zX3NlY3JldF9hY2Nlc3Nfa2V5JyBpbiBub3QgZW5jcnlwdGVkIgogICAgICAgIAogICAgICAgIHB1c2hTbnNTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFB1c2hTbnNTZXJ2aWNlKQogICAgICAgIHB1c2hDbGllbnQgPSBwdXNoU25zU2VydmljZS5jcmVhdGVTbnNDbGllbnQoc25zX2FjY2Vzc19rZXksIHNuc19zZWNyZXRfYWNjZXNzX2tleSwgc25zX3JlZ2lvbikKCiAgICAgICAgaWYgYW5kcm9pZF9jcmVkc1siZW5hYmxlZCJdOgogICAgICAgICAgICBzZWxmLnB1c2hBbmRyb2lkU2VydmljZSA9IHB1c2hDbGllbnQKICAgICAgICAgICAgc2VsZi5wdXNoQW5kcm9pZFBsYXRmb3JtQXJuID0gYW5kcm9pZF9jcmVkc1sicGxhdGZvcm1fYXJuIl0KICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemUgU05TIG5vdGlmaWNhdGlvbiBzZXJ2aWNlcy4gQ3JlYXRlZCBBbmRyb2lkIG5vdGlmaWNhdGlvbiBzZXJ2aWNlIgoKICAgICAgICBpZiBpb3NfY3JlZHNbImVuYWJsZWQiXToKICAgICAgICAgICAgc2VsZi5wdXNoQXBwbGVTZXJ2aWNlID0gcHVzaENsaWVudCAKICAgICAgICAgICAgc2VsZi5wdXNoQXBwbGVQbGF0Zm9ybUFybiA9IGlvc19jcmVkc1sicGxhdGZvcm1fYXJuIl0KICAgICAgICAgICAgc2VsZi5wdXNoQXBwbGVTZXJ2aWNlUHJvZHVjdGlvbiA9IGlvc19jcmVkc1sicHJvZHVjdGlvbiJdCiAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBJbml0aWFsaXplIFNOUyBub3RpZmljYXRpb24gc2VydmljZXMuIENyZWF0ZWQgaU9TIG5vdGlmaWNhdGlvbiBzZXJ2aWNlIgoKICAgICAgICBlbmFibGVkID0gc2VsZi5wdXNoQW5kcm9pZFNlcnZpY2UgIT0gTm9uZSBvciBzZWxmLnB1c2hBcHBsZVNlcnZpY2UgIT0gTm9uZQoKICAgICAgICByZXR1cm4gZW5hYmxlZAoKICAgIGRlZiBpbml0R2x1dVB1c2hOb3RpZmljYXRpb25TZXJ2aWNlKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gSW5pdGlhbGl6ZSBHbHV1IG5vdGlmaWNhdGlvbiBzZXJ2aWNlcyIKCiAgICAgICAgc2VsZi5wdXNoR2x1dU1vZGUgPSBUcnVlCgogICAgICAgIGNyZWRzID0gc2VsZi5sb2FkUHVzaE5vdGlmaWNhdGlvbkNyZWRzKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKQogICAgICAgIGlmIGNyZWRzID09IE5vbmU6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgZ2x1dV9jb25mID0gY3JlZHNbImdsdXUiXQogICAgICAgICAgICBhbmRyb2lkX2NyZWRzID0gY3JlZHNbImFuZHJvaWQiXVsiZ2x1dSJdCiAgICAgICAgICAgIGlvc19jcmVkcyA9IGNyZWRzWyJpb3MiXVsiZ2x1dSJdCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gSW5pdGlhbGl6ZSBHbHV1IG5vdGlmaWNhdGlvbiBzZXJ2aWNlcy4gSW52YWxpZCBjcmVkZW50aWFscyBmaWxlIGZvcm1hdCIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgc2VsZi5wdXNoQW5kcm9pZFNlcnZpY2UgPSBOb25lCiAgICAgICAgc2VsZi5wdXNoQXBwbGVTZXJ2aWNlID0gTm9uZQogICAgICAgIGlmIG5vdCAoYW5kcm9pZF9jcmVkc1siZW5hYmxlZCJdIG9yIGlvc19jcmVkc1siZW5hYmxlZCJdKToKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemUgR2x1dSBub3RpZmljYXRpb24gc2VydmljZXMuIEdsdXUgZGlzYWJsZWQgZm9yIGFsbCBwbGF0Zm9ybXMiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBnbHV1X3NlcnZlcl91cmkgPSBnbHV1X2NvbmZbInNlcnZlcl91cmkiXQogICAgICAgIG5vdGlmeUNsaWVudEZhY3RvcnkgPSBOb3RpZnlDbGllbnRGYWN0b3J5Lmluc3RhbmNlKCkKICAgICAgICBtZXRhZGF0YUNvbmZpZ3VyYXRpb24gPSBOb25lCiAgICAgICAgdHJ5OgogICAgICAgICAgICBtZXRhZGF0YUNvbmZpZ3VyYXRpb24gPSBub3RpZnlDbGllbnRGYWN0b3J5LmNyZWF0ZU1ldGFEYXRhQ29uZmlndXJhdGlvblNlcnZpY2UoZ2x1dV9zZXJ2ZXJfdXJpKS5nZXRNZXRhZGF0YUNvbmZpZ3VyYXRpb24oKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemUgR2x1dSBub3RpZmljYXRpb24gc2VydmljZXMuIEZhaWxlZCB0byBsb2FkIG1ldGFkYXRhLiBFeGNlcHRpb246ICIsIHN5cy5leGNfaW5mbygpWzFdCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBnbHV1Q2xpZW50ID0gbm90aWZ5Q2xpZW50RmFjdG9yeS5jcmVhdGVOb3RpZnlTZXJ2aWNlKG1ldGFkYXRhQ29uZmlndXJhdGlvbikKICAgICAgICBlbmNyeXB0aW9uU2VydmljZSA9IENkaVV0aWwuYmVhbihFbmNyeXB0aW9uU2VydmljZSkKCiAgICAgICAgaWYgYW5kcm9pZF9jcmVkc1siZW5hYmxlZCJdOgogICAgICAgICAgICBnbHV1X2FjY2Vzc19rZXkgPSBhbmRyb2lkX2NyZWRzWyJhY2Nlc3Nfa2V5Il0KICAgICAgICAgICAgZ2x1dV9zZWNyZXRfYWNjZXNzX2tleSA9IGFuZHJvaWRfY3JlZHNbInNlY3JldF9hY2Nlc3Nfa2V5Il0KICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBnbHV1X3NlY3JldF9hY2Nlc3Nfa2V5ID0gZW5jcnlwdGlvblNlcnZpY2UuZGVjcnlwdChnbHV1X3NlY3JldF9hY2Nlc3Nfa2V5KQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAjIElnbm9yZSBleGNlcHRpb24uIFBhc3N3b3JkIGlzIG5vdCBlbmNyeXB0ZWQKICAgICAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBJbml0aWFsaXplIEdsdXUgbm90aWZpY2F0aW9uIHNlcnZpY2VzLiBBc3N1bWluZyB0aGF0ICdnbHV1X3NlY3JldF9hY2Nlc3Nfa2V5JyBpbiBub3QgZW5jcnlwdGVkIgogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5wdXNoQW5kcm9pZFNlcnZpY2UgPSBnbHV1Q2xpZW50IAogICAgICAgICAgICBzZWxmLnB1c2hBbmRyb2lkU2VydmljZUF1dGggPSBub3RpZnlDbGllbnRGYWN0b3J5LmdldEF1dGhvcml6YXRpb24oZ2x1dV9hY2Nlc3Nfa2V5LCBnbHV1X3NlY3JldF9hY2Nlc3Nfa2V5KTsKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemUgR2x1dSBub3RpZmljYXRpb24gc2VydmljZXMuIENyZWF0ZWQgQW5kcm9pZCBub3RpZmljYXRpb24gc2VydmljZSIKCiAgICAgICAgaWYgaW9zX2NyZWRzWyJlbmFibGVkIl06CiAgICAgICAgICAgIGdsdXVfYWNjZXNzX2tleSA9IGlvc19jcmVkc1siYWNjZXNzX2tleSJdCiAgICAgICAgICAgIGdsdXVfc2VjcmV0X2FjY2Vzc19rZXkgPSBpb3NfY3JlZHNbInNlY3JldF9hY2Nlc3Nfa2V5Il0KICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBnbHV1X3NlY3JldF9hY2Nlc3Nfa2V5ID0gZW5jcnlwdGlvblNlcnZpY2UuZGVjcnlwdChnbHV1X3NlY3JldF9hY2Nlc3Nfa2V5KQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAjIElnbm9yZSBleGNlcHRpb24uIFBhc3N3b3JkIGlzIG5vdCBlbmNyeXB0ZWQKICAgICAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBJbml0aWFsaXplIEdsdXUgbm90aWZpY2F0aW9uIHNlcnZpY2VzLiBBc3N1bWluZyB0aGF0ICdnbHV1X3NlY3JldF9hY2Nlc3Nfa2V5JyBpbiBub3QgZW5jcnlwdGVkIgogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5wdXNoQXBwbGVTZXJ2aWNlID0gZ2x1dUNsaWVudCAKICAgICAgICAgICAgc2VsZi5wdXNoQXBwbGVTZXJ2aWNlQXV0aCA9IG5vdGlmeUNsaWVudEZhY3RvcnkuZ2V0QXV0aG9yaXphdGlvbihnbHV1X2FjY2Vzc19rZXksIGdsdXVfc2VjcmV0X2FjY2Vzc19rZXkpOwogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gSW5pdGlhbGl6ZSBHbHV1IG5vdGlmaWNhdGlvbiBzZXJ2aWNlcy4gQ3JlYXRlZCBpT1Mgbm90aWZpY2F0aW9uIHNlcnZpY2UiCgogICAgICAgIGVuYWJsZWQgPSBzZWxmLnB1c2hBbmRyb2lkU2VydmljZSAhPSBOb25lIG9yIHNlbGYucHVzaEFwcGxlU2VydmljZSAhPSBOb25lCgogICAgICAgIHJldHVybiBlbmFibGVkCgogICAgZGVmIGxvYWRQdXNoTm90aWZpY2F0aW9uQ3JlZHMoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBJbml0aWFsaXplIG5vdGlmaWNhdGlvbiBzZXJ2aWNlcyIKICAgICAgICBpZiBub3QgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImNyZWRlbnRpYWxzX2ZpbGUiKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgc3VwZXJfZ2x1dV9jcmVkc19maWxlID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJjcmVkZW50aWFsc19maWxlIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgIyBMb2FkIGNyZWRlbnRpYWxzIGZyb20gZmlsZQogICAgICAgIGYgPSBvcGVuKHN1cGVyX2dsdXVfY3JlZHNfZmlsZSwgJ3InKQogICAgICAgIHRyeToKICAgICAgICAgICAgY3JlZHMgPSBqc29uLmxvYWRzKGYucmVhZCgpKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEluaXRpYWxpemUgbm90aWZpY2F0aW9uIHNlcnZpY2VzLiBGYWlsZWQgdG8gbG9hZCBjcmVkZW50aWFscyBmcm9tIGZpbGU6Iiwgc3VwZXJfZ2x1dV9jcmVkc19maWxlCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgZi5jbG9zZSgpCgogICAgICAgIHJldHVybiBjcmVkcwoKICAgIGRlZiBzZW5kUHVzaE5vdGlmaWNhdGlvbihzZWxmLCBjbGllbnRfcmVkaXJlY3RfdXJpLCB1c2VyLCBzdXBlcl9nbHV1X3JlcXVlc3QpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5zZW5kUHVzaE5vdGlmaWNhdGlvbkltcGwoY2xpZW50X3JlZGlyZWN0X3VyaSwgdXNlciwgc3VwZXJfZ2x1dV9yZXF1ZXN0KQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFNlbmQgcHVzaCBub3RpZmljYXRpb24uIEZhaWxlZCB0byBzZW5kIHB1c2ggbm90aWZpY2F0aW9uOiAiLCBzeXMuZXhjX2luZm8oKVsxXQoKICAgIGRlZiBzZW5kUHVzaE5vdGlmaWNhdGlvbkltcGwoc2VsZiwgY2xpZW50X3JlZGlyZWN0X3VyaSwgdXNlciwgc3VwZXJfZ2x1dV9yZXF1ZXN0KToKICAgICAgICBpZiBub3Qgc2VsZi5lbmFibGVkUHVzaE5vdGlmaWNhdGlvbnM6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB1c2VyX25hbWUgPSB1c2VyLmdldFVzZXJJZCgpCiAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFNlbmQgcHVzaCBub3RpZmljYXRpb24uIExvYWRpbmcgdXNlciAnJXMnIGRldmljZXMiICUgdXNlcl9uYW1lCgogICAgICAgIHNlbmRfbm90aWZpY2F0aW9uID0gRmFsc2UKICAgICAgICBzZW5kX25vdGlmaWNhdGlvbl9yZXN1bHQgPSBUcnVlCgogICAgICAgIHVzZXJTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFVzZXJTZXJ2aWNlKQogICAgICAgIGRldmljZVJlZ2lzdHJhdGlvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oRGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZSkKCiAgICAgICAgdXNlcl9pbnVtID0gdXNlclNlcnZpY2UuZ2V0VXNlckludW0odXNlcl9uYW1lKQoKICAgICAgICBzZW5kX2FuZHJvaWQgPSAwCiAgICAgICAgc2VuZF9pb3MgPSAwCiAgICAgICAgdTJmX2RldmljZXNfbGlzdCA9IGRldmljZVJlZ2lzdHJhdGlvblNlcnZpY2UuZmluZFVzZXJEZXZpY2VSZWdpc3RyYXRpb25zKHVzZXJfaW51bSwgY2xpZW50X3JlZGlyZWN0X3VyaSwgIm94SWQiLCAib3hEZXZpY2VEYXRhIiwgIm94RGV2aWNlTm90aWZpY2F0aW9uQ29uZiIpCiAgICAgICAgaWYgdTJmX2RldmljZXNfbGlzdC5zaXplKCkgPiAwOgogICAgICAgICAgICBmb3IgdTJmX2RldmljZSBpbiB1MmZfZGV2aWNlc19saXN0OgogICAgICAgICAgICAgICAgZGV2aWNlX2RhdGEgPSB1MmZfZGV2aWNlLmdldERldmljZURhdGEoKQoKICAgICAgICAgICAgICAgICMgRGV2aWNlIGRhdGEgd2hpY2ggU3VwZXItR2x1dSBnZXRzIGR1cmluZyBlbnJvbGxtZW50CiAgICAgICAgICAgICAgICBpZiBkZXZpY2VfZGF0YSA9PSBOb25lOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgcGxhdGZvcm0gPSBkZXZpY2VfZGF0YS5nZXRQbGF0Zm9ybSgpCiAgICAgICAgICAgICAgICBwdXNoX3Rva2VuID0gZGV2aWNlX2RhdGEuZ2V0UHVzaFRva2VuKCkKICAgICAgICAgICAgICAgIGRlYnVnID0gRmFsc2UKCiAgICAgICAgICAgICAgICBpZiBTdHJpbmdIZWxwZXIuZXF1YWxzSWdub3JlQ2FzZShwbGF0Zm9ybSwgImlvcyIpIGFuZCBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eShwdXNoX3Rva2VuKToKICAgICAgICAgICAgICAgICAgICAjIFNlbmRpbmcgbm90aWZpY2F0aW9uIHRvIGlPUyB1c2VyJ3MgZGV2aWNlCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wdXNoQXBwbGVTZXJ2aWNlID09IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBTZW5kIHB1c2ggbm90aWZpY2F0aW9uLiBBcHBsZSBuYXRpdmUgcHVzaCBub3RpZmljYXRpb24gc2VydmljZSBpcyBub3QgZW5hYmxlZCIKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzZW5kX25vdGlmaWNhdGlvbiA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlID0gIlN1cGVyIEdsdXUiCiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSAiQ29uZmlybSB5b3VyIHNpZ24gaW4gcmVxdWVzdCB0bzogJXMiICUgY2xpZW50X3JlZGlyZWN0X3VyaQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wdXNoU25zTW9kZSBvciBzZWxmLnB1c2hHbHV1TW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1c2hTbnNTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFB1c2hTbnNTZXJ2aWNlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RW5kcG9pbnRBcm4gPSBzZWxmLmdldFRhcmdldEVuZHBvaW50QXJuKGRldmljZVJlZ2lzdHJhdGlvblNlcnZpY2UsIHB1c2hTbnNTZXJ2aWNlLCBQdXNoUGxhdGZvcm0uQVBOUywgdXNlciwgdTJmX2RldmljZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRhcmdldEVuZHBvaW50QXJuID09IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAJcmV0dXJuCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZF9ub3RpZmljYXRpb24gPSBUcnVlCiAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuc19wdXNoX3JlcXVlc3RfZGljdGlvbmFyeSA9IHsgImFwcyI6IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyAiYmFkZ2UiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYWxlcnQiIDogeyJib2R5IjogbWVzc2FnZSwgInRpdGxlIiA6IHRpdGxlfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNhdGVnb3J5IjogIkFDVElPTkFCTEUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY29udGVudC1hdmFpbGFibGUiOiAiMSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzb3VuZCI6ICdkZWZhdWx0JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVlc3QiIDogc3VwZXJfZ2x1dV9yZXF1ZXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdXNoX21lc3NhZ2UgPSBqc29uLmR1bXBzKHNuc19wdXNoX3JlcXVlc3RfZGljdGlvbmFyeSwgc2VwYXJhdG9ycz0oJywnLCc6JykpCiAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYucHVzaFNuc01vZGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGVfcHVzaF9wbGF0Zm9ybSA9IFB1c2hQbGF0Zm9ybS5BUE5TCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYucHVzaEFwcGxlU2VydmljZVByb2R1Y3Rpb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxlX3B1c2hfcGxhdGZvcm0gPSBQdXNoUGxhdGZvcm0uQVBOU19TQU5EQk9YCiAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZF9ub3RpZmljYXRpb25fcmVzdWx0ID0gcHVzaFNuc1NlcnZpY2Uuc2VuZFB1c2hNZXNzYWdlKHNlbGYucHVzaEFwcGxlU2VydmljZSwgYXBwbGVfcHVzaF9wbGF0Zm9ybSwgdGFyZ2V0RW5kcG9pbnRBcm4sIHB1c2hfbWVzc2FnZSwgTm9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkZWJ1ZzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFNlbmQgaU9TIFNOUyBwdXNoIG5vdGlmaWNhdGlvbi4gdG9rZW46ICclcycsIG1lc3NhZ2U6ICclcycsIHNlbmRfbm90aWZpY2F0aW9uX3Jlc3VsdDogJyVzJywgYXBwbGVfcHVzaF9wbGF0Zm9ybTogJyVzJyIgJSAocHVzaF90b2tlbiwgcHVzaF9tZXNzYWdlLCBzZW5kX25vdGlmaWNhdGlvbl9yZXN1bHQsIGFwcGxlX3B1c2hfcGxhdGZvcm0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGlmIHNlbGYucHVzaEdsdXVNb2RlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRfbm90aWZpY2F0aW9uX3Jlc3VsdCA9IHNlbGYucHVzaEFwcGxlU2VydmljZS5zZW5kTm90aWZpY2F0aW9uKHNlbGYucHVzaEFwcGxlU2VydmljZUF1dGgsIHRhcmdldEVuZHBvaW50QXJuLCBwdXNoX21lc3NhZ2UpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZGVidWc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBTZW5kIGlPUyBHbHV1IHB1c2ggbm90aWZpY2F0aW9uLiB0b2tlbjogJyVzJywgbWVzc2FnZTogJyVzJywgc2VuZF9ub3RpZmljYXRpb25fcmVzdWx0OiAnJXMnIiAlIChwdXNoX3Rva2VuLCBwdXNoX21lc3NhZ2UsIHNlbmRfbm90aWZpY2F0aW9uX3Jlc3VsdCkKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZGl0aW9uYWxfZmllbGRzID0geyAicmVxdWVzdCIgOiBzdXBlcl9nbHV1X3JlcXVlc3QgfQogICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2dCdWlsZGVyID0gQVBOUy5uZXdQYXlsb2FkKCkuYWxlcnRCb2R5KG1lc3NhZ2UpLmFsZXJ0VGl0bGUodGl0bGUpLnNvdW5kKCJkZWZhdWx0IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZ0J1aWxkZXIuY2F0ZWdvcnkoJ0FDVElPTkFCTEUnKS5iYWRnZSgwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnQnVpbGRlci5mb3JOZXdzc3RhbmQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnQnVpbGRlci5jdXN0b21GaWVsZHMoYWRkaXRpb25hbF9maWVsZHMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdXNoX21lc3NhZ2UgPSBtc2dCdWlsZGVyLmJ1aWxkKCkKICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZF9ub3RpZmljYXRpb25fcmVzdWx0ID0gc2VsZi5wdXNoQXBwbGVTZXJ2aWNlLnB1c2gocHVzaF90b2tlbiwgcHVzaF9tZXNzYWdlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZGVidWc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFNlbmQgaU9TIE5hdGl2ZSBwdXNoIG5vdGlmaWNhdGlvbi4gdG9rZW46ICclcycsIG1lc3NhZ2U6ICclcycsIHNlbmRfbm90aWZpY2F0aW9uX3Jlc3VsdDogJyVzJyIgJSAocHVzaF90b2tlbiwgcHVzaF9tZXNzYWdlLCBzZW5kX25vdGlmaWNhdGlvbl9yZXN1bHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRfaW9zID0gc2VuZF9pb3MgKyAxCgogICAgICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmVxdWFsc0lnbm9yZUNhc2UocGxhdGZvcm0sICJhbmRyb2lkIikgYW5kIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5KHB1c2hfdG9rZW4pOgogICAgICAgICAgICAgICAgICAgICMgU2VuZGluZyBub3RpZmljYXRpb24gdG8gQW5kcm9pZCB1c2VyJ3MgZGV2aWNlCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wdXNoQW5kcm9pZFNlcnZpY2UgPT0gTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFNlbmQgbmF0aXZlIHB1c2ggbm90aWZpY2F0aW9uLiBBbmRyb2lkIG5hdGl2ZSBwdXNoIG5vdGlmaWNhdGlvbiBzZXJ2aWNlIGlzIG5vdCBlbmFibGVkIgogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRfbm90aWZpY2F0aW9uID0gVHJ1ZQoKICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGUgPSAiU3VwZXItR2x1dSIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wdXNoU25zTW9kZSBvciBzZWxmLnB1c2hHbHV1TW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1c2hTbnNTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFB1c2hTbnNTZXJ2aWNlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RW5kcG9pbnRBcm4gPSBzZWxmLmdldFRhcmdldEVuZHBvaW50QXJuKGRldmljZVJlZ2lzdHJhdGlvblNlcnZpY2UsIHB1c2hTbnNTZXJ2aWNlLCBQdXNoUGxhdGZvcm0uR0NNLCB1c2VyLCB1MmZfZGV2aWNlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdGFyZ2V0RW5kcG9pbnRBcm4gPT0gTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAlyZXR1cm4KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kX25vdGlmaWNhdGlvbiA9IFRydWUKICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc25zX3B1c2hfcmVxdWVzdF9kaWN0aW9uYXJ5ID0geyAiY29sbGFwc2Vfa2V5IjogInNpbmdsZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb250ZW50X2F2YWlsYWJsZSI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lX3RvX2xpdmUiOiA2MCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRhdGEiOiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgIm1lc3NhZ2UiIDogc3VwZXJfZ2x1dV9yZXF1ZXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiIDogdGl0bGUgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVzaF9tZXNzYWdlID0ganNvbi5kdW1wcyhzbnNfcHVzaF9yZXF1ZXN0X2RpY3Rpb25hcnksIHNlcGFyYXRvcnM9KCcsJywnOicpKQogICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnB1c2hTbnNNb2RlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRfbm90aWZpY2F0aW9uX3Jlc3VsdCA9IHB1c2hTbnNTZXJ2aWNlLnNlbmRQdXNoTWVzc2FnZShzZWxmLnB1c2hBbmRyb2lkU2VydmljZSwgUHVzaFBsYXRmb3JtLkdDTSwgdGFyZ2V0RW5kcG9pbnRBcm4sIHB1c2hfbWVzc2FnZSwgTm9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkZWJ1ZzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFNlbmQgQW5kcm9pZCBTTlMgcHVzaCBub3RpZmljYXRpb24uIHRva2VuOiAnJXMnLCBtZXNzYWdlOiAnJXMnLCBzZW5kX25vdGlmaWNhdGlvbl9yZXN1bHQ6ICclcyciICUgKHB1c2hfdG9rZW4sIHB1c2hfbWVzc2FnZSwgc2VuZF9ub3RpZmljYXRpb25fcmVzdWx0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiBzZWxmLnB1c2hHbHV1TW9kZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kX25vdGlmaWNhdGlvbl9yZXN1bHQgPSBzZWxmLnB1c2hBbmRyb2lkU2VydmljZS5zZW5kTm90aWZpY2F0aW9uKHNlbGYucHVzaEFuZHJvaWRTZXJ2aWNlQXV0aCwgdGFyZ2V0RW5kcG9pbnRBcm4sIHB1c2hfbWVzc2FnZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkZWJ1ZzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFNlbmQgQW5kcm9pZCBHbHV1IHB1c2ggbm90aWZpY2F0aW9uLiB0b2tlbjogJyVzJywgbWVzc2FnZTogJyVzJywgc2VuZF9ub3RpZmljYXRpb25fcmVzdWx0OiAnJXMnIiAlIChwdXNoX3Rva2VuLCBwdXNoX21lc3NhZ2UsIHNlbmRfbm90aWZpY2F0aW9uX3Jlc3VsdCkKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZ0J1aWxkZXIgPSBNZXNzYWdlLkJ1aWxkZXIoKS5hZGREYXRhKCJtZXNzYWdlIiwgc3VwZXJfZ2x1dV9yZXF1ZXN0KS5hZGREYXRhKCJ0aXRsZSIsIHRpdGxlKS5jb2xsYXBzZUtleSgic2luZ2xlIikuY29udGVudEF2YWlsYWJsZShUcnVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVzaF9tZXNzYWdlID0gbXNnQnVpbGRlci5idWlsZCgpCiAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRfbm90aWZpY2F0aW9uX3Jlc3VsdCA9IHNlbGYucHVzaEFuZHJvaWRTZXJ2aWNlLnNlbmQocHVzaF9tZXNzYWdlLCBwdXNoX3Rva2VuLCAzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZGVidWc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIFNlbmQgQW5kcm9pZCBOYXRpdmUgcHVzaCBub3RpZmljYXRpb24uIHRva2VuOiAnJXMnLCBtZXNzYWdlOiAnJXMnLCBzZW5kX25vdGlmaWNhdGlvbl9yZXN1bHQ6ICclcyciICUgKHB1c2hfdG9rZW4sIHB1c2hfbWVzc2FnZSwgc2VuZF9ub3RpZmljYXRpb25fcmVzdWx0KQogICAgICAgICAgICAgICAgICAgICAgICBzZW5kX2FuZHJvaWQgPSBzZW5kX2FuZHJvaWQgKyAxCgogICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBTZW5kIHB1c2ggbm90aWZpY2F0aW9uLiBzZW5kX2FuZHJvaWQ6ICclcycsIHNlbmRfaW9zOiAnJXMnIiAlIChzZW5kX2FuZHJvaWQsIHNlbmRfaW9zKQoKICAgIGRlZiBnZXRUYXJnZXRFbmRwb2ludEFybihzZWxmLCBkZXZpY2VSZWdpc3RyYXRpb25TZXJ2aWNlLCBwdXNoU25zU2VydmljZSwgcGxhdGZvcm0sIHVzZXIsIHUyZkRldmljZSk6CiAgICAgICAgdGFyZ2V0RW5kcG9pbnRBcm4gPSBOb25lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgIyBSZXR1cm4gZW5kcG9pbnQgQVJOIGlmIGl0IGNyZWF0ZWQgYWxyZWFkeQogICAgICAgIG5vdGlmaWNhdGlvbkNvbmYgPSB1MmZEZXZpY2UuZ2V0RGV2aWNlTm90aWZpY2F0aW9uQ29uZigpCiAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzTm90RW1wdHkobm90aWZpY2F0aW9uQ29uZik6CiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbmZKc29uID0ganNvbi5sb2Fkcyhub3RpZmljYXRpb25Db25mKQogICAgICAgICAgICB0YXJnZXRFbmRwb2ludEFybiA9IG5vdGlmaWNhdGlvbkNvbmZKc29uWydzbnNfZW5kcG9pbnRfYXJuJ10KICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzTm90RW1wdHkodGFyZ2V0RW5kcG9pbnRBcm4pOgogICAgICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEdldCB0YXJnZXQgZW5kcG9pbnQgQVJOLiBUaGVyZSBpcyBhbHJlYWR5IGNyZWF0ZWQgdGFyZ2V0IGVuZHBvaW50IEFSTiIKICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRFbmRwb2ludEFybgoKICAgICAgICAjIENyZWF0ZSBlbmRwb2ludCBBUk4gICAgICAgIAogICAgICAgIHB1c2hDbGllbnQgPSBOb25lCiAgICAgICAgcHVzaENsaWVudEF1dGggPSBOb25lCiAgICAgICAgcGxhdGZvcm1BcHBsaWNhdGlvbkFybiA9IE5vbmUKICAgICAgICBpZiBwbGF0Zm9ybSA9PSBQdXNoUGxhdGZvcm0uR0NNOgogICAgICAgICAgICBwdXNoQ2xpZW50ID0gc2VsZi5wdXNoQW5kcm9pZFNlcnZpY2UKICAgICAgICAgICAgaWYgc2VsZi5wdXNoU25zTW9kZToKICAgICAgICAgICAgICAgIHBsYXRmb3JtQXBwbGljYXRpb25Bcm4gPSBzZWxmLnB1c2hBbmRyb2lkUGxhdGZvcm1Bcm4KICAgICAgICAgICAgaWYgc2VsZi5wdXNoR2x1dU1vZGU6CiAgICAgICAgICAgICAgICBwdXNoQ2xpZW50QXV0aCA9IHNlbGYucHVzaEFuZHJvaWRTZXJ2aWNlQXV0aAogICAgICAgIGVsaWYgcGxhdGZvcm0gPT0gUHVzaFBsYXRmb3JtLkFQTlM6CiAgICAgICAgICAgIHB1c2hDbGllbnQgPSBzZWxmLnB1c2hBcHBsZVNlcnZpY2UKICAgICAgICAgICAgaWYgc2VsZi5wdXNoU25zTW9kZToKICAgICAgICAgICAgICAgIHBsYXRmb3JtQXBwbGljYXRpb25Bcm4gPSBzZWxmLnB1c2hBcHBsZVBsYXRmb3JtQXJuCiAgICAgICAgICAgIGlmIHNlbGYucHVzaEdsdXVNb2RlOgogICAgICAgICAgICAgICAgcHVzaENsaWVudEF1dGggPSBzZWxmLnB1c2hBcHBsZVNlcnZpY2VBdXRoCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgZGV2aWNlRGF0YSA9IHUyZkRldmljZS5nZXREZXZpY2VEYXRhKCkKICAgICAgICBwdXNoVG9rZW4gPSBkZXZpY2VEYXRhLmdldFB1c2hUb2tlbigpCiAgICAgICAgCiAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEdldCB0YXJnZXQgZW5kcG9pbnQgQVJOLiBBdHRlbXB0aW5nIHRvIGNyZWF0ZSB0YXJnZXQgZW5kcG9pbnQgQVJOIGZvciB1c2VyOiAnJXMnIiAlIHVzZXIuZ2V0VXNlcklkKCkKICAgICAgICBpZiBzZWxmLnB1c2hTbnNNb2RlOgogICAgICAgICAgICB0YXJnZXRFbmRwb2ludEFybiA9IHB1c2hTbnNTZXJ2aWNlLmNyZWF0ZVBsYXRmb3JtQXJuKHB1c2hDbGllbnQsIHBsYXRmb3JtQXBwbGljYXRpb25Bcm4sIHB1c2hUb2tlbiwgdXNlcikKICAgICAgICBlbHNlOgogICAgICAgICAgICBjdXN0b21Vc2VyRGF0YSA9IHB1c2hTbnNTZXJ2aWNlLmdldEN1c3RvbVVzZXJEYXRhKHVzZXIpCiAgICAgICAgICAgIHJlZ2lzdGVyRGV2aWNlUmVzcG9uc2UgPSBwdXNoQ2xpZW50LnJlZ2lzdGVyRGV2aWNlKHB1c2hDbGllbnRBdXRoLCBwdXNoVG9rZW4sIGN1c3RvbVVzZXJEYXRhKTsKICAgICAgICAgICAgaWYgcmVnaXN0ZXJEZXZpY2VSZXNwb25zZSAhPSBOb25lIGFuZCByZWdpc3RlckRldmljZVJlc3BvbnNlLmdldFN0YXR1c0NvZGUoKSA9PSAyMDA6CiAgICAgICAgICAgICAgICB0YXJnZXRFbmRwb2ludEFybiA9IHJlZ2lzdGVyRGV2aWNlUmVzcG9uc2UuZ2V0RW5kcG9pbnRBcm4oKQogICAgICAgIAogICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KHRhcmdldEVuZHBvaW50QXJuKToKCSAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEZhaWxlZCB0byBnZXQgZW5kcG9pbnQgQVJOIGZvciB1c2VyOiAnJXMnIiAlIHVzZXIuZ2V0VXNlcklkKCkKICAgICAgICAJcmV0dXJuIE5vbmUKCiAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEdldCB0YXJnZXQgZW5kcG9pbnQgQVJOLiBDcmVhdGUgdGFyZ2V0IGVuZHBvaW50IEFSTiAnJXMnIGZvciB1c2VyOiAnJXMnIiAlICh0YXJnZXRFbmRwb2ludEFybiwgdXNlci5nZXRVc2VySWQoKSkKICAgICAgICAKICAgICAgICAjIFN0b3JlIGNyZWF0ZWQgZW5kcG9pbnQgQVJOIGluIGRldmljZSBlbnRyeQogICAgICAgIHVzZXJJbnVtID0gdXNlci5nZXRBdHRyaWJ1dGUoImludW0iKQogICAgICAgIHUyZkRldmljZVVwZGF0ZSA9IGRldmljZVJlZ2lzdHJhdGlvblNlcnZpY2UuZmluZFVzZXJEZXZpY2VSZWdpc3RyYXRpb24odXNlckludW0sIHUyZkRldmljZS5nZXRJZCgpKQogICAgICAgIHUyZkRldmljZVVwZGF0ZS5zZXREZXZpY2VOb3RpZmljYXRpb25Db25mKCd7InNuc19lbmRwb2ludF9hcm4iIDogIiVzIn0nICUgdGFyZ2V0RW5kcG9pbnRBcm4pCiAgICAgICAgZGV2aWNlUmVnaXN0cmF0aW9uU2VydmljZS51cGRhdGVEZXZpY2VSZWdpc3RyYXRpb24odXNlckludW0sIHUyZkRldmljZVVwZGF0ZSkKCiAgICAgICAgcmV0dXJuIHRhcmdldEVuZHBvaW50QXJuCgogICAgZGVmIGdldEFwcGxpY2F0aW9uVXJpKHNlbGYsIHNlc3Npb25fYXR0cmlidXRlcyk6CiAgICAgICAgaWYgc2VsZi5hcHBsaWNhdGlvbklkICE9IE5vbmU6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmFwcGxpY2F0aW9uSWQKICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IHNlc3Npb25fYXR0cmlidXRlcy5jb250YWluc0tleSgicmVkaXJlY3RfdXJpIik6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHJldHVybiBzZXNzaW9uX2F0dHJpYnV0ZXMuZ2V0KCJyZWRpcmVjdF91cmkiKQoKICAgIGRlZiBzZXRSZXF1ZXN0U2NvcGVkUGFyYW1ldGVycyhzZWxmLCBpZGVudGl0eSwgc3RlcCk6CiAgICAgICAgZG93bmxvYWRNYXAgPSBIYXNoTWFwKCkKICAgICAgICBpZiBzZWxmLnJlZ2lzdHJhdGlvblVyaSAhPSBOb25lOgogICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJleHRlcm5hbF9yZWdpc3RyYXRpb25fdXJpIiwgc2VsZi5yZWdpc3RyYXRpb25VcmkpCgogICAgICAgIGlmIHNlbGYuYW5kcm9pZFVybCE9IE5vbmUgYW5kIHN0ZXAgPT0gMToKICAgICAgICAgICAgZG93bmxvYWRNYXAucHV0KCJhbmRyb2lkIiwgc2VsZi5hbmRyb2lkVXJsKQoKICAgICAgICBpZiBzZWxmLklPU1VybCAgIT0gTm9uZSBhbmQgc3RlcCA9PSAxOgogICAgICAgICAgICBkb3dubG9hZE1hcC5wdXQoImlvcyIsIHNlbGYuSU9TVXJsKQogICAgICAgICAgICAKICAgICAgICBpZiBzZWxmLmN1c3RvbUxhYmVsICE9IE5vbmU6CiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInN1cGVyX2dsdXVfbGFiZWwiLCBzZWxmLmN1c3RvbUxhYmVsKQogICAgICAgICAgICAKICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJkb3dubG9hZF91cmwiLCBkb3dubG9hZE1hcCkKICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJzdXBlcl9nbHV1X3FyX29wdGlvbnMiLCBzZWxmLmN1c3RvbVFyT3B0aW9ucykKCiAgICBkZWYgYWRkR2VvbG9jYXRpb25EYXRhKHNlbGYsIHNlc3Npb25fYXR0cmlidXRlcywgc3VwZXJfZ2x1dV9yZXF1ZXN0X2RpY3Rpb25hcnkpOgogICAgICAgIGlmIHNlc3Npb25fYXR0cmlidXRlcy5jb250YWluc0tleSgicmVtb3RlX2lwIik6CiAgICAgICAgICAgIHJlbW90ZV9pcCA9IHNlc3Npb25fYXR0cmlidXRlcy5nZXQoInJlbW90ZV9pcCIpCiAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5KHJlbW90ZV9pcCk6CiAgICAgICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gUHJlcGFyZSBmb3Igc3RlcCAyLiBBZGRpbmcgcmVxX2lwIGFuZCByZXFfbG9jIHRvIHN1cGVyX2dsdXVfcmVxdWVzdCIKICAgICAgICAgICAgICAgIHN1cGVyX2dsdXVfcmVxdWVzdF9kaWN0aW9uYXJ5WydyZXFfaXAnXSA9IHJlbW90ZV9pcAoKICAgICAgICAgICAgICAgIHJlbW90ZV9sb2NfZGljID0gc2VsZi5kZXRlcm1pbmVHZW9sb2NhdGlvbkRhdGEocmVtb3RlX2lwKQogICAgICAgICAgICAgICAgaWYgcmVtb3RlX2xvY19kaWMgPT0gTm9uZToKICAgICAgICAgICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gUHJlcGFyZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gZGV0ZXJtaW5lIHJlbW90ZSBsb2NhdGlvbiBieSByZW1vdGUgSVAgJyVzJyIgJSByZW1vdGVfaXAKICAgICAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgICAgICByZW1vdGVfbG9jID0gIiVzLCAlcywgJXMiICUgKCByZW1vdGVfbG9jX2RpY1snY291bnRyeSddLCByZW1vdGVfbG9jX2RpY1sncmVnaW9uTmFtZSddLCByZW1vdGVfbG9jX2RpY1snY2l0eSddICkKICAgICAgICAgICAgICAgIHJlbW90ZV9sb2NfZW5jb2RlZCA9IHVybGxpYi5xdW90ZShyZW1vdGVfbG9jLmVuY29kZSgndXRmLTgnKSkKICAgICAgICAgICAgICAgIHN1cGVyX2dsdXVfcmVxdWVzdF9kaWN0aW9uYXJ5WydyZXFfbG9jJ10gPSByZW1vdGVfbG9jX2VuY29kZWQKCiAgICBkZWYgZGV0ZXJtaW5lR2VvbG9jYXRpb25EYXRhKHNlbGYsIHJlbW90ZV9pcCk6CiAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIERldGVybWluZSByZW1vdGUgbG9jYXRpb24uIHJlbW90ZV9pcDogJyVzJyIgJSByZW1vdGVfaXAKICAgICAgICBodHRwU2VydmljZSA9IENkaVV0aWwuYmVhbihIdHRwU2VydmljZSkKCiAgICAgICAgaHR0cF9jbGllbnQgPSBodHRwU2VydmljZS5nZXRIdHRwc0NsaWVudCgpCiAgICAgICAgaHR0cF9jbGllbnRfcGFyYW1zID0gaHR0cF9jbGllbnQuZ2V0UGFyYW1zKCkKICAgICAgICBodHRwX2NsaWVudF9wYXJhbXMuc2V0SW50UGFyYW1ldGVyKENvcmVDb25uZWN0aW9uUE5hbWVzLkNPTk5FQ1RJT05fVElNRU9VVCwgMTUgKiAxMDAwKQogICAgICAgIAogICAgICAgIGdlb2xvY2F0aW9uX3NlcnZpY2VfdXJsID0gImh0dHA6Ly9pcC1hcGkuY29tL2pzb24vJXM/ZmllbGRzPTQ5MTc3IiAlIHJlbW90ZV9pcAogICAgICAgIGdlb2xvY2F0aW9uX3NlcnZpY2VfaGVhZGVycyA9IHsgIkFjY2VwdCIgOiAiYXBwbGljYXRpb24vanNvbiIgfQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGh0dHBfc2VydmljZV9yZXNwb25zZSA9IGh0dHBTZXJ2aWNlLmV4ZWN1dGVHZXQoaHR0cF9jbGllbnQsIGdlb2xvY2F0aW9uX3NlcnZpY2VfdXJsLCAgZ2VvbG9jYXRpb25fc2VydmljZV9oZWFkZXJzKQogICAgICAgICAgICBodHRwX3Jlc3BvbnNlID0gaHR0cF9zZXJ2aWNlX3Jlc3BvbnNlLmdldEh0dHBSZXNwb25zZSgpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gRGV0ZXJtaW5lIHJlbW90ZSBsb2NhdGlvbi4gRXhjZXB0aW9uOiAiLCBzeXMuZXhjX2luZm8oKVsxXQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG5vdCBodHRwU2VydmljZS5pc1Jlc3BvbnNlU3Rhc3R1c0NvZGVPayhodHRwX3Jlc3BvbnNlKToKICAgICAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBEZXRlcm1pbmUgcmVtb3RlIGxvY2F0aW9uLiBHZXQgaW52YWxpZCByZXNwb25zZSBmcm9tIHZhbGlkYXRpb24gc2VydmVyOiAiLCBzdHIoaHR0cF9yZXNwb25zZS5nZXRTdGF0dXNMaW5lKCkuZ2V0U3RhdHVzQ29kZSgpKQogICAgICAgICAgICAgICAgaHR0cFNlcnZpY2UuY29uc3VtZShodHRwX3Jlc3BvbnNlKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgIAogICAgICAgICAgICByZXNwb25zZV9ieXRlcyA9IGh0dHBTZXJ2aWNlLmdldFJlc3BvbnNlQ29udGVudChodHRwX3Jlc3BvbnNlKQogICAgICAgICAgICByZXNwb25zZV9zdHJpbmcgPSBodHRwU2VydmljZS5jb252ZXJ0RW50aXR5VG9TdHJpbmcocmVzcG9uc2VfYnl0ZXMpCiAgICAgICAgICAgIGh0dHBTZXJ2aWNlLmNvbnN1bWUoaHR0cF9yZXNwb25zZSkKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBodHRwX3NlcnZpY2VfcmVzcG9uc2UuY2xvc2VDb25uZWN0aW9uKCkKCiAgICAgICAgaWYgcmVzcG9uc2Vfc3RyaW5nID09IE5vbmU6CiAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBEZXRlcm1pbmUgcmVtb3RlIGxvY2F0aW9uLiBHZXQgZW1wdHkgcmVzcG9uc2UgZnJvbSBsb2NhdGlvbiBzZXJ2ZXIiCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgCiAgICAgICAgcmVzcG9uc2UgPSBqc29uLmxvYWRzKHJlc3BvbnNlX3N0cmluZykKICAgICAgICAKICAgICAgICBpZiBub3QgU3RyaW5nSGVscGVyLmVxdWFsc0lnbm9yZUNhc2UocmVzcG9uc2VbJ3N0YXR1cyddLCAic3VjY2VzcyIpOgogICAgICAgICAgICBwcmludCAiU3VwZXItR2x1dS4gRGV0ZXJtaW5lIHJlbW90ZSBsb2NhdGlvbi4gR2V0IHJlc3BvbnNlIHdpdGggc3RhdHVzOiAnJXMnIiAlIHJlc3BvbnNlWydzdGF0dXMnXQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICByZXR1cm4gcmVzcG9uc2UKCiAgICBkZWYgaXNVc2VyTWVtYmVyT2ZHcm91cChzZWxmLCB1c2VyLCBhdHRyaWJ1dGUsIGdyb3VwKToKICAgICAgICBpc19tZW1iZXIgPSBGYWxzZQogICAgICAgIG1lbWJlcl9vZl9saXN0ID0gdXNlci5nZXRBdHRyaWJ1dGVWYWx1ZXMoYXR0cmlidXRlKQogICAgICAgIGlmIChtZW1iZXJfb2ZfbGlzdCAhPSBOb25lKToKICAgICAgICAgICAgZm9yIG1lbWJlcl9vZiBpbiBtZW1iZXJfb2ZfbGlzdDoKICAgICAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5lcXVhbHNJZ25vcmVDYXNlKGdyb3VwLCBtZW1iZXJfb2YpIG9yIG1lbWJlcl9vZi5lbmRzd2l0aChncm91cCk6CiAgICAgICAgICAgICAgICAgICAgaXNfbWVtYmVyID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIHJldHVybiBpc19tZW1iZXIKCiAgICBkZWYgcHJvY2Vzc0F1ZGl0R3JvdXAoc2VsZiwgdXNlciwgYXR0cmlidXRlLCBncm91cCk6CiAgICAgICAgaXNfbWVtYmVyID0gc2VsZi5pc1VzZXJNZW1iZXJPZkdyb3VwKHVzZXIsIGF0dHJpYnV0ZSwgZ3JvdXApCiAgICAgICAgaWYgKGlzX21lbWJlcik6CiAgICAgICAgICAgIHByaW50ICJTdXBlci1HbHV1LiBBdXRoZW50aWNhdGUgZm9yIHByb2Nlc3NBdWRpdEdyb3VwLiBVc2VyICclcycgbWVtYmVyIG9mIGF1ZGl0IGdyb3VwIiAlIHVzZXIuZ2V0VXNlcklkKCkKICAgICAgICAgICAgcHJpbnQgIlN1cGVyLUdsdXUuIEF1dGhlbnRpY2F0ZSBmb3IgcHJvY2Vzc0F1ZGl0R3JvdXAuIFNlbmRpbmcgZS1tYWlsIGFib3V0IHVzZXIgJyVzJyBsb2dpbiB0byAlcyIgJSAodXNlci5nZXRVc2VySWQoKSwgc2VsZi5hdWRpdF9lbWFpbCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU2VuZCBlLW1haWwgdG8gYWRtaW5pc3RyYXRvcgogICAgICAgICAgICB1c2VyX2lkID0gdXNlci5nZXRVc2VySWQoKQogICAgICAgICAgICBtYWlsU2VydmljZSA9IENkaVV0aWwuYmVhbihNYWlsU2VydmljZSkKICAgICAgICAgICAgc3ViamVjdCA9ICJVc2VyIGxvZyBpbjogJXMiICUgdXNlcl9pZAogICAgICAgICAgICBib2R5ID0gIlVzZXIgbG9nIGluOiAlcyIgJSB1c2VyX2lkCiAgICAgICAgICAgIG1haWxTZXJ2aWNlLnNlbmRNYWlsKHNlbGYuYXVkaXRfZW1haWwsIHN1YmplY3QsIGJvZHkpCg==
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=92F0-759E,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: ThumbSignIn authentication module
displayName: thumb_sign_in
oxEnabled: false
inum: 92F0-759E
oxConfigurationProperty: {"value1":"ts_host","value2":"https://ts.host.com","description":""}
oxConfigurationProperty: {"value1":"ts_apiKey","value2":"ts_api_key","description":""}
oxConfigurationProperty: {"value1":"ts_apiSecret","value2":"ts_api_secret","description":""}
oxLevel: 50
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxRevision: 1
oxScript:: IyBBdXRob3I6IFRodW1iU2lnbkluCgpmcm9tIG9yZy5nbHV1LnNlcnZpY2UuY2RpLnV0aWwgaW1wb3J0IENkaVV0aWwKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VjdXJpdHkgaW1wb3J0IElkZW50aXR5CmZyb20gb3JnLmdsdXUubW9kZWwuY3VzdG9tLnNjcmlwdC50eXBlLmF1dGggaW1wb3J0IFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlIGltcG9ydCBBdXRoZW50aWNhdGlvblNlcnZpY2UKZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIKZnJvbSBvcmcuZ2x1dS5veGF1dGgudXRpbCBpbXBvcnQgU2VydmVyVXRpbApmcm9tIGNvbS5wcmFtYXRpLnRzLnRodW1ic2lnbmluX2phdmFfc2RrIGltcG9ydCBUaHVtYnNpZ25pbkFwaUNvbnRyb2xsZXIKZnJvbSBvcmcuanNvbiBpbXBvcnQgSlNPTk9iamVjdApmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC51dGlsIGltcG9ydCBCYXNlNjRVdGlsCmZyb20gamF2YS5sYW5nIGltcG9ydCBTdHJpbmcKCmltcG9ydCBqYXZhCgoKY2xhc3MgUGVyc29uQXV0aGVudGljYXRpb24oUGVyc29uQXV0aGVudGljYXRpb25UeXBlKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudF90aW1lX21pbGxpcyk6CiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRfdGltZV9taWxsaXMKICAgICAgICBzZWxmLnRodW1ic2lnbmluQXBpQ29udHJvbGxlciA9IFRodW1ic2lnbmluQXBpQ29udHJvbGxlcigpCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uX2F0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gSW5pdGlhbGl6YXRpb24iCgogICAgICAgIGdsb2JhbCB0c19ob3N0CiAgICAgICAgdHNfaG9zdCA9IGNvbmZpZ3VyYXRpb25fYXR0cmlidXRlcy5nZXQoInRzX2hvc3QiKS5nZXRWYWx1ZTIoKQogICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gSW5pdGlhbGl6YXRpb24uIFZhbHVlIG9mIHRzX2hvc3QgaXMgJXMiICUgdHNfaG9zdAoKICAgICAgICBnbG9iYWwgdHNfYXBpX2tleQogICAgICAgIHRzX2FwaV9rZXkgPSBjb25maWd1cmF0aW9uX2F0dHJpYnV0ZXMuZ2V0KCJ0c19hcGlLZXkiKS5nZXRWYWx1ZTIoKQogICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gSW5pdGlhbGl6YXRpb24uIFZhbHVlIG9mIHRzX2FwaV9rZXkgaXMgJXMiICUgdHNfYXBpX2tleQoKICAgICAgICBnbG9iYWwgdHNfYXBpX3NlY3JldAogICAgICAgIHRzX2FwaV9zZWNyZXQgPSBjb25maWd1cmF0aW9uX2F0dHJpYnV0ZXMuZ2V0KCJ0c19hcGlTZWNyZXQiKS5nZXRWYWx1ZTIoKQoKICAgICAgICBnbG9iYWwgdHNfc3RhdHVzUGF0aAogICAgICAgIHRzX3N0YXR1c1BhdGggPSAiL3RzL3NlY3VyZS90eG4tc3RhdHVzLyIKCiAgICAgICAgZ2xvYmFsIEFVVEhFTlRJQ0FURQogICAgICAgIEFVVEhFTlRJQ0FURSA9ICJhdXRoZW50aWNhdGUiCgogICAgICAgIGdsb2JhbCBSRUdJU1RFUgogICAgICAgIFJFR0lTVEVSID0gInJlZ2lzdGVyIgoKICAgICAgICBnbG9iYWwgVFJBTlNBQ1RJT05fSUQKICAgICAgICBUUkFOU0FDVElPTl9JRCA9ICJ0cmFuc2FjdGlvbklkIgoKICAgICAgICBnbG9iYWwgVVNFUl9JRAogICAgICAgIFVTRVJfSUQgPSAidXNlcklkIgoKICAgICAgICBnbG9iYWwgVVNFUl9MT0dJTl9GTE9XCiAgICAgICAgVVNFUl9MT0dJTl9GTE9XID0gInVzZXJMb2dpbkZsb3ciCgogICAgICAgIGdsb2JhbCBUSFVNQlNJR05JTl9BVVRIRU5USUNBVElPTgogICAgICAgIFRIVU1CU0lHTklOX0FVVEhFTlRJQ0FUSU9OID0gIlRodW1iU2lnbkluX0F1dGhlbnRpY2F0aW9uIgoKICAgICAgICBnbG9iYWwgVEhVTUJTSUdOSU5fUkVHSVNUUkFUSU9OCiAgICAgICAgVEhVTUJTSUdOSU5fUkVHSVNUUkFUSU9OID0gIlRodW1iU2lnbkluX1JlZ2lzdHJhdGlvbiIKCiAgICAgICAgZ2xvYmFsIFRIVU1CU0lHTklOX0xPR0lOX1BPU1RfUkVHSVNUUkFUSU9OCiAgICAgICAgVEhVTUJTSUdOSU5fTE9HSU5fUE9TVF9SRUdJU1RSQVRJT04gPSAiVGh1bWJTaWduSW5fUmVnaXN0cmF0aW9uU3VjZXNzIgoKICAgICAgICBnbG9iYWwgUkVMWUlOR19QQVJUWV9JRAogICAgICAgIFJFTFlJTkdfUEFSVFlfSUQgPSAicmVseWluZ1BhcnR5SWQiCgogICAgICAgIGdsb2JhbCBSRUxZSU5HX1BBUlRZX0xPR0lOX1VSTAogICAgICAgIFJFTFlJTkdfUEFSVFlfTE9HSU5fVVJMID0gInJlbHlpbmdQYXJ0eUxvZ2luVXJsIgoKICAgICAgICBnbG9iYWwgVFNJX0xPR0lOX1BBR0UKICAgICAgICBUU0lfTE9HSU5fUEFHRSA9ICIvYXV0aC90aHVtYnNpZ25pbi90c0xvZ2luLnhodG1sIgoKICAgICAgICBnbG9iYWwgVFNJX1JFR0lTVEVSX1BBR0UKICAgICAgICBUU0lfUkVHSVNURVJfUEFHRSA9ICIvYXV0aC90aHVtYnNpZ25pbi90c1JlZ2lzdGVyLnhodG1sIgoKICAgICAgICBnbG9iYWwgVFNJX0xPR0lOX1BPU1RfUkVHSVNUUkFUSU9OX1BBR0UKICAgICAgICBUU0lfTE9HSU5fUE9TVF9SRUdJU1RSQVRJT05fUEFHRSA9ICIvYXV0aC90aHVtYnNpZ25pbi90c1JlZ2lzdHJhdGlvblN1Y2Nlc3MueGh0bWwiCgogICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIHJldHVybiBUcnVlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldF9yZWx5aW5nX3BhcnR5X2xvZ2luX3VybChpZGVudGl0eSk6CiAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBJbnNpZGUgc2V0X3JlbHlpbmdfcGFydHlfbG9naW5fdXJsLi4uIgogICAgICAgIHNlc3Npb25faWQgPSBpZGVudGl0eS5nZXRTZXNzaW9uSWQoKQogICAgICAgIHNlc3Npb25fYXR0cmlidXRlID0gc2Vzc2lvbl9pZC5nZXRTZXNzaW9uQXR0cmlidXRlcygpCiAgICAgICAgc3RhdGVfand0X3Rva2VuID0gc2Vzc2lvbl9hdHRyaWJ1dGUuZ2V0KCJzdGF0ZSIpCiAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBWYWx1ZSBvZiBzdGF0ZV9qd3RfdG9rZW4gaXMgJXMiICUgc3RhdGVfand0X3Rva2VuCiAgICAgICAgcmVseWluZ19wYXJ0eV9sb2dpbl91cmwgPSAiIgogICAgICAgIGlmIChzdGF0ZV9qd3RfdG9rZW4gaXMgTm9uZSkgb3IgKCIuIiBub3QgaW4gc3RhdGVfand0X3Rva2VuKToKICAgICAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBWYWx1ZSBvZiBzdGF0ZSBwYXJhbWV0ZXIgaXMgbm90IGluIHRoZSBmb3JtYXQgb2YgSldUIFRva2VuIgogICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKFJFTFlJTkdfUEFSVFlfTE9HSU5fVVJMLCByZWx5aW5nX3BhcnR5X2xvZ2luX3VybCkKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgc3RhdGVfand0X3Rva2VuX2FycmF5ID0gU3RyaW5nKHN0YXRlX2p3dF90b2tlbikuc3BsaXQoIlxcLiIpCiAgICAgICAgc3RhdGVfand0X3Rva2VuX3BheWxvYWQgPSBzdGF0ZV9qd3RfdG9rZW5fYXJyYXlbMV0KICAgICAgICBzdGF0ZV9wYXlsb2FkX3N0ciA9IFN0cmluZyhCYXNlNjRVdGlsLmJhc2U2NHVybGRlY29kZShzdGF0ZV9qd3RfdG9rZW5fcGF5bG9hZCksICJVVEYtOCIpCiAgICAgICAgc3RhdGVfcGF5bG9hZF9qc29uID0gSlNPTk9iamVjdChzdGF0ZV9wYXlsb2FkX3N0cikKICAgICAgICBwcmludCAiVGh1bWJTaWduSW4uIFZhbHVlIG9mIHN0YXRlIEpXVCB0b2tlbiBQYXlsb2FkIGlzICVzIiAlIHN0YXRlX3BheWxvYWRfanNvbgogICAgICAgIGlmIHN0YXRlX3BheWxvYWRfanNvbi5oYXMoImFkZGl0aW9uYWxfY2xhaW1zIik6CiAgICAgICAgICAgIGFkZGl0aW9uYWxfY2xhaW1zID0gc3RhdGVfcGF5bG9hZF9qc29uLmdldCgiYWRkaXRpb25hbF9jbGFpbXMiKQogICAgICAgICAgICByZWx5aW5nX3BhcnR5X2lkID0gYWRkaXRpb25hbF9jbGFpbXMuZ2V0KFJFTFlJTkdfUEFSVFlfSUQpCiAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gVmFsdWUgb2YgcmVseWluZ19wYXJ0eV9pZCBpcyAlcyIgJSByZWx5aW5nX3BhcnR5X2lkCiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoUkVMWUlOR19QQVJUWV9JRCwgcmVseWluZ19wYXJ0eV9pZCkKCiAgICAgICAgICAgIGlmIFN0cmluZyhyZWx5aW5nX3BhcnR5X2lkKS5zdGFydHNXaXRoKCJnb29nbGUuY29tIik6CiAgICAgICAgICAgICAgICAjIGdvb2dsZS5jb20vYS91bnBoaXNoYWJsZWVudGVycHJpc2UuY29tCiAgICAgICAgICAgICAgICByZWx5aW5nX3BhcnR5X2lkX2FycmF5ID0gU3RyaW5nKHJlbHlpbmdfcGFydHlfaWQpLnNwbGl0KCIvIikKICAgICAgICAgICAgICAgIGdvb2dsZV9kb21haW4gPSByZWx5aW5nX3BhcnR5X2lkX2FycmF5WzJdCiAgICAgICAgICAgICAgICBwcmludCAiVGh1bWJTaWduSW4uIFZhbHVlIG9mIGdvb2dsZV9kb21haW4gaXMgJXMiICUgZ29vZ2xlX2RvbWFpbgogICAgICAgICAgICAgICAgcmVseWluZ19wYXJ0eV9sb2dpbl91cmwgPSAiaHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS9hY2NvdW50cy9BY2NvdW50Q2hvb3Nlcj9oZD0iKyBnb29nbGVfZG9tYWluICsgIiUyNmNvbnRpbnVlPWh0dHBzOi8vYXBwcy5nb29nbGUuY29tL3VzZXIvaHViIgogICAgICAgICAgICAgICAgIyBlbGlmIChTdHJpbmcocmVseWluZ19wYXJ0eV9pZCkuc3RhcnRzV2l0aCgieHl6IikpOgogICAgICAgICAgICAgICAgIyByZWx5aW5nX3BhcnR5X2xvZ2luX3VybCA9ICJ4eXouY29tIgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBJZiByZWx5aW5nX3BhcnR5X2xvZ2luX3VybCBpcyBlbXB0eSwgR2x1dSdzIGRlZmF1bHQgbG9naW4gVVJMIHdpbGwgYmUgdXNlZAogICAgICAgICAgICAgICAgcmVseWluZ19wYXJ0eV9sb2dpbl91cmwgPSAiIgoKICAgICAgICBwcmludCAiVGh1bWJTaWduSW4uIFZhbHVlIG9mIHJlbHlpbmdfcGFydHlfbG9naW5fdXJsIGlzICVzIiAlIHJlbHlpbmdfcGFydHlfbG9naW5fdXJsCiAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcihSRUxZSU5HX1BBUlRZX0xPR0lOX1VSTCwgcmVseWluZ19wYXJ0eV9sb2dpbl91cmwpCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgaW5pdGlhbGl6ZV90aHVtYnNpZ25pbihzZWxmLCBpZGVudGl0eSwgcmVxdWVzdF9wYXRoKToKICAgICAgICAjIEludm9raW5nIHRoZSBhdXRoZW50aWNhdGUvcmVnaXN0ZXIgVGh1bWJTaWduSW4gQVBJIHZpYSB0aGUgSmF2YSBTREsKICAgICAgICB0aHVtYnNpZ25pbl9yZXNwb25zZSA9IHNlbGYudGh1bWJzaWduaW5BcGlDb250cm9sbGVyLmhhbmRsZVRodW1iU2lnbmluUmVxdWVzdChyZXF1ZXN0X3BhdGgsIHRzX2FwaV9rZXksIHRzX2FwaV9zZWNyZXQpCiAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBWYWx1ZSBvZiB0aHVtYnNpZ25pbl9yZXNwb25zZSBpcyAlcyIgJSB0aHVtYnNpZ25pbl9yZXNwb25zZQoKICAgICAgICB0aHVtYnNpZ25pbl9yZXNwb25zZV9qc29uID0gSlNPTk9iamVjdCh0aHVtYnNpZ25pbl9yZXNwb25zZSkKICAgICAgICB0cmFuc2FjdGlvbl9pZCA9IHRodW1ic2lnbmluX3Jlc3BvbnNlX2pzb24uZ2V0KFRSQU5TQUNUSU9OX0lEKQogICAgICAgIHN0YXR1c19yZXF1ZXN0X3R5cGUgPSAiYXV0aFN0YXR1cyIgaWYgcmVxdWVzdF9wYXRoID09IEFVVEhFTlRJQ0FURSBlbHNlICJyZWdTdGF0dXMiCiAgICAgICAgc3RhdHVzX3JlcXVlc3QgPSBzdGF0dXNfcmVxdWVzdF90eXBlICsgIi8iICsgdHJhbnNhY3Rpb25faWQKICAgICAgICBwcmludCAiVGh1bWJTaWduSW4uIFZhbHVlIG9mIHN0YXR1c19yZXF1ZXN0IGlzICVzIiAlIHN0YXR1c19yZXF1ZXN0CgogICAgICAgIGF1dGhvcml6YXRpb25faGVhZGVyID0gc2VsZi50aHVtYnNpZ25pbkFwaUNvbnRyb2xsZXIuZ2V0QXV0aG9yaXphdGlvbkhlYWRlckpzb25TdHIoc3RhdHVzX3JlcXVlc3QsIHRzX2FwaV9rZXksIHRzX2FwaV9zZWNyZXQpCiAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBWYWx1ZSBvZiBhdXRob3JpemF0aW9uX2hlYWRlciBpcyAlcyIgJSBhdXRob3JpemF0aW9uX2hlYWRlcgogICAgICAgICMgeyJhdXRoSGVhZGVyIjoiSG1hY1NIQTI1NiBDcmVkZW50aWFsPVgsU2lnbmVkSGVhZGVycz1hY2NlcHQ7Y29udGVudC10eXBlO3gtdHMtZGF0ZSxTaWduYXR1cmU9WCIsIlhUc0RhdGUiOiJYIn0KICAgICAgICBhdXRob3JpemF0aW9uX2hlYWRlcl9qc29uID0gSlNPTk9iamVjdChhdXRob3JpemF0aW9uX2hlYWRlcikKICAgICAgICBhdXRoX2hlYWRlciA9IGF1dGhvcml6YXRpb25faGVhZGVyX2pzb24uZ2V0KCJhdXRoSGVhZGVyIikKICAgICAgICB4X3RzX2RhdGUgPSBhdXRob3JpemF0aW9uX2hlYWRlcl9qc29uLmdldCgiWFRzRGF0ZSIpCgogICAgICAgIHRzaV9yZXNwb25zZV9rZXkgPSAiYXV0aGVudGljYXRlUmVzcG9uc2VKc29uU3RyIiBpZiByZXF1ZXN0X3BhdGggPT0gQVVUSEVOVElDQVRFIGVsc2UgInJlZ2lzdGVyUmVzcG9uc2VKc29uU3RyIgogICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIodHNpX3Jlc3BvbnNlX2tleSwgdGh1bWJzaWduaW5fcmVzcG9uc2UpCiAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigiYXV0aG9yaXphdGlvbkhlYWRlciIsIGF1dGhfaGVhZGVyKQogICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInhUc0RhdGUiLCB4X3RzX2RhdGUpCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgcHJlcGFyZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbl9hdHRyaWJ1dGVzLCByZXF1ZXN0X3BhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gSW5zaWRlIHByZXBhcmVGb3JTdGVwLiBTdGVwICVkIiAlIHN0ZXAKICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKICAgICAgICBhdXRoZW50aWNhdGlvbl9zZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkKCiAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigidHNfaG9zdCIsIHRzX2hvc3QpCiAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigidHNfc3RhdHVzUGF0aCIsIHRzX3N0YXR1c1BhdGgpCgogICAgICAgIHNlbGYuc2V0X3JlbHlpbmdfcGFydHlfbG9naW5fdXJsKGlkZW50aXR5KQoKICAgICAgICBpZiBzdGVwID09IDEgb3Igc3RlcCA9PSAzOgogICAgICAgICAgICBwcmludCAiVGh1bWJTaWduSW4uIFByZXBhcmUgZm9yIHN0ZXAgMSIKICAgICAgICAgICAgc2VsZi5pbml0aWFsaXplX3RodW1ic2lnbmluKGlkZW50aXR5LCBBVVRIRU5USUNBVEUpCiAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgIGVsaWYgc3RlcCA9PSAyOgogICAgICAgICAgICBwcmludCAiVGh1bWJTaWduSW4uIFByZXBhcmUgZm9yIHN0ZXAgMiIKICAgICAgICAgICAgaWYgaWRlbnRpdHkuaXNTZXRXb3JraW5nUGFyYW1ldGVyKFVTRVJfTE9HSU5fRkxPVyk6CiAgICAgICAgICAgICAgICB1c2VyX2xvZ2luX2Zsb3cgPSBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKFVTRVJfTE9HSU5fRkxPVykKICAgICAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gVmFsdWUgb2YgdXNlcl9sb2dpbl9mbG93IGlzICVzIiAlIHVzZXJfbG9naW5fZmxvdwogICAgICAgICAgICB1c2VyID0gYXV0aGVudGljYXRpb25fc2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpCiAgICAgICAgICAgIGlmIHVzZXIgaXMgTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gUHJlcGFyZSBmb3Igc3RlcCAyLiBGYWlsZWQgdG8gZGV0ZXJtaW5lIHVzZXIgbmFtZSIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICB1c2VyX25hbWUgPSB1c2VyLmdldFVzZXJJZCgpCiAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gUHJlcGFyZSBmb3Igc3RlcCAyLiB1c2VyX25hbWU6ICIgKyB1c2VyX25hbWUKICAgICAgICAgICAgaWYgdXNlcl9uYW1lIGlzIE5vbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcihVU0VSX0lELCB1c2VyX25hbWUpCiAgICAgICAgICAgIHNlbGYuaW5pdGlhbGl6ZV90aHVtYnNpZ25pbihpZGVudGl0eSwgUkVHSVNURVIgKyAiLyIgKyB1c2VyX25hbWUpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdldF91c2VyX2lkX2Zyb21fdGh1bWJzaWduaW4oc2VsZiwgcmVxdWVzdF9wYXJhbWV0ZXJzKToKICAgICAgICB0cmFuc2FjdGlvbl9pZCA9IFNlcnZlclV0aWwuZ2V0Rmlyc3RWYWx1ZShyZXF1ZXN0X3BhcmFtZXRlcnMsIFRSQU5TQUNUSU9OX0lEKQogICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gVmFsdWUgb2YgdHJhbnNhY3Rpb25faWQgaXMgJXMiICUgdHJhbnNhY3Rpb25faWQKICAgICAgICBnZXRfdXNlcl9yZXF1ZXN0ID0gImdldFVzZXIvIiArIHRyYW5zYWN0aW9uX2lkCiAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBWYWx1ZSBvZiBnZXRfdXNlcl9yZXF1ZXN0IGlzICVzIiAlIGdldF91c2VyX3JlcXVlc3QKCiAgICAgICAgZ2V0X3VzZXJfcmVzcG9uc2UgPSBzZWxmLnRodW1ic2lnbmluQXBpQ29udHJvbGxlci5oYW5kbGVUaHVtYlNpZ25pblJlcXVlc3QoZ2V0X3VzZXJfcmVxdWVzdCwgdHNfYXBpX2tleSwgdHNfYXBpX3NlY3JldCkKICAgICAgICBwcmludCAiVGh1bWJTaWduSW4uIFZhbHVlIG9mIGdldF91c2VyX3Jlc3BvbnNlIGlzICVzIiAlIGdldF91c2VyX3Jlc3BvbnNlCiAgICAgICAgZ2V0X3VzZXJfcmVzcG9uc2VfanNvbiA9IEpTT05PYmplY3QoZ2V0X3VzZXJfcmVzcG9uc2UpCiAgICAgICAgdGh1bWJzaWduaW5fdXNlcl9pZCA9IGdldF91c2VyX3Jlc3BvbnNlX2pzb24uZ2V0KFVTRVJfSUQpCiAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBWYWx1ZSBvZiB0aHVtYnNpZ25pbl91c2VyX2lkIGlzICVzIiAlIHRodW1ic2lnbmluX3VzZXJfaWQKICAgICAgICByZXR1cm4gdGh1bWJzaWduaW5fdXNlcl9pZAoKICAgIGRlZiBhdXRoZW50aWNhdGUoc2VsZiwgY29uZmlndXJhdGlvbl9hdHRyaWJ1dGVzLCByZXF1ZXN0X3BhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gSW5zaWRlIGF1dGhlbnRpY2F0ZS4gU3RlcCAlZCIgJSBzdGVwCiAgICAgICAgYXV0aGVudGljYXRpb25fc2VydmljZSA9IENkaVV0aWwuYmVhbihBdXRoZW50aWNhdGlvblNlcnZpY2UpCiAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCgogICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInRzX2hvc3QiLCB0c19ob3N0KQogICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInRzX3N0YXR1c1BhdGgiLCB0c19zdGF0dXNQYXRoKQoKICAgICAgICBpZiBzdGVwID09IDEgb3Igc3RlcCA9PSAzOgogICAgICAgICAgICBwcmludCAiVGh1bWJTaWduSW4uIEF1dGhlbnRpY2F0ZSBmb3IgU3RlcCAlZCIgJSBzdGVwCgogICAgICAgICAgICBsb2dpbl9mbG93ID0gU2VydmVyVXRpbC5nZXRGaXJzdFZhbHVlKHJlcXVlc3RfcGFyYW1ldGVycywgImxvZ2luX2Zsb3ciKQogICAgICAgICAgICBwcmludCAiVGh1bWJTaWduSW4uIFZhbHVlIG9mIGxvZ2luX2Zsb3cgcGFyYW1ldGVyIGlzICVzIiAlIGxvZ2luX2Zsb3cKCiAgICAgICAgICAgICMgTG9naWMgZm9yIFRodW1iU2lnbkluIEF1dGhlbnRpY2F0aW9uIEZsb3cgKEVpdGhlciBzdGVwIDEgb3Igc3RlcCAzKQogICAgICAgICAgICBpZiBsb2dpbl9mbG93ID09IFRIVU1CU0lHTklOX0FVVEhFTlRJQ0FUSU9OIG9yIGxvZ2luX2Zsb3cgPT0gVEhVTUJTSUdOSU5fTE9HSU5fUE9TVF9SRUdJU1RSQVRJT046CiAgICAgICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKFVTRVJfTE9HSU5fRkxPVywgbG9naW5fZmxvdykKICAgICAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gVmFsdWUgb2YgdXNlckxvZ2luRmxvdyBpcyAlcyIgJSBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKFVTRVJfTE9HSU5fRkxPVykKICAgICAgICAgICAgICAgIGxvZ2dlZF9pbl9zdGF0dXMgPSBhdXRoZW50aWNhdGlvbl9zZXJ2aWNlLmF1dGhlbnRpY2F0ZShzZWxmLmdldF91c2VyX2lkX2Zyb21fdGh1bWJzaWduaW4ocmVxdWVzdF9wYXJhbWV0ZXJzKSkKICAgICAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gbG9nZ2VkX2luIHN0YXR1cyA6ICVyIiAlIGxvZ2dlZF9pbl9zdGF0dXMKICAgICAgICAgICAgICAgIHJldHVybiBsb2dnZWRfaW5fc3RhdHVzCgogICAgICAgICAgICAjIExvZ2ljIGZvciB0cmFkaXRpb25hbCBsb2dpbiBmbG93IChzdGVwIDEpCiAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gVXNlciBjcmVkZW50aWFscyBsb2dpbiBmbG93IgogICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKFVTRVJfTE9HSU5fRkxPVywgVEhVTUJTSUdOSU5fUkVHSVNUUkFUSU9OKQogICAgICAgICAgICBwcmludCAiVGh1bWJTaWduSW4uIFZhbHVlIG9mIHVzZXJMb2dpbkZsb3cgaXMgJXMiICUgaWRlbnRpdHkuZ2V0V29ya2luZ1BhcmFtZXRlcihVU0VSX0xPR0lOX0ZMT1cpCiAgICAgICAgICAgIGxvZ2dlZF9pbiA9IHNlbGYuYXV0aGVudGljYXRlX3VzZXJfY3JlZGVudGlhbHMoaWRlbnRpdHksIGF1dGhlbnRpY2F0aW9uX3NlcnZpY2UpCiAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gU3RhdHVzIG9mIFVzZXIgQ3JlZGVudGlhbHMgYmFzZWQgQXV0aGVudGljYXRpb24gOiAlciIgJSBsb2dnZWRfaW4KCiAgICAgICAgICAgICMgV2hlbiB0aGUgdHJhZGl0aW9uYWwgbG9naW4gZmFpbHMsIHJlaW5pdGlhbGl6ZSB0aGUgVGh1bWJTaWduSW4gZGF0YSBiZWZvcmUgc2VuZGluZyBlcnJvciByZXNwb25zZSB0byBVSQogICAgICAgICAgICBpZiBub3QgbG9nZ2VkX2luOgogICAgICAgICAgICAgICAgc2VsZi5pbml0aWFsaXplX3RodW1ic2lnbmluKGlkZW50aXR5LCBBVVRIRU5USUNBVEUpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gQXV0aGVudGljYXRlIHN1Y2Nlc3NmdWwgZm9yIHN0ZXAgJWQiICUgc3RlcAogICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICBlbGlmIHN0ZXAgPT0gMjoKICAgICAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBSZWdpc3RyYXRpb24gZmxvdyAoc3RlcCAyKSIKICAgICAgICAgICAgc2VsZi52ZXJpZnlfdXNlcl9sb2dpbl9mbG93KGlkZW50aXR5KQoKICAgICAgICAgICAgdXNlciA9IHNlbGYuZ2V0X2F1dGhlbnRpY2F0ZWRfdXNlcl9mcm9tX2dsdXUoYXV0aGVudGljYXRpb25fc2VydmljZSkKICAgICAgICAgICAgaWYgdXNlciBpcyBOb25lOgogICAgICAgICAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBSZWdpc3RyYXRpb24gZmxvdyAoc3RlcCAyKS4gRmFpbGVkIHRvIGRldGVybWluZSB1c2VyIG5hbWUiCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIHVzZXJfbmFtZSA9IHVzZXIuZ2V0VXNlcklkKCkKICAgICAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBSZWdpc3RyYXRpb24gZmxvdyAoc3RlcCAyKSBzdWNjZXNzZnVsLiB1c2VyX25hbWU6ICVzIiAlIHVzZXJfbmFtZQogICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgYXV0aGVudGljYXRlX3VzZXJfY3JlZGVudGlhbHMoc2VsZiwgaWRlbnRpdHksIGF1dGhlbnRpY2F0aW9uX3NlcnZpY2UpOgogICAgICAgIGNyZWRlbnRpYWxzID0gaWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHMoKQogICAgICAgIHVzZXJfbmFtZSA9IGNyZWRlbnRpYWxzLmdldFVzZXJuYW1lKCkKICAgICAgICB1c2VyX3Bhc3N3b3JkID0gY3JlZGVudGlhbHMuZ2V0UGFzc3dvcmQoKQogICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gdXNlcl9uYW1lOiAiICsgdXNlcl9uYW1lCiAgICAgICAgbG9nZ2VkX2luID0gRmFsc2UKICAgICAgICBpZiBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eVN0cmluZyh1c2VyX25hbWUpIGFuZCBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eVN0cmluZyh1c2VyX3Bhc3N3b3JkKToKICAgICAgICAgICAgbG9nZ2VkX2luID0gc2VsZi5hdXRoZW50aWNhdGVfdXNlcl9pbl9nbHV1X2xkYXAoYXV0aGVudGljYXRpb25fc2VydmljZSwgdXNlcl9uYW1lLCB1c2VyX3Bhc3N3b3JkKQogICAgICAgIHJldHVybiBsb2dnZWRfaW4KCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgYXV0aGVudGljYXRlX3VzZXJfaW5fZ2x1dV9sZGFwKGF1dGhlbnRpY2F0aW9uX3NlcnZpY2UsIHVzZXJfbmFtZSwgdXNlcl9wYXNzd29yZCk6CiAgICAgICAgcmV0dXJuIGF1dGhlbnRpY2F0aW9uX3NlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJfbmFtZSwgdXNlcl9wYXNzd29yZCkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0X2F1dGhlbnRpY2F0ZWRfdXNlcl9mcm9tX2dsdXUoYXV0aGVudGljYXRpb25fc2VydmljZSk6CiAgICAgICAgcmV0dXJuIGF1dGhlbnRpY2F0aW9uX3NlcnZpY2UuZ2V0QXV0aGVudGljYXRlZFVzZXIoKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB2ZXJpZnlfdXNlcl9sb2dpbl9mbG93KGlkZW50aXR5KToKICAgICAgICBpZiBpZGVudGl0eS5pc1NldFdvcmtpbmdQYXJhbWV0ZXIoVVNFUl9MT0dJTl9GTE9XKToKICAgICAgICAgICAgdXNlcl9sb2dpbl9mbG93ID0gaWRlbnRpdHkuZ2V0V29ya2luZ1BhcmFtZXRlcihVU0VSX0xPR0lOX0ZMT1cpCiAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gVmFsdWUgb2YgdXNlcl9sb2dpbl9mbG93IGlzICVzIiAlIHVzZXJfbG9naW5fZmxvdwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoVVNFUl9MT0dJTl9GTE9XLCBUSFVNQlNJR05JTl9SRUdJU1RSQVRJT04pCiAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gU2V0dGluZyB0aGUgdmFsdWUgb2YgdXNlcl9sb2dpbl9mbG93IHRvICVzIiAlIGlkZW50aXR5LmdldFdvcmtpbmdQYXJhbWV0ZXIoVVNFUl9MT0dJTl9GTE9XKQoKICAgIGRlZiBnZXRFeHRyYVBhcmFtZXRlcnNGb3JTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25fYXR0cmlidXRlcywgc3RlcCk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgZ2V0Q291bnRBdXRoZW50aWNhdGlvblN0ZXBzKHNlbGYsIGNvbmZpZ3VyYXRpb25fYXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBJbnNpZGUgZ2V0Q291bnRBdXRoZW50aWNhdGlvblN0ZXBzLi4iCiAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCgogICAgICAgIHVzZXJfbG9naW5fZmxvdyA9IGlkZW50aXR5LmdldFdvcmtpbmdQYXJhbWV0ZXIoVVNFUl9MT0dJTl9GTE9XKQogICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gVmFsdWUgb2YgdXNlckxvZ2luRmxvdyBpcyAlcyIgJSB1c2VyX2xvZ2luX2Zsb3cKICAgICAgICBpZiB1c2VyX2xvZ2luX2Zsb3cgPT0gVEhVTUJTSUdOSU5fQVVUSEVOVElDQVRJT046CiAgICAgICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gVG90YWwgQXV0aGVudGljYXRpb24gU3RlcHMgaXM6IDEiCiAgICAgICAgICAgIHJldHVybiAxCiAgICAgICAgcHJpbnQgIlRodW1iU2lnbkluLiBUb3RhbCBBdXRoZW50aWNhdGlvbiBTdGVwcyBpczogMyIKICAgICAgICByZXR1cm4gMwoKICAgIGRlZiBnZXRQYWdlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uX2F0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gSW5zaWRlIGdldFBhZ2VGb3JTdGVwLiBTdGVwICVkIiAlIHN0ZXAKICAgICAgICBpZiBzdGVwID09IDM6CiAgICAgICAgICAgIHJldHVybiBUU0lfTE9HSU5fUE9TVF9SRUdJU1RSQVRJT05fUEFHRQogICAgICAgIHRodW1ic2lnbmluX3BhZ2UgPSBUU0lfUkVHSVNURVJfUEFHRSBpZiBzdGVwID09IDIgZWxzZSBUU0lfTE9HSU5fUEFHRQogICAgICAgIHJldHVybiB0aHVtYnNpZ25pbl9wYWdlCgogICAgZGVmIGRlc3Ryb3koc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJUaHVtYlNpZ25Jbi4gRGVzdHJveSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQogICAgICAgIAogICAgZGVmIGdldEF1dGhlbnRpY2F0aW9uTWV0aG9kQ2xhaW1zKHNlbGYsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgZGVmIGlzVmFsaWRBdXRoZW50aWNhdGlvbk1ldGhvZChzZWxmLCB1c2FnZVR5cGUsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBbHRlcm5hdGl2ZUF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGdldE5leHRTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CiAgICAgICAgcmV0dXJuIC0xCgogICAgZGVmIGdldExvZ291dEV4dGVybmFsVXJsKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcHJpbnQgIkdldCBleHRlcm5hbCBsb2dvdXQgVVJMIGNhbGwiCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgbG9nb3V0KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcmV0dXJuIFRydWUK
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=A51E-76DA,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample authentication module
displayName: basic
oxEnabled: false
inum: A51E-76DA
oxLevel: 10
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlLmNkaS51dGlsIGltcG9ydCBDZGlVdGlsCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlY3VyaXR5IGltcG9ydCBJZGVudGl0eQpmcm9tIG9yZy5nbHV1Lm1vZGVsLmN1c3RvbS5zY3JpcHQudHlwZS5hdXRoIGltcG9ydCBQZXJzb25BdXRoZW50aWNhdGlvblR5cGUKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZSBpbXBvcnQgQXV0aGVudGljYXRpb25TZXJ2aWNlCmZyb20gb3JnLmdsdXUudXRpbCBpbXBvcnQgU3RyaW5nSGVscGVyCgppbXBvcnQgamF2YQoKY2xhc3MgUGVyc29uQXV0aGVudGljYXRpb24oUGVyc29uQXV0aGVudGljYXRpb25UeXBlKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6CiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCAgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJCYXNpYy4gSW5pdGlhbGl6YXRpb24iCiAgICAgICAgcHJpbnQgIkJhc2ljLiBJbml0aWFsaXplZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUgICAKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkJhc2ljLiBEZXN0cm95IgogICAgICAgIHByaW50ICJCYXNpYy4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIGdldEF1dGhlbnRpY2F0aW9uTWV0aG9kQ2xhaW1zKHNlbGYsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgZGVmIGdldEFwaVZlcnNpb24oc2VsZik6CiAgICAgICAgcmV0dXJuIDExCgogICAgZGVmIGlzVmFsaWRBdXRoZW50aWNhdGlvbk1ldGhvZChzZWxmLCB1c2FnZVR5cGUsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBbHRlcm5hdGl2ZUF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGF1dGhlbnRpY2F0ZShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIGF1dGhlbnRpY2F0aW9uU2VydmljZSA9IENkaVV0aWwuYmVhbihBdXRoZW50aWNhdGlvblNlcnZpY2UpCgogICAgICAgIGlmIChzdGVwID09IDEpOgogICAgICAgICAgICBwcmludCAiQmFzaWMuIEF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxIgoKICAgICAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCiAgICAgICAgICAgIGNyZWRlbnRpYWxzID0gaWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHMoKQoKICAgICAgICAgICAgdXNlcl9uYW1lID0gY3JlZGVudGlhbHMuZ2V0VXNlcm5hbWUoKQogICAgICAgICAgICB1c2VyX3Bhc3N3b3JkID0gY3JlZGVudGlhbHMuZ2V0UGFzc3dvcmQoKQoKICAgICAgICAgICAgbG9nZ2VkX2luID0gRmFsc2UKICAgICAgICAgICAgaWYgKFN0cmluZ0hlbHBlci5pc05vdEVtcHR5U3RyaW5nKHVzZXJfbmFtZSkgYW5kIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5U3RyaW5nKHVzZXJfcGFzc3dvcmQpKToKICAgICAgICAgICAgICAgIGxvZ2dlZF9pbiA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5hdXRoZW50aWNhdGUodXNlcl9uYW1lLCB1c2VyX3Bhc3N3b3JkKQoKICAgICAgICAgICAgaWYgKG5vdCBsb2dnZWRfaW4pOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBwcmVwYXJlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIGlmIChzdGVwID09IDEpOgogICAgICAgICAgICBwcmludCAiQmFzaWMuIFByZXBhcmUgZm9yIFN0ZXAgMSIKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgZ2V0RXh0cmFQYXJhbWV0ZXJzRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgc3RlcCk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgZ2V0Q291bnRBdXRoZW50aWNhdGlvblN0ZXBzKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gMQoKICAgIGRlZiBnZXRQYWdlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgc3RlcCk6CiAgICAgICAgcmV0dXJuICIiCgogICAgZGVmIGdldE5leHRTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CiAgICAgICAgcmV0dXJuIC0xCgogICAgZGVmIGdldExvZ291dEV4dGVybmFsVXJsKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcHJpbnQgIkdldCBleHRlcm5hbCBsb2dvdXQgVVJMIGNhbGwiCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgbG9nb3V0KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcmV0dXJuIFRydWUK
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=A910-56AB,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample script for SCIM events
displayName: scim_event_handler
oxEnabled: false
inum: A910-56AB
oxConfigurationProperty: {"value1":"testProp1","value2":"Test value 1","description":""}
oxConfigurationProperty: {"value1":"testProp2","value2":"Test value 2","description":""}
oxLevel: 100
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveFRydXN0IGlzIGF2YWlsYWJsZSB1bmRlciB0aGUgTUlUIExpY2Vuc2UgKDIwMDgpLiBTZWUgaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL01JVCBmb3IgZnVsbCB0ZXh0LgojIENvcHlyaWdodCAoYykgMjAxNCwgR2x1dQojCiMgQXV0aG9yOiBKb3NlIEdvbnphbGV6CiMKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuc2NpbSBpbXBvcnQgU2NpbVR5cGUKZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIsIEFycmF5SGVscGVyCmZyb20gamF2YS51dGlsIGltcG9ydCBBcnJheXMsIEFycmF5TGlzdApmcm9tIG9yZy5nbHV1Lm94dHJ1c3QubGRhcC5zZXJ2aWNlIGltcG9ydCBQZXJzb25TZXJ2aWNlCmZyb20gb3JnLmdsdXUuc2VydmljZS5jZGkudXRpbCBpbXBvcnQgQ2RpVXRpbApmcm9tIG9yZy5nbHV1Lm94dHJ1c3QubW9kZWwgaW1wb3J0IEdsdXVDdXN0b21QZXJzb24KCmltcG9ydCBqYXZhCgpjbGFzcyBTY2ltRXZlbnRIYW5kbGVyKFNjaW1UeXBlKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJTY2ltRXZlbnRIYW5kbGVyIChpbml0KTogSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIHJldHVybiBUcnVlICAgCgogICAgZGVmIGRlc3Ryb3koc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJTY2ltRXZlbnRIYW5kbGVyIChkZXN0cm95KTogRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZSAgIAoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgICNyZXR1cm4gMiBpZiB5b3Ugd2FudCB0aGUgcG9zdCogc2NyaXB0cyBiZWluZyBleGVjdXRlZAogICAgICAgIHJldHVybiAxMQoKICAgIGRlZiBjcmVhdGVVc2VyKHNlbGYsIHVzZXIsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKCiAgICAgICAgcHJpbnQgIlNjaW1FdmVudEhhbmRsZXIgKGNyZWF0ZVVzZXIpOiBDdXJyZW50IGlkID0gIiArIHVzZXIuZ2V0VWlkKCkKCiAgICAgICAgdGVzdFByb3AxID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJ0ZXN0UHJvcDEiKS5nZXRWYWx1ZTIoKQogICAgICAgIHRlc3RQcm9wMiA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgidGVzdFByb3AyIikuZ2V0VmFsdWUyKCkKCiAgICAgICAgcHJpbnQgIlNjaW1FdmVudEhhbmRsZXIgKGNyZWF0ZVVzZXIpOiB0ZXN0UHJvcDEgPSAiICsgdGVzdFByb3AxCiAgICAgICAgcHJpbnQgIlNjaW1FdmVudEhhbmRsZXIgKGNyZWF0ZVVzZXIpOiB0ZXN0UHJvcDIgPSAiICsgdGVzdFByb3AyCgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIHVwZGF0ZVVzZXIoc2VsZiwgdXNlciwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHBlcnNvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oUGVyc29uU2VydmljZSkKICAgICAgICBvbGRVc2VyID0gcGVyc29uU2VydmljZS5nZXRQZXJzb25CeVVpZCh1c2VyLmdldFVpZCgpKQogICAgICAgIHByaW50ICJTY2ltRXZlbnRIYW5kbGVyICh1cGRhdGVVc2VyKTogT2xkIGRpc3BsYXlOYW1lICVzIiAlIG9sZFVzZXIuZ2V0RGlzcGxheU5hbWUoKQogICAgICAgIHByaW50ICJTY2ltRXZlbnRIYW5kbGVyICh1cGRhdGVVc2VyKTogTmV3IGRpc3BsYXlOYW1lICIgKyB1c2VyLmdldERpc3BsYXlOYW1lKCkKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZWxldGVVc2VyKHNlbGYsIHVzZXIsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiU2NpbUV2ZW50SGFuZGxlciAoZGVsZXRlVXNlcik6IEN1cnJlbnQgaWQgPSAiICsgdXNlci5nZXRVaWQoKQogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGNyZWF0ZUdyb3VwKHNlbGYsIGdyb3VwLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIlNjaW1FdmVudEhhbmRsZXIgKGNyZWF0ZUdyb3VwKTogQ3VycmVudCBkaXNwbGF5TmFtZSA9ICIgKyBncm91cC5nZXREaXNwbGF5TmFtZSgpCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgdXBkYXRlR3JvdXAoc2VsZiwgZ3JvdXAsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiU2NpbUV2ZW50SGFuZGxlciAodXBkYXRlR3JvdXApOiBDdXJyZW50IGRpc3BsYXlOYW1lID0gIiArIGdyb3VwLmdldERpc3BsYXlOYW1lKCkKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZWxldGVHcm91cChzZWxmLCBncm91cCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJTY2ltRXZlbnRIYW5kbGVyIChkZWxldGVHcm91cCk6IEN1cnJlbnQgZGlzcGxheU5hbWUgPSAiICsgZ3JvdXAuZ2V0RGlzcGxheU5hbWUoKQogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgcG9zdENyZWF0ZVVzZXIoc2VsZiwgdXNlciwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIHBvc3RVcGRhdGVVc2VyKHNlbGYsIHVzZXIsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBwb3N0RGVsZXRlVXNlcihzZWxmLCB1c2VyLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgcG9zdFVwZGF0ZUdyb3VwKHNlbGYsIGdyb3VwLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgcG9zdENyZWF0ZUdyb3VwKHNlbGYsIGdyb3VwLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgcG9zdERlbGV0ZUdyb3VwKHNlbGYsIGdyb3VwLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcmV0dXJuIFRydWU=
oxScriptType: scim
programmingLanguage: python

dn: inum=D40C-1CA4,ou=scripts,o=gluu
objectClass: oxCustomScript
objectClass: top
description: Passport SAML authentication module
displayName: passport_saml
oxEnabled: true
inum: D40C-1CA4
oxConfigurationProperty: {"value1":"key_store_file","value2":"/etc/certs/passport-rp.jks","hide":false,"description":""}
oxConfigurationProperty: {"value1":"key_store_password","value2":"secret","hide":false,"description":""}
oxLevel: 60
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE5LCBHbHV1CiMKIyBBdXRob3I6IEpvc2UgR29uemFsZXoKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIyBBdXRob3I6IENocmlzdGlhbiBFbGFuZAojCgpmcm9tIG9yZy5nbHV1LmpzZjIuc2VydmljZSBpbXBvcnQgRmFjZXNTZXJ2aWNlCmZyb20gb3JnLmdsdXUuanNmMi5tZXNzYWdlIGltcG9ydCBGYWNlc01lc3NhZ2VzCgpmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5jb21tb24gaW1wb3J0IFVzZXIsIFdlYktleVN0b3JhZ2UKZnJvbSBvcmcuZ2x1dS5veGF1dGgubW9kZWwuY29uZmlndXJhdGlvbiBpbXBvcnQgQXBwQ29uZmlndXJhdGlvbgpmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5jcnlwdG8gaW1wb3J0IENyeXB0b1Byb3ZpZGVyRmFjdG9yeQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5qd3QgaW1wb3J0IEp3dCwgSnd0Q2xhaW1OYW1lCmZyb20gb3JnLmdsdXUub3hhdXRoLm1vZGVsLnV0aWwgaW1wb3J0IEJhc2U2NFV0aWwKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZSBpbXBvcnQgQXBwSW5pdGlhbGl6ZXIsIEF1dGhlbnRpY2F0aW9uU2VydmljZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlLmNvbW1vbiBpbXBvcnQgVXNlclNlcnZpY2UsIEVuY3J5cHRpb25TZXJ2aWNlCmZyb20gb3JnLmdsdXUub3hhdXRoLm1vZGVsLmF1dGhvcml6ZSBpbXBvcnQgQXV0aG9yaXplUmVxdWVzdFBhcmFtCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UubmV0IGltcG9ydCBIdHRwU2VydmljZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZWN1cml0eSBpbXBvcnQgSWRlbnRpdHkKZnJvbSBvcmcuZ2x1dS5veGF1dGgudXRpbCBpbXBvcnQgU2VydmVyVXRpbApmcm9tIG9yZy5nbHV1LmNvbmZpZy5veHRydXN0IGltcG9ydCBMZGFwT3hQYXNzcG9ydENvbmZpZ3VyYXRpb24KZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuYXV0aCBpbXBvcnQgUGVyc29uQXV0aGVudGljYXRpb25UeXBlCmZyb20gb3JnLmdsdXUucGVyc2lzdCBpbXBvcnQgUGVyc2lzdGVuY2VFbnRyeU1hbmFnZXIKZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlLmNkaS51dGlsIGltcG9ydCBDZGlVdGlsCmZyb20gb3JnLmdsdXUudXRpbCBpbXBvcnQgU3RyaW5nSGVscGVyCmZyb20gamF2YS51dGlsIGltcG9ydCBBcnJheUxpc3QsIEFycmF5cywgQ29sbGVjdGlvbnMsIEhhc2hTZXQKZnJvbSBvcmcuZ2x1dS5veGF1dGgubW9kZWwuZXhjZXB0aW9uIGltcG9ydCBJbnZhbGlkSnd0RXhjZXB0aW9uCmZyb20gamF2YXguZmFjZXMuYXBwbGljYXRpb24gaW1wb3J0IEZhY2VzTWVzc2FnZQpmcm9tIGphdmF4LmZhY2VzLmNvbnRleHQgaW1wb3J0IEZhY2VzQ29udGV4dAoKaW1wb3J0IGpzb24KaW1wb3J0IHN5cwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IGJhc2U2NAoKCmNsYXNzIFBlcnNvbkF1dGhlbnRpY2F0aW9uKFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgoKICAgICAgICBwcmludCAiUGFzc3BvcnQuIGluaXQgY2FsbGVkIgoKICAgICAgICBzZWxmLmV4dGVuc2lvbk1vZHVsZSA9IHNlbGYubG9hZEV4dGVybmFsTW9kdWxlKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiZXh0ZW5zaW9uX21vZHVsZSIpKQogICAgICAgIGV4dGVuc2lvblJlc3VsdCA9IHNlbGYuZXh0ZW5zaW9uSW5pdChjb25maWd1cmF0aW9uQXR0cmlidXRlcykKICAgICAgICBpZiBleHRlbnNpb25SZXN1bHQgIT0gTm9uZToKICAgICAgICAgICAgcmV0dXJuIGV4dGVuc2lvblJlc3VsdAoKICAgICAgICBwcmludCAiUGFzc3BvcnQuIGluaXQuIEJlaGF2aW91ciBpcyBpbmJvdW5kIFNBTUwiCiAgICAgICAgc3VjY2VzcyA9IHNlbGYucHJvY2Vzc0tleVN0b3JlUHJvcGVydGllcyhjb25maWd1cmF0aW9uQXR0cmlidXRlcykKCiAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgc2VsZi5wcm92aWRlcktleSA9ICJwcm92aWRlciIKICAgICAgICAgICAgc2VsZi5jdXN0b21BdXRoelBhcmFtZXRlciA9IHNlbGYuZ2V0Q3VzdG9tQXV0aHpQYXJhbWV0ZXIoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJhdXRoel9yZXFfcGFyYW1fcHJvdmlkZXIiKSkKICAgICAgICAgICAgc2VsZi5wYXNzcG9ydEROID0gc2VsZi5nZXRQYXNzcG9ydENvbmZpZ0ROKCkKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBpbml0LiBJbml0aWFsaXphdGlvbiBzdWNjZXNzIgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gaW5pdC4gSW5pdGlhbGl6YXRpb24gZmFpbGVkIgogICAgICAgIHJldHVybiBzdWNjZXNzCgoKICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiUGFzc3BvcnQuIGRlc3Ryb3kgY2FsbGVkIgogICAgICAgIHJldHVybiBUcnVlCgoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQoKICAgIGRlZiBnZXRBdXRoZW50aWNhdGlvbk1ldGhvZENsYWltcyhzZWxmLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgaXNWYWxpZEF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBUcnVlCgoKICAgIGRlZiBnZXRBbHRlcm5hdGl2ZUF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBOb25lCgoKICAgIGRlZiBhdXRoZW50aWNhdGUoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKCiAgICAgICAgZXh0ZW5zaW9uUmVzdWx0ID0gc2VsZi5leHRlbnNpb25BdXRoZW50aWNhdGUoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKQogICAgICAgIGlmIGV4dGVuc2lvblJlc3VsdCAhPSBOb25lOgogICAgICAgICAgICByZXR1cm4gZXh0ZW5zaW9uUmVzdWx0CgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXV0aGVudGljYXRlIGZvciBzdGVwICVzIGNhbGxlZCIgJSBzdHIoc3RlcCkKICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKCiAgICAgICAgIyBMb2FkaW5nIHNlbGYucmVnaXN0ZXJlZFByb3ZpZGVycyBpbiBjYXNlIHBhc3Nwb3J0IGRlc3Ryb3llZAogICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsJ3JlZ2lzdGVyZWRQcm92aWRlcnMnKToKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBGZXRjaGluZyByZWdpc3RlcmVkIHByb3ZpZGVycy4iCiAgICAgICAgICAgIHNlbGYucGFyc2VQcm92aWRlckNvbmZpZ3MoKQoKICAgICAgICBpZiBzdGVwID09IDE6CgogICAgICAgICAgICBqd3RfcGFyYW0gPSBOb25lCgogICAgICAgICAgICBpZiBzZWxmLmlzSW5ib3VuZEZsb3coaWRlbnRpdHkpOgogICAgICAgICAgICAgICAgIyBpZiBpcyBpZHAtaW5pdGlhdGVkIGluYm91bmQgZmxvdwogICAgICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBhdXRoZW50aWNhdGUgZm9yIHN0ZXAgMS4gRGV0ZWN0ZWQgaWRwLWluaXRpYXRlZCBpbmJvdW5kIFNhbWwgZmxvdyIKICAgICAgICAgICAgICAgICMgZ2V0IHJlcXVlc3QgZnJvbSBzZXNzaW9uIGF0dHJpYnV0ZXMKICAgICAgICAgICAgICAgIGp3dF9wYXJhbSA9IGlkZW50aXR5LmdldFNlc3Npb25JZCgpLmdldFNlc3Npb25BdHRyaWJ1dGVzKCkuZ2V0KEF1dGhvcml6ZVJlcXVlc3RQYXJhbS5TVEFURSkKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXV0aGVudGljYXRlLiBzdGVwID09MS4gaWYgc2VsZi5pc0luYm91bmRGbG93KGlkZW50aXR5KTouIgogICAgICAgICAgICAgICAgcHJpbnQgImp3dF9wYXJhbSA9ICVzIiAlIGp3dF9wYXJhbQogICAgICAgICAgICAgICAgIyBub3cgand0X3BhcmFtICE9IE5vbmUKCgoKICAgICAgICAgICAgaWYgand0X3BhcmFtID09IE5vbmU6CiAgICAgICAgICAgICAgICBwcmludCAiRW50ZXJlZCBpZiBqd3RfcGFyYW0gPT0gTm9uZSIKICAgICAgICAgICAgICAgICMgZ2V0cyBqd3QgcGFyYW1ldGVyICJ1c2VyIiBzZW50IGFmdGVyIGF1dGhlbnRpY2F0aW9uIGJ5IHBhc3Nwb3J0IChpZiBleGlzdHMpCiAgICAgICAgICAgICAgICBqd3RfcGFyYW0gPSBTZXJ2ZXJVdGlsLmdldEZpcnN0VmFsdWUocmVxdWVzdFBhcmFtZXRlcnMsICJ1c2VyIikKCgogICAgICAgICAgICBpZiBqd3RfcGFyYW0gIT0gTm9uZToKICAgICAgICAgICAgICAgICMgYW5kIG5vdyB0aGF0IHRoZSBqd3RfcGFyYW0gdXNlciBleGlzdHMuLi4KICAgICAgICAgICAgICAgIHByaW50ICJFbnRlcmVkIGlmIGp3dF9wYXJhbSAhPSBOb25lIgogICAgICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBhdXRoZW50aWNhdGUgZm9yIHN0ZXAgMS4gSldUIHVzZXIgcHJvZmlsZSB0b2tlbiBmb3VuZCIKCiAgICAgICAgICAgICAgICBpZiBzZWxmLmlzSW5ib3VuZEZsb3coaWRlbnRpdHkpOgogICAgICAgICAgICAgICAgICAgIGp3dF9wYXJhbSA9IGJhc2U2NC51cmxzYWZlX2I2NGRlY29kZShzdHIoand0X3BhcmFtKyc9PScpKQoKICAgICAgICAgICAgICAgICMgUGFyc2UgSldUIGFuZCB2YWxpZGF0ZQogICAgICAgICAgICAgICAgand0ID0gSnd0LnBhcnNlKGp3dF9wYXJhbSkKCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi52YWxpZFNpZ25hdHVyZShqd3QpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgICAgIGlmIHNlbGYuand0SGFzRXhwaXJlZChqd3QpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgICAgICMgR2V0cyB1c2VyIHByb2ZpbGUgYXMgc3RyaW5nIGFuZCBqc29uIHVzaW5nIHRoZSBpbmZvcm1hdGlvbiBvbiBKV1QKICAgICAgICAgICAgICAgICh1c2VyX3Byb2ZpbGUsIGpzb25wKSA9IHNlbGYuZ2V0VXNlclByb2ZpbGUoand0KQoKICAgICAgICAgICAgICAgIGlmIHVzZXJfcHJvZmlsZSA9PSBOb25lOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgICAgIHNlc3Npb25BdHRyaWJ1dGVzID0gaWRlbnRpdHkuZ2V0U2Vzc2lvbklkKCkuZ2V0U2Vzc2lvbkF0dHJpYnV0ZXMoKQogICAgICAgICAgICAgICAgc2VsZi5za2lwUHJvZmlsZVVwZGF0ZSA9IFN0cmluZ0hlbHBlci5lcXVhbHNJZ25vcmVDYXNlKHNlc3Npb25BdHRyaWJ1dGVzLmdldCgic2tpcFBhc3Nwb3J0UHJvZmlsZVVwZGF0ZSIpLCAidHJ1ZSIpCgogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuYXR0ZW1wdEF1dGhlbnRpY2F0aW9uKGlkZW50aXR5LCB1c2VyX3Byb2ZpbGUsIGpzb25wKQoKICAgICAgICAgICAgI1NlZSBwYXNzcG9ydGxvZ2luLnhodG1sCiAgICAgICAgICAgIHByaW50ICItLS0tLS0tLS0tLS0tPT09PT09PT09PT09LS0tLS0tLS0tLS0tIgogICAgICAgICAgICBwcm92aWRlciA9IFNlcnZlclV0aWwuZ2V0Rmlyc3RWYWx1ZShyZXF1ZXN0UGFyYW1ldGVycywgImxvZ2luRm9ybTpwcm92aWRlciIpCiAgICAgICAgICAgIHByaW50ICJhdXRoZW50aWNhdGUoKSAtIHByb3ZpZGVyID0gJXMiICUgc3RyKHByb3ZpZGVyKQoKCiAgICAgICAgICAgIHByaW50ICJhdXRoZW50aWNhdGUgLSBzZWxmLnJlZ2lzdGVyZWRQcm92aWRlcnM6ICVzIiAlIHN0cihzZWxmLnJlZ2lzdGVyZWRQcm92aWRlcnMpCiAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KHByb3ZpZGVyKToKCiAgICAgICAgICAgICAgICAjaXQncyB1c2VybmFtZSArIHBhc3N3IGF1dGgKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXV0aGVudGljYXRlIGZvciBzdGVwIDEuIEJhc2ljIGF1dGhlbnRpY2F0aW9uIGRldGVjdGVkIgogICAgICAgICAgICAgICAgbG9nZ2VkX2luID0gRmFsc2UKCiAgICAgICAgICAgICAgICBjcmVkZW50aWFscyA9IGlkZW50aXR5LmdldENyZWRlbnRpYWxzKCkKICAgICAgICAgICAgICAgIHVzZXJfbmFtZSA9IGNyZWRlbnRpYWxzLmdldFVzZXJuYW1lKCkKICAgICAgICAgICAgICAgIHVzZXJfcGFzc3dvcmQgPSBjcmVkZW50aWFscy5nZXRQYXNzd29yZCgpCgogICAgICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9uYW1lKSBhbmQgU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9wYXNzd29yZCk6CiAgICAgICAgICAgICAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkKICAgICAgICAgICAgICAgICAgICBsb2dnZWRfaW4gPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJfbmFtZSwgdXNlcl9wYXNzd29yZCkKCiAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiBCYXNpYyBhdXRoZW50aWNhdGlvbiByZXR1cm5lZDogJXMiICUgbG9nZ2VkX2luCiAgICAgICAgICAgICAgICByZXR1cm4gbG9nZ2VkX2luCgoKCiAgICAgICAgICAgIGVsaWYgcHJvdmlkZXIgaW4gc2VsZi5yZWdpc3RlcmVkUHJvdmlkZXJzOgogICAgICAgICAgICAgICAgIyB1c2VyIHNlbGVjdGVkIHByb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgIyBpdCdzIGEgcmVjb2duaXplZCBleHRlcm5hbCBJRFAKCiAgICAgICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJzZWxlY3RlZFByb3ZpZGVyIiwgcHJvdmlkZXIpCiAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiBSZXRyeWluZyBzdGVwIDEiCgogICAgICAgICAgICAgICAgI3NlZSBwcmVwYXJlRm9yU3RlcCAoc3RlcCA9IDEpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICBpZiBzdGVwID09IDI6CiAgICAgICAgICAgIG1haWwgPSBTZXJ2ZXJVdGlsLmdldEZpcnN0VmFsdWUocmVxdWVzdFBhcmFtZXRlcnMsICJsb2dpbkZvcm06ZW1haWwiKQogICAgICAgICAgICBqc29ucCA9IGlkZW50aXR5LmdldFdvcmtpbmdQYXJhbWV0ZXIoInBhc3Nwb3J0X3VzZXJfcHJvZmlsZSIpCgogICAgICAgICAgICBpZiBtYWlsID09IE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLnNldE1lc3NhZ2VFcnJvcihGYWNlc01lc3NhZ2UuU0VWRVJJVFlfRVJST1IsICJFbWFpbCB3YXMgbWlzc2luZyBpbiB1c2VyIHByb2ZpbGUiKQogICAgICAgICAgICBlbGlmIGpzb25wICE9IE5vbmU6CiAgICAgICAgICAgICAgICAjIENvbXBsZXRpb24gb2YgcHJvZmlsZSB0YWtlcyBwbGFjZQogICAgICAgICAgICAgICAgdXNlcl9wcm9maWxlID0ganNvbi5sb2Fkcyhqc29ucCkKICAgICAgICAgICAgICAgIHVzZXJfcHJvZmlsZVsibWFpbCJdID0gWyBtYWlsIF0KCiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5hdHRlbXB0QXV0aGVudGljYXRpb24oaWRlbnRpdHksIHVzZXJfcHJvZmlsZSwganNvbnApCgogICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAyLiBGYWlsZWQ6IGV4cGVjdGVkIG1haWwgdmFsdWUgaW4gSFRUUCByZXF1ZXN0IGFuZCBqc29uIHByb2ZpbGUgaW4gc2Vzc2lvbiIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgoKICAgIGRlZiBwcmVwYXJlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgoKICAgICAgICBleHRlbnNpb25SZXN1bHQgPSBzZWxmLmV4dGVuc2lvblByZXBhcmVGb3JTdGVwKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCkKICAgICAgICBpZiBleHRlbnNpb25SZXN1bHQgIT0gTm9uZToKICAgICAgICAgICAgcmV0dXJuIGV4dGVuc2lvblJlc3VsdAoKICAgICAgICBwcmludCAiUGFzc3BvcnQuIHByZXBhcmVGb3JTdGVwIGNhbGxlZCAlcyIgICUgc3RyKHN0ZXApCiAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCgogICAgICAgIGlmIHN0ZXAgPT0gMToKICAgICAgICAgICAgI3JlLXJlYWQgdGhlIHN0cmF0ZWdpZXMgY29uZmlnIChmb3IgaW5zdGFuY2UgdG8ga25vdyB3aGljaCBzdHJhdGVnaWVzIGhhdmUgZW5hYmxlZCB0aGUgZW1haWwgYWNjb3VudCBsaW5raW5nKQogICAgICAgICAgICBzZWxmLnBhcnNlUHJvdmlkZXJDb25maWdzKCkKICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigiZXh0ZXJuYWxQcm92aWRlcnMiLCBqc29uLmR1bXBzKHNlbGYucmVnaXN0ZXJlZFByb3ZpZGVycykpCgogICAgICAgICAgICBwcm92aWRlclBhcmFtID0gc2VsZi5jdXN0b21BdXRoelBhcmFtZXRlcgogICAgICAgICAgICB1cmwgPSBOb25lCgogICAgICAgICAgICBzZXNzaW9uQXR0cmlidXRlcyA9IGlkZW50aXR5LmdldFNlc3Npb25JZCgpLmdldFNlc3Npb25BdHRyaWJ1dGVzKCkKICAgICAgICAgICAgc2VsZi5za2lwUHJvZmlsZVVwZGF0ZSA9IFN0cmluZ0hlbHBlci5lcXVhbHNJZ25vcmVDYXNlKHNlc3Npb25BdHRyaWJ1dGVzLmdldCgic2tpcFBhc3Nwb3J0UHJvZmlsZVVwZGF0ZSIpLCAidHJ1ZSIpCgogICAgICAgICAgICAjdGhpcyBwYXJhbSBjb3VsZCBoYXZlIGJlZW4gc2V0IHByZXZpb3VzbHkgaW4gYXV0aGVudGljYXRlIHN0ZXAgaWYgY3VycmVudCBzdGVwIGlzIGJlaW5nIHJldHJpZWQKICAgICAgICAgICAgcHJvdmlkZXIgPSBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKCJzZWxlY3RlZFByb3ZpZGVyIikKICAgICAgICAgICAgcHJpbnQgInByZXBhcmVGb3JTdGVwICVzIC0gcHJvdmlkZXIgPSAlcyIgJSAoc3RyKHN0ZXApLCBzdHIocHJvdmlkZXIpKQoKICAgICAgICAgICAgIyBpZiB0aGVyZSBpcyBhIHNlbGVjdGVkUHJvdmlkZXIKICAgICAgICAgICAgaWYgcHJvdmlkZXIgIT0gTm9uZToKCiAgICAgICAgICAgICAgICAjIGdldCB0aGUgcmVkaXJlY3QgVVJMIHRvIHVzZSBhdCBmYWNlc1NlcnZpY2UucmVkaXJlY3RUb0V4dGVybmFsVVJMKCkgdGhhdCBzZW5kcyAvcGFzc3BvcnQvYXV0aC88cHJvdmlkZXI+Lzx0b2tlbj4KICAgICAgICAgICAgICAgIHVybCA9IHNlbGYuZ2V0UGFzc3BvcnRSZWRpcmVjdFVybChwcm92aWRlcikKICAgICAgICAgICAgICAgIHByaW50ICJwcmVwYXJlRm9yU3RlcCAlcyAtIHVybCA9ICVzIiAlIChzdHIoc3RlcCksIHVybCkKCiAgICAgICAgICAgICAgICAjIHNldHMgc2VsZWN0ZWRQcm92aWRlciBiYWNrIHRvIE5vbmUKICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInNlbGVjdGVkUHJvdmlkZXIiLCBOb25lKQoKICAgICAgICAgICAgIyBpZiB0aGVyZSBpcyBjdXN0b21BdXRoelBhcmFtZXRlcgogICAgICAgICAgICBlbGlmIHByb3ZpZGVyUGFyYW0gIT0gTm9uZToKCgogICAgICAgICAgICAgICAgIyBnZXQgaXQgZnJvbSBzZXNzaW9uQXRyaWJ1dGVzCiAgICAgICAgICAgICAgICBwYXJhbVZhbHVlID0gc2Vzc2lvbkF0dHJpYnV0ZXMuZ2V0KHByb3ZpZGVyUGFyYW0pCgogICAgICAgICAgICAgICAgI2lmIGV4aXN0cwogICAgICAgICAgICAgICAgaWYgcGFyYW1WYWx1ZSAhPSBOb25lOgogICAgICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gcHJlcGFyZUZvclN0ZXAuIEZvdW5kIHZhbHVlIGluIGN1c3RvbSBwYXJhbSBvZiBhdXRob3JpemF0aW9uIHJlcXVlc3Q6ICVzIiAlIHBhcmFtVmFsdWUKICAgICAgICAgICAgICAgICAgICBwcm92aWRlciA9IHNlbGYuZ2V0UHJvdmlkZXJGcm9tSnNvbihwYXJhbVZhbHVlKQoKICAgICAgICAgICAgICAgICAgICBpZiBwcm92aWRlciA9PSBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIHByZXBhcmVGb3JTdGVwLiBBIHByb3ZpZGVyIHZhbHVlIGNvdWxkIG5vdCBiZSBleHRyYWN0ZWQgZnJvbSBjdXN0b20gYXV0aG9yaXphdGlvbiByZXF1ZXN0IHBhcmFtZXRlciIKICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBwcm92aWRlciBpbiBzZWxmLnJlZ2lzdGVyZWRQcm92aWRlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gcHJlcGFyZUZvclN0ZXAuIFByb3ZpZGVyICclcycgbm90IHBhcnQgb2Yga25vd24gY29uZmlndXJlZCBJRFBzL09QcyIgJSBwcm92aWRlcgogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9IHNlbGYuZ2V0UGFzc3BvcnRSZWRpcmVjdFVybChwcm92aWRlcikKCgogICAgICAgICAgICAjIGlmIG5vIHByb3ZpZGVyIHNlbGVjdGVkIHlldC4uLgogICAgICAgICAgICBpZiB1cmwgPT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gcHJlcGFyZUZvclN0ZXAuIEEgcGFnZSB0byBtYW51YWxseSBzZWxlY3QgYW4gaWRlbnRpdHkgcHJvdmlkZXIgd2lsbCBiZSBzaG93biIKCiAgICAgICAgICAgICMgZWxzZSBhbHJlYWR5IGdvdCB0aGUgL3Bhc3Nwb3J0L2F1dGgvPHByb3ZpZGVyPi88dG9rZW4+IHVybC4uLgogICAgICAgICAgICBlbHNlOgoKICAgICAgICAgICAgICAgIGZhY2VzU2VydmljZSA9IENkaVV0aWwuYmVhbihGYWNlc1NlcnZpY2UpCgogICAgICAgICAgICAgICAgIyByZWRpcmVjdHMgdG8gUGFzc3BvcnQgZ2V0UmVkaXJlY3RVUkwgLSBzZW5kcyBicm93c2VyIHRvIElEUC4KICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gUmVkaXJlY3RpbmcgdG8gZXh0ZXJuYWwgdXJsOiAlcyIgKyB1cmwKCiAgICAgICAgICAgICAgICBmYWNlc1NlcnZpY2UucmVkaXJlY3RUb0V4dGVybmFsVVJMKHVybCkKCiAgICAgICAgcmV0dXJuIFRydWUKCgogICAgZGVmIGdldEV4dHJhUGFyYW1ldGVyc0ZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0RXh0cmFQYXJhbWV0ZXJzRm9yU3RlcCBjYWxsZWQgZm9yIHN0ZXAgJXMiICUgc3RyKHN0ZXApCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICByZXR1cm4gQXJyYXlzLmFzTGlzdCgic2VsZWN0ZWRQcm92aWRlciIsICJleHRlcm5hbFByb3ZpZGVycyIpCiAgICAgICAgZWxpZiBzdGVwID09IDI6CiAgICAgICAgICAgIHJldHVybiBBcnJheXMuYXNMaXN0KCJwYXNzcG9ydF91c2VyX3Byb2ZpbGUiKQogICAgICAgIHJldHVybiBOb25lCgoKICAgIGRlZiBnZXRDb3VudEF1dGhlbnRpY2F0aW9uU3RlcHMoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0Q291bnRBdXRoZW50aWNhdGlvblN0ZXBzIGNhbGxlZCIKICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKICAgICAgICBpZiBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKCJwYXNzcG9ydF91c2VyX3Byb2ZpbGUiKSAhPSBOb25lOgogICAgICAgICAgICByZXR1cm4gMgogICAgICAgIHJldHVybiAxCgoKICAgIGRlZiBnZXRQYWdlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgc3RlcCk6CiAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBnZXRQYWdlRm9yU3RlcCBjYWxsZWQiCgogICAgICAgIGV4dGVuc2lvblJlc3VsdCA9IHNlbGYuZXh0ZW5zaW9uR2V0UGFnZUZvclN0ZXAoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApCiAgICAgICAgaWYgZXh0ZW5zaW9uUmVzdWx0ICE9IE5vbmU6CiAgICAgICAgICAgIHJldHVybiBleHRlbnNpb25SZXN1bHQKCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBnZXRQYWdlRm9yU3RlcC4gRW50ZXJlZCBpZiBzdGVwID09MSIKICAgICAgICAgICAgaWYgc2VsZi5pc0luYm91bmRGbG93KGlkZW50aXR5KToKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0UGFnZUZvclN0ZXAgZm9yIHN0ZXAgMS4gRGV0ZWN0ZWQgaW5ib3VuZCBTYW1sIGZsb3ciCiAgICAgICAgICAgICAgICByZXR1cm4gIi9wb3N0bG9naW4ueGh0bWwiCiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0UGFnZUZvclN0ZXAgMS4gTm9ybWFsRmxvdywgcmV0dXJuaW5nIHBhc3Nwb3J0bG9naW4ueGh0bWwiCiAgICAgICAgICAgIHJldHVybiAiL2F1dGgvcGFzc3BvcnQvcGFzc3BvcnRsb2dpbi54aHRtbCIKCiAgICAgICAgcmV0dXJuICIvYXV0aC9wYXNzcG9ydC9wYXNzcG9ydHBvc3Rsb2dpbi54aHRtbCIKCgogICAgZGVmIGdldE5leHRTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCk6CiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICBpZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkKICAgICAgICAgICAgcHJvdmlkZXIgPSBpZGVudGl0eS5nZXRXb3JraW5nUGFyYW1ldGVyKCJzZWxlY3RlZFByb3ZpZGVyIikKICAgICAgICAgICAgaWYgcHJvdmlkZXIgIT0gTm9uZToKICAgICAgICAgICAgICAgIHJldHVybiAxCgogICAgICAgIHJldHVybiAtMQoKCiAgICBkZWYgbG9nb3V0KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcmV0dXJuIFRydWUKCiMgRXh0ZW5zaW9uIG1vZHVsZSByZWxhdGVkIGZ1bmN0aW9ucwoKICAgIGRlZiBleHRlbnNpb25Jbml0KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKCiAgICAgICAgaWYgc2VsZi5leHRlbnNpb25Nb2R1bGUgPT0gTm9uZToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICByZXR1cm4gc2VsZi5leHRlbnNpb25Nb2R1bGUuaW5pdChjb25maWd1cmF0aW9uQXR0cmlidXRlcykKCgogICAgZGVmIGV4dGVuc2lvbkF1dGhlbnRpY2F0ZShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgoKICAgICAgICBpZiBzZWxmLmV4dGVuc2lvbk1vZHVsZSA9PSBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHJldHVybiBzZWxmLmV4dGVuc2lvbk1vZHVsZS5hdXRoZW50aWNhdGUoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKQoKCiAgICBkZWYgZXh0ZW5zaW9uUHJlcGFyZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKCiAgICAgICAgaWYgc2VsZi5leHRlbnNpb25Nb2R1bGUgPT0gTm9uZToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICByZXR1cm4gc2VsZi5leHRlbnNpb25Nb2R1bGUucHJlcGFyZUZvclN0ZXAoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKQoKCiAgICBkZWYgZXh0ZW5zaW9uR2V0UGFnZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgoKICAgICAgICBpZiBzZWxmLmV4dGVuc2lvbk1vZHVsZSA9PSBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHJldHVybiBzZWxmLmV4dGVuc2lvbk1vZHVsZS5nZXRQYWdlRm9yU3RlcChjb25maWd1cmF0aW9uQXR0cmlidXRlcywgc3RlcCkKCiMgSW5pdGFsaXphdGlvbiByb3V0aW5lcwoKICAgIGRlZiBsb2FkRXh0ZXJuYWxNb2R1bGUoc2VsZiwgc2ltcGxlQ3VzdFByb3BlcnR5KToKCiAgICAgICAgaWYgc2ltcGxlQ3VzdFByb3BlcnR5ICE9IE5vbmU6CiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gbG9hZEV4dGVybmFsTW9kdWxlLiBMb2FkaW5nIHBhc3Nwb3J0IGV4dGVuc2lvbiBtb2R1bGUuLi4iCiAgICAgICAgICAgIG1vZHVsZU5hbWUgPSBzaW1wbGVDdXN0UHJvcGVydHkuZ2V0VmFsdWUyKCkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbW9kdWxlID0gX19pbXBvcnRfXyhtb2R1bGVOYW1lKQogICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGxvYWRFeHRlcm5hbE1vZHVsZS4gRmFpbGVkIHRvIGxvYWQgbW9kdWxlICVzIiAlIG1vZHVsZU5hbWUKICAgICAgICAgICAgICAgIHByaW50ICJFeGNlcHRpb246ICIsIHN5cy5leGNfaW5mbygpWzFdCiAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGxvYWRFeHRlcm5hbE1vZHVsZS4gRmxvdyB3aWxsIGJlIGRyaXZlbiBlbnRpcmVseSBieSByb3V0aW5lcyBvZiBtYWluIHBhc3Nwb3J0IHNjcmlwdCIKICAgICAgICByZXR1cm4gTm9uZQoKCiAgICBkZWYgcHJvY2Vzc0tleVN0b3JlUHJvcGVydGllcyhzZWxmLCBhdHRycyk6CiAgICAgICAgZmlsZSA9IGF0dHJzLmdldCgia2V5X3N0b3JlX2ZpbGUiKQogICAgICAgIHBhc3N3b3JkID0gYXR0cnMuZ2V0KCJrZXlfc3RvcmVfcGFzc3dvcmQiKQoKICAgICAgICBpZiBmaWxlICE9IE5vbmUgYW5kIHBhc3N3b3JkICE9IE5vbmU6CiAgICAgICAgICAgIGZpbGUgPSBmaWxlLmdldFZhbHVlMigpCiAgICAgICAgICAgIHBhc3N3b3JkID0gcGFzc3dvcmQuZ2V0VmFsdWUyKCkKCiAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5KGZpbGUpIGFuZCBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eShwYXNzd29yZCk6CiAgICAgICAgICAgICAgICBzZWxmLmtleVN0b3JlRmlsZSA9IGZpbGUKICAgICAgICAgICAgICAgIHNlbGYua2V5U3RvcmVQYXNzd29yZCA9IHBhc3N3b3JkCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICBwcmludCAiUGFzc3BvcnQuIHJlYWRLZXlTdG9yZVByb3BlcnRpZXMuIFByb3BlcnRpZXMga2V5X3N0b3JlX2ZpbGUgb3Iga2V5X3N0b3JlX3Bhc3N3b3JkIG5vdCBmb3VuZCBvciBlbXB0eSIKICAgICAgICByZXR1cm4gRmFsc2UKCgogICAgZGVmIGdldEN1c3RvbUF1dGh6UGFyYW1ldGVyKHNlbGYsIHNpbXBsZUN1c3RQcm9wZXJ0eSk6CgogICAgICAgIGN1c3RvbUF1dGh6UGFyYW1ldGVyID0gTm9uZQogICAgICAgIGlmIHNpbXBsZUN1c3RQcm9wZXJ0eSAhPSBOb25lOgogICAgICAgICAgICBwcm9wID0gc2ltcGxlQ3VzdFByb3BlcnR5LmdldFZhbHVlMigpCiAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc05vdEVtcHR5KHByb3ApOgogICAgICAgICAgICAgICAgY3VzdG9tQXV0aHpQYXJhbWV0ZXIgPSBwcm9wCgogICAgICAgIGlmIGN1c3RvbUF1dGh6UGFyYW1ldGVyID09IE5vbmU6CiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0Q3VzdG9tQXV0aHpQYXJhbWV0ZXIuIE5vIGN1c3RvbSBwYXJhbSBmb3IgT0lEQyBhdXRoeiByZXF1ZXN0IGluIHNjcmlwdCBwcm9wZXJ0aWVzIgogICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGdldEN1c3RvbUF1dGh6UGFyYW1ldGVyLiBQYXNzcG9ydCBmbG93IGNhbm5vdCBiZSBpbml0aWF0ZWQgYnkgZG9pbmcgYW4gT3BlbklEIGNvbm5lY3QgYXV0aG9yaXphdGlvbiByZXF1ZXN0IgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0Q3VzdG9tQXV0aHpQYXJhbWV0ZXIuIEN1c3RvbSBwYXJhbSBmb3IgT0lEQyBhdXRoeiByZXF1ZXN0IGluIHNjcmlwdCBwcm9wZXJ0aWVzOiAlcyIgJSBjdXN0b21BdXRoelBhcmFtZXRlcgoKICAgICAgICByZXR1cm4gY3VzdG9tQXV0aHpQYXJhbWV0ZXIKCiMgQ29uZmlndXJhdGlvbiBwYXJzaW5nCgogICAgZGVmIGdldFBhc3Nwb3J0Q29uZmlnRE4oc2VsZik6CgogICAgICAgIGYgPSBvcGVuKCcvZXRjL2dsdXUvY29uZi9nbHV1LnByb3BlcnRpZXMnLCAncicpCiAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgcHJvcCA9IGxpbmUuc3BsaXQoIj0iKQogICAgICAgICAgICBpZiBwcm9wWzBdID09ICJveHBhc3Nwb3J0X0NvbmZpZ3VyYXRpb25FbnRyeUROIjoKICAgICAgICAgICAgICBwcm9wLnBvcCgwKQogICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIGYuY2xvc2UoKQogICAgICAgIHJldHVybiAiPSIuam9pbihwcm9wKS5zdHJpcCgpCgoKICAgIGRlZiBwYXJzZUFsbFByb3ZpZGVycyhzZWxmKToKCiAgICAgICAgcmVnaXN0ZXJlZFByb3ZpZGVycyA9IHt9CiAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBwYXJzZUFsbFByb3ZpZGVycy4gQWRkaW5nIHByb3ZpZGVycyIKICAgICAgICBlbnRyeU1hbmFnZXIgPSBDZGlVdGlsLmJlYW4oUGVyc2lzdGVuY2VFbnRyeU1hbmFnZXIpCgogICAgICAgIGNvbmZpZyA9IExkYXBPeFBhc3Nwb3J0Q29uZmlndXJhdGlvbigpCiAgICAgICAgY29uZmlnID0gZW50cnlNYW5hZ2VyLmZpbmQoY29uZmlnLmdldENsYXNzKCksIHNlbGYucGFzc3BvcnRETikuZ2V0UGFzc3BvcnRDb25maWd1cmF0aW9uKCkKICAgICAgICBjb25maWcgPSBjb25maWcuZ2V0UHJvdmlkZXJzKCkgaWYgY29uZmlnICE9IE5vbmUgZWxzZSBjb25maWcKCiAgICAgICAgaWYgY29uZmlnICE9IE5vbmUgYW5kIGxlbihjb25maWcpID4gMDoKICAgICAgICAgICAgZm9yIHBydmRldGFpbHMgaW4gY29uZmlnOgogICAgICAgICAgICAgICAgaWYgcHJ2ZGV0YWlscy5pc0VuYWJsZWQoKToKICAgICAgICAgICAgICAgICAgICByZWdpc3RlcmVkUHJvdmlkZXJzW3BydmRldGFpbHMuZ2V0SWQoKV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICJlbWFpbExpbmtpbmdTYWZlIjogcHJ2ZGV0YWlscy5pc0VtYWlsTGlua2luZ1NhZmUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVlc3RGb3JFbWFpbCIgOiBwcnZkZXRhaWxzLmlzUmVxdWVzdEZvckVtYWlsKCksCiAgICAgICAgICAgICAgICAgICAgICAgICJsb2dvX2ltZyI6IHBydmRldGFpbHMuZ2V0TG9nb0ltZygpLAogICAgICAgICAgICAgICAgICAgICAgICAiZGlzcGxheU5hbWUiOiBwcnZkZXRhaWxzLmdldERpc3BsYXlOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogcHJ2ZGV0YWlscy5nZXRUeXBlKCkKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgIHJldHVybiByZWdpc3RlcmVkUHJvdmlkZXJzCgoKICAgIGRlZiBwYXJzZVByb3ZpZGVyQ29uZmlncyhzZWxmKToKCiAgICAgICAgcmVnaXN0ZXJlZFByb3ZpZGVycyA9IHt9CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZWdpc3RlcmVkUHJvdmlkZXJzID0gc2VsZi5wYXJzZUFsbFByb3ZpZGVycygpCiAgICAgICAgICAgIHRvUmVtb3ZlID0gW10KCiAgICAgICAgICAgIGZvciBwcm92aWRlciBpbiByZWdpc3RlcmVkUHJvdmlkZXJzOgogICAgICAgICAgICAgICAgaWYgcmVnaXN0ZXJlZFByb3ZpZGVyc1twcm92aWRlcl1bInR5cGUiXSAhPSAic2FtbCI6CiAgICAgICAgICAgICAgICAgICAgdG9SZW1vdmUuYXBwZW5kKHByb3ZpZGVyKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZWdpc3RlcmVkUHJvdmlkZXJzW3Byb3ZpZGVyXVsic2FtbCJdID0gVHJ1ZQoKICAgICAgICAgICAgZm9yIHByb3ZpZGVyIGluIHRvUmVtb3ZlOgogICAgICAgICAgICAgICAgcmVnaXN0ZXJlZFByb3ZpZGVycy5wb3AocHJvdmlkZXIpCgoKICAgICAgICAgICAgaWYgbGVuKHJlZ2lzdGVyZWRQcm92aWRlcnMua2V5cygpKSA+IDA6CiAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIHBhcnNlUHJvdmlkZXJDb25maWdzLiBDb25maWd1cmVkIHByb3ZpZGVyczoiLCByZWdpc3RlcmVkUHJvdmlkZXJzCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIHBhcnNlUHJvdmlkZXJDb25maWdzLiBObyBwcm92aWRlcnMgcmVnaXN0ZXJlZCB5ZXQiCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIHBhcnNlUHJvdmlkZXJDb25maWdzLiBBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSBidWlsZGluZyB0aGUgbGlzdCBvZiBzdXBwb3J0ZWQgYXV0aGVudGljYXRpb24gcHJvdmlkZXJzIiwgc3lzLmV4Y19pbmZvKClbMV0KCgogICAgICAgIHByaW50ICJwYXJzZVByb3ZpZGVyQ29uZmlncyAtIHJlZ2lzdGVyZWRQcm92aWRlcnMgPSAlcyIgJSBzdHIocmVnaXN0ZXJlZFByb3ZpZGVycykKICAgICAgICBzZWxmLnJlZ2lzdGVyZWRQcm92aWRlcnMgPSByZWdpc3RlcmVkUHJvdmlkZXJzCiAgICAgICAgcHJpbnQgInBhcnNlUHJvdmlkZXJDb25maWdzIC0gc2VsZi5yZWdpc3RlcmVkUHJvdmlkZXJzID0gJXMiICUgc3RyKHNlbGYucmVnaXN0ZXJlZFByb3ZpZGVycykKCiMgQXV4aWxpYXJ5IHJvdXRpbmVzCgogICAgZGVmIGdldFByb3ZpZGVyRnJvbUpzb24oc2VsZiwgcHJvdmlkZXJKc29uKToKCiAgICAgICAgcHJvdmlkZXIgPSBOb25lCiAgICAgICAgdHJ5OgogICAgICAgICAgICBvYmogPSBqc29uLmxvYWRzKEJhc2U2NFV0aWwuYmFzZTY0dXJsZGVjb2RlVG9TdHJpbmcocHJvdmlkZXJKc29uKSkKICAgICAgICAgICAgcHJvdmlkZXIgPSBvYmpbc2VsZi5wcm92aWRlcktleV0KICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0UHJvdmlkZXJGcm9tSnNvbi4gQ291bGQgbm90IHBhcnNlIHByb3ZpZGVkIEpzb24gc3RyaW5nLiBSZXR1cm5pbmcgTm9uZSIKCiAgICAgICAgcmV0dXJuIHByb3ZpZGVyCgoKICAgIGRlZiBnZXRQYXNzcG9ydFJlZGlyZWN0VXJsKHNlbGYsIHByb3ZpZGVyKToKCiAgICAgICAgIyBwcm92aWRlciBpcyBhc3N1bWVkIHRvIGV4aXN0IGluIHNlbGYucmVnaXN0ZXJlZFByb3ZpZGVycwogICAgICAgIHVybCA9IE5vbmUKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZhY2VzQ29udGV4dCA9IENkaVV0aWwuYmVhbihGYWNlc0NvbnRleHQpCiAgICAgICAgICAgIHRva2VuRW5kcG9pbnQgPSAiaHR0cHM6Ly8lcy9wYXNzcG9ydC90b2tlbiIgJSBmYWNlc0NvbnRleHQuZ2V0RXh0ZXJuYWxDb250ZXh0KCkuZ2V0UmVxdWVzdCgpLmdldFNlcnZlck5hbWUoKQoKICAgICAgICAgICAgaHR0cFNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oSHR0cFNlcnZpY2UpCiAgICAgICAgICAgIGh0dHBjbGllbnQgPSBodHRwU2VydmljZS5nZXRIdHRwc0NsaWVudCgpCgogICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGdldFBhc3Nwb3J0UmVkaXJlY3RVcmwuIE9idGFpbmluZyB0b2tlbiBmcm9tIHBhc3Nwb3J0IGF0ICVzIiAlIHRva2VuRW5kcG9pbnQKICAgICAgICAgICAgcmVzdWx0UmVzcG9uc2UgPSBodHRwU2VydmljZS5leGVjdXRlR2V0KGh0dHBjbGllbnQsIHRva2VuRW5kcG9pbnQsIENvbGxlY3Rpb25zLnNpbmdsZXRvbk1hcCgiQWNjZXB0IiwgInRleHQvanNvbiIpKQogICAgICAgICAgICBodHRwUmVzcG9uc2UgPSByZXN1bHRSZXNwb25zZS5nZXRIdHRwUmVzcG9uc2UoKQoKICAgICAgICAgICAgYnl0ZXMgPSBodHRwU2VydmljZS5nZXRSZXNwb25zZUNvbnRlbnQoaHR0cFJlc3BvbnNlKQoKICAgICAgICAgICAgcmVzcG9uc2UgPSBodHRwU2VydmljZS5jb252ZXJ0RW50aXR5VG9TdHJpbmcoYnl0ZXMpCiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0UGFzc3BvcnRSZWRpcmVjdFVybC4gUmVzcG9uc2Ugd2FzICVzIiAlIGh0dHBSZXNwb25zZS5nZXRTdGF0dXNMaW5lKCkuZ2V0U3RhdHVzQ29kZSgpCgogICAgICAgICAgICB0b2tlbk9iaiA9IGpzb24ubG9hZHMocmVzcG9uc2UpCgogICAgICAgICAgICB1cmwgPSAiL3Bhc3Nwb3J0L2F1dGgvJXMvJXMiICUgKHByb3ZpZGVyLCB0b2tlbk9ialsidG9rZW5fIl0pCgogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBnZXRQYXNzcG9ydFJlZGlyZWN0VXJsLiBFcnJvciBidWlsZGluZyByZWRpcmVjdCBVUkw6ICIsIHN5cy5leGNfaW5mbygpWzFdCgogICAgICAgIHJldHVybiB1cmwKCgogICAgZGVmIHZhbGlkU2lnbmF0dXJlKHNlbGYsIGp3dCk6CgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gdmFsaWRTaWduYXR1cmUuIENoZWNraW5nIEpXVCB0b2tlbiBzaWduYXR1cmUiCiAgICAgICAgdmFsaWQgPSBGYWxzZQoKICAgICAgICB0cnk6CgogICAgICAgICAgICBhcHBDb25maWd1cmF0aW9uID0gQXBwQ29uZmlndXJhdGlvbigpCiAgICAgICAgICAgIGFwcENvbmZpZ3VyYXRpb24uc2V0V2ViS2V5c1N0b3JhZ2UoV2ViS2V5U3RvcmFnZS5LRVlTVE9SRSkKICAgICAgICAgICAgYXBwQ29uZmlndXJhdGlvbi5zZXRLZXlTdG9yZUZpbGUoc2VsZi5rZXlTdG9yZUZpbGUpCiAgICAgICAgICAgIGFwcENvbmZpZ3VyYXRpb24uc2V0S2V5U3RvcmVTZWNyZXQoc2VsZi5rZXlTdG9yZVBhc3N3b3JkKQogICAgICAgICAgICBhcHBDb25maWd1cmF0aW9uLnNldEtleVJlZ2VuZXJhdGlvbkVuYWJsZWQoRmFsc2UpCgogICAgICAgICAgICBjcnlwdG9Qcm92aWRlciA9IENyeXB0b1Byb3ZpZGVyRmFjdG9yeS5nZXRDcnlwdG9Qcm92aWRlcihhcHBDb25maWd1cmF0aW9uKQoKCiAgICAgICAgICAgIGFsZ19zdHJpbmcgPSBzdHIoand0LmdldEhlYWRlcigpLmdldFNpZ25hdHVyZUFsZ29yaXRobSgpKQogICAgICAgICAgICBzaWduYXR1cmVfc3RyaW5nID0gc3RyKGp3dC5nZXRFbmNvZGVkU2lnbmF0dXJlKCkpCgogICAgICAgICAgICBpZiBhbGdfc3RyaW5nID09ICJub25lIiBvciBhbGdfc3RyaW5nID09ICJOb25lIiBvciBhbGdfc3RyaW5nID09ICJOb05lIiBvciBhbGdfc3RyaW5nID09ICJuT05FIiBvciBhbGdfc3RyaW5nID09ICJOT05FIiBvciBhbGdfc3RyaW5nID09ICJOb25FIiBvciBhbGdfc3RyaW5nID09ICJuT25FIjoKICAgICAgICAgICAgICAgICMgYmxvY2tzIG5vbmUgYXR0YWNrCgogICAgICAgICAgICAgICAgcHJpbnQgIldBUk5JTkc6IEpXVCBTaWduYXR1cmUgYWxnb3JpdGhtIGlzIG5vbmUiCiAgICAgICAgICAgICAgICB2YWxpZCA9IEZhbHNlCgogICAgICAgICAgICBlbGlmIGFsZ19zdHJpbmcgIT0gIlJTNTEyIjoKICAgICAgICAgICAgICAgICMgYmxvY2tzIGFueXRoaW5nIHRoYXQncyBub3QgUlM1MTIKCiAgICAgICAgICAgICAgICBwcmludCAiV0FSTklORzogSldUIFNpZ25hdHVyZSBhbGdvcml0aG0gaXMgTk9UIFJTNTEyIgogICAgICAgICAgICAgICAgdmFsaWQgPSBGYWxzZQoKICAgICAgICAgICAgZWxpZiBzaWduYXR1cmVfc3RyaW5nID09ICIiIDoKICAgICAgICAgICAgICAgICMgYmxvY2tzIGVtcHR5IHNpZ25hdHVyZSBzdHJpbmcKICAgICAgICAgICAgICAgIHByaW50ICJXQVJOSU5HOiBKV1QgU2lnbmF0dXJlIG5vdCBzZW50IgogICAgICAgICAgICAgICAgdmFsaWQgPSBGYWxzZQoKICAgICAgICAgICAgZWxzZToKCiAgICAgICAgICAgICAgICAjIGNsYXNzIGV4dGVuZHMgQWJzdHJhY3RDcnlwdG9Qcm92aWRlcgogICAgICAgICAgICAgICAgJycnIG9uIHZlcnNpb24gNC4yIC5nZXRBbGdvcml0aG0oKSBtZXRob2Qgd2FzIHJlbmFtZWQgdG8gLmdldFNpZ25hdHVyZUFsZ29yaXRobSgpCiAgICAgICAgICAgICAgICBmb3Igb2xkZXIgdmVyc2lvbnM6CiAgICAgICAgICAgICAgICB2YWxpZCA9IGNyeXB0b1Byb3ZpZGVyLnZlcmlmeVNpZ25hdHVyZShqd3QuZ2V0U2lnbmluZ0lucHV0KCksIGp3dC5nZXRFbmNvZGVkU2lnbmF0dXJlKCksIGp3dC5nZXRIZWFkZXIoKS5nZXRLZXlJZCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOb25lLCBOb25lLCBqd3QuZ2V0SGVhZGVyKCkuZ2V0QWxnb3JpdGhtKCkpCiAgICAgICAgICAgICAgICAnJycKCiAgICAgICAgICAgICAgICAjIHdvcmtpbmcgb24gNC4yOgogICAgICAgICAgICAgICAgdmFsaWQgPSBjcnlwdG9Qcm92aWRlci52ZXJpZnlTaWduYXR1cmUoand0LmdldFNpZ25pbmdJbnB1dCgpLCBqd3QuZ2V0RW5jb2RlZFNpZ25hdHVyZSgpLCBqd3QuZ2V0SGVhZGVyKCkuZ2V0S2V5SWQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTm9uZSwgTm9uZSwgand0LmdldEhlYWRlcigpLmdldFNpZ25hdHVyZUFsZ29yaXRobSgpKQoKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJFeGNlcHRpb246ICIsIHN5cy5leGNfaW5mbygpWzFdCgogICAgICAgIHByaW50ICJQYXNzcG9ydC4gdmFsaWRTaWduYXR1cmUuIFZhbGlkYXRpb24gcmVzdWx0IHdhcyAlcyIgJSB2YWxpZAoKICAgICAgICByZXR1cm4gdmFsaWQKCgogICAgZGVmIGp3dEhhc0V4cGlyZWQoc2VsZiwgand0KToKICAgICAgICAjIENoZWNrIGlmIGp3dCBoYXMgZXhwaXJlZAogICAgICAgIGp3dF9jbGFpbXMgPSBqd3QuZ2V0Q2xhaW1zKCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGV4cF9kYXRlID0gand0X2NsYWltcy5nZXRDbGFpbUFzRGF0ZShKd3RDbGFpbU5hbWUuRVhQSVJBVElPTl9USU1FKQogICAgICAgICAgICBoYXNFeHBpcmVkID0gZXhwX2RhdGUgPCBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIkV4Y2VwdGlvbjogVGhlIEpXVCBkb2VzIG5vdCBoYXZlICclcycgYXR0cmlidXRlIiAlIEp3dENsYWltTmFtZS5FWFBJUkFUSU9OX1RJTUUKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIHJldHVybiBoYXNFeHBpcmVkCgoKICAgIGRlZiBnZXRVc2VyUHJvZmlsZShzZWxmLCBqd3QpOgoKICAgICAgICAjIGdldENsYWltcyBtZXRob2QgbG9jYXRlZCBhdCBvcmcuZ2x1dS5veGF1dGgubW9kZWwudG9rZW4uSnNvbldlYlJlc3BvbnNlLmphdmEgYXMgYSBvcmcuZ2x1dS5veGF1dGgubW9kZWwuand0Lkp3dENsYWltcyBvYmplY3QKICAgICAgICBqd3RfY2xhaW1zID0gand0LmdldENsYWltcygpCgogICAgICAgIHVzZXJfcHJvZmlsZV9qc29uID0gTm9uZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgcHVibGljIFN0cmluZyBnZXRDbGFpbUFzU3RyaW5nKFN0cmluZyBrZXkpCiAgICAgICAgICAgIHVzZXJfcHJvZmlsZV9qc29uID0gQ2RpVXRpbC5iZWFuKEVuY3J5cHRpb25TZXJ2aWNlKS5kZWNyeXB0KGp3dF9jbGFpbXMuZ2V0Q2xhaW1Bc1N0cmluZygiZGF0YSIpKQoKICAgICAgICAgICAgdXNlcl9wcm9maWxlID0ganNvbi5sb2Fkcyh1c2VyX3Byb2ZpbGVfanNvbikKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gZ2V0VXNlclByb2ZpbGUuIFByb2JsZW0gb2J0YWluaW5nIHVzZXIgcHJvZmlsZSBqc29uIHJlcHJlc2VudGF0aW9uIgoKICAgICAgICByZXR1cm4gKHVzZXJfcHJvZmlsZSwgdXNlcl9wcm9maWxlX2pzb24pCgoKICAgIGRlZiBhdHRlbXB0QXV0aGVudGljYXRpb24oc2VsZiwgaWRlbnRpdHksIHVzZXJfcHJvZmlsZSwgdXNlcl9wcm9maWxlX2pzb24pOgoKICAgICAgICBwcmludCAiRW50ZXJlZCBhdHRlbXB0QXV0aGVudGljYXRpb24uLi4iCiAgICAgICAgdWlkS2V5ID0gInVpZCIKICAgICAgICBpZiBub3Qgc2VsZi5jaGVja1JlcXVpcmVkQXR0cmlidXRlcyh1c2VyX3Byb2ZpbGUsIFt1aWRLZXksIHNlbGYucHJvdmlkZXJLZXldKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIHByb3ZpZGVyID0gdXNlcl9wcm9maWxlW3NlbGYucHJvdmlkZXJLZXldCiAgICAgICAgcHJpbnQgInVzZXJfcHJvZmlsZVtzZWxmLnByb3ZpZGVyS2V5XSA9ICVzIiAlIHN0cih1c2VyX3Byb2ZpbGVbc2VsZi5wcm92aWRlcktleV0pCiAgICAgICAgaWYgbm90IHByb3ZpZGVyIGluIHNlbGYucmVnaXN0ZXJlZFByb3ZpZGVyczoKICAgICAgICAgICAgcHJpbnQgIkVudGVyZWQgaWYgbm90ZSBwcm92aWRlciBpbiBzZWxmLnJlZ2lzdGVyZWRQcm92aWVyczoiCiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXR0ZW1wdEF1dGhlbnRpY2F0aW9uLiBJZGVudGl0eSBQcm92aWRlciAlcyBub3QgcmVjb2duaXplZCIgJSBwcm92aWRlcgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgcHJpbnQgImF0dGVtcHRBdXRoZW50aWNhdGlvbi4gdXNlcl9wcm9maWxlID0gJXMiICUgdXNlcl9wcm9maWxlCiAgICAgICAgcHJpbnQgInVzZXJfcHJvZmlsZVt1aWRLZXldID0gJXMiICUgdXNlcl9wcm9maWxlW3VpZEtleV0KICAgICAgICB1aWQgPSB1c2VyX3Byb2ZpbGVbdWlkS2V5XVswXQogICAgICAgIHByaW50ICJhdHRlbXB0QXV0aGVudGljYXRpb24gLSB1aWQgPSAlcyIgJSB1aWQKICAgICAgICBleHRlcm5hbFVpZCA9ICJwYXNzcG9ydC0lczolczolcyIgJSAoInNhbWwiLCBwcm92aWRlciwgdWlkKQoKICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkKICAgICAgICB1c2VyQnlVaWQgPSBzZWxmLmdldFVzZXJCeUV4dGVybmFsVWlkKHVpZCwgcHJvdmlkZXIsIHVzZXJTZXJ2aWNlKQoKICAgICAgICBlbWFpbCA9IE5vbmUKICAgICAgICBpZiAibWFpbCIgaW4gdXNlcl9wcm9maWxlOgogICAgICAgICAgICBlbWFpbCA9IHVzZXJfcHJvZmlsZVsibWFpbCJdCiAgICAgICAgICAgIGlmIGxlbihlbWFpbCkgPT0gMDoKICAgICAgICAgICAgICAgIGVtYWlsID0gTm9uZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZW1haWwgPSBlbWFpbFswXQogICAgICAgICAgICAgICAgdXNlcl9wcm9maWxlWyJtYWlsIl0gPSBbIGVtYWlsIF0KCiAgICAgICAgaWYgZW1haWwgPT0gTm9uZSBhbmQgc2VsZi5yZWdpc3RlcmVkUHJvdmlkZXJzW3Byb3ZpZGVyXVsicmVxdWVzdEZvckVtYWlsIl06CiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXR0ZW1wdEF1dGhlbnRpY2F0aW9uLiBFbWFpbCB3YXMgbm90IHJlY2VpdmVkIgoKICAgICAgICAgICAgaWYgdXNlckJ5VWlkICE9IE5vbmU6CiAgICAgICAgICAgICAgICAjIFRoaXMgYXZvaWRzIGFza2luZyBmb3IgdGhlIGVtYWlsIG92ZXIgZXZlcnkgbG9naW4gYXR0ZW1wdAogICAgICAgICAgICAgICAgZW1haWwgPSB1c2VyQnlVaWQuZ2V0QXR0cmlidXRlKCJtYWlsIikKICAgICAgICAgICAgICAgIGlmIGVtYWlsICE9IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBhdHRlbXB0QXV0aGVudGljYXRpb24uIEZpbGxpbmcgbWlzc2luZyBlbWFpbCB2YWx1ZSB3aXRoICVzIiAlIGVtYWlsCiAgICAgICAgICAgICAgICAgICAgdXNlcl9wcm9maWxlWyJtYWlsIl0gPSBbIGVtYWlsIF0KCiAgICAgICAgICAgIGlmIGVtYWlsID09IE5vbmU6CiAgICAgICAgICAgICAgICAjIFN0b3JlIHVzZXIgcHJvZmlsZSBpbiBzZXNzaW9uIGFuZCBhYm9ydCB0aGlzIHJvdXRpbmUKICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInBhc3Nwb3J0X3VzZXJfcHJvZmlsZSIsIHVzZXJfcHJvZmlsZV9qc29uKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgdXNlckJ5TWFpbCA9IE5vbmUgaWYgZW1haWwgPT0gTm9uZSBlbHNlIHVzZXJTZXJ2aWNlLmdldFVzZXJCeUF0dHJpYnV0ZSgibWFpbCIsIGVtYWlsKQoKICAgICAgICAjIERldGVybWluZSBpZiB3ZSBzaG91bGQgYWRkIGVudHJ5LCB1cGRhdGUgZXhpc3RpbmcsIG9yIGRlbnkgYWNjZXNzCiAgICAgICAgZG9VcGRhdGUgPSBGYWxzZQogICAgICAgIGRvQWRkID0gRmFsc2UKICAgICAgICBpZiB1c2VyQnlVaWQgIT0gTm9uZToKICAgICAgICAgICAgcHJpbnQgIlVzZXIgd2l0aCBleHRlcm5hbFVpZCAnJXMnIGFscmVhZHkgZXhpc3RzIiAlIGV4dGVybmFsVWlkCiAgICAgICAgICAgIGlmIHVzZXJCeU1haWwgPT0gTm9uZToKICAgICAgICAgICAgICAgIGRvVXBkYXRlID0gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgaWYgdXNlckJ5TWFpbC5nZXRVc2VySWQoKSA9PSB1c2VyQnlVaWQuZ2V0VXNlcklkKCk6CiAgICAgICAgICAgICAgICAgICAgZG9VcGRhdGUgPSBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHByaW50ICJVc2VycyB3aXRoIGV4dGVybmFsVWlkICclcycgYW5kIG1haWwgJyVzJyBhcmUgZGlmZmVyZW50LiBBY2Nlc3Mgd2lsbCBiZSBkZW5pZWQuIEltcGVyc29uYXRpb24gYXR0ZW1wdD8iICUgKGV4dGVybmFsVWlkLCBlbWFpbCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNldE1lc3NhZ2VFcnJvcihGYWNlc01lc3NhZ2UuU0VWRVJJVFlfRVJST1IsICJFbWFpbCB2YWx1ZSBjb3JyZXNwb25kcyB0byBhbiBhbHJlYWR5IGV4aXN0aW5nIHByb3Zpc2lvbmVkIGFjY291bnQiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIHVzZXJCeU1haWwgPT0gTm9uZToKICAgICAgICAgICAgICAgIGRvQWRkID0gVHJ1ZQogICAgICAgICAgICBlbGlmIHNlbGYucmVnaXN0ZXJlZFByb3ZpZGVyc1twcm92aWRlcl1bImVtYWlsTGlua2luZ1NhZmUiXToKCiAgICAgICAgICAgICAgICB0bXBMaXN0ID0gdXNlckJ5TWFpbC5nZXRBdHRyaWJ1dGVWYWx1ZXMoIm94RXh0ZXJuYWxVaWQiKQogICAgICAgICAgICAgICAgdG1wTGlzdCA9IEFycmF5TGlzdCgpIGlmIHRtcExpc3QgPT0gTm9uZSBlbHNlIEFycmF5TGlzdCh0bXBMaXN0KQogICAgICAgICAgICAgICAgdG1wTGlzdC5hZGQoZXh0ZXJuYWxVaWQpCiAgICAgICAgICAgICAgICB1c2VyQnlNYWlsLnNldEF0dHJpYnV0ZSgib3hFeHRlcm5hbFVpZCIsIHRtcExpc3QpCgogICAgICAgICAgICAgICAgdXNlckJ5VWlkID0gdXNlckJ5TWFpbAogICAgICAgICAgICAgICAgcHJpbnQgIkV4dGVybmFsIHVzZXIgc3VwcGx5aW5nIG1haWwgJXMgd2lsbCBiZSBsaW5rZWQgdG8gZXhpc3RpbmcgYWNjb3VudCAnJXMnIiAlIChlbWFpbCwgdXNlckJ5TWFpbC5nZXRVc2VySWQoKSkKICAgICAgICAgICAgICAgIGRvVXBkYXRlID0gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQgIkFuIGF0dGVtcHQgdG8gc3VwcGx5IGFuIGVtYWlsIG9mIGFuIGV4aXN0aW5nIHVzZXIgd2FzIG1hZGUuIFR1cm4gb24gJ2VtYWlsTGlua2luZ1NhZmUnIGlmIHlvdSB3YW50IHRvIGVuYWJsZSBsaW5raW5nIgogICAgICAgICAgICAgICAgc2VsZi5zZXRNZXNzYWdlRXJyb3IoRmFjZXNNZXNzYWdlLlNFVkVSSVRZX0VSUk9SLCAiRW1haWwgdmFsdWUgY29ycmVzcG9uZHMgdG8gYW4gYWxyZWFkeSBleGlzdGluZyBhY2NvdW50LiBJZiB5b3UgYWxyZWFkeSBoYXZlIGEgdXNlcm5hbWUgYW5kIHBhc3N3b3JkIHVzZSB0aG9zZSBpbnN0ZWFkIG9mIGFuIGV4dGVybmFsIGF1dGhlbnRpY2F0aW9uIHNpdGUgdG8gZ2V0IGFjY2Vzcy4iKQoKICAgICAgICB1c2VybmFtZSA9IE5vbmUKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGRvVXBkYXRlOgogICAgICAgICAgICAgICAgdXNlcm5hbWUgPSB1c2VyQnlVaWQuZ2V0VXNlcklkKCkKICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXR0ZW1wdEF1dGhlbnRpY2F0aW9uLiBVcGRhdGluZyB1c2VyICVzIiAlIHVzZXJuYW1lCiAgICAgICAgICAgICAgICBzZWxmLnVwZGF0ZVVzZXIodXNlckJ5VWlkLCB1c2VyX3Byb2ZpbGUsIHVzZXJTZXJ2aWNlKQogICAgICAgICAgICBlbGlmIGRvQWRkOgogICAgICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBhdHRlbXB0QXV0aGVudGljYXRpb24uIENyZWF0aW5nIHVzZXIgJXMiICUgZXh0ZXJuYWxVaWQKICAgICAgICAgICAgICAgIG5ld1VzZXIgPSBzZWxmLmFkZFVzZXIoZXh0ZXJuYWxVaWQsIHVzZXJfcHJvZmlsZSwgdXNlclNlcnZpY2UpCiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IG5ld1VzZXIuZ2V0VXNlcklkKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJFeGNlcHRpb246ICIsIHN5cy5leGNfaW5mbygpWzFdCiAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gYXR0ZW1wdEF1dGhlbnRpY2F0aW9uLiBBdXRoZW50aWNhdGlvbiBmYWlsZWQiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBpZiB1c2VybmFtZSA9PSBOb25lOgogICAgICAgICAgICBwcmludCAiUGFzc3BvcnQuIGF0dGVtcHRBdXRoZW50aWNhdGlvbi4gQXV0aGVudGljYXRpb24gYXR0ZW1wdCB3YXMgcmVqZWN0ZWQiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlZF9pbiA9IENkaVV0aWwuYmVhbihBdXRoZW50aWNhdGlvblNlcnZpY2UpLmF1dGhlbnRpY2F0ZSh1c2VybmFtZSkKICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBhdHRlbXB0QXV0aGVudGljYXRpb24uIEF1dGhlbnRpY2F0aW9uIGZvciAlcyByZXR1cm5lZCAlcyIgJSAodXNlcm5hbWUsIGxvZ2dlZF9pbikKICAgICAgICAgICAgcmV0dXJuIGxvZ2dlZF9pbgoKCiAgICBkZWYgZ2V0VXNlckJ5RXh0ZXJuYWxVaWQoc2VsZiwgdWlkLCBwcm92aWRlciwgdXNlclNlcnZpY2UpOgogICAgICAgIG5ld0Zvcm1hdCA9ICJwYXNzcG9ydC0lczolczolcyIgJSAoInNhbWwiLCBwcm92aWRlciwgdWlkKQogICAgICAgIHVzZXIgPSB1c2VyU2VydmljZS5nZXRVc2VyQnlBdHRyaWJ1dGUoIm94RXh0ZXJuYWxVaWQiLCBuZXdGb3JtYXQpCgogICAgICAgIGlmIHVzZXIgPT0gTm9uZToKICAgICAgICAgICAgb2xkRm9ybWF0ID0gInBhc3Nwb3J0LSVzOiVzIiAlICgic2FtbCIsIHVpZCkKICAgICAgICAgICAgdXNlciA9IHVzZXJTZXJ2aWNlLmdldFVzZXJCeUF0dHJpYnV0ZSgib3hFeHRlcm5hbFVpZCIsIG9sZEZvcm1hdCkKCiAgICAgICAgICAgIGlmIHVzZXIgIT0gTm9uZToKICAgICAgICAgICAgICAgICMgTWlncmF0ZSB0byBuZXdlciBmb3JtYXQKICAgICAgICAgICAgICAgIGxpc3QgPSBIYXNoU2V0KHVzZXIuZ2V0QXR0cmlidXRlVmFsdWVzKCJveEV4dGVybmFsVWlkIikpCiAgICAgICAgICAgICAgICBsaXN0LnJlbW92ZShvbGRGb3JtYXQpCiAgICAgICAgICAgICAgICBsaXN0LmFkZChuZXdGb3JtYXQpCiAgICAgICAgICAgICAgICB1c2VyLnNldEF0dHJpYnV0ZSgib3hFeHRlcm5hbFVpZCIsIEFycmF5TGlzdChsaXN0KSkKICAgICAgICAgICAgICAgIHByaW50ICJNaWdyYXRpbmcgdXNlcidzIG94RXh0ZXJuYWxVaWQgdG8gbmV3ZXIgZm9ybWF0ICdwYXNzcG9ydC1zYW1sOnByb3ZpZGVyOnVpZCciCiAgICAgICAgICAgICAgICB1c2VyU2VydmljZS51cGRhdGVVc2VyKHVzZXIpCgogICAgICAgIHJldHVybiB1c2VyCgoKICAgIGRlZiBzZXRNZXNzYWdlRXJyb3Ioc2VsZiwgc2V2ZXJpdHksIG1zZyk6CiAgICAgICAgZmFjZXNNZXNzYWdlcyA9IENkaVV0aWwuYmVhbihGYWNlc01lc3NhZ2VzKQogICAgICAgIGZhY2VzTWVzc2FnZXMuc2V0S2VlcE1lc3NhZ2VzKCkKICAgICAgICBmYWNlc01lc3NhZ2VzLmNsZWFyKCkKICAgICAgICBmYWNlc01lc3NhZ2VzLmFkZChzZXZlcml0eSwgbXNnKQoKCiAgICBkZWYgY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZXMoc2VsZiwgcHJvZmlsZSwgYXR0cnMpOgoKICAgICAgICBmb3IgYXR0ciBpbiBhdHRyczoKICAgICAgICAgICAgaWYgKG5vdCBhdHRyIGluIHByb2ZpbGUpIG9yIGxlbihwcm9maWxlW2F0dHJdKSA9PSAwOgogICAgICAgICAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBjaGVja1JlcXVpcmVkQXR0cmlidXRlcy4gQXR0cmlidXRlICclcycgaXMgbWlzc2luZyBpbiBwcm9maWxlIiAlIGF0dHIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHJldHVybiBUcnVlCgoKICAgIGRlZiBhZGRVc2VyKHNlbGYsIGV4dGVybmFsVWlkLCBwcm9maWxlLCB1c2VyU2VydmljZSk6CiAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBFbnRlcmVkIGFkZFVzZXIoKS4iCiAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBhZGRVc2VyLiBleHRlcm5hbFVpZCA9ICVzIiAlIGV4dGVybmFsVWlkCiAgICAgICAgcHJpbnQgIlBhc3Nwb3J0LiBhZGRVc2VyLiBwcm9maWxlID0gJXMiICUgcHJvZmlsZQogICAgICAgIG5ld1VzZXIgPSBVc2VyKCkKICAgICAgICAjRmlsbCB1c2VyIGF0dHJzCiAgICAgICAgbmV3VXNlci5zZXRBdHRyaWJ1dGUoIm94RXh0ZXJuYWxVaWQiLCBleHRlcm5hbFVpZCkKICAgICAgICBzZWxmLmZpbGxVc2VyKG5ld1VzZXIsIHByb2ZpbGUpCiAgICAgICAgbmV3VXNlciA9IHVzZXJTZXJ2aWNlLmFkZFVzZXIobmV3VXNlciwgVHJ1ZSkKICAgICAgICByZXR1cm4gbmV3VXNlcgoKCiAgICBkZWYgdXBkYXRlVXNlcihzZWxmLCBmb3VuZFVzZXIsIHByb2ZpbGUsIHVzZXJTZXJ2aWNlKToKICAgICAgICAjIHdoZW4gdGhpcyBpcyBmYWxzZSwgdGhlcmUgbWlnaHQgc3RpbGwgc29tZSB1cGRhdGVzIHRha2luZyBwbGFjZSAoZS5nLiBub3QgcmVsYXRlZCB0byBwcm9maWxlIGF0dHJzIHJlbGVhc2VkIGJ5IGV4dGVybmFsIHByb3ZpZGVyKQogICAgICAgIGlmIChub3Qgc2VsZi5za2lwUHJvZmlsZVVwZGF0ZSk6CiAgICAgICAgICAgIHNlbGYuZmlsbFVzZXIoZm91bmRVc2VyLCBwcm9maWxlKQogICAgICAgIHVzZXJTZXJ2aWNlLnVwZGF0ZVVzZXIoZm91bmRVc2VyKQoKCiAgICBkZWYgZmlsbFVzZXIoc2VsZiwgZm91bmRVc2VyLCBwcm9maWxlKToKICAgICAgICBwcmludAogICAgICAgIHByaW50ICJQYXNzcG9ydC4gRW50ZXJlZCBmaWxsVXNlcigpLiIKICAgICAgICBwcmludCAiUGFzc3BvcnQuIGZpbGxVc2VyLiBmb3VuZFVzZXIgPSAlcyIgJSBmb3VuZFVzZXIKICAgICAgICBwcmludCAiUGFzc3BvcnQuIGZpbGxVc2VyLiBwcm9maWxlID0gJXMiICUgcHJvZmlsZQogICAgICAgIGZvciBhdHRyIGluIHByb2ZpbGU6CiAgICAgICAgICAgICMgInByb3ZpZGVyIiBpcyBkaXNyZWdhcmRlZCBpZiBwYXJ0IG9mIG1hcHBpbmcKICAgICAgICAgICAgaWYgYXR0ciAhPSBzZWxmLnByb3ZpZGVyS2V5OgogICAgICAgICAgICAgICAgdmFsdWVzID0gcHJvZmlsZVthdHRyXQogICAgICAgICAgICAgICAgcHJpbnQgIiVzID0gJXMiICUgKGF0dHIsIHZhbHVlcykKICAgICAgICAgICAgICAgIGZvdW5kVXNlci5zZXRBdHRyaWJ1dGUoYXR0ciwgdmFsdWVzKQoKICAgICAgICAgICAgICAgIGlmIGF0dHIgPT0gIm1haWwiOgogICAgICAgICAgICAgICAgICAgIHByaW50ICJQYXNzcG9ydC4gZmlsbFVzZXIuIGVudGVyZWQgaWYgYXR0ciA9PSBtYWlsIgogICAgICAgICAgICAgICAgICAgIG94dHJ1c3RNYWlscyA9IFtdCiAgICAgICAgICAgICAgICAgICAgZm9yIG1haWwgaW4gdmFsdWVzOgogICAgICAgICAgICAgICAgICAgICAgICBveHRydXN0TWFpbHMuYXBwZW5kKCd7InZhbHVlIjoiJXMiLCJwcmltYXJ5IjpmYWxzZX0nICUgbWFpbCkKICAgICAgICAgICAgICAgICAgICBmb3VuZFVzZXIuc2V0QXR0cmlidXRlKCJveFRydXN0RW1haWwiLCBveHRydXN0TWFpbHMpCgojIElEUC1pbml0aWF0ZWQgZmxvdyByb3V0aW5lcwoKICAgIGRlZiBpc0luYm91bmRGbG93KHNlbGYsIGlkZW50aXR5KToKICAgICAgICBwcmludCAicGFzc3BvcnQuIGVudGVyZWQgaXNJbmJvdW5kRmxvdyIKCiAgICAgICAgc2Vzc2lvbklkID0gaWRlbnRpdHkuZ2V0U2Vzc2lvbklkKCkKICAgICAgICBwcmludCAicGFzc3BvcnQuIGlzSW5ib3VuZEZsb3cuIHNlc3Npb25JZCA9ICVzIiAlIHNlc3Npb25JZAogICAgICAgIGlmIHNlc3Npb25JZCA9PSBOb25lOgogICAgICAgICAgICBwcmludCAicGFzc3BvcnQuIGlzSW5ib3VuZEZsb3cuIHNlc3Npb25JZCBub3QgZm91bmQgeWV0Li4uIgogICAgICAgICAgICAjIERldGVjdCBtb2RlIGlmIHRoZXJlIGlzIG5vIHNlc3Npb24geWV0LiBJdCdzIG5lZWRlZCBmb3IgZ2V0UGFnZUZvclN0ZXAgbWV0aG9kCiAgICAgICAgICAgIGZhY2VzQ29udGV4dCA9IENkaVV0aWwuYmVhbihGYWNlc0NvbnRleHQpCiAgICAgICAgICAgIHJlcXVlc3RQYXJhbWV0ZXJzID0gZmFjZXNDb250ZXh0LmdldEV4dGVybmFsQ29udGV4dCgpLmdldFJlcXVlc3RQYXJhbWV0ZXJNYXAoKQogICAgICAgICAgICBwcmludCAicGFzc3BvcnQuIGlzSW5ib3VuZEZsb3cuIHJlcXVlc3RQYXJhbWV0ZXJzID0gJXMiICUgcmVxdWVzdFBhcmFtZXRlcnMKCiAgICAgICAgICAgIGF1dGh6X3N0YXRlID0gcmVxdWVzdFBhcmFtZXRlcnMuZ2V0KEF1dGhvcml6ZVJlcXVlc3RQYXJhbS5TVEFURSkKICAgICAgICAgICAgcHJpbnQgInBhc3Nwb3J0LiBpc0luYm91bmRGbG93LiBhdXRoel9zdGF0ZSA9ICVzIiAlIGF1dGh6X3N0YXRlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYXV0aHpfc3RhdGUgPSBpZGVudGl0eS5nZXRTZXNzaW9uSWQoKS5nZXRTZXNzaW9uQXR0cmlidXRlcygpLmdldChBdXRob3JpemVSZXF1ZXN0UGFyYW0uU1RBVEUpCgogICAgICAgIHByaW50ICJwYXNzcG9ydC4gSXNJbmJvdW5kRmxvdy4gYXV0aHpfc3RhdGUgPSAlcyIgJSBhdXRoel9zdGF0ZQoKICAgICAgICAjIHRoZSByZXBsYWNlIGFib3ZlIGlzIHdvcmthcm91bmQgZHVlIGEgcHJvYmxlbSByZXBvcnRlZAogICAgICAgICMgb24gaXNzdWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9HbHV1RmVkZXJhdGlvbi9nbHV1LXBhc3Nwb3J0L2lzc3Vlcy85NQogICAgICAgICMgVE9ETzogUmVtb3ZlIGFmdGVyIGZpeGVkIG9uIEpTRiBzaWRlCgogICAgICAgIGI2NHVybF9kZWNvZGVkX2F1dGhfc3RhdGUgPSBiYXNlNjQudXJsc2FmZV9iNjRkZWNvZGUoc3RyKGF1dGh6X3N0YXRlKyc9PScpKQoKICAgICAgICAjIHByaW50ICJwYXNzcG9ydC4gSXNJbmJvdW5kRmxvdy4gYjY0dXJsX2RlY29kZWRfYXV0aF9zdGF0ZSA9ICVzIiAlIHN0cihiNjR1cmxfZGVjb2RlZF9hdXRoX3N0YXRlKQogICAgICAgIHByaW50ICJwYXNzcG9ydC4gSXNJbmJvdW5kRmxvdy4gc2VsZi5pc0luYm91bmRKd3QoKSA9ICVzIiAlIHN0cihzZWxmLmlzSW5ib3VuZEp3dChiNjR1cmxfZGVjb2RlZF9hdXRoX3N0YXRlKSkKICAgICAgICBpZiBzZWxmLmlzSW5ib3VuZEp3dChiNjR1cmxfZGVjb2RlZF9hdXRoX3N0YXRlKToKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgcmV0dXJuIEZhbHNlCgoKICAgIGRlZiBpc0luYm91bmRKd3Qoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIHZhbHVlID09IE5vbmU6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICB0cnk6CgogICAgICAgICAgICBwcmludCgicGFzc3BvcnQuaXNJbmJvdW5kSnd0LiB2YWx1ZSA9ICVzIiAlIHZhbHVlKQogICAgICAgICAgICAjIHZhbHVlID0gdmFsdWUucmVwbGFjZSgiXyIsICIuIikKICAgICAgICAgICAgIyBwcmludCgicGFzc3BvcnQuaXNJbmJvdW5kSnd0LiB2YWx1ZSA9ICVzIiAlIHZhbHVlKQoKICAgICAgICAgICAgand0ID0gSnd0LnBhcnNlKHZhbHVlKQogICAgICAgICAgICBwcmludCAicGFzc3BvcnQuaXNJbmJvdW5kSnd0LiBqd3QgPSAlcyIgJSBqd3QKCiAgICAgICAgICAgICMgdXNlcl9wcm9maWxlX2pzb24gPSBqd3QuZ2V0Q2xhaW1zKCkuZ2V0Q2xhaW1Bc1N0cmluZygiZGF0YSIpCgogICAgICAgICAgICB1c2VyX3Byb2ZpbGVfanNvbiA9IENkaVV0aWwuYmVhbihFbmNyeXB0aW9uU2VydmljZSkuZGVjcnlwdChqd3QuZ2V0Q2xhaW1zKCkuZ2V0Q2xhaW1Bc1N0cmluZygiZGF0YSIpKQogICAgICAgICAgICBwcmludCAicGFzc3BvcnQuaXNJbmJvdW5kSnd0LiB1c2VyX3Byb2ZpbGVfanNvbiA9ICVzIiAlIHVzZXJfcHJvZmlsZV9qc29uCiAgICAgICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KHVzZXJfcHJvZmlsZV9qc29uKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGV4Y2VwdCBJbnZhbGlkSnd0RXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwcmludCgiVW5leHBlY3RlZCBlcnJvcjoiLCBzeXMuZXhjX2luZm8oKVswXSkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGdldExvZ291dEV4dGVybmFsVXJsKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcHJpbnQgIkdldCBleHRlcm5hbCBsb2dvdXQgVVJMIGNhbGwiCiAgICAgICAgcmV0dXJuIE5vbmUK
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=DAA9-B788,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample Client Registration script
displayName: client_registration
oxEnabled: false
inum: DAA9-B788
oxLevel: 100
oxConfigurationProperty: {"value1":"client_redirect_uris","value2":"https://client.example.com/example1, https://client.example.com/example2","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuY2xpZW50IGltcG9ydCBDbGllbnRSZWdpc3RyYXRpb25UeXBlCmZyb20gb3JnLmdsdXUuc2VydmljZS5jZGkudXRpbCBpbXBvcnQgQ2RpVXRpbApmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlIGltcG9ydCBTY29wZVNlcnZpY2UKZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIsIEFycmF5SGVscGVyCmZyb20gamF2YS51dGlsIGltcG9ydCBBcnJheXMsIEFycmF5TGlzdCwgSGFzaFNldAoKaW1wb3J0IGphdmEKCmNsYXNzIENsaWVudFJlZ2lzdHJhdGlvbihDbGllbnRSZWdpc3RyYXRpb25UeXBlKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6CiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkNsaWVudCByZWdpc3RyYXRpb24uIEluaXRpYWxpemF0aW9uIgogICAgICAgIAogICAgICAgIHNlbGYuY2xpZW50UmVkaXJlY3RVcmlzU2V0ID0gc2VsZi5wcmVwYXJlQ2xpZW50UmVkaXJlY3RVcmlzKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKQoKICAgICAgICBwcmludCAiQ2xpZW50IHJlZ2lzdHJhdGlvbi4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIHJldHVybiBUcnVlICAgCgogICAgZGVmIGRlc3Ryb3koc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJDbGllbnQgcmVnaXN0cmF0aW9uLiBEZXN0cm95IgogICAgICAgIHByaW50ICJDbGllbnQgcmVnaXN0cmF0aW9uLiBEZXN0cm95ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIHJldHVybiBUcnVlICAgCgogICAgIyBVcGRhdGUgY2xpZW50IGVudHJ5IGJlZm9yZSBwZXJzaXN0ZW50IGl0CiAgICAjICAgcmVnaXN0ZXJSZXF1ZXN0IGlzIG9yZy5nbHV1Lm94YXV0aC5jbGllbnQuUmVnaXN0ZXJSZXF1ZXN0CiAgICAjICAgY2xpZW50IGlzIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5yZWdpc3RyYXRpb24uQ2xpZW50CiAgICAjICAgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMgaXMgamF2YS51dGlsLk1hcDxTdHJpbmcsIFNpbXBsZUN1c3RvbVByb3BlcnR5PgogICAgZGVmIGNyZWF0ZUNsaWVudChzZWxmLCByZWdpc3RlclJlcXVlc3QsIGNsaWVudCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJDbGllbnQgcmVnaXN0cmF0aW9uLiBDcmVhdGVDbGllbnQgbWV0aG9kIgoKICAgICAgICByZWRpcmVjdFVyaXMgPSBjbGllbnQuZ2V0UmVkaXJlY3RVcmlzKCkKICAgICAgICBwcmludCAiQ2xpZW50IHJlZ2lzdHJhdGlvbi4gUmVkaXJlY3QgVXJpczogJXMiICUgcmVkaXJlY3RVcmlzCgogICAgICAgIGFkZEFkZHJlc3NTY29wZSA9IEZhbHNlCiAgICAgICAgZm9yIHJlZGlyZWN0VXJpIGluIHJlZGlyZWN0VXJpczoKICAgICAgICAgICAgaWYgKHNlbGYuY2xpZW50UmVkaXJlY3RVcmlzU2V0LmNvbnRhaW5zKHJlZGlyZWN0VXJpKSk6CiAgICAgICAgICAgICAgICBhZGRBZGRyZXNzU2NvcGUgPSBUcnVlCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIAogICAgICAgIHByaW50ICJDbGllbnQgcmVnaXN0cmF0aW9uLiBJcyBhZGQgYWRkcmVzcyBzY29wZTogJXMiICUgYWRkQWRkcmVzc1Njb3BlCgogICAgICAgIGlmIGFkZEFkZHJlc3NTY29wZToKICAgICAgICAgICAgY3VycmVudFNjb3BlcyA9IGNsaWVudC5nZXRTY29wZXMoKQogICAgICAgICAgICBwcmludCAiQ2xpZW50IHJlZ2lzdHJhdGlvbi4gQ3VycmVudCBzY29wZXM6ICVzIiAlIGN1cnJlbnRTY29wZXMKICAgICAgICAgICAgCiAgICAgICAgICAgIHNjb3BlU2VydmljZSA9IENkaVV0aWwuYmVhbihTY29wZVNlcnZpY2UpCiAgICAgICAgICAgIGFkZHJlc3NTY29wZSA9IHNjb3BlU2VydmljZS5nZXRTY29wZUJ5RGlzcGxheU5hbWUoImFkZHJlc3MiKQogICAgICAgICAgICBuZXdTY29wZXMgPSBBcnJheUhlbHBlci5hZGRJdGVtVG9TdHJpbmdBcnJheShjdXJyZW50U2NvcGVzLCBhZGRyZXNzU2NvcGUuZ2V0RG4oKSkKICAgIAogICAgICAgICAgICBwcmludCAiQ2xpZW50IHJlZ2lzdHJhdGlvbi4gUmVzdWx0IHNjb3BlczogJXMiICUgbmV3U2NvcGVzCiAgICAgICAgICAgIGNsaWVudC5zZXRTY29wZXMobmV3U2NvcGVzKQoKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICMgVXBkYXRlIGNsaWVudCBlbnRyeSBiZWZvcmUgcGVyc2lzdGVudCBpdAogICAgIyAgIHJlZ2lzdGVyUmVxdWVzdCBpcyBvcmcuZ2x1dS5veGF1dGguY2xpZW50LlJlZ2lzdGVyUmVxdWVzdAogICAgIyAgIGNsaWVudCBpcyBvcmcuZ2x1dS5veGF1dGgubW9kZWwucmVnaXN0cmF0aW9uLkNsaWVudAogICAgIyAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eT4KICAgIGRlZiB1cGRhdGVDbGllbnQoc2VsZiwgcmVnaXN0ZXJSZXF1ZXN0LCBjbGllbnQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiQ2xpZW50IHJlZ2lzdHJhdGlvbi4gVXBkYXRlQ2xpZW50IG1ldGhvZCIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQoKICAgIGRlZiBwcmVwYXJlQ2xpZW50UmVkaXJlY3RVcmlzKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBjbGllbnRSZWRpcmVjdFVyaXNTZXQgPSBIYXNoU2V0KCkKICAgICAgICBpZiBub3QgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImNsaWVudF9yZWRpcmVjdF91cmlzIik6CiAgICAgICAgICAgIHJldHVybiBjbGllbnRSZWRpcmVjdFVyaXNTZXQKCiAgICAgICAgY2xpZW50UmVkaXJlY3RVcmlzTGlzdCA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiY2xpZW50X3JlZGlyZWN0X3VyaXMiKS5nZXRWYWx1ZTIoKQogICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KGNsaWVudFJlZGlyZWN0VXJpc0xpc3QpOgogICAgICAgICAgICBwcmludCAiQ2xpZW50IHJlZ2lzdHJhdGlvbi4gVGhlIHByb3BlcnR5IGNsaWVudF9yZWRpcmVjdF91cmlzIGlzIGVtcHR5IgogICAgICAgICAgICByZXR1cm4gY2xpZW50UmVkaXJlY3RVcmlzU2V0ICAgIAoKICAgICAgICBjbGllbnRSZWRpcmVjdFVyaXNBcnJheSA9IFN0cmluZ0hlbHBlci5zcGxpdChjbGllbnRSZWRpcmVjdFVyaXNMaXN0LCAiLCIpCiAgICAgICAgaWYgQXJyYXlIZWxwZXIuaXNFbXB0eShjbGllbnRSZWRpcmVjdFVyaXNBcnJheSk6CiAgICAgICAgICAgIHByaW50ICJDbGllbnQgcmVnaXN0cmF0aW9uLiBObyBjbGllbnRzIHNwZWNpZmllZCBpbiBjbGllbnRfcmVkaXJlY3RfdXJpcyBwcm9wZXJ0eSIKICAgICAgICAgICAgcmV0dXJuIGNsaWVudFJlZGlyZWN0VXJpc1NldAogICAgICAgIAogICAgICAgICMgQ29udmVydCB0byBIYXNoU2V0IHRvIHF1aWNrIHNlYXJjaAogICAgICAgIGkgPSAwCiAgICAgICAgY291bnQgPSBsZW4oY2xpZW50UmVkaXJlY3RVcmlzQXJyYXkpCiAgICAgICAgd2hpbGUgaSA8IGNvdW50OgogICAgICAgICAgICB1cmlzID0gY2xpZW50UmVkaXJlY3RVcmlzQXJyYXlbaV0KICAgICAgICAgICAgY2xpZW50UmVkaXJlY3RVcmlzU2V0LmFkZCh1cmlzKQogICAgICAgICAgICBpID0gaSArIDEKCiAgICAgICAgcmV0dXJuIGNsaWVudFJlZGlyZWN0VXJpc1NldAo=
oxScriptType: client_registration
programmingLanguage: python

dn: inum=09A0-93D6,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Twilio SMS authentication module
displayName: twilio_sms
oxEnabled: false
inum: 09A0-93D6
oxConfigurationProperty: {"value1":"twilio_sid","value2":"","description":"Twilio account SID"}
oxConfigurationProperty: {"value1":"twilio_token","value2":"","description":"Twilio API token"}
oxConfigurationProperty: {"value1":"from_number","value2":"","description":"Twilio phone number with SMS capabilities"}
oxLevel: 50
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuDQojIENvcHlyaWdodCAoYykgMjAxOCwgR2x1dQ0KIw0KIyBBdXRob3I6IEpvc2UgR29uemFsZXoNCiMgQXV0aG9yOiBHYXNteXIgTW91Z2FuZw0KDQpmcm9tIG9yZy5nbHV1LnNlcnZpY2UuY2RpLnV0aWwgaW1wb3J0IENkaVV0aWwNCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlY3VyaXR5IGltcG9ydCBJZGVudGl0eQ0KZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuYXV0aCBpbXBvcnQgUGVyc29uQXV0aGVudGljYXRpb25UeXBlDQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlIGltcG9ydCBBdXRoZW50aWNhdGlvblNlcnZpY2UNCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuY29tbW9uIGltcG9ydCBVc2VyU2VydmljZQ0KZnJvbSBvcmcuZ2x1dS5veGF1dGgudXRpbCBpbXBvcnQgU2VydmVyVXRpbA0KZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIsIEFycmF5SGVscGVyDQpmcm9tIGphdmEudXRpbCBpbXBvcnQgQXJyYXlzDQpmcm9tIGphdmF4LmZhY2VzLmFwcGxpY2F0aW9uIGltcG9ydCBGYWNlc01lc3NhZ2UNCmZyb20gb3JnLmdsdXUuanNmMi5tZXNzYWdlIGltcG9ydCBGYWNlc01lc3NhZ2VzDQoNCmltcG9ydCBjb20udHdpbGlvLlR3aWxpbyBhcyBUd2lsaW8NCmltcG9ydCBjb20udHdpbGlvLnJlc3QuYXBpLnYyMDEwLmFjY291bnQuTWVzc2FnZSBhcyBNZXNzYWdlDQppbXBvcnQgY29tLnR3aWxpby50eXBlLlBob25lTnVtYmVyIGFzIFBob25lTnVtYmVyDQppbXBvcnQgb3JnLmNvZGVoYXVzLmpldHRpc29uLmpzb24uSlNPTkFycmF5IGFzIEpTT05BcnJheQ0KDQoNCmltcG9ydCBqYXZhDQppbXBvcnQgcmFuZG9tDQppbXBvcnQgamFycmF5DQoNCmNsYXNzIFBlcnNvbkF1dGhlbnRpY2F0aW9uKFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZSk6DQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGN1cnJlbnRUaW1lTWlsbGlzKToNCiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzDQogICAgICAgIHNlbGYubW9iaWxlX251bWJlciA9IE5vbmUNCiAgICAgICAgc2VsZi5pZGVudGl0eSA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkNCg0KICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICBwcmludCAiVHdpbGlvIFNNUy4gSW5pdGlhbGl6YXRpb24iDQogICAgICAgIHNlbGYuQUNDT1VOVF9TSUQgPSBOb25lDQogICAgICAgIHNlbGYuQVVUSF9UT0tFTiA9IE5vbmUNCiAgICAgICAgc2VsZi5GUk9NX05VTUJFUiA9IE5vbmUNCg0KICAgICAgICAjIEdldCBDdXN0b20gUHJvcGVydGllcw0KICAgICAgICB0cnk6DQogICAgICAgICAgICBzZWxmLkFDQ09VTlRfU0lEID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJ0d2lsaW9fc2lkIikuZ2V0VmFsdWUyKCkNCiAgICAgICAgZXhjZXB0Og0KICAgICAgICAgICAgcHJpbnQgJ1R3aWxpb1NNUywgTWlzc2luZyByZXF1aXJlZCBjb25maWd1cmF0aW9uIGF0dHJpYnV0ZSAidHdpbGlvX3NpZCInDQoNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgc2VsZi5BVVRIX1RPS0VOID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJ0d2lsaW9fdG9rZW4iKS5nZXRWYWx1ZTIoKQ0KICAgICAgICBleGNlcHQ6DQogICAgICAgICAgICBwcmludCdUd2lsaW9TTVMsIE1pc3NpbmcgcmVxdWlyZWQgY29uZmlndXJhdGlvbiBhdHRyaWJ1dGUgInR3aWxpb190b2tlbiInDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHNlbGYuRlJPTV9OVU1CRVIgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoImZyb21fbnVtYmVyIikuZ2V0VmFsdWUyKCkNCiAgICAgICAgZXhjZXB0Og0KICAgICAgICAgICAgcHJpbnQnVHdpbGlvU01TLCBNaXNzaW5nIHJlcXVpcmVkIGNvbmZpZ3VyYXRpb24gYXR0cmlidXRlICJmcm9tX251bWJlciInDQoNCiAgICAgICAgaWYgTm9uZSBpbiAoc2VsZi5BQ0NPVU5UX1NJRCwgc2VsZi5BVVRIX1RPS0VOLCBzZWxmLkZST01fTlVNQkVSKToNCiAgICAgICAgICAgIHByaW50ICJ0d2lsaW9fc2lkLCB0d2lsaW9fdG9rZW4sIGZyb21fbnVtYmVyIGlzIGVtcHR5IC4uLiByZXR1cm5pbmcgRmFsc2UiDQogICAgICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgICAgICBwcmludCAiVHdpbGlvIFNNUy4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5Ig0KDQogICAgICAgIHJldHVybiBUcnVlDQoNCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6DQogICAgICAgIHByaW50ICJUd2lsaW8gU01TLiBEZXN0cm95Ig0KICAgICAgICBwcmludCAiVHdpbGlvIFNNUy4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSINCiAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOg0KICAgICAgICByZXR1cm4gMTENCiAgICAgICAgDQogICAgZGVmIGdldEF1dGhlbnRpY2F0aW9uTWV0aG9kQ2xhaW1zKHNlbGYsIHJlcXVlc3RQYXJhbWV0ZXJzKToNCiAgICAgICAgcmV0dXJuIE5vbmUNCiAgICAgICAgDQogICAgZGVmIGlzVmFsaWRBdXRoZW50aWNhdGlvbk1ldGhvZChzZWxmLCB1c2FnZVR5cGUsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToNCiAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgIGRlZiBnZXRBbHRlcm5hdGl2ZUF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgZGVmIGF1dGhlbnRpY2F0ZShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOg0KICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkNCiAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkNCg0KICAgICAgICBmYWNlc01lc3NhZ2VzID0gQ2RpVXRpbC5iZWFuKEZhY2VzTWVzc2FnZXMpDQogICAgICAgIGZhY2VzTWVzc2FnZXMuc2V0S2VlcE1lc3NhZ2VzKCkNCg0KICAgICAgICBzZXNzaW9uX2F0dHJpYnV0ZXMgPSBzZWxmLmlkZW50aXR5LmdldFNlc3Npb25JZCgpLmdldFNlc3Npb25BdHRyaWJ1dGVzKCkNCiAgICAgICAgZm9ybV9wYXNzY29kZSA9IFNlcnZlclV0aWwuZ2V0Rmlyc3RWYWx1ZShyZXF1ZXN0UGFyYW1ldGVycywgInBhc3Njb2RlIikNCiAgICAgICAgZm9ybV9uYW1lID0gU2VydmVyVXRpbC5nZXRGaXJzdFZhbHVlKHJlcXVlc3RQYXJhbWV0ZXJzLCAiVHdpbGlvU21zbG9naW5Gb3JtIikNCg0KICAgICAgICBwcmludCAiVHdpbGlvU01TLiBmb3JtX3Jlc3BvbnNlX3Bhc3Njb2RlOiAlcyIgJSBzdHIoZm9ybV9wYXNzY29kZSkNCg0KICAgICAgICBpZiBzdGVwID09IDE6DQogICAgICAgICAgICBwcmludCAiVHdpbGlvU01TLiBTdGVwIDEgUGFzc3dvcmQgQXV0aGVudGljYXRpb24iDQogICAgICAgICAgICBjcmVkZW50aWFscyA9IHNlbGYuaWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHMoKQ0KDQogICAgICAgICAgICB1c2VyX25hbWUgPSBjcmVkZW50aWFscy5nZXRVc2VybmFtZSgpDQogICAgICAgICAgICB1c2VyX3Bhc3N3b3JkID0gY3JlZGVudGlhbHMuZ2V0UGFzc3dvcmQoKQ0KDQogICAgICAgICAgICBsb2dnZWRfaW4gPSBGYWxzZQ0KICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9uYW1lKSBhbmQgU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9wYXNzd29yZCk6DQogICAgICAgICAgICAgICAgbG9nZ2VkX2luID0gYXV0aGVudGljYXRpb25TZXJ2aWNlLmF1dGhlbnRpY2F0ZSh1c2VyX25hbWUsIHVzZXJfcGFzc3dvcmQpDQoNCiAgICAgICAgICAgIGlmIG5vdCBsb2dnZWRfaW46DQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICAgICAgICAgICMgR2V0IHRoZSBQZXJzb24ncyBudW1iZXIgYW5kIGdlbmVyYXRlIGEgY29kZQ0KICAgICAgICAgICAgZm91bmRVc2VyID0gTm9uZQ0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgIGZvdW5kVXNlciA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpDQogICAgICAgICAgICBleGNlcHQ6DQogICAgICAgICAgICAgICAgcHJpbnQgJ1R3aWxpb1NNUywgRXJyb3IgcmV0cmlldmluZyB1c2VyICVzIGZyb20gTERBUCcgJSAodXNlcl9uYW1lKQ0KICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgaXNWZXJpZmllZCA9IGZvdW5kVXNlci5nZXRBdHRyaWJ1dGUoInBob25lTnVtYmVyVmVyaWZpZWQiKQ0KICAgICAgICAgICAgICAgIGlmIGlzVmVyaWZpZWQ6DQogICAgICAgICAgICAgICAgICAgIHNlbGYubW9iaWxlX251bWJlciA9IGZvdW5kVXNlci5nZXRBdHRyaWJ1dGUoImVtcGxveWVlTnVtYmVyIikNCiAgICAgICAgICAgICAgICBpZiAgc2VsZi5tb2JpbGVfbnVtYmVyID09IE5vbmU6DQogICAgICAgICAgICAgICAgICAgIHNlbGYubW9iaWxlX251bWJlciA9IGZvdW5kVXNlci5nZXRBdHRyaWJ1dGUoIm1vYmlsZSIpDQogICAgICAgICAgICAgICAgaWYgIHNlbGYubW9iaWxlX251bWJlciA9PSBOb25lOg0KICAgICAgICAgICAgICAgICAgICBzZWxmLm1vYmlsZV9udW1iZXIgPSBmb3VuZFVzZXIuZ2V0QXR0cmlidXRlKCJ0ZWxlcGhvbmVOdW1iZXIiKQ0KICAgICAgICAgICAgICAgIGlmICBzZWxmLm1vYmlsZV9udW1iZXIgPT0gTm9uZToNCiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIlR3aWxpb1NNUywgRXJyb3IgZmluZGluZyBtb2JpbGUgbnVtYmVyIGZvciB1c2VyICclcyciICUgdXNlcl9uYW1lICAgIA0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIGV4Y2VwdDoNCiAgICAgICAgICAgICAgICBmYWNlc01lc3NhZ2VzLmFkZChGYWNlc01lc3NhZ2UuU0VWRVJJVFlfRVJST1IsICJGYWlsZWQgdG8gZGV0ZXJtaW5lIG1vYmlsZSBwaG9uZSBudW1iZXIiKQ0KICAgICAgICAgICAgICAgIHByaW50ICdUd2lsaW9TTVMsIEVycm9yIGZpbmRpbmcgbW9iaWxlIG51bWJlciBmb3IgIiVzIi4gRXhjZXB0aW9uOiAlc2AgJSAodXNlcl9uYW1lLCBzeXMuZXhjX2luZm8oKVsxXSlgJw0KICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgICAgICAgICAjIEdlbmVyYXRlIFJhbmRvbSBzaXggZGlnaXQgY29kZSBhbmQgc3RvcmUgaXQgaW4gYXJyYXkNCiAgICAgICAgICAgIGNvZGUgPSByYW5kb20ucmFuZGludCgxMDAwMDAsIDk5OTk5OSkNCg0KICAgICAgICAgICAgIyBHZXQgY29kZSBhbmQgc2F2ZSBpdCBpbiBMREFQIHRlbXBvcmFyaWx5IHdpdGggc3BlY2lhbCBzZXNzaW9uIGVudHJ5DQogICAgICAgICAgICBzZWxmLmlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImNvZGUiLCBjb2RlKQ0KDQogICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgVHdpbGlvLmluaXQoc2VsZi5BQ0NPVU5UX1NJRCwgc2VsZi5BVVRIX1RPS0VOKTsNCiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZS5jcmVhdG9yKFBob25lTnVtYmVyKHNlbGYubW9iaWxlX251bWJlciksIFBob25lTnVtYmVyKHNlbGYuRlJPTV9OVU1CRVIpLCBzdHIoY29kZSkpLmNyZWF0ZSgpOw0KICAgICAgICAgICAgICAgIHByaW50ICIrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrIg0KICAgICAgICAgICAgICAgIHByaW50ICdUd2lsaW9TTXMsIE1lc3NhZ2UgU2lkOiAlcycgJSAobWVzc2FnZS5nZXRTaWQoKSkNCiAgICAgICAgICAgICAgICBwcmludCAnVHdpbGlvU01zLCBVc2VyIHBob25lOiAlcycgJSAoc2VsZi5tb2JpbGVfbnVtYmVyKQ0KICAgICAgICAgICAgICAgIHByaW50ICIrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrIg0KICAgICAgICAgICAgICAgIHNlbGYuaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigibW9iaWxlX251bWJlciIsIHNlbGYubW9iaWxlX251bWJlcikNCiAgICAgICAgICAgICAgICBzZWxmLmlkZW50aXR5LmdldFNlc3Npb25JZCgpLmdldFNlc3Npb25BdHRyaWJ1dGVzKCkucHV0KCJtb2JpbGVfbnVtYmVyIixzZWxmLm1vYmlsZV9udW1iZXIpDQogICAgICAgICAgICAgICAgc2VsZi5pZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJtb2JpbGUiLCBzZWxmLm1vYmlsZV9udW1iZXIpDQogICAgICAgICAgICAgICAgc2VsZi5pZGVudGl0eS5nZXRTZXNzaW9uSWQoKS5nZXRTZXNzaW9uQXR0cmlidXRlcygpLnB1dCgibW9iaWxlIixzZWxmLm1vYmlsZV9udW1iZXIpDQogICAgICAgICAgICAgICAgcHJpbnQgIisrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysiDQogICAgICAgICAgICAgICAgcHJpbnQgIk51bWJlcjogJXMiICUgKHNlbGYuaWRlbnRpdHkuZ2V0V29ya2luZ1BhcmFtZXRlcigibW9iaWxlX251bWJlciIpKQ0KICAgICAgICAgICAgICAgIHByaW50ICJNb2JpbGU6ICVzIiAlIChzZWxmLmlkZW50aXR5LmdldFdvcmtpbmdQYXJhbWV0ZXIoIm1vYmlsZSIpKQ0KICAgICAgICAgICAgICAgIHByaW50ICIrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrIg0KICAgICAgICAgICAgICAgIHJldHVybiBUcnVlDQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uLCBleDoNCiAgICAgICAgICAgICAgICBmYWNlc01lc3NhZ2VzLmFkZChGYWNlc01lc3NhZ2UuU0VWRVJJVFlfRVJST1IsICJGYWlsZWQgdG8gc2VuZCBtZXNzYWdlIHRvIG1vYmlsZSBwaG9uZSIpDQogICAgICAgICAgICAgICAgcHJpbnQgIlR3aWxpb1NNUy4gRXJyb3Igc2VuZGluZyBtZXNzYWdlIHRvIFR3aWxpbyINCiAgICAgICAgICAgICAgICBwcmludCAiVHdpbGlvU01TLiBVbmV4cGVjdGVkIGVycm9yOiIsIGV4DQoNCiAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KICAgICAgICBlbGlmIHN0ZXAgPT0gMjoNCiAgICAgICAgICAgICMgUmV0cmlldmUgdGhlIHNlc3Npb24gYXR0cmlidXRlDQogICAgICAgICAgICBwcmludCAiVHdpbGlvU01TLiBTdGVwIDIgU01TL09UUCBBdXRoZW50aWNhdGlvbiINCiAgICAgICAgICAgIGNvZGUgPSBzZXNzaW9uX2F0dHJpYnV0ZXMuZ2V0KCJjb2RlIikNCiAgICAgICAgICAgIHByaW50ICItLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIg0KICAgICAgICAgICAgcHJpbnQgIlR3aWxpb1NNUy4gQ29kZTogJXMiICUgc3RyKGNvZGUpDQogICAgICAgICAgICBwcmludCAiLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSINCg0KICAgICAgICAgICAgaWYgY29kZSBpcyBOb25lOg0KICAgICAgICAgICAgICAgIHByaW50ICJUd2lsaW9TTVMuIEZhaWxlZCB0byBmaW5kIHByZXZpb3VzbHkgc2VudCBjb2RlIg0KICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgICAgICAgICBpZiBmb3JtX3Bhc3Njb2RlIGlzIE5vbmU6DQogICAgICAgICAgICAgICAgcHJpbnQgIlR3aWxpb1NNUy4gUGFzc2NvZGUgaXMgZW1wdHkiDQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICAgICAgICAgIGlmIGxlbihmb3JtX3Bhc3Njb2RlKSAhPSA2Og0KICAgICAgICAgICAgICAgIHByaW50ICJUd2lsaW9TTVMuIFBhc3Njb2RlIGZyb20gcmVzcG9uc2UgaXMgbm90IDYgZGlnaXRzOiAlcyIgJSBmb3JtX3Bhc3Njb2RlDQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICAgICAgICAgIGlmIGZvcm1fcGFzc2NvZGUgPT0gY29kZToNCiAgICAgICAgICAgICAgICBwcmludCAiVGl3bGlvU01TLCBTVUNDRVNTISBVc2VyIGVudGVyZWQgdGhlIHNhbWUgY29kZSEiDQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgICAgICAgICAgcHJpbnQgIisrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrIiANCiAgICAgICAgICAgIHByaW50ICJUd2lsaW9TTVMuIEZBSUwhIFVzZXIgZW50ZXJlZCB0aGUgd3JvbmcgY29kZSEgJXMgIT0gJXMiICUgKGZvcm1fcGFzc2NvZGUsIGNvZGUpDQogICAgICAgICAgICBwcmludCAiKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysiIA0KICAgICAgICAgICAgZmFjZXNNZXNzYWdlcy5hZGQoRmFjZXNNZXNzYWdlLlNFVkVSSVRZX0VSUk9SLCAiSW5jb3JyZWN0IFR3aWxpbyBjb2RlLCBwbGVhc2UgdHJ5IGFnYWluLiIpDQoNCiAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgICAgIHByaW50ICJUd2lsaW9TTVMuIEVSUk9SOiBzdGVwIHBhcmFtIG5vdCBmb3VuZCBvciAhPSAoMXwyKSINCg0KICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgIGRlZiBwcmVwYXJlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOg0KICAgICAgICBpZiBzdGVwID09IDE6DQogICAgICAgICAgICBwcmludCAiVHdpbGlvU01TLiBQcmVwYXJlIGZvciBTdGVwIDEiDQogICAgICAgICAgICByZXR1cm4gVHJ1ZQ0KICAgICAgICBlbGlmIHN0ZXAgPT0gMjoNCiAgICAgICAgICAgIHByaW50ICJUd2lsaW9TTVMuIFByZXBhcmUgZm9yIFN0ZXAgMiINCiAgICAgICAgICAgIHJldHVybiBUcnVlDQogICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgZGVmIGdldEV4dHJhUGFyYW1ldGVyc0ZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOg0KICAgICAgICBpZiBzdGVwID09IDI6DQogICAgICAgICAgICByZXR1cm4gQXJyYXlzLmFzTGlzdCgiY29kZSIpDQoNCiAgICAgICAgcmV0dXJuIE5vbmUNCg0KICAgIGRlZiBnZXRDb3VudEF1dGhlbnRpY2F0aW9uU3RlcHMoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOg0KICAgICAgICByZXR1cm4gMg0KDQogICAgZGVmIGdldFBhZ2VGb3JTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCBzdGVwKToNCiAgICAgICAgaWYgc3RlcCA9PSAyOg0KICAgICAgICAgICAgcmV0dXJuICIvYXV0aC9vdHBfc21zL290cF9zbXMueGh0bWwiDQoNCiAgICAgICAgcmV0dXJuICIiDQogICAgICAgIA0KICAgIGRlZiBnZXROZXh0U3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOg0KICAgICAgICByZXR1cm4gLTENCg0KICAgIGRlZiBnZXRMb2dvdXRFeHRlcm5hbFVybChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMpOg0KICAgICAgICBwcmludCAiR2V0IGV4dGVybmFsIGxvZ291dCBVUkwgY2FsbCINCiAgICAgICAgcmV0dXJuIE5vbmUNCiAgICAgICAgDQogICAgZGVmIGxvZ291dChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMpOg0KICAgICAgICByZXR1cm4gVHJ1ZQ0K
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=09A0-93D7,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: SMPP SMS authentication module
displayName: smpp
oxEnabled: false
inum: 09A0-93D7
oxConfigurationProperty: {"value1":"smpp_server","value2":"","description":"IP or FQDN of SMPP server"}
oxConfigurationProperty: {"value1":"smpp_port","value2":"","description":"TCP port of the SMPP server"}
oxConfigurationProperty: {"value1":"system_id","value2":"","description":"Use if SMPP server requires authentication"}
oxConfigurationProperty: {"value1":"password","value2":"","description":"Use if SMPP server requires authentication"}
oxConfigurationProperty: {"value1":"source_addr_ton","value2":"","description":"Type of number, eg ALPHANUMERIC, INTERNATIONAL"}
oxConfigurationProperty: {"value1":"source_addr","value2":"","description":"From number/name"}
oxLevel: 45
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE4LCBHbHV1CiMgQ29weXJpZ2h0IChjKSAyMDE5LCBUZWxlMgoKIyBBdXRob3I6IEpvc2UgR29uemFsZXoKIyBBdXRob3I6IEdhc215ciBNb3VnYW5nCiMgQXV0aG9yOiBTdGVmYW4gQW5kZXJzc29uCgpmcm9tIGphdmEudXRpbCBpbXBvcnQgQXJyYXlzLCBEYXRlCmZyb20gamF2YS5pbyBpbXBvcnQgSU9FeGNlcHRpb24KZnJvbSBqYXZhLmxhbmcgaW1wb3J0IEVudW0KCmZyb20gb3JnLmdsdXUuc2VydmljZS5jZGkudXRpbCBpbXBvcnQgQ2RpVXRpbApmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZWN1cml0eSBpbXBvcnQgSWRlbnRpdHkKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuYXV0aCBpbXBvcnQgUGVyc29uQXV0aGVudGljYXRpb25UeXBlCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UgaW1wb3J0IEF1dGhlbnRpY2F0aW9uU2VydmljZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlLmNvbW1vbiBpbXBvcnQgVXNlclNlcnZpY2UKZnJvbSBvcmcuZ2x1dS5veGF1dGgudXRpbCBpbXBvcnQgU2VydmVyVXRpbApmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlciwgQXJyYXlIZWxwZXIKZnJvbSBqYXZheC5mYWNlcy5hcHBsaWNhdGlvbiBpbXBvcnQgRmFjZXNNZXNzYWdlCmZyb20gb3JnLmdsdXUuanNmMi5tZXNzYWdlIGltcG9ydCBGYWNlc01lc3NhZ2VzCgpmcm9tIG9yZy5qc21wcCBpbXBvcnQgSW52YWxpZFJlc3BvbnNlRXhjZXB0aW9uLCBQRFVFeGNlcHRpb24KZnJvbSBvcmcuanNtcHAuYmVhbiBpbXBvcnQgQWxwaGFiZXQsIEJpbmRUeXBlLCBFU01DbGFzcywgR2VuZXJhbERhdGFDb2RpbmcsIE1lc3NhZ2VDbGFzcywgTnVtYmVyaW5nUGxhbkluZGljYXRvciwgUmVnaXN0ZXJlZERlbGl2ZXJ5LCBTTVNDRGVsaXZlcnlSZWNlaXB0LCBUeXBlT2ZOdW1iZXIKZnJvbSBvcmcuanNtcHAuZXh0cmEgaW1wb3J0IE5lZ2F0aXZlUmVzcG9uc2VFeGNlcHRpb24sIFJlc3BvbnNlVGltZW91dEV4Y2VwdGlvbgpmcm9tIG9yZy5qc21wcC5zZXNzaW9uIGltcG9ydCBCaW5kUGFyYW1ldGVyLCBTTVBQU2Vzc2lvbgpmcm9tIG9yZy5qc21wcC51dGlsIGltcG9ydCBBYnNvbHV0ZVRpbWVGb3JtYXR0ZXIsIFRpbWVGb3JtYXR0ZXIKaW1wb3J0IHJhbmRvbQoKCmNsYXNzIFNtcHBBdHRyaWJ1dGVFcnJvcihFeGNlcHRpb24pOgogICAgcGFzcwoKCmNsYXNzIFBlcnNvbkF1dGhlbnRpY2F0aW9uKFBlcnNvbkF1dGhlbnRpY2F0aW9uVHlwZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwogICAgICAgIHNlbGYuaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCgogICAgZGVmIGdldF9hbmRfcGFyc2Vfc21wcF9jb25maWcoc2VsZiwgY29uZmlnLCBhdHRyaWJ1dGUsIF90eXBlID0gTm9uZSwgIGNvbnZlcnQgPSBGYWxzZSwgb3B0aW9uYWwgPSBGYWxzZSwgZGVmYXVsdF9kZXNjID0gTm9uZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWx1ZSA9IGNvbmZpZy5nZXQoYXR0cmlidXRlKS5nZXRWYWx1ZTIoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgaWYgZGVmYXVsdF9kZXNjOgogICAgICAgICAgICAgICAgZGVmYXVsdF9kZXNjID0gIiB1c2luZyBkZWZhdWx0ICd7fSciLmZvcm1hdChkZWZhdWx0X2Rlc2MpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBkZWZhdWx0X2Rlc2MgPSAiIgoKICAgICAgICAgICAgaWYgb3B0aW9uYWw6CiAgICAgICAgICAgICAgICByYWlzZSBTbXBwQXR0cmlidXRlRXJyb3IoIlNNUFAgbWlzc2luZyBvcHRpb25hbCBjb25maWd1cmF0aW9uIGF0dHJpYnV0ZSAne30ne30iLmZvcm1hdChhdHRyaWJ1dGUsIGRlZmF1bHRfZGVzYykpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZSBTbXBwQXR0cmlidXRlRXJyb3IoIlNNUFAgbWlzc2luZyByZXF1aXJlZCBjb25maWd1cmF0aW9uIGF0dHJpYnV0ZSAne30nIi5mb3JtYXQoYXR0cmlidXRlKSkKCiAgICAgICAgaWYgX3R5cGUgYW5kIGlzc3ViY2xhc3MoX3R5cGUsIEVudW0pOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0YXR0cihfdHlwZSwgdmFsdWUpCiAgICAgICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgICAgIHJhaXNlIFNtcHBBdHRyaWJ1dGVFcnJvcigiU01QUCBjb3VsZCBub3QgZmluZCBhdHRyaWJ1dGUgJ3t9JyBpbiB7fSIuZm9ybWF0KGF0dHJpYnV0ZSwgX3R5cGUpKQoKICAgICAgICBpZiBjb252ZXJ0OgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGludCh2YWx1ZSkKICAgICAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gaW50KHZhbHVlLCAxNikKICAgICAgICAgICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgICAgICAgICByYWlzZSBTbXBwQXR0cmlidXRlRXJyb3IoIlNNUFAgY291bGQgbm90IHBhcnNlIHZhbHVlICd7fScgb2YgYXR0cmlidXRlICd7fSciLmZvcm1hdCh2YWx1ZSwgYXR0cmlidXRlKSkKCiAgICAgICAgcmV0dXJuIHZhbHVlCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQoIlNNUFAgSW5pdGlhbGl6YXRpb24iKQoKICAgICAgICBzZWxmLlRJTUVfRk9STUFUVEVSID0gQWJzb2x1dGVUaW1lRm9ybWF0dGVyKCkKCiAgICAgICAgc2VsZi5TTVBQX1NFUlZFUiA9IE5vbmUKICAgICAgICBzZWxmLlNNUFBfUE9SVCA9IE5vbmUKCiAgICAgICAgc2VsZi5TWVNURU1fSUQgPSBOb25lCiAgICAgICAgc2VsZi5QQVNTV09SRCA9IE5vbmUKCiAgICAgICAgIyBTZXR1cCBzb21lIGdvb2QgZGVmYXVsdHMgZm9yIFRPTiwgTlBJIGFuZCBzb3VyY2UgKGZyb20pIGFkZHJlc3MKICAgICAgICAjIFRPTiAoVHlwZSBvZiBOdW1iZXIpLCBOUEkgKE51bWJlciBQbGFuIEluZGljYXRvcikKICAgICAgICBzZWxmLlNSQ19BRERSX1RPTiA9IFR5cGVPZk51bWJlci5BTFBIQU5VTUVSSUMgICAgIyBBbHBoYW51bWVyaWMKICAgICAgICBzZWxmLlNSQ19BRERSX05QSSA9IE51bWJlcmluZ1BsYW5JbmRpY2F0b3IuSVNETiAgIyBJU0ROIChFMTYzL0UxNjQpCiAgICAgICAgc2VsZi5TUkNfQUREUiA9ICJHbHV1IE9UUCIKCiAgICAgICAgIyBEb24ndCB0b3VjaCB0aGVzZSB1bmxlc3MgeW91IGtub3cgd2hhdCB5b3VyIGRvaW5nLCB3ZSBkb24ndCBoYW5kbGUgbnVtYmVyIHJlZm9ybWF0dGluZyBmb3IKICAgICAgICAjIGFueSBvdGhlciB0eXBlIHRoYW4gaW50ZXJuYXRpb25hbC4KICAgICAgICBzZWxmLkRTVF9BRERSX1RPTiA9IFR5cGVPZk51bWJlci5JTlRFUk5BVElPTkFMICAgIyBJbnRlcm5hdGlvbmFsCiAgICAgICAgc2VsZi5EU1RfQUREUl9OUEkgPSBOdW1iZXJpbmdQbGFuSW5kaWNhdG9yLklTRE4gICMgSVNETiAoRTE2My9FMTY0KQoKICAgICAgICAjIFByaW9yaXR5IGZsYWcgYW5kIGRhdGFfY29kaW5nIGJpdHMKICAgICAgICBzZWxmLlBSSU9SSVRZX0ZMQUcgPSAzICAjIFZlcnkgVXJnZW50IChBTlNJLTEzNiksIEVtZXJnZW5jeSAoSVMtOTUpCiAgICAgICAgc2VsZi5EQVRBX0NPRElOR19BTFBIQUJFVCA9IEFscGhhYmV0LkFMUEhBX0RFRkFVTFQgICMgU01TIGRlZmF1bHQgYWxwaGFiZXQKICAgICAgICBzZWxmLkRBVEFfQ09ESU5HX01FU1NBR0VfQ0xBU1MgPSBNZXNzYWdlQ2xhc3MuQ0xBU1MxICAjIEVNIChNb2JpbGUgRXF1aXBtZW50IChtb2JpbGUgbWVtb3J5KSwgbm9ybWFsIG1lc3NhZ2UKCiAgICAgICAgIyBSZXF1aXJlZCBzZXJ2ZXIgc2V0dGluZ3MKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuU01QUF9TRVJWRVIgPSBzZWxmLmdldF9hbmRfcGFyc2Vfc21wcF9jb25maWcoY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsICJzbXBwX3NlcnZlciIpCiAgICAgICAgZXhjZXB0IFNtcHBBdHRyaWJ1dGVFcnJvciBhcyBlOgogICAgICAgICAgICBwcmludChlKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuU01QUF9QT1JUID0gc2VsZi5nZXRfYW5kX3BhcnNlX3NtcHBfY29uZmlnKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCAic21wcF9wb3J0IiwgY29udmVydCA9IFRydWUpCiAgICAgICAgZXhjZXB0IFNtcHBBdHRyaWJ1dGVFcnJvciBhcyBlOgogICAgICAgICAgICBwcmludChlKQoKICAgICAgICBpZiBOb25lIGluIChzZWxmLlNNUFBfU0VSVkVSLCBzZWxmLlNNUFBfUE9SVCk6CiAgICAgICAgICAgIHByaW50KCJTTVBQIHNtcHBfc2VydmVyIGFuZCBzbXBwX3BvcnQgaXMgZW1wdHksIHdpbGwgbm90IGVuYWJsZSBTTVBQIHNlcnZpY2UiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgIyBPcHRpb25hbCBzeXN0ZW1faWQgYW5kIHBhc3N3b3JkIGZvciBiaW5kIGF1dGgKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuU1lTVEVNX0lEID0gc2VsZi5nZXRfYW5kX3BhcnNlX3NtcHBfY29uZmlnKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCAic3lzdGVtX2lkIiwgb3B0aW9uYWwgPSBUcnVlKQogICAgICAgIGV4Y2VwdCBTbXBwQXR0cmlidXRlRXJyb3IgYXMgZToKICAgICAgICAgICAgcHJpbnQoZSkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLlBBU1NXT1JEID0gc2VsZi5nZXRfYW5kX3BhcnNlX3NtcHBfY29uZmlnKGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCAicGFzc3dvcmQiLCBvcHRpb25hbCA9IFRydWUpCiAgICAgICAgZXhjZXB0IFNtcHBBdHRyaWJ1dGVFcnJvciBhcyBlOgogICAgICAgICAgICBwcmludChlKQoKICAgICAgICBpZiBOb25lIGluIChzZWxmLlNZU1RFTV9JRCwgc2VsZi5QQVNTV09SRCk6CiAgICAgICAgICAgIHByaW50KCJTTVBQIEF1dGhlbnRpY2F0aW9uIGRpc2FibGVkIikKCiAgICAgICAgIyBGcm9tIG51bWJlciBhbmQgdG8gbnVtYmVyIHNldHRpbmdzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLlNSQ19BRERSX1RPTiA9IHNlbGYuZ2V0X2FuZF9wYXJzZV9zbXBwX2NvbmZpZygKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLAogICAgICAgICAgICAgICAgInNvdXJjZV9hZGRyX3RvbiIsCiAgICAgICAgICAgICAgICBfdHlwZSA9IFR5cGVPZk51bWJlciwKICAgICAgICAgICAgICAgIG9wdGlvbmFsID0gVHJ1ZSwKICAgICAgICAgICAgICAgIGRlZmF1bHRfZGVzYyA9IHNlbGYuU1JDX0FERFJfVE9OCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgU21wcEF0dHJpYnV0ZUVycm9yIGFzIGU6CiAgICAgICAgICAgIHByaW50KGUpCgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5TUkNfQUREUl9OUEkgPSBzZWxmLmdldF9hbmRfcGFyc2Vfc21wcF9jb25maWcoCiAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uQXR0cmlidXRlcywKICAgICAgICAgICAgICAgICJzb3VyY2VfYWRkcl9ucGkiLAogICAgICAgICAgICAgICAgX3R5cGUgPSBOdW1iZXJpbmdQbGFuSW5kaWNhdG9yLAogICAgICAgICAgICAgICAgb3B0aW9uYWwgPSBUcnVlLAogICAgICAgICAgICAgICAgZGVmYXVsdF9kZXNjID0gc2VsZi5TUkNfQUREUl9OUEkKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBTbXBwQXR0cmlidXRlRXJyb3IgYXMgZToKICAgICAgICAgICAgcHJpbnQoZSkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLlNSQ19BRERSID0gc2VsZi5nZXRfYW5kX3BhcnNlX3NtcHBfY29uZmlnKAogICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICAic291cmNlX2FkZHIiLAogICAgICAgICAgICAgICAgb3B0aW9uYWwgPSBUcnVlLAogICAgICAgICAgICAgICAgZGVmYXVsdF9kZXNjID0gc2VsZi5TUkNfQUREUgogICAgICAgICAgICApCiAgICAgICAgZXhjZXB0IFNtcHBBdHRyaWJ1dGVFcnJvciBhcyBlOgogICAgICAgICAgICBwcmludChlKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuRFNUX0FERFJfVE9OID0gc2VsZi5nZXRfYW5kX3BhcnNlX3NtcHBfY29uZmlnKAogICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICAiZGVzdF9hZGRyX3RvbiIsCiAgICAgICAgICAgICAgICBfdHlwZSA9IFR5cGVPZk51bWJlciwKICAgICAgICAgICAgICAgIG9wdGlvbmFsID0gVHJ1ZSwKICAgICAgICAgICAgICAgIGRlZmF1bHRfZGVzYyA9IHNlbGYuRFNUX0FERFJfVE9OCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgU21wcEF0dHJpYnV0ZUVycm9yIGFzIGU6CiAgICAgICAgICAgIHByaW50KGUpCgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5EU1RfQUREUl9OUEkgPSBzZWxmLmdldF9hbmRfcGFyc2Vfc21wcF9jb25maWcoCiAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uQXR0cmlidXRlcywKICAgICAgICAgICAgICAgICJkZXN0X2FkZHJfbnBpIiwKICAgICAgICAgICAgICAgIF90eXBlID0gTnVtYmVyaW5nUGxhbkluZGljYXRvciwKICAgICAgICAgICAgICAgIG9wdGlvbmFsID0gVHJ1ZSwKICAgICAgICAgICAgICAgIGRlZmF1bHRfZGVzYyA9IHNlbGYuRFNUX0FERFJfTlBJCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgU21wcEF0dHJpYnV0ZUVycm9yIGFzIGU6CiAgICAgICAgICAgIHByaW50KGUpCgogICAgICAgICMgUHJpb3JpdHkgZmxhZyBhbmQgZGF0YSBjb2RpbmcsIGRvbid0IHRvdWNoIHRoZXNlIHVubGVzcyB5b3Uga25vdyB3aGF0IHlvdXIgZG9pbmcuLi4KICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuUFJJT1JJVFlfRkxBRyA9IHNlbGYuZ2V0X2FuZF9wYXJzZV9zbXBwX2NvbmZpZygKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLAogICAgICAgICAgICAgICAgInByaW9yaXR5X2ZsYWciLAogICAgICAgICAgICAgICAgY29udmVydCA9IFRydWUsCiAgICAgICAgICAgICAgICBvcHRpb25hbCA9IFRydWUsCiAgICAgICAgICAgICAgICBkZWZhdWx0X2Rlc2MgPSAiMyAoVmVyeSBVcmdlbnQsIEVtZXJnZW5jeSkiCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgU21wcEF0dHJpYnV0ZUVycm9yIGFzIGU6CiAgICAgICAgICAgIHByaW50KGUpCgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5EQVRBX0NPRElOR19BTFBIQUJFVCA9IHNlbGYuZ2V0X2FuZF9wYXJzZV9zbXBwX2NvbmZpZygKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLAogICAgICAgICAgICAgICAgImRhdGFfY29kaW5nX2FscGhhYmV0IiwKICAgICAgICAgICAgICAgIF90eXBlID0gQWxwaGFiZXQsCiAgICAgICAgICAgICAgICBvcHRpb25hbCA9IFRydWUsCiAgICAgICAgICAgICAgICBkZWZhdWx0X2Rlc2MgPSBzZWxmLkRBVEFfQ09ESU5HX0FMUEhBQkVUCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgU21wcEF0dHJpYnV0ZUVycm9yIGFzIGU6CiAgICAgICAgICAgIHByaW50KGUpCgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5EQVRBX0NPRElOR19NRVNTQUdFX0NMQVNTID0gc2VsZi5nZXRfYW5kX3BhcnNlX3NtcHBfY29uZmlnKAogICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICAiZGF0YV9jb2RpbmdfYWxwaGFiZXQiLAogICAgICAgICAgICAgICAgX3R5cGUgPSBNZXNzYWdlQ2xhc3MsCiAgICAgICAgICAgICAgICBvcHRpb25hbCA9IFRydWUsCiAgICAgICAgICAgICAgICBkZWZhdWx0X2Rlc2MgPSBzZWxmLkRBVEFfQ09ESU5HX01FU1NBR0VfQ0xBU1MKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBTbXBwQXR0cmlidXRlRXJyb3IgYXMgZToKICAgICAgICAgICAgcHJpbnQoZSkKCiAgICAgICAgcHJpbnQoIlNNUFAgSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IikKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCgiU01QUCBEZXN0cm95IikKICAgICAgICBwcmludCgiU01QUCBEZXN0cm95ZWQgc3VjY2Vzc2Z1bGx5IikKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQogICAgICAgIAogICAgZGVmIGdldEF1dGhlbnRpY2F0aW9uTWV0aG9kQ2xhaW1zKHNlbGYsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgZGVmIGlzVmFsaWRBdXRoZW50aWNhdGlvbk1ldGhvZChzZWxmLCB1c2FnZVR5cGUsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBbHRlcm5hdGl2ZUF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGF1dGhlbnRpY2F0ZShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIHVzZXJTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKFVzZXJTZXJ2aWNlKQogICAgICAgIGF1dGhlbnRpY2F0aW9uU2VydmljZSA9IENkaVV0aWwuYmVhbihBdXRoZW50aWNhdGlvblNlcnZpY2UpCgogICAgICAgIGZhY2VzTWVzc2FnZXMgPSBDZGlVdGlsLmJlYW4oRmFjZXNNZXNzYWdlcykKICAgICAgICBmYWNlc01lc3NhZ2VzLnNldEtlZXBNZXNzYWdlcygpCgogICAgICAgIHNlc3Npb25fYXR0cmlidXRlcyA9IHNlbGYuaWRlbnRpdHkuZ2V0U2Vzc2lvbklkKCkuZ2V0U2Vzc2lvbkF0dHJpYnV0ZXMoKQogICAgICAgIGZvcm1fcGFzc2NvZGUgPSBTZXJ2ZXJVdGlsLmdldEZpcnN0VmFsdWUocmVxdWVzdFBhcmFtZXRlcnMsICJwYXNzY29kZSIpCgogICAgICAgIHByaW50KCJTTVBQIGZvcm1fcmVzcG9uc2VfcGFzc2NvZGU6IHt9Ii5mb3JtYXQoc3RyKGZvcm1fcGFzc2NvZGUpKSkKCiAgICAgICAgaWYgc3RlcCA9PSAxOgogICAgICAgICAgICBwcmludCgiU01QUCBTdGVwIDEgUGFzc3dvcmQgQXV0aGVudGljYXRpb24iKQogICAgICAgICAgICBjcmVkZW50aWFscyA9IHNlbGYuaWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHMoKQoKICAgICAgICAgICAgdXNlcl9uYW1lID0gY3JlZGVudGlhbHMuZ2V0VXNlcm5hbWUoKQogICAgICAgICAgICB1c2VyX3Bhc3N3b3JkID0gY3JlZGVudGlhbHMuZ2V0UGFzc3dvcmQoKQoKICAgICAgICAgICAgbG9nZ2VkX2luID0gRmFsc2UKICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9uYW1lKSBhbmQgU3RyaW5nSGVscGVyLmlzTm90RW1wdHlTdHJpbmcodXNlcl9wYXNzd29yZCk6CiAgICAgICAgICAgICAgICBsb2dnZWRfaW4gPSBhdXRoZW50aWNhdGlvblNlcnZpY2UuYXV0aGVudGljYXRlKHVzZXJfbmFtZSwgdXNlcl9wYXNzd29yZCkKCiAgICAgICAgICAgIGlmIG5vdCBsb2dnZWRfaW46CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICMgR2V0IHRoZSBQZXJzb24ncyBudW1iZXIgYW5kIGdlbmVyYXRlIGEgY29kZQogICAgICAgICAgICBmb3VuZFVzZXIgPSBOb25lCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZvdW5kVXNlciA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50KCJTTVBQIEVycm9yIHJldHJpZXZpbmcgdXNlciB7fSBmcm9tIExEQVAiLmZvcm1hdCh1c2VyX25hbWUpKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBtb2JpbGVfbnVtYmVyID0gTm9uZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpc1ZlcmlmaWVkID0gZm91bmRVc2VyLmdldEF0dHJpYnV0ZSgicGhvbmVOdW1iZXJWZXJpZmllZCIpCiAgICAgICAgICAgICAgICBpZiBpc1ZlcmlmaWVkOgogICAgICAgICAgICAgICAgICAgIG1vYmlsZV9udW1iZXIgPSBmb3VuZFVzZXIuZ2V0QXR0cmlidXRlKCJlbXBsb3llZU51bWJlciIpCiAgICAgICAgICAgICAgICBpZiBub3QgbW9iaWxlX251bWJlcjoKICAgICAgICAgICAgICAgICAgICBtb2JpbGVfbnVtYmVyID0gZm91bmRVc2VyLmdldEF0dHJpYnV0ZSgibW9iaWxlIikKICAgICAgICAgICAgICAgIGlmIG5vdCBtb2JpbGVfbnVtYmVyOgogICAgICAgICAgICAgICAgICAgIG1vYmlsZV9udW1iZXIgPSBmb3VuZFVzZXIuZ2V0QXR0cmlidXRlKCJ0ZWxlcGhvbmVOdW1iZXIiKQogICAgICAgICAgICAgICAgaWYgbm90IG1vYmlsZV9udW1iZXI6CiAgICAgICAgICAgICAgICAgICAgZmFjZXNNZXNzYWdlcy5hZGQoRmFjZXNNZXNzYWdlLlNFVkVSSVRZX0VSUk9SLCAiRmFpbGVkIHRvIGRldGVybWluZSBtb2JpbGUgcGhvbmUgbnVtYmVyIikKICAgICAgICAgICAgICAgICAgICBwcmludCgiU01QUCBFcnJvciBmaW5kaW5nIG1vYmlsZSBudW1iZXIgZm9yIHVzZXIgJ3t9JyIuZm9ybWF0KHVzZXJfbmFtZSkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGZhY2VzTWVzc2FnZXMuYWRkKEZhY2VzTWVzc2FnZS5TRVZFUklUWV9FUlJPUiwgIkZhaWxlZCB0byBkZXRlcm1pbmUgbW9iaWxlIHBob25lIG51bWJlciIpCiAgICAgICAgICAgICAgICBwcmludCgiU01QUCBFcnJvciBmaW5kaW5nIG1vYmlsZSBudW1iZXIgZm9yIHt9OiB7fSIuZm9ybWF0KHVzZXJfbmFtZSwgZSkpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICMgR2VuZXJhdGUgUmFuZG9tIHNpeCBkaWdpdCBjb2RlCiAgICAgICAgICAgIGNvZGUgPSByYW5kb20ucmFuZGludCgxMDAwMDAsIDk5OTk5OSkKCiAgICAgICAgICAgICMgR2V0IGNvZGUgYW5kIHNhdmUgaXQgaW4gTERBUCB0ZW1wb3JhcmlseSB3aXRoIHNwZWNpYWwgc2Vzc2lvbiBlbnRyeQogICAgICAgICAgICBzZWxmLmlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImNvZGUiLCBjb2RlKQoKICAgICAgICAgICAgc2VsZi5pZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJtb2JpbGVfbnVtYmVyIiwgbW9iaWxlX251bWJlcikKICAgICAgICAgICAgc2VsZi5pZGVudGl0eS5nZXRTZXNzaW9uSWQoKS5nZXRTZXNzaW9uQXR0cmlidXRlcygpLnB1dCgibW9iaWxlX251bWJlciIsIG1vYmlsZV9udW1iZXIpCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNlbmRNZXNzYWdlKG1vYmlsZV9udW1iZXIsIHN0cihjb2RlKSk6CiAgICAgICAgICAgICAgICBmYWNlc01lc3NhZ2VzLmFkZChGYWNlc01lc3NhZ2UuU0VWRVJJVFlfRVJST1IsICJGYWlsZWQgdG8gc2VuZCBtZXNzYWdlIHRvIG1vYmlsZSBwaG9uZSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxpZiBzdGVwID09IDI6CiAgICAgICAgICAgICMgUmV0cmlldmUgdGhlIHNlc3Npb24gYXR0cmlidXRlCiAgICAgICAgICAgIHByaW50KCJTTVBQIFN0ZXAgMiBTTVMvT1RQIEF1dGhlbnRpY2F0aW9uIikKICAgICAgICAgICAgY29kZSA9IHNlc3Npb25fYXR0cmlidXRlcy5nZXQoImNvZGUiKQogICAgICAgICAgICBwcmludCgiU01QUCBDb2RlOiB7fSIuZm9ybWF0KHN0cihjb2RlKSkpCgogICAgICAgICAgICBpZiBjb2RlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBwcmludCgiU01QUCBGYWlsZWQgdG8gZmluZCBwcmV2aW91c2x5IHNlbnQgY29kZSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIGlmIGZvcm1fcGFzc2NvZGUgaXMgTm9uZToKICAgICAgICAgICAgICAgIHByaW50KCJTTVBQIFBhc3Njb2RlIGlzIGVtcHR5IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgaWYgbGVuKGZvcm1fcGFzc2NvZGUpICE9IDY6CiAgICAgICAgICAgICAgICBwcmludCgiU01QUCBQYXNzY29kZSBmcm9tIHJlc3BvbnNlIGlzIG5vdCA2IGRpZ2l0czoge30iLmZvcm1hdChmb3JtX3Bhc3Njb2RlKSkKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgaWYgZm9ybV9wYXNzY29kZSA9PSBjb2RlOgogICAgICAgICAgICAgICAgcHJpbnQoIlNNUFAgU1VDQ0VTUyEgVXNlciBlbnRlcmVkIHRoZSBzYW1lIGNvZGUhIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgICAgICBwcmludCgiU01QUCBmYWlsZWQsIHVzZXIgZW50ZXJlZCB0aGUgd3JvbmcgY29kZSEge30gIT0ge30iLmZvcm1hdChmb3JtX3Bhc3Njb2RlLCBjb2RlKSkKICAgICAgICAgICAgZmFjZXNNZXNzYWdlcy5hZGQoZmFjZXNNZXNzYWdlLlNFVkVSSVRZX0VSUk9SLCAiSW5jb3JyZWN0IFNNUyBjb2RlLCBwbGVhc2UgdHJ5IGFnYWluLiIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBwcmludCgiU01QUCBFUlJPUjogc3RlcCBwYXJhbSBub3QgZm91bmQgb3IgIT0gKDF8MikiKQogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBwcmVwYXJlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMsIHN0ZXApOgogICAgICAgIGlmIHN0ZXAgPT0gMToKICAgICAgICAgICAgcHJpbnQoIlNNUFAgUHJlcGFyZSBmb3IgU3RlcCAxIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbGlmIHN0ZXAgPT0gMjoKICAgICAgICAgICAgcHJpbnQoIlNNUFAgUHJlcGFyZSBmb3IgU3RlcCAyIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdldEV4dHJhUGFyYW1ldGVyc0ZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHN0ZXApOgogICAgICAgIGlmIHN0ZXAgPT0gMjoKICAgICAgICAgICAgcmV0dXJuIEFycmF5cy5hc0xpc3QoImNvZGUiKQoKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBnZXRDb3VudEF1dGhlbnRpY2F0aW9uU3RlcHMoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiAyCgogICAgZGVmIGdldFBhZ2VGb3JTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCBzdGVwKToKICAgICAgICBpZiBzdGVwID09IDI6CiAgICAgICAgICAgIHJldHVybiAiL2F1dGgvb3RwX3Ntcy9vdHBfc21zLnhodG1sIgoKICAgICAgICByZXR1cm4gIiIKCiAgICBkZWYgZ2V0TmV4dFN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKICAgICAgICByZXR1cm4gLTEKCiAgICBkZWYgZ2V0TG9nb3V0RXh0ZXJuYWxVcmwoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICBwcmludCAiR2V0IGV4dGVybmFsIGxvZ291dCBVUkwgY2FsbCIKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBsb2dvdXQoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzKToKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBzZW5kTWVzc2FnZShzZWxmLCBudW1iZXIsIGNvZGUpOgogICAgICAgIHN0YXR1cyA9IEZhbHNlCiAgICAgICAgc2Vzc2lvbiA9IFNNUFBTZXNzaW9uKCkKICAgICAgICBzZXNzaW9uLnNldFRyYW5zYWN0aW9uVGltZXIoMTAwMDApCgogICAgICAgICMgV2Ugb25seSBoYW5kbGUgaW50ZXJuYXRpb25hbCBkZXN0aW5hdGlvbiBudW1iZXIgcmVmb3JtYXR0aW5nLgogICAgICAgICMgQWxsIG90aGVycyBtYXkgdmFyeSBieSBjb25maWd1cmF0aW9uIGRlY2lzaW9ucyB0YWtlbiBvbiBTTVBQCiAgICAgICAgIyBzZXJ2ZXIgc2lkZSB3aGljaCB3ZSBoYXZlIG5vIGNsdWUgYWJvdXQuCiAgICAgICAgaWYgc2VsZi5EU1RfQUREUl9UT04gPT0gVHlwZU9mTnVtYmVyLklOVEVSTkFUSU9OQUwgYW5kIG51bWJlci5zdGFydHN3aXRoKCIrIik6CiAgICAgICAgICAgIG51bWJlciA9IG51bWJlclsxOl0KCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwcmludCgiU01QUCBDb25uZWN0aW5nIikKICAgICAgICAgICAgcmVmZXJlbmNlX2lkID0gc2Vzc2lvbi5jb25uZWN0QW5kQmluZCgKICAgICAgICAgICAgICAgIHNlbGYuU01QUF9TRVJWRVIsCiAgICAgICAgICAgICAgICBzZWxmLlNNUFBfUE9SVCwKICAgICAgICAgICAgICAgIEJpbmRQYXJhbWV0ZXIoCiAgICAgICAgICAgICAgICAgICAgQmluZFR5cGUuQklORF9UWCwKICAgICAgICAgICAgICAgICAgICBzZWxmLlNZU1RFTV9JRCwKICAgICAgICAgICAgICAgICAgICBzZWxmLlBBU1NXT1JELAogICAgICAgICAgICAgICAgICAgIE5vbmUsCiAgICAgICAgICAgICAgICAgICAgc2VsZi5TUkNfQUREUl9UT04sCiAgICAgICAgICAgICAgICAgICAgc2VsZi5TUkNfQUREUl9OUEksCiAgICAgICAgICAgICAgICAgICAgTm9uZQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICApCiAgICAgICAgICAgIHByaW50KCJTTVBQIENvbm5lY3RlZCB0byBzZXJ2ZXIgd2l0aCBzeXN0ZW0gaWQge30iLmZvcm1hdChyZWZlcmVuY2VfaWQpKQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbWVzc2FnZV9pZCA9IHNlc3Npb24uc3VibWl0U2hvcnRNZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICJDTVQiLAogICAgICAgICAgICAgICAgICAgIHNlbGYuU1JDX0FERFJfVE9OLAogICAgICAgICAgICAgICAgICAgIHNlbGYuU1JDX0FERFJfTlBJLAogICAgICAgICAgICAgICAgICAgIHNlbGYuU1JDX0FERFIsCiAgICAgICAgICAgICAgICAgICAgc2VsZi5EU1RfQUREUl9UT04sCiAgICAgICAgICAgICAgICAgICAgc2VsZi5EU1RfQUREUl9OUEksCiAgICAgICAgICAgICAgICAgICAgbnVtYmVyLAogICAgICAgICAgICAgICAgICAgIEVTTUNsYXNzKCksCiAgICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgICBzZWxmLlBSSU9SSVRZX0ZMQUcsCiAgICAgICAgICAgICAgICAgICAgc2VsZi5USU1FX0ZPUk1BVFRFUi5mb3JtYXQoRGF0ZSgpKSwKICAgICAgICAgICAgICAgICAgICBOb25lLAogICAgICAgICAgICAgICAgICAgIFJlZ2lzdGVyZWREZWxpdmVyeShTTVNDRGVsaXZlcnlSZWNlaXB0LkRFRkFVTFQpLAogICAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgICAgR2VuZXJhbERhdGFDb2RpbmcoCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuREFUQV9DT0RJTkdfQUxQSEFCRVQsCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuREFUQV9DT0RJTkdfTUVTU0FHRV9DTEFTUywKICAgICAgICAgICAgICAgICAgICAgICAgRmFsc2UKICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgICAgY29kZQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgcHJpbnQoIlNNUFAgTWVzc2FnZSAne30nIHNlbnQgdG8gI3t9IHdpdGggbWVzc2FnZSBpZCB7fSIuZm9ybWF0KGNvZGUsIG51bWJlciwgbWVzc2FnZV9pZCkpCiAgICAgICAgICAgICAgICBzdGF0dXMgPSBUcnVlCiAgICAgICAgICAgIGV4Y2VwdCBQRFVFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KCJTTVBQIEludmFsaWQgUERVIHBhcmFtZXRlcjoge30iLmZvcm1hdChlKSkKICAgICAgICAgICAgZXhjZXB0IFJlc3BvbnNlVGltZW91dEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoIlNNUFAgUmVzcG9uc2UgdGltZW91dDoge30iLmZvcm1hdChlKSkKICAgICAgICAgICAgZXhjZXB0IEludmFsaWRSZXNwb25zZUV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoIlNNUFAgUmVjZWl2ZSBpbnZhbGlkIHJlc3BvbnNlOiB7fSIuZm9ybWF0KGUpKQogICAgICAgICAgICBleGNlcHQgTmVnYXRpdmVSZXNwb25zZUV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoIlNNUFAgUmVjZWl2ZSBuZWdhdGl2ZSByZXNwb25zZToge30iLmZvcm1hdChlKSkKICAgICAgICAgICAgZXhjZXB0IElPRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludCgiU01QUCBJTyBlcnJvciBvY2N1cmVkOiB7fSIuZm9ybWF0KGUpKQogICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgc2Vzc2lvbi51bmJpbmRBbmRDbG9zZSgpCiAgICAgICAgZXhjZXB0IElPRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KCJTTVBQIEZhaWxlZCBjb25uZWN0IGFuZCBiaW5kIHRvIGhvc3Q6IHt9Ii5mb3JtYXQoZSkpCgogICAgICAgIHJldHVybiBzdGF0dXMK
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=DAA9-B789,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Sample Application Session script
displayName: application_session
oxEnabled: false
inum: DAA9-B789
oxLevel: 100
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE2LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuc2Vzc2lvbiBpbXBvcnQgQXBwbGljYXRpb25TZXNzaW9uVHlwZQpmcm9tIG9yZy5nbHV1LnNlcnZpY2UuY2RpLnV0aWwgaW1wb3J0IENkaVV0aWwKZnJvbSBvcmcuZ2x1dS5wZXJzaXN0IGltcG9ydCBQZXJzaXN0ZW5jZUVudHJ5TWFuYWdlcgpmcm9tIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5jb25maWcgaW1wb3J0IFN0YXRpY0NvbmZpZ3VyYXRpb24KZnJvbSBvcmcuZ2x1dS5veGF1dGgubW9kZWwubGRhcCBpbXBvcnQgVG9rZW5MZGFwCmZyb20gamF2YXguZmFjZXMuYXBwbGljYXRpb24gaW1wb3J0IEZhY2VzTWVzc2FnZQpmcm9tIG9yZy5nbHV1LmpzZjIubWVzc2FnZSBpbXBvcnQgRmFjZXNNZXNzYWdlcwpmcm9tIG9yZy5nbHV1LnV0aWwgaW1wb3J0IFN0cmluZ0hlbHBlciwgQXJyYXlIZWxwZXIKZnJvbSBvcmcuZ2x1dS5veGF1dGgubW9kZWwuY29uZmlnIGltcG9ydCBDb25zdGFudHMKZnJvbSBqYXZhLnV0aWwgaW1wb3J0IEFycmF5cywgQXJyYXlMaXN0CmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuZXh0ZXJuYWwuc2Vzc2lvbiBpbXBvcnQgU2Vzc2lvbkV2ZW50VHlwZQoKaW1wb3J0IGphdmEKCmNsYXNzIEFwcGxpY2F0aW9uU2Vzc2lvbihBcHBsaWNhdGlvblNlc3Npb25UeXBlKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6CiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkFwcGxpY2F0aW9uIHNlc3Npb24uIEluaXRpYWxpemF0aW9uIgoKICAgICAgICBzZWxmLmVudHJ5TWFuYWdlciA9IENkaVV0aWwuYmVhbihQZXJzaXN0ZW5jZUVudHJ5TWFuYWdlcikKICAgICAgICBzZWxmLnN0YXRpY0NvbmZpZ3VyYXRpb24gPSBDZGlVdGlsLmJlYW4oU3RhdGljQ29uZmlndXJhdGlvbikKCiAgICAgICAgcHJpbnQgIkFwcGxpY2F0aW9uIHNlc3Npb24uIEluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseSIKCiAgICAgICAgcmV0dXJuIFRydWUgICAKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkFwcGxpY2F0aW9uIHNlc3Npb24uIERlc3Ryb3kiCiAgICAgICAgcHJpbnQgIkFwcGxpY2F0aW9uIHNlc3Npb24uIERlc3Ryb3llZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUgICAKCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToKICAgICAgICByZXR1cm4gMTEKCiAgICAjIENhbGxlZCBlYWNoIHRpbWUgc3BlY2lmaWMgc2Vzc2lvbiBldmVudCBvY2N1cnMKICAgICMgZXZlbnQgaXMgb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuZXh0ZXJuYWwuc2Vzc2lvbi5TZXNzaW9uRXZlbnQKICAgIGRlZiBvbkV2ZW50KHNlbGYsIGV2ZW50KToKICAgICAgICBpZiBldmVudC5nZXRUeXBlKCkgPT0gU2Vzc2lvbkV2ZW50VHlwZS5BVVRIRU5USUNBVEVEOgogICAgICAgICAgICBwcmludCAiU2Vzc2lvbiBpcyBhdXRoZW50aWNhdGVkLCBzZXNzaW9uOiAiICsgZXZlbnQuZ2V0U2Vzc2lvbklkKCkuZ2V0SWQoKQogICAgICAgIHJldHVybgoKICAgICMgQXBwbGljYXRpb24gY2FsbHMgaXQgYXQgc3RhcnQgc2Vzc2lvbiByZXF1ZXN0IHRvIGFsbG93IG5vdGlmeSAzcmQgcGFydCBzeXN0ZW1zCiAgICAjICAgaHR0cFJlcXVlc3QgaXMgamF2YXguc2VydmxldC5odHRwLkh0dHBTZXJ2bGV0UmVxdWVzdAogICAgIyAgIHNlc3Npb25JZCBpcyBvcmcuZ2x1dS5veGF1dGgubW9kZWwuY29tbW9uLlNlc3Npb25JZAogICAgIyAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eT4KICAgIGRlZiBzdGFydFNlc3Npb24oc2VsZiwgaHR0cFJlcXVlc3QsIHNlc3Npb25JZCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJBcHBsaWNhdGlvbiBzZXNzaW9uLiBTdGFydGluZyBleHRlcm5hbCBzZXNzaW9uIgoKICAgICAgICB1c2VyX25hbWUgPSBzZXNzaW9uSWQuZ2V0U2Vzc2lvbkF0dHJpYnV0ZXMoKS5nZXQoQ29uc3RhbnRzLkFVVEhFTlRJQ0FURURfVVNFUikKCiAgICAgICAgZmlyc3Rfc2Vzc2lvbiA9IHNlbGYuaXNGaXJzdFNlc3Npb24odXNlcl9uYW1lKQogICAgICAgIGlmIG5vdCBmaXJzdF9zZXNzaW9uOgogICAgICAgICAgICBmYWNlc01lc3NhZ2VzID0gQ2RpVXRpbC5iZWFuKEZhY2VzTWVzc2FnZXMpCiAgICAgICAgICAgIGZhY2VzTWVzc2FnZXMuYWRkKEZhY2VzTWVzc2FnZS5TRVZFUklUWV9FUlJPUiwgIlBsZWFzZSwgZW5kIGFjdGl2ZSBzZXNzaW9uIGZpcnN0ISIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBwcmludCAiQXBwbGljYXRpb24gc2Vzc2lvbi4gRXh0ZXJuYWwgc2Vzc2lvbiBzdGFydGVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICMgQXBwbGljYXRpb24gY2FsbHMgaXQgYXQgZW5kIHNlc3Npb24gcmVxdWVzdCB0byBhbGxvdyBub3RpZnkgM3JkIHBhcnQgc3lzdGVtcwogICAgIyAgIGh0dHBSZXF1ZXN0IGlzIGphdmF4LnNlcnZsZXQuaHR0cC5IdHRwU2VydmxldFJlcXVlc3QKICAgICMgICBzZXNzaW9uSWQgaXMgb3JnLmdsdXUub3hhdXRoLm1vZGVsLmNvbW1vbi5TZXNzaW9uSWQKICAgICMgICBjb25maWd1cmF0aW9uQXR0cmlidXRlcyBpcyBqYXZhLnV0aWwuTWFwPFN0cmluZywgU2ltcGxlQ3VzdG9tUHJvcGVydHk+CiAgICBkZWYgZW5kU2Vzc2lvbihzZWxmLCBodHRwUmVxdWVzdCwgc2Vzc2lvbklkLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkFwcGxpY2F0aW9uIHNlc3Npb24uIFN0YXJ0aW5nIGV4dGVybmFsIHNlc3Npb24gZW5kIgoKICAgICAgICBwcmludCAiQXBwbGljYXRpb24gc2Vzc2lvbi4gRXh0ZXJuYWwgc2Vzc2lvbiBlbmRlZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgaXNGaXJzdFNlc3Npb24oc2VsZiwgdXNlcl9uYW1lKToKICAgICAgICB0b2tlbkxkYXAgPSBUb2tlbkxkYXAoKQogICAgICAgIHRva2VuTGRhcC5zZXREbihzZWxmLnN0YXRpY0NvbmZpZ3VyYXRpb24uZ2V0QmFzZURuKCkuZ2V0Q2xpZW50cygpKQogICAgICAgIHRva2VuTGRhcC5zZXRVc2VySWQodXNlcl9uYW1lKQoKICAgICAgICB0b2tlbkxkYXBMaXN0ID0gc2VsZi5lbnRyeU1hbmFnZXIuZmluZEVudHJpZXModG9rZW5MZGFwLCAxKQogICAgICAgIHByaW50ICJBcHBsaWNhdGlvbiBzZXNzaW9uLiBpc0ZpcnN0U2Vzc2lvbi4gR2V0IHJlc3VsdDogJyVzJyIgJSB0b2tlbkxkYXBMaXN0CgogICAgICAgIGlmICh0b2tlbkxkYXBMaXN0ICE9IE5vbmUpIGFuZCAodG9rZW5MZGFwTGlzdC5zaXplKCkgPiAwKToKICAgICAgICAgICAgcHJpbnQgIkFwcGxpY2F0aW9uIHNlc3Npb24uIGlzRmlyc3RTZXNzaW9uOiBGYWxzZSIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIHByaW50ICJBcHBsaWNhdGlvbiBzZXNzaW9uLiBpc0ZpcnN0U2Vzc2lvbjogVHJ1ZSIKICAgICAgICByZXR1cm4gVHJ1ZQo=
oxScriptType: application_session
programmingLanguage: python

dn: inum=DAA9-BA60,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Consent Gathering script
displayName: consent_gathering
oxEnabled: false
inum: DAA9-BA60
oxLevel: 10
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE3LCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlLmNkaS51dGlsIGltcG9ydCBDZGlVdGlsCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlY3VyaXR5IGltcG9ydCBJZGVudGl0eQpmcm9tIG9yZy5nbHV1Lm1vZGVsLmN1c3RvbS5zY3JpcHQudHlwZS5hdXRoeiBpbXBvcnQgQ29uc2VudEdhdGhlcmluZ1R5cGUKZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIKCmltcG9ydCBqYXZhCmltcG9ydCByYW5kb20KCmNsYXNzIENvbnNlbnRHYXRoZXJpbmcoQ29uc2VudEdhdGhlcmluZ1R5cGUpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6CiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkNvbnNlbnQtR2F0aGVyaW5nLiBJbml0aWFsaXppbmcgLi4uIgogICAgICAgIHByaW50ICJDb25zZW50LUdhdGhlcmluZy4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgoKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiQ29uc2VudC1HYXRoZXJpbmcuIERlc3Ryb3lpbmcgLi4uIgogICAgICAgIHByaW50ICJDb25zZW50LUdhdGhlcmluZy4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToKICAgICAgICByZXR1cm4gMQoKICAgICMgTWFpbiBjb25zZW50LWdhdGhlciBtZXRob2QuIE11c3QgcmV0dXJuIFRydWUgKGlmIGdhdGhlcmluZyBwZXJmb3JtZWQgc3VjY2Vzc2Z1bGx5KSBvciBGYWxzZSAoaWYgZmFpbCkuCiAgICAjIEFsbCB1c2VyIGVudGVyZWQgdmFsdWVzIGNhbiBiZSBhY2Nlc3MgdmlhIE1hcDxTdHJpbmcsIFN0cmluZz4gY29udGV4dC5nZXRQYWdlQXR0cmlidXRlcygpCiAgICBkZWYgYXV0aG9yaXplKHNlbGYsIHN0ZXAsIGNvbnRleHQpOiAjIGNvbnRleHQgaXMgcmVmZXJlbmNlIG9mIG9yZy5nbHV1Lm94YXV0aC5zZXJ2aWNlLmV4dGVybmFsLmNvbnRleHQuQ29uc2VudEdhdGhlcmluZ0NvbnRleHQKICAgICAgICBwcmludCAiQ29uc2VudC1HYXRoZXJpbmcuIEF1dGhvcml6aW5nLi4uIgoKICAgICAgICBpZiBzdGVwID09IDE6CiAgICAgICAgICAgIGFsbG93QnV0dG9uID0gY29udGV4dC5nZXRSZXF1ZXN0UGFyYW1ldGVycygpLmdldCgiYXV0aG9yaXplRm9ybTphbGxvd0J1dHRvbiIpCiAgICAgICAgICAgIGlmIChhbGxvd0J1dHRvbiAhPSBOb25lKSBhbmQgKGxlbihhbGxvd0J1dHRvbikgPiAwKToKICAgICAgICAgICAgICAgIHByaW50ICJDb25zZW50LUdhdGhlcmluZy4gQXV0aG9yaXphdGlvbiBzdWNjZXNzIGZvciBzdGVwIDEiCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgcHJpbnQgIkNvbnNlbnQtR2F0aGVyaW5nLiBBdXRob3JpemF0aW9uIGRlY2xpbmVkIGZvciBzdGVwIDEiCiAgICAgICAgZWxpZiBzdGVwID09IDI6CiAgICAgICAgICAgIGFsbG93QnV0dG9uID0gY29udGV4dC5nZXRSZXF1ZXN0UGFyYW1ldGVycygpLmdldCgiYXV0aG9yaXplRm9ybTphbGxvd0J1dHRvbiIpCiAgICAgICAgICAgIGlmIChhbGxvd0J1dHRvbiAhPSBOb25lKSBhbmQgKGxlbihhbGxvd0J1dHRvbikgPiAwKToKICAgICAgICAgICAgICAgIHByaW50ICJDb25zZW50LUdhdGhlcmluZy4gQXV0aG9yaXphdGlvbiBzdWNjZXNzIGZvciBzdGVwIDIiCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgcHJpbnQgIkNvbnNlbnQtR2F0aGVyaW5nLiBBdXRob3JpemF0aW9uIGRlY2xpbmVkIGZvciBzdGVwIDIiCgogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBnZXROZXh0U3RlcChzZWxmLCBzdGVwLCBjb250ZXh0KToKICAgICAgICByZXR1cm4gLTEKCiAgICBkZWYgcHJlcGFyZUZvclN0ZXAoc2VsZiwgc3RlcCwgY29udGV4dCk6CiAgICAgICAgaWYgbm90IGNvbnRleHQuaXNBdXRoZW50aWNhdGVkKCk6CiAgICAgICAgICAgIHByaW50ICJVc2VyIGlzIG5vdCBhdXRoZW50aWNhdGVkLiBBYm9ydGluZyBhdXRob3JpemF0aW9uIGZsb3cgLi4uIgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgaWYgc3RlcCA9PSAyOgogICAgICAgICAgICBwYWdlQXR0cmlidXRlcyA9IGNvbnRleHQuZ2V0UGFnZUF0dHJpYnV0ZXMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZW5lcmF0ZSByYW5kb20gY29uc2VudCBnYXRoZXJpbmcgcmVxdWVzdAogICAgICAgICAgICBjb25zZW50UmVxdWVzdCA9ICJSZXF1ZXN0ZWQgdHJhbnNhY3Rpb24gIyVzIGFwcHJvdmFsIGZvciB0aGUgYW1vdW50IG9mIHN1bSAkICVzLjAwIiAlICggcmFuZG9tLnJhbmRpbnQoMTAwMDAwLCAxMDAwMDAwKSwgcmFuZG9tLnJhbmRpbnQoMSwgMTAwKSApCiAgICAgICAgICAgIHBhZ2VBdHRyaWJ1dGVzLnB1dCgiY29uc2VudF9yZXF1ZXN0IiwgY29uc2VudFJlcXVlc3QpCiAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGdldFN0ZXBzQ291bnQoc2VsZiwgY29udGV4dCk6CiAgICAgICAgcmV0dXJuIDExCgogICAgZGVmIGdldFBhZ2VGb3JTdGVwKHNlbGYsIHN0ZXAsIGNvbnRleHQpOgogICAgICAgIGlmIHN0ZXAgPT0gMToKICAgICAgICAgICAgcmV0dXJuICIvYXV0aHovYXV0aG9yaXplLnhodG1sIgogICAgICAgIGVsaWYgc3RlcCA9PSAyOgogICAgICAgICAgICByZXR1cm4gIi9hdXRoei90cmFuc2FjdGlvbi54aHRtbCIKCiAgICAgICAgcmV0dXJuICIiCg==
oxScriptType: consent_gathering
programmingLanguage: python

dn: inum=8AF7.D82A,ou=scripts,o=gluu
objectClass: oxCustomScript
objectClass: top
displayName: persistence_extension
inum: 8AF7.D82A
oxEnabled: false
oxLevel: 100
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDIwLCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBvcmcuZ2x1dS5zZXJ2aWNlLmNkaS51dGlsIGltcG9ydCBDZGlVdGlsCmZyb20gb3JnLmdsdXUubW9kZWwuY3VzdG9tLnNjcmlwdC50eXBlLnBlcnNpc3RlbmNlIGltcG9ydCBQZXJzaXN0ZW5jZVR5cGUKZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIKZnJvbSBvcmcuZ2x1dS5wZXJzaXN0Lm9wZXJhdGlvbi5hdXRoIGltcG9ydCBQYXNzd29yZEVuY3J5cHRpb25IZWxwZXIKZnJvbSBvcmcuZ2x1dS5wZXJzaXN0Lm9wZXJhdGlvbi5hdXRoIGltcG9ydCBQYXNzd29yZEVuY3J5cHRpb25NZXRob2QKCmltcG9ydCBqYXZhCgpjbGFzcyBQZXJzaXN0ZW5jZUV4dGVuc2lvbihQZXJzaXN0ZW5jZVR5cGUpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjdXJyZW50VGltZU1pbGxpcyk6CiAgICAgICAgc2VsZi5jdXJyZW50VGltZU1pbGxpcyA9IGN1cnJlbnRUaW1lTWlsbGlzCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIlBlcnNpc3RlbmNlIGV4dGVuc2lvbi4gSW5pdGlhbGl6YXRpb24iCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIlBlcnNpc3RlbmNlIGV4dGVuc2lvbi4gRGVzdHJveSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxMQoKICAgIGRlZiBvbkFmdGVyQ3JlYXRlKHNlbGYsIGNvbnRleHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiUGVyc2lzdGVuY2UgZXh0ZW5zaW9uLiBNZXRob2Q6IG9uQWZ0ZXJDcmVhdGUiCgogICAgZGVmIG9uQWZ0ZXJEZXN0cm95KHNlbGYsIGNvbnRleHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiUGVyc2lzdGVuY2UgZXh0ZW5zaW9uLiBNZXRob2Q6IG9uQWZ0ZXJEZXN0cm95IgoKICAgIGRlZiBjcmVhdGVIYXNoZWRQYXNzd29yZChzZWxmLCBjcmVkZW50aWFsKToKICAgICAgICBwcmludCAiUGVyc2lzdGVuY2UgZXh0ZW5zaW9uLiBNZXRob2Q6IGNyZWF0ZUhhc2hlZFBhc3N3b3JkIgoKICAgICAgICBoYXNoZWRfcGFzc3dvcmQ9IFBhc3N3b3JkRW5jcnlwdGlvbkhlbHBlci5jcmVhdGVTdG9yYWdlUGFzc3dvcmQoY3JlZGVudGlhbCwgUGFzc3dvcmRFbmNyeXB0aW9uTWV0aG9kLkhBU0hfTUVUSE9EX1BLQ1M1UzIpCgogICAgICAgIHJldHVybiBoYXNoZWRfcGFzc3dvcmQKCiAgICBkZWYgY29tcGFyZUhhc2hlZFBhc3N3b3JkcyhzZWxmLCBjcmVkZW50aWFsLCBzdG9yZWRDcmVkZW50aWFsKToKICAgICAgICBwcmludCAiUGVyc2lzdGVuY2UgZXh0ZW5zaW9uLiBNZXRob2Q6IGNvbXBhcmVIYXNoZWRQYXNzd29yZHMiCiAgICAgICAgCiAgICAgICAgYXV0aF9yZXN1bHQgPSBQYXNzd29yZEVuY3J5cHRpb25IZWxwZXIuY29tcGFyZUNyZWRlbnRpYWxzKGNyZWRlbnRpYWwsIHN0b3JlZENyZWRlbnRpYWwpCgogICAgICAgIHJldHVybiBhdXRoX3Jlc3VsdCAK
oxScriptType: persistence_extension
programmingLanguage: python

dn: inum=8AF7.D82B,ou=scripts,o=gluu
objectClass: oxCustomScript
objectClass: top
displayName: idp
inum: 8AF7.D82B
oxEnabled: false
oxLevel: 100
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveFNoaWJib2xldGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDIwLCBHbHV1CiMKIyBBdXRob3I6IFl1cml5IE1vdmNoYW4KIwoKZnJvbSBvcmcuZ2x1dS5tb2RlbC5jdXN0b20uc2NyaXB0LnR5cGUuaWRwIGltcG9ydCBJZHBUeXBlCmZyb20gb3JnLmdsdXUudXRpbCBpbXBvcnQgU3RyaW5nSGVscGVyCmZyb20gb3JnLmdsdXUuaWRwLmV4dGVybmFsYXV0aCBpbXBvcnQgQXV0aGVudGljYXRlZE5hbWVUcmFuc2xhdG9yCmZyb20gbmV0LnNoaWJib2xldGguaWRwLmF1dGhuLnByaW5jaXBhbCBpbXBvcnQgVXNlcm5hbWVQcmluY2lwYWwsIElkUEF0dHJpYnV0ZVByaW5jaXBhbApmcm9tIG5ldC5zaGliYm9sZXRoLmlkcC5hdXRobiBpbXBvcnQgRXh0ZXJuYWxBdXRoZW50aWNhdGlvbgpmcm9tIG5ldC5zaGliYm9sZXRoLmlkcC5hdHRyaWJ1dGUgaW1wb3J0IElkUEF0dHJpYnV0ZSwgU3RyaW5nQXR0cmlidXRlVmFsdWUKZnJvbSBuZXQuc2hpYmJvbGV0aC5pZHAuYXV0aG4uY29udGV4dCBpbXBvcnQgQXV0aGVudGljYXRpb25Db250ZXh0LCBFeHRlcm5hbEF1dGhlbnRpY2F0aW9uQ29udGV4dApmcm9tIG5ldC5zaGliYm9sZXRoLmlkcC5hdHRyaWJ1dGUuY29udGV4dCBpbXBvcnQgQXR0cmlidXRlQ29udGV4dApmcm9tIGphdmF4LnNlY3VyaXR5LmF1dGggaW1wb3J0IFN1YmplY3QKZnJvbSBqYXZhLnV0aWwgaW1wb3J0IENvbGxlY3Rpb25zLCBIYXNoU2V0LCBBcnJheUxpc3QsIEFycmF5cwoKaW1wb3J0IGphdmEKCmNsYXNzIElkcEV4dGVuc2lvbihJZHBUeXBlKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwoKICAgIGRlZiBpbml0KHNlbGYsIGN1c3RvbVNjcmlwdCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJJZHAgZXh0ZW5zaW9uLiBJbml0aWFsaXphdGlvbiIKICAgICAgICAKICAgICAgICBzZWxmLmRlZmF1bHROYW1lVHJhbnNsYXRvciA9IEF1dGhlbnRpY2F0ZWROYW1lVHJhbnNsYXRvcigpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIklkcCBleHRlbnNpb24uIERlc3Ryb3kiCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToKICAgICAgICByZXR1cm4gMTEKCiAgICAjIFRyYW5zbGF0ZSBhdHRyaWJ1dGVzIGZyb20gdXNlciBwcm9maWxlCiAgICAjICAgY29udGV4dCBpcyBvcmcuZ2x1dS5pZHAuZXh0ZXJuYWxhdXRoLlRyYW5zbGF0ZUF0dHJpYnV0ZXNDb250ZXh0IChodHRwczovL2dpdGh1Yi5jb20vR2x1dUZlZGVyYXRpb24vc2hpYi1veGF1dGgtYXV0aG4zL2Jsb2IvbWFzdGVyL3NyYy9tYWluL2phdmEvb3JnL2dsdXUvaWRwL2V4dGVybmFsYXV0aC9UcmFuc2xhdGVBdHRyaWJ1dGVzQ29udGV4dC5qYXZhKQogICAgIyAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eT4KICAgIGRlZiB0cmFuc2xhdGVBdHRyaWJ1dGVzKHNlbGYsIGNvbnRleHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiSWRwIGV4dGVuc2lvbi4gTWV0aG9kOiB0cmFuc2xhdGVBdHRyaWJ1dGVzIgogICAgICAgIAogICAgICAgICMgUmV0dXJuIEZhbHNlIHRvIHVzZSBkZWZhdWx0IG1ldGhvZAogICAgICAgICNyZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICByZXF1ZXN0ID0gY29udGV4dC5nZXRSZXF1ZXN0KCkKICAgICAgICB1c2VyUHJvZmlsZSA9IGNvbnRleHQuZ2V0VXNlclByb2ZpbGUoKQogICAgICAgIHByaW5jaXBhbEF0dHJpYnV0ZXMgPSBzZWxmLmRlZmF1bHROYW1lVHJhbnNsYXRvci5wcm9kdWNlSWRwQXR0cmlidXRlUHJpbmNpcGFsKHVzZXJQcm9maWxlLmdldEF0dHJpYnV0ZXMoKSkKICAgICAgICBwcmludCAiSWRwIGV4dGVuc2lvbi4gQ29udmVydGVkIHVzZXIgcHJvZmlsZTogJyVzJyB0byBhdHRyaWJ1dGUgcHJpbmNpcGFsOiAnJXMnIiAlICh1c2VyUHJvZmlsZSwgcHJpbmNpcGFsQXR0cmlidXRlcykKCiAgICAgICAgaWYgbm90IHByaW5jaXBhbEF0dHJpYnV0ZXMuaXNFbXB0eSgpOgogICAgICAgICAgICBwcmludCAiSWRwIGV4dGVuc2lvbi4gRm91bmQgYXR0cmlidXRlcyBmcm9tIG94QXV0aC4gUHJvY2Vzc2luZy4uLiIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU3RhcnQ6IEN1c3RvbSBwYXJ0CiAgICAgICAgICAgICMgQWRkIGdpdmVuTmFtZSBhdHRyaWJ1dGUKICAgICAgICAgICAgZ2l2ZW5OYW1lQXR0cmlidXRlID0gSWRQQXR0cmlidXRlKCJveEVucm9sbG1lbnRDb2RlIikKICAgICAgICAgICAgZ2l2ZW5OYW1lQXR0cmlidXRlLnNldFZhbHVlcyhBcnJheUxpc3QoQXJyYXlzLmFzTGlzdChTdHJpbmdBdHRyaWJ1dGVWYWx1ZSgiRHVtbXkiKSkpKQogICAgICAgICAgICBwcmluY2lwYWxBdHRyaWJ1dGVzLmFkZChJZFBBdHRyaWJ1dGVQcmluY2lwYWwoZ2l2ZW5OYW1lQXR0cmlidXRlKSkKICAgICAgICAgICAgcHJpbnQgIklkcCBleHRlbnNpb24uIFVwZGF0ZWQgYXR0cmlidXRlIHByaW5jaXBhbDogJyVzJyIgJSBwcmluY2lwYWxBdHRyaWJ1dGVzCiAgICAgICAgICAgICMgRW5kOiBDdXN0b20gcGFydAoKICAgICAgICAgICAgcHJpbmNpcGFscyA9IEhhc2hTZXQoKQogICAgICAgICAgICBwcmluY2lwYWxzLmFkZEFsbChwcmluY2lwYWxBdHRyaWJ1dGVzKQogICAgICAgICAgICBwcmluY2lwYWxzLmFkZChVc2VybmFtZVByaW5jaXBhbCh1c2VyUHJvZmlsZS5nZXRJZCgpKSkKCiAgICAgICAgICAgIHJlcXVlc3Quc2V0QXR0cmlidXRlKEV4dGVybmFsQXV0aGVudGljYXRpb24uU1VCSkVDVF9LRVksIFN1YmplY3QoRmFsc2UsIENvbGxlY3Rpb25zLnNpbmdsZXRvbihwcmluY2lwYWxzKSwKICAgICAgICAgICAgICAgIENvbGxlY3Rpb25zLmVtcHR5U2V0KCksIENvbGxlY3Rpb25zLmVtcHR5U2V0KCkpKQoKICAgICAgICAgICAgcHJpbnQgIkNyZWF0ZWQgYW4gSWRQIHN1YmplY3QgaW5zdGFuY2Ugd2l0aCBwcmluY2lwYWxzIGNvbnRhaW5pbmcgYXR0cmlidXRlcyBmb3I6ICclcyciICUgdXNlclByb2ZpbGUuZ2V0SWQoKQoKICAgICAgICAgICAgaWYgRmFsc2U6CiAgICAgICAgICAgICAgICBpZHBBdHRyaWJ1dGVzID0gQXJyYXlMaXN0KCkKICAgICAgICAgICAgICAgIGZvciBwcmluY2lwYWxBdHRyaWJ1dGUgaW4gcHJpbmNpcGFsQXR0cmlidXRlczoKICAgICAgICAgICAgICAgICAgICBpZHBBdHRyaWJ1dGVzLmFkZChwcmluY2lwYWxBdHRyaWJ1dGUuZ2V0QXR0cmlidXRlKCkpCiAgICAKICAgICAgICAgICAgICAgIHJlcXVlc3Quc2V0QXR0cmlidXRlKEV4dGVybmFsQXV0aGVudGljYXRpb24uQVRUUklCVVRFU19LRVksIGlkcEF0dHJpYnV0ZXMpCiAgICAKICAgICAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uS2V5ID0gY29udGV4dC5nZXRBdXRoZW50aWNhdGlvbktleSgpCiAgICAgICAgICAgICAgICBwcm9maWxlUmVxdWVzdENvbnRleHQgPSBFeHRlcm5hbEF1dGhlbnRpY2F0aW9uLmdldFByb2ZpbGVSZXF1ZXN0Q29udGV4dChhdXRoZW50aWNhdGlvbktleSwgcmVxdWVzdCkKICAgICAgICAgICAgICAgIGF1dGhDb250ZXh0ID0gcHJvZmlsZVJlcXVlc3RDb250ZXh0LmdldFN1YmNvbnRleHQoQXV0aGVudGljYXRpb25Db250ZXh0KQogICAgICAgICAgICAgICAgZXh0Q29udGV4dCA9IGF1dGhDb250ZXh0LmdldFN1YmNvbnRleHQoRXh0ZXJuYWxBdXRoZW50aWNhdGlvbkNvbnRleHQpCiAgICAKICAgICAgICAgICAgICAgIGV4dENvbnRleHQuc2V0U3ViamVjdChTdWJqZWN0KEZhbHNlLCBDb2xsZWN0aW9ucy5zaW5nbGV0b24ocHJpbmNpcGFscyksIENvbGxlY3Rpb25zLmVtcHR5U2V0KCksIENvbGxlY3Rpb25zLmVtcHR5U2V0KCkpKTsKICAgIAogICAgICAgICAgICAgICAgZXh0Q29udGV4dC5nZXRTdWJjb250ZXh0KEF0dHJpYnV0ZUNvbnRleHQsIFRydWUpLnNldFVuZmlsdGVyZWRJZFBBdHRyaWJ1dGVzKGlkcEF0dHJpYnV0ZXMpCiAgICAgICAgICAgICAgICBleHRDb250ZXh0LmdldFN1YmNvbnRleHQoQXR0cmlidXRlQ29udGV4dCkuc2V0SWRQQXR0cmlidXRlcyhpZHBBdHRyaWJ1dGVzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50ICJObyBhdHRyaWJ1dGVzIHJlbGVhc2VkIGZyb20gb3hBdXRoLiBDcmVhdGluZyBhbiBJZFAgcHJpbmNpcGFsIGZvcjogJyVzJyIgJSB1c2VyUHJvZmlsZS5nZXRJZCgpCiAgICAgICAgICAgIHJlcXVlc3Quc2V0QXR0cmlidXRlKEV4dGVybmFsQXV0aGVudGljYXRpb24uUFJJTkNJUEFMX05BTUVfS0VZLCB1c2VyUHJvZmlsZS5nZXRJZCgpKQoKICAgICAgICAjUmV0dXJuIFRydWUgdG8gc3BlY2lmeSB0aGF0IGRlZmF1bHQgbWV0aG9kIGlzIG5vdCBuZWVkZWQKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAjIFVwZGF0ZSBhdHRyaWJ1dGVzIGJlZm9yZSByZWxlYXNpbmcgdGhlbQogICAgIyAgIGNvbnRleHQgaXMgb3JnLmdsdXUuaWRwLmNvbnNlbnQucHJvY2Vzc29yLlBvc3RQcm9jZXNzQXR0cmlidXRlc0NvbnRleHQgKGh0dHBzOi8vZ2l0aHViLmNvbS9HbHV1RmVkZXJhdGlvbi9zaGliLW94YXV0aC1hdXRobjMvYmxvYi9tYXN0ZXIvc3JjL21haW4vamF2YS9vcmcvZ2x1dS9pZHAvY29uc2VudC9wcm9jZXNzb3IvUG9zdFByb2Nlc3NBdHRyaWJ1dGVzQ29udGV4dC5qYXZhKQogICAgIyAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eT4KICAgIGRlZiB1cGRhdGVBdHRyaWJ1dGVzKHNlbGYsIGNvbnRleHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiSWRwIGV4dGVuc2lvbi4gTWV0aG9kOiB1cGRhdGVBdHRyaWJ1dGVzIgogICAgICAgIHJldHVybiBUcnVlCg==
oxScriptType: idp
programmingLanguage: python

dn: inum=C1BA-C1BA,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Firebase notification sender
displayName: firebase_ciba_end_user_notification
oxEnabled: false
inum: C1BA-C1BA
oxLevel: 10
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE4LCBHbHV1CiMKIyBBdXRob3I6IE1pbHRvbiBCTwojCiMKCmZyb20gb3JnLmdsdXUub3hhdXRoLmNsaWVudC5mY20gaW1wb3J0IEZpcmViYXNlQ2xvdWRNZXNzYWdpbmdSZXNwb25zZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC5jbGllbnQuZmNtIGltcG9ydCBGaXJlYmFzZUNsb3VkTWVzc2FnaW5nQ2xpZW50CmZyb20gb3JnLmdsdXUub3hhdXRoLmNsaWVudC5mY20gaW1wb3J0IEZpcmViYXNlQ2xvdWRNZXNzYWdpbmdSZXF1ZXN0CmZyb20gb3JnLmdsdXUub3hhdXRoLnV0aWwgaW1wb3J0IFJlZGlyZWN0VXJpCmZyb20gb3JnLmdsdXUubW9kZWwuY3VzdG9tLnNjcmlwdC50eXBlLmNpYmEgaW1wb3J0IEVuZFVzZXJOb3RpZmljYXRpb25UeXBlCmZyb20gamF2YS5sYW5nIGltcG9ydCBTdHJpbmcKZnJvbSBqYXZhLnV0aWwgaW1wb3J0IFVVSUQKCmNsYXNzIEVuZFVzZXJOb3RpZmljYXRpb24oRW5kVXNlck5vdGlmaWNhdGlvblR5cGUpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGN1cnJlbnRUaW1lTWlsbGlzKToKICAgICAgICBzZWxmLmN1cnJlbnRUaW1lTWlsbGlzID0gY3VycmVudFRpbWVNaWxsaXMKCiAgICBkZWYgaW5pdChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkZpcmViYXNlIEVuZFVzZXJOb3RpZmljYXRpb24gc2NyaXB0LiBJbml0aWFsaXppbmcgLi4uIgogICAgICAgIHByaW50ICJGaXJlYmFzZSBFbmRVc2VyTm90aWZpY2F0aW9uIHNjcmlwdC4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgoKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiRmlyZWJhc2UgRW5kVXNlck5vdGlmaWNhdGlvbiBzY3JpcHQuIERlc3Ryb3lpbmcgLi4uIgogICAgICAgIHByaW50ICJGaXJlYmFzZSBFbmRVc2VyTm90aWZpY2F0aW9uIHNjcmlwdC4gRGVzdHJveWVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBnZXRBcGlWZXJzaW9uKHNlbGYpOgogICAgICAgIHJldHVybiAxCgogICAgIyBSZXR1cm5zIGJvb2xlYW4gdHJ1ZSBvciBmYWxzZSBkZXBlbmRpbmcgb24gdGhlIHByb2Nlc3MsIGlmIHRoZSBub3RpZmljYXRpb24KICAgICMgaXMgc2VudCBzdWNjZXNzZnVsbHkgb3Igbm90LgogICAgZGVmIG5vdGlmeUVuZFVzZXIoc2VsZiwgY29udGV4dCk6CiAgICAgICAgcHJpbnQgJ1NlbmRpbmcgcHVzaCBub3RpZmljYXRpb24gdXNpbmcgRmlyZWJhc2UgQ2xvdWQgTWVzc2FnaW5nJwogICAgICAgIGFwcENvbmZpZ3VyYXRpb24gPSBjb250ZXh0LmdldEFwcENvbmZpZ3VyYXRpb24oKQogICAgICAgIGVuY3J5cHRpb25TZXJ2aWNlID0gY29udGV4dC5nZXRFbmNyeXB0aW9uU2VydmljZSgpCiAgICAgICAgY2xpZW50SWQgPSBhcHBDb25maWd1cmF0aW9uLmdldEJhY2tjaGFubmVsQ2xpZW50SWQoKQogICAgICAgIHJlZGlyZWN0VXJpID0gYXBwQ29uZmlndXJhdGlvbi5nZXRCYWNrY2hhbm5lbFJlZGlyZWN0VXJpKCkKICAgICAgICB1cmwgPSBhcHBDb25maWd1cmF0aW9uLmdldENpYmFFbmRVc2VyTm90aWZpY2F0aW9uQ29uZmlnKCkuZ2V0Tm90aWZpY2F0aW9uVXJsKCkKICAgICAgICBrZXkgPSBlbmNyeXB0aW9uU2VydmljZS5kZWNyeXB0KGFwcENvbmZpZ3VyYXRpb24uZ2V0Q2liYUVuZFVzZXJOb3RpZmljYXRpb25Db25maWcoKS5nZXROb3RpZmljYXRpb25LZXkoKSwgVHJ1ZSkKICAgICAgICB0byA9IGNvbnRleHQuZ2V0RGV2aWNlUmVnaXN0cmF0aW9uVG9rZW4oKQogICAgICAgIHRpdGxlID0gIm94QXV0aCBBdXRoZW50aWNhdGlvbiBSZXF1ZXN0IgogICAgICAgIGJvZHkgPSAiQ2xpZW50IEluaXRpYXRlZCBCYWNrY2hhbm5lbCBBdXRoZW50aWNhdGlvbiAoQ0lCQSkiCgogICAgICAgIGF1dGhvcml6YXRpb25SZXF1ZXN0VXJpID0gUmVkaXJlY3RVcmkoYXBwQ29uZmlndXJhdGlvbi5nZXRBdXRob3JpemF0aW9uRW5kcG9pbnQoKSkKICAgICAgICBhdXRob3JpemF0aW9uUmVxdWVzdFVyaS5hZGRSZXNwb25zZVBhcmFtZXRlcigiY2xpZW50X2lkIiwgY2xpZW50SWQpCiAgICAgICAgYXV0aG9yaXphdGlvblJlcXVlc3RVcmkuYWRkUmVzcG9uc2VQYXJhbWV0ZXIoInJlc3BvbnNlX3R5cGUiLCAiaWRfdG9rZW4iKQogICAgICAgIGF1dGhvcml6YXRpb25SZXF1ZXN0VXJpLmFkZFJlc3BvbnNlUGFyYW1ldGVyKCJzY29wZSIsIGNvbnRleHQuZ2V0U2NvcGUoKSkKICAgICAgICBhdXRob3JpemF0aW9uUmVxdWVzdFVyaS5hZGRSZXNwb25zZVBhcmFtZXRlcigiYWNyX3ZhbHVlcyIsIGNvbnRleHQuZ2V0QWNyVmFsdWVzKCkpCiAgICAgICAgYXV0aG9yaXphdGlvblJlcXVlc3RVcmkuYWRkUmVzcG9uc2VQYXJhbWV0ZXIoInJlZGlyZWN0X3VyaSIsIHJlZGlyZWN0VXJpKQogICAgICAgIGF1dGhvcml6YXRpb25SZXF1ZXN0VXJpLmFkZFJlc3BvbnNlUGFyYW1ldGVyKCJzdGF0ZSIsIFVVSUQucmFuZG9tVVVJRCgpLnRvU3RyaW5nKCkpCiAgICAgICAgYXV0aG9yaXphdGlvblJlcXVlc3RVcmkuYWRkUmVzcG9uc2VQYXJhbWV0ZXIoIm5vbmNlIiwgVVVJRC5yYW5kb21VVUlEKCkudG9TdHJpbmcoKSkKICAgICAgICBhdXRob3JpemF0aW9uUmVxdWVzdFVyaS5hZGRSZXNwb25zZVBhcmFtZXRlcigicHJvbXB0IiwgImNvbnNlbnQiKQogICAgICAgIGF1dGhvcml6YXRpb25SZXF1ZXN0VXJpLmFkZFJlc3BvbnNlUGFyYW1ldGVyKCJhdXRoX3JlcV9pZCIsIGNvbnRleHQuZ2V0QXV0aFJlcUlkKCkpCgogICAgICAgIGNsaWNrQWN0aW9uID0gYXV0aG9yaXphdGlvblJlcXVlc3RVcmkudG9TdHJpbmcoKQoKICAgICAgICBmaXJlYmFzZUNsb3VkTWVzc2FnaW5nUmVxdWVzdCA9IEZpcmViYXNlQ2xvdWRNZXNzYWdpbmdSZXF1ZXN0KGtleSwgdG8sIHRpdGxlLCBib2R5LCBjbGlja0FjdGlvbikKICAgICAgICBmaXJlYmFzZUNsb3VkTWVzc2FnaW5nQ2xpZW50ID0gRmlyZWJhc2VDbG91ZE1lc3NhZ2luZ0NsaWVudCh1cmwpCiAgICAgICAgZmlyZWJhc2VDbG91ZE1lc3NhZ2luZ0NsaWVudC5zZXRSZXF1ZXN0KGZpcmViYXNlQ2xvdWRNZXNzYWdpbmdSZXF1ZXN0KQogICAgICAgIGZpcmViYXNlQ2xvdWRNZXNzYWdpbmdSZXNwb25zZSA9IGZpcmViYXNlQ2xvdWRNZXNzYWdpbmdDbGllbnQuZXhlYygpCgogICAgICAgIHJlc3BvbnNlU3RhdHVzID0gZmlyZWJhc2VDbG91ZE1lc3NhZ2luZ1Jlc3BvbnNlLmdldFN0YXR1cygpCiAgICAgICAgcHJpbnQgIkNJQkE6IGZpcmViYXNlIGNsb3VkIG1lc3NhZ2luZyByZXN1bHQgc3RhdHVzICIgKyBzdHIocmVzcG9uc2VTdGF0dXMpCiAgICAgICAgcmV0dXJuIChyZXNwb25zZVN0YXR1cyA+PSAyMDAgYW5kIHJlc3BvbnNlU3RhdHVzIDwgMzAwICkKCg==
oxScriptType: ciba_end_user_notification
programmingLanguage: python

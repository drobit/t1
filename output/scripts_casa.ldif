dn: inum=BABA-CACA,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Authentication script for Gluu Casa
displayName: casa
oxEnabled: true
inum: BABA-CACA
oxConfigurationProperty: {"value1":"supergluu_app_id","value2":"https://instance-1.us-central1-a.c.nifty-canyon-287111.internal/casa","description":""}
oxConfigurationProperty: {"value1":"u2f_app_id","value2":"https://instance-1.us-central1-a.c.nifty-canyon-287111.internal","description":""}
oxConfigurationProperty: {"value1":"mobile_methods","value2":"otp, twilio_sms, super_gluu","description":""}
oxLevel: 1
oxModuleProperty: {"value1":"usage_type","value2":"interactive","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBBdXRob3I6IEpvc2UgR29uemFsZXoKCmZyb20gamF2YS51dGlsIGltcG9ydCBDb2xsZWN0aW9ucywgSGFzaE1hcCwgSGFzaFNldCwgQXJyYXlMaXN0LCBBcnJheXMsIERhdGUKZnJvbSBqYXZhLm5pby5jaGFyc2V0IGltcG9ydCBDaGFyc2V0Cgpmcm9tIG9yZy5hcGFjaGUuaHR0cC5wYXJhbXMgaW1wb3J0IENvcmVDb25uZWN0aW9uUE5hbWVzCgpmcm9tIG9yZy5veGF1dGgucGVyc2lzdGVuY2UubW9kZWwuY29uZmlndXJhdGlvbiBpbXBvcnQgR2x1dUNvbmZpZ3VyYXRpb24KZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VjdXJpdHkgaW1wb3J0IElkZW50aXR5CmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UgaW1wb3J0IEF1dGhlbnRpY2F0aW9uU2VydmljZSwgVXNlclNlcnZpY2UKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZS5jb21tb24gaW1wb3J0IEVuY3J5cHRpb25TZXJ2aWNlCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UuY3VzdG9tIGltcG9ydCBDdXN0b21TY3JpcHRTZXJ2aWNlCmZyb20gb3JnLmdsdXUub3hhdXRoLnNlcnZpY2UubmV0IGltcG9ydCBIdHRwU2VydmljZQpmcm9tIG9yZy5nbHV1Lm94YXV0aC51dGlsIGltcG9ydCBTZXJ2ZXJVdGlsCmZyb20gb3JnLmdsdXUubW9kZWwgaW1wb3J0IFNpbXBsZUN1c3RvbVByb3BlcnR5CmZyb20gb3JnLmdsdXUubW9kZWwuY2FzYSBpbXBvcnQgQXBwbGljYXRpb25Db25maWd1cmF0aW9uCmZyb20gb3JnLmdsdXUubW9kZWwuY3VzdG9tLnNjcmlwdCBpbXBvcnQgQ3VzdG9tU2NyaXB0VHlwZQpmcm9tIG9yZy5nbHV1Lm1vZGVsLmN1c3RvbS5zY3JpcHQudHlwZS5hdXRoIGltcG9ydCBQZXJzb25BdXRoZW50aWNhdGlvblR5cGUKZnJvbSBvcmcuZ2x1dS5wZXJzaXN0IGltcG9ydCBQZXJzaXN0ZW5jZUVudHJ5TWFuYWdlcgpmcm9tIG9yZy5nbHV1LnNlcnZpY2UgaW1wb3J0IENhY2hlU2VydmljZQpmcm9tIG9yZy5nbHV1LnNlcnZpY2UuY2RpLnV0aWwgaW1wb3J0IENkaVV0aWwKZnJvbSBvcmcuZ2x1dS51dGlsIGltcG9ydCBTdHJpbmdIZWxwZXIKCnRyeToKICAgIGltcG9ydCBqc29uCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGltcG9ydCBzaW1wbGVqc29uIGFzIGpzb24KaW1wb3J0IHN5cwoKY2xhc3MgUGVyc29uQXV0aGVudGljYXRpb24oUGVyc29uQXV0aGVudGljYXRpb25UeXBlKToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgY3VycmVudFRpbWVNaWxsaXMpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWVNaWxsaXMgPSBjdXJyZW50VGltZU1pbGxpcwogICAgICAgIHNlbGYuQUNSX1NHID0gInN1cGVyX2dsdXUiCiAgICAgICAgc2VsZi5BQ1JfVTJGID0gInUyZiIKCiAgICAgICAgc2VsZi5tb2R1bGVQcmVmaXggPSAiY2FzYS1leHRlcm5hbF8iCgogICAgZGVmIGluaXQoc2VsZiwgY3VzdG9tU2NyaXB0LCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CgogICAgICAgIHByaW50ICJDYXNhLiBpbml0IGNhbGxlZCIKICAgICAgICBzZWxmLmF1dGhlbnRpY2F0b3JzID0ge30KICAgICAgICBzZWxmLnVpZF9hdHRyID0gc2VsZi5nZXRMb2NhbFByaW1hcnlLZXkoKQoKICAgICAgICBjdXN0U2NyaXB0U2VydmljZSA9IENkaVV0aWwuYmVhbihDdXN0b21TY3JpcHRTZXJ2aWNlKQogICAgICAgIHNlbGYuc2NyaXB0c0xpc3QgPSBjdXN0U2NyaXB0U2VydmljZS5maW5kQ3VzdG9tU2NyaXB0cyhDb2xsZWN0aW9ucy5zaW5nbGV0b25MaXN0KEN1c3RvbVNjcmlwdFR5cGUuUEVSU09OX0FVVEhFTlRJQ0FUSU9OKSwgIm94Q29uZmlndXJhdGlvblByb3BlcnR5IiwgImRpc3BsYXlOYW1lIiwgIm94RW5hYmxlZCIsICJveExldmVsIikKICAgICAgICBkeW5hbWljTWV0aG9kcyA9IHNlbGYuY29tcHV0ZU1ldGhvZHMoc2VsZi5zY3JpcHRzTGlzdCkKCiAgICAgICAgaWYgbGVuKGR5bmFtaWNNZXRob2RzKSA+IDA6CiAgICAgICAgICAgIHByaW50ICJDYXNhLiBpbml0LiBMb2FkaW5nIHNjcmlwdHMgZm9yIGR5bmFtaWMgbW9kdWxlczogJXMiICUgZHluYW1pY01ldGhvZHMKCiAgICAgICAgICAgIGZvciBhY3IgaW4gZHluYW1pY01ldGhvZHM6CiAgICAgICAgICAgICAgICBtb2R1bGVOYW1lID0gc2VsZi5tb2R1bGVQcmVmaXggKyBhY3IKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBleHRlcm5hbCA9IF9faW1wb3J0X18obW9kdWxlTmFtZSwgZ2xvYmFscygpLCBsb2NhbHMoKSwgWyJQZXJzb25BdXRoZW50aWNhdGlvbiJdLCAtMSkKICAgICAgICAgICAgICAgICAgICBtb2R1bGUgPSBleHRlcm5hbC5QZXJzb25BdXRoZW50aWNhdGlvbihzZWxmLmN1cnJlbnRUaW1lTWlsbGlzKQoKICAgICAgICAgICAgICAgICAgICBwcmludCAiQ2FzYS4gaW5pdC4gR290IGR5bmFtaWMgbW9kdWxlIGZvciBhY3IgJXMiICUgYWNyCiAgICAgICAgICAgICAgICAgICAgY29uZmlnQXR0cnMgPSBzZWxmLmdldENvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKGFjciwgc2VsZi5zY3JpcHRzTGlzdCkKCiAgICAgICAgICAgICAgICAgICAgaWYgYWNyID09IHNlbGYuQUNSX1UyRjoKICAgICAgICAgICAgICAgICAgICAgICAgdTJmX2FwcGxpY2F0aW9uX2lkID0gY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuZ2V0KCJ1MmZfYXBwX2lkIikuZ2V0VmFsdWUyKCkKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnQXR0cnMucHV0KCJ1MmZfYXBwbGljYXRpb25faWQiLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eSgidTJmX2FwcGxpY2F0aW9uX2lkIiwgdTJmX2FwcGxpY2F0aW9uX2lkKSkKICAgICAgICAgICAgICAgICAgICBlbGlmIGFjciA9PSBzZWxmLkFDUl9TRzoKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb25faWQgPSBjb25maWd1cmF0aW9uQXR0cmlidXRlcy5nZXQoInN1cGVyZ2x1dV9hcHBfaWQiKS5nZXRWYWx1ZTIoKQogICAgICAgICAgICAgICAgICAgICAgICBjb25maWdBdHRycy5wdXQoImFwcGxpY2F0aW9uX2lkIiwgU2ltcGxlQ3VzdG9tUHJvcGVydHkoImFwcGxpY2F0aW9uX2lkIiwgYXBwbGljYXRpb25faWQpKQoKICAgICAgICAgICAgICAgICAgICBpZiBtb2R1bGUuaW5pdChOb25lLCBjb25maWdBdHRycyk6CiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZS5jb25maWdBdHRycyA9IGNvbmZpZ0F0dHJzCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYXV0aGVudGljYXRvcnNbYWNyXSA9IG1vZHVsZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ICJDYXNhLiBpbml0LiBDYWxsIHRvIGluaXQgaW4gbW9kdWxlICclcycgcmV0dXJuZWQgRmFsc2UiICUgbW9kdWxlTmFtZQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHByaW50ICJDYXNhLiBpbml0LiBGYWlsZWQgdG8gbG9hZCBtb2R1bGUgJXMiICUgbW9kdWxlTmFtZQogICAgICAgICAgICAgICAgICAgIHByaW50ICJFeGNlcHRpb246ICIsIHN5cy5leGNfaW5mbygpWzFdCgogICAgICAgICAgICBtb2JpbGVfbWV0aG9kcyA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgibW9iaWxlX21ldGhvZHMiKQogICAgICAgICAgICBzZWxmLm1vYmlsZV9tZXRob2RzID0gW10gaWYgbW9iaWxlX21ldGhvZHMgPT0gTm9uZSBlbHNlIFN0cmluZ0hlbHBlci5zcGxpdChtb2JpbGVfbWV0aG9kcy5nZXRWYWx1ZTIoKSwgIiwiKQoKICAgICAgICBwcmludCAiQ2FzYS4gaW5pdC4gSW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIHJldHVybiBUcnVlCgoKICAgIGRlZiBkZXN0cm95KHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiQ2FzYS4gRGVzdHJveWVkIGNhbGxlZCIKICAgICAgICByZXR1cm4gVHJ1ZQoKCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToKICAgICAgICByZXR1cm4gMTEKCgogICAgZGVmIGdldEF1dGhlbnRpY2F0aW9uTWV0aG9kQ2xhaW1zKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICByZXR1cm4gTm9uZQoKCiAgICBkZWYgaXNWYWxpZEF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHByaW50ICJDYXNhLiBpc1ZhbGlkQXV0aGVudGljYXRpb25NZXRob2QgY2FsbGVkIgogICAgICAgIHJldHVybiBUcnVlCgoKICAgIGRlZiBnZXRBbHRlcm5hdGl2ZUF1dGhlbnRpY2F0aW9uTWV0aG9kKHNlbGYsIHVzYWdlVHlwZSwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgogICAgICAgIHJldHVybiBOb25lCgoKICAgIGRlZiBhdXRoZW50aWNhdGUoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKICAgICAgICBwcmludCAiQ2FzYS4gYXV0aGVudGljYXRlIGZvciBzdGVwICVzIiAlIHN0cihzdGVwKQoKICAgICAgICB1c2VyU2VydmljZSA9IENkaVV0aWwuYmVhbihVc2VyU2VydmljZSkKICAgICAgICBhdXRoZW50aWNhdGlvblNlcnZpY2UgPSBDZGlVdGlsLmJlYW4oQXV0aGVudGljYXRpb25TZXJ2aWNlKQogICAgICAgIGlkZW50aXR5ID0gQ2RpVXRpbC5iZWFuKElkZW50aXR5KQoKICAgICAgICBpZiBzdGVwID09IDE6CiAgICAgICAgICAgIGNyZWRlbnRpYWxzID0gaWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHMoKQogICAgICAgICAgICB1c2VyX25hbWUgPSBjcmVkZW50aWFscy5nZXRVc2VybmFtZSgpCiAgICAgICAgICAgIHVzZXJfcGFzc3dvcmQgPSBjcmVkZW50aWFscy5nZXRQYXNzd29yZCgpCgogICAgICAgICAgICBpZiBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eVN0cmluZyh1c2VyX25hbWUpIGFuZCBTdHJpbmdIZWxwZXIuaXNOb3RFbXB0eVN0cmluZyh1c2VyX3Bhc3N3b3JkKToKCiAgICAgICAgICAgICAgICBmb3VuZFVzZXIgPSB1c2VyU2VydmljZS5nZXRVc2VyQnlBdHRyaWJ1dGUoc2VsZi51aWRfYXR0ciwgdXNlcl9uYW1lKQogICAgICAgICAgICAgICAgI2ZvdW5kVXNlciA9IHVzZXJTZXJ2aWNlLmdldFVzZXIodXNlcl9uYW1lKQogICAgICAgICAgICAgICAgaWYgZm91bmRVc2VyID09IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkNhc2EuIGF1dGhlbnRpY2F0ZSBmb3Igc3RlcCAxLiBVbmtub3duIHVzZXJuYW1lIgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBwbGF0Zm9ybV9kYXRhID0gc2VsZi5wYXJzZVBsYXRmb3JtRGF0YShyZXF1ZXN0UGFyYW1ldGVycykKICAgICAgICAgICAgICAgICAgICBtZmFPZmYgPSBmb3VuZFVzZXIuZ2V0QXR0cmlidXRlKCJveFByZWZlcnJlZE1ldGhvZCIpID09IE5vbmUKICAgICAgICAgICAgICAgICAgICBsb2dnZWRfaW4gPSBGYWxzZQoKICAgICAgICAgICAgICAgICAgICBpZiBtZmFPZmY6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlZF9pbiA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5hdXRoZW50aWNhdGUodXNlcl9uYW1lLCB1c2VyX3Bhc3N3b3JkKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGFjciA9IHNlbGYuZ2V0U3VpdGFibGVBY3IoZm91bmRVc2VyLCBwbGF0Zm9ybV9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBhY3IgIT0gTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IHNlbGYuYXV0aGVudGljYXRvcnNbYWNyXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VkX2luID0gbW9kdWxlLmF1dGhlbnRpY2F0ZShtb2R1bGUuY29uZmlnQXR0cnMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKQoKICAgICAgICAgICAgICAgICAgICBpZiBsb2dnZWRfaW46CiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kVXNlciA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpCgogICAgICAgICAgICAgICAgICAgICAgICBpZiBmb3VuZFVzZXIgPT0gTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ICJDYXNhLiBhdXRoZW50aWNhdGUgZm9yIHN0ZXAgMS4gQ2Fubm90IHJldHJpZXZlIGxvZ2dlZCB1c2VyIgogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbWZhT2ZmOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInNraXAyRkEiLCBUcnVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjRGV0ZXJtaW5lIHdoZXRoZXIgdG8gc2tpcCAyRkEgYmFzZWQgb24gcG9saWN5IGRlZmluZWQgKGdsb2JhbCBvciB1c2VyIGN1c3RvbSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lwMkZBID0gc2VsZi5kZXRlcm1pbmVTa2lwMkZBKHVzZXJTZXJ2aWNlLCBpZGVudGl0eSwgZm91bmRVc2VyLCBwbGF0Zm9ybV9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoInNraXAyRkEiLCBza2lwMkZBKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoIkFDUiIsIGFjcikKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCAiQ2FzYS4gYXV0aGVudGljYXRlIGZvciBzdGVwIDEgd2FzIG5vdCBzdWNjZXNzZnVsIgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdXNlciA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpCiAgICAgICAgICAgIGlmIHVzZXIgPT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJDYXNhLiBhdXRoZW50aWNhdGUgZm9yIHN0ZXAgMi4gQ2Fubm90IHJldHJpZXZlIGxvZ2dlZCB1c2VyIgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICAjc2VlIGNhc2EueGh0bWwKICAgICAgICAgICAgYWx0ZXIgPSBTZXJ2ZXJVdGlsLmdldEZpcnN0VmFsdWUocmVxdWVzdFBhcmFtZXRlcnMsICJhbHRlcm5hdGl2ZU1ldGhvZCIpCiAgICAgICAgICAgIGlmIGFsdGVyICE9IE5vbmU6CiAgICAgICAgICAgICAgICAjYnlwYXNzIHRoZSByZXN0IG9mIHRoaXMgc3RlcCBpZiBhbiBhbHRlcm5hdGl2ZSBtZXRob2Qgd2FzIHByb3ZpZGVkLiBDdXJyZW50IHN0ZXAgd2lsbCBiZSByZXRyaWVkIChzZWUgZ2V0TmV4dFN0ZXApCiAgICAgICAgICAgICAgICBzZWxmLnNpbXVsYXRlRmlyc3RTdGVwKHJlcXVlc3RQYXJhbWV0ZXJzLCBhbHRlcikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgICAgICBzZXNzaW9uX2F0dHJpYnV0ZXMgPSBpZGVudGl0eS5nZXRTZXNzaW9uSWQoKS5nZXRTZXNzaW9uQXR0cmlidXRlcygpCiAgICAgICAgICAgIGFjciA9IHNlc3Npb25fYXR0cmlidXRlcy5nZXQoIkFDUiIpCiAgICAgICAgICAgICN0aGlzIHdvcmtpbmcgcGFyYW1ldGVyIGlzIHVzZWQgaW4gY2FzYS54aHRtbAogICAgICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJtZXRob2RzIiwgQXJyYXlMaXN0KHNlbGYuZ2V0QXZhaWxNZXRob2RzVXNlcih1c2VyLCBhY3IpKSkKCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBGYWxzZQogICAgICAgICAgICBpZiBhY3IgaW4gc2VsZi5hdXRoZW50aWNhdG9yczoKICAgICAgICAgICAgICAgIG1vZHVsZSA9IHNlbGYuYXV0aGVudGljYXRvcnNbYWNyXQogICAgICAgICAgICAgICAgc3VjY2VzcyA9IG1vZHVsZS5hdXRoZW50aWNhdGUobW9kdWxlLmNvbmZpZ0F0dHJzLCByZXF1ZXN0UGFyYW1ldGVycywgc3RlcCkKCiAgICAgICAgICAgICNVcGRhdGUgdGhlIGxpc3Qgb2YgdHJ1c3RlZCBkZXZpY2VzIGlmIDJmYSBwYXNzZWQKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIHByaW50ICJDYXNhLiBhdXRoZW50aWNhdGUuIDJGQSBhdXRoZW50aWNhdGlvbiB3YXMgc3VjY2Vzc2Z1bCIKICAgICAgICAgICAgICAgIHRkaSA9IHNlc3Npb25fYXR0cmlidXRlcy5nZXQoInRydXN0ZWREZXZpY2VzSW5mbyIpCiAgICAgICAgICAgICAgICBpZiB0ZGkgPT0gTm9uZToKICAgICAgICAgICAgICAgICAgICBwcmludCAiQ2FzYS4gYXV0aGVudGljYXRlLiBMaXN0IG9mIHVzZXIncyB0cnVzdGVkIGRldmljZXMgd2FzIG5vdCB1cGRhdGVkIgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB1c2VyLnNldEF0dHJpYnV0ZSgib3hUcnVzdGVkRGV2aWNlc0luZm8iLCB0ZGkpCiAgICAgICAgICAgICAgICAgICAgdXNlclNlcnZpY2UudXBkYXRlVXNlcih1c2VyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQgIkNhc2EuIGF1dGhlbnRpY2F0ZS4gMkZBIGF1dGhlbnRpY2F0aW9uIGZhaWxlZCIKCiAgICAgICAgICAgIHJldHVybiBzdWNjZXNzCgogICAgICAgIHJldHVybiBGYWxzZQoKCiAgICBkZWYgcHJlcGFyZUZvclN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKICAgICAgICBwcmludCAiQ2FzYS4gcHJlcGFyZUZvclN0ZXAgJXMiICUgc3RyKHN0ZXApCiAgICAgICAgaWRlbnRpdHkgPSBDZGlVdGlsLmJlYW4oSWRlbnRpdHkpCgogICAgICAgIGlmIHN0ZXAgPT0gMToKICAgICAgICAgICAgc2VsZi5wcmVwYXJlVUlQYXJhbXMoaWRlbnRpdHkpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2Vzc2lvbl9hdHRyaWJ1dGVzID0gaWRlbnRpdHkuZ2V0U2Vzc2lvbklkKCkuZ2V0U2Vzc2lvbkF0dHJpYnV0ZXMoKQoKICAgICAgICAgICAgYXV0aGVudGljYXRpb25TZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKEF1dGhlbnRpY2F0aW9uU2VydmljZSkKICAgICAgICAgICAgdXNlciA9IGF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRBdXRoZW50aWNhdGVkVXNlcigpCgogICAgICAgICAgICBpZiB1c2VyID09IE5vbmU6CiAgICAgICAgICAgICAgICBwcmludCAiQ2FzYS4gcHJlcGFyZUZvclN0ZXAuIENhbm5vdCByZXRyaWV2ZSBsb2dnZWQgdXNlciIKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgYWNyID0gc2Vzc2lvbl9hdHRyaWJ1dGVzLmdldCgiQUNSIikKICAgICAgICAgICAgcHJpbnQgIkNhc2EuIHByZXBhcmVGb3JTdGVwLiBBQ1IgPSAlcyIgJSBhY3IKICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigibWV0aG9kcyIsIEFycmF5TGlzdChzZWxmLmdldEF2YWlsTWV0aG9kc1VzZXIodXNlciwgYWNyKSkpCgogICAgICAgICAgICBpZiBhY3IgaW4gc2VsZi5hdXRoZW50aWNhdG9yczoKICAgICAgICAgICAgICAgIG1vZHVsZSA9IHNlbGYuYXV0aGVudGljYXRvcnNbYWNyXQogICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZS5wcmVwYXJlRm9yU3RlcChtb2R1bGUuY29uZmlnQXR0cnMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgoKICAgIGRlZiBnZXRFeHRyYVBhcmFtZXRlcnNGb3JTdGVwKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCBzdGVwKToKICAgICAgICBwcmludCAiQ2FzYS4gZ2V0RXh0cmFQYXJhbWV0ZXJzRm9yU3RlcCAlcyIgJSBzdHIoc3RlcCkKICAgICAgICBsaXN0ID0gQXJyYXlMaXN0KCkKCiAgICAgICAgaWYgc3RlcCA+IDE6CiAgICAgICAgICAgIGFjciA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkuZ2V0V29ya2luZ1BhcmFtZXRlcigiQUNSIikKCiAgICAgICAgICAgIGlmIGFjciBpbiBzZWxmLmF1dGhlbnRpY2F0b3JzOgogICAgICAgICAgICAgICAgbW9kdWxlID0gc2VsZi5hdXRoZW50aWNhdG9yc1thY3JdCiAgICAgICAgICAgICAgICBwYXJhbXMgPSBtb2R1bGUuZ2V0RXh0cmFQYXJhbWV0ZXJzRm9yU3RlcChtb2R1bGUuY29uZmlnQXR0cnMsIHN0ZXApCiAgICAgICAgICAgICAgICBpZiBwYXJhbXMgIT0gTm9uZToKICAgICAgICAgICAgICAgICAgICBsaXN0LmFkZEFsbChwYXJhbXMpCgogICAgICAgICAgICBsaXN0LmFkZEFsbChBcnJheXMuYXNMaXN0KCJBQ1IiLCAibWV0aG9kcyIsICJ0cnVzdGVkRGV2aWNlc0luZm8iKSkKCiAgICAgICAgbGlzdC5hZGRBbGwoQXJyYXlzLmFzTGlzdCgiY2FzYV9jb250ZXh0UGF0aCIsICJjYXNhX3ByZWZpeCIsICJjYXNhX2Zhdmljb25VcmwiLCAiY2FzYV9leHRyYUNzcyIsICJjYXNhX2xvZ29VcmwiKSkKICAgICAgICBwcmludCAiZXh0cmFzIGFyZSAlcyIgJSBsaXN0CiAgICAgICAgcmV0dXJuIGxpc3QKCgogICAgZGVmIGdldENvdW50QXV0aGVudGljYXRpb25TdGVwcyhzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkNhc2EuIGdldENvdW50QXV0aGVudGljYXRpb25TdGVwcyBjYWxsZWQiCgogICAgICAgIGlmIENkaVV0aWwuYmVhbihJZGVudGl0eSkuZ2V0V29ya2luZ1BhcmFtZXRlcigic2tpcDJGQSIpOgogICAgICAgICAgIHJldHVybiAxCgogICAgICAgIGFjciA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkuZ2V0V29ya2luZ1BhcmFtZXRlcigiQUNSIikKICAgICAgICBpZiBhY3IgaW4gc2VsZi5hdXRoZW50aWNhdG9yczoKICAgICAgICAgICAgbW9kdWxlID0gc2VsZi5hdXRoZW50aWNhdG9yc1thY3JdCiAgICAgICAgICAgIHJldHVybiBtb2R1bGUuZ2V0Q291bnRBdXRoZW50aWNhdGlvblN0ZXBzKG1vZHVsZS5jb25maWdBdHRycykKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gMgoKICAgICAgICBwcmludCAiQ2FzYS4gZ2V0Q291bnRBdXRoZW50aWNhdGlvblN0ZXBzLiBDb3VsZCBub3QgZGV0ZXJtaW5lIHRoZSBzdGVwIGNvdW50IGZvciBhY3IgJXMiICUgYWNyCgoKICAgIGRlZiBnZXRQYWdlRm9yU3RlcChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgc3RlcCk6CiAgICAgICAgcHJpbnQgIkNhc2EuIGdldFBhZ2VGb3JTdGVwIGNhbGxlZCAlcyIgJSBzdHIoc3RlcCkKCiAgICAgICAgaWYgc3RlcCA+IDE6CiAgICAgICAgICAgIGFjciA9IENkaVV0aWwuYmVhbihJZGVudGl0eSkuZ2V0V29ya2luZ1BhcmFtZXRlcigiQUNSIikKICAgICAgICAgICAgaWYgYWNyIGluIHNlbGYuYXV0aGVudGljYXRvcnM6CiAgICAgICAgICAgICAgICBtb2R1bGUgPSBzZWxmLmF1dGhlbnRpY2F0b3JzW2Fjcl0KICAgICAgICAgICAgICAgIHBhZ2UgPSBtb2R1bGUuZ2V0UGFnZUZvclN0ZXAobW9kdWxlLmNvbmZpZ0F0dHJzLCBzdGVwKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcGFnZT1Ob25lCgogICAgICAgICAgICByZXR1cm4gcGFnZQoKICAgICAgICByZXR1cm4gIi9jYXNhL2xvZ2luLnhodG1sIgoKCiAgICBkZWYgZ2V0TmV4dFN0ZXAoc2VsZiwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMsIHJlcXVlc3RQYXJhbWV0ZXJzLCBzdGVwKToKCiAgICAgICAgcHJpbnQgIkNhc2EuIGdldE5leHRTdGVwIGNhbGxlZCAlcyIgJSBzdHIoc3RlcCkKICAgICAgICBpZiBzdGVwID4gMToKICAgICAgICAgICAgYWNyID0gU2VydmVyVXRpbC5nZXRGaXJzdFZhbHVlKHJlcXVlc3RQYXJhbWV0ZXJzLCAiYWx0ZXJuYXRpdmVNZXRob2QiKQogICAgICAgICAgICBpZiBhY3IgIT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJDYXNhLiBnZXROZXh0U3RlcC4gVXNlIGFsdGVybmF0aXZlIG1ldGhvZCAlcyIgJSBhY3IKICAgICAgICAgICAgICAgIENkaVV0aWwuYmVhbihJZGVudGl0eSkuc2V0V29ya2luZ1BhcmFtZXRlcigiQUNSIiwgYWNyKQogICAgICAgICAgICAgICAgI3JldHJ5IHN0ZXAgd2l0aCBkaWZmZXJlbnQgYWNyCiAgICAgICAgICAgICAgICByZXR1cm4gMgoKICAgICAgICByZXR1cm4gLTEKCgogICAgZGVmIGxvZ291dChzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcywgcmVxdWVzdFBhcmFtZXRlcnMpOgogICAgICAgIHByaW50ICJDYXNhLiBsb2dvdXQgY2FsbGVkIgogICAgICAgIHJldHVybiBUcnVlCgojIE1pc2NlbGFuZW91cwoKICAgIGRlZiBnZXRMb2NhbFByaW1hcnlLZXkoc2VsZik6CiAgICAgICAgZW50cnlNYW5hZ2VyID0gQ2RpVXRpbC5iZWFuKFBlcnNpc3RlbmNlRW50cnlNYW5hZ2VyKQogICAgICAgIGNvbmZpZyA9IEdsdXVDb25maWd1cmF0aW9uKCkKICAgICAgICBjb25maWcgPSBlbnRyeU1hbmFnZXIuZmluZChjb25maWcuZ2V0Q2xhc3MoKSwgIm91PWNvbmZpZ3VyYXRpb24sbz1nbHV1IikKICAgICAgICAjUGljayAob25lKSBhdHRyaWJ1dGUgd2hlcmUgdXNlciBpZCBpcyBzdG9yZWQgKGUuZy4gdWlkL21haWwpCiAgICAgICAgdWlkX2F0dHIgPSBjb25maWcuZ2V0T3hJRFBBdXRoZW50aWNhdGlvbigpLmdldCgwKS5nZXRDb25maWcoKS5nZXRQcmltYXJ5S2V5KCkKICAgICAgICBwcmludCAiQ2FzYS4gaW5pdC4gdWlkIGF0dHJpYnV0ZSBpcyAnJXMnIiAlIHVpZF9hdHRyCiAgICAgICAgcmV0dXJuIHVpZF9hdHRyCgoKICAgIGRlZiBnZXRTZXR0aW5ncyhzZWxmKToKICAgICAgICBlbnRyeU1hbmFnZXIgPSBDZGlVdGlsLmJlYW4oUGVyc2lzdGVuY2VFbnRyeU1hbmFnZXIpCiAgICAgICAgY29uZmlnID0gQXBwbGljYXRpb25Db25maWd1cmF0aW9uKCkKICAgICAgICBjb25maWcgPSBlbnRyeU1hbmFnZXIuZmluZChjb25maWcuZ2V0Q2xhc3MoKSwgIm91PWNhc2Esb3U9Y29uZmlndXJhdGlvbixvPWdsdXUiKQogICAgICAgIHNldHRpbmdzID0gTm9uZQogICAgICAgIHRyeToKICAgICAgICAgICAgc2V0dGluZ3MgPSBqc29uLmxvYWRzKGNvbmZpZy5nZXRTZXR0aW5ncygpKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIkNhc2EuIGdldFNldHRpbmdzLiBGYWlsZWQgdG8gcGFyc2UgY2FzYSBzZXR0aW5ncyBmcm9tIERCIgogICAgICAgIHJldHVybiBzZXR0aW5ncwoKCiAgICBkZWYgY29tcHV0ZU1ldGhvZHMoc2VsZiwgc2NyaXB0TGlzdCk6CgogICAgICAgIG1ldGhvZHMgPSBbXQogICAgICAgIG1hcHBpbmcgPSB7fQogICAgICAgIGNtQ29uZmlncyA9IHNlbGYuZ2V0U2V0dGluZ3MoKQoKICAgICAgICBpZiBjbUNvbmZpZ3MgIT0gTm9uZSBhbmQgJ2Fjcl9wbHVnaW5fbWFwcGluZycgaW4gY21Db25maWdzOgogICAgICAgICAgICBtYXBwaW5nID0gY21Db25maWdzWydhY3JfcGx1Z2luX21hcHBpbmcnXQoKICAgICAgICBmb3IgbSBpbiBtYXBwaW5nOgogICAgICAgICAgICBmb3IgY3VzdG9tU2NyaXB0IGluIHNjcmlwdExpc3Q6CiAgICAgICAgICAgICAgICBpZiBjdXN0b21TY3JpcHQuZ2V0TmFtZSgpID09IG0gYW5kIGN1c3RvbVNjcmlwdC5pc0VuYWJsZWQoKToKICAgICAgICAgICAgICAgICAgICBtZXRob2RzLmFwcGVuZChtKQoKICAgICAgICBwcmludCAiQ2FzYS4gY29tcHV0ZU1ldGhvZHMuICVzIiAlIG1ldGhvZHMKICAgICAgICByZXR1cm4gbWV0aG9kcwoKCiAgICBkZWYgZ2V0Q29uZmlndXJhdGlvbkF0dHJpYnV0ZXMoc2VsZiwgYWNyLCBzY3JpcHRzTGlzdCk6CgogICAgICAgIGNvbmZpZ01hcCA9IEhhc2hNYXAoKQogICAgICAgIGZvciBjdXN0b21TY3JpcHQgaW4gc2NyaXB0c0xpc3Q6CiAgICAgICAgICAgIGlmIGN1c3RvbVNjcmlwdC5nZXROYW1lKCkgPT0gYWNyIGFuZCBjdXN0b21TY3JpcHQuaXNFbmFibGVkKCk6CiAgICAgICAgICAgICAgICBmb3IgcHJvcCBpbiBjdXN0b21TY3JpcHQuZ2V0Q29uZmlndXJhdGlvblByb3BlcnRpZXMoKToKICAgICAgICAgICAgICAgICAgICBjb25maWdNYXAucHV0KHByb3AuZ2V0VmFsdWUxKCksIFNpbXBsZUN1c3RvbVByb3BlcnR5KHByb3AuZ2V0VmFsdWUxKCksIHByb3AuZ2V0VmFsdWUyKCkpKQoKICAgICAgICBwcmludCAiQ2FzYS4gZ2V0Q29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuICVkIGNvbmZpZ3VyYXRpb24gcHJvcGVydGllcyB3ZXJlIGZvdW5kIGZvciAlcyIgJSAoY29uZmlnTWFwLnNpemUoKSwgYWNyKQogICAgICAgIHJldHVybiBjb25maWdNYXAKCgogICAgZGVmIGdldEF2YWlsTWV0aG9kc1VzZXIoc2VsZiwgdXNlciwgc2tpcD1Ob25lKToKICAgICAgICBtZXRob2RzID0gSGFzaFNldCgpCgogICAgICAgIGZvciBtZXRob2QgaW4gc2VsZi5hdXRoZW50aWNhdG9yczoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbW9kdWxlID0gc2VsZi5hdXRoZW50aWNhdG9yc1ttZXRob2RdCiAgICAgICAgICAgICAgICBpZiBtb2R1bGUuaGFzRW5yb2xsbWVudHMobW9kdWxlLmNvbmZpZ0F0dHJzLCB1c2VyKToKICAgICAgICAgICAgICAgICAgICBtZXRob2RzLmFkZChtZXRob2QpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50ICJDYXNhLiBnZXRBdmFpbE1ldGhvZHNVc2VyLiBoYXNFbnJvbGxtZW50cyBjYWxsIGNvdWxkIG5vdCBiZSBpc3N1ZWQgZm9yICVzIG1vZHVsZSIgJSBtZXRob2QKICAgICAgICAgICAgICAgIHByaW50ICJFeGNlcHRpb246ICIsIHN5cy5leGNfaW5mbygpWzFdCgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2tpcCAhPSBOb25lOgogICAgICAgICAgICAgICAgIyBza2lwIGlzIGd1YXJhbnRlZWQgdG8gYmUgYSBtZW1iZXIgb2YgbWV0aG9kcyAoaWYgaGFzRW5yb2xsbWVudHMgcm91dGluZXMgYXJlIHByb3Blcmx5IGltcGxlbWVudGVkKS4KICAgICAgICAgICAgICAgICMgQSBjYWxsIHRvIHJlbW92ZSBzdHJhbmdlbHkgY3Jhc2hlcyB3aGVuIHNraXAgaXMgYWJzZW50CiAgICAgICAgICAgICAgICBtZXRob2RzLnJlbW92ZShza2lwKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQgIkNhc2EuIGdldEF2YWlsTWV0aG9kc1VzZXIuIG1ldGhvZHMgbGlzdCBkb2VzIG5vdCBjb250YWluICVzIiAlIHNraXAKCiAgICAgICAgcHJpbnQgIkNhc2EuIGdldEF2YWlsTWV0aG9kc1VzZXIgJXMiICUgbWV0aG9kcy50b1N0cmluZygpCiAgICAgICAgcmV0dXJuIG1ldGhvZHMKCgogICAgZGVmIHByZXBhcmVVSVBhcmFtcyhzZWxmLCBpZGVudGl0eSk6CiAgICAgICAgCiAgICAgICAgcHJpbnQgIkNhc2EuIHByZXBhcmVVSVBhcmFtcy4gUmVhZGluZyBVSSBicmFuZGluZyBwYXJhbXMiCiAgICAgICAgY2FjaGVTZXJ2aWNlID0gQ2RpVXRpbC5iZWFuKENhY2hlU2VydmljZSkKICAgICAgICBjYXNhQXNzZXRzID0gY2FjaGVTZXJ2aWNlLmdldCgiY2FzYV9hc3NldHMiKQogICAgICAgICAgICAKICAgICAgICBpZiBjYXNhQXNzZXRzID09IE5vbmU6CiAgICAgICAgICAgICNUaGlzIG1heSBoYXBwZW4gd2hlbiBjYWNoZSB0eXBlIGlzIElOX01FTU9SWSwgd2hlcmUgYWN0dWFsIGNhY2hlIGlzIG1lcmVseSBhIGxvY2FsIHZhcmlhYmxlIAogICAgICAgICAgICAjKGEgZXhwaXJpbmcgbWFwKSBsaXZpbmcgaW5zaWRlIENhc2Egd2ViYXBwLCBub3Qgb3hBdXRoIHdlYmFwcAogICAgICAgICAgICAKICAgICAgICAgICAgc2V0cyA9IHNlbGYuZ2V0U2V0dGluZ3MoKQogICAgICAgICAgICAKICAgICAgICAgICAgY3VzdFByZWZpeCA9ICIvY3VzdG9tIgogICAgICAgICAgICBsb2dvVXJsID0gIi9pbWFnZXMvbG9nby5wbmciCiAgICAgICAgICAgIGZhdmljb25VcmwgPSAiL2ltYWdlcy9mYXZpY29uLmljbyIKICAgICAgICAgICAgaWYgKCJleHRyYV9jc3MiIGluIHNldHMgYW5kIHNldHNbImV4dHJhX2NzcyJdICE9IE5vbmUpIG9yIHNldHNbInVzZV9icmFuZGluZyJdOgogICAgICAgICAgICAgICAgbG9nb1VybCA9IGN1c3RQcmVmaXggKyBsb2dvVXJsCiAgICAgICAgICAgICAgICBmYXZpY29uVXJsID0gY3VzdFByZWZpeCArIGZhdmljb25VcmwKICAgICAgICAgICAgCiAgICAgICAgICAgIHByZWZpeCA9IGN1c3RQcmVmaXggaWYgc2V0c1sidXNlX2JyYW5kaW5nIl0gZWxzZSAiIgogICAgICAgICAgICAKICAgICAgICAgICAgY2FzYUFzc2V0cyA9IHsKICAgICAgICAgICAgICAgICJjb250ZXh0UGF0aCI6ICIvY2FzYSIsCiAgICAgICAgICAgICAgICAicHJlZml4IiA6IHByZWZpeCwKICAgICAgICAgICAgICAgICJmYXZpY29uVXJsIiA6IGZhdmljb25VcmwsCiAgICAgICAgICAgICAgICAiZXh0cmFDc3MiOiBzZXRzWyJleHRyYV9jc3MiXSBpZiAiZXh0cmFfY3NzIiBpbiBzZXRzIGVsc2UgTm9uZSwKICAgICAgICAgICAgICAgICJsb2dvVXJsIjogbG9nb1VybAogICAgICAgICAgICB9CiAgICAgICAgCiAgICAgICAgI1NldHRpbmcgYSBzaW5nbGUgdmFyaWFibGUgd2l0aCB0aGUgd2hvbGUgbWFwIGRvZXMgbm90IHdvcmsuLi4KICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJjYXNhX2NvbnRleHRQYXRoIiwgY2FzYUFzc2V0c1snY29udGV4dFBhdGgnXSkKICAgICAgICBpZGVudGl0eS5zZXRXb3JraW5nUGFyYW1ldGVyKCJjYXNhX3ByZWZpeCIsIGNhc2FBc3NldHNbJ3ByZWZpeCddKQogICAgICAgIGlkZW50aXR5LnNldFdvcmtpbmdQYXJhbWV0ZXIoImNhc2FfZmF2aWNvblVybCIsIGNhc2FBc3NldHNbJ2NvbnRleHRQYXRoJ10gKyBjYXNhQXNzZXRzWydmYXZpY29uVXJsJ10pCiAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigiY2FzYV9leHRyYUNzcyIsIGNhc2FBc3NldHNbJ2V4dHJhQ3NzJ10pCiAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigiY2FzYV9sb2dvVXJsIiwgY2FzYUFzc2V0c1snY29udGV4dFBhdGgnXSArIGNhc2FBc3NldHNbJ2xvZ29VcmwnXSkKCgogICAgZGVmIHNpbXVsYXRlRmlyc3RTdGVwKHNlbGYsIHJlcXVlc3RQYXJhbWV0ZXJzLCBhY3IpOgogICAgICAgICNUbyBzaW11bGF0ZSAxc3Qgc3RlcCwgdGhlcmUgaXMgbm8gbmVlZCB0byBjYWxsOgogICAgICAgICMgZ2V0UGFnZWZvcnN0ZXAgKG5vIG5lZWQgYXMgdXNlci9wd2Qgd29uJ3QgYmUgc2hvd24gYWdhaW4pCiAgICAgICAgIyBpc1ZhbGlkQXV0aGVudGljYXRpb25NZXRob2QgKGJ5IHJlc3RyaWN0aW9uLCBpdCByZXR1cm5zIFRydWUpCiAgICAgICAgIyBwcmVwYXJlRm9yU3RlcCAoYnkgcmVzdHJpY3Rpb24sIGl0IHJldHVybnMgVHJ1ZSkKICAgICAgICAjIGdldEV4dHJhUGFyYW1ldGVyc0ZvclN0ZXAgKGJ5IHJlc3RyaWN0aW9uLCBpdCByZXR1cm5zIE5vbmUpCiAgICAgICAgcHJpbnQgIkNhc2EuIHNpbXVsYXRlRmlyc3RTdGVwLiBDYWxsaW5nIGF1dGhlbnRpY2F0ZSAoc3RlcCAxKSBmb3IgJXMgbW9kdWxlIiAlIGFjcgogICAgICAgIGlmIGFjciBpbiBzZWxmLmF1dGhlbnRpY2F0b3JzOgogICAgICAgICAgICBtb2R1bGUgPSBzZWxmLmF1dGhlbnRpY2F0b3JzW2Fjcl0KICAgICAgICAgICAgYXV0aCA9IG1vZHVsZS5hdXRoZW50aWNhdGUobW9kdWxlLmNvbmZpZ0F0dHJzLCByZXF1ZXN0UGFyYW1ldGVycywgMSkKICAgICAgICAgICAgcHJpbnQgIkNhc2EuIHNpbXVsYXRlRmlyc3RTdGVwLiByZXR1cm5lZCB2YWx1ZSB3YXMgJXMiICUgYXV0aAoKCiMgMkZBIHBvbGljeSBlbmZvcmNlbWVudAoKICAgIGRlZiBwYXJzZVBsYXRmb3JtRGF0YShzZWxmLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjRmluZCBkZXZpY2UgaW5mbyBwYXNzZWQgaW4gSFRUUCByZXF1ZXN0IHBhcmFtcyAoc2VlIGluZGV4LnhodG1sKQogICAgICAgICAgICBwbGF0Zm9ybSA9IFNlcnZlclV0aWwuZ2V0Rmlyc3RWYWx1ZShyZXF1ZXN0UGFyYW1ldGVycywgImxvZ2luRm9ybTpwbGF0Zm9ybSIpCiAgICAgICAgICAgIGRldmljZUluZiA9IGpzb24ubG9hZHMocGxhdGZvcm0pCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwcmludCAiQ2FzYS4gcGFyc2VQbGF0Zm9ybURhdGEuIEVycm9yIHBhcnNpbmcgcGxhdGZvcm0gZGF0YSIKICAgICAgICAgICAgZGV2aWNlSW5mID0gTm9uZQoKICAgICAgICByZXR1cm4gZGV2aWNlSW5mCgoKICAgIGRlZiBnZXRTdWl0YWJsZUFjcihzZWxmLCB1c2VyLCBkZXZpY2VJbmYpOgoKICAgICAgICBvbk1vYmlsZSA9IGRldmljZUluZiAhPSBOb25lIGFuZCAnaXNNb2JpbGUnIGluIGRldmljZUluZiBhbmQgZGV2aWNlSW5mWydpc01vYmlsZSddCiAgICAgICAgaWQgPSB1c2VyLmdldFVzZXJJZCgpCiAgICAgICAgc3Ryb25nZXN0ID0gLTEKICAgICAgICBhY3IgPSBOb25lCiAgICAgICAgdXNlcl9tZXRob2RzID0gc2VsZi5nZXRBdmFpbE1ldGhvZHNVc2VyKHVzZXIpCgogICAgICAgIGZvciBzIGluIHNlbGYuc2NyaXB0c0xpc3Q6CiAgICAgICAgICAgIG5hbWUgPSBzLmdldE5hbWUoKQogICAgICAgICAgICBpZiB1c2VyX21ldGhvZHMuY29udGFpbnMobmFtZSkgYW5kIG5hbWUgaW4gc2VsZi5hdXRoZW50aWNhdG9ycyBhbmQgcy5nZXRMZXZlbCgpID4gc3Ryb25nZXN0IGFuZCAobm90IG9uTW9iaWxlIG9yIG5hbWUgaW4gc2VsZi5tb2JpbGVfbWV0aG9kcyk6CiAgICAgICAgICAgICAgICBhY3IgPSBuYW1lCiAgICAgICAgICAgICAgICBzdHJvbmdlc3QgPSBzLmdldExldmVsKCkKCiAgICAgICAgcHJpbnQgIkNhc2EuIGdldFN1aXRhYmxlQWNyLiBPbiBtb2JpbGUgPSAlcyIgJSBvbk1vYmlsZQogICAgICAgIGlmIGFjciA9PSBOb25lIGFuZCBvbk1vYmlsZToKICAgICAgICAgICAgcHJpbnQgIkNhc2EuIGdldFN1aXRhYmxlQWNyLiBObyBtb2JpbGUtZnJpZW5kbHkgYXV0aGVudGljYXRpb24gbWV0aG9kIGF2YWlsYWJsZSBmb3IgdXNlciAlcyIgJSBpZAogICAgICAgICAgICAjIHVzZXJfbWV0aG9kcyBpcyBub3QgZW1wdHkgd2hlbiB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCwgc28ganVzdCBwaWNrIGFueQogICAgICAgICAgICBhY3IgPSB1c2VyX21ldGhvZHMuZ2V0KDApCgogICAgICAgIHByaW50ICJDYXNhLiBnZXRTdWl0YWJsZUFjci4gJXMgd2FzIHNlbGVjdGVkIGZvciB1c2VyICVzIiAlIChhY3IsIGlkKQogICAgICAgIHJldHVybiBhY3IKCgogICAgZGVmIGRldGVybWluZVNraXAyRkEoc2VsZiwgdXNlclNlcnZpY2UsIGlkZW50aXR5LCBmb3VuZFVzZXIsIGRldmljZUluZik6CgogICAgICAgIGNtQ29uZmlncyA9IHNlbGYuZ2V0U2V0dGluZ3MoKQoKICAgICAgICBpZiBjbUNvbmZpZ3MgPT0gTm9uZToKICAgICAgICAgICAgcHJpbnQgIkNhc2EuIGRldGVybWluZVNraXAyRkEuIEZhaWxlZCB0byByZWFkIHBvbGljeV8yZmEiCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBtaXNzaW5nID0gRmFsc2UKICAgICAgICBpZiBub3QgJ3BsdWdpbnNfc2V0dGluZ3MnIGluIGNtQ29uZmlnczoKICAgICAgICAgICAgbWlzc2luZyA9IFRydWUKICAgICAgICBlbGlmIG5vdCAnc3Ryb25nLWF1dGhuLXNldHRpbmdzJyBpbiBjbUNvbmZpZ3NbJ3BsdWdpbnNfc2V0dGluZ3MnXToKICAgICAgICAgICAgbWlzc2luZyA9IFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICBjbUNvbmZpZ3MgPSBjbUNvbmZpZ3NbJ3BsdWdpbnNfc2V0dGluZ3MnXVsnc3Ryb25nLWF1dGhuLXNldHRpbmdzJ10KCiAgICAgICAgcG9saWN5MkZBID0gJ0VWRVJZX0xPR0lOJwogICAgICAgIGlmIG5vdCBtaXNzaW5nIGFuZCAncG9saWN5XzJmYScgaW4gY21Db25maWdzOgogICAgICAgICAgICBwb2xpY3kyRkEgPSAnLCcuam9pbihjbUNvbmZpZ3NbJ3BvbGljeV8yZmEnXSkKCiAgICAgICAgcHJpbnQgIkNhc2EuIGRldGVybWluZVNraXAyRkEgd2l0aCBnZW5lcmFsIHBvbGljeSAlcyIgJSBwb2xpY3kyRkEKICAgICAgICBwb2xpY3kyRkEgKz0gJywnCiAgICAgICAgc2tpcDJGQSA9IEZhbHNlCgogICAgICAgIGlmICdDVVNUT00sJyBpbiBwb2xpY3kyRkE6CiAgICAgICAgICAgICNyZWFkIHNldHRpbmcgZnJvbSB1c2VyIHByb2ZpbGUKICAgICAgICAgICAgcG9saWN5ID0gZm91bmRVc2VyLmdldEF0dHJpYnV0ZSgib3hTdHJvbmdBdXRoUG9saWN5IikKICAgICAgICAgICAgaWYgcG9saWN5ID09IE5vbmU6CiAgICAgICAgICAgICAgICBwb2xpY3kgPSAnRVZFUllfTE9HSU4sJwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcG9saWN5ID0gcG9saWN5LnVwcGVyKCkgKyAnLCcKICAgICAgICAgICAgcHJpbnQgIkNhc2EuIGRldGVybWluZVNraXAyRkEuIFVzaW5nIHVzZXIncyBlbmZvcmNlbWVudCBwb2xpY3kgJXMiICUgcG9saWN5CgogICAgICAgIGVsc2U6CiAgICAgICAgICAgICNJZiBpdCdzIG5vdCBjdXN0b20sIHRoZW4gYXBwbHkgdGhlIGdsb2JhbCBzZXR0aW5nIGFkbWluIGRlZmluZWQKICAgICAgICAgICAgcG9saWN5ID0gcG9saWN5MkZBCgogICAgICAgIGlmIG5vdCAnRVZFUllfTE9HSU4sJyBpbiBwb2xpY3k6CiAgICAgICAgICAgIGxvY2F0aW9uQ3JpdGVyaW9uID0gJ0xPQ0FUSU9OX1VOS05PV04sJyBpbiBwb2xpY3kKICAgICAgICAgICAgZGV2aWNlQ3JpdGVyaW9uID0gJ0RFVklDRV9VTktOT1dOLCcgaW4gcG9saWN5CgogICAgICAgICAgICBpZiBsb2NhdGlvbkNyaXRlcmlvbiBvciBkZXZpY2VDcml0ZXJpb246CiAgICAgICAgICAgICAgICBpZiBkZXZpY2VJbmYgPT0gTm9uZToKICAgICAgICAgICAgICAgICAgICBwcmludCAiQ2FzYS4gZGV0ZXJtaW5lU2tpcDJGQS4gTm8gdXNlciBkZXZpY2UgZGF0YS4gRm9yY2luZyAyRkEgdG8gdGFrZSBwbGFjZS4uLiIKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2tpcDJGQSA9IHNlbGYucHJvY2VzczJGQVBvbGljeShpZGVudGl0eSwgZm91bmRVc2VyLCBkZXZpY2VJbmYsIGxvY2F0aW9uQ3JpdGVyaW9uLCBkZXZpY2VDcml0ZXJpb24pCgogICAgICAgICAgICAgICAgICAgIGlmIHNraXAyRkE6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ICJDYXNhLiBkZXRlcm1pbmVTa2lwMkZBLiBTZWNvbmQgZmFjdG9yIGlzIHNraXBwZWQiCiAgICAgICAgICAgICAgICAgICAgICAgICNVcGRhdGUgYXR0cmlidXRlIGlmIGF1dGhlbnRpY2F0aW9uIHdpbGwgbm90IGhhdmUgc2Vjb25kIHN0ZXAKICAgICAgICAgICAgICAgICAgICAgICAgZGV2SW5mID0gaWRlbnRpdHkuZ2V0V29ya2luZ1BhcmFtZXRlcigidHJ1c3RlZERldmljZXNJbmZvIikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZGV2SW5mICE9IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZFVzZXIuc2V0QXR0cmlidXRlKCJveFRydXN0ZWREZXZpY2VzSW5mbyIsIGRldkluZikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJTZXJ2aWNlLnVwZGF0ZVVzZXIoZm91bmRVc2VyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQgIkNhc2EuIGRldGVybWluZVNraXAyRkEuIFVua25vd24gJXMgcG9saWN5OiBjYW5ub3Qgc2tpcCAyRkEiICUgcG9saWN5CgogICAgICAgIHJldHVybiBza2lwMkZBCgoKICAgIGRlZiBwcm9jZXNzMkZBUG9saWN5KHNlbGYsIGlkZW50aXR5LCBmb3VuZFVzZXIsIGRldmljZUluZiwgbG9jYXRpb25Dcml0ZXJpb24sIGRldmljZUNyaXRlcmlvbik6CgogICAgICAgIHNraXAyRkEgPSBGYWxzZQogICAgICAgICNSZXRyaWV2ZSB1c2VyJ3MgZGV2aWNlcyBpbmZvCiAgICAgICAgZGV2aWNlc0luZm8gPSBmb3VuZFVzZXIuZ2V0QXR0cmlidXRlKCJveFRydXN0ZWREZXZpY2VzSW5mbyIpCgogICAgICAgICNkbyBnZW9sb2NhdGlvbgogICAgICAgIGdlb2RhdGEgPSBzZWxmLmdldEdlb2xvY2F0aW9uKGlkZW50aXR5KQogICAgICAgIGlmIGdlb2RhdGEgPT0gTm9uZToKICAgICAgICAgICAgcHJpbnQgIkNhc2EuIHByb2Nlc3MyRkFQb2xpY3k6IEdlb2xvY2F0aW9uIGRhdGEgbm90IG9idGFpbmVkLiAyRkEgc2tpcHBpbmcgYmFzZWQgb24gbG9jYXRpb24gY2Fubm90IHRha2UgcGxhY2UiCgogICAgICAgIHRyeToKICAgICAgICAgICAgZW5jU2VydmljZSA9IENkaVV0aWwuYmVhbihFbmNyeXB0aW9uU2VydmljZSkKCiAgICAgICAgICAgIGlmIGRldmljZXNJbmZvID09IE5vbmU6CiAgICAgICAgICAgICAgICBwcmludCAiQ2FzYS4gcHJvY2VzczJGQVBvbGljeTogVGhlcmUgYXJlIG5vIHRydXN0ZWQgZGV2aWNlcyBmb3IgdXNlciB5ZXQiCiAgICAgICAgICAgICAgICAjU2ltdWxhdGUgZW1wdHkgbGlzdAogICAgICAgICAgICAgICAgZGV2aWNlc0luZm8gPSAiW10iCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBkZXZpY2VzSW5mbyA9IGVuY1NlcnZpY2UuZGVjcnlwdChkZXZpY2VzSW5mbykKCiAgICAgICAgICAgIGRldmljZXNJbmZvID0ganNvbi5sb2FkcyhkZXZpY2VzSW5mbykKCiAgICAgICAgICAgIHBhcnRpYWxNYXRjaCA9IEZhbHNlCiAgICAgICAgICAgIGlkeCA9IDAKICAgICAgICAgICAgI1RyeSB0byBmaW5kIGEgbWF0Y2ggZm9yIGRldmljZSBvbmx5CiAgICAgICAgICAgIGZvciBkZXZpY2UgaW4gZGV2aWNlc0luZm86CiAgICAgICAgICAgICAgICBwYXJ0aWFsTWF0Y2ggPSBkZXZpY2VbJ2Jyb3dzZXInXVsnbmFtZSddPT1kZXZpY2VJbmZbJ25hbWUnXSBhbmQgZGV2aWNlWydvcyddWyd2ZXJzaW9uJ109PWRldmljZUluZlsnb3MnXVsndmVyc2lvbiddIGFuZCBkZXZpY2VbJ29zJ11bJ2ZhbWlseSddPT1kZXZpY2VJbmZbJ29zJ11bJ2ZhbWlseSddCiAgICAgICAgICAgICAgICBpZiBwYXJ0aWFsTWF0Y2g6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGlkeCs9MQoKICAgICAgICAgICAgbWF0Y2hGb3VuZCA9IEZhbHNlCgogICAgICAgICAgICAjQXQgbGVhc3Qgb25lIG9mIGxvY2F0aW9uQ3JpdGVyaW9uIG9yIGRldmljZUNyaXRlcmlvbiBpcyBUcnVlCiAgICAgICAgICAgIGlmIGxvY2F0aW9uQ3JpdGVyaW9uIGFuZCBub3QgZGV2aWNlQ3JpdGVyaW9uOgogICAgICAgICAgICAgICAgI3RoaXMgY2hlY2sgbWFrZXMgc2Vuc2UgaWYgdGhlcmUgaXMgY2l0eSBkYXRhIG9ubHkKICAgICAgICAgICAgICAgIGlmIGdlb2RhdGEhPU5vbmU6CiAgICAgICAgICAgICAgICAgICAgZm9yIGRldmljZSBpbiBkZXZpY2VzSW5mbzoKICAgICAgICAgICAgICAgICAgICAgICAgI1NlYXJjaCBhbGwgcmVnaXN0ZXJlZCBjaXRpZXMgdGhhdCBhcmUgZm91bmQgaW4gdHJ1c3RlZCBkZXZpY2VzCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBvcmlnaW4gaW4gZGV2aWNlWydvcmlnaW5zJ106CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaEZvdW5kID0gbWF0Y2hGb3VuZCBvciBvcmlnaW5bJ2NpdHknXT09Z2VvZGF0YVsnY2l0eSddCgogICAgICAgICAgICBlbGlmIHBhcnRpYWxNYXRjaDoKICAgICAgICAgICAgICAgICNJbiB0aGlzIGJyYW5jaCBkZXZpY2VDcml0ZXJpb24gaXMgVHJ1ZQogICAgICAgICAgICAgICAgaWYgbm90IGxvY2F0aW9uQ3JpdGVyaW9uOgogICAgICAgICAgICAgICAgICAgIG1hdGNoRm91bmQgPSBUcnVlCiAgICAgICAgICAgICAgICBlbGlmIGdlb2RhdGEhPU5vbmU6CiAgICAgICAgICAgICAgICAgICAgZm9yIG9yaWdpbiBpbiBkZXZpY2VzSW5mb1tpZHhdWydvcmlnaW5zJ106CiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoRm91bmQgPSBtYXRjaEZvdW5kIG9yIG9yaWdpblsnY2l0eSddPT1nZW9kYXRhWydjaXR5J10KCiAgICAgICAgICAgIHNraXAyRkEgPSBtYXRjaEZvdW5kCiAgICAgICAgICAgIG5vdyA9IERhdGUoKS5nZXRUaW1lKCkKCiAgICAgICAgICAgICNVcGRhdGUgYXR0cmlidXRlIG94VHJ1c3RlZERldmljZXNJbmZvIGFjY29yZGluZ2x5CiAgICAgICAgICAgIGlmIHBhcnRpYWxNYXRjaDoKICAgICAgICAgICAgICAgICNVcGRhdGUgYW4gZXhpc3RpbmcgcmVjb3JkICh1cGRhdGUgdGltZXN0YW1wIGluIGNpdHksIG9yIGVsc2UgYWRkIGl0KQogICAgICAgICAgICAgICAgaWYgZ2VvZGF0YSAhPSBOb25lOgogICAgICAgICAgICAgICAgICAgIHBhcnRpYWxNYXRjaCA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgaWR4Q2l0eSA9IDAKCiAgICAgICAgICAgICAgICAgICAgZm9yIG9yaWdpbiBpbiBkZXZpY2VzSW5mb1tpZHhdWydvcmlnaW5zJ106CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWxNYXRjaCA9IG9yaWdpblsnY2l0eSddPT1nZW9kYXRhWydjaXR5J10KICAgICAgICAgICAgICAgICAgICAgICAgaWYgcGFydGlhbE1hdGNoOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkeENpdHkrPTEKCiAgICAgICAgICAgICAgICAgICAgaWYgcGFydGlhbE1hdGNoOgogICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VzSW5mb1tpZHhdWydvcmlnaW5zJ11baWR4Q2l0eV1bJ3RpbWVzdGFtcCddID0gbm93CiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlc0luZm9baWR4XVsnb3JpZ2lucyddLmFwcGVuZCh7ImNpdHkiOiBnZW9kYXRhWydjaXR5J10sICJjb3VudHJ5IjogZ2VvZGF0YVsnY291bnRyeSddLCAidGltZXN0YW1wIjogbm93fSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICNDcmVhdGUgYSBuZXcgZW50cnkKICAgICAgICAgICAgICAgIGJyb3dzZXIgPSB7Im5hbWUiOiBkZXZpY2VJbmZbJ25hbWUnXSwgInZlcnNpb24iOiBkZXZpY2VJbmZbJ3ZlcnNpb24nXX0KICAgICAgICAgICAgICAgIG9zID0geyJmYW1pbHkiOiBkZXZpY2VJbmZbJ29zJ11bJ2ZhbWlseSddLCAidmVyc2lvbiI6IGRldmljZUluZlsnb3MnXVsndmVyc2lvbiddfQoKICAgICAgICAgICAgICAgIGlmIGdlb2RhdGEgPT0gTm9uZToKICAgICAgICAgICAgICAgICAgICBvcmlnaW5zID0gW10KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgb3JpZ2lucyA9IFt7ImNpdHkiOiBnZW9kYXRhWydjaXR5J10sICJjb3VudHJ5IjogZ2VvZGF0YVsnY291bnRyeSddLCAidGltZXN0YW1wIjogbm93fV0KCiAgICAgICAgICAgICAgICBvYmogPSB7ImJyb3dzZXIiOiBicm93c2VyLCAib3MiOiBvcywgImFkZGVkT24iOiBub3csICJvcmlnaW5zIjogb3JpZ2luc30KICAgICAgICAgICAgICAgIGRldmljZXNJbmZvLmFwcGVuZChvYmopCgogICAgICAgICAgICBlbmMgPSBqc29uLmR1bXBzKGRldmljZXNJbmZvLCBzZXBhcmF0b3JzPSgnLCcsJzonKSkKICAgICAgICAgICAgZW5jID0gZW5jU2VydmljZS5lbmNyeXB0KGVuYykKICAgICAgICAgICAgaWRlbnRpdHkuc2V0V29ya2luZ1BhcmFtZXRlcigidHJ1c3RlZERldmljZXNJbmZvIiwgZW5jKQoKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50ICJDYXNhLiBwcm9jZXNzMkZBUG9saWN5LiBFcnJvciEiLCBzeXMuZXhjX2luZm8oKVsxXQoKICAgICAgICByZXR1cm4gc2tpcDJGQQoKCiAgICBkZWYgZ2V0R2VvbG9jYXRpb24oc2VsZiwgaWRlbnRpdHkpOgoKICAgICAgICBzZXNzaW9uX2F0dHJpYnV0ZXMgPSBpZGVudGl0eS5nZXRTZXNzaW9uSWQoKS5nZXRTZXNzaW9uQXR0cmlidXRlcygpCiAgICAgICAgaWYgc2Vzc2lvbl9hdHRyaWJ1dGVzLmNvbnRhaW5zS2V5KCJyZW1vdGVfaXAiKToKICAgICAgICAgICAgcmVtb3RlX2lwID0gc2Vzc2lvbl9hdHRyaWJ1dGVzLmdldCgicmVtb3RlX2lwIikKICAgICAgICAgICAgaWYgU3RyaW5nSGVscGVyLmlzTm90RW1wdHkocmVtb3RlX2lwKToKCiAgICAgICAgICAgICAgICBodHRwU2VydmljZSA9IENkaVV0aWwuYmVhbihIdHRwU2VydmljZSkKCiAgICAgICAgICAgICAgICBodHRwX2NsaWVudCA9IGh0dHBTZXJ2aWNlLmdldEh0dHBzQ2xpZW50KCkKICAgICAgICAgICAgICAgIGh0dHBfY2xpZW50X3BhcmFtcyA9IGh0dHBfY2xpZW50LmdldFBhcmFtcygpCiAgICAgICAgICAgICAgICBodHRwX2NsaWVudF9wYXJhbXMuc2V0SW50UGFyYW1ldGVyKENvcmVDb25uZWN0aW9uUE5hbWVzLkNPTk5FQ1RJT05fVElNRU9VVCwgNCAqIDEwMDApCgogICAgICAgICAgICAgICAgZ2VvbG9jYXRpb25fc2VydmljZV91cmwgPSAiaHR0cDovL2lwLWFwaS5jb20vanNvbi8lcz9maWVsZHM9Y291bnRyeSxjaXR5LHN0YXR1cyxtZXNzYWdlIiAlIHJlbW90ZV9pcAogICAgICAgICAgICAgICAgZ2VvbG9jYXRpb25fc2VydmljZV9oZWFkZXJzID0geyAiQWNjZXB0IiA6ICJhcHBsaWNhdGlvbi9qc29uIiB9CgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGh0dHBfc2VydmljZV9yZXNwb25zZSA9IGh0dHBTZXJ2aWNlLmV4ZWN1dGVHZXQoaHR0cF9jbGllbnQsIGdlb2xvY2F0aW9uX3NlcnZpY2VfdXJsLCBnZW9sb2NhdGlvbl9zZXJ2aWNlX2hlYWRlcnMpCiAgICAgICAgICAgICAgICAgICAgaHR0cF9yZXNwb25zZSA9IGh0dHBfc2VydmljZV9yZXNwb25zZS5nZXRIdHRwUmVzcG9uc2UoKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHByaW50ICJDYXNhLiBEZXRlcm1pbmUgcmVtb3RlIGxvY2F0aW9uLiBFeGNlcHRpb246ICIsIHN5cy5leGNfaW5mbygpWzFdCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGh0dHBTZXJ2aWNlLmlzUmVzcG9uc2VTdGFzdHVzQ29kZU9rKGh0dHBfcmVzcG9uc2UpOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCAiQ2FzYS4gRGV0ZXJtaW5lIHJlbW90ZSBsb2NhdGlvbi4gR2V0IG5vbiAyMDAgT0sgcmVzcG9uc2UgZnJvbSBzZXJ2ZXI6Iiwgc3RyKGh0dHBfcmVzcG9uc2UuZ2V0U3RhdHVzTGluZSgpLmdldFN0YXR1c0NvZGUoKSkKICAgICAgICAgICAgICAgICAgICAgICAgaHR0cFNlcnZpY2UuY29uc3VtZShodHRwX3Jlc3BvbnNlKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAgICAgICAgICAgICByZXNwb25zZV9ieXRlcyA9IGh0dHBTZXJ2aWNlLmdldFJlc3BvbnNlQ29udGVudChodHRwX3Jlc3BvbnNlKQogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlX3N0cmluZyA9IGh0dHBTZXJ2aWNlLmNvbnZlcnRFbnRpdHlUb1N0cmluZyhyZXNwb25zZV9ieXRlcywgQ2hhcnNldC5mb3JOYW1lKCJVVEYtOCIpKQogICAgICAgICAgICAgICAgICAgIGh0dHBTZXJ2aWNlLmNvbnN1bWUoaHR0cF9yZXNwb25zZSkKICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgaHR0cF9zZXJ2aWNlX3Jlc3BvbnNlLmNsb3NlQ29ubmVjdGlvbigpCgogICAgICAgICAgICAgICAgaWYgcmVzcG9uc2Vfc3RyaW5nID09IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQgIkNhc2EuIERldGVybWluZSByZW1vdGUgbG9jYXRpb24uIEdldCBlbXB0eSByZXNwb25zZSBmcm9tIGxvY2F0aW9uIHNlcnZlciIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0ganNvbi5sb2FkcyhyZXNwb25zZV9zdHJpbmcpCgogICAgICAgICAgICAgICAgaWYgbm90IFN0cmluZ0hlbHBlci5lcXVhbHNJZ25vcmVDYXNlKHJlc3BvbnNlWydzdGF0dXMnXSwgInN1Y2Nlc3MiKToKICAgICAgICAgICAgICAgICAgICBwcmludCAiQ2FzYS4gRGV0ZXJtaW5lIHJlbW90ZSBsb2NhdGlvbi4gR2V0IHJlc3BvbnNlIHdpdGggc3RhdHVzOiAnJXMnIiAlIHJlc3BvbnNlWydzdGF0dXMnXQogICAgICAgICAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlCgogICAgICAgIHJldHVybiBOb25lCgogICAgICAgIAogICAgZGVmIGdldExvZ291dEV4dGVybmFsVXJsKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLCByZXF1ZXN0UGFyYW1ldGVycyk6CiAgICAgICAgcHJpbnQgIkdldCBleHRlcm5hbCBsb2dvdXQgVVJMIGNhbGwiCiAgICAgICAgcmV0dXJuIE5vbmUK
oxScriptType: person_authentication
programmingLanguage: python

dn: inum=DAA9-F7F8,ou=scripts,o=gluu
objectClass: top
objectClass: oxCustomScript
description: Gluu Casa Client Registration script
displayName: casa_client_registration
oxEnabled: true
inum: DAA9-F7F8
oxLevel: 1
oxConfigurationProperty: {"value1":"client_redirect_uris","value2":"https://instance-1.us-central1-a.c.nifty-canyon-287111.internal/casa","description":""}
oxConfigurationProperty: {"value1":"scopes","value2":"openid, profile, user_name, clientinfo, oxd","description":""}
oxModuleProperty: {"value1":"location_type","value2":"ldap","description":""}
oxRevision: 1
oxScript:: IyBveEF1dGggaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBNSVQgTGljZW5zZSAoMjAwOCkuIFNlZSBodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUIGZvciBmdWxsIHRleHQuCiMgQ29weXJpZ2h0IChjKSAyMDE4LCBHbHV1CiMKIyBBdXRob3I6IEpvc2UgR29uemFsZXoKCmZyb20gb3JnLmdsdXUubW9kZWwuY3VzdG9tLnNjcmlwdC50eXBlLmNsaWVudCBpbXBvcnQgQ2xpZW50UmVnaXN0cmF0aW9uVHlwZQpmcm9tIG9yZy5nbHV1LnNlcnZpY2UuY2RpLnV0aWwgaW1wb3J0IENkaVV0aWwKZnJvbSBvcmcuZ2x1dS5veGF1dGguc2VydmljZSBpbXBvcnQgU2NvcGVTZXJ2aWNlCmZyb20gb3JnLmdsdXUudXRpbCBpbXBvcnQgU3RyaW5nSGVscGVyLCBBcnJheUhlbHBlcgpmcm9tIGphdmEudXRpbCBpbXBvcnQgQXJyYXlzLCBBcnJheUxpc3QsIEhhc2hTZXQsIERhdGUsIEdyZWdvcmlhbkNhbGVuZGFyCgppbXBvcnQgamF2YQoKY2xhc3MgQ2xpZW50UmVnaXN0cmF0aW9uKENsaWVudFJlZ2lzdHJhdGlvblR5cGUpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGN1cnJlbnRUaW1lTWlsbGlzKToKICAgICAgICBzZWxmLmN1cnJlbnRUaW1lTWlsbGlzID0gY3VycmVudFRpbWVNaWxsaXMKCiAgICBkZWYgaW5pdChzZWxmLCBjdXN0b21TY3JpcHQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiQ2FzYSBjbGllbnQgcmVnaXN0cmF0aW9uLiBJbml0aWFsaXphdGlvbiIKICAgICAgICBzZWxmLmNsaWVudFJlZGlyZWN0VXJpc1NldCA9IHNlbGYucHJlcGFyZUNsaWVudFJlZGlyZWN0VXJpcyhjb25maWd1cmF0aW9uQXR0cmlidXRlcykKICAgICAgICBwcmludCAiQ2FzYSBjbGllbnQgcmVnaXN0cmF0aW9uLiBJbml0aWFsaXplZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgcmV0dXJuIFRydWUgICAKCiAgICBkZWYgZGVzdHJveShzZWxmLCBjb25maWd1cmF0aW9uQXR0cmlidXRlcyk6CiAgICAgICAgcHJpbnQgIkNhc2EgY2xpZW50IHJlZ2lzdHJhdGlvbi4gRGVzdHJveSIKICAgICAgICBwcmludCAiQ2FzYSBjbGllbnQgcmVnaXN0cmF0aW9uLiBEZXN0cm95ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIHJldHVybiBUcnVlICAgCgogICAgIyBVcGRhdGUgY2xpZW50IGVudHJ5IGJlZm9yZSBwZXJzaXN0ZW50IGl0CiAgICAjICAgcmVnaXN0ZXJSZXF1ZXN0IGlzIG9yZy5nbHV1Lm94YXV0aC5jbGllbnQuUmVnaXN0ZXJSZXF1ZXN0CiAgICAjICAgY2xpZW50IGlzIG9yZy5nbHV1Lm94YXV0aC5tb2RlbC5yZWdpc3RyYXRpb24uQ2xpZW50CiAgICAjICAgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMgaXMgamF2YS51dGlsLk1hcDxTdHJpbmcsIFNpbXBsZUN1c3RvbVByb3BlcnR5PgogICAgZGVmIGNyZWF0ZUNsaWVudChzZWxmLCByZWdpc3RlclJlcXVlc3QsIGNsaWVudCwgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMpOgoKICAgICAgICBwcmludCAiQ2FzYSBjbGllbnQgcmVnaXN0cmF0aW9uLiBDcmVhdGVDbGllbnQgbWV0aG9kIgogICAgICAgIHJlZGlyZWN0VXJpcyA9IGNsaWVudC5nZXRSZWRpcmVjdFVyaXMoKQogICAgICAgIHByaW50ICJDYXNhIGNsaWVudCByZWdpc3RyYXRpb24uIFJlZGlyZWN0IFVyaXM6ICVzIiAlIHJlZGlyZWN0VXJpcwoKICAgICAgICBjcmVkTWFuYWdlckNsaWVudCA9IEZhbHNlCiAgICAgICAgZm9yIHJlZGlyZWN0VXJpIGluIHJlZGlyZWN0VXJpczoKICAgICAgICAgICAgaWYgc2VsZi5jbGllbnRSZWRpcmVjdFVyaXNTZXQuY29udGFpbnMocmVkaXJlY3RVcmkpOgogICAgICAgICAgICAgICAgY3JlZE1hbmFnZXJDbGllbnQgPSBUcnVlCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIAogICAgICAgIGlmIG5vdCBjcmVkTWFuYWdlckNsaWVudDoKICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgcHJpbnQgIkNhc2EgY2xpZW50IHJlZ2lzdHJhdGlvbi4gQ2xpZW50IGlzIEdsdXUgQ2FzYSIKICAgICAgICBzZWxmLnNldENsaWVudFNjb3BlcyhjbGllbnQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgic2NvcGVzIikpCiAgICAgICAgI0V4dGVuZCBjbGllbnQgbGlmZXRpbWUgZm9yIG9uZSB5ZWFyCiAgICAgICAgY2FsPUdyZWdvcmlhbkNhbGVuZGFyKCkKICAgICAgICBjYWwuYWRkKDEsMTApCiAgICAgICAgY2xpZW50LnNldENsaWVudFNlY3JldEV4cGlyZXNBdChEYXRlKGNhbC5nZXRUaW1lSW5NaWxsaXMoKSkpCiAgICAgICAgY2xpZW50LnNldFRydXN0ZWRDbGllbnQoVHJ1ZSkKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICMgVXBkYXRlIGNsaWVudCBlbnRyeSBiZWZvcmUgcGVyc2lzdGVudCBpdAogICAgIyAgIHJlZ2lzdGVyUmVxdWVzdCBpcyBvcmcuZ2x1dS5veGF1dGguY2xpZW50LlJlZ2lzdGVyUmVxdWVzdAogICAgIyAgIGNsaWVudCBpcyBvcmcuZ2x1dS5veGF1dGgubW9kZWwucmVnaXN0cmF0aW9uLkNsaWVudAogICAgIyAgIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzIGlzIGphdmEudXRpbC5NYXA8U3RyaW5nLCBTaW1wbGVDdXN0b21Qcm9wZXJ0eT4KICAgIGRlZiB1cGRhdGVDbGllbnQoc2VsZiwgcmVnaXN0ZXJSZXF1ZXN0LCBjbGllbnQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBwcmludCAiQ2FzYSBjbGllbnQgcmVnaXN0cmF0aW9uLiBVcGRhdGVDbGllbnQgbWV0aG9kIiAgICAgICAKICAgICAgICBzZWxmLnNldENsaWVudFNjb3BlcyhjbGllbnQsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgic2NvcGVzIikpCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgZ2V0QXBpVmVyc2lvbihzZWxmKToKICAgICAgICByZXR1cm4gMTEKCiAgICBkZWYgc2V0Q2xpZW50U2NvcGVzKHNlbGYsIGNsaWVudCwgcmVxdWlyZWRTY29wZXMpOgogICAgICAgIAogICAgICAgIGlmIHJlcXVpcmVkU2NvcGVzID09IE5vbmU6CiAgICAgICAgICAgIHByaW50ICJDYXNhIGNsaWVudCByZWdpc3RyYXRpb24uIE5vIGxpc3Qgb2Ygc2NvcGVzIHdhcyBwYXNzZWQgaW4gc2NyaXB0IHBhcmFtZXRlcnMiCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICByZXF1aXJlZFNjb3BlcyA9IFN0cmluZ0hlbHBlci5zcGxpdChyZXF1aXJlZFNjb3Blcy5nZXRWYWx1ZTIoKSwgIiwiKQogICAgICAgIG5ld1Njb3BlcyA9IGNsaWVudC5nZXRTY29wZXMoKQogICAgICAgIHNjb3BlU2VydmljZSA9IENkaVV0aWwuYmVhbihTY29wZVNlcnZpY2UpCgogICAgICAgIGZvciBzY29wZU5hbWUgaW4gcmVxdWlyZWRTY29wZXM6CiAgICAgICAgICAgIHNjb3BlID0gc2NvcGVTZXJ2aWNlLmdldFNjb3BlQnlJZChzY29wZU5hbWUpCiAgICAgICAgICAgIGlmIG5vdCBzY29wZS5pc0RlZmF1bHRTY29wZSgpOgogICAgICAgICAgICAgICAgcHJpbnQgIkNhc2EgY2xpZW50IHJlZ2lzdHJhdGlvbi4gQWRkaW5nIHNjb3BlICclcyciICUgc2NvcGVOYW1lCiAgICAgICAgICAgICAgICBuZXdTY29wZXMgPSBBcnJheUhlbHBlci5hZGRJdGVtVG9TdHJpbmdBcnJheShuZXdTY29wZXMsIHNjb3BlLmdldERuKCkpCgogICAgICAgIHByaW50ICJDYXNhIGNsaWVudCByZWdpc3RyYXRpb24uIFJlc3VsdCBzY29wZXMgYXJlOiAlcyIgJSBuZXdTY29wZXMKICAgICAgICBjbGllbnQuc2V0U2NvcGVzKG5ld1Njb3BlcykKICAgICAgICAKICAgICAgICAKICAgIGRlZiBwcmVwYXJlQ2xpZW50UmVkaXJlY3RVcmlzKHNlbGYsIGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzKToKICAgICAgICBjbGllbnRSZWRpcmVjdFVyaXNTZXQgPSBIYXNoU2V0KCkKICAgICAgICBpZiBub3QgY29uZmlndXJhdGlvbkF0dHJpYnV0ZXMuY29udGFpbnNLZXkoImNsaWVudF9yZWRpcmVjdF91cmlzIik6CiAgICAgICAgICAgIHJldHVybiBjbGllbnRSZWRpcmVjdFVyaXNTZXQKCiAgICAgICAgY2xpZW50UmVkaXJlY3RVcmlzTGlzdCA9IGNvbmZpZ3VyYXRpb25BdHRyaWJ1dGVzLmdldCgiY2xpZW50X3JlZGlyZWN0X3VyaXMiKS5nZXRWYWx1ZTIoKQogICAgICAgIGlmIFN0cmluZ0hlbHBlci5pc0VtcHR5KGNsaWVudFJlZGlyZWN0VXJpc0xpc3QpOgogICAgICAgICAgICBwcmludCAiQ2FzYSBjbGllbnQgcmVnaXN0cmF0aW9uLiBUaGUgcHJvcGVydHkgY2xpZW50X3JlZGlyZWN0X3VyaXMgaXMgZW1wdHkiCiAgICAgICAgICAgIHJldHVybiBjbGllbnRSZWRpcmVjdFVyaXNTZXQgICAgCgogICAgICAgIGNsaWVudFJlZGlyZWN0VXJpc0FycmF5ID0gU3RyaW5nSGVscGVyLnNwbGl0KGNsaWVudFJlZGlyZWN0VXJpc0xpc3QsICIsIikKICAgICAgICBpZiBBcnJheUhlbHBlci5pc0VtcHR5KGNsaWVudFJlZGlyZWN0VXJpc0FycmF5KToKICAgICAgICAgICAgcHJpbnQgIkNhc2EgY2xpZW50IHJlZ2lzdHJhdGlvbi4gTm8gY2xpZW50cyBzcGVjaWZpZWQgaW4gY2xpZW50X3JlZGlyZWN0X3VyaXMgcHJvcGVydHkiCiAgICAgICAgICAgIHJldHVybiBjbGllbnRSZWRpcmVjdFVyaXNTZXQKICAgICAgICAKICAgICAgICAjIENvbnZlcnQgdG8gSGFzaFNldCB0byBxdWljayBzZWFyY2gKICAgICAgICBpID0gMAogICAgICAgIGNvdW50ID0gbGVuKGNsaWVudFJlZGlyZWN0VXJpc0FycmF5KQogICAgICAgIHdoaWxlIGkgPCBjb3VudDoKICAgICAgICAgICAgdXJpcyA9IGNsaWVudFJlZGlyZWN0VXJpc0FycmF5W2ldCiAgICAgICAgICAgIGNsaWVudFJlZGlyZWN0VXJpc1NldC5hZGQodXJpcykKICAgICAgICAgICAgaSA9IGkgKyAxCgogICAgICAgIHJldHVybiBjbGllbnRSZWRpcmVjdFVyaXNTZXQK
oxScriptType: client_registration
programmingLanguage: python
